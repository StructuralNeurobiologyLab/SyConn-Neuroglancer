function require(x) { throw new Error('Cannot require ' + x) }
(()=>{var W4=Object.create,md=Object.defineProperty;var oE=Object.getOwnPropertyDescriptor;var z4=Object.getOwnPropertyNames;var H4=Object.getPrototypeOf,$4=Object.prototype.hasOwnProperty;var j4=n=>md(n,"__esModule",{value:!0});var Ce=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),wc=(n,e)=>{for(var t in e)md(n,t,{get:e[t],enumerable:!0})},q4=(n,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of z4(e))!$4.call(n,r)&&r!=="default"&&md(n,r,{get:()=>e[r],enumerable:!(t=oE(e,r))||t.enumerable});return n},rt=n=>q4(j4(md(n!=null?W4(H4(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n),Ut=(n,e,t,r)=>{for(var i=r>1?void 0:r?oE(e,t):e,a=n.length-1,o;a>=0;a--)(o=n[a])&&(i=(r?o(e,t,i):o(i))||i);return r&&i&&md(e,t,i),i};var hh=Ce((KK,mE)=>{function J4(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}mE.exports=J4});var yE=Ce((XK,gE)=>{var Y4=typeof window=="object"&&window&&window.Object===Object&&window;gE.exports=Y4});var dS=Ce((QK,vE)=>{var K4=yE(),X4=typeof self=="object"&&self&&self.Object===Object&&self,Q4=K4||X4||Function("return this")();vE.exports=Q4});var bE=Ce((ZK,SE)=>{var Z4=dS(),eG=function(){return Z4.Date.now()};SE.exports=eG});var pS=Ce((e7,xE)=>{var tG=dS(),nG=tG.Symbol;xE.exports=nG});var kE=Ce((t7,TE)=>{var CE=pS(),wE=Object.prototype,rG=wE.hasOwnProperty,iG=wE.toString,vd=CE?CE.toStringTag:void 0;function aG(n){var e=rG.call(n,vd),t=n[vd];try{n[vd]=void 0;var r=!0}catch(a){}var i=iG.call(n);return r&&(e?n[vd]=t:delete n[vd]),i}TE.exports=aG});var EE=Ce((n7,LE)=>{var oG=Object.prototype,sG=oG.toString;function lG(n){return sG.call(n)}LE.exports=lG});var AE=Ce((r7,IE)=>{var DE=pS(),cG=kE(),uG=EE(),dG="[object Null]",pG="[object Undefined]",PE=DE?DE.toStringTag:void 0;function fG(n){return n==null?n===void 0?pG:dG:PE&&PE in Object(n)?cG(n):uG(n)}IE.exports=fG});var RE=Ce((i7,ME)=>{function hG(n){return n!=null&&typeof n=="object"}ME.exports=hG});var VE=Ce((a7,_E)=>{var mG=AE(),gG=RE(),yG="[object Symbol]";function vG(n){return typeof n=="symbol"||gG(n)&&mG(n)==yG}_E.exports=vG});var UE=Ce((o7,BE)=>{var OE=hh(),SG=VE(),NE=0/0,bG=/^\s+|\s+$/g,xG=/^[-+]0x[0-9a-f]+$/i,CG=/^0b[01]+$/i,wG=/^0o[0-7]+$/i,TG=parseInt;function kG(n){if(typeof n=="number")return n;if(SG(n))return NE;if(OE(n)){var e=typeof n.valueOf=="function"?n.valueOf():n;n=OE(e)?e+"":e}if(typeof n!="string")return n===0?n:+n;n=n.replace(bG,"");var t=CG.test(n);return t||wG.test(n)?TG(n.slice(2),t?2:8):xG.test(n)?NE:+n}BE.exports=kG});var Ct=Ce((s7,GE)=>{var LG=hh(),fS=bE(),FE=UE(),EG="Expected a function",DG=Math.max,PG=Math.min;function IG(n,e,t){var r,i,a,o,l,c,d=0,p=!1,m=!1,y=!0;if(typeof n!="function")throw new TypeError(EG);e=FE(e)||0,LG(t)&&(p=!!t.leading,m="maxWait"in t,a=m?DG(FE(t.maxWait)||0,e):a,y="trailing"in t?!!t.trailing:y);function v(E){var V=r,N=i;return r=i=void 0,d=E,o=n.apply(N,V),o}function b(E){return d=E,l=setTimeout(k,e),p?v(E):o}function x(E){var V=E-c,N=E-d,U=e-V;return m?PG(U,a-N):U}function C(E){var V=E-c,N=E-d;return c===void 0||V>=e||V<0||m&&N>=a}function k(){var E=fS();if(C(E))return M(E);l=setTimeout(k,x(E))}function M(E){return l=void 0,y&&r?v(E):(r=i=void 0,o)}function I(){l!==void 0&&clearTimeout(l),d=0,r=c=i=l=void 0}function A(){return l===void 0?o:M(fS())}function D(){var E=fS(),V=C(E);if(r=arguments,i=this,c=E,V){if(l===void 0)return b(c);if(m)return clearTimeout(l),l=setTimeout(k,e),v(c)}return l===void 0&&(l=setTimeout(k,e)),o}return D.cancel=I,D.flush=A,D}GE.exports=IG});var Pl=Ce((uge,yR)=>{var N5=Ct(),B5=hh(),U5="Expected a function";function F5(n,e,t){var r=!0,i=!0;if(typeof n!="function")throw new TypeError(U5);return B5(t)&&(r="leading"in t?!!t.leading:r,i="trailing"in t?!!t.trailing:i),N5(n,e,{leading:r,maxWait:e,trailing:i})}yR.exports=F5});var Ds=Ce((Ow,Nw)=>{(function(n,e){typeof Ow=="object"&&typeof Nw!="undefined"?Nw.exports=e():typeof define=="function"&&define.amd?define(e):(n=n||self,n.CodeMirror=e())})(Ow,function(){"use strict";var n=navigator.userAgent,e=navigator.platform,t=/gecko\/\d/i.test(n),r=/MSIE \d/.test(n),i=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(n),a=/Edge\/(\d+)/.exec(n),o=r||i||a,l=o&&(r?document.documentMode||6:+(a||i)[1]),c=!a&&/WebKit\//.test(n),d=c&&/Qt\/\d+\.\d+/.test(n),p=!a&&/Chrome\//.test(n),m=/Opera\//.test(n),y=/Apple Computer/.test(navigator.vendor),v=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(n),b=/PhantomJS/.test(n),x=!a&&/AppleWebKit/.test(n)&&/Mobile\/\w+/.test(n),C=/Android/.test(n),k=x||C||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(n),M=x||/Mac/.test(e),I=/\bCrOS\b/.test(n),A=/win/i.test(e),D=m&&n.match(/Version\/(\d*\.\d*)/);D&&(D=Number(D[1])),D&&D>=15&&(m=!1,c=!0);var E=M&&(d||m&&(D==null||D<12.11)),V=t||o&&l>=9;function N(s){return new RegExp("(^|\\s)"+s+"(?:$|\\s)\\s*")}var U=function(s,u){var h=s.className,f=N(u).exec(h);if(f){var g=h.slice(f.index+f[0].length);s.className=h.slice(0,f.index)+(g?f[1]+g:"")}};function _(s){for(var u=s.childNodes.length;u>0;--u)s.removeChild(s.firstChild);return s}function B(s,u){return _(s).appendChild(u)}function R(s,u,h,f){var g=document.createElement(s);if(h&&(g.className=h),f&&(g.style.cssText=f),typeof u=="string")g.appendChild(document.createTextNode(u));else if(u)for(var S=0;S<u.length;++S)g.appendChild(u[S]);return g}function X(s,u,h,f){var g=R(s,u,h,f);return g.setAttribute("role","presentation"),g}var j;document.createRange?j=function(s,u,h,f){var g=document.createRange();return g.setEnd(f||s,h),g.setStart(s,u),g}:j=function(s,u,h){var f=document.body.createTextRange();try{f.moveToElementText(s.parentNode)}catch(g){return f}return f.collapse(!0),f.moveEnd("character",h),f.moveStart("character",u),f};function oe(s,u){if(u.nodeType==3&&(u=u.parentNode),s.contains)return s.contains(u);do if(u.nodeType==11&&(u=u.host),u==s)return!0;while(u=u.parentNode)}function me(){var s;try{s=document.activeElement}catch(u){s=document.body||null}for(;s&&s.shadowRoot&&s.shadowRoot.activeElement;)s=s.shadowRoot.activeElement;return s}function xe(s,u){var h=s.className;N(u).test(h)||(s.className+=(h?" ":"")+u)}function se(s,u){for(var h=s.split(" "),f=0;f<h.length;f++)h[f]&&!N(h[f]).test(u)&&(u+=" "+h[f]);return u}var Se=function(s){s.select()};x?Se=function(s){s.selectionStart=0,s.selectionEnd=s.value.length}:o&&(Se=function(s){try{s.select()}catch(u){}});function Ie(s){var u=Array.prototype.slice.call(arguments,1);return function(){return s.apply(null,u)}}function je(s,u,h){u||(u={});for(var f in s)s.hasOwnProperty(f)&&(h!==!1||!u.hasOwnProperty(f))&&(u[f]=s[f]);return u}function Be(s,u,h,f,g){u==null&&(u=s.search(/[^\s\u00a0]/),u==-1&&(u=s.length));for(var S=f||0,w=g||0;;){var T=s.indexOf("	",S);if(T<0||T>=u)return w+(u-S);w+=T-S,w+=h-w%h,S=T+1}}var Pe=function(){this.id=null,this.f=null,this.time=0,this.handler=Ie(this.onTimeout,this)};Pe.prototype.onTimeout=function(s){s.id=0,s.time<=+new Date?s.f():setTimeout(s.handler,s.time-+new Date)},Pe.prototype.set=function(s,u){this.f=u;var h=+new Date+s;(!this.id||h<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,s),this.time=h)};function ge(s,u){for(var h=0;h<s.length;++h)if(s[h]==u)return h;return-1}var $e=50,ht={toString:function(){return"CodeMirror.Pass"}},Dt={scroll:!1},Ae={origin:"*mouse"},Xe={origin:"+move"};function qt(s,u,h){for(var f=0,g=0;;){var S=s.indexOf("	",f);S==-1&&(S=s.length);var w=S-f;if(S==s.length||g+w>=u)return f+Math.min(w,u-g);if(g+=S-f,g+=h-g%h,f=S+1,g>=u)return f}}var Me=[""];function Bn(s){for(;Me.length<=s;)Me.push(Oe(Me)+" ");return Me[s]}function Oe(s){return s[s.length-1]}function ln(s,u){for(var h=[],f=0;f<s.length;f++)h[f]=u(s[f],f);return h}function pi(s,u,h){for(var f=0,g=h(u);f<s.length&&h(s[f])<=g;)f++;s.splice(f,0,u)}function aa(){}function _r(s,u){var h;return Object.create?h=Object.create(s):(aa.prototype=s,h=new aa),u&&je(u,h),h}var oa=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function le(s){return/\w/.test(s)||s>"\x80"&&(s.toUpperCase()!=s.toLowerCase()||oa.test(s))}function ke(s,u){return u?u.source.indexOf("\\w")>-1&&le(s)?!0:u.test(s):le(s)}function fe(s){for(var u in s)if(s.hasOwnProperty(u)&&s[u])return!1;return!0}var Re=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function Ne(s){return s.charCodeAt(0)>=768&&Re.test(s)}function tt(s,u,h){for(;(h<0?u>0:u<s.length)&&Ne(s.charAt(u));)u+=h;return u}function ce(s,u,h){for(var f=u>h?-1:1;;){if(u==h)return u;var g=(u+h)/2,S=f<0?Math.ceil(g):Math.floor(g);if(S==u)return s(S)?u:h;s(S)?h=S:u=S+f}}function De(s,u,h,f){if(!s)return f(u,h,"ltr",0);for(var g=!1,S=0;S<s.length;++S){var w=s[S];(w.from<h&&w.to>u||u==h&&w.to==u)&&(f(Math.max(w.from,u),Math.min(w.to,h),w.level==1?"rtl":"ltr",S),g=!0)}g||f(u,h,"ltr")}var ot=null;function Qe(s,u,h){var f;ot=null;for(var g=0;g<s.length;++g){var S=s[g];if(S.from<u&&S.to>u)return g;S.to==u&&(S.from!=S.to&&h=="before"?f=g:ot=g),S.from==u&&(S.from!=S.to&&h!="before"?f=g:ot=g)}return f!=null?f:ot}var bt=function(){var s="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",u="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function h(P){return P<=247?s.charAt(P):1424<=P&&P<=1524?"R":1536<=P&&P<=1785?u.charAt(P-1536):1774<=P&&P<=2220?"r":8192<=P&&P<=8203?"w":P==8204?"b":"L"}var f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,g=/[stwN]/,S=/[LRr]/,w=/[Lb1n]/,T=/[1n]/;function L(P,F,W){this.level=P,this.from=F,this.to=W}return function(P,F){var W=F=="ltr"?"L":"R";if(P.length==0||F=="ltr"&&!f.test(P))return!1;for(var Y=P.length,J=[],ee=0;ee<Y;++ee)J.push(h(P.charCodeAt(ee)));for(var ne=0,de=W;ne<Y;++ne){var ye=J[ne];ye=="m"?J[ne]=de:de=ye}for(var we=0,ve=W;we<Y;++we){var Le=J[we];Le=="1"&&ve=="r"?J[we]="n":S.test(Le)&&(ve=Le,Le=="r"&&(J[we]="R"))}for(var Ue=1,Ve=J[0];Ue<Y-1;++Ue){var st=J[Ue];st=="+"&&Ve=="1"&&J[Ue+1]=="1"?J[Ue]="1":st==","&&Ve==J[Ue+1]&&(Ve=="1"||Ve=="n")&&(J[Ue]=Ve),Ve=st}for(var Nt=0;Nt<Y;++Nt){var Dn=J[Nt];if(Dn==",")J[Nt]="N";else if(Dn=="%"){var Zt=void 0;for(Zt=Nt+1;Zt<Y&&J[Zt]=="%";++Zt);for(var Nr=Nt&&J[Nt-1]=="!"||Zt<Y&&J[Zt]=="1"?"1":"N",xr=Nt;xr<Zt;++xr)J[xr]=Nr;Nt=Zt-1}}for(var dn=0,Cr=W;dn<Y;++dn){var Fn=J[dn];Cr=="L"&&Fn=="1"?J[dn]="L":S.test(Fn)&&(Cr=Fn)}for(var yn=0;yn<Y;++yn)if(g.test(J[yn])){var pn=void 0;for(pn=yn+1;pn<Y&&g.test(J[pn]);++pn);for(var nn=(yn?J[yn-1]:W)=="L",wr=(pn<Y?J[pn]:W)=="L",xc=nn==wr?nn?"L":"R":W,jo=yn;jo<pn;++jo)J[jo]=xc;yn=pn-1}for(var $n=[],ma,Pn=0;Pn<Y;)if(w.test(J[Pn])){var lS=Pn;for(++Pn;Pn<Y&&w.test(J[Pn]);++Pn);$n.push(new L(0,lS,Pn))}else{var Ka=Pn,qs=$n.length,Js=F=="rtl"?1:0;for(++Pn;Pn<Y&&J[Pn]!="L";++Pn);for(var nr=Ka;nr<Pn;)if(T.test(J[nr])){Ka<nr&&($n.splice(qs,0,new L(1,Ka,nr)),qs+=Js);var Cc=nr;for(++nr;nr<Pn&&T.test(J[nr]);++nr);$n.splice(qs,0,new L(2,Cc,nr)),qs+=Js,Ka=nr}else++nr;Ka<Pn&&$n.splice(qs,0,new L(1,Ka,Pn))}return F=="ltr"&&($n[0].level==1&&(ma=P.match(/^\s+/))&&($n[0].from=ma[0].length,$n.unshift(new L(0,0,ma[0].length))),Oe($n).level==1&&(ma=P.match(/\s+$/))&&(Oe($n).to-=ma[0].length,$n.push(new L(0,Y-ma[0].length,Y)))),F=="rtl"?$n.reverse():$n}}();function Jt(s,u){var h=s.order;return h==null&&(h=s.order=bt(s.text,u)),h}var Vr=[],be=function(s,u,h){if(s.addEventListener)s.addEventListener(u,h,!1);else if(s.attachEvent)s.attachEvent("on"+u,h);else{var f=s._handlers||(s._handlers={});f[u]=(f[u]||Vr).concat(h)}};function yr(s,u){return s._handlers&&s._handlers[u]||Vr}function nt(s,u,h){if(s.removeEventListener)s.removeEventListener(u,h,!1);else if(s.detachEvent)s.detachEvent("on"+u,h);else{var f=s._handlers,g=f&&f[u];if(g){var S=ge(g,h);S>-1&&(f[u]=g.slice(0,S).concat(g.slice(S+1)))}}}function Wt(s,u){var h=yr(s,u);if(!!h.length)for(var f=Array.prototype.slice.call(arguments,2),g=0;g<h.length;++g)h[g].apply(null,f)}function Ot(s,u,h){return typeof u=="string"&&(u={type:u,preventDefault:function(){this.defaultPrevented=!0}}),Wt(s,h||u.type,s,u),Bs(u)||u.codemirrorIgnore}function Ql(s){var u=s._handlers&&s._handlers.cursorActivity;if(!!u)for(var h=s.curOp.cursorActivityHandlers||(s.curOp.cursorActivityHandlers=[]),f=0;f<u.length;++f)ge(h,u[f])==-1&&h.push(u[f])}function un(s,u){return yr(s,u).length>0}function Oo(s){s.prototype.on=function(u,h){be(this,u,h)},s.prototype.off=function(u,h){nt(this,u,h)}}function mn(s){s.preventDefault?s.preventDefault():s.returnValue=!1}function Rf(s){s.stopPropagation?s.stopPropagation():s.cancelBubble=!0}function Bs(s){return s.defaultPrevented!=null?s.defaultPrevented:s.returnValue==!1}function zn(s){mn(s),Rf(s)}function Zl(s){return s.target||s.srcElement}function _f(s){var u=s.which;return u==null&&(s.button&1?u=1:s.button&2?u=3:s.button&4&&(u=2)),M&&s.ctrlKey&&u==1&&(u=3),u}var sa=function(){if(o&&l<9)return!1;var s=R("div");return"draggable"in s||"dragDrop"in s}(),Bu;function Vf(s){if(Bu==null){var u=R("span","\u200B");B(s,R("span",[u,document.createTextNode("x")])),s.firstChild.offsetHeight!=0&&(Bu=u.offsetWidth<=1&&u.offsetHeight>2&&!(o&&l<8))}var h=Bu?R("span","\u200B"):R("span","\xA0",null,"display: inline-block; width: 1px; margin-right: -1px");return h.setAttribute("cm-text",""),h}var ec;function yv(s){if(ec!=null)return ec;var u=B(s,document.createTextNode("A\u062EA")),h=j(u,0,1).getBoundingClientRect(),f=j(u,1,2).getBoundingClientRect();return _(s),!h||h.left==h.right?!1:ec=f.right-h.right<3}var la=`

b`.split(/\n/).length!=3?function(s){for(var u=0,h=[],f=s.length;u<=f;){var g=s.indexOf(`
`,u);g==-1&&(g=s.length);var S=s.slice(u,s.charAt(g-1)=="\r"?g-1:g),w=S.indexOf("\r");w!=-1?(h.push(S.slice(0,w)),u+=w+1):(h.push(S),u=g+1)}return h}:function(s){return s.split(/\r\n?|\n/)},ca=window.getSelection?function(s){try{return s.selectionStart!=s.selectionEnd}catch(u){return!1}}:function(s){var u;try{u=s.ownerDocument.selection.createRange()}catch(h){}return!u||u.parentElement()!=s?!1:u.compareEndPoints("StartToEnd",u)!=0},No=function(){var s=R("div");return"oncopy"in s?!0:(s.setAttribute("oncopy","return;"),typeof s.oncopy=="function")}(),tc=null;function Wa(s){if(tc!=null)return tc;var u=B(s,R("span","x")),h=u.getBoundingClientRect(),f=j(u,0,1).getBoundingClientRect();return tc=Math.abs(h.left-f.left)>1}var Uu={},za={};function nc(s,u){arguments.length>2&&(u.dependencies=Array.prototype.slice.call(arguments,2)),Uu[s]=u}function Ai(s,u){za[s]=u}function Ha(s){if(typeof s=="string"&&za.hasOwnProperty(s))s=za[s];else if(s&&typeof s.name=="string"&&za.hasOwnProperty(s.name)){var u=za[s.name];typeof u=="string"&&(u={name:u}),s=_r(u,s),s.name=u.name}else{if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(s))return Ha("application/xml");if(typeof s=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(s))return Ha("application/json")}return typeof s=="string"?{name:s}:s||{name:"null"}}function Fu(s,u){u=Ha(u);var h=Uu[u.name];if(!h)return Fu(s,"text/plain");var f=h(s,u);if($a.hasOwnProperty(u.name)){var g=$a[u.name];for(var S in g)!g.hasOwnProperty(S)||(f.hasOwnProperty(S)&&(f["_"+S]=f[S]),f[S]=g[S])}if(f.name=u.name,u.helperType&&(f.helperType=u.helperType),u.modeProps)for(var w in u.modeProps)f[w]=u.modeProps[w];return f}var $a={};function vv(s,u){var h=$a.hasOwnProperty(s)?$a[s]:$a[s]={};je(u,h)}function fi(s,u){if(u===!0)return u;if(s.copyState)return s.copyState(u);var h={};for(var f in u){var g=u[f];g instanceof Array&&(g=g.concat([])),h[f]=g}return h}function rc(s,u){for(var h;s.innerMode&&(h=s.innerMode(u),!(!h||h.mode==s));)u=h.state,s=h.mode;return h||{mode:s,state:u}}function Of(s,u,h){return s.startState?s.startState(u,h):!0}var Yt=function(s,u,h){this.pos=this.start=0,this.string=s,this.tabSize=u||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=h};Yt.prototype.eol=function(){return this.pos>=this.string.length},Yt.prototype.sol=function(){return this.pos==this.lineStart},Yt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},Yt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},Yt.prototype.eat=function(s){var u=this.string.charAt(this.pos),h;if(typeof s=="string"?h=u==s:h=u&&(s.test?s.test(u):s(u)),h)return++this.pos,u},Yt.prototype.eatWhile=function(s){for(var u=this.pos;this.eat(s););return this.pos>u},Yt.prototype.eatSpace=function(){for(var s=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>s},Yt.prototype.skipToEnd=function(){this.pos=this.string.length},Yt.prototype.skipTo=function(s){var u=this.string.indexOf(s,this.pos);if(u>-1)return this.pos=u,!0},Yt.prototype.backUp=function(s){this.pos-=s},Yt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Be(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Be(this.string,this.lineStart,this.tabSize):0)},Yt.prototype.indentation=function(){return Be(this.string,null,this.tabSize)-(this.lineStart?Be(this.string,this.lineStart,this.tabSize):0)},Yt.prototype.match=function(s,u,h){if(typeof s=="string"){var f=function(w){return h?w.toLowerCase():w},g=this.string.substr(this.pos,s.length);if(f(g)==f(s))return u!==!1&&(this.pos+=s.length),!0}else{var S=this.string.slice(this.pos).match(s);return S&&S.index>0?null:(S&&u!==!1&&(this.pos+=S[0].length),S)}},Yt.prototype.current=function(){return this.string.slice(this.start,this.pos)},Yt.prototype.hideFirstChars=function(s,u){this.lineStart+=s;try{return u()}finally{this.lineStart-=s}},Yt.prototype.lookAhead=function(s){var u=this.lineOracle;return u&&u.lookAhead(s)},Yt.prototype.baseToken=function(){var s=this.lineOracle;return s&&s.baseToken(this.pos)};function _e(s,u){if(u-=s.first,u<0||u>=s.size)throw new Error("There is no line "+(u+s.first)+" in the document.");for(var h=s;!h.lines;)for(var f=0;;++f){var g=h.children[f],S=g.chunkSize();if(u<S){h=g;break}u-=S}return h.lines[u]}function ua(s,u,h){var f=[],g=u.line;return s.iter(u.line,h.line+1,function(S){var w=S.text;g==h.line&&(w=w.slice(0,h.ch)),g==u.line&&(w=w.slice(u.ch)),f.push(w),++g}),f}function Gu(s,u,h){var f=[];return s.iter(u,h,function(g){f.push(g.text)}),f}function hi(s,u){var h=u-s.height;if(h)for(var f=s;f;f=f.parent)f.height+=h}function vt(s){if(s.parent==null)return null;for(var u=s.parent,h=ge(u.lines,s),f=u.parent;f;u=f,f=f.parent)for(var g=0;f.children[g]!=u;++g)h+=f.children[g].chunkSize();return h+u.first}function O(s,u){var h=s.first;e:do{for(var f=0;f<s.children.length;++f){var g=s.children[f],S=g.height;if(u<S){s=g;continue e}u-=S,h+=g.chunkSize()}return h}while(!s.lines);for(var w=0;w<s.lines.length;++w){var T=s.lines[w],L=T.height;if(u<L)break;u-=L}return h+w}function H(s,u){return u>=s.first&&u<s.first+s.size}function te(s,u){return String(s.lineNumberFormatter(u+s.firstLineNumber))}function q(s,u,h){if(h===void 0&&(h=null),!(this instanceof q))return new q(s,u,h);this.line=s,this.ch=u,this.sticky=h}function he(s,u){return s.line-u.line||s.ch-u.ch}function pt(s,u){return s.sticky==u.sticky&&he(s,u)==0}function kt(s){return q(s.line,s.ch)}function gn(s,u){return he(s,u)<0?u:s}function vr(s,u){return he(s,u)<0?s:u}function Nf(s,u){return Math.max(s.first,Math.min(u,s.first+s.size-1))}function Ze(s,u){if(u.line<s.first)return q(s.first,0);var h=s.first+s.size-1;return u.line>h?q(h,_e(s,h).text.length):zF(u,_e(s,u.line).text.length)}function zF(s,u){var h=s.ch;return h==null||h>u?q(s.line,u):h<0?q(s.line,0):s}function ak(s,u){for(var h=[],f=0;f<u.length;f++)h[f]=Ze(s,u[f]);return h}var Bf=function(s,u){this.state=s,this.lookAhead=u},da=function(s,u,h,f){this.state=u,this.doc=s,this.line=h,this.maxLookAhead=f||0,this.baseTokens=null,this.baseTokenPos=1};da.prototype.lookAhead=function(s){var u=this.doc.getLine(this.line+s);return u!=null&&s>this.maxLookAhead&&(this.maxLookAhead=s),u},da.prototype.baseToken=function(s){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=s;)this.baseTokenPos+=2;var u=this.baseTokens[this.baseTokenPos+1];return{type:u&&u.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-s}},da.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},da.fromSaved=function(s,u,h){return u instanceof Bf?new da(s,fi(s.mode,u.state),h,u.lookAhead):new da(s,fi(s.mode,u),h)},da.prototype.save=function(s){var u=s!==!1?fi(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new Bf(u,this.maxLookAhead):u};function ok(s,u,h,f){var g=[s.state.modeGen],S={};pk(s,u.text,s.doc.mode,h,function(P,F){return g.push(P,F)},S,f);for(var w=h.state,T=function(P){h.baseTokens=g;var F=s.state.overlays[P],W=1,Y=0;h.state=!0,pk(s,u.text,F.mode,h,function(J,ee){for(var ne=W;Y<J;){var de=g[W];de>J&&g.splice(W,1,J,g[W+1],de),W+=2,Y=Math.min(J,de)}if(!!ee)if(F.opaque)g.splice(ne,W-ne,J,"overlay "+ee),W=ne+2;else for(;ne<W;ne+=2){var ye=g[ne+1];g[ne+1]=(ye?ye+" ":"")+"overlay "+ee}},S),h.state=w,h.baseTokens=null,h.baseTokenPos=1},L=0;L<s.state.overlays.length;++L)T(L);return{styles:g,classes:S.bgClass||S.textClass?S:null}}function sk(s,u,h){if(!u.styles||u.styles[0]!=s.state.modeGen){var f=Wu(s,vt(u)),g=u.text.length>s.options.maxHighlightLength&&fi(s.doc.mode,f.state),S=ok(s,u,f);g&&(f.state=g),u.stateAfter=f.save(!g),u.styles=S.styles,S.classes?u.styleClasses=S.classes:u.styleClasses&&(u.styleClasses=null),h===s.doc.highlightFrontier&&(s.doc.modeFrontier=Math.max(s.doc.modeFrontier,++s.doc.highlightFrontier))}return u.styles}function Wu(s,u,h){var f=s.doc,g=s.display;if(!f.mode.startState)return new da(f,!0,u);var S=HF(s,u,h),w=S>f.first&&_e(f,S-1).stateAfter,T=w?da.fromSaved(f,w,S):new da(f,Of(f.mode),S);return f.iter(S,u,function(L){Sv(s,L.text,T);var P=T.line;L.stateAfter=P==u-1||P%5==0||P>=g.viewFrom&&P<g.viewTo?T.save():null,T.nextLine()}),h&&(f.modeFrontier=T.line),T}function Sv(s,u,h,f){var g=s.doc.mode,S=new Yt(u,s.options.tabSize,h);for(S.start=S.pos=f||0,u==""&&lk(g,h.state);!S.eol();)bv(g,S,h.state),S.start=S.pos}function lk(s,u){if(s.blankLine)return s.blankLine(u);if(!!s.innerMode){var h=rc(s,u);if(h.mode.blankLine)return h.mode.blankLine(h.state)}}function bv(s,u,h,f){for(var g=0;g<10;g++){f&&(f[0]=rc(s,h).mode);var S=s.token(u,h);if(u.pos>u.start)return S}throw new Error("Mode "+s.name+" failed to advance stream.")}var ck=function(s,u,h){this.start=s.start,this.end=s.pos,this.string=s.current(),this.type=u||null,this.state=h};function uk(s,u,h,f){var g=s.doc,S=g.mode,w;u=Ze(g,u);var T=_e(g,u.line),L=Wu(s,u.line,h),P=new Yt(T.text,s.options.tabSize,L),F;for(f&&(F=[]);(f||P.pos<u.ch)&&!P.eol();)P.start=P.pos,w=bv(S,P,L.state),f&&F.push(new ck(P,w,fi(g.mode,L.state)));return f?F:new ck(P,w,L.state)}function dk(s,u){if(s)for(;;){var h=s.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!h)break;s=s.slice(0,h.index)+s.slice(h.index+h[0].length);var f=h[1]?"bgClass":"textClass";u[f]==null?u[f]=h[2]:new RegExp("(?:^|\\s)"+h[2]+"(?:$|\\s)").test(u[f])||(u[f]+=" "+h[2])}return s}function pk(s,u,h,f,g,S,w){var T=h.flattenSpans;T==null&&(T=s.options.flattenSpans);var L=0,P=null,F=new Yt(u,s.options.tabSize,f),W,Y=s.options.addModeClass&&[null];for(u==""&&dk(lk(h,f.state),S);!F.eol();){if(F.pos>s.options.maxHighlightLength?(T=!1,w&&Sv(s,u,f,F.pos),F.pos=u.length,W=null):W=dk(bv(h,F,f.state,Y),S),Y){var J=Y[0].name;J&&(W="m-"+(W?J+" "+W:J))}if(!T||P!=W){for(;L<F.start;)L=Math.min(F.start,L+5e3),g(L,P);P=W}F.start=F.pos}for(;L<F.pos;){var ee=Math.min(F.pos,L+5e3);g(ee,P),L=ee}}function HF(s,u,h){for(var f,g,S=s.doc,w=h?-1:u-(s.doc.mode.innerMode?1e3:100),T=u;T>w;--T){if(T<=S.first)return S.first;var L=_e(S,T-1),P=L.stateAfter;if(P&&(!h||T+(P instanceof Bf?P.lookAhead:0)<=S.modeFrontier))return T;var F=Be(L.text,null,s.options.tabSize);(g==null||f>F)&&(g=T-1,f=F)}return g}function $F(s,u){if(s.modeFrontier=Math.min(s.modeFrontier,u),!(s.highlightFrontier<u-10)){for(var h=s.first,f=u-1;f>h;f--){var g=_e(s,f).stateAfter;if(g&&(!(g instanceof Bf)||f+g.lookAhead<u)){h=f+1;break}}s.highlightFrontier=Math.min(s.highlightFrontier,h)}}var fk=!1,ja=!1;function jF(){fk=!0}function qF(){ja=!0}function Uf(s,u,h){this.marker=s,this.from=u,this.to=h}function zu(s,u){if(s)for(var h=0;h<s.length;++h){var f=s[h];if(f.marker==u)return f}}function JF(s,u){for(var h,f=0;f<s.length;++f)s[f]!=u&&(h||(h=[])).push(s[f]);return h}function YF(s,u){s.markedSpans=s.markedSpans?s.markedSpans.concat([u]):[u],u.marker.attachLine(s)}function KF(s,u,h){var f;if(s)for(var g=0;g<s.length;++g){var S=s[g],w=S.marker,T=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);if(T||S.from==u&&w.type=="bookmark"&&(!h||!S.marker.insertLeft)){var L=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);(f||(f=[])).push(new Uf(w,S.from,L?null:S.to))}}return f}function XF(s,u,h){var f;if(s)for(var g=0;g<s.length;++g){var S=s[g],w=S.marker,T=S.to==null||(w.inclusiveRight?S.to>=u:S.to>u);if(T||S.from==u&&w.type=="bookmark"&&(!h||S.marker.insertLeft)){var L=S.from==null||(w.inclusiveLeft?S.from<=u:S.from<u);(f||(f=[])).push(new Uf(w,L?null:S.from-u,S.to==null?null:S.to-u))}}return f}function xv(s,u){if(u.full)return null;var h=H(s,u.from.line)&&_e(s,u.from.line).markedSpans,f=H(s,u.to.line)&&_e(s,u.to.line).markedSpans;if(!h&&!f)return null;var g=u.from.ch,S=u.to.ch,w=he(u.from,u.to)==0,T=KF(h,g,w),L=XF(f,S,w),P=u.text.length==1,F=Oe(u.text).length+(P?g:0);if(T)for(var W=0;W<T.length;++W){var Y=T[W];if(Y.to==null){var J=zu(L,Y.marker);J?P&&(Y.to=J.to==null?null:J.to+F):Y.to=g}}if(L)for(var ee=0;ee<L.length;++ee){var ne=L[ee];if(ne.to!=null&&(ne.to+=F),ne.from==null){var de=zu(T,ne.marker);de||(ne.from=F,P&&(T||(T=[])).push(ne))}else ne.from+=F,P&&(T||(T=[])).push(ne)}T&&(T=hk(T)),L&&L!=T&&(L=hk(L));var ye=[T];if(!P){var we=u.text.length-2,ve;if(we>0&&T)for(var Le=0;Le<T.length;++Le)T[Le].to==null&&(ve||(ve=[])).push(new Uf(T[Le].marker,null,null));for(var Ue=0;Ue<we;++Ue)ye.push(ve);ye.push(L)}return ye}function hk(s){for(var u=0;u<s.length;++u){var h=s[u];h.from!=null&&h.from==h.to&&h.marker.clearWhenEmpty!==!1&&s.splice(u--,1)}return s.length?s:null}function QF(s,u,h){var f=null;if(s.iter(u.line,h.line+1,function(J){if(J.markedSpans)for(var ee=0;ee<J.markedSpans.length;++ee){var ne=J.markedSpans[ee].marker;ne.readOnly&&(!f||ge(f,ne)==-1)&&(f||(f=[])).push(ne)}}),!f)return null;for(var g=[{from:u,to:h}],S=0;S<f.length;++S)for(var w=f[S],T=w.find(0),L=0;L<g.length;++L){var P=g[L];if(!(he(P.to,T.from)<0||he(P.from,T.to)>0)){var F=[L,1],W=he(P.from,T.from),Y=he(P.to,T.to);(W<0||!w.inclusiveLeft&&!W)&&F.push({from:P.from,to:T.from}),(Y>0||!w.inclusiveRight&&!Y)&&F.push({from:T.to,to:P.to}),g.splice.apply(g,F),L+=F.length-3}}return g}function mk(s){var u=s.markedSpans;if(!!u){for(var h=0;h<u.length;++h)u[h].marker.detachLine(s);s.markedSpans=null}}function gk(s,u){if(!!u){for(var h=0;h<u.length;++h)u[h].marker.attachLine(s);s.markedSpans=u}}function Ff(s){return s.inclusiveLeft?-1:0}function Gf(s){return s.inclusiveRight?1:0}function Cv(s,u){var h=s.lines.length-u.lines.length;if(h!=0)return h;var f=s.find(),g=u.find(),S=he(f.from,g.from)||Ff(s)-Ff(u);if(S)return-S;var w=he(f.to,g.to)||Gf(s)-Gf(u);return w||u.id-s.id}function yk(s,u){var h=ja&&s.markedSpans,f;if(h)for(var g=void 0,S=0;S<h.length;++S)g=h[S],g.marker.collapsed&&(u?g.from:g.to)==null&&(!f||Cv(f,g.marker)<0)&&(f=g.marker);return f}function vk(s){return yk(s,!0)}function Wf(s){return yk(s,!1)}function ZF(s,u){var h=ja&&s.markedSpans,f;if(h)for(var g=0;g<h.length;++g){var S=h[g];S.marker.collapsed&&(S.from==null||S.from<u)&&(S.to==null||S.to>u)&&(!f||Cv(f,S.marker)<0)&&(f=S.marker)}return f}function Sk(s,u,h,f,g){var S=_e(s,u),w=ja&&S.markedSpans;if(w)for(var T=0;T<w.length;++T){var L=w[T];if(!!L.marker.collapsed){var P=L.marker.find(0),F=he(P.from,h)||Ff(L.marker)-Ff(g),W=he(P.to,f)||Gf(L.marker)-Gf(g);if(!(F>=0&&W<=0||F<=0&&W>=0)&&(F<=0&&(L.marker.inclusiveRight&&g.inclusiveLeft?he(P.to,h)>=0:he(P.to,h)>0)||F>=0&&(L.marker.inclusiveRight&&g.inclusiveLeft?he(P.from,f)<=0:he(P.from,f)<0)))return!0}}}function pa(s){for(var u;u=vk(s);)s=u.find(-1,!0).line;return s}function e3(s){for(var u;u=Wf(s);)s=u.find(1,!0).line;return s}function t3(s){for(var u,h;u=Wf(s);)s=u.find(1,!0).line,(h||(h=[])).push(s);return h}function wv(s,u){var h=_e(s,u),f=pa(h);return h==f?u:vt(f)}function bk(s,u){if(u>s.lastLine())return u;var h=_e(s,u),f;if(!Bo(s,h))return u;for(;f=Wf(h);)h=f.find(1,!0).line;return vt(h)+1}function Bo(s,u){var h=ja&&u.markedSpans;if(h){for(var f=void 0,g=0;g<h.length;++g)if(f=h[g],!!f.marker.collapsed){if(f.from==null)return!0;if(!f.marker.widgetNode&&f.from==0&&f.marker.inclusiveLeft&&Tv(s,u,f))return!0}}}function Tv(s,u,h){if(h.to==null){var f=h.marker.find(1,!0);return Tv(s,f.line,zu(f.line.markedSpans,h.marker))}if(h.marker.inclusiveRight&&h.to==u.text.length)return!0;for(var g=void 0,S=0;S<u.markedSpans.length;++S)if(g=u.markedSpans[S],g.marker.collapsed&&!g.marker.widgetNode&&g.from==h.to&&(g.to==null||g.to!=h.from)&&(g.marker.inclusiveLeft||h.marker.inclusiveRight)&&Tv(s,u,g))return!0}function qa(s){s=pa(s);for(var u=0,h=s.parent,f=0;f<h.lines.length;++f){var g=h.lines[f];if(g==s)break;u+=g.height}for(var S=h.parent;S;h=S,S=h.parent)for(var w=0;w<S.children.length;++w){var T=S.children[w];if(T==h)break;u+=T.height}return u}function zf(s){if(s.height==0)return 0;for(var u=s.text.length,h,f=s;h=vk(f);){var g=h.find(0,!0);f=g.from.line,u+=g.from.ch-g.to.ch}for(f=s;h=Wf(f);){var S=h.find(0,!0);u-=f.text.length-S.from.ch,f=S.to.line,u+=f.text.length-S.to.ch}return u}function kv(s){var u=s.display,h=s.doc;u.maxLine=_e(h,h.first),u.maxLineLength=zf(u.maxLine),u.maxLineChanged=!0,h.iter(function(f){var g=zf(f);g>u.maxLineLength&&(u.maxLineLength=g,u.maxLine=f)})}var ic=function(s,u,h){this.text=s,gk(this,u),this.height=h?h(this):1};ic.prototype.lineNo=function(){return vt(this)},Oo(ic);function n3(s,u,h,f){s.text=u,s.stateAfter&&(s.stateAfter=null),s.styles&&(s.styles=null),s.order!=null&&(s.order=null),mk(s),gk(s,h);var g=f?f(s):1;g!=s.height&&hi(s,g)}function r3(s){s.parent=null,mk(s)}var i3={},a3={};function xk(s,u){if(!s||/^\s*$/.test(s))return null;var h=u.addModeClass?a3:i3;return h[s]||(h[s]=s.replace(/\S+/g,"cm-$&"))}function Ck(s,u){var h=X("span",null,null,c?"padding-right: .1px":null),f={pre:X("pre",[h],"CodeMirror-line"),content:h,col:0,pos:0,cm:s,trailingSpace:!1,splitSpaces:s.getOption("lineWrapping")};u.measure={};for(var g=0;g<=(u.rest?u.rest.length:0);g++){var S=g?u.rest[g-1]:u.line,w=void 0;f.pos=0,f.addToken=s3,yv(s.display.measure)&&(w=Jt(S,s.doc.direction))&&(f.addToken=c3(f.addToken,w)),f.map=[];var T=u!=s.display.externalMeasured&&vt(S);u3(S,f,sk(s,S,T)),S.styleClasses&&(S.styleClasses.bgClass&&(f.bgClass=se(S.styleClasses.bgClass,f.bgClass||"")),S.styleClasses.textClass&&(f.textClass=se(S.styleClasses.textClass,f.textClass||""))),f.map.length==0&&f.map.push(0,0,f.content.appendChild(Vf(s.display.measure))),g==0?(u.measure.map=f.map,u.measure.cache={}):((u.measure.maps||(u.measure.maps=[])).push(f.map),(u.measure.caches||(u.measure.caches=[])).push({}))}if(c){var L=f.content.lastChild;(/\bcm-tab\b/.test(L.className)||L.querySelector&&L.querySelector(".cm-tab"))&&(f.content.className="cm-tab-wrap-hack")}return Wt(s,"renderLine",s,u.line,f.pre),f.pre.className&&(f.textClass=se(f.pre.className,f.textClass||"")),f}function o3(s){var u=R("span","\u2022","cm-invalidchar");return u.title="\\u"+s.charCodeAt(0).toString(16),u.setAttribute("aria-label",u.title),u}function s3(s,u,h,f,g,S,w){if(!!u){var T=s.splitSpaces?l3(u,s.trailingSpace):u,L=s.cm.state.specialChars,P=!1,F;if(!L.test(u))s.col+=u.length,F=document.createTextNode(T),s.map.push(s.pos,s.pos+u.length,F),o&&l<9&&(P=!0),s.pos+=u.length;else{F=document.createDocumentFragment();for(var W=0;;){L.lastIndex=W;var Y=L.exec(u),J=Y?Y.index-W:u.length-W;if(J){var ee=document.createTextNode(T.slice(W,W+J));o&&l<9?F.appendChild(R("span",[ee])):F.appendChild(ee),s.map.push(s.pos,s.pos+J,ee),s.col+=J,s.pos+=J}if(!Y)break;W+=J+1;var ne=void 0;if(Y[0]=="	"){var de=s.cm.options.tabSize,ye=de-s.col%de;ne=F.appendChild(R("span",Bn(ye),"cm-tab")),ne.setAttribute("role","presentation"),ne.setAttribute("cm-text","	"),s.col+=ye}else Y[0]=="\r"||Y[0]==`
`?(ne=F.appendChild(R("span",Y[0]=="\r"?"\u240D":"\u2424","cm-invalidchar")),ne.setAttribute("cm-text",Y[0]),s.col+=1):(ne=s.cm.options.specialCharPlaceholder(Y[0]),ne.setAttribute("cm-text",Y[0]),o&&l<9?F.appendChild(R("span",[ne])):F.appendChild(ne),s.col+=1);s.map.push(s.pos,s.pos+1,ne),s.pos++}}if(s.trailingSpace=T.charCodeAt(u.length-1)==32,h||f||g||P||S||w){var we=h||"";f&&(we+=f),g&&(we+=g);var ve=R("span",[F],we,S);if(w)for(var Le in w)w.hasOwnProperty(Le)&&Le!="style"&&Le!="class"&&ve.setAttribute(Le,w[Le]);return s.content.appendChild(ve)}s.content.appendChild(F)}}function l3(s,u){if(s.length>1&&!/  /.test(s))return s;for(var h=u,f="",g=0;g<s.length;g++){var S=s.charAt(g);S==" "&&h&&(g==s.length-1||s.charCodeAt(g+1)==32)&&(S="\xA0"),f+=S,h=S==" "}return f}function c3(s,u){return function(h,f,g,S,w,T,L){g=g?g+" cm-force-border":"cm-force-border";for(var P=h.pos,F=P+f.length;;){for(var W=void 0,Y=0;Y<u.length&&(W=u[Y],!(W.to>P&&W.from<=P));Y++);if(W.to>=F)return s(h,f,g,S,w,T,L);s(h,f.slice(0,W.to-P),g,S,null,T,L),S=null,f=f.slice(W.to-P),P=W.to}}}function wk(s,u,h,f){var g=!f&&h.widgetNode;g&&s.map.push(s.pos,s.pos+u,g),!f&&s.cm.display.input.needsContentAttribute&&(g||(g=s.content.appendChild(document.createElement("span"))),g.setAttribute("cm-marker",h.id)),g&&(s.cm.display.input.setUneditable(g),s.content.appendChild(g)),s.pos+=u,s.trailingSpace=!1}function u3(s,u,h){var f=s.markedSpans,g=s.text,S=0;if(!f){for(var w=1;w<h.length;w+=2)u.addToken(u,g.slice(S,S=h[w]),xk(h[w+1],u.cm.options));return}for(var T=g.length,L=0,P=1,F="",W,Y,J=0,ee,ne,de,ye,we;;){if(J==L){ee=ne=de=Y="",we=null,ye=null,J=Infinity;for(var ve=[],Le=void 0,Ue=0;Ue<f.length;++Ue){var Ve=f[Ue],st=Ve.marker;if(st.type=="bookmark"&&Ve.from==L&&st.widgetNode)ve.push(st);else if(Ve.from<=L&&(Ve.to==null||Ve.to>L||st.collapsed&&Ve.to==L&&Ve.from==L)){if(Ve.to!=null&&Ve.to!=L&&J>Ve.to&&(J=Ve.to,ne=""),st.className&&(ee+=" "+st.className),st.css&&(Y=(Y?Y+";":"")+st.css),st.startStyle&&Ve.from==L&&(de+=" "+st.startStyle),st.endStyle&&Ve.to==J&&(Le||(Le=[])).push(st.endStyle,Ve.to),st.title&&((we||(we={})).title=st.title),st.attributes)for(var Nt in st.attributes)(we||(we={}))[Nt]=st.attributes[Nt];st.collapsed&&(!ye||Cv(ye.marker,st)<0)&&(ye=Ve)}else Ve.from>L&&J>Ve.from&&(J=Ve.from)}if(Le)for(var Dn=0;Dn<Le.length;Dn+=2)Le[Dn+1]==J&&(ne+=" "+Le[Dn]);if(!ye||ye.from==L)for(var Zt=0;Zt<ve.length;++Zt)wk(u,0,ve[Zt]);if(ye&&(ye.from||0)==L){if(wk(u,(ye.to==null?T+1:ye.to)-L,ye.marker,ye.from==null),ye.to==null)return;ye.to==L&&(ye=!1)}}if(L>=T)break;for(var Nr=Math.min(T,J);;){if(F){var xr=L+F.length;if(!ye){var dn=xr>Nr?F.slice(0,Nr-L):F;u.addToken(u,dn,W?W+ee:ee,de,L+dn.length==J?ne:"",Y,we)}if(xr>=Nr){F=F.slice(Nr-L),L=Nr;break}L=xr,de=""}F=g.slice(S,S=h[P++]),W=xk(h[P++],u.cm.options)}}}function Tk(s,u,h){this.line=u,this.rest=t3(u),this.size=this.rest?vt(Oe(this.rest))-h+1:1,this.node=this.text=null,this.hidden=Bo(s,u)}function Hf(s,u,h){for(var f=[],g,S=u;S<h;S=g){var w=new Tk(s.doc,_e(s.doc,S),S);g=S+w.size,f.push(w)}return f}var ac=null;function d3(s){ac?ac.ops.push(s):s.ownsGroup=ac={ops:[s],delayedCallbacks:[]}}function p3(s){var u=s.delayedCallbacks,h=0;do{for(;h<u.length;h++)u[h].call(null);for(var f=0;f<s.ops.length;f++){var g=s.ops[f];if(g.cursorActivityHandlers)for(;g.cursorActivityCalled<g.cursorActivityHandlers.length;)g.cursorActivityHandlers[g.cursorActivityCalled++].call(null,g.cm)}}while(h<u.length)}function f3(s,u){var h=s.ownsGroup;if(!!h)try{p3(h)}finally{ac=null,u(h)}}var Hu=null;function Un(s,u){var h=yr(s,u);if(!!h.length){var f=Array.prototype.slice.call(arguments,2),g;ac?g=ac.delayedCallbacks:Hu?g=Hu:(g=Hu=[],setTimeout(h3,0));for(var S=function(T){g.push(function(){return h[T].apply(null,f)})},w=0;w<h.length;++w)S(w)}}function h3(){var s=Hu;Hu=null;for(var u=0;u<s.length;++u)s[u]()}function kk(s,u,h,f){for(var g=0;g<u.changes.length;g++){var S=u.changes[g];S=="text"?g3(s,u):S=="gutter"?Ek(s,u,h,f):S=="class"?Lv(s,u):S=="widget"&&y3(s,u,f)}u.changes=null}function $u(s){return s.node==s.text&&(s.node=R("div",null,null,"position: relative"),s.text.parentNode&&s.text.parentNode.replaceChild(s.node,s.text),s.node.appendChild(s.text),o&&l<8&&(s.node.style.zIndex=2)),s.node}function m3(s,u){var h=u.bgClass?u.bgClass+" "+(u.line.bgClass||""):u.line.bgClass;if(h&&(h+=" CodeMirror-linebackground"),u.background)h?u.background.className=h:(u.background.parentNode.removeChild(u.background),u.background=null);else if(h){var f=$u(u);u.background=f.insertBefore(R("div",null,h),f.firstChild),s.display.input.setUneditable(u.background)}}function Lk(s,u){var h=s.display.externalMeasured;return h&&h.line==u.line?(s.display.externalMeasured=null,u.measure=h.measure,h.built):Ck(s,u)}function g3(s,u){var h=u.text.className,f=Lk(s,u);u.text==u.node&&(u.node=f.pre),u.text.parentNode.replaceChild(f.pre,u.text),u.text=f.pre,f.bgClass!=u.bgClass||f.textClass!=u.textClass?(u.bgClass=f.bgClass,u.textClass=f.textClass,Lv(s,u)):h&&(u.text.className=h)}function Lv(s,u){m3(s,u),u.line.wrapClass?$u(u).className=u.line.wrapClass:u.node!=u.text&&(u.node.className="");var h=u.textClass?u.textClass+" "+(u.line.textClass||""):u.line.textClass;u.text.className=h||""}function Ek(s,u,h,f){if(u.gutter&&(u.node.removeChild(u.gutter),u.gutter=null),u.gutterBackground&&(u.node.removeChild(u.gutterBackground),u.gutterBackground=null),u.line.gutterClass){var g=$u(u);u.gutterBackground=R("div",null,"CodeMirror-gutter-background "+u.line.gutterClass,"left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px; width: "+f.gutterTotalWidth+"px"),s.display.input.setUneditable(u.gutterBackground),g.insertBefore(u.gutterBackground,u.text)}var S=u.line.gutterMarkers;if(s.options.lineNumbers||S){var w=$u(u),T=u.gutter=R("div",null,"CodeMirror-gutter-wrapper","left: "+(s.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px");if(s.display.input.setUneditable(T),w.insertBefore(T,u.text),u.line.gutterClass&&(T.className+=" "+u.line.gutterClass),s.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(u.lineNumber=T.appendChild(R("div",te(s.options,h),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+s.display.lineNumInnerWidth+"px"))),S)for(var L=0;L<s.display.gutterSpecs.length;++L){var P=s.display.gutterSpecs[L].className,F=S.hasOwnProperty(P)&&S[P];F&&T.appendChild(R("div",[F],"CodeMirror-gutter-elt","left: "+f.gutterLeft[P]+"px; width: "+f.gutterWidth[P]+"px"))}}}function y3(s,u,h){u.alignable&&(u.alignable=null);for(var f=N("CodeMirror-linewidget"),g=u.node.firstChild,S=void 0;g;g=S)S=g.nextSibling,f.test(g.className)&&u.node.removeChild(g);Dk(s,u,h)}function v3(s,u,h,f){var g=Lk(s,u);return u.text=u.node=g.pre,g.bgClass&&(u.bgClass=g.bgClass),g.textClass&&(u.textClass=g.textClass),Lv(s,u),Ek(s,u,h,f),Dk(s,u,f),u.node}function Dk(s,u,h){if(Pk(s,u.line,u,h,!0),u.rest)for(var f=0;f<u.rest.length;f++)Pk(s,u.rest[f],u,h,!1)}function Pk(s,u,h,f,g){if(!!u.widgets)for(var S=$u(h),w=0,T=u.widgets;w<T.length;++w){var L=T[w],P=R("div",[L.node],"CodeMirror-linewidget"+(L.className?" "+L.className:""));L.handleMouseEvents||P.setAttribute("cm-ignore-events","true"),S3(L,P,h,f),s.display.input.setUneditable(P),g&&L.above?S.insertBefore(P,h.gutter||h.text):S.appendChild(P),Un(L,"redraw")}}function S3(s,u,h,f){if(s.noHScroll){(h.alignable||(h.alignable=[])).push(u);var g=f.wrapperWidth;u.style.left=f.fixedPos+"px",s.coverGutter||(g-=f.gutterTotalWidth,u.style.paddingLeft=f.gutterTotalWidth+"px"),u.style.width=g+"px"}s.coverGutter&&(u.style.zIndex=5,u.style.position="relative",s.noHScroll||(u.style.marginLeft=-f.gutterTotalWidth+"px"))}function ju(s){if(s.height!=null)return s.height;var u=s.doc.cm;if(!u)return 0;if(!oe(document.body,s.node)){var h="position: relative;";s.coverGutter&&(h+="margin-left: -"+u.display.gutters.offsetWidth+"px;"),s.noHScroll&&(h+="width: "+u.display.wrapper.clientWidth+"px;"),B(u.display.measure,R("div",[s.node],null,h))}return s.height=s.node.parentNode.offsetHeight}function Ja(s,u){for(var h=Zl(u);h!=s.wrapper;h=h.parentNode)if(!h||h.nodeType==1&&h.getAttribute("cm-ignore-events")=="true"||h.parentNode==s.sizer&&h!=s.mover)return!0}function $f(s){return s.lineSpace.offsetTop}function Ev(s){return s.mover.offsetHeight-s.lineSpace.offsetHeight}function Ik(s){if(s.cachedPaddingH)return s.cachedPaddingH;var u=B(s.measure,R("pre","x","CodeMirror-line-like")),h=window.getComputedStyle?window.getComputedStyle(u):u.currentStyle,f={left:parseInt(h.paddingLeft),right:parseInt(h.paddingRight)};return!isNaN(f.left)&&!isNaN(f.right)&&(s.cachedPaddingH=f),f}function fa(s){return $e-s.display.nativeBarWidth}function Us(s){return s.display.scroller.clientWidth-fa(s)-s.display.barWidth}function Dv(s){return s.display.scroller.clientHeight-fa(s)-s.display.barHeight}function b3(s,u,h){var f=s.options.lineWrapping,g=f&&Us(s);if(!u.measure.heights||f&&u.measure.width!=g){var S=u.measure.heights=[];if(f){u.measure.width=g;for(var w=u.text.firstChild.getClientRects(),T=0;T<w.length-1;T++){var L=w[T],P=w[T+1];Math.abs(L.bottom-P.bottom)>2&&S.push((L.bottom+P.top)/2-h.top)}}S.push(h.bottom-h.top)}}function Ak(s,u,h){if(s.line==u)return{map:s.measure.map,cache:s.measure.cache};for(var f=0;f<s.rest.length;f++)if(s.rest[f]==u)return{map:s.measure.maps[f],cache:s.measure.caches[f]};for(var g=0;g<s.rest.length;g++)if(vt(s.rest[g])>h)return{map:s.measure.maps[g],cache:s.measure.caches[g],before:!0}}function x3(s,u){u=pa(u);var h=vt(u),f=s.display.externalMeasured=new Tk(s.doc,u,h);f.lineN=h;var g=f.built=Ck(s,f);return f.text=g.pre,B(s.display.lineMeasure,g.pre),f}function Mk(s,u,h,f){return ha(s,oc(s,u),h,f)}function Pv(s,u){if(u>=s.display.viewFrom&&u<s.display.viewTo)return s.display.view[Ws(s,u)];var h=s.display.externalMeasured;if(h&&u>=h.lineN&&u<h.lineN+h.size)return h}function oc(s,u){var h=vt(u),f=Pv(s,h);f&&!f.text?f=null:f&&f.changes&&(kk(s,f,h,Vv(s)),s.curOp.forceUpdate=!0),f||(f=x3(s,u));var g=Ak(f,u,h);return{line:u,view:f,rect:null,map:g.map,cache:g.cache,before:g.before,hasHeights:!1}}function ha(s,u,h,f,g){u.before&&(h=-1);var S=h+(f||""),w;return u.cache.hasOwnProperty(S)?w=u.cache[S]:(u.rect||(u.rect=u.view.text.getBoundingClientRect()),u.hasHeights||(b3(s,u.view,u.rect),u.hasHeights=!0),w=w3(s,u,h,f),w.bogus||(u.cache[S]=w)),{left:w.left,right:w.right,top:g?w.rtop:w.top,bottom:g?w.rbottom:w.bottom}}var Rk={left:0,right:0,top:0,bottom:0};function _k(s,u,h){for(var f,g,S,w,T,L,P=0;P<s.length;P+=3)if(T=s[P],L=s[P+1],u<T?(g=0,S=1,w="left"):u<L?(g=u-T,S=g+1):(P==s.length-3||u==L&&s[P+3]>u)&&(S=L-T,g=S-1,u>=L&&(w="right")),g!=null){if(f=s[P+2],T==L&&h==(f.insertLeft?"left":"right")&&(w=h),h=="left"&&g==0)for(;P&&s[P-2]==s[P-3]&&s[P-1].insertLeft;)f=s[(P-=3)+2],w="left";if(h=="right"&&g==L-T)for(;P<s.length-3&&s[P+3]==s[P+4]&&!s[P+5].insertLeft;)f=s[(P+=3)+2],w="right";break}return{node:f,start:g,end:S,collapse:w,coverStart:T,coverEnd:L}}function C3(s,u){var h=Rk;if(u=="left")for(var f=0;f<s.length&&(h=s[f]).left==h.right;f++);else for(var g=s.length-1;g>=0&&(h=s[g]).left==h.right;g--);return h}function w3(s,u,h,f){var g=_k(u.map,h,f),S=g.node,w=g.start,T=g.end,L=g.collapse,P;if(S.nodeType==3){for(var F=0;F<4;F++){for(;w&&Ne(u.line.text.charAt(g.coverStart+w));)--w;for(;g.coverStart+T<g.coverEnd&&Ne(u.line.text.charAt(g.coverStart+T));)++T;if(o&&l<9&&w==0&&T==g.coverEnd-g.coverStart?P=S.parentNode.getBoundingClientRect():P=C3(j(S,w,T).getClientRects(),f),P.left||P.right||w==0)break;T=w,w=w-1,L="right"}o&&l<11&&(P=T3(s.display.measure,P))}else{w>0&&(L=f="right");var W;s.options.lineWrapping&&(W=S.getClientRects()).length>1?P=W[f=="right"?W.length-1:0]:P=S.getBoundingClientRect()}if(o&&l<9&&!w&&(!P||!P.left&&!P.right)){var Y=S.parentNode.getClientRects()[0];Y?P={left:Y.left,right:Y.left+lc(s.display),top:Y.top,bottom:Y.bottom}:P=Rk}for(var J=P.top-u.rect.top,ee=P.bottom-u.rect.top,ne=(J+ee)/2,de=u.view.measure.heights,ye=0;ye<de.length-1&&!(ne<de[ye]);ye++);var we=ye?de[ye-1]:0,ve=de[ye],Le={left:(L=="right"?P.right:P.left)-u.rect.left,right:(L=="left"?P.left:P.right)-u.rect.left,top:we,bottom:ve};return!P.left&&!P.right&&(Le.bogus=!0),s.options.singleCursorHeightPerLine||(Le.rtop=J,Le.rbottom=ee),Le}function T3(s,u){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!Wa(s))return u;var h=screen.logicalXDPI/screen.deviceXDPI,f=screen.logicalYDPI/screen.deviceYDPI;return{left:u.left*h,right:u.right*h,top:u.top*f,bottom:u.bottom*f}}function Vk(s){if(s.measure&&(s.measure.cache={},s.measure.heights=null,s.rest))for(var u=0;u<s.rest.length;u++)s.measure.caches[u]={}}function Ok(s){s.display.externalMeasure=null,_(s.display.lineMeasure);for(var u=0;u<s.display.view.length;u++)Vk(s.display.view[u])}function qu(s){Ok(s),s.display.cachedCharWidth=s.display.cachedTextHeight=s.display.cachedPaddingH=null,s.options.lineWrapping||(s.display.maxLineChanged=!0),s.display.lineNumChars=null}function Nk(){return p&&C?-(document.body.getBoundingClientRect().left-parseInt(getComputedStyle(document.body).marginLeft)):window.pageXOffset||(document.documentElement||document.body).scrollLeft}function Bk(){return p&&C?-(document.body.getBoundingClientRect().top-parseInt(getComputedStyle(document.body).marginTop)):window.pageYOffset||(document.documentElement||document.body).scrollTop}function Iv(s){var u=0;if(s.widgets)for(var h=0;h<s.widgets.length;++h)s.widgets[h].above&&(u+=ju(s.widgets[h]));return u}function jf(s,u,h,f,g){if(!g){var S=Iv(u);h.top+=S,h.bottom+=S}if(f=="line")return h;f||(f="local");var w=qa(u);if(f=="local"?w+=$f(s.display):w-=s.display.viewOffset,f=="page"||f=="window"){var T=s.display.lineSpace.getBoundingClientRect();w+=T.top+(f=="window"?0:Bk());var L=T.left+(f=="window"?0:Nk());h.left+=L,h.right+=L}return h.top+=w,h.bottom+=w,h}function Uk(s,u,h){if(h=="div")return u;var f=u.left,g=u.top;if(h=="page")f-=Nk(),g-=Bk();else if(h=="local"||!h){var S=s.display.sizer.getBoundingClientRect();f+=S.left,g+=S.top}var w=s.display.lineSpace.getBoundingClientRect();return{left:f-w.left,top:g-w.top}}function Av(s,u,h,f,g){return f||(f=_e(s.doc,u.line)),jf(s,f,Mk(s,f,u.ch,g),h)}function Mi(s,u,h,f,g,S){f=f||_e(s.doc,u.line),g||(g=oc(s,f));function w(ee,ne){var de=ha(s,g,ee,ne?"right":"left",S);return ne?de.left=de.right:de.right=de.left,jf(s,f,de,h)}var T=Jt(f,s.doc.direction),L=u.ch,P=u.sticky;if(L>=f.text.length?(L=f.text.length,P="before"):L<=0&&(L=0,P="after"),!T)return w(P=="before"?L-1:L,P=="before");function F(ee,ne,de){var ye=T[ne],we=ye.level==1;return w(de?ee-1:ee,we!=de)}var W=Qe(T,L,P),Y=ot,J=F(L,W,P=="before");return Y!=null&&(J.other=F(L,Y,P!="before")),J}function Fk(s,u){var h=0;u=Ze(s.doc,u),s.options.lineWrapping||(h=lc(s.display)*u.ch);var f=_e(s.doc,u.line),g=qa(f)+$f(s.display);return{left:h,right:h,top:g,bottom:g+f.height}}function Mv(s,u,h,f,g){var S=q(s,u,h);return S.xRel=g,f&&(S.outside=f),S}function Rv(s,u,h){var f=s.doc;if(h+=s.display.viewOffset,h<0)return Mv(f.first,0,null,-1,-1);var g=O(f,h),S=f.first+f.size-1;if(g>S)return Mv(f.first+f.size-1,_e(f,S).text.length,null,1,1);u<0&&(u=0);for(var w=_e(f,g);;){var T=k3(s,w,g,u,h),L=ZF(w,T.ch+(T.xRel>0||T.outside>0?1:0));if(!L)return T;var P=L.find(1);if(P.line==g)return P;w=_e(f,g=P.line)}}function Gk(s,u,h,f){f-=Iv(u);var g=u.text.length,S=ce(function(w){return ha(s,h,w-1).bottom<=f},g,0);return g=ce(function(w){return ha(s,h,w).top>f},S,g),{begin:S,end:g}}function Wk(s,u,h,f){h||(h=oc(s,u));var g=jf(s,u,ha(s,h,f),"line").top;return Gk(s,u,h,g)}function _v(s,u,h,f){return s.bottom<=h?!1:s.top>h?!0:(f?s.left:s.right)>u}function k3(s,u,h,f,g){g-=qa(u);var S=oc(s,u),w=Iv(u),T=0,L=u.text.length,P=!0,F=Jt(u,s.doc.direction);if(F){var W=(s.options.lineWrapping?E3:L3)(s,u,h,S,F,f,g);P=W.level!=1,T=P?W.from:W.to-1,L=P?W.to:W.from-1}var Y=null,J=null,ee=ce(function(Ue){var Ve=ha(s,S,Ue);return Ve.top+=w,Ve.bottom+=w,_v(Ve,f,g,!1)?(Ve.top<=g&&Ve.left<=f&&(Y=Ue,J=Ve),!0):!1},T,L),ne,de,ye=!1;if(J){var we=f-J.left<J.right-f,ve=we==P;ee=Y+(ve?0:1),de=ve?"after":"before",ne=we?J.left:J.right}else{!P&&(ee==L||ee==T)&&ee++,de=ee==0?"after":ee==u.text.length?"before":ha(s,S,ee-(P?1:0)).bottom+w<=g==P?"after":"before";var Le=Mi(s,q(h,ee,de),"line",u,S);ne=Le.left,ye=g<Le.top?-1:g>=Le.bottom?1:0}return ee=tt(u.text,ee,1),Mv(h,ee,de,ye,f-ne)}function L3(s,u,h,f,g,S,w){var T=ce(function(W){var Y=g[W],J=Y.level!=1;return _v(Mi(s,q(h,J?Y.to:Y.from,J?"before":"after"),"line",u,f),S,w,!0)},0,g.length-1),L=g[T];if(T>0){var P=L.level!=1,F=Mi(s,q(h,P?L.from:L.to,P?"after":"before"),"line",u,f);_v(F,S,w,!0)&&F.top>w&&(L=g[T-1])}return L}function E3(s,u,h,f,g,S,w){var T=Gk(s,u,f,w),L=T.begin,P=T.end;/\s/.test(u.text.charAt(P-1))&&P--;for(var F=null,W=null,Y=0;Y<g.length;Y++){var J=g[Y];if(!(J.from>=P||J.to<=L)){var ee=J.level!=1,ne=ha(s,f,ee?Math.min(P,J.to)-1:Math.max(L,J.from)).right,de=ne<S?S-ne+1e9:ne-S;(!F||W>de)&&(F=J,W=de)}}return F||(F=g[g.length-1]),F.from<L&&(F={from:L,to:F.to,level:F.level}),F.to>P&&(F={from:F.from,to:P,level:F.level}),F}var Fs;function sc(s){if(s.cachedTextHeight!=null)return s.cachedTextHeight;if(Fs==null){Fs=R("pre",null,"CodeMirror-line-like");for(var u=0;u<49;++u)Fs.appendChild(document.createTextNode("x")),Fs.appendChild(R("br"));Fs.appendChild(document.createTextNode("x"))}B(s.measure,Fs);var h=Fs.offsetHeight/50;return h>3&&(s.cachedTextHeight=h),_(s.measure),h||1}function lc(s){if(s.cachedCharWidth!=null)return s.cachedCharWidth;var u=R("span","xxxxxxxxxx"),h=R("pre",[u],"CodeMirror-line-like");B(s.measure,h);var f=u.getBoundingClientRect(),g=(f.right-f.left)/10;return g>2&&(s.cachedCharWidth=g),g||10}function Vv(s){for(var u=s.display,h={},f={},g=u.gutters.clientLeft,S=u.gutters.firstChild,w=0;S;S=S.nextSibling,++w){var T=s.display.gutterSpecs[w].className;h[T]=S.offsetLeft+S.clientLeft+g,f[T]=S.clientWidth}return{fixedPos:Ov(u),gutterTotalWidth:u.gutters.offsetWidth,gutterLeft:h,gutterWidth:f,wrapperWidth:u.wrapper.clientWidth}}function Ov(s){return s.scroller.getBoundingClientRect().left-s.sizer.getBoundingClientRect().left}function zk(s){var u=sc(s.display),h=s.options.lineWrapping,f=h&&Math.max(5,s.display.scroller.clientWidth/lc(s.display)-3);return function(g){if(Bo(s.doc,g))return 0;var S=0;if(g.widgets)for(var w=0;w<g.widgets.length;w++)g.widgets[w].height&&(S+=g.widgets[w].height);return h?S+(Math.ceil(g.text.length/f)||1)*u:S+u}}function Nv(s){var u=s.doc,h=zk(s);u.iter(function(f){var g=h(f);g!=f.height&&hi(f,g)})}function Gs(s,u,h,f){var g=s.display;if(!h&&Zl(u).getAttribute("cm-not-content")=="true")return null;var S,w,T=g.lineSpace.getBoundingClientRect();try{S=u.clientX-T.left,w=u.clientY-T.top}catch(W){return null}var L=Rv(s,S,w),P;if(f&&L.xRel>0&&(P=_e(s.doc,L.line).text).length==L.ch){var F=Be(P,P.length,s.options.tabSize)-P.length;L=q(L.line,Math.max(0,Math.round((S-Ik(s.display).left)/lc(s.display))-F))}return L}function Ws(s,u){if(u>=s.display.viewTo||(u-=s.display.viewFrom,u<0))return null;for(var h=s.display.view,f=0;f<h.length;f++)if(u-=h[f].size,u<0)return f}function Sr(s,u,h,f){u==null&&(u=s.doc.first),h==null&&(h=s.doc.first+s.doc.size),f||(f=0);var g=s.display;if(f&&h<g.viewTo&&(g.updateLineNumbers==null||g.updateLineNumbers>u)&&(g.updateLineNumbers=u),s.curOp.viewChanged=!0,u>=g.viewTo)ja&&wv(s.doc,u)<g.viewTo&&Fo(s);else if(h<=g.viewFrom)ja&&bk(s.doc,h+f)>g.viewFrom?Fo(s):(g.viewFrom+=f,g.viewTo+=f);else if(u<=g.viewFrom&&h>=g.viewTo)Fo(s);else if(u<=g.viewFrom){var S=qf(s,h,h+f,1);S?(g.view=g.view.slice(S.index),g.viewFrom=S.lineN,g.viewTo+=f):Fo(s)}else if(h>=g.viewTo){var w=qf(s,u,u,-1);w?(g.view=g.view.slice(0,w.index),g.viewTo=w.lineN):Fo(s)}else{var T=qf(s,u,u,-1),L=qf(s,h,h+f,1);T&&L?(g.view=g.view.slice(0,T.index).concat(Hf(s,T.lineN,L.lineN)).concat(g.view.slice(L.index)),g.viewTo+=f):Fo(s)}var P=g.externalMeasured;P&&(h<P.lineN?P.lineN+=f:u<P.lineN+P.size&&(g.externalMeasured=null))}function Uo(s,u,h){s.curOp.viewChanged=!0;var f=s.display,g=s.display.externalMeasured;if(g&&u>=g.lineN&&u<g.lineN+g.size&&(f.externalMeasured=null),!(u<f.viewFrom||u>=f.viewTo)){var S=f.view[Ws(s,u)];if(S.node!=null){var w=S.changes||(S.changes=[]);ge(w,h)==-1&&w.push(h)}}}function Fo(s){s.display.viewFrom=s.display.viewTo=s.doc.first,s.display.view=[],s.display.viewOffset=0}function qf(s,u,h,f){var g=Ws(s,u),S,w=s.display.view;if(!ja||h==s.doc.first+s.doc.size)return{index:g,lineN:h};for(var T=s.display.viewFrom,L=0;L<g;L++)T+=w[L].size;if(T!=u){if(f>0){if(g==w.length-1)return null;S=T+w[g].size-u,g++}else S=T-u;u+=S,h+=S}for(;wv(s.doc,h)!=h;){if(g==(f<0?0:w.length-1))return null;h+=f*w[g-(f<0?1:0)].size,g+=f}return{index:g,lineN:h}}function D3(s,u,h){var f=s.display,g=f.view;g.length==0||u>=f.viewTo||h<=f.viewFrom?(f.view=Hf(s,u,h),f.viewFrom=u):(f.viewFrom>u?f.view=Hf(s,u,f.viewFrom).concat(f.view):f.viewFrom<u&&(f.view=f.view.slice(Ws(s,u))),f.viewFrom=u,f.viewTo<h?f.view=f.view.concat(Hf(s,f.viewTo,h)):f.viewTo>h&&(f.view=f.view.slice(0,Ws(s,h)))),f.viewTo=h}function Hk(s){for(var u=s.display.view,h=0,f=0;f<u.length;f++){var g=u[f];!g.hidden&&(!g.node||g.changes)&&++h}return h}function Ju(s){s.display.input.showSelection(s.display.input.prepareSelection())}function $k(s,u){u===void 0&&(u=!0);for(var h=s.doc,f={},g=f.cursors=document.createDocumentFragment(),S=f.selection=document.createDocumentFragment(),w=0;w<h.sel.ranges.length;w++)if(!(!u&&w==h.sel.primIndex)){var T=h.sel.ranges[w];if(!(T.from().line>=s.display.viewTo||T.to().line<s.display.viewFrom)){var L=T.empty();(L||s.options.showCursorWhenSelecting)&&jk(s,T.head,g),L||P3(s,T,S)}}return f}function jk(s,u,h){var f=Mi(s,u,"div",null,null,!s.options.singleCursorHeightPerLine),g=h.appendChild(R("div","\xA0","CodeMirror-cursor"));if(g.style.left=f.left+"px",g.style.top=f.top+"px",g.style.height=Math.max(0,f.bottom-f.top)*s.options.cursorHeight+"px",f.other){var S=h.appendChild(R("div","\xA0","CodeMirror-cursor CodeMirror-secondarycursor"));S.style.display="",S.style.left=f.other.left+"px",S.style.top=f.other.top+"px",S.style.height=(f.other.bottom-f.other.top)*.85+"px"}}function Jf(s,u){return s.top-u.top||s.left-u.left}function P3(s,u,h){var f=s.display,g=s.doc,S=document.createDocumentFragment(),w=Ik(s.display),T=w.left,L=Math.max(f.sizerWidth,Us(s)-f.sizer.offsetLeft)-w.right,P=g.direction=="ltr";function F(ve,Le,Ue,Ve){Le<0&&(Le=0),Le=Math.round(Le),Ve=Math.round(Ve),S.appendChild(R("div",null,"CodeMirror-selected","position: absolute; left: "+ve+`px;
                             top: `+Le+"px; width: "+(Ue==null?L-ve:Ue)+`px;
                             height: `+(Ve-Le)+"px"))}function W(ve,Le,Ue){var Ve=_e(g,ve),st=Ve.text.length,Nt,Dn;function Zt(dn,Cr){return Av(s,q(ve,dn),"div",Ve,Cr)}function Nr(dn,Cr,Fn){var yn=Wk(s,Ve,null,dn),pn=Cr=="ltr"==(Fn=="after")?"left":"right",nn=Fn=="after"?yn.begin:yn.end-(/\s/.test(Ve.text.charAt(yn.end-1))?2:1);return Zt(nn,pn)[pn]}var xr=Jt(Ve,g.direction);return De(xr,Le||0,Ue==null?st:Ue,function(dn,Cr,Fn,yn){var pn=Fn=="ltr",nn=Zt(dn,pn?"left":"right"),wr=Zt(Cr-1,pn?"right":"left"),xc=Le==null&&dn==0,jo=Ue==null&&Cr==st,$n=yn==0,ma=!xr||yn==xr.length-1;if(wr.top-nn.top<=3){var Pn=(P?xc:jo)&&$n,lS=(P?jo:xc)&&ma,Ka=Pn?T:(pn?nn:wr).left,qs=lS?L:(pn?wr:nn).right;F(Ka,nn.top,qs-Ka,nn.bottom)}else{var Js,nr,Cc,cS;pn?(Js=P&&xc&&$n?T:nn.left,nr=P?L:Nr(dn,Fn,"before"),Cc=P?T:Nr(Cr,Fn,"after"),cS=P&&jo&&ma?L:wr.right):(Js=P?Nr(dn,Fn,"before"):T,nr=!P&&xc&&$n?L:nn.right,Cc=!P&&jo&&ma?T:wr.left,cS=P?Nr(Cr,Fn,"after"):L),F(Js,nn.top,nr-Js,nn.bottom),nn.bottom<wr.top&&F(T,nn.bottom,null,wr.top),F(Cc,wr.top,cS-Cc,wr.bottom)}(!Nt||Jf(nn,Nt)<0)&&(Nt=nn),Jf(wr,Nt)<0&&(Nt=wr),(!Dn||Jf(nn,Dn)<0)&&(Dn=nn),Jf(wr,Dn)<0&&(Dn=wr)}),{start:Nt,end:Dn}}var Y=u.from(),J=u.to();if(Y.line==J.line)W(Y.line,Y.ch,J.ch);else{var ee=_e(g,Y.line),ne=_e(g,J.line),de=pa(ee)==pa(ne),ye=W(Y.line,Y.ch,de?ee.text.length+1:null).end,we=W(J.line,de?0:null,J.ch).start;de&&(ye.top<we.top-2?(F(ye.right,ye.top,null,ye.bottom),F(T,we.top,we.left,we.bottom)):F(ye.right,ye.top,we.left-ye.right,ye.bottom)),ye.bottom<we.top&&F(T,ye.bottom,null,we.top)}h.appendChild(S)}function Bv(s){if(!!s.state.focused){var u=s.display;clearInterval(u.blinker);var h=!0;u.cursorDiv.style.visibility="",s.options.cursorBlinkRate>0?u.blinker=setInterval(function(){s.hasFocus()||cc(s),u.cursorDiv.style.visibility=(h=!h)?"":"hidden"},s.options.cursorBlinkRate):s.options.cursorBlinkRate<0&&(u.cursorDiv.style.visibility="hidden")}}function qk(s){s.state.focused||(s.display.input.focus(),Uv(s))}function Jk(s){s.state.delayingBlurEvent=!0,setTimeout(function(){s.state.delayingBlurEvent&&(s.state.delayingBlurEvent=!1,cc(s))},100)}function Uv(s,u){s.state.delayingBlurEvent&&(s.state.delayingBlurEvent=!1),s.options.readOnly!="nocursor"&&(s.state.focused||(Wt(s,"focus",s,u),s.state.focused=!0,xe(s.display.wrapper,"CodeMirror-focused"),!s.curOp&&s.display.selForContextMenu!=s.doc.sel&&(s.display.input.reset(),c&&setTimeout(function(){return s.display.input.reset(!0)},20)),s.display.input.receivedFocus()),Bv(s))}function cc(s,u){s.state.delayingBlurEvent||(s.state.focused&&(Wt(s,"blur",s,u),s.state.focused=!1,U(s.display.wrapper,"CodeMirror-focused")),clearInterval(s.display.blinker),setTimeout(function(){s.state.focused||(s.display.shift=!1)},150))}function Yf(s){for(var u=s.display,h=u.lineDiv.offsetTop,f=0;f<u.view.length;f++){var g=u.view[f],S=s.options.lineWrapping,w=void 0,T=0;if(!g.hidden){if(o&&l<8){var L=g.node.offsetTop+g.node.offsetHeight;w=L-h,h=L}else{var P=g.node.getBoundingClientRect();w=P.bottom-P.top,!S&&g.text.firstChild&&(T=g.text.firstChild.getBoundingClientRect().right-P.left-1)}var F=g.line.height-w;if((F>.005||F<-.005)&&(hi(g.line,w),Yk(g.line),g.rest))for(var W=0;W<g.rest.length;W++)Yk(g.rest[W]);if(T>s.display.sizerWidth){var Y=Math.ceil(T/lc(s.display));Y>s.display.maxLineLength&&(s.display.maxLineLength=Y,s.display.maxLine=g.line,s.display.maxLineChanged=!0)}}}}function Yk(s){if(s.widgets)for(var u=0;u<s.widgets.length;++u){var h=s.widgets[u],f=h.node.parentNode;f&&(h.height=f.offsetHeight)}}function Kf(s,u,h){var f=h&&h.top!=null?Math.max(0,h.top):s.scroller.scrollTop;f=Math.floor(f-$f(s));var g=h&&h.bottom!=null?h.bottom:f+s.wrapper.clientHeight,S=O(u,f),w=O(u,g);if(h&&h.ensure){var T=h.ensure.from.line,L=h.ensure.to.line;T<S?(S=T,w=O(u,qa(_e(u,T))+s.wrapper.clientHeight)):Math.min(L,u.lastLine())>=w&&(S=O(u,qa(_e(u,L))-s.wrapper.clientHeight),w=L)}return{from:S,to:Math.max(w,S+1)}}function I3(s,u){if(!Ot(s,"scrollCursorIntoView")){var h=s.display,f=h.sizer.getBoundingClientRect(),g=null;if(u.top+f.top<0?g=!0:u.bottom+f.top>(window.innerHeight||document.documentElement.clientHeight)&&(g=!1),g!=null&&!b){var S=R("div","\u200B",null,`position: absolute;
                         top: `+(u.top-h.viewOffset-$f(s.display))+`px;
                         height: `+(u.bottom-u.top+fa(s)+h.barHeight)+`px;
                         left: `+u.left+"px; width: "+Math.max(2,u.right-u.left)+"px;");s.display.lineSpace.appendChild(S),S.scrollIntoView(g),s.display.lineSpace.removeChild(S)}}}function A3(s,u,h,f){f==null&&(f=0);var g;!s.options.lineWrapping&&u==h&&(u=u.ch?q(u.line,u.sticky=="before"?u.ch-1:u.ch,"after"):u,h=u.sticky=="before"?q(u.line,u.ch+1,"before"):u);for(var S=0;S<5;S++){var w=!1,T=Mi(s,u),L=!h||h==u?T:Mi(s,h);g={left:Math.min(T.left,L.left),top:Math.min(T.top,L.top)-f,right:Math.max(T.left,L.left),bottom:Math.max(T.bottom,L.bottom)+f};var P=Fv(s,g),F=s.doc.scrollTop,W=s.doc.scrollLeft;if(P.scrollTop!=null&&(Ku(s,P.scrollTop),Math.abs(s.doc.scrollTop-F)>1&&(w=!0)),P.scrollLeft!=null&&(zs(s,P.scrollLeft),Math.abs(s.doc.scrollLeft-W)>1&&(w=!0)),!w)break}return g}function M3(s,u){var h=Fv(s,u);h.scrollTop!=null&&Ku(s,h.scrollTop),h.scrollLeft!=null&&zs(s,h.scrollLeft)}function Fv(s,u){var h=s.display,f=sc(s.display);u.top<0&&(u.top=0);var g=s.curOp&&s.curOp.scrollTop!=null?s.curOp.scrollTop:h.scroller.scrollTop,S=Dv(s),w={};u.bottom-u.top>S&&(u.bottom=u.top+S);var T=s.doc.height+Ev(h),L=u.top<f,P=u.bottom>T-f;if(u.top<g)w.scrollTop=L?0:u.top;else if(u.bottom>g+S){var F=Math.min(u.top,(P?T:u.bottom)-S);F!=g&&(w.scrollTop=F)}var W=s.options.fixedGutter?0:h.gutters.offsetWidth,Y=s.curOp&&s.curOp.scrollLeft!=null?s.curOp.scrollLeft:h.scroller.scrollLeft-W,J=Us(s)-h.gutters.offsetWidth,ee=u.right-u.left>J;return ee&&(u.right=u.left+J),u.left<10?w.scrollLeft=0:u.left<Y?w.scrollLeft=Math.max(0,u.left+W-(ee?0:10)):u.right>J+Y-3&&(w.scrollLeft=u.right+(ee?0:10)-J),w}function Gv(s,u){u!=null&&(Xf(s),s.curOp.scrollTop=(s.curOp.scrollTop==null?s.doc.scrollTop:s.curOp.scrollTop)+u)}function uc(s){Xf(s);var u=s.getCursor();s.curOp.scrollToPos={from:u,to:u,margin:s.options.cursorScrollMargin}}function Yu(s,u,h){(u!=null||h!=null)&&Xf(s),u!=null&&(s.curOp.scrollLeft=u),h!=null&&(s.curOp.scrollTop=h)}function R3(s,u){Xf(s),s.curOp.scrollToPos=u}function Xf(s){var u=s.curOp.scrollToPos;if(u){s.curOp.scrollToPos=null;var h=Fk(s,u.from),f=Fk(s,u.to);Kk(s,h,f,u.margin)}}function Kk(s,u,h,f){var g=Fv(s,{left:Math.min(u.left,h.left),top:Math.min(u.top,h.top)-f,right:Math.max(u.right,h.right),bottom:Math.max(u.bottom,h.bottom)+f});Yu(s,g.scrollLeft,g.scrollTop)}function Ku(s,u){Math.abs(s.doc.scrollTop-u)<2||(t||zv(s,{top:u}),Xk(s,u,!0),t&&zv(s),Zu(s,100))}function Xk(s,u,h){u=Math.max(0,Math.min(s.display.scroller.scrollHeight-s.display.scroller.clientHeight,u)),!(s.display.scroller.scrollTop==u&&!h)&&(s.doc.scrollTop=u,s.display.scrollbars.setScrollTop(u),s.display.scroller.scrollTop!=u&&(s.display.scroller.scrollTop=u))}function zs(s,u,h,f){u=Math.max(0,Math.min(u,s.display.scroller.scrollWidth-s.display.scroller.clientWidth)),!((h?u==s.doc.scrollLeft:Math.abs(s.doc.scrollLeft-u)<2)&&!f)&&(s.doc.scrollLeft=u,nL(s),s.display.scroller.scrollLeft!=u&&(s.display.scroller.scrollLeft=u),s.display.scrollbars.setScrollLeft(u))}function Xu(s){var u=s.display,h=u.gutters.offsetWidth,f=Math.round(s.doc.height+Ev(s.display));return{clientHeight:u.scroller.clientHeight,viewHeight:u.wrapper.clientHeight,scrollWidth:u.scroller.scrollWidth,clientWidth:u.scroller.clientWidth,viewWidth:u.wrapper.clientWidth,barLeft:s.options.fixedGutter?h:0,docHeight:f,scrollHeight:f+fa(s)+u.barHeight,nativeBarWidth:u.nativeBarWidth,gutterWidth:h}}var Hs=function(s,u,h){this.cm=h;var f=this.vert=R("div",[R("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),g=this.horiz=R("div",[R("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");f.tabIndex=g.tabIndex=-1,s(f),s(g),be(f,"scroll",function(){f.clientHeight&&u(f.scrollTop,"vertical")}),be(g,"scroll",function(){g.clientWidth&&u(g.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,o&&l<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Hs.prototype.update=function(s){var u=s.scrollWidth>s.clientWidth+1,h=s.scrollHeight>s.clientHeight+1,f=s.nativeBarWidth;if(h){this.vert.style.display="block",this.vert.style.bottom=u?f+"px":"0";var g=s.viewHeight-(u?f:0);this.vert.firstChild.style.height=Math.max(0,s.scrollHeight-s.clientHeight+g)+"px"}else this.vert.style.display="",this.vert.firstChild.style.height="0";if(u){this.horiz.style.display="block",this.horiz.style.right=h?f+"px":"0",this.horiz.style.left=s.barLeft+"px";var S=s.viewWidth-s.barLeft-(h?f:0);this.horiz.firstChild.style.width=Math.max(0,s.scrollWidth-s.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&s.clientHeight>0&&(f==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:h?f:0,bottom:u?f:0}},Hs.prototype.setScrollLeft=function(s){this.horiz.scrollLeft!=s&&(this.horiz.scrollLeft=s),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Hs.prototype.setScrollTop=function(s){this.vert.scrollTop!=s&&(this.vert.scrollTop=s),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Hs.prototype.zeroWidthHack=function(){var s=M&&!v?"12px":"18px";this.horiz.style.height=this.vert.style.width=s,this.horiz.style.pointerEvents=this.vert.style.pointerEvents="none",this.disableHoriz=new Pe,this.disableVert=new Pe},Hs.prototype.enableZeroWidthBar=function(s,u,h){s.style.pointerEvents="auto";function f(){var g=s.getBoundingClientRect(),S=h=="vert"?document.elementFromPoint(g.right-1,(g.top+g.bottom)/2):document.elementFromPoint((g.right+g.left)/2,g.bottom-1);S!=s?s.style.pointerEvents="none":u.set(1e3,f)}u.set(1e3,f)},Hs.prototype.clear=function(){var s=this.horiz.parentNode;s.removeChild(this.horiz),s.removeChild(this.vert)};var Qu=function(){};Qu.prototype.update=function(){return{bottom:0,right:0}},Qu.prototype.setScrollLeft=function(){},Qu.prototype.setScrollTop=function(){},Qu.prototype.clear=function(){};function dc(s,u){u||(u=Xu(s));var h=s.display.barWidth,f=s.display.barHeight;Qk(s,u);for(var g=0;g<4&&h!=s.display.barWidth||f!=s.display.barHeight;g++)h!=s.display.barWidth&&s.options.lineWrapping&&Yf(s),Qk(s,Xu(s)),h=s.display.barWidth,f=s.display.barHeight}function Qk(s,u){var h=s.display,f=h.scrollbars.update(u);h.sizer.style.paddingRight=(h.barWidth=f.right)+"px",h.sizer.style.paddingBottom=(h.barHeight=f.bottom)+"px",h.heightForcer.style.borderBottom=f.bottom+"px solid transparent",f.right&&f.bottom?(h.scrollbarFiller.style.display="block",h.scrollbarFiller.style.height=f.bottom+"px",h.scrollbarFiller.style.width=f.right+"px"):h.scrollbarFiller.style.display="",f.bottom&&s.options.coverGutterNextToScrollbar&&s.options.fixedGutter?(h.gutterFiller.style.display="block",h.gutterFiller.style.height=f.bottom+"px",h.gutterFiller.style.width=u.gutterWidth+"px"):h.gutterFiller.style.display=""}var Zk={native:Hs,null:Qu};function eL(s){s.display.scrollbars&&(s.display.scrollbars.clear(),s.display.scrollbars.addClass&&U(s.display.wrapper,s.display.scrollbars.addClass)),s.display.scrollbars=new Zk[s.options.scrollbarStyle](function(u){s.display.wrapper.insertBefore(u,s.display.scrollbarFiller),be(u,"mousedown",function(){s.state.focused&&setTimeout(function(){return s.display.input.focus()},0)}),u.setAttribute("cm-not-content","true")},function(u,h){h=="horizontal"?zs(s,u):Ku(s,u)},s),s.display.scrollbars.addClass&&xe(s.display.wrapper,s.display.scrollbars.addClass)}var _3=0;function $s(s){s.curOp={cm:s,viewChanged:!1,startHeight:s.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++_3},d3(s.curOp)}function js(s){var u=s.curOp;u&&f3(u,function(h){for(var f=0;f<h.ops.length;f++)h.ops[f].cm.curOp=null;V3(h)})}function V3(s){for(var u=s.ops,h=0;h<u.length;h++)O3(u[h]);for(var f=0;f<u.length;f++)N3(u[f]);for(var g=0;g<u.length;g++)B3(u[g]);for(var S=0;S<u.length;S++)U3(u[S]);for(var w=0;w<u.length;w++)F3(u[w])}function O3(s){var u=s.cm,h=u.display;W3(u),s.updateMaxLine&&kv(u),s.mustUpdate=s.viewChanged||s.forceUpdate||s.scrollTop!=null||s.scrollToPos&&(s.scrollToPos.from.line<h.viewFrom||s.scrollToPos.to.line>=h.viewTo)||h.maxLineChanged&&u.options.lineWrapping,s.update=s.mustUpdate&&new Qf(u,s.mustUpdate&&{top:s.scrollTop,ensure:s.scrollToPos},s.forceUpdate)}function N3(s){s.updatedDisplay=s.mustUpdate&&Wv(s.cm,s.update)}function B3(s){var u=s.cm,h=u.display;s.updatedDisplay&&Yf(u),s.barMeasure=Xu(u),h.maxLineChanged&&!u.options.lineWrapping&&(s.adjustWidthTo=Mk(u,h.maxLine,h.maxLine.text.length).left+3,u.display.sizerWidth=s.adjustWidthTo,s.barMeasure.scrollWidth=Math.max(h.scroller.clientWidth,h.sizer.offsetLeft+s.adjustWidthTo+fa(u)+u.display.barWidth),s.maxScrollLeft=Math.max(0,h.sizer.offsetLeft+s.adjustWidthTo-Us(u))),(s.updatedDisplay||s.selectionChanged)&&(s.preparedSelection=h.input.prepareSelection())}function U3(s){var u=s.cm;s.adjustWidthTo!=null&&(u.display.sizer.style.minWidth=s.adjustWidthTo+"px",s.maxScrollLeft<u.doc.scrollLeft&&zs(u,Math.min(u.display.scroller.scrollLeft,s.maxScrollLeft),!0),u.display.maxLineChanged=!1);var h=s.focus&&s.focus==me();s.preparedSelection&&u.display.input.showSelection(s.preparedSelection,h),(s.updatedDisplay||s.startHeight!=u.doc.height)&&dc(u,s.barMeasure),s.updatedDisplay&&$v(u,s.barMeasure),s.selectionChanged&&Bv(u),u.state.focused&&s.updateInput&&u.display.input.reset(s.typing),h&&qk(s.cm)}function F3(s){var u=s.cm,h=u.display,f=u.doc;if(s.updatedDisplay&&tL(u,s.update),h.wheelStartX!=null&&(s.scrollTop!=null||s.scrollLeft!=null||s.scrollToPos)&&(h.wheelStartX=h.wheelStartY=null),s.scrollTop!=null&&Xk(u,s.scrollTop,s.forceScroll),s.scrollLeft!=null&&zs(u,s.scrollLeft,!0,!0),s.scrollToPos){var g=A3(u,Ze(f,s.scrollToPos.from),Ze(f,s.scrollToPos.to),s.scrollToPos.margin);I3(u,g)}var S=s.maybeHiddenMarkers,w=s.maybeUnhiddenMarkers;if(S)for(var T=0;T<S.length;++T)S[T].lines.length||Wt(S[T],"hide");if(w)for(var L=0;L<w.length;++L)w[L].lines.length&&Wt(w[L],"unhide");h.wrapper.offsetHeight&&(f.scrollTop=u.display.scroller.scrollTop),s.changeObjs&&Wt(u,"changes",u,s.changeObjs),s.update&&s.update.finish()}function Or(s,u){if(s.curOp)return u();$s(s);try{return u()}finally{js(s)}}function Ln(s,u){return function(){if(s.curOp)return u.apply(s,arguments);$s(s);try{return u.apply(s,arguments)}finally{js(s)}}}function tr(s){return function(){if(this.curOp)return s.apply(this,arguments);$s(this);try{return s.apply(this,arguments)}finally{js(this)}}}function En(s){return function(){var u=this.cm;if(!u||u.curOp)return s.apply(this,arguments);$s(u);try{return s.apply(this,arguments)}finally{js(u)}}}function Zu(s,u){s.doc.highlightFrontier<s.display.viewTo&&s.state.highlight.set(u,Ie(G3,s))}function G3(s){var u=s.doc;if(!(u.highlightFrontier>=s.display.viewTo)){var h=+new Date+s.options.workTime,f=Wu(s,u.highlightFrontier),g=[];u.iter(f.line,Math.min(u.first+u.size,s.display.viewTo+500),function(S){if(f.line>=s.display.viewFrom){var w=S.styles,T=S.text.length>s.options.maxHighlightLength?fi(u.mode,f.state):null,L=ok(s,S,f,!0);T&&(f.state=T),S.styles=L.styles;var P=S.styleClasses,F=L.classes;F?S.styleClasses=F:P&&(S.styleClasses=null);for(var W=!w||w.length!=S.styles.length||P!=F&&(!P||!F||P.bgClass!=F.bgClass||P.textClass!=F.textClass),Y=0;!W&&Y<w.length;++Y)W=w[Y]!=S.styles[Y];W&&g.push(f.line),S.stateAfter=f.save(),f.nextLine()}else S.text.length<=s.options.maxHighlightLength&&Sv(s,S.text,f),S.stateAfter=f.line%5==0?f.save():null,f.nextLine();if(+new Date>h)return Zu(s,s.options.workDelay),!0}),u.highlightFrontier=f.line,u.modeFrontier=Math.max(u.modeFrontier,f.line),g.length&&Or(s,function(){for(var S=0;S<g.length;S++)Uo(s,g[S],"text")})}}var Qf=function(s,u,h){var f=s.display;this.viewport=u,this.visible=Kf(f,s.doc,u),this.editorIsHidden=!f.wrapper.offsetWidth,this.wrapperHeight=f.wrapper.clientHeight,this.wrapperWidth=f.wrapper.clientWidth,this.oldDisplayWidth=Us(s),this.force=h,this.dims=Vv(s),this.events=[]};Qf.prototype.signal=function(s,u){un(s,u)&&this.events.push(arguments)},Qf.prototype.finish=function(){for(var s=0;s<this.events.length;s++)Wt.apply(null,this.events[s])};function W3(s){var u=s.display;!u.scrollbarsClipped&&u.scroller.offsetWidth&&(u.nativeBarWidth=u.scroller.offsetWidth-u.scroller.clientWidth,u.heightForcer.style.height=fa(s)+"px",u.sizer.style.marginBottom=-u.nativeBarWidth+"px",u.sizer.style.borderRightWidth=fa(s)+"px",u.scrollbarsClipped=!0)}function z3(s){if(s.hasFocus())return null;var u=me();if(!u||!oe(s.display.lineDiv,u))return null;var h={activeElt:u};if(window.getSelection){var f=window.getSelection();f.anchorNode&&f.extend&&oe(s.display.lineDiv,f.anchorNode)&&(h.anchorNode=f.anchorNode,h.anchorOffset=f.anchorOffset,h.focusNode=f.focusNode,h.focusOffset=f.focusOffset)}return h}function H3(s){if(!(!s||!s.activeElt||s.activeElt==me())&&(s.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(s.activeElt.nodeName)&&s.anchorNode&&oe(document.body,s.anchorNode)&&oe(document.body,s.focusNode))){var u=window.getSelection(),h=document.createRange();h.setEnd(s.anchorNode,s.anchorOffset),h.collapse(!1),u.removeAllRanges(),u.addRange(h),u.extend(s.focusNode,s.focusOffset)}}function Wv(s,u){var h=s.display,f=s.doc;if(u.editorIsHidden)return Fo(s),!1;if(!u.force&&u.visible.from>=h.viewFrom&&u.visible.to<=h.viewTo&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo)&&h.renderedView==h.view&&Hk(s)==0)return!1;rL(s)&&(Fo(s),u.dims=Vv(s));var g=f.first+f.size,S=Math.max(u.visible.from-s.options.viewportMargin,f.first),w=Math.min(g,u.visible.to+s.options.viewportMargin);h.viewFrom<S&&S-h.viewFrom<20&&(S=Math.max(f.first,h.viewFrom)),h.viewTo>w&&h.viewTo-w<20&&(w=Math.min(g,h.viewTo)),ja&&(S=wv(s.doc,S),w=bk(s.doc,w));var T=S!=h.viewFrom||w!=h.viewTo||h.lastWrapHeight!=u.wrapperHeight||h.lastWrapWidth!=u.wrapperWidth;D3(s,S,w),h.viewOffset=qa(_e(s.doc,h.viewFrom)),s.display.mover.style.top=h.viewOffset+"px";var L=Hk(s);if(!T&&L==0&&!u.force&&h.renderedView==h.view&&(h.updateLineNumbers==null||h.updateLineNumbers>=h.viewTo))return!1;var P=z3(s);return L>4&&(h.lineDiv.style.display="none"),$3(s,h.updateLineNumbers,u.dims),L>4&&(h.lineDiv.style.display=""),h.renderedView=h.view,H3(P),_(h.cursorDiv),_(h.selectionDiv),h.gutters.style.height=h.sizer.style.minHeight=0,T&&(h.lastWrapHeight=u.wrapperHeight,h.lastWrapWidth=u.wrapperWidth,Zu(s,400)),h.updateLineNumbers=null,!0}function tL(s,u){for(var h=u.viewport,f=!0;;f=!1){if(!f||!s.options.lineWrapping||u.oldDisplayWidth==Us(s)){if(h&&h.top!=null&&(h={top:Math.min(s.doc.height+Ev(s.display)-Dv(s),h.top)}),u.visible=Kf(s.display,s.doc,h),u.visible.from>=s.display.viewFrom&&u.visible.to<=s.display.viewTo)break}else f&&(u.visible=Kf(s.display,s.doc,h));if(!Wv(s,u))break;Yf(s);var g=Xu(s);Ju(s),dc(s,g),$v(s,g),u.force=!1}u.signal(s,"update",s),(s.display.viewFrom!=s.display.reportedViewFrom||s.display.viewTo!=s.display.reportedViewTo)&&(u.signal(s,"viewportChange",s,s.display.viewFrom,s.display.viewTo),s.display.reportedViewFrom=s.display.viewFrom,s.display.reportedViewTo=s.display.viewTo)}function zv(s,u){var h=new Qf(s,u);if(Wv(s,h)){Yf(s),tL(s,h);var f=Xu(s);Ju(s),dc(s,f),$v(s,f),h.finish()}}function $3(s,u,h){var f=s.display,g=s.options.lineNumbers,S=f.lineDiv,w=S.firstChild;function T(ee){var ne=ee.nextSibling;return c&&M&&s.display.currentWheelTarget==ee?ee.style.display="none":ee.parentNode.removeChild(ee),ne}for(var L=f.view,P=f.viewFrom,F=0;F<L.length;F++){var W=L[F];if(!W.hidden)if(!W.node||W.node.parentNode!=S){var Y=v3(s,W,P,h);S.insertBefore(Y,w)}else{for(;w!=W.node;)w=T(w);var J=g&&u!=null&&u<=P&&W.lineNumber;W.changes&&(ge(W.changes,"gutter")>-1&&(J=!1),kk(s,W,P,h)),J&&(_(W.lineNumber),W.lineNumber.appendChild(document.createTextNode(te(s.options,P)))),w=W.node.nextSibling}P+=W.size}for(;w;)w=T(w)}function Hv(s){var u=s.gutters.offsetWidth;s.sizer.style.marginLeft=u+"px"}function $v(s,u){s.display.sizer.style.minHeight=u.docHeight+"px",s.display.heightForcer.style.top=u.docHeight+"px",s.display.gutters.style.height=u.docHeight+s.display.barHeight+fa(s)+"px"}function nL(s){var u=s.display,h=u.view;if(!(!u.alignWidgets&&(!u.gutters.firstChild||!s.options.fixedGutter))){for(var f=Ov(u)-u.scroller.scrollLeft+s.doc.scrollLeft,g=u.gutters.offsetWidth,S=f+"px",w=0;w<h.length;w++)if(!h[w].hidden){s.options.fixedGutter&&(h[w].gutter&&(h[w].gutter.style.left=S),h[w].gutterBackground&&(h[w].gutterBackground.style.left=S));var T=h[w].alignable;if(T)for(var L=0;L<T.length;L++)T[L].style.left=S}s.options.fixedGutter&&(u.gutters.style.left=f+g+"px")}}function rL(s){if(!s.options.lineNumbers)return!1;var u=s.doc,h=te(s.options,u.first+u.size-1),f=s.display;if(h.length!=f.lineNumChars){var g=f.measure.appendChild(R("div",[R("div",h)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=g.firstChild.offsetWidth,w=g.offsetWidth-S;return f.lineGutter.style.width="",f.lineNumInnerWidth=Math.max(S,f.lineGutter.offsetWidth-w)+1,f.lineNumWidth=f.lineNumInnerWidth+w,f.lineNumChars=f.lineNumInnerWidth?h.length:-1,f.lineGutter.style.width=f.lineNumWidth+"px",Hv(s.display),!0}return!1}function jv(s,u){for(var h=[],f=!1,g=0;g<s.length;g++){var S=s[g],w=null;if(typeof S!="string"&&(w=S.style,S=S.className),S=="CodeMirror-linenumbers")if(u)f=!0;else continue;h.push({className:S,style:w})}return u&&!f&&h.push({className:"CodeMirror-linenumbers",style:null}),h}function iL(s){var u=s.gutters,h=s.gutterSpecs;_(u),s.lineGutter=null;for(var f=0;f<h.length;++f){var g=h[f],S=g.className,w=g.style,T=u.appendChild(R("div",null,"CodeMirror-gutter "+S));w&&(T.style.cssText=w),S=="CodeMirror-linenumbers"&&(s.lineGutter=T,T.style.width=(s.lineNumWidth||1)+"px")}u.style.display=h.length?"":"none",Hv(s)}function ed(s){iL(s.display),Sr(s),nL(s)}function j3(s,u,h,f){var g=this;this.input=h,g.scrollbarFiller=R("div",null,"CodeMirror-scrollbar-filler"),g.scrollbarFiller.setAttribute("cm-not-content","true"),g.gutterFiller=R("div",null,"CodeMirror-gutter-filler"),g.gutterFiller.setAttribute("cm-not-content","true"),g.lineDiv=X("div",null,"CodeMirror-code"),g.selectionDiv=R("div",null,null,"position: relative; z-index: 1"),g.cursorDiv=R("div",null,"CodeMirror-cursors"),g.measure=R("div",null,"CodeMirror-measure"),g.lineMeasure=R("div",null,"CodeMirror-measure"),g.lineSpace=X("div",[g.measure,g.lineMeasure,g.selectionDiv,g.cursorDiv,g.lineDiv],null,"position: relative; outline: none");var S=X("div",[g.lineSpace],"CodeMirror-lines");g.mover=R("div",[S],null,"position: relative"),g.sizer=R("div",[g.mover],"CodeMirror-sizer"),g.sizerWidth=null,g.heightForcer=R("div",null,null,"position: absolute; height: "+$e+"px; width: 1px;"),g.gutters=R("div",null,"CodeMirror-gutters"),g.lineGutter=null,g.scroller=R("div",[g.sizer,g.heightForcer,g.gutters],"CodeMirror-scroll"),g.scroller.setAttribute("tabIndex","-1"),g.wrapper=R("div",[g.scrollbarFiller,g.gutterFiller,g.scroller],"CodeMirror"),o&&l<8&&(g.gutters.style.zIndex=-1,g.scroller.style.paddingRight=0),!c&&!(t&&k)&&(g.scroller.draggable=!0),s&&(s.appendChild?s.appendChild(g.wrapper):s(g.wrapper)),g.viewFrom=g.viewTo=u.first,g.reportedViewFrom=g.reportedViewTo=u.first,g.view=[],g.renderedView=null,g.externalMeasured=null,g.viewOffset=0,g.lastWrapHeight=g.lastWrapWidth=0,g.updateLineNumbers=null,g.nativeBarWidth=g.barHeight=g.barWidth=0,g.scrollbarsClipped=!1,g.lineNumWidth=g.lineNumInnerWidth=g.lineNumChars=null,g.alignWidgets=!1,g.cachedCharWidth=g.cachedTextHeight=g.cachedPaddingH=null,g.maxLine=null,g.maxLineLength=0,g.maxLineChanged=!1,g.wheelDX=g.wheelDY=g.wheelStartX=g.wheelStartY=null,g.shift=!1,g.selForContextMenu=null,g.activeTouch=null,g.gutterSpecs=jv(f.gutters,f.lineNumbers),iL(g),h.init(g)}var Zf=0,qr=null;o?qr=-.53:t?qr=15:p?qr=-.7:y&&(qr=-1/3);function aL(s){var u=s.wheelDeltaX,h=s.wheelDeltaY;return u==null&&s.detail&&s.axis==s.HORIZONTAL_AXIS&&(u=s.detail),h==null&&s.detail&&s.axis==s.VERTICAL_AXIS?h=s.detail:h==null&&(h=s.wheelDelta),{x:u,y:h}}function q3(s){var u=aL(s);return u.x*=qr,u.y*=qr,u}function oL(s,u){var h=aL(u),f=h.x,g=h.y,S=s.display,w=S.scroller,T=w.scrollWidth>w.clientWidth,L=w.scrollHeight>w.clientHeight;if(!!(f&&T||g&&L)){if(g&&M&&c){e:for(var P=u.target,F=S.view;P!=w;P=P.parentNode)for(var W=0;W<F.length;W++)if(F[W].node==P){s.display.currentWheelTarget=P;break e}}if(f&&!t&&!m&&qr!=null){g&&L&&Ku(s,Math.max(0,w.scrollTop+g*qr)),zs(s,Math.max(0,w.scrollLeft+f*qr)),(!g||g&&L)&&mn(u),S.wheelStartX=null;return}if(g&&qr!=null){var Y=g*qr,J=s.doc.scrollTop,ee=J+S.wrapper.clientHeight;Y<0?J=Math.max(0,J+Y-50):ee=Math.min(s.doc.height,ee+Y+50),zv(s,{top:J,bottom:ee})}Zf<20&&(S.wheelStartX==null?(S.wheelStartX=w.scrollLeft,S.wheelStartY=w.scrollTop,S.wheelDX=f,S.wheelDY=g,setTimeout(function(){if(S.wheelStartX!=null){var ne=w.scrollLeft-S.wheelStartX,de=w.scrollTop-S.wheelStartY,ye=de&&S.wheelDY&&de/S.wheelDY||ne&&S.wheelDX&&ne/S.wheelDX;S.wheelStartX=S.wheelStartY=null,!!ye&&(qr=(qr*Zf+ye)/(Zf+1),++Zf)}},200)):(S.wheelDX+=f,S.wheelDY+=g))}}var Jr=function(s,u){this.ranges=s,this.primIndex=u};Jr.prototype.primary=function(){return this.ranges[this.primIndex]},Jr.prototype.equals=function(s){if(s==this)return!0;if(s.primIndex!=this.primIndex||s.ranges.length!=this.ranges.length)return!1;for(var u=0;u<this.ranges.length;u++){var h=this.ranges[u],f=s.ranges[u];if(!pt(h.anchor,f.anchor)||!pt(h.head,f.head))return!1}return!0},Jr.prototype.deepCopy=function(){for(var s=[],u=0;u<this.ranges.length;u++)s[u]=new xt(kt(this.ranges[u].anchor),kt(this.ranges[u].head));return new Jr(s,this.primIndex)},Jr.prototype.somethingSelected=function(){for(var s=0;s<this.ranges.length;s++)if(!this.ranges[s].empty())return!0;return!1},Jr.prototype.contains=function(s,u){u||(u=s);for(var h=0;h<this.ranges.length;h++){var f=this.ranges[h];if(he(u,f.from())>=0&&he(s,f.to())<=0)return h}return-1};var xt=function(s,u){this.anchor=s,this.head=u};xt.prototype.from=function(){return vr(this.anchor,this.head)},xt.prototype.to=function(){return gn(this.anchor,this.head)},xt.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Ri(s,u,h){var f=s&&s.options.selectionsMayTouch,g=u[h];u.sort(function(Y,J){return he(Y.from(),J.from())}),h=ge(u,g);for(var S=1;S<u.length;S++){var w=u[S],T=u[S-1],L=he(T.to(),w.from());if(f&&!w.empty()?L>0:L>=0){var P=vr(T.from(),w.from()),F=gn(T.to(),w.to()),W=T.empty()?w.from()==w.head:T.from()==T.head;S<=h&&--h,u.splice(--S,2,new xt(W?F:P,W?P:F))}}return new Jr(u,h)}function Go(s,u){return new Jr([new xt(s,u||s)],0)}function Wo(s){return s.text?q(s.from.line+s.text.length-1,Oe(s.text).length+(s.text.length==1?s.from.ch:0)):s.to}function sL(s,u){if(he(s,u.from)<0)return s;if(he(s,u.to)<=0)return Wo(u);var h=s.line+u.text.length-(u.to.line-u.from.line)-1,f=s.ch;return s.line==u.to.line&&(f+=Wo(u).ch-u.to.ch),q(h,f)}function qv(s,u){for(var h=[],f=0;f<s.sel.ranges.length;f++){var g=s.sel.ranges[f];h.push(new xt(sL(g.anchor,u),sL(g.head,u)))}return Ri(s.cm,h,s.sel.primIndex)}function lL(s,u,h){return s.line==u.line?q(h.line,s.ch-u.ch+h.ch):q(h.line+(s.line-u.line),s.ch)}function J3(s,u,h){for(var f=[],g=q(s.first,0),S=g,w=0;w<u.length;w++){var T=u[w],L=lL(T.from,g,S),P=lL(Wo(T),g,S);if(g=T.to,S=P,h=="around"){var F=s.sel.ranges[w],W=he(F.head,F.anchor)<0;f[w]=new xt(W?P:L,W?L:P)}else f[w]=new xt(L,L)}return new Jr(f,s.sel.primIndex)}function Jv(s){s.doc.mode=Fu(s.options,s.doc.modeOption),td(s)}function td(s){s.doc.iter(function(u){u.stateAfter&&(u.stateAfter=null),u.styles&&(u.styles=null)}),s.doc.modeFrontier=s.doc.highlightFrontier=s.doc.first,Zu(s,100),s.state.modeGen++,s.curOp&&Sr(s)}function cL(s,u){return u.from.ch==0&&u.to.ch==0&&Oe(u.text)==""&&(!s.cm||s.cm.options.wholeLineUpdateBefore)}function Yv(s,u,h,f){function g(we){return h?h[we]:null}function S(we,ve,Le){n3(we,ve,Le,f),Un(we,"change",we,u)}function w(we,ve){for(var Le=[],Ue=we;Ue<ve;++Ue)Le.push(new ic(P[Ue],g(Ue),f));return Le}var T=u.from,L=u.to,P=u.text,F=_e(s,T.line),W=_e(s,L.line),Y=Oe(P),J=g(P.length-1),ee=L.line-T.line;if(u.full)s.insert(0,w(0,P.length)),s.remove(P.length,s.size-P.length);else if(cL(s,u)){var ne=w(0,P.length-1);S(W,W.text,J),ee&&s.remove(T.line,ee),ne.length&&s.insert(T.line,ne)}else if(F==W)if(P.length==1)S(F,F.text.slice(0,T.ch)+Y+F.text.slice(L.ch),J);else{var de=w(1,P.length-1);de.push(new ic(Y+F.text.slice(L.ch),J,f)),S(F,F.text.slice(0,T.ch)+P[0],g(0)),s.insert(T.line+1,de)}else if(P.length==1)S(F,F.text.slice(0,T.ch)+P[0]+W.text.slice(L.ch),g(0)),s.remove(T.line+1,ee);else{S(F,F.text.slice(0,T.ch)+P[0],g(0)),S(W,Y+W.text.slice(L.ch),J);var ye=w(1,P.length-1);ee>1&&s.remove(T.line+1,ee-1),s.insert(T.line+1,ye)}Un(s,"change",s,u)}function zo(s,u,h){function f(g,S,w){if(g.linked)for(var T=0;T<g.linked.length;++T){var L=g.linked[T];if(L.doc!=S){var P=w&&L.sharedHist;h&&!P||(u(L.doc,P),f(L.doc,g,P))}}}f(s,null,!0)}function uL(s,u){if(u.cm)throw new Error("This document is already in use.");s.doc=u,u.cm=s,Nv(s),Jv(s),dL(s),s.options.lineWrapping||kv(s),s.options.mode=u.modeOption,Sr(s)}function dL(s){(s.doc.direction=="rtl"?xe:U)(s.display.lineDiv,"CodeMirror-rtl")}function Y3(s){Or(s,function(){dL(s),Sr(s)})}function eh(s){this.done=[],this.undone=[],this.undoDepth=Infinity,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=s||1}function Kv(s,u){var h={from:kt(u.from),to:Wo(u),text:ua(s,u.from,u.to)};return hL(s,h,u.from.line,u.to.line+1),zo(s,function(f){return hL(f,h,u.from.line,u.to.line+1)},!0),h}function pL(s){for(;s.length;){var u=Oe(s);if(u.ranges)s.pop();else break}}function K3(s,u){if(u)return pL(s.done),Oe(s.done);if(s.done.length&&!Oe(s.done).ranges)return Oe(s.done);if(s.done.length>1&&!s.done[s.done.length-2].ranges)return s.done.pop(),Oe(s.done)}function fL(s,u,h,f){var g=s.history;g.undone.length=0;var S=+new Date,w,T;if((g.lastOp==f||g.lastOrigin==u.origin&&u.origin&&(u.origin.charAt(0)=="+"&&g.lastModTime>S-(s.cm?s.cm.options.historyEventDelay:500)||u.origin.charAt(0)=="*"))&&(w=K3(g,g.lastOp==f)))T=Oe(w.changes),he(u.from,u.to)==0&&he(u.from,T.to)==0?T.to=Wo(u):w.changes.push(Kv(s,u));else{var L=Oe(g.done);for((!L||!L.ranges)&&th(s.sel,g.done),w={changes:[Kv(s,u)],generation:g.generation},g.done.push(w);g.done.length>g.undoDepth;)g.done.shift(),g.done[0].ranges||g.done.shift()}g.done.push(h),g.generation=++g.maxGeneration,g.lastModTime=g.lastSelTime=S,g.lastOp=g.lastSelOp=f,g.lastOrigin=g.lastSelOrigin=u.origin,T||Wt(s,"historyAdded")}function X3(s,u,h,f){var g=u.charAt(0);return g=="*"||g=="+"&&h.ranges.length==f.ranges.length&&h.somethingSelected()==f.somethingSelected()&&new Date-s.history.lastSelTime<=(s.cm?s.cm.options.historyEventDelay:500)}function Q3(s,u,h,f){var g=s.history,S=f&&f.origin;h==g.lastSelOp||S&&g.lastSelOrigin==S&&(g.lastModTime==g.lastSelTime&&g.lastOrigin==S||X3(s,S,Oe(g.done),u))?g.done[g.done.length-1]=u:th(u,g.done),g.lastSelTime=+new Date,g.lastSelOrigin=S,g.lastSelOp=h,f&&f.clearRedo!==!1&&pL(g.undone)}function th(s,u){var h=Oe(u);h&&h.ranges&&h.equals(s)||u.push(s)}function hL(s,u,h,f){var g=u["spans_"+s.id],S=0;s.iter(Math.max(s.first,h),Math.min(s.first+s.size,f),function(w){w.markedSpans&&((g||(g=u["spans_"+s.id]={}))[S]=w.markedSpans),++S})}function Z3(s){if(!s)return null;for(var u,h=0;h<s.length;++h)s[h].marker.explicitlyCleared?u||(u=s.slice(0,h)):u&&u.push(s[h]);return u?u.length?u:null:s}function e4(s,u){var h=u["spans_"+s.id];if(!h)return null;for(var f=[],g=0;g<u.text.length;++g)f.push(Z3(h[g]));return f}function mL(s,u){var h=e4(s,u),f=xv(s,u);if(!h)return f;if(!f)return h;for(var g=0;g<h.length;++g){var S=h[g],w=f[g];if(S&&w){e:for(var T=0;T<w.length;++T){for(var L=w[T],P=0;P<S.length;++P)if(S[P].marker==L.marker)continue e;S.push(L)}}else w&&(h[g]=w)}return h}function pc(s,u,h){for(var f=[],g=0;g<s.length;++g){var S=s[g];if(S.ranges){f.push(h?Jr.prototype.deepCopy.call(S):S);continue}var w=S.changes,T=[];f.push({changes:T});for(var L=0;L<w.length;++L){var P=w[L],F=void 0;if(T.push({from:P.from,to:P.to,text:P.text}),u)for(var W in P)(F=W.match(/^spans_(\d+)$/))&&ge(u,Number(F[1]))>-1&&(Oe(T)[W]=P[W],delete P[W])}}return f}function Xv(s,u,h,f){if(f){var g=s.anchor;if(h){var S=he(u,g)<0;S!=he(h,g)<0?(g=u,u=h):S!=he(u,h)<0&&(u=h)}return new xt(g,u)}else return new xt(h||u,u)}function nh(s,u,h,f,g){g==null&&(g=s.cm&&(s.cm.display.shift||s.extend)),Hn(s,new Jr([Xv(s.sel.primary(),u,h,g)],0),f)}function gL(s,u,h){for(var f=[],g=s.cm&&(s.cm.display.shift||s.extend),S=0;S<s.sel.ranges.length;S++)f[S]=Xv(s.sel.ranges[S],u[S],null,g);var w=Ri(s.cm,f,s.sel.primIndex);Hn(s,w,h)}function Qv(s,u,h,f){var g=s.sel.ranges.slice(0);g[u]=h,Hn(s,Ri(s.cm,g,s.sel.primIndex),f)}function yL(s,u,h,f){Hn(s,Go(u,h),f)}function t4(s,u,h){var f={ranges:u.ranges,update:function(g){this.ranges=[];for(var S=0;S<g.length;S++)this.ranges[S]=new xt(Ze(s,g[S].anchor),Ze(s,g[S].head))},origin:h&&h.origin};return Wt(s,"beforeSelectionChange",s,f),s.cm&&Wt(s.cm,"beforeSelectionChange",s.cm,f),f.ranges!=u.ranges?Ri(s.cm,f.ranges,f.ranges.length-1):u}function vL(s,u,h){var f=s.history.done,g=Oe(f);g&&g.ranges?(f[f.length-1]=u,rh(s,u,h)):Hn(s,u,h)}function Hn(s,u,h){rh(s,u,h),Q3(s,s.sel,s.cm?s.cm.curOp.id:NaN,h)}function rh(s,u,h){(un(s,"beforeSelectionChange")||s.cm&&un(s.cm,"beforeSelectionChange"))&&(u=t4(s,u,h));var f=h&&h.bias||(he(u.primary().head,s.sel.primary().head)<0?-1:1);SL(s,xL(s,u,f,!0)),!(h&&h.scroll===!1)&&s.cm&&uc(s.cm)}function SL(s,u){u.equals(s.sel)||(s.sel=u,s.cm&&(s.cm.curOp.updateInput=1,s.cm.curOp.selectionChanged=!0,Ql(s.cm)),Un(s,"cursorActivity",s))}function bL(s){SL(s,xL(s,s.sel,null,!1))}function xL(s,u,h,f){for(var g,S=0;S<u.ranges.length;S++){var w=u.ranges[S],T=u.ranges.length==s.sel.ranges.length&&s.sel.ranges[S],L=ih(s,w.anchor,T&&T.anchor,h,f),P=ih(s,w.head,T&&T.head,h,f);(g||L!=w.anchor||P!=w.head)&&(g||(g=u.ranges.slice(0,S)),g[S]=new xt(L,P))}return g?Ri(s.cm,g,u.primIndex):u}function fc(s,u,h,f,g){var S=_e(s,u.line);if(S.markedSpans)for(var w=0;w<S.markedSpans.length;++w){var T=S.markedSpans[w],L=T.marker,P="selectLeft"in L?!L.selectLeft:L.inclusiveLeft,F="selectRight"in L?!L.selectRight:L.inclusiveRight;if((T.from==null||(P?T.from<=u.ch:T.from<u.ch))&&(T.to==null||(F?T.to>=u.ch:T.to>u.ch))){if(g&&(Wt(L,"beforeCursorEnter"),L.explicitlyCleared))if(S.markedSpans){--w;continue}else break;if(!L.atomic)continue;if(h){var W=L.find(f<0?1:-1),Y=void 0;if((f<0?F:P)&&(W=CL(s,W,-f,W&&W.line==u.line?S:null)),W&&W.line==u.line&&(Y=he(W,h))&&(f<0?Y<0:Y>0))return fc(s,W,u,f,g)}var J=L.find(f<0?-1:1);return(f<0?P:F)&&(J=CL(s,J,f,J.line==u.line?S:null)),J?fc(s,J,u,f,g):null}}return u}function ih(s,u,h,f,g){var S=f||1,w=fc(s,u,h,S,g)||!g&&fc(s,u,h,S,!0)||fc(s,u,h,-S,g)||!g&&fc(s,u,h,-S,!0);return w||(s.cantEdit=!0,q(s.first,0))}function CL(s,u,h,f){return h<0&&u.ch==0?u.line>s.first?Ze(s,q(u.line-1)):null:h>0&&u.ch==(f||_e(s,u.line)).text.length?u.line<s.first+s.size-1?q(u.line+1,0):null:new q(u.line,u.ch+h)}function wL(s){s.setSelection(q(s.firstLine(),0),q(s.lastLine()),Dt)}function TL(s,u,h){var f={canceled:!1,from:u.from,to:u.to,text:u.text,origin:u.origin,cancel:function(){return f.canceled=!0}};return h&&(f.update=function(g,S,w,T){g&&(f.from=Ze(s,g)),S&&(f.to=Ze(s,S)),w&&(f.text=w),T!==void 0&&(f.origin=T)}),Wt(s,"beforeChange",s,f),s.cm&&Wt(s.cm,"beforeChange",s.cm,f),f.canceled?(s.cm&&(s.cm.curOp.updateInput=2),null):{from:f.from,to:f.to,text:f.text,origin:f.origin}}function hc(s,u,h){if(s.cm){if(!s.cm.curOp)return Ln(s.cm,hc)(s,u,h);if(s.cm.state.suppressEdits)return}if(!((un(s,"beforeChange")||s.cm&&un(s.cm,"beforeChange"))&&(u=TL(s,u,!0),!u))){var f=fk&&!h&&QF(s,u.from,u.to);if(f)for(var g=f.length-1;g>=0;--g)kL(s,{from:f[g].from,to:f[g].to,text:g?[""]:u.text,origin:u.origin});else kL(s,u)}}function kL(s,u){if(!(u.text.length==1&&u.text[0]==""&&he(u.from,u.to)==0)){var h=qv(s,u);fL(s,u,h,s.cm?s.cm.curOp.id:NaN),nd(s,u,h,xv(s,u));var f=[];zo(s,function(g,S){!S&&ge(f,g.history)==-1&&(PL(g.history,u),f.push(g.history)),nd(g,u,null,xv(g,u))})}}function ah(s,u,h){var f=s.cm&&s.cm.state.suppressEdits;if(!(f&&!h)){for(var g=s.history,S,w=s.sel,T=u=="undo"?g.done:g.undone,L=u=="undo"?g.undone:g.done,P=0;P<T.length&&(S=T[P],!(h?S.ranges&&!S.equals(s.sel):!S.ranges));P++);if(P!=T.length){for(g.lastOrigin=g.lastSelOrigin=null;;)if(S=T.pop(),S.ranges){if(th(S,L),h&&!S.equals(s.sel)){Hn(s,S,{clearRedo:!1});return}w=S}else if(f){T.push(S);return}else break;var F=[];th(w,L),L.push({changes:F,generation:g.generation}),g.generation=S.generation||++g.maxGeneration;for(var W=un(s,"beforeChange")||s.cm&&un(s.cm,"beforeChange"),Y=function(ne){var de=S.changes[ne];if(de.origin=u,W&&!TL(s,de,!1))return T.length=0,{};F.push(Kv(s,de));var ye=ne?qv(s,de):Oe(T);nd(s,de,ye,mL(s,de)),!ne&&s.cm&&s.cm.scrollIntoView({from:de.from,to:Wo(de)});var we=[];zo(s,function(ve,Le){!Le&&ge(we,ve.history)==-1&&(PL(ve.history,de),we.push(ve.history)),nd(ve,de,null,mL(ve,de))})},J=S.changes.length-1;J>=0;--J){var ee=Y(J);if(ee)return ee.v}}}}function LL(s,u){if(u!=0&&(s.first+=u,s.sel=new Jr(ln(s.sel.ranges,function(g){return new xt(q(g.anchor.line+u,g.anchor.ch),q(g.head.line+u,g.head.ch))}),s.sel.primIndex),s.cm)){Sr(s.cm,s.first,s.first-u,u);for(var h=s.cm.display,f=h.viewFrom;f<h.viewTo;f++)Uo(s.cm,f,"gutter")}}function nd(s,u,h,f){if(s.cm&&!s.cm.curOp)return Ln(s.cm,nd)(s,u,h,f);if(u.to.line<s.first){LL(s,u.text.length-1-(u.to.line-u.from.line));return}if(!(u.from.line>s.lastLine())){if(u.from.line<s.first){var g=u.text.length-1-(s.first-u.from.line);LL(s,g),u={from:q(s.first,0),to:q(u.to.line+g,u.to.ch),text:[Oe(u.text)],origin:u.origin}}var S=s.lastLine();u.to.line>S&&(u={from:u.from,to:q(S,_e(s,S).text.length),text:[u.text[0]],origin:u.origin}),u.removed=ua(s,u.from,u.to),h||(h=qv(s,u)),s.cm?n4(s.cm,u,f):Yv(s,u,f),rh(s,h,Dt),s.cantEdit&&ih(s,q(s.firstLine(),0))&&(s.cantEdit=!1)}}function n4(s,u,h){var f=s.doc,g=s.display,S=u.from,w=u.to,T=!1,L=S.line;s.options.lineWrapping||(L=vt(pa(_e(f,S.line))),f.iter(L,w.line+1,function(J){if(J==g.maxLine)return T=!0,!0})),f.sel.contains(u.from,u.to)>-1&&Ql(s),Yv(f,u,h,zk(s)),s.options.lineWrapping||(f.iter(L,S.line+u.text.length,function(J){var ee=zf(J);ee>g.maxLineLength&&(g.maxLine=J,g.maxLineLength=ee,g.maxLineChanged=!0,T=!1)}),T&&(s.curOp.updateMaxLine=!0)),$F(f,S.line),Zu(s,400);var P=u.text.length-(w.line-S.line)-1;u.full?Sr(s):S.line==w.line&&u.text.length==1&&!cL(s.doc,u)?Uo(s,S.line,"text"):Sr(s,S.line,w.line+1,P);var F=un(s,"changes"),W=un(s,"change");if(W||F){var Y={from:S,to:w,text:u.text,removed:u.removed,origin:u.origin};W&&Un(s,"change",s,Y),F&&(s.curOp.changeObjs||(s.curOp.changeObjs=[])).push(Y)}s.display.selForContextMenu=null}function mc(s,u,h,f,g){var S;f||(f=h),he(f,h)<0&&(S=[f,h],h=S[0],f=S[1]),typeof u=="string"&&(u=s.splitLines(u)),hc(s,{from:h,to:f,text:u,origin:g})}function EL(s,u,h,f){h<s.line?s.line+=f:u<s.line&&(s.line=u,s.ch=0)}function DL(s,u,h,f){for(var g=0;g<s.length;++g){var S=s[g],w=!0;if(S.ranges){S.copied||(S=s[g]=S.deepCopy(),S.copied=!0);for(var T=0;T<S.ranges.length;T++)EL(S.ranges[T].anchor,u,h,f),EL(S.ranges[T].head,u,h,f);continue}for(var L=0;L<S.changes.length;++L){var P=S.changes[L];if(h<P.from.line)P.from=q(P.from.line+f,P.from.ch),P.to=q(P.to.line+f,P.to.ch);else if(u<=P.to.line){w=!1;break}}w||(s.splice(0,g+1),g=0)}}function PL(s,u){var h=u.from.line,f=u.to.line,g=u.text.length-(f-h)-1;DL(s.done,h,f,g),DL(s.undone,h,f,g)}function rd(s,u,h,f){var g=u,S=u;return typeof u=="number"?S=_e(s,Nf(s,u)):g=vt(u),g==null?null:(f(S,g)&&s.cm&&Uo(s.cm,g,h),S)}function id(s){this.lines=s,this.parent=null;for(var u=0,h=0;h<s.length;++h)s[h].parent=this,u+=s[h].height;this.height=u}id.prototype={chunkSize:function(){return this.lines.length},removeInner:function(s,u){for(var h=s,f=s+u;h<f;++h){var g=this.lines[h];this.height-=g.height,r3(g),Un(g,"delete")}this.lines.splice(s,u)},collapse:function(s){s.push.apply(s,this.lines)},insertInner:function(s,u,h){this.height+=h,this.lines=this.lines.slice(0,s).concat(u).concat(this.lines.slice(s));for(var f=0;f<u.length;++f)u[f].parent=this},iterN:function(s,u,h){for(var f=s+u;s<f;++s)if(h(this.lines[s]))return!0}};function ad(s){this.children=s;for(var u=0,h=0,f=0;f<s.length;++f){var g=s[f];u+=g.chunkSize(),h+=g.height,g.parent=this}this.size=u,this.height=h,this.parent=null}ad.prototype={chunkSize:function(){return this.size},removeInner:function(s,u){this.size-=u;for(var h=0;h<this.children.length;++h){var f=this.children[h],g=f.chunkSize();if(s<g){var S=Math.min(u,g-s),w=f.height;if(f.removeInner(s,S),this.height-=w-f.height,g==S&&(this.children.splice(h--,1),f.parent=null),(u-=S)==0)break;s=0}else s-=g}if(this.size-u<25&&(this.children.length>1||!(this.children[0]instanceof id))){var T=[];this.collapse(T),this.children=[new id(T)],this.children[0].parent=this}},collapse:function(s){for(var u=0;u<this.children.length;++u)this.children[u].collapse(s)},insertInner:function(s,u,h){this.size+=u.length,this.height+=h;for(var f=0;f<this.children.length;++f){var g=this.children[f],S=g.chunkSize();if(s<=S){if(g.insertInner(s,u,h),g.lines&&g.lines.length>50){for(var w=g.lines.length%25+25,T=w;T<g.lines.length;){var L=new id(g.lines.slice(T,T+=25));g.height-=L.height,this.children.splice(++f,0,L),L.parent=this}g.lines=g.lines.slice(0,w),this.maybeSpill()}break}s-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var s=this;do{var u=s.children.splice(s.children.length-5,5),h=new ad(u);if(s.parent){s.size-=h.size,s.height-=h.height;var g=ge(s.parent.children,s);s.parent.children.splice(g+1,0,h)}else{var f=new ad(s.children);f.parent=s,s.children=[f,h],s=f}h.parent=s.parent}while(s.children.length>10);s.parent.maybeSpill()}},iterN:function(s,u,h){for(var f=0;f<this.children.length;++f){var g=this.children[f],S=g.chunkSize();if(s<S){var w=Math.min(u,S-s);if(g.iterN(s,w,h))return!0;if((u-=w)==0)break;s=0}else s-=S}}};var od=function(s,u,h){if(h)for(var f in h)h.hasOwnProperty(f)&&(this[f]=h[f]);this.doc=s,this.node=u};od.prototype.clear=function(){var s=this.doc.cm,u=this.line.widgets,h=this.line,f=vt(h);if(!(f==null||!u)){for(var g=0;g<u.length;++g)u[g]==this&&u.splice(g--,1);u.length||(h.widgets=null);var S=ju(this);hi(h,Math.max(0,h.height-S)),s&&(Or(s,function(){IL(s,h,-S),Uo(s,f,"widget")}),Un(s,"lineWidgetCleared",s,this,f))}},od.prototype.changed=function(){var s=this,u=this.height,h=this.doc.cm,f=this.line;this.height=null;var g=ju(this)-u;!g||(Bo(this.doc,f)||hi(f,f.height+g),h&&Or(h,function(){h.curOp.forceUpdate=!0,IL(h,f,g),Un(h,"lineWidgetChanged",h,s,vt(f))}))},Oo(od);function IL(s,u,h){qa(u)<(s.curOp&&s.curOp.scrollTop||s.doc.scrollTop)&&Gv(s,h)}function r4(s,u,h,f){var g=new od(s,h,f),S=s.cm;return S&&g.noHScroll&&(S.display.alignWidgets=!0),rd(s,u,"widget",function(w){var T=w.widgets||(w.widgets=[]);if(g.insertAt==null?T.push(g):T.splice(Math.min(T.length-1,Math.max(0,g.insertAt)),0,g),g.line=w,S&&!Bo(s,w)){var L=qa(w)<s.scrollTop;hi(w,w.height+ju(g)),L&&Gv(S,g.height),S.curOp.forceUpdate=!0}return!0}),S&&Un(S,"lineWidgetAdded",S,g,typeof u=="number"?u:vt(u)),g}var AL=0,Ho=function(s,u){this.lines=[],this.type=u,this.doc=s,this.id=++AL};Ho.prototype.clear=function(){if(!this.explicitlyCleared){var s=this.doc.cm,u=s&&!s.curOp;if(u&&$s(s),un(this,"clear")){var h=this.find();h&&Un(this,"clear",h.from,h.to)}for(var f=null,g=null,S=0;S<this.lines.length;++S){var w=this.lines[S],T=zu(w.markedSpans,this);s&&!this.collapsed?Uo(s,vt(w),"text"):s&&(T.to!=null&&(g=vt(w)),T.from!=null&&(f=vt(w))),w.markedSpans=JF(w.markedSpans,T),T.from==null&&this.collapsed&&!Bo(this.doc,w)&&s&&hi(w,sc(s.display))}if(s&&this.collapsed&&!s.options.lineWrapping)for(var L=0;L<this.lines.length;++L){var P=pa(this.lines[L]),F=zf(P);F>s.display.maxLineLength&&(s.display.maxLine=P,s.display.maxLineLength=F,s.display.maxLineChanged=!0)}f!=null&&s&&this.collapsed&&Sr(s,f,g+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,s&&bL(s.doc)),s&&Un(s,"markerCleared",s,this,f,g),u&&js(s),this.parent&&this.parent.clear()}},Ho.prototype.find=function(s,u){s==null&&this.type=="bookmark"&&(s=1);for(var h,f,g=0;g<this.lines.length;++g){var S=this.lines[g],w=zu(S.markedSpans,this);if(w.from!=null&&(h=q(u?S:vt(S),w.from),s==-1))return h;if(w.to!=null&&(f=q(u?S:vt(S),w.to),s==1))return f}return h&&{from:h,to:f}},Ho.prototype.changed=function(){var s=this,u=this.find(-1,!0),h=this,f=this.doc.cm;!u||!f||Or(f,function(){var g=u.line,S=vt(u.line),w=Pv(f,S);if(w&&(Vk(w),f.curOp.selectionChanged=f.curOp.forceUpdate=!0),f.curOp.updateMaxLine=!0,!Bo(h.doc,g)&&h.height!=null){var T=h.height;h.height=null;var L=ju(h)-T;L&&hi(g,g.height+L)}Un(f,"markerChanged",f,s)})},Ho.prototype.attachLine=function(s){if(!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(!u.maybeHiddenMarkers||ge(u.maybeHiddenMarkers,this)==-1)&&(u.maybeUnhiddenMarkers||(u.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(s)},Ho.prototype.detachLine=function(s){if(this.lines.splice(ge(this.lines,s),1),!this.lines.length&&this.doc.cm){var u=this.doc.cm.curOp;(u.maybeHiddenMarkers||(u.maybeHiddenMarkers=[])).push(this)}},Oo(Ho);function gc(s,u,h,f,g){if(f&&f.shared)return i4(s,u,h,f,g);if(s.cm&&!s.cm.curOp)return Ln(s.cm,gc)(s,u,h,f,g);var S=new Ho(s,g),w=he(u,h);if(f&&je(f,S,!1),w>0||w==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=X("span",[S.replacedWith],"CodeMirror-widget"),f.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),f.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(Sk(s,u.line,u,h,S)||u.line!=h.line&&Sk(s,h.line,u,h,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");qF()}S.addToHistory&&fL(s,{from:u,to:h,origin:"markText"},s.sel,NaN);var T=u.line,L=s.cm,P;if(s.iter(T,h.line+1,function(W){L&&S.collapsed&&!L.options.lineWrapping&&pa(W)==L.display.maxLine&&(P=!0),S.collapsed&&T!=u.line&&hi(W,0),YF(W,new Uf(S,T==u.line?u.ch:null,T==h.line?h.ch:null)),++T}),S.collapsed&&s.iter(u.line,h.line+1,function(W){Bo(s,W)&&hi(W,0)}),S.clearOnEnter&&be(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&(jF(),(s.history.done.length||s.history.undone.length)&&s.clearHistory()),S.collapsed&&(S.id=++AL,S.atomic=!0),L){if(P&&(L.curOp.updateMaxLine=!0),S.collapsed)Sr(L,u.line,h.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var F=u.line;F<=h.line;F++)Uo(L,F,"text");S.atomic&&bL(L.doc),Un(L,"markerAdded",L,S)}return S}var sd=function(s,u){this.markers=s,this.primary=u;for(var h=0;h<s.length;++h)s[h].parent=this};sd.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var s=0;s<this.markers.length;++s)this.markers[s].clear();Un(this,"clear")}},sd.prototype.find=function(s,u){return this.primary.find(s,u)},Oo(sd);function i4(s,u,h,f,g){f=je(f),f.shared=!1;var S=[gc(s,u,h,f,g)],w=S[0],T=f.widgetNode;return zo(s,function(L){T&&(f.widgetNode=T.cloneNode(!0)),S.push(gc(L,Ze(L,u),Ze(L,h),f,g));for(var P=0;P<L.linked.length;++P)if(L.linked[P].isParent)return;w=Oe(S)}),new sd(S,w)}function ML(s){return s.findMarks(q(s.first,0),s.clipPos(q(s.lastLine())),function(u){return u.parent})}function a4(s,u){for(var h=0;h<u.length;h++){var f=u[h],g=f.find(),S=s.clipPos(g.from),w=s.clipPos(g.to);if(he(S,w)){var T=gc(s,S,w,f.primary,f.primary.type);f.markers.push(T),T.parent=f}}}function o4(s){for(var u=function(f){var g=s[f],S=[g.primary.doc];zo(g.primary.doc,function(L){return S.push(L)});for(var w=0;w<g.markers.length;w++){var T=g.markers[w];ge(S,T.doc)==-1&&(T.parent=null,g.markers.splice(w--,1))}},h=0;h<s.length;h++)u(h)}var s4=0,br=function(s,u,h,f,g){if(!(this instanceof br))return new br(s,u,h,f,g);h==null&&(h=0),ad.call(this,[new id([new ic("",null)])]),this.first=h,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=h;var S=q(h,0);this.sel=Go(S),this.history=new eh(null),this.id=++s4,this.modeOption=u,this.lineSep=f,this.direction=g=="rtl"?"rtl":"ltr",this.extend=!1,typeof s=="string"&&(s=this.splitLines(s)),Yv(this,{from:S,to:S,text:s}),Hn(this,Go(S),Dt)};br.prototype=_r(ad.prototype,{constructor:br,iter:function(s,u,h){h?this.iterN(s-this.first,u-s,h):this.iterN(this.first,this.first+this.size,s)},insert:function(s,u){for(var h=0,f=0;f<u.length;++f)h+=u[f].height;this.insertInner(s-this.first,u,h)},remove:function(s,u){this.removeInner(s-this.first,u)},getValue:function(s){var u=Gu(this,this.first,this.first+this.size);return s===!1?u:u.join(s||this.lineSeparator())},setValue:En(function(s){var u=q(this.first,0),h=this.first+this.size-1;hc(this,{from:u,to:q(h,_e(this,h).text.length),text:this.splitLines(s),origin:"setValue",full:!0},!0),this.cm&&Yu(this.cm,0,0),Hn(this,Go(u),Dt)}),replaceRange:function(s,u,h,f){u=Ze(this,u),h=h?Ze(this,h):u,mc(this,s,u,h,f)},getRange:function(s,u,h){var f=ua(this,Ze(this,s),Ze(this,u));return h===!1?f:f.join(h||this.lineSeparator())},getLine:function(s){var u=this.getLineHandle(s);return u&&u.text},getLineHandle:function(s){if(H(this,s))return _e(this,s)},getLineNumber:function(s){return vt(s)},getLineHandleVisualStart:function(s){return typeof s=="number"&&(s=_e(this,s)),pa(s)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(s){return Ze(this,s)},getCursor:function(s){var u=this.sel.primary(),h;return s==null||s=="head"?h=u.head:s=="anchor"?h=u.anchor:s=="end"||s=="to"||s===!1?h=u.to():h=u.from(),h},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:En(function(s,u,h){yL(this,Ze(this,typeof s=="number"?q(s,u||0):s),null,h)}),setSelection:En(function(s,u,h){yL(this,Ze(this,s),Ze(this,u||s),h)}),extendSelection:En(function(s,u,h){nh(this,Ze(this,s),u&&Ze(this,u),h)}),extendSelections:En(function(s,u){gL(this,ak(this,s),u)}),extendSelectionsBy:En(function(s,u){var h=ln(this.sel.ranges,s);gL(this,ak(this,h),u)}),setSelections:En(function(s,u,h){if(!!s.length){for(var f=[],g=0;g<s.length;g++)f[g]=new xt(Ze(this,s[g].anchor),Ze(this,s[g].head));u==null&&(u=Math.min(s.length-1,this.sel.primIndex)),Hn(this,Ri(this.cm,f,u),h)}}),addSelection:En(function(s,u,h){var f=this.sel.ranges.slice(0);f.push(new xt(Ze(this,s),Ze(this,u||s))),Hn(this,Ri(this.cm,f,f.length-1),h)}),getSelection:function(s){for(var u=this.sel.ranges,h,f=0;f<u.length;f++){var g=ua(this,u[f].from(),u[f].to());h=h?h.concat(g):g}return s===!1?h:h.join(s||this.lineSeparator())},getSelections:function(s){for(var u=[],h=this.sel.ranges,f=0;f<h.length;f++){var g=ua(this,h[f].from(),h[f].to());s!==!1&&(g=g.join(s||this.lineSeparator())),u[f]=g}return u},replaceSelection:function(s,u,h){for(var f=[],g=0;g<this.sel.ranges.length;g++)f[g]=s;this.replaceSelections(f,u,h||"+input")},replaceSelections:En(function(s,u,h){for(var f=[],g=this.sel,S=0;S<g.ranges.length;S++){var w=g.ranges[S];f[S]={from:w.from(),to:w.to(),text:this.splitLines(s[S]),origin:h}}for(var T=u&&u!="end"&&J3(this,f,u),L=f.length-1;L>=0;L--)hc(this,f[L]);T?vL(this,T):this.cm&&uc(this.cm)}),undo:En(function(){ah(this,"undo")}),redo:En(function(){ah(this,"redo")}),undoSelection:En(function(){ah(this,"undo",!0)}),redoSelection:En(function(){ah(this,"redo",!0)}),setExtending:function(s){this.extend=s},getExtending:function(){return this.extend},historySize:function(){for(var s=this.history,u=0,h=0,f=0;f<s.done.length;f++)s.done[f].ranges||++u;for(var g=0;g<s.undone.length;g++)s.undone[g].ranges||++h;return{undo:u,redo:h}},clearHistory:function(){var s=this;this.history=new eh(this.history.maxGeneration),zo(this,function(u){return u.history=s.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(s){return s&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(s){return this.history.generation==(s||this.cleanGeneration)},getHistory:function(){return{done:pc(this.history.done),undone:pc(this.history.undone)}},setHistory:function(s){var u=this.history=new eh(this.history.maxGeneration);u.done=pc(s.done.slice(0),null,!0),u.undone=pc(s.undone.slice(0),null,!0)},setGutterMarker:En(function(s,u,h){return rd(this,s,"gutter",function(f){var g=f.gutterMarkers||(f.gutterMarkers={});return g[u]=h,!h&&fe(g)&&(f.gutterMarkers=null),!0})}),clearGutter:En(function(s){var u=this;this.iter(function(h){h.gutterMarkers&&h.gutterMarkers[s]&&rd(u,h,"gutter",function(){return h.gutterMarkers[s]=null,fe(h.gutterMarkers)&&(h.gutterMarkers=null),!0})})}),lineInfo:function(s){var u;if(typeof s=="number"){if(!H(this,s)||(u=s,s=_e(this,s),!s))return null}else if(u=vt(s),u==null)return null;return{line:u,handle:s,text:s.text,gutterMarkers:s.gutterMarkers,textClass:s.textClass,bgClass:s.bgClass,wrapClass:s.wrapClass,widgets:s.widgets}},addLineClass:En(function(s,u,h){return rd(this,s,u=="gutter"?"gutter":"class",function(f){var g=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass";if(!f[g])f[g]=h;else{if(N(h).test(f[g]))return!1;f[g]+=" "+h}return!0})}),removeLineClass:En(function(s,u,h){return rd(this,s,u=="gutter"?"gutter":"class",function(f){var g=u=="text"?"textClass":u=="background"?"bgClass":u=="gutter"?"gutterClass":"wrapClass",S=f[g];if(S)if(h==null)f[g]=null;else{var w=S.match(N(h));if(!w)return!1;var T=w.index+w[0].length;f[g]=S.slice(0,w.index)+(!w.index||T==S.length?"":" ")+S.slice(T)||null}else return!1;return!0})}),addLineWidget:En(function(s,u,h){return r4(this,s,u,h)}),removeLineWidget:function(s){s.clear()},markText:function(s,u,h){return gc(this,Ze(this,s),Ze(this,u),h,h&&h.type||"range")},setBookmark:function(s,u){var h={replacedWith:u&&(u.nodeType==null?u.widget:u),insertLeft:u&&u.insertLeft,clearWhenEmpty:!1,shared:u&&u.shared,handleMouseEvents:u&&u.handleMouseEvents};return s=Ze(this,s),gc(this,s,s,h,"bookmark")},findMarksAt:function(s){s=Ze(this,s);var u=[],h=_e(this,s.line).markedSpans;if(h)for(var f=0;f<h.length;++f){var g=h[f];(g.from==null||g.from<=s.ch)&&(g.to==null||g.to>=s.ch)&&u.push(g.marker.parent||g.marker)}return u},findMarks:function(s,u,h){s=Ze(this,s),u=Ze(this,u);var f=[],g=s.line;return this.iter(s.line,u.line+1,function(S){var w=S.markedSpans;if(w)for(var T=0;T<w.length;T++){var L=w[T];!(L.to!=null&&g==s.line&&s.ch>=L.to||L.from==null&&g!=s.line||L.from!=null&&g==u.line&&L.from>=u.ch)&&(!h||h(L.marker))&&f.push(L.marker.parent||L.marker)}++g}),f},getAllMarks:function(){var s=[];return this.iter(function(u){var h=u.markedSpans;if(h)for(var f=0;f<h.length;++f)h[f].from!=null&&s.push(h[f].marker)}),s},posFromIndex:function(s){var u,h=this.first,f=this.lineSeparator().length;return this.iter(function(g){var S=g.text.length+f;if(S>s)return u=s,!0;s-=S,++h}),Ze(this,q(h,u))},indexFromPos:function(s){s=Ze(this,s);var u=s.ch;if(s.line<this.first||s.ch<0)return 0;var h=this.lineSeparator().length;return this.iter(this.first,s.line,function(f){u+=f.text.length+h}),u},copy:function(s){var u=new br(Gu(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return u.scrollTop=this.scrollTop,u.scrollLeft=this.scrollLeft,u.sel=this.sel,u.extend=!1,s&&(u.history.undoDepth=this.history.undoDepth,u.setHistory(this.getHistory())),u},linkedDoc:function(s){s||(s={});var u=this.first,h=this.first+this.size;s.from!=null&&s.from>u&&(u=s.from),s.to!=null&&s.to<h&&(h=s.to);var f=new br(Gu(this,u,h),s.mode||this.modeOption,u,this.lineSep,this.direction);return s.sharedHist&&(f.history=this.history),(this.linked||(this.linked=[])).push({doc:f,sharedHist:s.sharedHist}),f.linked=[{doc:this,isParent:!0,sharedHist:s.sharedHist}],a4(f,ML(this)),f},unlinkDoc:function(s){if(s instanceof Kt&&(s=s.doc),this.linked)for(var u=0;u<this.linked.length;++u){var h=this.linked[u];if(h.doc==s){this.linked.splice(u,1),s.unlinkDoc(this),o4(ML(this));break}}if(s.history==this.history){var f=[s.id];zo(s,function(g){return f.push(g.id)},!0),s.history=new eh(null),s.history.done=pc(this.history.done,f),s.history.undone=pc(this.history.undone,f)}},iterLinkedDocs:function(s){zo(this,s)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(s){return this.lineSep?s.split(this.lineSep):la(s)},lineSeparator:function(){return this.lineSep||`
`},setDirection:En(function(s){s!="rtl"&&(s="ltr"),s!=this.direction&&(this.direction=s,this.iter(function(u){return u.order=null}),this.cm&&Y3(this.cm))})}),br.prototype.eachLine=br.prototype.iter;var RL=0;function l4(s){var u=this;if(_L(u),!(Ot(u,s)||Ja(u.display,s))){mn(s),o&&(RL=+new Date);var h=Gs(u,s,!0),f=s.dataTransfer.files;if(!(!h||u.isReadOnly()))if(f&&f.length&&window.FileReader&&window.File)for(var g=f.length,S=Array(g),w=0,T=function(){++w==g&&Ln(u,function(){h=Ze(u.doc,h);var J={from:h,to:h,text:u.doc.splitLines(S.filter(function(ee){return ee!=null}).join(u.doc.lineSeparator())),origin:"paste"};hc(u.doc,J),vL(u.doc,Go(Ze(u.doc,h),Ze(u.doc,Wo(J))))})()},L=function(J,ee){if(u.options.allowDropFileTypes&&ge(u.options.allowDropFileTypes,J.type)==-1){T();return}var ne=new FileReader;ne.onerror=function(){return T()},ne.onload=function(){var de=ne.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(de)){T();return}S[ee]=de,T()},ne.readAsText(J)},P=0;P<f.length;P++)L(f[P],P);else{if(u.state.draggingText&&u.doc.sel.contains(h)>-1){u.state.draggingText(s),setTimeout(function(){return u.display.input.focus()},20);return}try{var F=s.dataTransfer.getData("Text");if(F){var W;if(u.state.draggingText&&!u.state.draggingText.copy&&(W=u.listSelections()),rh(u.doc,Go(h,h)),W)for(var Y=0;Y<W.length;++Y)mc(u.doc,"",W[Y].anchor,W[Y].head,"drag");u.replaceSelection(F,"around","paste"),u.display.input.focus()}}catch(J){}}}}function c4(s,u){if(o&&(!s.state.draggingText||+new Date-RL<100)){zn(u);return}if(!(Ot(s,u)||Ja(s.display,u))&&(u.dataTransfer.setData("Text",s.getSelection()),u.dataTransfer.effectAllowed="copyMove",u.dataTransfer.setDragImage&&!y)){var h=R("img",null,null,"position: fixed; left: 0; top: 0;");h.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",m&&(h.width=h.height=1,s.display.wrapper.appendChild(h),h._top=h.offsetTop),u.dataTransfer.setDragImage(h,0,0),m&&h.parentNode.removeChild(h)}}function u4(s,u){var h=Gs(s,u);if(!!h){var f=document.createDocumentFragment();jk(s,h,f),s.display.dragCursor||(s.display.dragCursor=R("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),s.display.lineSpace.insertBefore(s.display.dragCursor,s.display.cursorDiv)),B(s.display.dragCursor,f)}}function _L(s){s.display.dragCursor&&(s.display.lineSpace.removeChild(s.display.dragCursor),s.display.dragCursor=null)}function VL(s){if(!!document.getElementsByClassName){for(var u=document.getElementsByClassName("CodeMirror"),h=[],f=0;f<u.length;f++){var g=u[f].CodeMirror;g&&h.push(g)}h.length&&h[0].operation(function(){for(var S=0;S<h.length;S++)s(h[S])})}}var OL=!1;function d4(){OL||(p4(),OL=!0)}function p4(){var s;be(window,"resize",function(){s==null&&(s=setTimeout(function(){s=null,VL(f4)},100))}),be(window,"blur",function(){return VL(cc)})}function f4(s){var u=s.display;u.cachedCharWidth=u.cachedTextHeight=u.cachedPaddingH=null,u.scrollbarsClipped=!1,s.setSize()}for(var $o={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},ld=0;ld<10;ld++)$o[ld+48]=$o[ld+96]=String(ld);for(var oh=65;oh<=90;oh++)$o[oh]=String.fromCharCode(oh);for(var cd=1;cd<=12;cd++)$o[cd+111]=$o[cd+63235]="F"+cd;var Ya={};Ya.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Ya.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Ya.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Ya.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Ya.default=M?Ya.macDefault:Ya.pcDefault;function h4(s){var u=s.split(/-(?!$)/);s=u[u.length-1];for(var h,f,g,S,w=0;w<u.length-1;w++){var T=u[w];if(/^(cmd|meta|m)$/i.test(T))S=!0;else if(/^a(lt)?$/i.test(T))h=!0;else if(/^(c|ctrl|control)$/i.test(T))f=!0;else if(/^s(hift)?$/i.test(T))g=!0;else throw new Error("Unrecognized modifier name: "+T)}return h&&(s="Alt-"+s),f&&(s="Ctrl-"+s),S&&(s="Cmd-"+s),g&&(s="Shift-"+s),s}function m4(s){var u={};for(var h in s)if(s.hasOwnProperty(h)){var f=s[h];if(/^(name|fallthrough|(de|at)tach)$/.test(h))continue;if(f=="..."){delete s[h];continue}for(var g=ln(h.split(" "),h4),S=0;S<g.length;S++){var w=void 0,T=void 0;S==g.length-1?(T=g.join(" "),w=f):(T=g.slice(0,S+1).join(" "),w="...");var L=u[T];if(!L)u[T]=w;else if(L!=w)throw new Error("Inconsistent bindings for "+T)}delete s[h]}for(var P in u)s[P]=u[P];return s}function yc(s,u,h,f){u=sh(u);var g=u.call?u.call(s,f):u[s];if(g===!1)return"nothing";if(g==="...")return"multi";if(g!=null&&h(g))return"handled";if(u.fallthrough){if(Object.prototype.toString.call(u.fallthrough)!="[object Array]")return yc(s,u.fallthrough,h,f);for(var S=0;S<u.fallthrough.length;S++){var w=yc(s,u.fallthrough[S],h,f);if(w)return w}}}function NL(s){var u=typeof s=="string"?s:$o[s.keyCode];return u=="Ctrl"||u=="Alt"||u=="Shift"||u=="Mod"}function BL(s,u,h){var f=s;return u.altKey&&f!="Alt"&&(s="Alt-"+s),(E?u.metaKey:u.ctrlKey)&&f!="Ctrl"&&(s="Ctrl-"+s),(E?u.ctrlKey:u.metaKey)&&f!="Mod"&&(s="Cmd-"+s),!h&&u.shiftKey&&f!="Shift"&&(s="Shift-"+s),s}function UL(s,u){if(m&&s.keyCode==34&&s.char)return!1;var h=$o[s.keyCode];return h==null||s.altGraphKey?!1:(s.keyCode==3&&s.code&&(h=s.code),BL(h,s,u))}function sh(s){return typeof s=="string"?Ya[s]:s}function vc(s,u){for(var h=s.doc.sel.ranges,f=[],g=0;g<h.length;g++){for(var S=u(h[g]);f.length&&he(S.from,Oe(f).to)<=0;){var w=f.pop();if(he(w.from,S.from)<0){S.from=w.from;break}}f.push(S)}Or(s,function(){for(var T=f.length-1;T>=0;T--)mc(s.doc,"",f[T].from,f[T].to,"+delete");uc(s)})}function Zv(s,u,h){var f=tt(s.text,u+h,h);return f<0||f>s.text.length?null:f}function eS(s,u,h){var f=Zv(s,u.ch,h);return f==null?null:new q(u.line,f,h<0?"after":"before")}function tS(s,u,h,f,g){if(s){u.doc.direction=="rtl"&&(g=-g);var S=Jt(h,u.doc.direction);if(S){var w=g<0?Oe(S):S[0],T=g<0==(w.level==1),L=T?"after":"before",P;if(w.level>0||u.doc.direction=="rtl"){var F=oc(u,h);P=g<0?h.text.length-1:0;var W=ha(u,F,P).top;P=ce(function(Y){return ha(u,F,Y).top==W},g<0==(w.level==1)?w.from:w.to-1,P),L=="before"&&(P=Zv(h,P,1))}else P=g<0?w.to:w.from;return new q(f,P,L)}}return new q(f,g<0?h.text.length:0,g<0?"before":"after")}function g4(s,u,h,f){var g=Jt(u,s.doc.direction);if(!g)return eS(u,h,f);h.ch>=u.text.length?(h.ch=u.text.length,h.sticky="before"):h.ch<=0&&(h.ch=0,h.sticky="after");var S=Qe(g,h.ch,h.sticky),w=g[S];if(s.doc.direction=="ltr"&&w.level%2==0&&(f>0?w.to>h.ch:w.from<h.ch))return eS(u,h,f);var T=function(ye,we){return Zv(u,ye instanceof q?ye.ch:ye,we)},L,P=function(ye){return s.options.lineWrapping?(L=L||oc(s,u),Wk(s,u,L,ye)):{begin:0,end:u.text.length}},F=P(h.sticky=="before"?T(h,-1):h.ch);if(s.doc.direction=="rtl"||w.level==1){var W=w.level==1==f<0,Y=T(h,W?1:-1);if(Y!=null&&(W?Y<=w.to&&Y<=F.end:Y>=w.from&&Y>=F.begin)){var J=W?"before":"after";return new q(h.line,Y,J)}}var ee=function(ye,we,ve){for(var Le=function(Nt,Dn){return Dn?new q(h.line,T(Nt,1),"before"):new q(h.line,Nt,"after")};ye>=0&&ye<g.length;ye+=we){var Ue=g[ye],Ve=we>0==(Ue.level!=1),st=Ve?ve.begin:T(ve.end,-1);if(Ue.from<=st&&st<Ue.to||(st=Ve?Ue.from:T(Ue.to,-1),ve.begin<=st&&st<ve.end))return Le(st,Ve)}},ne=ee(S+f,f,F);if(ne)return ne;var de=f>0?F.end:T(F.begin,-1);return de!=null&&!(f>0&&de==u.text.length)&&(ne=ee(f>0?0:g.length-1,f,P(de)),ne)?ne:null}var ud={selectAll:wL,singleSelection:function(s){return s.setSelection(s.getCursor("anchor"),s.getCursor("head"),Dt)},killLine:function(s){return vc(s,function(u){if(u.empty()){var h=_e(s.doc,u.head.line).text.length;return u.head.ch==h&&u.head.line<s.lastLine()?{from:u.head,to:q(u.head.line+1,0)}:{from:u.head,to:q(u.head.line,h)}}else return{from:u.from(),to:u.to()}})},deleteLine:function(s){return vc(s,function(u){return{from:q(u.from().line,0),to:Ze(s.doc,q(u.to().line+1,0))}})},delLineLeft:function(s){return vc(s,function(u){return{from:q(u.from().line,0),to:u.from()}})},delWrappedLineLeft:function(s){return vc(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return{from:f,to:u.from()}})},delWrappedLineRight:function(s){return vc(s,function(u){var h=s.charCoords(u.head,"div").top+5,f=s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div");return{from:u.from(),to:f}})},undo:function(s){return s.undo()},redo:function(s){return s.redo()},undoSelection:function(s){return s.undoSelection()},redoSelection:function(s){return s.redoSelection()},goDocStart:function(s){return s.extendSelection(q(s.firstLine(),0))},goDocEnd:function(s){return s.extendSelection(q(s.lastLine()))},goLineStart:function(s){return s.extendSelectionsBy(function(u){return FL(s,u.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(s){return s.extendSelectionsBy(function(u){return GL(s,u.head)},{origin:"+move",bias:1})},goLineEnd:function(s){return s.extendSelectionsBy(function(u){return y4(s,u.head.line)},{origin:"+move",bias:-1})},goLineRight:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:s.display.lineDiv.offsetWidth+100,top:h},"div")},Xe)},goLineLeft:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5;return s.coordsChar({left:0,top:h},"div")},Xe)},goLineLeftSmart:function(s){return s.extendSelectionsBy(function(u){var h=s.cursorCoords(u.head,"div").top+5,f=s.coordsChar({left:0,top:h},"div");return f.ch<s.getLine(f.line).search(/\S/)?GL(s,u.head):f},Xe)},goLineUp:function(s){return s.moveV(-1,"line")},goLineDown:function(s){return s.moveV(1,"line")},goPageUp:function(s){return s.moveV(-1,"page")},goPageDown:function(s){return s.moveV(1,"page")},goCharLeft:function(s){return s.moveH(-1,"char")},goCharRight:function(s){return s.moveH(1,"char")},goColumnLeft:function(s){return s.moveH(-1,"column")},goColumnRight:function(s){return s.moveH(1,"column")},goWordLeft:function(s){return s.moveH(-1,"word")},goGroupRight:function(s){return s.moveH(1,"group")},goGroupLeft:function(s){return s.moveH(-1,"group")},goWordRight:function(s){return s.moveH(1,"word")},delCharBefore:function(s){return s.deleteH(-1,"codepoint")},delCharAfter:function(s){return s.deleteH(1,"char")},delWordBefore:function(s){return s.deleteH(-1,"word")},delWordAfter:function(s){return s.deleteH(1,"word")},delGroupBefore:function(s){return s.deleteH(-1,"group")},delGroupAfter:function(s){return s.deleteH(1,"group")},indentAuto:function(s){return s.indentSelection("smart")},indentMore:function(s){return s.indentSelection("add")},indentLess:function(s){return s.indentSelection("subtract")},insertTab:function(s){return s.replaceSelection("	")},insertSoftTab:function(s){for(var u=[],h=s.listSelections(),f=s.options.tabSize,g=0;g<h.length;g++){var S=h[g].from(),w=Be(s.getLine(S.line),S.ch,f);u.push(Bn(f-w%f))}s.replaceSelections(u)},defaultTab:function(s){s.somethingSelected()?s.indentSelection("add"):s.execCommand("insertTab")},transposeChars:function(s){return Or(s,function(){for(var u=s.listSelections(),h=[],f=0;f<u.length;f++)if(!!u[f].empty()){var g=u[f].head,S=_e(s.doc,g.line).text;if(S){if(g.ch==S.length&&(g=new q(g.line,g.ch-1)),g.ch>0)g=new q(g.line,g.ch+1),s.replaceRange(S.charAt(g.ch-1)+S.charAt(g.ch-2),q(g.line,g.ch-2),g,"+transpose");else if(g.line>s.doc.first){var w=_e(s.doc,g.line-1).text;w&&(g=new q(g.line,1),s.replaceRange(S.charAt(0)+s.doc.lineSeparator()+w.charAt(w.length-1),q(g.line-1,w.length-1),g,"+transpose"))}}h.push(new xt(g,g))}s.setSelections(h)})},newlineAndIndent:function(s){return Or(s,function(){for(var u=s.listSelections(),h=u.length-1;h>=0;h--)s.replaceRange(s.doc.lineSeparator(),u[h].anchor,u[h].head,"+input");u=s.listSelections();for(var f=0;f<u.length;f++)s.indentLine(u[f].from().line,null,!0);uc(s)})},openLine:function(s){return s.replaceSelection(`
`,"start")},toggleOverwrite:function(s){return s.toggleOverwrite()}};function FL(s,u){var h=_e(s.doc,u),f=pa(h);return f!=h&&(u=vt(f)),tS(!0,s,f,u,1)}function y4(s,u){var h=_e(s.doc,u),f=e3(h);return f!=h&&(u=vt(f)),tS(!0,s,h,u,-1)}function GL(s,u){var h=FL(s,u.line),f=_e(s.doc,h.line),g=Jt(f,s.doc.direction);if(!g||g[0].level==0){var S=Math.max(h.ch,f.text.search(/\S/)),w=u.line==h.line&&u.ch<=S&&u.ch;return q(h.line,w?0:S,h.sticky)}return h}function lh(s,u,h){if(typeof u=="string"&&(u=ud[u],!u))return!1;s.display.input.ensurePolled();var f=s.display.shift,g=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),h&&(s.display.shift=!1),g=u(s)!=ht}finally{s.display.shift=f,s.state.suppressEdits=!1}return g}function v4(s,u,h){for(var f=0;f<s.state.keyMaps.length;f++){var g=yc(u,s.state.keyMaps[f],h,s);if(g)return g}return s.options.extraKeys&&yc(u,s.options.extraKeys,h,s)||yc(u,s.options.keyMap,h,s)}var S4=new Pe;function dd(s,u,h,f){var g=s.state.keySeq;if(g){if(NL(u))return"handled";if(/\'$/.test(u)?s.state.keySeq=null:S4.set(50,function(){s.state.keySeq==g&&(s.state.keySeq=null,s.display.input.reset())}),WL(s,g+" "+u,h,f))return!0}return WL(s,u,h,f)}function WL(s,u,h,f){var g=v4(s,u,f);return g=="multi"&&(s.state.keySeq=u),g=="handled"&&Un(s,"keyHandled",s,u,h),(g=="handled"||g=="multi")&&(mn(h),Bv(s)),!!g}function zL(s,u){var h=UL(u,!0);return h?u.shiftKey&&!s.state.keySeq?dd(s,"Shift-"+h,u,function(f){return lh(s,f,!0)})||dd(s,h,u,function(f){if(typeof f=="string"?/^go[A-Z]/.test(f):f.motion)return lh(s,f)}):dd(s,h,u,function(f){return lh(s,f)}):!1}function b4(s,u,h){return dd(s,"'"+h+"'",u,function(f){return lh(s,f,!0)})}var nS=null;function HL(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&(u.curOp.focus=me(),!Ot(u,s))){o&&l<11&&s.keyCode==27&&(s.returnValue=!1);var h=s.keyCode;u.display.shift=h==16||s.shiftKey;var f=zL(u,s);m&&(nS=f?h:null,!f&&h==88&&!No&&(M?s.metaKey:s.ctrlKey)&&u.replaceSelection("",null,"cut")),t&&!M&&!f&&h==46&&s.shiftKey&&!s.ctrlKey&&document.execCommand&&document.execCommand("cut"),h==18&&!/\bCodeMirror-crosshair\b/.test(u.display.lineDiv.className)&&x4(u)}}function x4(s){var u=s.display.lineDiv;xe(u,"CodeMirror-crosshair");function h(f){(f.keyCode==18||!f.altKey)&&(U(u,"CodeMirror-crosshair"),nt(document,"keyup",h),nt(document,"mouseover",h))}be(document,"keyup",h),be(document,"mouseover",h)}function $L(s){s.keyCode==16&&(this.doc.sel.shift=!1),Ot(this,s)}function jL(s){var u=this;if(!(s.target&&s.target!=u.display.input.getField())&&!(Ja(u.display,s)||Ot(u,s)||s.ctrlKey&&!s.altKey||M&&s.metaKey)){var h=s.keyCode,f=s.charCode;if(m&&h==nS){nS=null,mn(s);return}if(!(m&&(!s.which||s.which<10)&&zL(u,s))){var g=String.fromCharCode(f==null?h:f);g!="\b"&&(b4(u,s,g)||u.display.input.onKeyPress(s))}}}var C4=400,rS=function(s,u,h){this.time=s,this.pos=u,this.button=h};rS.prototype.compare=function(s,u,h){return this.time+C4>s&&he(u,this.pos)==0&&h==this.button};var pd,fd;function w4(s,u){var h=+new Date;return fd&&fd.compare(h,s,u)?(pd=fd=null,"triple"):pd&&pd.compare(h,s,u)?(fd=new rS(h,s,u),pd=null,"double"):(pd=new rS(h,s,u),fd=null,"single")}function qL(s){var u=this,h=u.display;if(!(Ot(u,s)||h.activeTouch&&h.input.supportsTouch())){if(h.input.ensurePolled(),h.shift=s.shiftKey,Ja(h,s)){c||(h.scroller.draggable=!1,setTimeout(function(){return h.scroller.draggable=!0},100));return}if(!iS(u,s)){var f=Gs(u,s),g=_f(s),S=f?w4(f,g):"single";window.focus(),g==1&&u.state.selectingText&&u.state.selectingText(s),!(f&&T4(u,g,f,S,s))&&(g==1?f?L4(u,f,S,s):Zl(s)==h.scroller&&mn(s):g==2?(f&&nh(u.doc,f),setTimeout(function(){return h.input.focus()},20)):g==3&&(V?u.display.input.onContextMenu(s):Jk(u)))}}}function T4(s,u,h,f,g){var S="Click";return f=="double"?S="Double"+S:f=="triple"&&(S="Triple"+S),S=(u==1?"Left":u==2?"Middle":"Right")+S,dd(s,BL(S,g),g,function(w){if(typeof w=="string"&&(w=ud[w]),!w)return!1;var T=!1;try{s.isReadOnly()&&(s.state.suppressEdits=!0),T=w(s,h)!=ht}finally{s.state.suppressEdits=!1}return T})}function k4(s,u,h){var f=s.getOption("configureMouse"),g=f?f(s,u,h):{};if(g.unit==null){var S=I?h.shiftKey&&h.metaKey:h.altKey;g.unit=S?"rectangle":u=="single"?"char":u=="double"?"word":"line"}return(g.extend==null||s.doc.extend)&&(g.extend=s.doc.extend||h.shiftKey),g.addNew==null&&(g.addNew=M?h.metaKey:h.ctrlKey),g.moveOnDrag==null&&(g.moveOnDrag=!(M?h.altKey:h.ctrlKey)),g}function L4(s,u,h,f){o?setTimeout(Ie(qk,s),0):s.curOp.focus=me();var g=k4(s,h,f),S=s.doc.sel,w;s.options.dragDrop&&sa&&!s.isReadOnly()&&h=="single"&&(w=S.contains(u))>-1&&(he((w=S.ranges[w]).from(),u)<0||u.xRel>0)&&(he(w.to(),u)>0||u.xRel<0)?E4(s,f,u,g):D4(s,f,u,g)}function E4(s,u,h,f){var g=s.display,S=!1,w=Ln(s,function(P){c&&(g.scroller.draggable=!1),s.state.draggingText=!1,nt(g.wrapper.ownerDocument,"mouseup",w),nt(g.wrapper.ownerDocument,"mousemove",T),nt(g.scroller,"dragstart",L),nt(g.scroller,"drop",w),S||(mn(P),f.addNew||nh(s.doc,h,null,null,f.extend),c&&!y||o&&l==9?setTimeout(function(){g.wrapper.ownerDocument.body.focus({preventScroll:!0}),g.input.focus()},20):g.input.focus())}),T=function(P){S=S||Math.abs(u.clientX-P.clientX)+Math.abs(u.clientY-P.clientY)>=10},L=function(){return S=!0};c&&(g.scroller.draggable=!0),s.state.draggingText=w,w.copy=!f.moveOnDrag,g.scroller.dragDrop&&g.scroller.dragDrop(),be(g.wrapper.ownerDocument,"mouseup",w),be(g.wrapper.ownerDocument,"mousemove",T),be(g.scroller,"dragstart",L),be(g.scroller,"drop",w),Jk(s),setTimeout(function(){return g.input.focus()},20)}function JL(s,u,h){if(h=="char")return new xt(u,u);if(h=="word")return s.findWordAt(u);if(h=="line")return new xt(q(u.line,0),Ze(s.doc,q(u.line+1,0)));var f=h(s,u);return new xt(f.from,f.to)}function D4(s,u,h,f){var g=s.display,S=s.doc;mn(u);var w,T,L=S.sel,P=L.ranges;if(f.addNew&&!f.extend?(T=S.sel.contains(h),T>-1?w=P[T]:w=new xt(h,h)):(w=S.sel.primary(),T=S.sel.primIndex),f.unit=="rectangle")f.addNew||(w=new xt(h,h)),h=Gs(s,u,!0,!0),T=-1;else{var F=JL(s,h,f.unit);f.extend?w=Xv(w,F.anchor,F.head,f.extend):w=F}f.addNew?T==-1?(T=P.length,Hn(S,Ri(s,P.concat([w]),T),{scroll:!1,origin:"*mouse"})):P.length>1&&P[T].empty()&&f.unit=="char"&&!f.extend?(Hn(S,Ri(s,P.slice(0,T).concat(P.slice(T+1)),0),{scroll:!1,origin:"*mouse"}),L=S.sel):Qv(S,T,w,Ae):(T=0,Hn(S,new Jr([w],0),Ae),L=S.sel);var W=h;function Y(ve){if(he(W,ve)!=0)if(W=ve,f.unit=="rectangle"){for(var Le=[],Ue=s.options.tabSize,Ve=Be(_e(S,h.line).text,h.ch,Ue),st=Be(_e(S,ve.line).text,ve.ch,Ue),Nt=Math.min(Ve,st),Dn=Math.max(Ve,st),Zt=Math.min(h.line,ve.line),Nr=Math.min(s.lastLine(),Math.max(h.line,ve.line));Zt<=Nr;Zt++){var xr=_e(S,Zt).text,dn=qt(xr,Nt,Ue);Nt==Dn?Le.push(new xt(q(Zt,dn),q(Zt,dn))):xr.length>dn&&Le.push(new xt(q(Zt,dn),q(Zt,qt(xr,Dn,Ue))))}Le.length||Le.push(new xt(h,h)),Hn(S,Ri(s,L.ranges.slice(0,T).concat(Le),T),{origin:"*mouse",scroll:!1}),s.scrollIntoView(ve)}else{var Cr=w,Fn=JL(s,ve,f.unit),yn=Cr.anchor,pn;he(Fn.anchor,yn)>0?(pn=Fn.head,yn=vr(Cr.from(),Fn.anchor)):(pn=Fn.anchor,yn=gn(Cr.to(),Fn.head));var nn=L.ranges.slice(0);nn[T]=P4(s,new xt(Ze(S,yn),pn)),Hn(S,Ri(s,nn,T),Ae)}}var J=g.wrapper.getBoundingClientRect(),ee=0;function ne(ve){var Le=++ee,Ue=Gs(s,ve,!0,f.unit=="rectangle");if(!!Ue)if(he(Ue,W)!=0){s.curOp.focus=me(),Y(Ue);var Ve=Kf(g,S);(Ue.line>=Ve.to||Ue.line<Ve.from)&&setTimeout(Ln(s,function(){ee==Le&&ne(ve)}),150)}else{var st=ve.clientY<J.top?-20:ve.clientY>J.bottom?20:0;st&&setTimeout(Ln(s,function(){ee==Le&&(g.scroller.scrollTop+=st,ne(ve))}),50)}}function de(ve){s.state.selectingText=!1,ee=Infinity,ve&&(mn(ve),g.input.focus()),nt(g.wrapper.ownerDocument,"mousemove",ye),nt(g.wrapper.ownerDocument,"mouseup",we),S.history.lastSelOrigin=null}var ye=Ln(s,function(ve){ve.buttons===0||!_f(ve)?de(ve):ne(ve)}),we=Ln(s,de);s.state.selectingText=we,be(g.wrapper.ownerDocument,"mousemove",ye),be(g.wrapper.ownerDocument,"mouseup",we)}function P4(s,u){var h=u.anchor,f=u.head,g=_e(s.doc,h.line);if(he(h,f)==0&&h.sticky==f.sticky)return u;var S=Jt(g);if(!S)return u;var w=Qe(S,h.ch,h.sticky),T=S[w];if(T.from!=h.ch&&T.to!=h.ch)return u;var L=w+(T.from==h.ch==(T.level!=1)?0:1);if(L==0||L==S.length)return u;var P;if(f.line!=h.line)P=(f.line-h.line)*(s.doc.direction=="ltr"?1:-1)>0;else{var F=Qe(S,f.ch,f.sticky),W=F-w||(f.ch-h.ch)*(T.level==1?-1:1);F==L-1||F==L?P=W<0:P=W>0}var Y=S[L+(P?-1:0)],J=P==(Y.level==1),ee=J?Y.from:Y.to,ne=J?"after":"before";return h.ch==ee&&h.sticky==ne?u:new xt(new q(h.line,ee,ne),f)}function YL(s,u,h,f){var g,S;if(u.touches)g=u.touches[0].clientX,S=u.touches[0].clientY;else try{g=u.clientX,S=u.clientY}catch(Y){return!1}if(g>=Math.floor(s.display.gutters.getBoundingClientRect().right))return!1;f&&mn(u);var w=s.display,T=w.lineDiv.getBoundingClientRect();if(S>T.bottom||!un(s,h))return Bs(u);S-=T.top-w.viewOffset;for(var L=0;L<s.display.gutterSpecs.length;++L){var P=w.gutters.childNodes[L];if(P&&P.getBoundingClientRect().right>=g){var F=O(s.doc,S),W=s.display.gutterSpecs[L];return Wt(s,h,s,F,W.className,u),Bs(u)}}}function iS(s,u){return YL(s,u,"gutterClick",!0)}function KL(s,u){Ja(s.display,u)||I4(s,u)||Ot(s,u,"contextmenu")||V||s.display.input.onContextMenu(u)}function I4(s,u){return un(s,"gutterContextMenu")?YL(s,u,"gutterContextMenu",!1):!1}function XL(s){s.display.wrapper.className=s.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+s.options.theme.replace(/(^|\s)\s*/g," cm-s-"),qu(s)}var Sc={toString:function(){return"CodeMirror.Init"}},QL={},ch={};function A4(s){var u=s.optionHandlers;function h(f,g,S,w){s.defaults[f]=g,S&&(u[f]=w?function(T,L,P){P!=Sc&&S(T,L,P)}:S)}s.defineOption=h,s.Init=Sc,h("value","",function(f,g){return f.setValue(g)},!0),h("mode",null,function(f,g){f.doc.modeOption=g,Jv(f)},!0),h("indentUnit",2,Jv,!0),h("indentWithTabs",!1),h("smartIndent",!0),h("tabSize",4,function(f){td(f),qu(f),Sr(f)},!0),h("lineSeparator",null,function(f,g){if(f.doc.lineSep=g,!!g){var S=[],w=f.doc.first;f.doc.iter(function(L){for(var P=0;;){var F=L.text.indexOf(g,P);if(F==-1)break;P=F+g.length,S.push(q(w,F))}w++});for(var T=S.length-1;T>=0;T--)mc(f.doc,g,S[T],q(S[T].line,S[T].ch+g.length))}}),h("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200c\u200e\u200f\u2028\u2029\ufeff\ufff9-\ufffc]/g,function(f,g,S){f.state.specialChars=new RegExp(g.source+(g.test("	")?"":"|	"),"g"),S!=Sc&&f.refresh()}),h("specialCharPlaceholder",o3,function(f){return f.refresh()},!0),h("electricChars",!0),h("inputStyle",k?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),h("spellcheck",!1,function(f,g){return f.getInputField().spellcheck=g},!0),h("autocorrect",!1,function(f,g){return f.getInputField().autocorrect=g},!0),h("autocapitalize",!1,function(f,g){return f.getInputField().autocapitalize=g},!0),h("rtlMoveVisually",!A),h("wholeLineUpdateBefore",!0),h("theme","default",function(f){XL(f),ed(f)},!0),h("keyMap","default",function(f,g,S){var w=sh(g),T=S!=Sc&&sh(S);T&&T.detach&&T.detach(f,w),w.attach&&w.attach(f,T||null)}),h("extraKeys",null),h("configureMouse",null),h("lineWrapping",!1,R4,!0),h("gutters",[],function(f,g){f.display.gutterSpecs=jv(g,f.options.lineNumbers),ed(f)},!0),h("fixedGutter",!0,function(f,g){f.display.gutters.style.left=g?Ov(f.display)+"px":"0",f.refresh()},!0),h("coverGutterNextToScrollbar",!1,function(f){return dc(f)},!0),h("scrollbarStyle","native",function(f){eL(f),dc(f),f.display.scrollbars.setScrollTop(f.doc.scrollTop),f.display.scrollbars.setScrollLeft(f.doc.scrollLeft)},!0),h("lineNumbers",!1,function(f,g){f.display.gutterSpecs=jv(f.options.gutters,g),ed(f)},!0),h("firstLineNumber",1,ed,!0),h("lineNumberFormatter",function(f){return f},ed,!0),h("showCursorWhenSelecting",!1,Ju,!0),h("resetSelectionOnContextMenu",!0),h("lineWiseCopyCut",!0),h("pasteLinesPerSelection",!0),h("selectionsMayTouch",!1),h("readOnly",!1,function(f,g){g=="nocursor"&&(cc(f),f.display.input.blur()),f.display.input.readOnlyChanged(g)}),h("screenReaderLabel",null,function(f,g){g=g===""?null:g,f.display.input.screenReaderLabelChanged(g)}),h("disableInput",!1,function(f,g){g||f.display.input.reset()},!0),h("dragDrop",!0,M4),h("allowDropFileTypes",null),h("cursorBlinkRate",530),h("cursorScrollMargin",0),h("cursorHeight",1,Ju,!0),h("singleCursorHeightPerLine",!0,Ju,!0),h("workTime",100),h("workDelay",100),h("flattenSpans",!0,td,!0),h("addModeClass",!1,td,!0),h("pollInterval",100),h("undoDepth",200,function(f,g){return f.doc.history.undoDepth=g}),h("historyEventDelay",1250),h("viewportMargin",10,function(f){return f.refresh()},!0),h("maxHighlightLength",1e4,td,!0),h("moveInputWithCursor",!0,function(f,g){g||f.display.input.resetPosition()}),h("tabindex",null,function(f,g){return f.display.input.getField().tabIndex=g||""}),h("autofocus",null),h("direction","ltr",function(f,g){return f.doc.setDirection(g)},!0),h("phrases",null)}function M4(s,u,h){var f=h&&h!=Sc;if(!u!=!f){var g=s.display.dragFunctions,S=u?be:nt;S(s.display.scroller,"dragstart",g.start),S(s.display.scroller,"dragenter",g.enter),S(s.display.scroller,"dragover",g.over),S(s.display.scroller,"dragleave",g.leave),S(s.display.scroller,"drop",g.drop)}}function R4(s){s.options.lineWrapping?(xe(s.display.wrapper,"CodeMirror-wrap"),s.display.sizer.style.minWidth="",s.display.sizerWidth=null):(U(s.display.wrapper,"CodeMirror-wrap"),kv(s)),Nv(s),Sr(s),qu(s),setTimeout(function(){return dc(s)},100)}function Kt(s,u){var h=this;if(!(this instanceof Kt))return new Kt(s,u);this.options=u=u?je(u):{},je(QL,u,!1);var f=u.value;typeof f=="string"?f=new br(f,u.mode,null,u.lineSeparator,u.direction):u.mode&&(f.modeOption=u.mode),this.doc=f;var g=new Kt.inputStyles[u.inputStyle](this),S=this.display=new j3(s,f,g,u);S.wrapper.CodeMirror=this,XL(this),u.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),eL(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new Pe,keySeq:null,specialChars:null},u.autofocus&&!k&&S.input.focus(),o&&l<11&&setTimeout(function(){return h.display.input.reset(!0)},20),_4(this),d4(),$s(this),this.curOp.forceUpdate=!0,uL(this,f),u.autofocus&&!k||this.hasFocus()?setTimeout(function(){h.hasFocus()&&!h.state.focused&&Uv(h)},20):cc(this);for(var w in ch)ch.hasOwnProperty(w)&&ch[w](this,u[w],Sc);rL(this),u.finishInit&&u.finishInit(this);for(var T=0;T<aS.length;++T)aS[T](this);js(this),c&&u.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}Kt.defaults=QL,Kt.optionHandlers=ch;function _4(s){var u=s.display;be(u.scroller,"mousedown",Ln(s,qL)),o&&l<11?be(u.scroller,"dblclick",Ln(s,function(L){if(!Ot(s,L)){var P=Gs(s,L);if(!(!P||iS(s,L)||Ja(s.display,L))){mn(L);var F=s.findWordAt(P);nh(s.doc,F.anchor,F.head)}}})):be(u.scroller,"dblclick",function(L){return Ot(s,L)||mn(L)}),be(u.scroller,"contextmenu",function(L){return KL(s,L)}),be(u.input.getField(),"contextmenu",function(L){u.scroller.contains(L.target)||KL(s,L)});var h,f={end:0};function g(){u.activeTouch&&(h=setTimeout(function(){return u.activeTouch=null},1e3),f=u.activeTouch,f.end=+new Date)}function S(L){if(L.touches.length!=1)return!1;var P=L.touches[0];return P.radiusX<=1&&P.radiusY<=1}function w(L,P){if(P.left==null)return!0;var F=P.left-L.left,W=P.top-L.top;return F*F+W*W>20*20}be(u.scroller,"touchstart",function(L){if(!Ot(s,L)&&!S(L)&&!iS(s,L)){u.input.ensurePolled(),clearTimeout(h);var P=+new Date;u.activeTouch={start:P,moved:!1,prev:P-f.end<=300?f:null},L.touches.length==1&&(u.activeTouch.left=L.touches[0].pageX,u.activeTouch.top=L.touches[0].pageY)}}),be(u.scroller,"touchmove",function(){u.activeTouch&&(u.activeTouch.moved=!0)}),be(u.scroller,"touchend",function(L){var P=u.activeTouch;if(P&&!Ja(u,L)&&P.left!=null&&!P.moved&&new Date-P.start<300){var F=s.coordsChar(u.activeTouch,"page"),W;!P.prev||w(P,P.prev)?W=new xt(F,F):!P.prev.prev||w(P,P.prev.prev)?W=s.findWordAt(F):W=new xt(q(F.line,0),Ze(s.doc,q(F.line+1,0))),s.setSelection(W.anchor,W.head),s.focus(),mn(L)}g()}),be(u.scroller,"touchcancel",g),be(u.scroller,"scroll",function(){u.scroller.clientHeight&&(Ku(s,u.scroller.scrollTop),zs(s,u.scroller.scrollLeft,!0),Wt(s,"scroll",s))}),be(u.scroller,"mousewheel",function(L){return oL(s,L)}),be(u.scroller,"DOMMouseScroll",function(L){return oL(s,L)}),be(u.wrapper,"scroll",function(){return u.wrapper.scrollTop=u.wrapper.scrollLeft=0}),u.dragFunctions={enter:function(L){Ot(s,L)||zn(L)},over:function(L){Ot(s,L)||(u4(s,L),zn(L))},start:function(L){return c4(s,L)},drop:Ln(s,l4),leave:function(L){Ot(s,L)||_L(s)}};var T=u.input.getField();be(T,"keyup",function(L){return $L.call(s,L)}),be(T,"keydown",Ln(s,HL)),be(T,"keypress",Ln(s,jL)),be(T,"focus",function(L){return Uv(s,L)}),be(T,"blur",function(L){return cc(s,L)})}var aS=[];Kt.defineInitHook=function(s){return aS.push(s)};function hd(s,u,h,f){var g=s.doc,S;h==null&&(h="add"),h=="smart"&&(g.mode.indent?S=Wu(s,u).state:h="prev");var w=s.options.tabSize,T=_e(g,u),L=Be(T.text,null,w);T.stateAfter&&(T.stateAfter=null);var P=T.text.match(/^\s*/)[0],F;if(!f&&!/\S/.test(T.text))F=0,h="not";else if(h=="smart"&&(F=g.mode.indent(S,T.text.slice(P.length),T.text),F==ht||F>150)){if(!f)return;h="prev"}h=="prev"?u>g.first?F=Be(_e(g,u-1).text,null,w):F=0:h=="add"?F=L+s.options.indentUnit:h=="subtract"?F=L-s.options.indentUnit:typeof h=="number"&&(F=L+h),F=Math.max(0,F);var W="",Y=0;if(s.options.indentWithTabs)for(var J=Math.floor(F/w);J;--J)Y+=w,W+="	";if(Y<F&&(W+=Bn(F-Y)),W!=P)return mc(g,W,q(u,0),q(u,P.length),"+input"),T.stateAfter=null,!0;for(var ee=0;ee<g.sel.ranges.length;ee++){var ne=g.sel.ranges[ee];if(ne.head.line==u&&ne.head.ch<P.length){var de=q(u,P.length);Qv(g,ee,new xt(de,de));break}}}var _i=null;function uh(s){_i=s}function oS(s,u,h,f,g){var S=s.doc;s.display.shift=!1,f||(f=S.sel);var w=+new Date-200,T=g=="paste"||s.state.pasteIncoming>w,L=la(u),P=null;if(T&&f.ranges.length>1)if(_i&&_i.text.join(`
`)==u){if(f.ranges.length%_i.text.length==0){P=[];for(var F=0;F<_i.text.length;F++)P.push(S.splitLines(_i.text[F]))}}else L.length==f.ranges.length&&s.options.pasteLinesPerSelection&&(P=ln(L,function(ye){return[ye]}));for(var W=s.curOp.updateInput,Y=f.ranges.length-1;Y>=0;Y--){var J=f.ranges[Y],ee=J.from(),ne=J.to();J.empty()&&(h&&h>0?ee=q(ee.line,ee.ch-h):s.state.overwrite&&!T?ne=q(ne.line,Math.min(_e(S,ne.line).text.length,ne.ch+Oe(L).length)):T&&_i&&_i.lineWise&&_i.text.join(`
`)==L.join(`
`)&&(ee=ne=q(ee.line,0)));var de={from:ee,to:ne,text:P?P[Y%P.length]:L,origin:g||(T?"paste":s.state.cutIncoming>w?"cut":"+input")};hc(s.doc,de),Un(s,"inputRead",s,de)}u&&!T&&eE(s,u),uc(s),s.curOp.updateInput<2&&(s.curOp.updateInput=W),s.curOp.typing=!0,s.state.pasteIncoming=s.state.cutIncoming=-1}function ZL(s,u){var h=s.clipboardData&&s.clipboardData.getData("Text");if(h)return s.preventDefault(),!u.isReadOnly()&&!u.options.disableInput&&Or(u,function(){return oS(u,h,0,null,"paste")}),!0}function eE(s,u){if(!(!s.options.electricChars||!s.options.smartIndent))for(var h=s.doc.sel,f=h.ranges.length-1;f>=0;f--){var g=h.ranges[f];if(!(g.head.ch>100||f&&h.ranges[f-1].head.line==g.head.line)){var S=s.getModeAt(g.head),w=!1;if(S.electricChars){for(var T=0;T<S.electricChars.length;T++)if(u.indexOf(S.electricChars.charAt(T))>-1){w=hd(s,g.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(_e(s.doc,g.head.line).text.slice(0,g.head.ch))&&(w=hd(s,g.head.line,"smart"));w&&Un(s,"electricInput",s,g.head.line)}}}function tE(s){for(var u=[],h=[],f=0;f<s.doc.sel.ranges.length;f++){var g=s.doc.sel.ranges[f].head.line,S={anchor:q(g,0),head:q(g+1,0)};h.push(S),u.push(s.getRange(S.anchor,S.head))}return{text:u,ranges:h}}function nE(s,u,h,f){s.setAttribute("autocorrect",h?"":"off"),s.setAttribute("autocapitalize",f?"":"off"),s.setAttribute("spellcheck",!!u)}function rE(){var s=R("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none"),u=R("div",[s],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return c?s.style.width="1000px":s.setAttribute("wrap","off"),x&&(s.style.border="1px solid black"),nE(s),u}function V4(s){var u=s.optionHandlers,h=s.helpers={};s.prototype={constructor:s,focus:function(){window.focus(),this.display.input.focus()},setOption:function(f,g){var S=this.options,w=S[f];S[f]==g&&f!="mode"||(S[f]=g,u.hasOwnProperty(f)&&Ln(this,u[f])(this,g,w),Wt(this,"optionChange",this,f))},getOption:function(f){return this.options[f]},getDoc:function(){return this.doc},addKeyMap:function(f,g){this.state.keyMaps[g?"push":"unshift"](sh(f))},removeKeyMap:function(f){for(var g=this.state.keyMaps,S=0;S<g.length;++S)if(g[S]==f||g[S].name==f)return g.splice(S,1),!0},addOverlay:tr(function(f,g){var S=f.token?f:s.getMode(this.options,f);if(S.startState)throw new Error("Overlays may not be stateful.");pi(this.state.overlays,{mode:S,modeSpec:f,opaque:g&&g.opaque,priority:g&&g.priority||0},function(w){return w.priority}),this.state.modeGen++,Sr(this)}),removeOverlay:tr(function(f){for(var g=this.state.overlays,S=0;S<g.length;++S){var w=g[S].modeSpec;if(w==f||typeof f=="string"&&w.name==f){g.splice(S,1),this.state.modeGen++,Sr(this);return}}}),indentLine:tr(function(f,g,S){typeof g!="string"&&typeof g!="number"&&(g==null?g=this.options.smartIndent?"smart":"prev":g=g?"add":"subtract"),H(this.doc,f)&&hd(this,f,g,S)}),indentSelection:tr(function(f){for(var g=this.doc.sel.ranges,S=-1,w=0;w<g.length;w++){var T=g[w];if(T.empty())T.head.line>S&&(hd(this,T.head.line,f,!0),S=T.head.line,w==this.doc.sel.primIndex&&uc(this));else{var L=T.from(),P=T.to(),F=Math.max(S,L.line);S=Math.min(this.lastLine(),P.line-(P.ch?0:1))+1;for(var W=F;W<S;++W)hd(this,W,f);var Y=this.doc.sel.ranges;L.ch==0&&g.length==Y.length&&Y[w].from().ch>0&&Qv(this.doc,w,new xt(L,Y[w].to()),Dt)}}}),getTokenAt:function(f,g){return uk(this,f,g)},getLineTokens:function(f,g){return uk(this,q(f),g,!0)},getTokenTypeAt:function(f){f=Ze(this.doc,f);var g=sk(this,_e(this.doc,f.line)),S=0,w=(g.length-1)/2,T=f.ch,L;if(T==0)L=g[2];else for(;;){var P=S+w>>1;if((P?g[P*2-1]:0)>=T)w=P;else if(g[P*2+1]<T)S=P+1;else{L=g[P*2+2];break}}var F=L?L.indexOf("overlay "):-1;return F<0?L:F==0?null:L.slice(0,F-1)},getModeAt:function(f){var g=this.doc.mode;return g.innerMode?s.innerMode(g,this.getTokenAt(f).state).mode:g},getHelper:function(f,g){return this.getHelpers(f,g)[0]},getHelpers:function(f,g){var S=[];if(!h.hasOwnProperty(g))return S;var w=h[g],T=this.getModeAt(f);if(typeof T[g]=="string")w[T[g]]&&S.push(w[T[g]]);else if(T[g])for(var L=0;L<T[g].length;L++){var P=w[T[g][L]];P&&S.push(P)}else T.helperType&&w[T.helperType]?S.push(w[T.helperType]):w[T.name]&&S.push(w[T.name]);for(var F=0;F<w._global.length;F++){var W=w._global[F];W.pred(T,this)&&ge(S,W.val)==-1&&S.push(W.val)}return S},getStateAfter:function(f,g){var S=this.doc;return f=Nf(S,f==null?S.first+S.size-1:f),Wu(this,f+1,g).state},cursorCoords:function(f,g){var S,w=this.doc.sel.primary();return f==null?S=w.head:typeof f=="object"?S=Ze(this.doc,f):S=f?w.from():w.to(),Mi(this,S,g||"page")},charCoords:function(f,g){return Av(this,Ze(this.doc,f),g||"page")},coordsChar:function(f,g){return f=Uk(this,f,g||"page"),Rv(this,f.left,f.top)},lineAtHeight:function(f,g){return f=Uk(this,{top:f,left:0},g||"page").top,O(this.doc,f+this.display.viewOffset)},heightAtLine:function(f,g,S){var w=!1,T;if(typeof f=="number"){var L=this.doc.first+this.doc.size-1;f<this.doc.first?f=this.doc.first:f>L&&(f=L,w=!0),T=_e(this.doc,f)}else T=f;return jf(this,T,{top:0,left:0},g||"page",S||w).top+(w?this.doc.height-qa(T):0)},defaultTextHeight:function(){return sc(this.display)},defaultCharWidth:function(){return lc(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(f,g,S,w,T){var L=this.display;f=Mi(this,Ze(this.doc,f));var P=f.bottom,F=f.left;if(g.style.position="absolute",g.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(g),L.sizer.appendChild(g),w=="over")P=f.top;else if(w=="above"||w=="near"){var W=Math.max(L.wrapper.clientHeight,this.doc.height),Y=Math.max(L.sizer.clientWidth,L.lineSpace.clientWidth);(w=="above"||f.bottom+g.offsetHeight>W)&&f.top>g.offsetHeight?P=f.top-g.offsetHeight:f.bottom+g.offsetHeight<=W&&(P=f.bottom),F+g.offsetWidth>Y&&(F=Y-g.offsetWidth)}g.style.top=P+"px",g.style.left=g.style.right="",T=="right"?(F=L.sizer.clientWidth-g.offsetWidth,g.style.right="0px"):(T=="left"?F=0:T=="middle"&&(F=(L.sizer.clientWidth-g.offsetWidth)/2),g.style.left=F+"px"),S&&M3(this,{left:F,top:P,right:F+g.offsetWidth,bottom:P+g.offsetHeight})},triggerOnKeyDown:tr(HL),triggerOnKeyPress:tr(jL),triggerOnKeyUp:$L,triggerOnMouseDown:tr(qL),execCommand:function(f){if(ud.hasOwnProperty(f))return ud[f].call(null,this)},triggerElectric:tr(function(f){eE(this,f)}),findPosH:function(f,g,S,w){var T=1;g<0&&(T=-1,g=-g);for(var L=Ze(this.doc,f),P=0;P<g&&(L=sS(this.doc,L,T,S,w),!L.hitSide);++P);return L},moveH:tr(function(f,g){var S=this;this.extendSelectionsBy(function(w){return S.display.shift||S.doc.extend||w.empty()?sS(S.doc,w.head,f,g,S.options.rtlMoveVisually):f<0?w.from():w.to()},Xe)}),deleteH:tr(function(f,g){var S=this.doc.sel,w=this.doc;S.somethingSelected()?w.replaceSelection("",null,"+delete"):vc(this,function(T){var L=sS(w,T.head,f,g,!1);return f<0?{from:L,to:T.head}:{from:T.head,to:L}})}),findPosV:function(f,g,S,w){var T=1,L=w;g<0&&(T=-1,g=-g);for(var P=Ze(this.doc,f),F=0;F<g;++F){var W=Mi(this,P,"div");if(L==null?L=W.left:W.left=L,P=iE(this,W,T,S),P.hitSide)break}return P},moveV:tr(function(f,g){var S=this,w=this.doc,T=[],L=!this.display.shift&&!w.extend&&w.sel.somethingSelected();if(w.extendSelectionsBy(function(F){if(L)return f<0?F.from():F.to();var W=Mi(S,F.head,"div");F.goalColumn!=null&&(W.left=F.goalColumn),T.push(W.left);var Y=iE(S,W,f,g);return g=="page"&&F==w.sel.primary()&&Gv(S,Av(S,Y,"div").top-W.top),Y},Xe),T.length)for(var P=0;P<w.sel.ranges.length;P++)w.sel.ranges[P].goalColumn=T[P]}),findWordAt:function(f){var g=this.doc,S=_e(g,f.line).text,w=f.ch,T=f.ch;if(S){var L=this.getHelper(f,"wordChars");(f.sticky=="before"||T==S.length)&&w?--w:++T;for(var P=S.charAt(w),F=ke(P,L)?function(W){return ke(W,L)}:/\s/.test(P)?function(W){return/\s/.test(W)}:function(W){return!/\s/.test(W)&&!ke(W)};w>0&&F(S.charAt(w-1));)--w;for(;T<S.length&&F(S.charAt(T));)++T}return new xt(q(f.line,w),q(f.line,T))},toggleOverwrite:function(f){f!=null&&f==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?xe(this.display.cursorDiv,"CodeMirror-overwrite"):U(this.display.cursorDiv,"CodeMirror-overwrite"),Wt(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==me()},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:tr(function(f,g){Yu(this,f,g)}),getScrollInfo:function(){var f=this.display.scroller;return{left:f.scrollLeft,top:f.scrollTop,height:f.scrollHeight-fa(this)-this.display.barHeight,width:f.scrollWidth-fa(this)-this.display.barWidth,clientHeight:Dv(this),clientWidth:Us(this)}},scrollIntoView:tr(function(f,g){f==null?(f={from:this.doc.sel.primary().head,to:null},g==null&&(g=this.options.cursorScrollMargin)):typeof f=="number"?f={from:q(f,0),to:null}:f.from==null&&(f={from:f,to:null}),f.to||(f.to=f.from),f.margin=g||0,f.from.line!=null?R3(this,f):Kk(this,f.from,f.to,f.margin)}),setSize:tr(function(f,g){var S=this,w=function(L){return typeof L=="number"||/^\d+$/.test(String(L))?L+"px":L};f!=null&&(this.display.wrapper.style.width=w(f)),g!=null&&(this.display.wrapper.style.height=w(g)),this.options.lineWrapping&&Ok(this);var T=this.display.viewFrom;this.doc.iter(T,this.display.viewTo,function(L){if(L.widgets){for(var P=0;P<L.widgets.length;P++)if(L.widgets[P].noHScroll){Uo(S,T,"widget");break}}++T}),this.curOp.forceUpdate=!0,Wt(this,"refresh",this)}),operation:function(f){return Or(this,f)},startOperation:function(){return $s(this)},endOperation:function(){return js(this)},refresh:tr(function(){var f=this.display.cachedTextHeight;Sr(this),this.curOp.forceUpdate=!0,qu(this),Yu(this,this.doc.scrollLeft,this.doc.scrollTop),Hv(this.display),(f==null||Math.abs(f-sc(this.display))>.5||this.options.lineWrapping)&&Nv(this),Wt(this,"refresh",this)}),swapDoc:tr(function(f){var g=this.doc;return g.cm=null,this.state.selectingText&&this.state.selectingText(),uL(this,f),qu(this),this.display.input.reset(),Yu(this,f.scrollLeft,f.scrollTop),this.curOp.forceScroll=!0,Un(this,"swapDoc",this,g),g}),phrase:function(f){var g=this.options.phrases;return g&&Object.prototype.hasOwnProperty.call(g,f)?g[f]:f},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Oo(s),s.registerHelper=function(f,g,S){h.hasOwnProperty(f)||(h[f]=s[f]={_global:[]}),h[f][g]=S},s.registerGlobalHelper=function(f,g,S,w){s.registerHelper(f,g,w),h[f]._global.push({pred:S,val:w})}}function sS(s,u,h,f,g){var S=u,w=h,T=_e(s,u.line),L=g&&s.direction=="rtl"?-h:h;function P(){var we=u.line+L;return we<s.first||we>=s.first+s.size?!1:(u=new q(we,u.ch,u.sticky),T=_e(s,we))}function F(we){var ve;if(f=="codepoint"){var Le=T.text.charCodeAt(u.ch+(f>0?0:-1));isNaN(Le)?ve=null:ve=new q(u.line,Math.max(0,Math.min(T.text.length,u.ch+h*(Le>=55296&&Le<56320?2:1))),-h)}else g?ve=g4(s.cm,T,u,h):ve=eS(T,u,h);if(ve==null)if(!we&&P())u=tS(g,s.cm,T,u.line,L);else return!1;else u=ve;return!0}if(f=="char"||f=="codepoint")F();else if(f=="column")F(!0);else if(f=="word"||f=="group")for(var W=null,Y=f=="group",J=s.cm&&s.cm.getHelper(u,"wordChars"),ee=!0;!(h<0&&!F(!ee));ee=!1){var ne=T.text.charAt(u.ch)||`
`,de=ke(ne,J)?"w":Y&&ne==`
`?"n":!Y||/\s/.test(ne)?null:"p";if(Y&&!ee&&!de&&(de="s"),W&&W!=de){h<0&&(h=1,F(),u.sticky="after");break}if(de&&(W=de),h>0&&!F(!ee))break}var ye=ih(s,u,S,w,!0);return pt(S,ye)&&(ye.hitSide=!0),ye}function iE(s,u,h,f){var g=s.doc,S=u.left,w;if(f=="page"){var T=Math.min(s.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),L=Math.max(T-.5*sc(s.display),3);w=(h>0?u.bottom:u.top)+h*L}else f=="line"&&(w=h>0?u.bottom+3:u.top-3);for(var P;P=Rv(s,S,w),!!P.outside;){if(h<0?w<=0:w>=g.height){P.hitSide=!0;break}w+=h*5}return P}var Pt=function(s){this.cm=s,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Pe,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Pt.prototype.init=function(s){var u=this,h=this,f=h.cm,g=h.div=s.lineDiv;nE(g,f.options.spellcheck,f.options.autocorrect,f.options.autocapitalize);function S(T){for(var L=T.target;L;L=L.parentNode){if(L==g)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(L.className))break}return!1}be(g,"paste",function(T){!S(T)||Ot(f,T)||ZL(T,f)||l<=11&&setTimeout(Ln(f,function(){return u.updateFromDOM()}),20)}),be(g,"compositionstart",function(T){u.composing={data:T.data,done:!1}}),be(g,"compositionupdate",function(T){u.composing||(u.composing={data:T.data,done:!1})}),be(g,"compositionend",function(T){u.composing&&(T.data!=u.composing.data&&u.readFromDOMSoon(),u.composing.done=!0)}),be(g,"touchstart",function(){return h.forceCompositionEnd()}),be(g,"input",function(){u.composing||u.readFromDOMSoon()});function w(T){if(!(!S(T)||Ot(f,T))){if(f.somethingSelected())uh({lineWise:!1,text:f.getSelections()}),T.type=="cut"&&f.replaceSelection("",null,"cut");else if(f.options.lineWiseCopyCut){var L=tE(f);uh({lineWise:!0,text:L.text}),T.type=="cut"&&f.operation(function(){f.setSelections(L.ranges,0,Dt),f.replaceSelection("",null,"cut")})}else return;if(T.clipboardData){T.clipboardData.clearData();var P=_i.text.join(`
`);if(T.clipboardData.setData("Text",P),T.clipboardData.getData("Text")==P){T.preventDefault();return}}var F=rE(),W=F.firstChild;f.display.lineSpace.insertBefore(F,f.display.lineSpace.firstChild),W.value=_i.text.join(`
`);var Y=document.activeElement;Se(W),setTimeout(function(){f.display.lineSpace.removeChild(F),Y.focus(),Y==g&&h.showPrimarySelection()},50)}}be(g,"copy",w),be(g,"cut",w)},Pt.prototype.screenReaderLabelChanged=function(s){s?this.div.setAttribute("aria-label",s):this.div.removeAttribute("aria-label")},Pt.prototype.prepareSelection=function(){var s=$k(this.cm,!1);return s.focus=document.activeElement==this.div,s},Pt.prototype.showSelection=function(s,u){!s||!this.cm.display.view.length||((s.focus||u)&&this.showPrimarySelection(),this.showMultipleSelections(s))},Pt.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},Pt.prototype.showPrimarySelection=function(){var s=this.getSelection(),u=this.cm,h=u.doc.sel.primary(),f=h.from(),g=h.to();if(u.display.viewTo==u.display.viewFrom||f.line>=u.display.viewTo||g.line<u.display.viewFrom){s.removeAllRanges();return}var S=dh(u,s.anchorNode,s.anchorOffset),w=dh(u,s.focusNode,s.focusOffset);if(!(S&&!S.bad&&w&&!w.bad&&he(vr(S,w),f)==0&&he(gn(S,w),g)==0)){var T=u.display.view,L=f.line>=u.display.viewFrom&&aE(u,f)||{node:T[0].measure.map[2],offset:0},P=g.line<u.display.viewTo&&aE(u,g);if(!P){var F=T[T.length-1].measure,W=F.maps?F.maps[F.maps.length-1]:F.map;P={node:W[W.length-1],offset:W[W.length-2]-W[W.length-3]}}if(!L||!P){s.removeAllRanges();return}var Y=s.rangeCount&&s.getRangeAt(0),J;try{J=j(L.node,L.offset,P.offset,P.node)}catch(ee){}J&&(!t&&u.state.focused?(s.collapse(L.node,L.offset),J.collapsed||(s.removeAllRanges(),s.addRange(J))):(s.removeAllRanges(),s.addRange(J)),Y&&s.anchorNode==null?s.addRange(Y):t&&this.startGracePeriod()),this.rememberSelection()}},Pt.prototype.startGracePeriod=function(){var s=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){s.gracePeriod=!1,s.selectionChanged()&&s.cm.operation(function(){return s.cm.curOp.selectionChanged=!0})},20)},Pt.prototype.showMultipleSelections=function(s){B(this.cm.display.cursorDiv,s.cursors),B(this.cm.display.selectionDiv,s.selection)},Pt.prototype.rememberSelection=function(){var s=this.getSelection();this.lastAnchorNode=s.anchorNode,this.lastAnchorOffset=s.anchorOffset,this.lastFocusNode=s.focusNode,this.lastFocusOffset=s.focusOffset},Pt.prototype.selectionInEditor=function(){var s=this.getSelection();if(!s.rangeCount)return!1;var u=s.getRangeAt(0).commonAncestorContainer;return oe(this.div,u)},Pt.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||document.activeElement!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},Pt.prototype.blur=function(){this.div.blur()},Pt.prototype.getField=function(){return this.div},Pt.prototype.supportsTouch=function(){return!0},Pt.prototype.receivedFocus=function(){var s=this;this.selectionInEditor()?this.pollSelection():Or(this.cm,function(){return s.cm.curOp.selectionChanged=!0});function u(){s.cm.state.focused&&(s.pollSelection(),s.polling.set(s.cm.options.pollInterval,u))}this.polling.set(this.cm.options.pollInterval,u)},Pt.prototype.selectionChanged=function(){var s=this.getSelection();return s.anchorNode!=this.lastAnchorNode||s.anchorOffset!=this.lastAnchorOffset||s.focusNode!=this.lastFocusNode||s.focusOffset!=this.lastFocusOffset},Pt.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var s=this.getSelection(),u=this.cm;if(C&&p&&this.cm.display.gutterSpecs.length&&O4(s.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var h=dh(u,s.anchorNode,s.anchorOffset),f=dh(u,s.focusNode,s.focusOffset);h&&f&&Or(u,function(){Hn(u.doc,Go(h,f),Dt),(h.bad||f.bad)&&(u.curOp.selectionChanged=!0)})}}},Pt.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var s=this.cm,u=s.display,h=s.doc.sel.primary(),f=h.from(),g=h.to();if(f.ch==0&&f.line>s.firstLine()&&(f=q(f.line-1,_e(s.doc,f.line-1).length)),g.ch==_e(s.doc,g.line).text.length&&g.line<s.lastLine()&&(g=q(g.line+1,0)),f.line<u.viewFrom||g.line>u.viewTo-1)return!1;var S,w,T;f.line==u.viewFrom||(S=Ws(s,f.line))==0?(w=vt(u.view[0].line),T=u.view[0].node):(w=vt(u.view[S].line),T=u.view[S-1].node.nextSibling);var L=Ws(s,g.line),P,F;if(L==u.view.length-1?(P=u.viewTo-1,F=u.lineDiv.lastChild):(P=vt(u.view[L+1].line)-1,F=u.view[L+1].node.previousSibling),!T)return!1;for(var W=s.doc.splitLines(N4(s,T,F,w,P)),Y=ua(s.doc,q(w,0),q(P,_e(s.doc,P).text.length));W.length>1&&Y.length>1;)if(Oe(W)==Oe(Y))W.pop(),Y.pop(),P--;else if(W[0]==Y[0])W.shift(),Y.shift(),w++;else break;for(var J=0,ee=0,ne=W[0],de=Y[0],ye=Math.min(ne.length,de.length);J<ye&&ne.charCodeAt(J)==de.charCodeAt(J);)++J;for(var we=Oe(W),ve=Oe(Y),Le=Math.min(we.length-(W.length==1?J:0),ve.length-(Y.length==1?J:0));ee<Le&&we.charCodeAt(we.length-ee-1)==ve.charCodeAt(ve.length-ee-1);)++ee;if(W.length==1&&Y.length==1&&w==f.line)for(;J&&J>f.ch&&we.charCodeAt(we.length-ee-1)==ve.charCodeAt(ve.length-ee-1);)J--,ee++;W[W.length-1]=we.slice(0,we.length-ee).replace(/^\u200b+/,""),W[0]=W[0].slice(J).replace(/\u200b+$/,"");var Ue=q(w,J),Ve=q(P,Y.length?Oe(Y).length-ee:0);if(W.length>1||W[0]||he(Ue,Ve))return mc(s.doc,W,Ue,Ve,"+input"),!0},Pt.prototype.ensurePolled=function(){this.forceCompositionEnd()},Pt.prototype.reset=function(){this.forceCompositionEnd()},Pt.prototype.forceCompositionEnd=function(){!this.composing||(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Pt.prototype.readFromDOMSoon=function(){var s=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(s.readDOMTimeout=null,s.composing)if(s.composing.done)s.composing=null;else return;s.updateFromDOM()},80))},Pt.prototype.updateFromDOM=function(){var s=this;(this.cm.isReadOnly()||!this.pollContent())&&Or(this.cm,function(){return Sr(s.cm)})},Pt.prototype.setUneditable=function(s){s.contentEditable="false"},Pt.prototype.onKeyPress=function(s){s.charCode==0||this.composing||(s.preventDefault(),this.cm.isReadOnly()||Ln(this.cm,oS)(this.cm,String.fromCharCode(s.charCode==null?s.keyCode:s.charCode),0))},Pt.prototype.readOnlyChanged=function(s){this.div.contentEditable=String(s!="nocursor")},Pt.prototype.onContextMenu=function(){},Pt.prototype.resetPosition=function(){},Pt.prototype.needsContentAttribute=!0;function aE(s,u){var h=Pv(s,u.line);if(!h||h.hidden)return null;var f=_e(s.doc,u.line),g=Ak(h,f,u.line),S=Jt(f,s.doc.direction),w="left";if(S){var T=Qe(S,u.ch);w=T%2?"right":"left"}var L=_k(g.map,u.ch,w);return L.offset=L.collapse=="right"?L.end:L.start,L}function O4(s){for(var u=s;u;u=u.parentNode)if(/CodeMirror-gutter-wrapper/.test(u.className))return!0;return!1}function bc(s,u){return u&&(s.bad=!0),s}function N4(s,u,h,f,g){var S="",w=!1,T=s.doc.lineSeparator(),L=!1;function P(J){return function(ee){return ee.id==J}}function F(){w&&(S+=T,L&&(S+=T),w=L=!1)}function W(J){J&&(F(),S+=J)}function Y(J){if(J.nodeType==1){var ee=J.getAttribute("cm-text");if(ee){W(ee);return}var ne=J.getAttribute("cm-marker"),de;if(ne){var ye=s.findMarks(q(f,0),q(g+1,0),P(+ne));ye.length&&(de=ye[0].find(0))&&W(ua(s.doc,de.from,de.to).join(T));return}if(J.getAttribute("contenteditable")=="false")return;var we=/^(pre|div|p|li|table|br)$/i.test(J.nodeName);if(!/^br$/i.test(J.nodeName)&&J.textContent.length==0)return;we&&F();for(var ve=0;ve<J.childNodes.length;ve++)Y(J.childNodes[ve]);/^(pre|p)$/i.test(J.nodeName)&&(L=!0),we&&(w=!0)}else J.nodeType==3&&W(J.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;Y(u),u!=h;)u=u.nextSibling,L=!1;return S}function dh(s,u,h){var f;if(u==s.display.lineDiv){if(f=s.display.lineDiv.childNodes[h],!f)return bc(s.clipPos(q(s.display.viewTo-1)),!0);u=null,h=0}else for(f=u;;f=f.parentNode){if(!f||f==s.display.lineDiv)return null;if(f.parentNode&&f.parentNode==s.display.lineDiv)break}for(var g=0;g<s.display.view.length;g++){var S=s.display.view[g];if(S.node==f)return B4(S,u,h)}}function B4(s,u,h){var f=s.text.firstChild,g=!1;if(!u||!oe(f,u))return bc(q(vt(s.line),0),!0);if(u==f&&(g=!0,u=f.childNodes[h],h=0,!u)){var S=s.rest?Oe(s.rest):s.line;return bc(q(vt(S),S.text.length),g)}var w=u.nodeType==3?u:null,T=u;for(!w&&u.childNodes.length==1&&u.firstChild.nodeType==3&&(w=u.firstChild,h&&(h=w.nodeValue.length));T.parentNode!=f;)T=T.parentNode;var L=s.measure,P=L.maps;function F(de,ye,we){for(var ve=-1;ve<(P?P.length:0);ve++)for(var Le=ve<0?L.map:P[ve],Ue=0;Ue<Le.length;Ue+=3){var Ve=Le[Ue+2];if(Ve==de||Ve==ye){var st=vt(ve<0?s.line:s.rest[ve]),Nt=Le[Ue]+we;return(we<0||Ve!=de)&&(Nt=Le[Ue+(we?1:0)]),q(st,Nt)}}}var W=F(w,T,h);if(W)return bc(W,g);for(var Y=T.nextSibling,J=w?w.nodeValue.length-h:0;Y;Y=Y.nextSibling){if(W=F(Y,Y.firstChild,0),W)return bc(q(W.line,W.ch-J),g);J+=Y.textContent.length}for(var ee=T.previousSibling,ne=h;ee;ee=ee.previousSibling){if(W=F(ee,ee.firstChild,-1),W)return bc(q(W.line,W.ch+ne),g);ne+=ee.textContent.length}}var cn=function(s){this.cm=s,this.prevInput="",this.pollingFast=!1,this.polling=new Pe,this.hasSelection=!1,this.composing=null};cn.prototype.init=function(s){var u=this,h=this,f=this.cm;this.createField(s);var g=this.textarea;s.wrapper.insertBefore(this.wrapper,s.wrapper.firstChild),x&&(g.style.width="0px"),be(g,"input",function(){o&&l>=9&&u.hasSelection&&(u.hasSelection=null),h.poll()}),be(g,"paste",function(w){Ot(f,w)||ZL(w,f)||(f.state.pasteIncoming=+new Date,h.fastPoll())});function S(w){if(!Ot(f,w)){if(f.somethingSelected())uh({lineWise:!1,text:f.getSelections()});else if(f.options.lineWiseCopyCut){var T=tE(f);uh({lineWise:!0,text:T.text}),w.type=="cut"?f.setSelections(T.ranges,null,Dt):(h.prevInput="",g.value=T.text.join(`
`),Se(g))}else return;w.type=="cut"&&(f.state.cutIncoming=+new Date)}}be(g,"cut",S),be(g,"copy",S),be(s.scroller,"paste",function(w){if(!(Ja(s,w)||Ot(f,w))){if(!g.dispatchEvent){f.state.pasteIncoming=+new Date,h.focus();return}var T=new Event("paste");T.clipboardData=w.clipboardData,g.dispatchEvent(T)}}),be(s.lineSpace,"selectstart",function(w){Ja(s,w)||mn(w)}),be(g,"compositionstart",function(){var w=f.getCursor("from");h.composing&&h.composing.range.clear(),h.composing={start:w,range:f.markText(w,f.getCursor("to"),{className:"CodeMirror-composing"})}}),be(g,"compositionend",function(){h.composing&&(h.poll(),h.composing.range.clear(),h.composing=null)})},cn.prototype.createField=function(s){this.wrapper=rE(),this.textarea=this.wrapper.firstChild},cn.prototype.screenReaderLabelChanged=function(s){s?this.textarea.setAttribute("aria-label",s):this.textarea.removeAttribute("aria-label")},cn.prototype.prepareSelection=function(){var s=this.cm,u=s.display,h=s.doc,f=$k(s);if(s.options.moveInputWithCursor){var g=Mi(s,h.sel.primary().head,"div"),S=u.wrapper.getBoundingClientRect(),w=u.lineDiv.getBoundingClientRect();f.teTop=Math.max(0,Math.min(u.wrapper.clientHeight-10,g.top+w.top-S.top)),f.teLeft=Math.max(0,Math.min(u.wrapper.clientWidth-10,g.left+w.left-S.left))}return f},cn.prototype.showSelection=function(s){var u=this.cm,h=u.display;B(h.cursorDiv,s.cursors),B(h.selectionDiv,s.selection),s.teTop!=null&&(this.wrapper.style.top=s.teTop+"px",this.wrapper.style.left=s.teLeft+"px")},cn.prototype.reset=function(s){if(!(this.contextMenuPending||this.composing)){var u=this.cm;if(u.somethingSelected()){this.prevInput="";var h=u.getSelection();this.textarea.value=h,u.state.focused&&Se(this.textarea),o&&l>=9&&(this.hasSelection=h)}else s||(this.prevInput=this.textarea.value="",o&&l>=9&&(this.hasSelection=null))}},cn.prototype.getField=function(){return this.textarea},cn.prototype.supportsTouch=function(){return!1},cn.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!k||me()!=this.textarea))try{this.textarea.focus()}catch(s){}},cn.prototype.blur=function(){this.textarea.blur()},cn.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},cn.prototype.receivedFocus=function(){this.slowPoll()},cn.prototype.slowPoll=function(){var s=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){s.poll(),s.cm.state.focused&&s.slowPoll()})},cn.prototype.fastPoll=function(){var s=!1,u=this;u.pollingFast=!0;function h(){var f=u.poll();!f&&!s?(s=!0,u.polling.set(60,h)):(u.pollingFast=!1,u.slowPoll())}u.polling.set(20,h)},cn.prototype.poll=function(){var s=this,u=this.cm,h=this.textarea,f=this.prevInput;if(this.contextMenuPending||!u.state.focused||ca(h)&&!f&&!this.composing||u.isReadOnly()||u.options.disableInput||u.state.keySeq)return!1;var g=h.value;if(g==f&&!u.somethingSelected())return!1;if(o&&l>=9&&this.hasSelection===g||M&&/[\uf700-\uf7ff]/.test(g))return u.display.input.reset(),!1;if(u.doc.sel==u.display.selForContextMenu){var S=g.charCodeAt(0);if(S==8203&&!f&&(f="\u200B"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var w=0,T=Math.min(f.length,g.length);w<T&&f.charCodeAt(w)==g.charCodeAt(w);)++w;return Or(u,function(){oS(u,g.slice(w),f.length-w,null,s.composing?"*compose":null),g.length>1e3||g.indexOf(`
`)>-1?h.value=s.prevInput="":s.prevInput=g,s.composing&&(s.composing.range.clear(),s.composing.range=u.markText(s.composing.start,u.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},cn.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},cn.prototype.onKeyPress=function(){o&&l>=9&&(this.hasSelection=null),this.fastPoll()},cn.prototype.onContextMenu=function(s){var u=this,h=u.cm,f=h.display,g=u.textarea;u.contextMenuPending&&u.contextMenuPending();var S=Gs(h,s),w=f.scroller.scrollTop;if(!S||m)return;var T=h.options.resetSelectionOnContextMenu;T&&h.doc.sel.contains(S)==-1&&Ln(h,Hn)(h.doc,Go(S),Dt);var L=g.style.cssText,P=u.wrapper.style.cssText,F=u.wrapper.offsetParent.getBoundingClientRect();u.wrapper.style.cssText="position: static",g.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(s.clientY-F.top-5)+"px; left: "+(s.clientX-F.left-5)+`px;
      z-index: 1000; background: `+(o?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var W;c&&(W=window.scrollY),f.input.focus(),c&&window.scrollTo(null,W),f.input.reset(),h.somethingSelected()||(g.value=u.prevInput=" "),u.contextMenuPending=J,f.selForContextMenu=h.doc.sel,clearTimeout(f.detectingSelectAll);function Y(){if(g.selectionStart!=null){var ne=h.somethingSelected(),de="\u200B"+(ne?g.value:"");g.value="\u21DA",g.value=de,u.prevInput=ne?"":"\u200B",g.selectionStart=1,g.selectionEnd=de.length,f.selForContextMenu=h.doc.sel}}function J(){if(u.contextMenuPending==J&&(u.contextMenuPending=!1,u.wrapper.style.cssText=P,g.style.cssText=L,o&&l<9&&f.scrollbars.setScrollTop(f.scroller.scrollTop=w),g.selectionStart!=null)){(!o||o&&l<9)&&Y();var ne=0,de=function(){f.selForContextMenu==h.doc.sel&&g.selectionStart==0&&g.selectionEnd>0&&u.prevInput=="\u200B"?Ln(h,wL)(h):ne++<10?f.detectingSelectAll=setTimeout(de,500):(f.selForContextMenu=null,f.input.reset())};f.detectingSelectAll=setTimeout(de,200)}}if(o&&l>=9&&Y(),V){zn(s);var ee=function(){nt(window,"mouseup",ee),setTimeout(J,20)};be(window,"mouseup",ee)}else setTimeout(J,50)},cn.prototype.readOnlyChanged=function(s){s||this.reset(),this.textarea.disabled=s=="nocursor",this.textarea.readOnly=!!s},cn.prototype.setUneditable=function(){},cn.prototype.needsContentAttribute=!1;function U4(s,u){if(u=u?je(u):{},u.value=s.value,!u.tabindex&&s.tabIndex&&(u.tabindex=s.tabIndex),!u.placeholder&&s.placeholder&&(u.placeholder=s.placeholder),u.autofocus==null){var h=me();u.autofocus=h==s||s.getAttribute("autofocus")!=null&&h==document.body}function f(){s.value=T.getValue()}var g;if(s.form&&(be(s.form,"submit",f),!u.leaveSubmitMethodAlone)){var S=s.form;g=S.submit;try{var w=S.submit=function(){f(),S.submit=g,S.submit(),S.submit=w}}catch(L){}}u.finishInit=function(L){L.save=f,L.getTextArea=function(){return s},L.toTextArea=function(){L.toTextArea=isNaN,f(),s.parentNode.removeChild(L.getWrapperElement()),s.style.display="",s.form&&(nt(s.form,"submit",f),!u.leaveSubmitMethodAlone&&typeof s.form.submit=="function"&&(s.form.submit=g))}},s.style.display="none";var T=Kt(function(L){return s.parentNode.insertBefore(L,s.nextSibling)},u);return T}function F4(s){s.off=nt,s.on=be,s.wheelEventPixels=q3,s.Doc=br,s.splitLines=la,s.countColumn=Be,s.findColumn=qt,s.isWordChar=le,s.Pass=ht,s.signal=Wt,s.Line=ic,s.changeEnd=Wo,s.scrollbarModel=Zk,s.Pos=q,s.cmpPos=he,s.modes=Uu,s.mimeModes=za,s.resolveMode=Ha,s.getMode=Fu,s.modeExtensions=$a,s.extendMode=vv,s.copyState=fi,s.startState=Of,s.innerMode=rc,s.commands=ud,s.keyMap=Ya,s.keyName=UL,s.isModifierKey=NL,s.lookupKey=yc,s.normalizeKeyMap=m4,s.StringStream=Yt,s.SharedTextMarker=sd,s.TextMarker=Ho,s.LineWidget=od,s.e_preventDefault=mn,s.e_stopPropagation=Rf,s.e_stop=zn,s.addClass=xe,s.contains=oe,s.rmClass=U,s.keyNames=$o}A4(Kt),V4(Kt);var G4="iter insert remove copy getEditor constructor".split(" ");for(var ph in br.prototype)br.prototype.hasOwnProperty(ph)&&ge(G4,ph)<0&&(Kt.prototype[ph]=function(s){return function(){return s.apply(this.doc,arguments)}}(br.prototype[ph]));return Oo(br),Kt.inputStyles={textarea:cn,contenteditable:Pt},Kt.defineMode=function(s){!Kt.defaults.mode&&s!="null"&&(Kt.defaults.mode=s),nc.apply(this,arguments)},Kt.defineMIME=Ai,Kt.defineMode("null",function(){return{token:function(s){return s.skipToEnd()}}}),Kt.defineMIME("text/plain","null"),Kt.defineExtension=function(s,u){Kt.prototype[s]=u},Kt.defineDocExtension=function(s,u){br.prototype[s]=u},Kt.fromTextArea=U4,F4(Kt),Kt.version="5.58.2",Kt})});var B2=Ce((O2,N2)=>{(function(n){typeof O2=="object"&&typeof N2=="object"?n(Ds()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";var e="CodeMirror-lint-markers";function t(I,A,D){var E=document.createElement("div");E.className="CodeMirror-lint-tooltip cm-s-"+I.options.theme,E.appendChild(D.cloneNode(!0)),I.state.lint.options.selfContain?I.getWrapperElement().appendChild(E):document.body.appendChild(E);function V(N){if(!E.parentNode)return n.off(document,"mousemove",V);E.style.top=Math.max(0,N.clientY-E.offsetHeight-5)+"px",E.style.left=N.clientX+5+"px"}return n.on(document,"mousemove",V),V(A),E.style.opacity!=null&&(E.style.opacity=1),E}function r(I){I.parentNode&&I.parentNode.removeChild(I)}function i(I){!I.parentNode||(I.style.opacity==null&&r(I),I.style.opacity=0,setTimeout(function(){r(I)},600))}function a(I,A,D,E){var V=t(I,A,D);function N(){n.off(E,"mouseout",N),V&&(i(V),V=null)}var U=setInterval(function(){if(V)for(var _=E;;_=_.parentNode){if(_&&_.nodeType==11&&(_=_.host),_==document.body)return;if(!_){N();break}}if(!V)return clearInterval(U)},400);n.on(E,"mouseout",N)}function o(I,A,D){this.marked=[],this.options=A,this.timeout=null,this.hasGutter=D,this.onMouseOver=function(E){M(I,E)},this.waitingFor=0}function l(I,A){return A instanceof Function?{getAnnotations:A}:((!A||A===!0)&&(A={}),A)}function c(I){var A=I.state.lint;A.hasGutter&&I.clearGutter(e);for(var D=0;D<A.marked.length;++D)A.marked[D].clear();A.marked.length=0}function d(I,A,D,E,V){var N=document.createElement("div"),U=N;return N.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+D,E&&(U=N.appendChild(document.createElement("div")),U.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),V!=!1&&n.on(U,"mouseover",function(_){a(I,_,A,U)}),N}function p(I,A){return I=="error"?I:A}function m(I){for(var A=[],D=0;D<I.length;++D){var E=I[D],V=E.from.line;(A[V]||(A[V]=[])).push(E)}return A}function y(I){var A=I.severity;A||(A="error");var D=document.createElement("div");return D.className="CodeMirror-lint-message CodeMirror-lint-message-"+A,typeof I.messageHTML!="undefined"?D.innerHTML=I.messageHTML:D.appendChild(document.createTextNode(I.message)),D}function v(I,A,D){var E=I.state.lint,V=++E.waitingFor;function N(){V=-1,I.off("change",N)}I.on("change",N),A(I.getValue(),function(U,_){I.off("change",N),E.waitingFor==V&&(_&&U instanceof n&&(U=_),I.operation(function(){x(I,U)}))},D,I)}function b(I){var A=I.state.lint,D=A.options,E=D.options||D,V=D.getAnnotations||I.getHelper(n.Pos(0,0),"lint");if(!!V)if(D.async||V.async)v(I,V,E);else{var N=V(I.getValue(),E,I);if(!N)return;N.then?N.then(function(U){I.operation(function(){x(I,U)})}):I.operation(function(){x(I,N)})}}function x(I,A){c(I);for(var D=I.state.lint,E=D.options,V=m(A),N=0;N<V.length;++N){var U=V[N];if(!!U){for(var _=null,B=D.hasGutter&&document.createDocumentFragment(),R=0;R<U.length;++R){var X=U[R],j=X.severity;j||(j="error"),_=p(_,j),E.formatAnnotation&&(X=E.formatAnnotation(X)),D.hasGutter&&B.appendChild(y(X)),X.to&&D.marked.push(I.markText(X.from,X.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+j,__annotation:X}))}D.hasGutter&&I.setGutterMarker(N,e,d(I,B,_,U.length>1,D.options.tooltips))}}E.onUpdateLinting&&E.onUpdateLinting(A,V,I)}function C(I){var A=I.state.lint;!A||(clearTimeout(A.timeout),A.timeout=setTimeout(function(){b(I)},A.options.delay||500))}function k(I,A,D){for(var E=D.target||D.srcElement,V=document.createDocumentFragment(),N=0;N<A.length;N++){var U=A[N];V.appendChild(y(U))}a(I,D,V,E)}function M(I,A){var D=A.target||A.srcElement;if(!!/\bCodeMirror-lint-mark-/.test(D.className)){for(var E=D.getBoundingClientRect(),V=(E.left+E.right)/2,N=(E.top+E.bottom)/2,U=I.findMarksAt(I.coordsChar({left:V,top:N},"client")),_=[],B=0;B<U.length;++B){var R=U[B].__annotation;R&&_.push(R)}_.length&&k(I,_,A)}}n.defineOption("lint",!1,function(I,A,D){if(D&&D!=n.Init&&(c(I),I.state.lint.options.lintOnChange!==!1&&I.off("change",C),n.off(I.getWrapperElement(),"mouseover",I.state.lint.onMouseOver),clearTimeout(I.state.lint.timeout),delete I.state.lint),A){for(var E=I.getOption("gutters"),V=!1,N=0;N<E.length;++N)E[N]==e&&(V=!0);var U=I.state.lint=new o(I,l(I,A),V);U.options.lintOnChange!==!1&&I.on("change",C),U.options.tooltips!=!1&&U.options.tooltips!="gutter"&&n.on(I.getWrapperElement(),"mouseover",U.onMouseOver),b(I)}}),n.defineExtension("performLint",function(){this.state.lint&&b(this)})})});var F2=Ce((vke,U2)=>{U2.exports=function(n){n.defineMode("glsl",function(a,o){var l=a.indentUnit,c=o.keywords||e(t),d=o.builtins||e(r),p=o.blockKeywords||e("case do else for if switch while struct"),m=o.atoms||e("null"),y=o.hooks||{},v=o.multiLineStrings,b=/[+\-*&%=<>!?|\/]/,x;function C(E,V){var N=E.next();if(y[N]){var U=y[N](E,V);if(U!==!1)return U}if(N=='"'||N=="'")return V.tokenize=k(N),V.tokenize(E,V);if(/[\[\]{}\(\),;\:\.]/.test(N))return x=N,"bracket";if(/\d/.test(N))return E.eatWhile(/[\w\.]/),"number";if(N=="/"){if(E.eat("*"))return V.tokenize=M,M(E,V);if(E.eat("/"))return E.skipToEnd(),"comment"}if(N=="#")return E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),E.eatWhile(/[\S]+/),E.eatWhile(/[\s]+/),"comment";if(b.test(N))return E.eatWhile(b),"operator";E.eatWhile(/[\w\$_]/);var _=E.current();return c.propertyIsEnumerable(_)?(p.propertyIsEnumerable(_)&&(x="newstatement"),"keyword"):d.propertyIsEnumerable(_)?"builtin":m.propertyIsEnumerable(_)?"atom":"word"}function k(E){return function(V,N){for(var U=!1,_,B=!1;(_=V.next())!=null;){if(_==E&&!U){B=!0;break}U=!U&&_=="\\"}return(B||!(U||v))&&(N.tokenize=C),"string"}}function M(E,V){for(var N=!1,U;U=E.next();){if(U=="/"&&N){V.tokenize=C;break}N=U=="*"}return"comment"}function I(E,V,N,U,_){this.indented=E,this.column=V,this.type=N,this.align=U,this.prev=_}function A(E,V,N){return E.context=new I(E.indented,V,N,null,E.context)}function D(E){var V=E.context.type;return(V==")"||V=="]"||V=="}")&&(E.indented=E.context.indented),E.context=E.context.prev}return{startState:function(E){return{tokenize:null,context:new I((E||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(E,V){var N=V.context;if(E.sol()&&(N.align==null&&(N.align=!1),V.indented=E.indentation(),V.startOfLine=!0),E.eatSpace())return null;x=null;var U=(V.tokenize||C)(E,V);if(U=="comment"||U=="meta")return U;if(N.align==null&&(N.align=!0),(x==";"||x==":")&&N.type=="statement")D(V);else if(x=="{")A(V,E.column(),"}");else if(x=="[")A(V,E.column(),"]");else if(x=="(")A(V,E.column(),")");else if(x=="}"){for(;N.type=="statement";)N=D(V);for(N.type=="}"&&(N=D(V));N.type=="statement";)N=D(V)}else x==N.type?D(V):(N.type=="}"||N.type=="top"||N.type=="statement"&&x=="newstatement")&&A(V,E.column(),"statement");return V.startOfLine=!1,U},indent:function(E,V){if(E.tokenize!=C&&E.tokenize!=null)return 0;var N=V&&V.charAt(0),U=E.context,_=N==U.type;return U.type=="statement"?U.indented+(N=="{"?0:l):U.align?U.column+(_?0:1):U.indented+(_?0:l)},electricChars:"{}"}});function e(a){for(var o={},l=a.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",r="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function i(a,o){return o.startOfLine?(a.skipToEnd(),"meta"):!1}(function(){function a(o,l){for(var c;(c=o.next())!=null;)if(c=='"'&&!o.eat('"')){l.tokenize=null;break}return"string"}n.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(r),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":i}})})()}});var yN=Ce((mN,gN)=>{(function(n){typeof mN=="object"&&typeof gN=="object"?n(Ds()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.defineMode("javascript",function(e,t){var r=e.indentUnit,i=t.statementIndent,a=t.jsonld,o=t.json||a,l=t.typescript,c=t.wordCharacters||/[\w$\xa1-\uffff]/,d=function(){function O(gn){return{type:gn,style:"keyword"}}var H=O("keyword a"),te=O("keyword b"),q=O("keyword c"),he=O("keyword d"),pt=O("operator"),kt={type:"atom",style:"atom"};return{if:O("if"),while:H,with:H,else:te,do:te,try:te,finally:te,return:he,break:he,continue:he,new:O("new"),delete:q,void:q,throw:q,debugger:O("debugger"),var:O("var"),const:O("var"),let:O("var"),function:O("function"),catch:O("catch"),for:O("for"),switch:O("switch"),case:O("case"),default:O("default"),in:pt,typeof:pt,instanceof:pt,true:kt,false:kt,null:kt,undefined:kt,NaN:kt,Infinity:kt,this:O("this"),class:O("class"),super:O("atom"),yield:q,export:O("export"),import:O("import"),extends:q,await:q}}(),p=/[+\-*&%=<>!?|~^@]/,m=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function y(O){for(var H=!1,te,q=!1;(te=O.next())!=null;){if(!H){if(te=="/"&&!q)return;te=="["?q=!0:q&&te=="]"&&(q=!1)}H=!H&&te=="\\"}}var v,b;function x(O,H,te){return v=O,b=te,H}function C(O,H){var te=O.next();if(te=='"'||te=="'")return H.tokenize=k(te),H.tokenize(O,H);if(te=="."&&O.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return x("number","number");if(te=="."&&O.match(".."))return x("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(te))return x(te);if(te=="="&&O.eat(">"))return x("=>","operator");if(te=="0"&&O.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return x("number","number");if(/\d/.test(te))return O.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),x("number","number");if(te=="/")return O.eat("*")?(H.tokenize=M,M(O,H)):O.eat("/")?(O.skipToEnd(),x("comment","comment")):vt(O,H,1)?(y(O),O.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),x("regexp","string-2")):(O.eat("="),x("operator","operator",O.current()));if(te=="`")return H.tokenize=I,I(O,H);if(te=="#"&&O.peek()=="!")return O.skipToEnd(),x("meta","meta");if(te=="#"&&O.eatWhile(c))return x("variable","property");if(te=="<"&&O.match("!--")||te=="-"&&O.match("->")&&!/\S/.test(O.string.slice(0,O.start)))return O.skipToEnd(),x("comment","comment");if(p.test(te))return(te!=">"||!H.lexical||H.lexical.type!=">")&&(O.eat("=")?(te=="!"||te=="=")&&O.eat("="):/[<>*+\-|&?]/.test(te)&&(O.eat(te),te==">"&&O.eat(te))),te=="?"&&O.eat(".")?x("."):x("operator","operator",O.current());if(c.test(te)){O.eatWhile(c);var q=O.current();if(H.lastType!="."){if(d.propertyIsEnumerable(q)){var he=d[q];return x(he.type,he.style,q)}if(q=="async"&&O.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return x("async","keyword",q)}return x("variable","variable",q)}}function k(O){return function(H,te){var q=!1,he;if(a&&H.peek()=="@"&&H.match(m))return te.tokenize=C,x("jsonld-keyword","meta");for(;(he=H.next())!=null&&!(he==O&&!q);)q=!q&&he=="\\";return q||(te.tokenize=C),x("string","string")}}function M(O,H){for(var te=!1,q;q=O.next();){if(q=="/"&&te){H.tokenize=C;break}te=q=="*"}return x("comment","comment")}function I(O,H){for(var te=!1,q;(q=O.next())!=null;){if(!te&&(q=="`"||q=="$"&&O.eat("{"))){H.tokenize=C;break}te=!te&&q=="\\"}return x("quasi","string-2",O.current())}var A="([{}])";function D(O,H){H.fatArrowAt&&(H.fatArrowAt=null);var te=O.string.indexOf("=>",O.start);if(!(te<0)){if(l){var q=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(O.string.slice(O.start,te));q&&(te=q.index)}for(var he=0,pt=!1,kt=te-1;kt>=0;--kt){var gn=O.string.charAt(kt),vr=A.indexOf(gn);if(vr>=0&&vr<3){if(!he){++kt;break}if(--he==0){gn=="("&&(pt=!0);break}}else if(vr>=3&&vr<6)++he;else if(c.test(gn))pt=!0;else if(/["'\/`]/.test(gn))for(;;--kt){if(kt==0)return;var Nf=O.string.charAt(kt-1);if(Nf==gn&&O.string.charAt(kt-2)!="\\"){kt--;break}}else if(pt&&!he){++kt;break}}pt&&!he&&(H.fatArrowAt=kt)}}var E={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,"jsonld-keyword":!0};function V(O,H,te,q,he,pt){this.indented=O,this.column=H,this.type=te,this.prev=he,this.info=pt,q!=null&&(this.align=q)}function N(O,H){for(var te=O.localVars;te;te=te.next)if(te.name==H)return!0;for(var q=O.context;q;q=q.prev)for(var te=q.vars;te;te=te.next)if(te.name==H)return!0}function U(O,H,te,q,he){var pt=O.cc;for(_.state=O,_.stream=he,_.marked=null,_.cc=pt,_.style=H,O.lexical.hasOwnProperty("align")||(O.lexical.align=!0);;){var kt=pt.length?pt.pop():o?Ae:ht;if(kt(te,q)){for(;pt.length&&pt[pt.length-1].lex;)pt.pop()();return _.marked?_.marked:te=="variable"&&N(O,q)?"variable-2":H}}}var _={state:null,column:null,marked:null,cc:null};function B(){for(var O=arguments.length-1;O>=0;O--)_.cc.push(arguments[O])}function R(){return B.apply(null,arguments),!0}function X(O,H){for(var te=H;te;te=te.next)if(te.name==O)return!0;return!1}function j(O){var H=_.state;if(_.marked="def",H.context){if(H.lexical.info=="var"&&H.context&&H.context.block){var te=oe(O,H.context);if(te!=null){H.context=te;return}}else if(!X(O,H.localVars)){H.localVars=new se(O,H.localVars);return}}t.globalVars&&!X(O,H.globalVars)&&(H.globalVars=new se(O,H.globalVars))}function oe(O,H){if(H)if(H.block){var te=oe(O,H.prev);return te?te==H.prev?H:new xe(te,H.vars,!0):null}else return X(O,H.vars)?H:new xe(H.prev,new se(O,H.vars),!1);else return null}function me(O){return O=="public"||O=="private"||O=="protected"||O=="abstract"||O=="readonly"}function xe(O,H,te){this.prev=O,this.vars=H,this.block=te}function se(O,H){this.name=O,this.next=H}var Se=new se("this",new se("arguments",null));function Ie(){_.state.context=new xe(_.state.context,_.state.localVars,!1),_.state.localVars=Se}function je(){_.state.context=new xe(_.state.context,_.state.localVars,!0),_.state.localVars=null}function Be(){_.state.localVars=_.state.context.vars,_.state.context=_.state.context.prev}Be.lex=!0;function Pe(O,H){var te=function(){var q=_.state,he=q.indented;if(q.lexical.type=="stat")he=q.lexical.indented;else for(var pt=q.lexical;pt&&pt.type==")"&&pt.align;pt=pt.prev)he=pt.indented;q.lexical=new V(he,_.stream.column(),O,null,q.lexical,H)};return te.lex=!0,te}function ge(){var O=_.state;O.lexical.prev&&(O.lexical.type==")"&&(O.indented=O.lexical.indented),O.lexical=O.lexical.prev)}ge.lex=!0;function $e(O){function H(te){return te==O?R():O==";"||te=="}"||te==")"||te=="]"?B():R(H)}return H}function ht(O,H){return O=="var"?R(Pe("vardef",H),Bs,$e(";"),ge):O=="keyword a"?R(Pe("form"),qt,ht,ge):O=="keyword b"?R(Pe("form"),ht,ge):O=="keyword d"?_.stream.match(/^\s*$/,!1)?R():R(Pe("stat"),Bn,$e(";"),ge):O=="debugger"?R($e(";")):O=="{"?R(Pe("}"),je,bt,ge,Be):O==";"?R():O=="if"?(_.state.lexical.info=="else"&&_.state.cc[_.state.cc.length-1]==ge&&_.state.cc.pop()(),R(Pe("form"),qt,ht,ge,Vf)):O=="function"?R(ca):O=="for"?R(Pe("form"),ec,ht,ge):O=="class"||l&&H=="interface"?(_.marked="keyword",R(Pe("form",O=="class"?O:H),za,ge)):O=="variable"?l&&H=="declare"?(_.marked="keyword",R(ht)):l&&(H=="module"||H=="enum"||H=="type")&&_.stream.match(/^\s*\w/,!1)?(_.marked="keyword",H=="enum"?R(ua):H=="type"?R(tc,$e("operator"),nt,$e(";")):R(Pe("form"),zn,$e("{"),Pe("}"),bt,ge,ge)):l&&H=="namespace"?(_.marked="keyword",R(Pe("form"),Ae,ht,ge)):l&&H=="abstract"?(_.marked="keyword",R(ht)):R(Pe("stat"),Re):O=="switch"?R(Pe("form"),qt,$e("{"),Pe("}","switch"),je,bt,ge,ge,Be):O=="case"?R(Ae,$e(":")):O=="default"?R($e(":")):O=="catch"?R(Pe("form"),Ie,Dt,ht,ge,Be):O=="export"?R(Pe("stat"),Fu,ge):O=="import"?R(Pe("stat"),vv,ge):O=="async"?R(ht):H=="@"?R(Ae,ht):B(Pe("stat"),Ae,$e(";"),ge)}function Dt(O){if(O=="(")return R(Wa,$e(")"))}function Ae(O,H){return Me(O,H,!1)}function Xe(O,H){return Me(O,H,!0)}function qt(O){return O!="("?B():R(Pe(")"),Bn,$e(")"),ge)}function Me(O,H,te){if(_.state.fatArrowAt==_.stream.start){var q=te?oa:_r;if(O=="(")return R(Ie,Pe(")"),ot(Wa,")"),ge,$e("=>"),q,Be);if(O=="variable")return B(Ie,zn,$e("=>"),q,Be)}var he=te?ln:Oe;return E.hasOwnProperty(O)?R(he):O=="function"?R(ca,he):O=="class"||l&&H=="interface"?(_.marked="keyword",R(Pe("form"),Uu,ge)):O=="keyword c"||O=="async"?R(te?Xe:Ae):O=="("?R(Pe(")"),Bn,$e(")"),ge,he):O=="operator"||O=="spread"?R(te?Xe:Ae):O=="["?R(Pe("]"),_e,ge,he):O=="{"?Qe(tt,"}",null,he):O=="quasi"?B(pi,he):O=="new"?R(le(te)):O=="import"?R(Ae):R()}function Bn(O){return O.match(/[;\}\)\],]/)?B():B(Ae)}function Oe(O,H){return O==","?R(Bn):ln(O,H,!1)}function ln(O,H,te){var q=te==!1?Oe:ln,he=te==!1?Ae:Xe;if(O=="=>")return R(Ie,te?oa:_r,Be);if(O=="operator")return/\+\+|--/.test(H)||l&&H=="!"?R(q):l&&H=="<"&&_.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?R(Pe(">"),ot(nt,">"),ge,q):H=="?"?R(Ae,$e(":"),he):R(he);if(O=="quasi")return B(pi,q);if(O!=";"){if(O=="(")return Qe(Xe,")","call",q);if(O==".")return R(Ne,q);if(O=="[")return R(Pe("]"),Bn,$e("]"),ge,q);if(l&&H=="as")return _.marked="keyword",R(nt,q);if(O=="regexp")return _.state.lastType=_.marked="operator",_.stream.backUp(_.stream.pos-_.stream.start-1),R(he)}}function pi(O,H){return O!="quasi"?B():H.slice(H.length-2)!="${"?R(pi):R(Ae,aa)}function aa(O){if(O=="}")return _.marked="string-2",_.state.tokenize=I,R(pi)}function _r(O){return D(_.stream,_.state),B(O=="{"?ht:Ae)}function oa(O){return D(_.stream,_.state),B(O=="{"?ht:Xe)}function le(O){return function(H){return H=="."?R(O?fe:ke):H=="variable"&&l?R(Oo,O?ln:Oe):B(O?Xe:Ae)}}function ke(O,H){if(H=="target")return _.marked="keyword",R(Oe)}function fe(O,H){if(H=="target")return _.marked="keyword",R(ln)}function Re(O){return O==":"?R(ge,ht):B(Oe,$e(";"),ge)}function Ne(O){if(O=="variable")return _.marked="property",R()}function tt(O,H){if(O=="async")return _.marked="property",R(tt);if(O=="variable"||_.style=="keyword"){if(_.marked="property",H=="get"||H=="set")return R(ce);var te;return l&&_.state.fatArrowAt==_.stream.start&&(te=_.stream.match(/^\s*:\s*/,!1))&&(_.state.fatArrowAt=_.stream.pos+te[0].length),R(De)}else{if(O=="number"||O=="string")return _.marked=a?"property":_.style+" property",R(De);if(O=="jsonld-keyword")return R(De);if(l&&me(H))return _.marked="keyword",R(tt);if(O=="[")return R(Ae,Jt,$e("]"),De);if(O=="spread")return R(Xe,De);if(H=="*")return _.marked="keyword",R(tt);if(O==":")return B(De)}}function ce(O){return O!="variable"?B(De):(_.marked="property",R(ca))}function De(O){if(O==":")return R(Xe);if(O=="(")return B(ca)}function ot(O,H,te){function q(he,pt){if(te?te.indexOf(he)>-1:he==","){var kt=_.state.lexical;return kt.info=="call"&&(kt.pos=(kt.pos||0)+1),R(function(gn,vr){return gn==H||vr==H?B():B(O)},q)}return he==H||pt==H?R():te&&te.indexOf(";")>-1?B(O):R($e(H))}return function(he,pt){return he==H||pt==H?R():B(O,q)}}function Qe(O,H,te){for(var q=3;q<arguments.length;q++)_.cc.push(arguments[q]);return R(Pe(H,te),ot(O,H),ge)}function bt(O){return O=="}"?R():B(ht,bt)}function Jt(O,H){if(l){if(O==":")return R(nt);if(H=="?")return R(Jt)}}function Vr(O,H){if(l&&(O==":"||H=="in"))return R(nt)}function be(O){if(l&&O==":")return _.stream.match(/^\s*\w+\s+is\b/,!1)?R(Ae,yr,nt):R(nt)}function yr(O,H){if(H=="is")return _.marked="keyword",R()}function nt(O,H){if(H=="keyof"||H=="typeof"||H=="infer")return _.marked="keyword",R(H=="typeof"?Xe:nt);if(O=="variable"||H=="void")return _.marked="type",R(un);if(H=="|"||H=="&")return R(nt);if(O=="string"||O=="number"||O=="atom")return R(un);if(O=="[")return R(Pe("]"),ot(nt,"]",","),ge,un);if(O=="{")return R(Pe("}"),ot(Ot,"}",",;"),ge,un);if(O=="(")return R(ot(Ql,")"),Wt,un);if(O=="<")return R(ot(nt,">"),nt)}function Wt(O){if(O=="=>")return R(nt)}function Ot(O,H){if(O=="variable"||_.style=="keyword")return _.marked="property",R(Ot);if(H=="?"||O=="number"||O=="string")return R(Ot);if(O==":")return R(nt);if(O=="[")return R($e("variable"),Vr,$e("]"),Ot);if(O=="(")return B(No,Ot)}function Ql(O,H){return O=="variable"&&_.stream.match(/^\s*[?:]/,!1)||H=="?"?R(Ql):O==":"?R(nt):O=="spread"?R(Ql):B(nt)}function un(O,H){if(H=="<")return R(Pe(">"),ot(nt,">"),ge,un);if(H=="|"||O=="."||H=="&")return R(nt);if(O=="[")return R(nt,$e("]"),un);if(H=="extends"||H=="implements")return _.marked="keyword",R(nt);if(H=="?")return R(nt,$e(":"),nt)}function Oo(O,H){if(H=="<")return R(Pe(">"),ot(nt,">"),ge,un)}function mn(){return B(nt,Rf)}function Rf(O,H){if(H=="=")return R(nt)}function Bs(O,H){return H=="enum"?(_.marked="keyword",R(ua)):B(zn,Jt,sa,Bu)}function zn(O,H){if(l&&me(H))return _.marked="keyword",R(zn);if(O=="variable")return j(H),R();if(O=="spread")return R(zn);if(O=="[")return Qe(_f,"]");if(O=="{")return Qe(Zl,"}")}function Zl(O,H){return O=="variable"&&!_.stream.match(/^\s*:/,!1)?(j(H),R(sa)):(O=="variable"&&(_.marked="property"),O=="spread"?R(zn):O=="}"?B():O=="["?R(Ae,$e("]"),$e(":"),Zl):R($e(":"),zn,sa))}function _f(){return B(zn,sa)}function sa(O,H){if(H=="=")return R(Xe)}function Bu(O){if(O==",")return R(Bs)}function Vf(O,H){if(O=="keyword b"&&H=="else")return R(Pe("form","else"),ht,ge)}function ec(O,H){if(H=="await")return R(ec);if(O=="(")return R(Pe(")"),yv,ge)}function yv(O){return O=="var"?R(Bs,la):O=="variable"?R(la):B(la)}function la(O,H){return O==")"?R():O==";"?R(la):H=="in"||H=="of"?(_.marked="keyword",R(Ae,la)):B(Ae,la)}function ca(O,H){if(H=="*")return _.marked="keyword",R(ca);if(O=="variable")return j(H),R(ca);if(O=="(")return R(Ie,Pe(")"),ot(Wa,")"),ge,be,ht,Be);if(l&&H=="<")return R(Pe(">"),ot(mn,">"),ge,ca)}function No(O,H){if(H=="*")return _.marked="keyword",R(No);if(O=="variable")return j(H),R(No);if(O=="(")return R(Ie,Pe(")"),ot(Wa,")"),ge,be,Be);if(l&&H=="<")return R(Pe(">"),ot(mn,">"),ge,No)}function tc(O,H){if(O=="keyword"||O=="variable")return _.marked="type",R(tc);if(H=="<")return R(Pe(">"),ot(mn,">"),ge)}function Wa(O,H){return H=="@"&&R(Ae,Wa),O=="spread"?R(Wa):l&&me(H)?(_.marked="keyword",R(Wa)):l&&O=="this"?R(Jt,sa):B(zn,Jt,sa)}function Uu(O,H){return O=="variable"?za(O,H):nc(O,H)}function za(O,H){if(O=="variable")return j(H),R(nc)}function nc(O,H){if(H=="<")return R(Pe(">"),ot(mn,">"),ge,nc);if(H=="extends"||H=="implements"||l&&O==",")return H=="implements"&&(_.marked="keyword"),R(l?nt:Ae,nc);if(O=="{")return R(Pe("}"),Ai,ge)}function Ai(O,H){if(O=="async"||O=="variable"&&(H=="static"||H=="get"||H=="set"||l&&me(H))&&_.stream.match(/^\s+[\w$\xa1-\uffff]/,!1))return _.marked="keyword",R(Ai);if(O=="variable"||_.style=="keyword")return _.marked="property",R(Ha,Ai);if(O=="number"||O=="string")return R(Ha,Ai);if(O=="[")return R(Ae,Jt,$e("]"),Ha,Ai);if(H=="*")return _.marked="keyword",R(Ai);if(l&&O=="(")return B(No,Ai);if(O==";"||O==",")return R(Ai);if(O=="}")return R();if(H=="@")return R(Ae,Ai)}function Ha(O,H){if(H=="?")return R(Ha);if(O==":")return R(nt,sa);if(H=="=")return R(Xe);var te=_.state.lexical.prev,q=te&&te.info=="interface";return B(q?No:ca)}function Fu(O,H){return H=="*"?(_.marked="keyword",R(Yt,$e(";"))):H=="default"?(_.marked="keyword",R(Ae,$e(";"))):O=="{"?R(ot($a,"}"),Yt,$e(";")):B(ht)}function $a(O,H){if(H=="as")return _.marked="keyword",R($e("variable"));if(O=="variable")return B(Xe,$a)}function vv(O){return O=="string"?R():O=="("?B(Ae):B(fi,rc,Yt)}function fi(O,H){return O=="{"?Qe(fi,"}"):(O=="variable"&&j(H),H=="*"&&(_.marked="keyword"),R(Of))}function rc(O){if(O==",")return R(fi,rc)}function Of(O,H){if(H=="as")return _.marked="keyword",R(fi)}function Yt(O,H){if(H=="from")return _.marked="keyword",R(Ae)}function _e(O){return O=="]"?R():B(ot(Xe,"]"))}function ua(){return B(Pe("form"),zn,$e("{"),Pe("}"),ot(Gu,"}"),ge,ge)}function Gu(){return B(zn,sa)}function hi(O,H){return O.lastType=="operator"||O.lastType==","||p.test(H.charAt(0))||/[,.]/.test(H.charAt(0))}function vt(O,H,te){return H.tokenize==C&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(H.lastType)||H.lastType=="quasi"&&/\{\s*$/.test(O.string.slice(0,O.pos-(te||0)))}return{startState:function(O){var H={tokenize:C,lastType:"sof",cc:[],lexical:new V((O||0)-r,0,"block",!1),localVars:t.localVars,context:t.localVars&&new xe(null,null,!1),indented:O||0};return t.globalVars&&typeof t.globalVars=="object"&&(H.globalVars=t.globalVars),H},token:function(O,H){if(O.sol()&&(H.lexical.hasOwnProperty("align")||(H.lexical.align=!1),H.indented=O.indentation(),D(O,H)),H.tokenize!=M&&O.eatSpace())return null;var te=H.tokenize(O,H);return v=="comment"?te:(H.lastType=v=="operator"&&(b=="++"||b=="--")?"incdec":v,U(H,te,v,b,O))},indent:function(O,H){if(O.tokenize==M||O.tokenize==I)return n.Pass;if(O.tokenize!=C)return 0;var te=H&&H.charAt(0),q=O.lexical,he;if(!/^\s*else\b/.test(H))for(var pt=O.cc.length-1;pt>=0;--pt){var kt=O.cc[pt];if(kt==ge)q=q.prev;else if(kt!=Vf)break}for(;(q.type=="stat"||q.type=="form")&&(te=="}"||(he=O.cc[O.cc.length-1])&&(he==Oe||he==ln)&&!/^[,\.=+\-*:?[\(]/.test(H));)q=q.prev;i&&q.type==")"&&q.prev.type=="stat"&&(q=q.prev);var gn=q.type,vr=te==gn;return gn=="vardef"?q.indented+(O.lastType=="operator"||O.lastType==","?q.info.length+1:0):gn=="form"&&te=="{"?q.indented:gn=="form"?q.indented+r:gn=="stat"?q.indented+(hi(O,H)?i||r:0):q.info=="switch"&&!vr&&t.doubleIndentSwitch!=!1?q.indented+(/^(?:case|default)\b/.test(H)?r:2*r):q.align?q.column+(vr?0:1):q.indented+(vr?0:r)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:o?null:"/*",blockCommentEnd:o?null:"*/",blockCommentContinue:o?null:" * ",lineComment:o?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:o?"json":"javascript",jsonldMode:a,jsonMode:o,expressionAllowed:vt,skipExpression:function(O){var H=O.cc[O.cc.length-1];(H==Ae||H==Xe)&&O.cc.pop()}}}),n.registerHelper("wordChars","javascript",/[\w$]/),n.defineMIME("text/javascript","javascript"),n.defineMIME("text/ecmascript","javascript"),n.defineMIME("application/javascript","javascript"),n.defineMIME("application/x-javascript","javascript"),n.defineMIME("application/ecmascript","javascript"),n.defineMIME("application/json",{name:"javascript",json:!0}),n.defineMIME("application/x-json",{name:"javascript",json:!0}),n.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),n.defineMIME("text/typescript",{name:"javascript",typescript:!0}),n.defineMIME("application/typescript",{name:"javascript",typescript:!0})})});var K0=Ce((vN,SN)=>{(function(n){typeof vN=="object"&&typeof SN=="object"?n(Ds()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";function e(a,o,l,c){if(l&&l.call){var d=l;l=null}else var d=i(a,l,"rangeFinder");typeof o=="number"&&(o=n.Pos(o,0));var p=i(a,l,"minFoldSize");function m(x){var C=d(a,o);if(!C||C.to.line-C.from.line<p)return null;for(var k=a.findMarksAt(C.from),M=0;M<k.length;++M)if(k[M].__isFold&&c!=="fold"){if(!x)return null;C.cleared=!0,k[M].clear()}return C}var y=m(!0);if(i(a,l,"scanUp"))for(;!y&&o.line>a.firstLine();)o=n.Pos(o.line-1,0),y=m(!1);if(!(!y||y.cleared||c==="unfold")){var v=t(a,l,y);n.on(v,"mousedown",function(x){b.clear(),n.e_preventDefault(x)});var b=a.markText(y.from,y.to,{replacedWith:v,clearOnEnter:i(a,l,"clearOnEnter"),__isFold:!0});b.on("clear",function(x,C){n.signal(a,"unfold",a,x,C)}),n.signal(a,"fold",a,y.from,y.to)}}function t(a,o,l){var c=i(a,o,"widget");if(typeof c=="function"&&(c=c(l.from,l.to)),typeof c=="string"){var d=document.createTextNode(c);c=document.createElement("span"),c.appendChild(d),c.className="CodeMirror-foldmarker"}else c&&(c=c.cloneNode(!0));return c}n.newFoldFunction=function(a,o){return function(l,c){e(l,c,{rangeFinder:a,widget:o})}},n.defineExtension("foldCode",function(a,o,l){e(this,a,o,l)}),n.defineExtension("isFolded",function(a){for(var o=this.findMarksAt(a),l=0;l<o.length;++l)if(o[l].__isFold)return!0}),n.commands.toggleFold=function(a){a.foldCode(a.getCursor())},n.commands.fold=function(a){a.foldCode(a.getCursor(),null,"fold")},n.commands.unfold=function(a){a.foldCode(a.getCursor(),null,"unfold")},n.commands.foldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"fold")})},n.commands.unfoldAll=function(a){a.operation(function(){for(var o=a.firstLine(),l=a.lastLine();o<=l;o++)a.foldCode(n.Pos(o,0),null,"unfold")})},n.registerHelper("fold","combine",function(){var a=Array.prototype.slice.call(arguments,0);return function(o,l){for(var c=0;c<a.length;++c){var d=a[c](o,l);if(d)return d}}}),n.registerHelper("fold","auto",function(a,o){for(var l=a.getHelpers(o,"fold"),c=0;c<l.length;c++){var d=l[c](a,o);if(d)return d}});var r={rangeFinder:n.fold.auto,widget:"\u2194",minFoldSize:0,scanUp:!1,clearOnEnter:!0};n.defineOption("foldOptions",null);function i(a,o,l){if(o&&o[l]!==void 0)return o[l];var c=a.options.foldOptions;return c&&c[l]!==void 0?c[l]:r[l]}n.defineExtension("foldOption",function(a,o){return i(this,a,o)})})});var CN=Ce((bN,xN)=>{(function(n){typeof bN=="object"&&typeof xN=="object"?n(Ds(),K0()):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./foldcode"],n):n(CodeMirror)})(function(n){"use strict";n.defineOption("foldGutter",!1,function(v,b,x){x&&x!=n.Init&&(v.clearGutter(v.state.foldGutter.options.gutter),v.state.foldGutter=null,v.off("gutterClick",d),v.off("changes",p),v.off("viewportChange",m),v.off("fold",y),v.off("unfold",y),v.off("swapDoc",p)),b&&(v.state.foldGutter=new t(r(b)),c(v),v.on("gutterClick",d),v.on("changes",p),v.on("viewportChange",m),v.on("fold",y),v.on("unfold",y),v.on("swapDoc",p))});var e=n.Pos;function t(v){this.options=v,this.from=this.to=0}function r(v){return v===!0&&(v={}),v.gutter==null&&(v.gutter="CodeMirror-foldgutter"),v.indicatorOpen==null&&(v.indicatorOpen="CodeMirror-foldgutter-open"),v.indicatorFolded==null&&(v.indicatorFolded="CodeMirror-foldgutter-folded"),v}function i(v,b){for(var x=v.findMarks(e(b,0),e(b+1,0)),C=0;C<x.length;++C)if(x[C].__isFold){var k=x[C].find(-1);if(k&&k.line===b)return x[C]}}function a(v){if(typeof v=="string"){var b=document.createElement("div");return b.className=v+" CodeMirror-guttermarker-subtle",b}else return v.cloneNode(!0)}function o(v,b,x){var C=v.state.foldGutter.options,k=b-1,M=v.foldOption(C,"minFoldSize"),I=v.foldOption(C,"rangeFinder"),A=typeof C.indicatorFolded=="string"&&l(C.indicatorFolded),D=typeof C.indicatorOpen=="string"&&l(C.indicatorOpen);v.eachLine(b,x,function(E){++k;var V=null,N=E.gutterMarkers;if(N&&(N=N[C.gutter]),i(v,k)){if(A&&N&&A.test(N.className))return;V=a(C.indicatorFolded)}else{var U=e(k,0),_=I&&I(v,U);if(_&&_.to.line-_.from.line>=M){if(D&&N&&D.test(N.className))return;V=a(C.indicatorOpen)}}!V&&!N||v.setGutterMarker(E,C.gutter,V)})}function l(v){return new RegExp("(^|\\s)"+v+"(?:$|\\s)\\s*")}function c(v){var b=v.getViewport(),x=v.state.foldGutter;!x||(v.operation(function(){o(v,b.from,b.to)}),x.from=b.from,x.to=b.to)}function d(v,b,x){var C=v.state.foldGutter;if(!!C){var k=C.options;if(x==k.gutter){var M=i(v,b);M?M.clear():v.foldCode(e(b,0),k)}}}function p(v){var b=v.state.foldGutter;if(!!b){var x=b.options;b.from=b.to=0,clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){c(v)},x.foldOnChangeTimeSpan||600)}}function m(v){var b=v.state.foldGutter;if(!!b){var x=b.options;clearTimeout(b.changeUpdate),b.changeUpdate=setTimeout(function(){var C=v.getViewport();b.from==b.to||C.from-b.to>20||b.from-C.to>20?c(v):v.operation(function(){C.from<b.from&&(o(v,C.from,b.from),b.from=C.from),C.to>b.to&&(o(v,b.to,C.to),b.to=C.to)})},x.updateViewportTimeSpan||400)}}function y(v,b){var x=v.state.foldGutter;if(!!x){var C=b.line;C>=x.from&&C<x.to&&o(v,C,C+1)}}})});var kN=Ce((wN,TN)=>{(function(n){typeof wN=="object"&&typeof TN=="object"?n(Ds()):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],n):n(CodeMirror)})(function(n){"use strict";n.registerHelper("fold","brace",function(e,t){var r=t.line,i=e.getLine(r),a;function o(I){for(var A=t.ch,D=0;;){var E=A<=0?-1:i.lastIndexOf(I,A-1);if(E==-1){if(D==1)break;D=1,A=i.length;continue}if(D==1&&E<t.ch)break;if(a=e.getTokenTypeAt(n.Pos(r,E+1)),!/^(comment|string)/.test(a))return E+1;A=E-1}}var l="{",c="}",d=o("{");if(d==null&&(l="[",c="]",d=o("[")),d==null)return;var p=1,m=e.lastLine(),y,v;e:for(var b=r;b<=m;++b)for(var x=e.getLine(b),C=b==r?d:0;;){var k=x.indexOf(l,C),M=x.indexOf(c,C);if(k<0&&(k=x.length),M<0&&(M=x.length),C=Math.min(k,M),C==x.length)break;if(e.getTokenTypeAt(n.Pos(b,C+1))==a){if(C==k)++p;else if(!--p){y=b,v=C;break e}}++C}if(!(y==null||r==y))return{from:n.Pos(r,d),to:n.Pos(y,v)}}),n.registerHelper("fold","import",function(e,t){function r(d){if(d<e.firstLine()||d>e.lastLine())return null;var p=e.getTokenAt(n.Pos(d,1));if(/\S/.test(p.string)||(p=e.getTokenAt(n.Pos(d,p.end+1))),p.type!="keyword"||p.string!="import")return null;for(var m=d,y=Math.min(e.lastLine(),d+10);m<=y;++m){var v=e.getLine(m),b=v.indexOf(";");if(b!=-1)return{startCh:p.end,end:n.Pos(m,b)}}}var i=t.line,a=r(i),o;if(!a||r(i-1)||(o=r(i-2))&&o.end.line==i-1)return null;for(var l=a.end;;){var c=r(l.line+1);if(c==null)break;l=c.end}return{from:e.clipPos(n.Pos(i,a.startCh+1)),to:l}}),n.registerHelper("fold","include",function(e,t){function r(c){if(c<e.firstLine()||c>e.lastLine())return null;var d=e.getTokenAt(n.Pos(c,1));if(/\S/.test(d.string)||(d=e.getTokenAt(n.Pos(c,d.end+1))),d.type=="meta"&&d.string.slice(0,8)=="#include")return d.start+8}var i=t.line,a=r(i);if(a==null||r(i-1)!=null)return null;for(var o=i;;){var l=r(o+1);if(l==null)break;++o}return{from:n.Pos(i,a+1),to:e.clipPos(n.Pos(o))}})})});var GN=Ce((XBe,dT)=>{"use strict";window.crypto&&window.crypto.getRandomValues?dT.exports.randomBytes=function(n){var e=new Uint8Array(n);return window.crypto.getRandomValues(e),e}:dT.exports.randomBytes=function(n){for(var e=new Array(n),t=0;t<n;t++)e[t]=Math.floor(Math.random()*256);return e}});var Hl=Ce((QBe,zN)=>{"use strict";var IY=GN(),WN="abcdefghijklmnopqrstuvwxyz012345";zN.exports={string:function(n){for(var e=WN.length,t=IY.randomBytes(n),r=[],i=0;i<n;i++)r.push(WN.substr(t[i]%e,1));return r.join("")},number:function(n){return Math.floor(Math.random()*n)},numberString:function(n){var e=(""+(n-1)).length,t=new Array(e+1).join("0");return(t+this.number(n)).slice(-e)}}});var Do=Ce((ZBe,zy)=>{"use strict";var AY=Hl(),Pu={},pT=!1,HN=window.chrome&&window.chrome.app&&window.chrome.app.runtime;zy.exports={attachEvent:function(n,e){typeof window.addEventListener!="undefined"?window.addEventListener(n,e,!1):window.document&&window.attachEvent&&(window.document.attachEvent("on"+n,e),window.attachEvent("on"+n,e))},detachEvent:function(n,e){typeof window.addEventListener!="undefined"?window.removeEventListener(n,e,!1):window.document&&window.detachEvent&&(window.document.detachEvent("on"+n,e),window.detachEvent("on"+n,e))},unloadAdd:function(n){if(HN)return null;var e=AY.string(8);return Pu[e]=n,pT&&setTimeout(this.triggerUnloadCallbacks,0),e},unloadDel:function(n){n in Pu&&delete Pu[n]},triggerUnloadCallbacks:function(){for(var n in Pu)Pu[n](),delete Pu[n]}};var MY=function(){pT||(pT=!0,zy.exports.triggerUnloadCallbacks())};HN||zy.exports.attachEvent("unload",MY)});var jN=Ce((eUe,$N)=>{"use strict";$N.exports=function(e,t){if(t=t.split(":")[0],e=+e,!e)return!1;switch(t){case"http":case"ws":return e!==80;case"https":case"wss":return e!==443;case"ftp":return e!==21;case"gopher":return e!==70;case"file":return!1}return e!==0}});var YN=Ce(fT=>{"use strict";var RY=Object.prototype.hasOwnProperty,_Y;function qN(n){try{return decodeURIComponent(n.replace(/\+/g," "))}catch(e){return null}}function JN(n){try{return encodeURIComponent(n)}catch(e){return null}}function VY(n){for(var e=/([^=?#&]+)=?([^&]*)/g,t={},r;r=e.exec(n);){var i=qN(r[1]),a=qN(r[2]);i===null||a===null||i in t||(t[i]=a)}return t}function OY(n,e){e=e||"";var t=[],r,i;typeof e!="string"&&(e="?");for(i in n)if(RY.call(n,i)){if(r=n[i],!r&&(r===null||r===_Y||isNaN(r))&&(r=""),i=JN(i),r=JN(r),i===null||r===null)continue;t.push(i+"="+r)}return t.length?e+t.join("&"):""}fT.stringify=OY;fT.parse=VY});var gT=Ce((nUe,eB)=>{"use strict";var KN=jN(),Hy=YN(),NY=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//,BY=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\S\s]*)/i,UY="[\\x09\\x0A\\x0B\\x0C\\x0D\\x20\\xA0\\u1680\\u180E\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200A\\u202F\\u205F\\u3000\\u2028\\u2029\\uFEFF]",FY=new RegExp("^"+UY+"+");function hT(n){return(n||"").toString().replace(FY,"")}var mT=[["#","hash"],["?","query"],function(e){return e.replace("\\","/")},["/","pathname"],["@","auth",1],[NaN,"host",void 0,1,1],[/:(\d+)$/,"port",void 0,1],[NaN,"hostname",void 0,1,1]],XN={hash:1,query:1};function QN(n){var e;typeof window!="undefined"||typeof window!="undefined"?e=window:typeof self!="undefined"?e=self:e={};var t=e.location||{};n=n||t;var r={},i=typeof n,a;if(n.protocol==="blob:")r=new Na(unescape(n.pathname),{});else if(i==="string"){r=new Na(n,{});for(a in XN)delete r[a]}else if(i==="object"){for(a in n)a in XN||(r[a]=n[a]);r.slashes===void 0&&(r.slashes=NY.test(n.href))}return r}function ZN(n){n=hT(n);var e=BY.exec(n);return{protocol:e[1]?e[1].toLowerCase():"",slashes:!!e[2],rest:e[3]}}function GY(n,e){if(n==="")return e;for(var t=(e||"/").split("/").slice(0,-1).concat(n.split("/")),r=t.length,i=t[r-1],a=!1,o=0;r--;)t[r]==="."?t.splice(r,1):t[r]===".."?(t.splice(r,1),o++):o&&(r===0&&(a=!0),t.splice(r,1),o--);return a&&t.unshift(""),(i==="."||i==="..")&&t.push(""),t.join("/")}function Na(n,e,t){if(n=hT(n),!(this instanceof Na))return new Na(n,e,t);var r,i,a,o,l,c,d=mT.slice(),p=typeof e,m=this,y=0;for(p!=="object"&&p!=="string"&&(t=e,e=null),t&&typeof t!="function"&&(t=Hy.parse),e=QN(e),i=ZN(n||""),r=!i.protocol&&!i.slashes,m.slashes=i.slashes||r&&e.slashes,m.protocol=i.protocol||e.protocol||"",n=i.rest,i.slashes||(d[3]=[/(.*)/,"pathname"]);y<d.length;y++){if(o=d[y],typeof o=="function"){n=o(n);continue}a=o[0],c=o[1],a!==a?m[c]=n:typeof a=="string"?~(l=n.indexOf(a))&&(typeof o[2]=="number"?(m[c]=n.slice(0,l),n=n.slice(l+o[2])):(m[c]=n.slice(l),n=n.slice(0,l))):(l=a.exec(n))&&(m[c]=l[1],n=n.slice(0,l.index)),m[c]=m[c]||r&&o[3]&&e[c]||"",o[4]&&(m[c]=m[c].toLowerCase())}t&&(m.query=t(m.query)),r&&e.slashes&&m.pathname.charAt(0)!=="/"&&(m.pathname!==""||e.pathname!=="")&&(m.pathname=GY(m.pathname,e.pathname)),KN(m.port,m.protocol)||(m.host=m.hostname,m.port=""),m.username=m.password="",m.auth&&(o=m.auth.split(":"),m.username=o[0]||"",m.password=o[1]||""),m.origin=m.protocol&&m.host&&m.protocol!=="file:"?m.protocol+"//"+m.host:"null",m.href=m.toString()}function WY(n,e,t){var r=this;switch(n){case"query":typeof e=="string"&&e.length&&(e=(t||Hy.parse)(e)),r[n]=e;break;case"port":r[n]=e,KN(e,r.protocol)?e&&(r.host=r.hostname+":"+e):(r.host=r.hostname,r[n]="");break;case"hostname":r[n]=e,r.port&&(e+=":"+r.port),r.host=e;break;case"host":r[n]=e,/:\d+$/.test(e)?(e=e.split(":"),r.port=e.pop(),r.hostname=e.join(":")):(r.hostname=e,r.port="");break;case"protocol":r.protocol=e.toLowerCase(),r.slashes=!t;break;case"pathname":case"hash":if(e){var i=n==="pathname"?"/":"#";r[n]=e.charAt(0)!==i?i+e:e}else r[n]=e;break;default:r[n]=e}for(var a=0;a<mT.length;a++){var o=mT[a];o[4]&&(r[o[1]]=r[o[1]].toLowerCase())}return r.origin=r.protocol&&r.host&&r.protocol!=="file:"?r.protocol+"//"+r.host:"null",r.href=r.toString(),r}function zY(n){(!n||typeof n!="function")&&(n=Hy.stringify);var e,t=this,r=t.protocol;r&&r.charAt(r.length-1)!==":"&&(r+=":");var i=r+(t.slashes?"//":"");return t.username&&(i+=t.username,t.password&&(i+=":"+t.password),i+="@"),i+=t.host+t.pathname,e=typeof t.query=="object"?n(t.query):t.query,e&&(i+=e.charAt(0)!=="?"?"?"+e:e),t.hash&&(i+=t.hash),i}Na.prototype={set:WY,toString:zY};Na.extractProtocol=ZN;Na.location=QN;Na.trimLeft=hT;Na.qs=Hy;eB.exports=Na});var ui=Ce((rUe,tB)=>{"use strict";var HY=gT(),$Y=function(){};tB.exports={getOrigin:function(n){if(!n)return null;var e=new HY(n);if(e.protocol==="file:")return null;var t=e.port;return t||(t=e.protocol==="https:"?"443":"80"),e.protocol+"//"+e.hostname+":"+t},isOriginEqual:function(n,e){var t=this.getOrigin(n)===this.getOrigin(e);return $Y("same",n,e,t),t},isSchemeEqual:function(n,e){return n.split(":")[0]===e.split(":")[0]},addPath:function(n,e){var t=n.split("?");return t[0]+e+(t[1]?"?"+t[1]:"")},addQuery:function(n,e){return n+(n.indexOf("?")===-1?"?"+e:"&"+e)},isLoopbackAddr:function(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^\[::1\]$/.test(n)}}});var wt=Ce((iUe,yT)=>{typeof Object.create=="function"?yT.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:yT.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}});var vT=Ce((aUe,nB)=>{"use strict";function $y(){this._listeners={}}$y.prototype.addEventListener=function(n,e){n in this._listeners||(this._listeners[n]=[]);var t=this._listeners[n];t.indexOf(e)===-1&&(t=t.concat([e])),this._listeners[n]=t};$y.prototype.removeEventListener=function(n,e){var t=this._listeners[n];if(!!t){var r=t.indexOf(e);if(r!==-1){t.length>1?this._listeners[n]=t.slice(0,r).concat(t.slice(r+1)):delete this._listeners[n];return}}};$y.prototype.dispatchEvent=function(){var n=arguments[0],e=n.type,t=arguments.length===1?[n]:Array.apply(null,arguments);if(this["on"+e]&&this["on"+e].apply(this,t),e in this._listeners)for(var r=this._listeners[e],i=0;i<r.length;i++)r[i].apply(this,t)};nB.exports=$y});var gr=Ce((oUe,rB)=>{"use strict";var jY=wt(),jy=vT();function Vs(){jy.call(this)}jY(Vs,jy);Vs.prototype.removeAllListeners=function(n){n?delete this._listeners[n]:this._listeners={}};Vs.prototype.once=function(n,e){var t=this,r=!1;function i(){t.removeListener(n,i),r||(r=!0,e.apply(this,arguments))}this.on(n,i)};Vs.prototype.emit=function(){var n=arguments[0],e=this._listeners[n];if(!!e){for(var t=arguments.length,r=new Array(t-1),i=1;i<t;i++)r[i-1]=arguments[i];for(var a=0;a<e.length;a++)e[a].apply(this,r)}};Vs.prototype.on=Vs.prototype.addListener=jy.prototype.addEventListener;Vs.prototype.removeListener=jy.prototype.removeEventListener;rB.exports.EventEmitter=Vs});var aB=Ce((sUe,ST)=>{"use strict";var iB=window.WebSocket||window.MozWebSocket;iB?ST.exports=function(e){return new iB(e)}:ST.exports=void 0});var uB=Ce((lUe,cB)=>{"use strict";var oB=Do(),qY=ui(),JY=wt(),sB=gr().EventEmitter,lB=aB(),Po=function(){};function Io(n,e,t){if(!Io.enabled())throw new Error("Transport created when disabled");sB.call(this),Po("constructor",n);var r=this,i=qY.addPath(n,"/websocket");i.slice(0,5)==="https"?i="wss"+i.slice(5):i="ws"+i.slice(4),this.url=i,this.ws=new lB(this.url,[],t),this.ws.onmessage=function(a){Po("message event",a.data),r.emit("message",a.data)},this.unloadRef=oB.unloadAdd(function(){Po("unload"),r.ws.close()}),this.ws.onclose=function(a){Po("close event",a.code,a.reason),r.emit("close",a.code,a.reason),r._cleanup()},this.ws.onerror=function(a){Po("error event",a),r.emit("close",1006,"WebSocket connection broken"),r._cleanup()}}JY(Io,sB);Io.prototype.send=function(n){var e="["+n+"]";Po("send",e),this.ws.send(e)};Io.prototype.close=function(){Po("close");var n=this.ws;this._cleanup(),n&&n.close()};Io.prototype._cleanup=function(){Po("_cleanup");var n=this.ws;n&&(n.onmessage=n.onclose=n.onerror=null),oB.unloadDel(this.unloadRef),this.unloadRef=this.ws=null,this.removeAllListeners()};Io.enabled=function(){return Po("enabled"),!!lB};Io.transportName="websocket";Io.roundTrips=2;cB.exports=Io});var fB=Ce((cUe,pB)=>{"use strict";var YY=wt(),dB=gr().EventEmitter,Ao=function(){};function $l(n,e){Ao(n),dB.call(this),this.sendBuffer=[],this.sender=e,this.url=n}YY($l,dB);$l.prototype.send=function(n){Ao("send",n),this.sendBuffer.push(n),this.sendStop||this.sendSchedule()};$l.prototype.sendScheduleWait=function(){Ao("sendScheduleWait");var n=this,e;this.sendStop=function(){Ao("sendStop"),n.sendStop=null,clearTimeout(e)},e=setTimeout(function(){Ao("timeout"),n.sendStop=null,n.sendSchedule()},25)};$l.prototype.sendSchedule=function(){Ao("sendSchedule",this.sendBuffer.length);var n=this;if(this.sendBuffer.length>0){var e="["+this.sendBuffer.join(",")+"]";this.sendStop=this.sender(this.url,e,function(t){n.sendStop=null,t?(Ao("error",t),n.emit("close",t.code||1006,"Sending error: "+t),n.close()):n.sendScheduleWait()}),this.sendBuffer=[]}};$l.prototype._cleanup=function(){Ao("_cleanup"),this.removeAllListeners()};$l.prototype.close=function(){Ao("close"),this._cleanup(),this.sendStop&&(this.sendStop(),this.sendStop=null)};pB.exports=$l});var gB=Ce((uUe,mB)=>{"use strict";var KY=wt(),hB=gr().EventEmitter,ff=function(){};function qy(n,e,t){ff(e),hB.call(this),this.Receiver=n,this.receiveUrl=e,this.AjaxObject=t,this._scheduleReceiver()}KY(qy,hB);qy.prototype._scheduleReceiver=function(){ff("_scheduleReceiver");var n=this,e=this.poll=new this.Receiver(this.receiveUrl,this.AjaxObject);e.on("message",function(t){ff("message",t),n.emit("message",t)}),e.once("close",function(t,r){ff("close",t,r,n.pollIsClosing),n.poll=e=null,n.pollIsClosing||(r==="network"?n._scheduleReceiver():(n.emit("close",t||1006,r),n.removeAllListeners()))})};qy.prototype.abort=function(){ff("abort"),this.removeAllListeners(),this.pollIsClosing=!0,this.poll&&this.poll.abort()};mB.exports=qy});var CT=Ce((dUe,yB)=>{"use strict";var XY=wt(),QY=ui(),bT=fB(),ZY=gB(),Jy=function(){};function xT(n,e,t,r,i){var a=QY.addPath(n,e);Jy(a);var o=this;bT.call(this,n,t),this.poll=new ZY(r,a,i),this.poll.on("message",function(l){Jy("poll message",l),o.emit("message",l)}),this.poll.once("close",function(l,c){Jy("poll close",l,c),o.poll=null,o.emit("close",l,c),o.close()})}XY(xT,bT);xT.prototype.close=function(){bT.prototype.close.call(this),Jy("close"),this.removeAllListeners(),this.poll&&(this.poll.abort(),this.poll=null)};yB.exports=xT});var jl=Ce((pUe,bB)=>{"use strict";var e9=wt(),t9=ui(),vB=CT(),wT=function(){};function n9(n){return function(e,t,r){wT("create ajax sender",e,t);var i={};typeof t=="string"&&(i.headers={"Content-type":"text/plain"});var a=t9.addPath(e,"/xhr_send"),o=new n("POST",a,t,i);return o.once("finish",function(l){if(wT("finish",l),o=null,l!==200&&l!==204)return r(new Error("http status "+l));r()}),function(){wT("abort"),o.close(),o=null;var l=new Error("Aborted");l.code=1e3,r(l)}}}function SB(n,e,t,r){vB.call(this,n,e,n9(r),t,r)}e9(SB,vB);bB.exports=SB});var mf=Ce((fUe,CB)=>{"use strict";var r9=wt(),xB=gr().EventEmitter,Os=function(){};function hf(n,e){Os(n),xB.call(this);var t=this;this.bufferPosition=0,this.xo=new e("POST",n,null),this.xo.on("chunk",this._chunkHandler.bind(this)),this.xo.once("finish",function(r,i){Os("finish",r,i),t._chunkHandler(r,i),t.xo=null;var a=r===200?"network":"permanent";Os("close",a),t.emit("close",null,a),t._cleanup()})}r9(hf,xB);hf.prototype._chunkHandler=function(n,e){if(Os("_chunkHandler",n),!(n!==200||!e))for(var t=-1;;this.bufferPosition+=t+1){var r=e.slice(this.bufferPosition);if(t=r.indexOf(`
`),t===-1)break;var i=r.slice(0,t);i&&(Os("message",i),this.emit("message",i))}};hf.prototype._cleanup=function(){Os("_cleanup"),this.removeAllListeners()};hf.prototype.abort=function(){Os("abort"),this.xo&&(this.xo.close(),Os("close"),this.emit("close",null,"user"),this.xo=null),this._cleanup()};CB.exports=hf});var TT=Ce((hUe,EB)=>{"use strict";var wB=gr().EventEmitter,i9=wt(),TB=Do(),a9=ui(),gf=window.XMLHttpRequest,jr=function(){};function Ba(n,e,t,r){jr(n,e);var i=this;wB.call(this),setTimeout(function(){i._start(n,e,t,r)},0)}i9(Ba,wB);Ba.prototype._start=function(n,e,t,r){var i=this;try{this.xhr=new gf}catch(o){}if(!this.xhr){jr("no xhr"),this.emit("finish",0,"no xhr support"),this._cleanup();return}e=a9.addQuery(e,"t="+ +new Date),this.unloadRef=TB.unloadAdd(function(){jr("unload cleanup"),i._cleanup(!0)});try{this.xhr.open(n,e,!0),this.timeout&&"timeout"in this.xhr&&(this.xhr.timeout=this.timeout,this.xhr.ontimeout=function(){jr("xhr timeout"),i.emit("finish",0,""),i._cleanup(!1)})}catch(o){jr("exception",o),this.emit("finish",0,""),this._cleanup(!1);return}if((!r||!r.noCredentials)&&Ba.supportsCORS&&(jr("withCredentials"),this.xhr.withCredentials=!0),r&&r.headers)for(var a in r.headers)this.xhr.setRequestHeader(a,r.headers[a]);this.xhr.onreadystatechange=function(){if(i.xhr){var o=i.xhr,l,c;switch(jr("readyState",o.readyState),o.readyState){case 3:try{c=o.status,l=o.responseText}catch(d){}jr("status",c),c===1223&&(c=204),c===200&&l&&l.length>0&&(jr("chunk"),i.emit("chunk",c,l));break;case 4:c=o.status,jr("status",c),c===1223&&(c=204),(c===12005||c===12029)&&(c=0),jr("finish",c,o.responseText),i.emit("finish",c,o.responseText),i._cleanup(!1);break}}};try{i.xhr.send(t)}catch(o){i.emit("finish",0,""),i._cleanup(!1)}};Ba.prototype._cleanup=function(n){if(jr("cleanup"),!!this.xhr){if(this.removeAllListeners(),TB.unloadDel(this.unloadRef),this.xhr.onreadystatechange=function(){},this.xhr.ontimeout&&(this.xhr.ontimeout=null),n)try{this.xhr.abort()}catch(e){}this.unloadRef=this.xhr=null}};Ba.prototype.close=function(){jr("close"),this._cleanup(!0)};Ba.enabled=!!gf;var kB=["Active"].concat("Object").join("X");!Ba.enabled&&kB in window&&(jr("overriding xmlhttprequest"),gf=function(){try{return new window[kB]("Microsoft.XMLHTTP")}catch(n){return null}},Ba.enabled=!!new gf);var LB=!1;try{LB="withCredentials"in new gf}catch(n){}Ba.supportsCORS=LB;EB.exports=Ba});var yf=Ce((mUe,DB)=>{"use strict";var o9=wt(),Yy=TT();function kT(n,e,t,r){Yy.call(this,n,e,t,r)}o9(kT,Yy);kT.enabled=Yy.enabled&&Yy.supportsCORS;DB.exports=kT});var Iu=Ce((gUe,PB)=>{"use strict";var s9=wt(),LT=TT();function ET(n,e,t){LT.call(this,n,e,t,{noCredentials:!0})}s9(ET,LT);ET.enabled=LT.enabled;PB.exports=ET});var Au=Ce((yUe,IB)=>{"use strict";IB.exports={isOpera:function(){return window.navigator&&/opera/i.test(window.navigator.userAgent)},isKonqueror:function(){return window.navigator&&/konqueror/i.test(window.navigator.userAgent)},hasDomain:function(){if(!window.document)return!0;try{return!!window.document.domain}catch(n){return!1}}}});var RB=Ce((vUe,MB)=>{"use strict";var l9=wt(),AB=jl(),c9=mf(),DT=yf(),u9=Iu(),d9=Au();function Mu(n){if(!u9.enabled&&!DT.enabled)throw new Error("Transport created when disabled");AB.call(this,n,"/xhr_streaming",c9,DT)}l9(Mu,AB);Mu.enabled=function(n){return n.nullOrigin||d9.isOpera()?!1:DT.enabled};Mu.transportName="xhr-streaming";Mu.roundTrips=2;Mu.needBody=!!window.document;MB.exports=Mu});var Ky=Ce((SUe,OB)=>{"use strict";var _B=gr().EventEmitter,p9=wt(),VB=Do(),f9=Au(),h9=ui(),Ns=function(){};function ql(n,e,t){Ns(n,e);var r=this;_B.call(this),setTimeout(function(){r._start(n,e,t)},0)}p9(ql,_B);ql.prototype._start=function(n,e,t){Ns("_start");var r=this,i=new window.XDomainRequest;e=h9.addQuery(e,"t="+ +new Date),i.onerror=function(){Ns("onerror"),r._error()},i.ontimeout=function(){Ns("ontimeout"),r._error()},i.onprogress=function(){Ns("progress",i.responseText),r.emit("chunk",200,i.responseText)},i.onload=function(){Ns("load"),r.emit("finish",200,i.responseText),r._cleanup(!1)},this.xdr=i,this.unloadRef=VB.unloadAdd(function(){r._cleanup(!0)});try{this.xdr.open(n,e),this.timeout&&(this.xdr.timeout=this.timeout),this.xdr.send(t)}catch(a){this._error()}};ql.prototype._error=function(){this.emit("finish",0,""),this._cleanup(!1)};ql.prototype._cleanup=function(n){if(Ns("cleanup",n),!!this.xdr){if(this.removeAllListeners(),VB.unloadDel(this.unloadRef),this.xdr.ontimeout=this.xdr.onerror=this.xdr.onprogress=this.xdr.onload=null,n)try{this.xdr.abort()}catch(e){}this.unloadRef=this.xdr=null}};ql.prototype.close=function(){Ns("close"),this._cleanup(!0)};ql.enabled=!!(window.XDomainRequest&&f9.hasDomain());OB.exports=ql});var IT=Ce((bUe,BB)=>{"use strict";var m9=wt(),NB=jl(),g9=mf(),PT=Ky();function vf(n){if(!PT.enabled)throw new Error("Transport created when disabled");NB.call(this,n,"/xhr_streaming",g9,PT)}m9(vf,NB);vf.enabled=function(n){return n.cookie_needed||n.nullOrigin?!1:PT.enabled&&n.sameScheme};vf.transportName="xdr-streaming";vf.roundTrips=2;BB.exports=vf});var AT=Ce((xUe,UB)=>{UB.exports=window.EventSource});var WB=Ce((CUe,GB)=>{"use strict";var y9=wt(),FB=gr().EventEmitter,v9=AT(),Ru=function(){};function Sf(n){Ru(n),FB.call(this);var e=this,t=this.es=new v9(n);t.onmessage=function(r){Ru("message",r.data),e.emit("message",decodeURI(r.data))},t.onerror=function(r){Ru("error",t.readyState,r);var i=t.readyState!==2?"network":"permanent";e._cleanup(),e._close(i)}}y9(Sf,FB);Sf.prototype.abort=function(){Ru("abort"),this._cleanup(),this._close("user")};Sf.prototype._cleanup=function(){Ru("cleanup");var n=this.es;n&&(n.onmessage=n.onerror=null,n.close(),this.es=null)};Sf.prototype._close=function(n){Ru("close",n);var e=this;setTimeout(function(){e.emit("close",null,n),e.removeAllListeners()},200)};GB.exports=Sf});var MT=Ce((wUe,HB)=>{"use strict";var S9=wt(),zB=jl(),b9=WB(),x9=yf(),C9=AT();function _u(n){if(!_u.enabled())throw new Error("Transport created when disabled");zB.call(this,n,"/eventsource",b9,x9)}S9(_u,zB);_u.enabled=function(){return!!C9};_u.transportName="eventsource";_u.roundTrips=2;HB.exports=_u});var Ua=Ce((Vu,Xy)=>{(function(){var n=typeof define=="function"&&define.amd,e={function:!0,object:!0},t=e[typeof Vu]&&Vu&&!Vu.nodeType&&Vu,r=e[typeof window]&&window||this,i=t&&e[typeof Xy]&&Xy&&!Xy.nodeType&&typeof window=="object"&&window;i&&(i.global===i||i.window===i||i.self===i)&&(r=i);function a(p,m){p||(p=r.Object()),m||(m=r.Object());var y=p.Number||r.Number,v=p.String||r.String,b=p.Object||r.Object,x=p.Date||r.Date,C=p.SyntaxError||r.SyntaxError,k=p.TypeError||r.TypeError,M=p.Math||r.Math,I=p.JSON||r.JSON;typeof I=="object"&&I&&(m.stringify=I.stringify,m.parse=I.parse);var A=b.prototype,D=A.toString,E=A.hasOwnProperty,V;function N(le,ke){try{le()}catch(fe){ke&&ke()}}var U=new x(-3509827334573292);N(function(){U=U.getUTCFullYear()==-109252&&U.getUTCMonth()===0&&U.getUTCDate()===1&&U.getUTCHours()==10&&U.getUTCMinutes()==37&&U.getUTCSeconds()==6&&U.getUTCMilliseconds()==708});function _(le){if(_[le]!=null)return _[le];var ke;if(le=="bug-string-char-index")ke="a"[0]!="a";else if(le=="json")ke=_("json-stringify")&&_("date-serialization")&&_("json-parse");else if(le=="date-serialization"){if(ke=_("json-stringify")&&U,ke){var fe=m.stringify;N(function(){ke=fe(new x(-864e13))=='"-271821-04-20T00:00:00.000Z"'&&fe(new x(864e13))=='"+275760-09-13T00:00:00.000Z"'&&fe(new x(-621987552e5))=='"-000001-01-01T00:00:00.000Z"'&&fe(new x(-1))=='"1969-12-31T23:59:59.999Z"'})}}else{var Re,Ne='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if(le=="json-stringify"){var fe=m.stringify,tt=typeof fe=="function";tt&&((Re=function(){return 1}).toJSON=Re,N(function(){tt=fe(0)==="0"&&fe(new y)==="0"&&fe(new v)=='""'&&fe(D)===V&&fe(V)===V&&fe()===V&&fe(Re)==="1"&&fe([Re])=="[1]"&&fe([V])=="[null]"&&fe(null)=="null"&&fe([V,D,null])=="[null,null,null]"&&fe({a:[Re,!0,!1,null,`\0\b
\f\r	`]})==Ne&&fe(null,Re)==="1"&&fe([1,2],null,1)==`[
 1,
 2
]`},function(){tt=!1})),ke=tt}if(le=="json-parse"){var ce=m.parse,De;typeof ce=="function"&&N(function(){ce("0")===0&&!ce(!1)&&(Re=ce(Ne),De=Re.a.length==5&&Re.a[0]===1,De&&(N(function(){De=!ce('"	"')}),De&&N(function(){De=ce("01")!==1}),De&&N(function(){De=ce("1.")!==1})))},function(){De=!1}),ke=De}}return _[le]=!!ke}if(_["bug-string-char-index"]=_["date-serialization"]=_.json=_["json-stringify"]=_["json-parse"]=null,!_("json")){var B="[object Function]",R="[object Date]",X="[object Number]",j="[object String]",oe="[object Array]",me="[object Boolean]",xe=_("bug-string-char-index"),se=function(le,ke){var fe=0,Re,Ne,tt;(Re=function(){this.valueOf=0}).prototype.valueOf=0,Ne=new Re;for(tt in Ne)E.call(Ne,tt)&&fe++;return Re=Ne=null,fe?se=function(ce,De){var ot=D.call(ce)==B,Qe,bt;for(Qe in ce)!(ot&&Qe=="prototype")&&E.call(ce,Qe)&&!(bt=Qe==="constructor")&&De(Qe);(bt||E.call(ce,Qe="constructor"))&&De(Qe)}:(Ne=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],se=function(ce,De){var ot=D.call(ce)==B,Qe,bt,Jt=!ot&&typeof ce.constructor!="function"&&e[typeof ce.hasOwnProperty]&&ce.hasOwnProperty||E;for(Qe in ce)!(ot&&Qe=="prototype")&&Jt.call(ce,Qe)&&De(Qe);for(bt=Ne.length;Qe=Ne[--bt];)Jt.call(ce,Qe)&&De(Qe)}),se(le,ke)};if(!_("json-stringify")&&!_("date-serialization")){var Se={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},Ie="000000",je=function(le,ke){return(Ie+(ke||0)).slice(-le)},Be=function(le){var ke,fe,Re,Ne,tt,ce,De,ot,Qe;if(U)ke=function(be){fe=be.getUTCFullYear(),Re=be.getUTCMonth(),Ne=be.getUTCDate(),ce=be.getUTCHours(),De=be.getUTCMinutes(),ot=be.getUTCSeconds(),Qe=be.getUTCMilliseconds()};else{var bt=M.floor,Jt=[0,31,59,90,120,151,181,212,243,273,304,334],Vr=function(be,yr){return Jt[yr]+365*(be-1970)+bt((be-1969+(yr=+(yr>1)))/4)-bt((be-1901+yr)/100)+bt((be-1601+yr)/400)};ke=function(be){for(Ne=bt(be/864e5),fe=bt(Ne/365.2425)+1970-1;Vr(fe+1,0)<=Ne;fe++);for(Re=bt((Ne-Vr(fe,0))/30.42);Vr(fe,Re+1)<=Ne;Re++);Ne=1+Ne-Vr(fe,Re),tt=(be%864e5+864e5)%864e5,ce=bt(tt/36e5)%24,De=bt(tt/6e4)%60,ot=bt(tt/1e3)%60,Qe=tt%1e3}}return Be=function(be){return be>-1/0&&be<1/0?(ke(be),be=(fe<=0||fe>=1e4?(fe<0?"-":"+")+je(6,fe<0?-fe:fe):je(4,fe))+"-"+je(2,Re+1)+"-"+je(2,Ne)+"T"+je(2,ce)+":"+je(2,De)+":"+je(2,ot)+"."+je(3,Qe)+"Z",fe=Re=Ne=ce=De=ot=Qe=null):be=null,be},Be(le)};if(_("json-stringify")&&!_("date-serialization")){let le=function(ke){return Be(this)};var oa=le,Pe=m.stringify;m.stringify=function(ke,fe,Re){var Ne=x.prototype.toJSON;x.prototype.toJSON=le;var tt=Pe(ke,fe,Re);return x.prototype.toJSON=Ne,tt}}else{var ge="\\u00",$e=function(le){var ke=le.charCodeAt(0),fe=Se[ke];return fe||ge+je(2,ke.toString(16))},ht=/[\x00-\x1f\x22\x5c]/g,Dt=function(le){return ht.lastIndex=0,'"'+(ht.test(le)?le.replace(ht,$e):le)+'"'},Ae=function(le,ke,fe,Re,Ne,tt,ce){var De,ot,Qe,bt,Jt,Vr,be,yr,nt;if(N(function(){De=ke[le]}),typeof De=="object"&&De&&(De.getUTCFullYear&&D.call(De)==R&&De.toJSON===x.prototype.toJSON?De=Be(De):typeof De.toJSON=="function"&&(De=De.toJSON(le))),fe&&(De=fe.call(ke,le,De)),De==V)return De===V?De:"null";switch(ot=typeof De,ot=="object"&&(Qe=D.call(De)),Qe||ot){case"boolean":case me:return""+De;case"number":case X:return De>-1/0&&De<1/0?""+De:"null";case"string":case j:return Dt(""+De)}if(typeof De=="object"){for(be=ce.length;be--;)if(ce[be]===De)throw k();if(ce.push(De),bt=[],yr=tt,tt+=Ne,Qe==oe){for(Vr=0,be=De.length;Vr<be;Vr++)Jt=Ae(Vr,De,fe,Re,Ne,tt,ce),bt.push(Jt===V?"null":Jt);nt=bt.length?Ne?`[
`+tt+bt.join(`,
`+tt)+`
`+yr+"]":"["+bt.join(",")+"]":"[]"}else se(Re||De,function(Wt){var Ot=Ae(Wt,De,fe,Re,Ne,tt,ce);Ot!==V&&bt.push(Dt(Wt)+":"+(Ne?" ":"")+Ot)}),nt=bt.length?Ne?`{
`+tt+bt.join(`,
`+tt)+`
`+yr+"}":"{"+bt.join(",")+"}":"{}";return ce.pop(),nt}};m.stringify=function(le,ke,fe){var Re,Ne,tt,ce;if(e[typeof ke]&&ke){if(ce=D.call(ke),ce==B)Ne=ke;else if(ce==oe){tt={};for(var De=0,ot=ke.length,Qe;De<ot;)Qe=ke[De++],ce=D.call(Qe),(ce=="[object String]"||ce=="[object Number]")&&(tt[Qe]=1)}}if(fe)if(ce=D.call(fe),ce==X){if((fe-=fe%1)>0)for(fe>10&&(fe=10),Re="";Re.length<fe;)Re+=" "}else ce==j&&(Re=fe.length<=10?fe:fe.slice(0,10));return Ae("",(Qe={},Qe[""]=le,Qe),Ne,tt,Re,"",[])}}}if(!_("json-parse")){var Xe=v.fromCharCode,qt={92:"\\",34:'"',47:"/",98:"\b",116:"	",110:`
`,102:"\f",114:"\r"},Me,Bn,Oe=function(){throw Me=Bn=null,C()},ln=function(){for(var le=Bn,ke=le.length,fe,Re,Ne,tt,ce;Me<ke;)switch(ce=le.charCodeAt(Me),ce){case 9:case 10:case 13:case 32:Me++;break;case 123:case 125:case 91:case 93:case 58:case 44:return fe=xe?le.charAt(Me):le[Me],Me++,fe;case 34:for(fe="@",Me++;Me<ke;)if(ce=le.charCodeAt(Me),ce<32)Oe();else if(ce==92)switch(ce=le.charCodeAt(++Me),ce){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:fe+=qt[ce],Me++;break;case 117:for(Re=++Me,Ne=Me+4;Me<Ne;Me++)ce=le.charCodeAt(Me),ce>=48&&ce<=57||ce>=97&&ce<=102||ce>=65&&ce<=70||Oe();fe+=Xe("0x"+le.slice(Re,Me));break;default:Oe()}else{if(ce==34)break;for(ce=le.charCodeAt(Me),Re=Me;ce>=32&&ce!=92&&ce!=34;)ce=le.charCodeAt(++Me);fe+=le.slice(Re,Me)}if(le.charCodeAt(Me)==34)return Me++,fe;Oe();default:if(Re=Me,ce==45&&(tt=!0,ce=le.charCodeAt(++Me)),ce>=48&&ce<=57){for(ce==48&&(ce=le.charCodeAt(Me+1),ce>=48&&ce<=57)&&Oe(),tt=!1;Me<ke&&(ce=le.charCodeAt(Me),ce>=48&&ce<=57);Me++);if(le.charCodeAt(Me)==46){for(Ne=++Me;Ne<ke&&(ce=le.charCodeAt(Ne),!(ce<48||ce>57));Ne++);Ne==Me&&Oe(),Me=Ne}if(ce=le.charCodeAt(Me),ce==101||ce==69){for(ce=le.charCodeAt(++Me),(ce==43||ce==45)&&Me++,Ne=Me;Ne<ke&&(ce=le.charCodeAt(Ne),!(ce<48||ce>57));Ne++);Ne==Me&&Oe(),Me=Ne}return+le.slice(Re,Me)}tt&&Oe();var De=le.slice(Me,Me+4);if(De=="true")return Me+=4,!0;if(De=="fals"&&le.charCodeAt(Me+4)==101)return Me+=5,!1;if(De=="null")return Me+=4,null;Oe()}return"$"},pi=function(le){var ke,fe;if(le=="$"&&Oe(),typeof le=="string"){if((xe?le.charAt(0):le[0])=="@")return le.slice(1);if(le=="["){for(ke=[];le=ln(),le!="]";)fe?le==","?(le=ln(),le=="]"&&Oe()):Oe():fe=!0,le==","&&Oe(),ke.push(pi(le));return ke}else if(le=="{"){for(ke={};le=ln(),le!="}";)fe?le==","?(le=ln(),le=="}"&&Oe()):Oe():fe=!0,(le==","||typeof le!="string"||(xe?le.charAt(0):le[0])!="@"||ln()!=":")&&Oe(),ke[le.slice(1)]=pi(ln());return ke}Oe()}return le},aa=function(le,ke,fe){var Re=_r(le,ke,fe);Re===V?delete le[ke]:le[ke]=Re},_r=function(le,ke,fe){var Re=le[ke],Ne;if(typeof Re=="object"&&Re)if(D.call(Re)==oe)for(Ne=Re.length;Ne--;)aa(D,se,Re,Ne,fe);else se(Re,function(tt){aa(Re,tt,fe)});return fe.call(le,ke,Re)};m.parse=function(le,ke){var fe,Re;return Me=0,Bn=""+le,fe=pi(ln()),ln()!="$"&&Oe(),Me=Bn=null,ke&&D.call(ke)==B?_r((Re={},Re[""]=fe,Re),"",ke):fe}}}return m.runInContext=a,m}if(t&&!n)a(r,t);else{var o=r.JSON,l=r.JSON3,c=!1,d=a(r,r.JSON3={noConflict:function(){return c||(c=!0,r.JSON=o,r.JSON3=l,o=l=null),d}});r.JSON={parse:d.parse,stringify:d.stringify}}n&&define(function(){return d})}).call(Vu)});var RT=Ce((TUe,$B)=>{$B.exports="1.5.0"});var Ou=Ce((kUe,Mo)=>{"use strict";var Qy=Do(),w9=Ua(),T9=Au(),Jl=function(){};Mo.exports={WPrefix:"_jp",currentWindowId:null,polluteGlobalNamespace:function(){Mo.exports.WPrefix in window||(window[Mo.exports.WPrefix]={})},postMessage:function(n,e){window.parent!==window?window.parent.postMessage(w9.stringify({windowId:Mo.exports.currentWindowId,type:n,data:e||""}),"*"):Jl("Cannot postMessage, no parent window.",n,e)},createIframe:function(n,e){var t=window.document.createElement("iframe"),r,i,a=function(){Jl("unattach"),clearTimeout(r);try{t.onload=null}catch(d){}t.onerror=null},o=function(){Jl("cleanup"),t&&(a(),setTimeout(function(){t&&t.parentNode.removeChild(t),t=null},0),Qy.unloadDel(i))},l=function(d){Jl("onerror",d),t&&(o(),e(d))},c=function(d,p){Jl("post",d,p),setTimeout(function(){try{t&&t.contentWindow&&t.contentWindow.postMessage(d,p)}catch(m){}},0)};return t.src=n,t.style.display="none",t.style.position="absolute",t.onerror=function(){l("onerror")},t.onload=function(){Jl("onload"),clearTimeout(r),r=setTimeout(function(){l("onload timeout")},2e3)},window.document.body.appendChild(t),r=setTimeout(function(){l("timeout")},15e3),i=Qy.unloadAdd(o),{post:c,cleanup:o,loaded:a}},createHtmlfile:function(n,e){var t=["Active"].concat("Object").join("X"),r=new window[t]("htmlfile"),i,a,o,l=function(){clearTimeout(i),o.onerror=null},c=function(){r&&(l(),Qy.unloadDel(a),o.parentNode.removeChild(o),o=r=null,CollectGarbage())},d=function(y){Jl("onerror",y),r&&(c(),e(y))},p=function(y,v){try{setTimeout(function(){o&&o.contentWindow&&o.contentWindow.postMessage(y,v)},0)}catch(b){}};r.open(),r.write('<html><script>document.domain="'+window.document.domain+'";</script></html>'),r.close(),r.parentWindow[Mo.exports.WPrefix]=window[Mo.exports.WPrefix];var m=r.createElement("div");return r.body.appendChild(m),o=r.createElement("iframe"),m.appendChild(o),o.src=n,o.onerror=function(){d("onerror")},i=setTimeout(function(){d("timeout")},15e3),a=Qy.unloadAdd(c),{post:p,cleanup:c,loaded:l}}};Mo.exports.iframeEnabled=!1;window.document&&(Mo.exports.iframeEnabled=(typeof window.postMessage=="function"||typeof window.postMessage=="object")&&!T9.isKonqueror())});var VT=Ce((LUe,YB)=>{"use strict";var k9=wt(),Zy=Ua(),jB=gr().EventEmitter,L9=RT(),_T=ui(),qB=Ou(),JB=Do(),E9=Hl(),Fa=function(){};function Ga(n,e,t){if(!Ga.enabled())throw new Error("Transport created when disabled");jB.call(this);var r=this;this.origin=_T.getOrigin(t),this.baseUrl=t,this.transUrl=e,this.transport=n,this.windowId=E9.string(8);var i=_T.addPath(t,"/iframe.html")+"#"+this.windowId;Fa(n,e,i),this.iframeObj=qB.createIframe(i,function(a){Fa("err callback"),r.emit("close",1006,"Unable to load an iframe ("+a+")"),r.close()}),this.onmessageCallback=this._message.bind(this),JB.attachEvent("message",this.onmessageCallback)}k9(Ga,jB);Ga.prototype.close=function(){if(Fa("close"),this.removeAllListeners(),this.iframeObj){JB.detachEvent("message",this.onmessageCallback);try{this.postMessage("c")}catch(n){}this.iframeObj.cleanup(),this.iframeObj=null,this.onmessageCallback=this.iframeObj=null}};Ga.prototype._message=function(n){if(Fa("message",n.data),!_T.isOriginEqual(n.origin,this.origin)){Fa("not same origin",n.origin,this.origin);return}var e;try{e=Zy.parse(n.data)}catch(r){Fa("bad json",n.data);return}if(e.windowId!==this.windowId){Fa("mismatched window id",e.windowId,this.windowId);return}switch(e.type){case"s":this.iframeObj.loaded(),this.postMessage("s",Zy.stringify([L9,this.transport,this.transUrl,this.baseUrl]));break;case"t":this.emit("message",e.data);break;case"c":var t;try{t=Zy.parse(e.data)}catch(r){Fa("bad json",e.data);return}this.emit("close",t[0],t[1]),this.close();break}};Ga.prototype.postMessage=function(n,e){Fa("postMessage",n,e),this.iframeObj.post(Zy.stringify({windowId:this.windowId,type:n,data:e||""}),this.origin)};Ga.prototype.send=function(n){Fa("send",n),this.postMessage("m",n)};Ga.enabled=function(){return qB.iframeEnabled};Ga.transportName="iframe";Ga.roundTrips=2;YB.exports=Ga});var ev=Ce((EUe,KB)=>{"use strict";KB.exports={isObject:function(n){var e=typeof n;return e==="function"||e==="object"&&!!n},extend:function(n){if(!this.isObject(n))return n;for(var e,t,r=1,i=arguments.length;r<i;r++){e=arguments[r];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])}return n}}});var nv=Ce((DUe,XB)=>{"use strict";var D9=wt(),tv=VT(),P9=ev();XB.exports=function(n){function e(t,r){tv.call(this,n.transportName,t,r)}return D9(e,tv),e.enabled=function(t,r){if(!window.document)return!1;var i=P9.extend({},r);return i.sameOrigin=!0,n.enabled(i)&&tv.enabled()},e.transportName="iframe-"+n.transportName,e.needBody=!0,e.roundTrips=tv.roundTrips+n.roundTrips-1,e.facadeTransport=n,e}});var tU=Ce((PUe,eU)=>{"use strict";var I9=wt(),Yl=Ou(),A9=ui(),QB=gr().EventEmitter,M9=Hl(),Ro=function(){};function ra(n){Ro(n),QB.call(this);var e=this;Yl.polluteGlobalNamespace(),this.id="a"+M9.string(6),n=A9.addQuery(n,"c="+decodeURIComponent(Yl.WPrefix+"."+this.id)),Ro("using htmlfile",ra.htmlfileEnabled);var t=ra.htmlfileEnabled?Yl.createHtmlfile:Yl.createIframe;window[Yl.WPrefix][this.id]={start:function(){Ro("start"),e.iframeObj.loaded()},message:function(r){Ro("message",r),e.emit("message",r)},stop:function(){Ro("stop"),e._cleanup(),e._close("network")}},this.iframeObj=t(n,function(){Ro("callback"),e._cleanup(),e._close("permanent")})}I9(ra,QB);ra.prototype.abort=function(){Ro("abort"),this._cleanup(),this._close("user")};ra.prototype._cleanup=function(){Ro("_cleanup"),this.iframeObj&&(this.iframeObj.cleanup(),this.iframeObj=null),delete window[Yl.WPrefix][this.id]};ra.prototype._close=function(n){Ro("_close",n),this.emit("close",null,n),this.removeAllListeners()};ra.htmlfileEnabled=!1;var ZB=["Active"].concat("Object").join("X");if(ZB in window)try{ra.htmlfileEnabled=!!new window[ZB]("htmlfile")}catch(n){}ra.enabled=ra.htmlfileEnabled||Yl.iframeEnabled;eU.exports=ra});var NT=Ce((IUe,rU)=>{"use strict";var R9=wt(),OT=tU(),_9=Iu(),nU=jl();function bf(n){if(!OT.enabled)throw new Error("Transport created when disabled");nU.call(this,n,"/htmlfile",OT,_9)}R9(bf,nU);bf.enabled=function(n){return OT.enabled&&n.sameOrigin};bf.transportName="htmlfile";bf.roundTrips=2;rU.exports=bf});var UT=Ce((AUe,oU)=>{"use strict";var V9=wt(),iU=jl(),O9=mf(),BT=yf(),aU=Iu();function xf(n){if(!aU.enabled&&!BT.enabled)throw new Error("Transport created when disabled");iU.call(this,n,"/xhr",O9,BT)}V9(xf,iU);xf.enabled=function(n){return n.nullOrigin?!1:aU.enabled&&n.sameOrigin?!0:BT.enabled};xf.transportName="xhr-polling";xf.roundTrips=2;oU.exports=xf});var uU=Ce((MUe,cU)=>{"use strict";var N9=wt(),sU=jl(),B9=IT(),U9=mf(),lU=Ky();function Cf(n){if(!lU.enabled)throw new Error("Transport created when disabled");sU.call(this,n,"/xhr",U9,lU)}N9(Cf,sU);Cf.enabled=B9.enabled;Cf.transportName="xdr-polling";Cf.roundTrips=2;cU.exports=Cf});var hU=Ce((RUe,fU)=>{"use strict";var wf=Ou(),dU=Hl(),F9=Au(),G9=ui(),W9=wt(),pU=gr().EventEmitter,ia=function(){};function Ii(n){ia(n);var e=this;pU.call(this),wf.polluteGlobalNamespace(),this.id="a"+dU.string(6);var t=G9.addQuery(n,"c="+encodeURIComponent(wf.WPrefix+"."+this.id));window[wf.WPrefix][this.id]=this._callback.bind(this),this._createScript(t),this.timeoutId=setTimeout(function(){ia("timeout"),e._abort(new Error("JSONP script loaded abnormally (timeout)"))},Ii.timeout)}W9(Ii,pU);Ii.prototype.abort=function(){if(ia("abort"),window[wf.WPrefix][this.id]){var n=new Error("JSONP user aborted read");n.code=1e3,this._abort(n)}};Ii.timeout=35e3;Ii.scriptErrorTimeout=1e3;Ii.prototype._callback=function(n){ia("_callback",n),this._cleanup(),!this.aborting&&(n&&(ia("message",n),this.emit("message",n)),this.emit("close",null,"network"),this.removeAllListeners())};Ii.prototype._abort=function(n){ia("_abort",n),this._cleanup(),this.aborting=!0,this.emit("close",n.code,n.message),this.removeAllListeners()};Ii.prototype._cleanup=function(){if(ia("_cleanup"),clearTimeout(this.timeoutId),this.script2&&(this.script2.parentNode.removeChild(this.script2),this.script2=null),this.script){var n=this.script;n.parentNode.removeChild(n),n.onreadystatechange=n.onerror=n.onload=n.onclick=null,this.script=null}delete window[wf.WPrefix][this.id]};Ii.prototype._scriptError=function(){ia("_scriptError");var n=this;this.errorTimer||(this.errorTimer=setTimeout(function(){n.loadedOkay||n._abort(new Error("JSONP script loaded abnormally (onerror)"))},Ii.scriptErrorTimeout))};Ii.prototype._createScript=function(n){ia("_createScript",n);var e=this,t=this.script=window.document.createElement("script"),r;if(t.id="a"+dU.string(8),t.src=n,t.type="text/javascript",t.charset="UTF-8",t.onerror=this._scriptError.bind(this),t.onload=function(){ia("onload"),e._abort(new Error("JSONP script loaded abnormally (onload)"))},t.onreadystatechange=function(){if(ia("onreadystatechange",t.readyState),/loaded|closed/.test(t.readyState)){if(t&&t.htmlFor&&t.onclick){e.loadedOkay=!0;try{t.onclick()}catch(a){}}t&&e._abort(new Error("JSONP script loaded abnormally (onreadystatechange)"))}},typeof t.async=="undefined"&&window.document.attachEvent)if(F9.isOpera())r=this.script2=window.document.createElement("script"),r.text="try{var a = document.getElementById('"+t.id+"'); if(a)a.onerror();}catch(x){};",t.async=r.async=!1;else{try{t.htmlFor=t.id,t.event="onclick"}catch(a){}t.async=!0}typeof t.async!="undefined"&&(t.async=!0);var i=window.document.getElementsByTagName("head")[0];i.insertBefore(t,i.firstChild),r&&i.insertBefore(r,i.firstChild)};fU.exports=Ii});var yU=Ce((_Ue,gU)=>{"use strict";var z9=Hl(),mU=ui(),_o=function(){},di,Tf;function H9(n){_o("createIframe",n);try{return window.document.createElement('<iframe name="'+n+'">')}catch(t){var e=window.document.createElement("iframe");return e.name=n,e}}function $9(){_o("createForm"),di=window.document.createElement("form"),di.style.display="none",di.style.position="absolute",di.method="POST",di.enctype="application/x-www-form-urlencoded",di.acceptCharset="UTF-8",Tf=window.document.createElement("textarea"),Tf.name="d",di.appendChild(Tf),window.document.body.appendChild(di)}gU.exports=function(n,e,t){_o(n,e),di||$9();var r="a"+z9.string(8);di.target=r,di.action=mU.addQuery(mU.addPath(n,"/jsonp_send"),"i="+r);var i=H9(r);i.id=r,i.style.display="none",di.appendChild(i);try{Tf.value=e}catch(o){}di.submit();var a=function(o){_o("completed",r,o),!!i.onerror&&(i.onreadystatechange=i.onerror=i.onload=null,setTimeout(function(){_o("cleaning up",r),i.parentNode.removeChild(i),i=null},500),Tf.value="",t(o))};return i.onerror=function(){_o("onerror",r),a()},i.onload=function(){_o("onload",r),a()},i.onreadystatechange=function(o){_o("onreadystatechange",r,i.readyState,o),i.readyState==="complete"&&a()},function(){_o("aborted",r),a(new Error("Aborted"))}}});var bU=Ce((VUe,SU)=>{"use strict";var j9=wt(),vU=CT(),q9=hU(),J9=yU();function Kl(n){if(!Kl.enabled())throw new Error("Transport created when disabled");vU.call(this,n,"/jsonp",J9,q9)}j9(Kl,vU);Kl.enabled=function(){return!!window.document};Kl.transportName="jsonp-polling";Kl.roundTrips=1;Kl.needBody=!0;SU.exports=Kl});var CU=Ce((OUe,xU)=>{"use strict";xU.exports=[uB(),RB(),IT(),MT(),nv()(MT()),NT(),nv()(NT()),UT(),uU(),nv()(UT()),bU()]});var PU=Ce(()=>{"use strict";var kf=Array.prototype,FT=Object.prototype,Y9=Function.prototype,Lf=String.prototype,GT=kf.slice,WT=FT.toString,wU=function(n){return FT.toString.call(n)==="[object Function]"},K9=function(e){return WT.call(e)==="[object Array]"},TU=function(e){return WT.call(e)==="[object String]"},X9=Object.defineProperty&&function(){try{return Object.defineProperty({},"x",{}),!0}catch(n){return!1}}(),zT;X9?zT=function(n,e,t,r){!r&&e in n||Object.defineProperty(n,e,{configurable:!0,enumerable:!1,writable:!0,value:t})}:zT=function(n,e,t,r){!r&&e in n||(n[e]=t)};var Ef=function(n,e,t){for(var r in e)FT.hasOwnProperty.call(e,r)&&zT(n,r,e[r],t)},kU=function(n){if(n==null)throw new TypeError("can't convert "+n+" to object");return Object(n)};function Q9(n){var e=+n;return e!==e?e=0:e!==0&&e!==1/0&&e!==-(1/0)&&(e=(e>0||-1)*Math.floor(Math.abs(e))),e}function Z9(n){return n>>>0}function HT(){}Ef(Y9,{bind:function(e){var t=this;if(!wU(t))throw new TypeError("Function.prototype.bind called on incompatible "+t);for(var r=GT.call(arguments,1),i=function(){if(this instanceof c){var d=t.apply(this,r.concat(GT.call(arguments)));return Object(d)===d?d:this}else return t.apply(e,r.concat(GT.call(arguments)))},a=Math.max(0,t.length-r.length),o=[],l=0;l<a;l++)o.push("$"+l);var c=Function("binder","return function ("+o.join(",")+"){ return binder.apply(this, arguments); }")(i);return t.prototype&&(HT.prototype=t.prototype,c.prototype=new HT,HT.prototype=null),c}});Ef(Array,{isArray:K9});var LU=Object("a"),EU=LU[0]!=="a"||!(0 in LU),eK=function(e){var t=!0,r=!0;return e&&(e.call("foo",function(i,a,o){typeof o!="object"&&(t=!1)}),e.call([1],function(){"use strict";r=typeof this=="string"},"x")),!!e&&t&&r};Ef(kf,{forEach:function(e){var t=kU(this),r=EU&&TU(this)?this.split(""):t,i=arguments[1],a=-1,o=r.length>>>0;if(!wU(e))throw new TypeError;for(;++a<o;)a in r&&e.call(i,r[a],a,t)}},!eK(kf.forEach));var tK=Array.prototype.indexOf&&[0,1].indexOf(1,2)!==-1;Ef(kf,{indexOf:function(e){var t=EU&&TU(this)?this.split(""):kU(this),r=t.length>>>0;if(!r)return-1;var i=0;for(arguments.length>1&&(i=Q9(arguments[1])),i=i>=0?i:Math.max(0,r+i);i<r;i++)if(i in t&&t[i]===e)return i;return-1}},tK);var DU=Lf.split;"ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1?function(){var n=/()??/.exec("")[1]===void 0;Lf.split=function(e,t){var r=this;if(e===void 0&&t===0)return[];if(WT.call(e)!=="[object RegExp]")return DU.call(this,e,t);var i=[],a=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.extended?"x":"")+(e.sticky?"y":""),o=0,l,c,d,p;for(e=new RegExp(e.source,a+"g"),r+="",n||(l=new RegExp("^"+e.source+"$(?!\\s)",a)),t=t===void 0?-1>>>0:Z9(t);(c=e.exec(r))&&(d=c.index+c[0].length,!(d>o&&(i.push(r.slice(o,c.index)),!n&&c.length>1&&c[0].replace(l,function(){for(var m=1;m<arguments.length-2;m++)arguments[m]===void 0&&(c[m]=void 0)}),c.length>1&&c.index<r.length&&kf.push.apply(i,c.slice(1)),p=c[0].length,o=d,i.length>=t)));)e.lastIndex===c.index&&e.lastIndex++;return o===r.length?(p||!e.test(""))&&i.push(""):i.push(r.slice(o)),i.length>t?i.slice(0,t):i}}():"0".split(void 0,0).length&&(Lf.split=function(e,t){return e===void 0&&t===0?[]:DU.call(this,e,t)});var nK=Lf.substr,rK="".substr&&"0b".substr(-1)!=="b";Ef(Lf,{substr:function(e,t){return nK.call(this,e<0&&(e=this.length+e)<0?0:e,t)}},rK)});var AU=Ce((UUe,IU)=>{"use strict";var iK=Ua(),rv=/[\x00-\x1f\ud800-\udfff\ufffe\uffff\u0300-\u0333\u033d-\u0346\u034a-\u034c\u0350-\u0352\u0357-\u0358\u035c-\u0362\u0374\u037e\u0387\u0591-\u05af\u05c4\u0610-\u0617\u0653-\u0654\u0657-\u065b\u065d-\u065e\u06df-\u06e2\u06eb-\u06ec\u0730\u0732-\u0733\u0735-\u0736\u073a\u073d\u073f-\u0741\u0743\u0745\u0747\u07eb-\u07f1\u0951\u0958-\u095f\u09dc-\u09dd\u09df\u0a33\u0a36\u0a59-\u0a5b\u0a5e\u0b5c-\u0b5d\u0e38-\u0e39\u0f43\u0f4d\u0f52\u0f57\u0f5c\u0f69\u0f72-\u0f76\u0f78\u0f80-\u0f83\u0f93\u0f9d\u0fa2\u0fa7\u0fac\u0fb9\u1939-\u193a\u1a17\u1b6b\u1cda-\u1cdb\u1dc0-\u1dcf\u1dfc\u1dfe\u1f71\u1f73\u1f75\u1f77\u1f79\u1f7b\u1f7d\u1fbb\u1fbe\u1fc9\u1fcb\u1fd3\u1fdb\u1fe3\u1feb\u1fee-\u1fef\u1ff9\u1ffb\u1ffd\u2000-\u2001\u20d0-\u20d1\u20d4-\u20d7\u20e7-\u20e9\u2126\u212a-\u212b\u2329-\u232a\u2adc\u302b-\u302c\uaab2-\uaab3\uf900-\ufa0d\ufa10\ufa12\ufa15-\ufa1e\ufa20\ufa22\ufa25-\ufa26\ufa2a-\ufa2d\ufa30-\ufa6d\ufa70-\ufad9\ufb1d\ufb1f\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufb4e\ufff0-\uffff]/g,$T,aK=function(n){var e,t={},r=[];for(e=0;e<65536;e++)r.push(String.fromCharCode(e));return n.lastIndex=0,r.join("").replace(n,function(i){return t[i]="\\u"+("0000"+i.charCodeAt(0).toString(16)).slice(-4),""}),n.lastIndex=0,t};IU.exports={quote:function(n){var e=iK.stringify(n);return rv.lastIndex=0,rv.test(e)?($T||($T=aK(rv)),e.replace(rv,function(t){return $T[t]})):e}}});var RU=Ce((FUe,MU)=>{"use strict";var iv=function(){};MU.exports=function(n){return{filterToEnabled:function(e,t){var r={main:[],facade:[]};return e?typeof e=="string"&&(e=[e]):e=[],n.forEach(function(i){if(!!i){if(i.transportName==="websocket"&&t.websocket===!1){iv("disabled from server","websocket");return}if(e.length&&e.indexOf(i.transportName)===-1){iv("not in whitelist",i.transportName);return}i.enabled(t)?(iv("enabled",i.transportName),r.main.push(i),i.facadeTransport&&r.facade.push(i.facadeTransport)):iv("disabled",i.transportName)}}),r}}}});var VU=Ce((GUe,_U)=>{"use strict";var jT={};["log","debug","warn"].forEach(function(n){var e;try{e=window.console&&window.console[n]&&window.console[n].apply}catch(t){}jT[n]=e?function(){return window.console[n].apply(window.console,arguments)}:n==="log"?function(){}:jT.log});_U.exports=jT});var av=Ce((WUe,OU)=>{"use strict";function Xl(n){this.type=n}Xl.prototype.initEvent=function(n,e,t){return this.type=n,this.bubbles=e,this.cancelable=t,this.timeStamp=+new Date,this};Xl.prototype.stopPropagation=function(){};Xl.prototype.preventDefault=function(){};Xl.CAPTURING_PHASE=1;Xl.AT_TARGET=2;Xl.BUBBLING_PHASE=3;OU.exports=Xl});var qT=Ce((zUe,NU)=>{"use strict";NU.exports=window.location||{origin:"http://localhost:80",protocol:"http:",host:"localhost",port:80,href:"http://localhost/",hash:""}});var GU=Ce((HUe,FU)=>{"use strict";var oK=wt(),BU=av();function UU(){BU.call(this),this.initEvent("close",!1,!1),this.wasClean=!1,this.code=0,this.reason=""}oK(UU,BU);FU.exports=UU});var $U=Ce(($Ue,HU)=>{"use strict";var sK=wt(),WU=av();function zU(n){WU.call(this),this.initEvent("message",!1,!1),this.data=n}sK(zU,WU);HU.exports=zU});var JU=Ce((jUe,qU)=>{"use strict";var jU=gr().EventEmitter,lK=wt();function Df(){var n=this;jU.call(this),this.to=setTimeout(function(){n.emit("finish",200,"{}")},Df.timeout)}lK(Df,jU);Df.prototype.close=function(){clearTimeout(this.to)};Df.timeout=2e3;qU.exports=Df});var YT=Ce((qUe,KU)=>{"use strict";var YU=gr().EventEmitter,cK=wt(),uK=Ua(),dK=ev(),pK=function(){};function JT(n,e){YU.call(this);var t=this,r=+new Date;this.xo=new e("GET",n),this.xo.once("finish",function(i,a){var o,l;if(i===200){if(l=+new Date-r,a)try{o=uK.parse(a)}catch(c){pK("bad json",a)}dK.isObject(o)||(o={})}t.emit("finish",o,l),t.removeAllListeners()})}cK(JT,YU);JT.prototype.close=function(){this.removeAllListeners(),this.xo.close()};KU.exports=JT});var KT=Ce((JUe,QU)=>{"use strict";var fK=wt(),XU=gr().EventEmitter,hK=Ua(),mK=Iu(),gK=YT();function ov(n){var e=this;XU.call(this),this.ir=new gK(n,mK),this.ir.once("finish",function(t,r){e.ir=null,e.emit("message",hK.stringify([t,r]))})}fK(ov,XU);ov.transportName="iframe-info-receiver";ov.prototype.close=function(){this.ir&&(this.ir.close(),this.ir=null),this.removeAllListeners()};QU.exports=ov});var nF=Ce((YUe,tF)=>{"use strict";var ZU=gr().EventEmitter,yK=wt(),vK=Ua(),SK=Do(),eF=VT(),bK=KT(),xK=function(){};function sv(n,e){var t=this;ZU.call(this);var r=function(){var i=t.ifr=new eF(bK.transportName,e,n);i.once("message",function(a){if(a){var o;try{o=vK.parse(a)}catch(d){xK("bad json",a),t.emit("finish"),t.close();return}var l=o[0],c=o[1];t.emit("finish",l,c)}t.close()}),i.once("close",function(){t.emit("finish"),t.close()})};window.document.body?r():SK.attachEvent("load",r)}yK(sv,ZU);sv.enabled=function(){return eF.enabled()};sv.prototype.close=function(){this.ifr&&this.ifr.close(),this.removeAllListeners(),this.ifr=null};tF.exports=sv});var lF=Ce((KUe,sF)=>{"use strict";var rF=gr().EventEmitter,CK=wt(),wK=ui(),iF=Ky(),aF=yf(),TK=Iu(),kK=JU(),oF=nF(),lv=YT(),Nu=function(){};function Vo(n,e){Nu(n);var t=this;rF.call(this),setTimeout(function(){t.doXhr(n,e)},0)}CK(Vo,rF);Vo._getReceiver=function(n,e,t){return t.sameOrigin?new lv(e,TK):aF.enabled?new lv(e,aF):iF.enabled&&t.sameScheme?new lv(e,iF):oF.enabled()?new oF(n,e):new lv(e,kK)};Vo.prototype.doXhr=function(n,e){var t=this,r=wK.addPath(n,"/info");Nu("doXhr",r),this.xo=Vo._getReceiver(n,r,e),this.timeoutRef=setTimeout(function(){Nu("timeout"),t._cleanup(!1),t.emit("finish")},Vo.timeout),this.xo.once("finish",function(i,a){Nu("finish",i,a),t._cleanup(!0),t.emit("finish",i,a)})};Vo.prototype._cleanup=function(n){Nu("_cleanup"),clearTimeout(this.timeoutRef),this.timeoutRef=null,!n&&this.xo&&this.xo.close(),this.xo=null};Vo.prototype.close=function(){Nu("close"),this.removeAllListeners(),this._cleanup(!1)};Vo.timeout=8e3;sF.exports=Vo});var dF=Ce((XUe,uF)=>{"use strict";var LK=Ua(),cF=Ou();function Pf(n){this._transport=n,n.on("message",this._transportMessage.bind(this)),n.on("close",this._transportClose.bind(this))}Pf.prototype._transportClose=function(n,e){cF.postMessage("c",LK.stringify([n,e]))};Pf.prototype._transportMessage=function(n){cF.postMessage("t",n)};Pf.prototype._send=function(n){this._transport.send(n)};Pf.prototype._close=function(){this._transport.close(),this._transport.removeAllListeners()};uF.exports=Pf});var gF=Ce((QUe,mF)=>{"use strict";var pF=ui(),EK=Do(),fF=Ua(),DK=dF(),hF=KT(),XT=Ou(),cv=qT(),QT=function(){};mF.exports=function(n,e){var t={};e.forEach(function(i){i.facadeTransport&&(t[i.facadeTransport.transportName]=i.facadeTransport)}),t[hF.transportName]=hF;var r;n.bootstrap_iframe=function(){var i;XT.currentWindowId=cv.hash.slice(1);var a=function(o){if(o.source===parent&&(typeof r=="undefined"&&(r=o.origin),o.origin===r)){var l;try{l=fF.parse(o.data)}catch(v){QT("bad json",o.data);return}if(l.windowId===XT.currentWindowId)switch(l.type){case"s":var c;try{c=fF.parse(l.data)}catch(v){QT("bad json",l.data);break}var d=c[0],p=c[1],m=c[2],y=c[3];if(QT(d,p,m,y),d!==n.version)throw new Error('Incompatible SockJS! Main site uses: "'+d+'", the iframe: "'+n.version+'".');if(!pF.isOriginEqual(m,cv.href)||!pF.isOriginEqual(y,cv.href))throw new Error("Can't connect to different domain from within an iframe. ("+cv.href+", "+m+", "+y+")");i=new DK(new t[p](m,y));break;case"m":i._send(l.data);break;case"c":i&&i._close(),i=null;break}}};EK.attachEvent("message",a),XT.postMessage("s")}}});var wF=Ce((ZUe,CF)=>{"use strict";PU();var PK=gT(),IK=wt(),AK=Ua(),yF=Hl(),MK=AU(),If=ui(),RK=Do(),_K=RU(),VK=ev(),OK=Au(),NK=VU(),ZT=av(),vF=vT(),uv=qT(),BK=GU(),SF=$U(),UK=lF(),kn=function(){},bF;function Tt(n,e,t){if(!(this instanceof Tt))return new Tt(n,e,t);if(arguments.length<1)throw new TypeError("Failed to construct 'SockJS: 1 argument required, but only 0 present");vF.call(this),this.readyState=Tt.CONNECTING,this.extensions="",this.protocol="",t=t||{},t.protocols_whitelist&&NK.warn("'protocols_whitelist' is DEPRECATED. Use 'transports' instead."),this._transportsWhitelist=t.transports,this._transportOptions=t.transportOptions||{},this._timeout=t.timeout||0;var r=t.sessionId||8;if(typeof r=="function")this._generateSessionId=r;else if(typeof r=="number")this._generateSessionId=function(){return yF.string(r)};else throw new TypeError("If sessionId is used in the options, it needs to be a number or a function.");this._server=t.server||yF.numberString(1e3);var i=new PK(n);if(!i.host||!i.protocol)throw new SyntaxError("The URL '"+n+"' is invalid");if(i.hash)throw new SyntaxError("The URL must not contain a fragment");if(i.protocol!=="http:"&&i.protocol!=="https:")throw new SyntaxError("The URL's scheme must be either 'http:' or 'https:'. '"+i.protocol+"' is not allowed.");var a=i.protocol==="https:";if(uv.protocol==="https:"&&!a&&!If.isLoopbackAddr(i.hostname))throw new Error("SecurityError: An insecure SockJS connection may not be initiated from a page loaded over HTTPS");e?Array.isArray(e)||(e=[e]):e=[];var o=e.sort();o.forEach(function(c,d){if(!c)throw new SyntaxError("The protocols entry '"+c+"' is invalid.");if(d<o.length-1&&c===o[d+1])throw new SyntaxError("The protocols entry '"+c+"' is duplicated.")});var l=If.getOrigin(uv.href);this._origin=l?l.toLowerCase():null,i.set("pathname",i.pathname.replace(/\/+$/,"")),this.url=i.href,kn("using url",this.url),this._urlInfo={nullOrigin:!OK.hasDomain(),sameOrigin:If.isOriginEqual(this.url,uv.href),sameScheme:If.isSchemeEqual(this.url,uv.href)},this._ir=new UK(this.url,this._urlInfo),this._ir.once("finish",this._receiveInfo.bind(this))}IK(Tt,vF);function xF(n){return n===1e3||n>=3e3&&n<=4999}Tt.prototype.close=function(n,e){if(n&&!xF(n))throw new Error("InvalidAccessError: Invalid code");if(e&&e.length>123)throw new SyntaxError("reason argument has an invalid length");if(!(this.readyState===Tt.CLOSING||this.readyState===Tt.CLOSED)){var t=!0;this._close(n||1e3,e||"Normal closure",t)}};Tt.prototype.send=function(n){if(typeof n!="string"&&(n=""+n),this.readyState===Tt.CONNECTING)throw new Error("InvalidStateError: The connection has not been established yet");this.readyState===Tt.OPEN&&this._transport.send(MK.quote(n))};Tt.version=RT();Tt.CONNECTING=0;Tt.OPEN=1;Tt.CLOSING=2;Tt.CLOSED=3;Tt.prototype._receiveInfo=function(n,e){if(kn("_receiveInfo",e),this._ir=null,!n){this._close(1002,"Cannot connect to server");return}this._rto=this.countRTO(e),this._transUrl=n.base_url?n.base_url:this.url,n=VK.extend(n,this._urlInfo),kn("info",n);var t=bF.filterToEnabled(this._transportsWhitelist,n);this._transports=t.main,kn(this._transports.length+" enabled transports"),this._connect()};Tt.prototype._connect=function(){for(var n=this._transports.shift();n;n=this._transports.shift()){if(kn("attempt",n.transportName),n.needBody&&(!window.document.body||typeof window.document.readyState!="undefined"&&window.document.readyState!=="complete"&&window.document.readyState!=="interactive")){kn("waiting for body"),this._transports.unshift(n),RK.attachEvent("load",this._connect.bind(this));return}var e=Math.max(this._timeout,this._rto*n.roundTrips||5e3);this._transportTimeoutId=setTimeout(this._transportTimeout.bind(this),e),kn("using timeout",e);var t=If.addPath(this._transUrl,"/"+this._server+"/"+this._generateSessionId()),r=this._transportOptions[n.transportName];kn("transport url",t);var i=new n(t,this._transUrl,r);i.on("message",this._transportMessage.bind(this)),i.once("close",this._transportClose.bind(this)),i.transportName=n.transportName,this._transport=i;return}this._close(2e3,"All transports failed",!1)};Tt.prototype._transportTimeout=function(){kn("_transportTimeout"),this.readyState===Tt.CONNECTING&&(this._transport&&this._transport.close(),this._transportClose(2007,"Transport timed out"))};Tt.prototype._transportMessage=function(n){kn("_transportMessage",n);var e=this,t=n.slice(0,1),r=n.slice(1),i;switch(t){case"o":this._open();return;case"h":this.dispatchEvent(new ZT("heartbeat")),kn("heartbeat",this.transport);return}if(r)try{i=AK.parse(r)}catch(a){kn("bad json",r)}if(typeof i=="undefined"){kn("empty payload",r);return}switch(t){case"a":Array.isArray(i)&&i.forEach(function(a){kn("message",e.transport,a),e.dispatchEvent(new SF(a))});break;case"m":kn("message",this.transport,i),this.dispatchEvent(new SF(i));break;case"c":Array.isArray(i)&&i.length===2&&this._close(i[0],i[1],!0);break}};Tt.prototype._transportClose=function(n,e){if(kn("_transportClose",this.transport,n,e),this._transport&&(this._transport.removeAllListeners(),this._transport=null,this.transport=null),!xF(n)&&n!==2e3&&this.readyState===Tt.CONNECTING){this._connect();return}this._close(n,e)};Tt.prototype._open=function(){kn("_open",this._transport&&this._transport.transportName,this.readyState),this.readyState===Tt.CONNECTING?(this._transportTimeoutId&&(clearTimeout(this._transportTimeoutId),this._transportTimeoutId=null),this.readyState=Tt.OPEN,this.transport=this._transport.transportName,this.dispatchEvent(new ZT("open")),kn("connected",this.transport)):this._close(1006,"Server lost session")};Tt.prototype._close=function(n,e,t){kn("_close",this.transport,n,e,t,this.readyState);var r=!1;if(this._ir&&(r=!0,this._ir.close(),this._ir=null),this._transport&&(this._transport.close(),this._transport=null,this.transport=null),this.readyState===Tt.CLOSED)throw new Error("InvalidStateError: SockJS has already been closed");this.readyState=Tt.CLOSING,setTimeout(function(){this.readyState=Tt.CLOSED,r&&this.dispatchEvent(new ZT("error"));var i=new BK("close");i.wasClean=t||!1,i.code=n||1e3,i.reason=e,this.dispatchEvent(i),this.onmessage=this.onclose=this.onerror=null,kn("disconnected")}.bind(this),0)};Tt.prototype.countRTO=function(n){return n>100?4*n:300+n};CF.exports=function(n){return bF=_K(n),gF()(Tt,n),Tt}});var kF=Ce((eFe,TF)=>{"use strict";var FK=CU();TF.exports=wF()(FK);"_sockjs_onload"in window&&setTimeout(window._sockjs_onload,1)});function fh(n,e){let t=n.length,r=0;for(let i=0;i<t;++i)e(n[i],i,n)&&(n[r]=n[i],++r);n.length=r}function sE(n,e){if(n.length===e)return n;let t=new n.constructor(e);return t.set(n),t}function gd(n,e,t,r){let i=n.length/e,a=n.length*t*r,o=new n.constructor(a),l=n.length*r,c=e,d=e*r;for(let p=0;p<i;++p)for(let m=0;m<e;++m){let y=n[p*e+m],v=p*d+m;for(let b=0;b<t;++b)for(let x=0;x<r;++x)o[b*l+x*c+v]=y}return o}function lE(n,e,t,r=0,i=n.length){for(;r<i;){let a=r+i-1>>1,o=t(e,n[a]);if(o>0)r=a+1;else if(o<0)i=a;else return a}return~r}function cE(n,e,t){let r=e-n;for(;r>0;){let i=Math.floor(r/2),a=n+i;t(a)?r=i:(n=a+1,r-=i+1)}return n}function uE(n,e){let t=[];for(let r=0,i=n.length;r<i;++r)n[r]===e&&t.push(r);return t}function Ee(n,e){let t=n.length;if(e.length!==t)return!1;for(let r=0;r<t;++r)if(n[r]!==e[r])return!1;return!0}function yd(n,e,t=(r,i)=>r===i){let r=n.length;if(e.length!==r)return!1;for(let i=0;i<r;++i)if(!t(n[i],e[i]))return!1;return!0}function dE(n,e,t){let r=[];if(t===e){for(let i=0;i<n;++i)r[i]=i;return r}r[t]=e;for(let i=0,a=0;i<n;){if(i===e){++i;continue}a===t&&++a,r[a++]=i++}return r}function uS(n,e,t){for(let r=0,i=t.length;r<i;++r){let a=t[r];a!==-1&&(n[r]=e[a])}return n}function rr(n){let e=[];for(let t=0,r=n.length;t<r;++t){let i=n[t];for(let a=0,o=i.length;a<o;++a){let l=e[a];l===void 0&&(l=e[a]=[]),l.push(i[a])}}return e}function pE(n,e){let t=[],r=0;for(let a=0,o=e.length;a<o;++a){let{retainCount:l,deleteCount:c,insertCount:d}=e[a];l!==0&&(t.push(n.slice(r,r+l)),r+=l),r+=c,d!==0&&t.push(new Array(d))}let i=n.length;return r!==i&&t.push(n.slice(r)),new Array(0).concat(...t)}function fE(n,e,t){let r=[],i=0,a=0,o=n.length,l=e.length;for(;i<o&&a<l;){let c,d=n[i],p=e[a];if(c=t(d,p),c===0){let m=1;for(++i,++a;i<o&&a<l&&(c=t(n[i],e[a]))===0;)++m,++i,++a;r.push({retainCount:m,deleteCount:0,insertCount:0});continue}if(c<0){let m=1;for(;++i<o&&(c=t(n[i],p))<0;)++m;r.push({retainCount:0,deleteCount:m,insertCount:0});continue}if(c>0){let m=1;for(;++a<l&&(c=t(d,e[a]))>0;)++m;r.push({retainCount:0,deleteCount:0,insertCount:m});continue}}return(i<o||a<l)&&r.push({retainCount:0,deleteCount:o-i,insertCount:l-a}),r}function hE(n,e,t,r,i,a){let o=0,l=0;if(n!==0&&e!==0)for(;;){let c=t(o,l);if(c<0){if(r(o),++o===n)break}else if(c>0){if(i(l),++l===e)break}else if(a(o,l),++o,++l,o===n||l===e)break}for(;o<n;)r(o),++o;for(;l<e;)i(l),++l}var zE=rt(Ct());var AG=!1;function WE(n){typeof n=="object"?n.dispose():n()}function Xa(n){for(let e=n.length;e>0;--e)WE(n[e-1])}function Gn(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}var z=class{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){if(AG){if(this.refCount===0)debugger;(this.disposedStacks=this.disposedStacks||[]).push(new Error().stack)}--this.refCount==0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let{disposers:e}=this;e!==void 0&&(Xa(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(t!=null){let r=t.indexOf(e);r!==-1&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){this.registerDisposer(Gn(e,t,r,i))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}},Sd=class extends z{constructor(e){super();this.value=e}};function mh(n){return()=>{if(n!==void 0){let e=n;n=void 0,WE(e)}}}var qe=class{constructor(){this.handlers=new Set;this.count=0;let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}};var re=class extends qe{},gh={count:0,add(n){return()=>{}},remove(n){return!1}};var Ge=class{constructor(e){this.value_=e;this.changed=new re}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}},lt=class extends Ge{constructor(e,t,r=e){super(e);this.validator=t;this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let{validator:t}=this;try{this.value=t(e);return}catch(r){}}this.value=this.defaultValue}},hS=class extends z{constructor(e,t){super();this.changed=new re;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}};function mS(n,...e){return new hS(n,e)}var HE=class extends z{constructor(e,t){super();this.changed=new re;this.valueGeneration=-1;this.f=e,this.ws=t;for(let r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}};function ir(n,...e){return new HE(n,e)}var yh=class extends z{constructor(e,t=(r,i)=>r===i){super();this.changed=new qe;this.value=e.value,this.registerDisposer(e.changed.add(()=>{let r=e.value;t(this.value,r)||(this.value=r,this.changed.dispatch())}))}};function fn(n,e,t){let r=new hS(n,e),i=new yh(r,t);return i.registerDisposer(r),i}var bd=class extends z{constructor(e){super();this.changed=new re;let t=e(this),r=Object.keys(t),i=()=>{let a=Array.isArray(t)?[]:{};for(let o of r)a[o]=t[o].value;this.value=a,this.changed.dispatch()};i();for(let a of r){let o=t[a];this.registerDisposer(o.changed.add(()=>i()))}}};var gS=class{constructor(e){this.changed=new re;e===void 0?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){let{values:t}=this;return t.delete(e)?(this.changed.dispatch(),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch())}};function ar(n,...e){let t=e.map(c=>c.value),r=e.length,i=new z,a=n(i,...t),o=(0,zE.default)(()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new z,a=n(i,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),Xa(l),i.dispose()},get value(){return o.flush(),a}}}function Qa(n,...e){let t=e.map(c=>c.value),r=e.length,i=new z,a=n(i,...t),o=()=>{let c=!1;for(let d=0;d<r;++d){let m=e[d].value;t[d]!==m&&(t[d]=m,c=!0)}!c||(i.dispose(),i=new z,a=n(i,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){Xa(l),i.dispose()},get value(){return a}}}function Yr(n){return{changed:gh,value:n}}function Kr(n,e){return n(e.value),e.changed.add(()=>n(e.value))}var Tc=class{constructor(e,t){this.outer=e;this.getInner=t;this.changed=new re;this.update=()=>{let{disposer:e,outer:t}=this;e!==void 0&&e();let r=this.inner=this.getInner(t.value);this.disposer=r.changed.add(this.changed.dispatch),this.changed.dispatch()};e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}},xd=class extends Tc{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}};var vh=new Float32Array(1);function $E(n){vh[0]=n,n=vh[0];for(let e=1;e<21;++e){let t=n.toPrecision(e);if(vh[0]=parseFloat(t),vh[0]===n)return t}return n.toString()}var et=1e-6,It=typeof Float32Array!="undefined"?Float32Array:Array,Br=Math.random;var v7=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var Ft={};wc(Ft,{add:()=>eW,adjoint:()=>FG,clone:()=>RG,copy:()=>_G,create:()=>yS,determinant:()=>GG,equals:()=>iW,exactEquals:()=>rW,frob:()=>ZG,fromMat2d:()=>JG,fromMat4:()=>MG,fromQuat:()=>YG,fromRotation:()=>jG,fromScaling:()=>qG,fromTranslation:()=>$G,fromValues:()=>VG,identity:()=>NG,invert:()=>UG,mul:()=>aW,multiply:()=>jE,multiplyScalar:()=>tW,multiplyScalarAndAdd:()=>nW,normalFromMat4:()=>KG,projection:()=>XG,rotate:()=>zG,scale:()=>HG,set:()=>OG,str:()=>QG,sub:()=>oW,subtract:()=>qE,translate:()=>WG,transpose:()=>BG});function yS(){var n=new It(9);return It!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function MG(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n}function RG(n){var e=new It(9);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e}function _G(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function VG(n,e,t,r,i,a,o,l,c){var d=new It(9);return d[0]=n,d[1]=e,d[2]=t,d[3]=r,d[4]=i,d[5]=a,d[6]=o,d[7]=l,d[8]=c,d}function OG(n,e,t,r,i,a,o,l,c,d){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n}function NG(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function BG(n,e){if(n===e){var t=e[1],r=e[2],i=e[5];n[1]=e[3],n[2]=e[6],n[3]=t,n[5]=e[7],n[6]=r,n[7]=i}else n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8];return n}function UG(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=p*o-l*d,y=-p*a+l*c,v=d*a-o*c,b=t*m+r*y+i*v;return b?(b=1/b,n[0]=m*b,n[1]=(-p*r+i*d)*b,n[2]=(l*r-i*o)*b,n[3]=y*b,n[4]=(p*t-i*c)*b,n[5]=(-l*t+i*a)*b,n[6]=v*b,n[7]=(-d*t+r*c)*b,n[8]=(o*t-r*a)*b,n):null}function FG(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8];return n[0]=o*p-l*d,n[1]=i*d-r*p,n[2]=r*l-i*o,n[3]=l*c-a*p,n[4]=t*p-i*c,n[5]=i*a-t*l,n[6]=a*d-o*c,n[7]=r*c-t*d,n[8]=t*o-r*a,n}function GG(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8];return e*(d*a-o*c)+t*(-d*i+o*l)+r*(c*i-a*l)}function jE(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=t[0],v=t[1],b=t[2],x=t[3],C=t[4],k=t[5],M=t[6],I=t[7],A=t[8];return n[0]=y*r+v*o+b*d,n[1]=y*i+v*l+b*p,n[2]=y*a+v*c+b*m,n[3]=x*r+C*o+k*d,n[4]=x*i+C*l+k*p,n[5]=x*a+C*c+k*m,n[6]=M*r+I*o+A*d,n[7]=M*i+I*l+A*p,n[8]=M*a+I*c+A*m,n}function WG(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=t[0],v=t[1];return n[0]=r,n[1]=i,n[2]=a,n[3]=o,n[4]=l,n[5]=c,n[6]=y*r+v*o+d,n[7]=y*i+v*l+p,n[8]=y*a+v*c+m,n}function zG(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=Math.sin(t),v=Math.cos(t);return n[0]=v*r+y*o,n[1]=v*i+y*l,n[2]=v*a+y*c,n[3]=v*o-y*r,n[4]=v*l-y*i,n[5]=v*c-y*a,n[6]=d,n[7]=p,n[8]=m,n}function HG(n,e,t){var r=t[0],i=t[1];return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=i*e[3],n[4]=i*e[4],n[5]=i*e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n}function $G(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e[0],n[7]=e[1],n[8]=1,n}function jG(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=-t,n[4]=r,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function qG(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=e[1],n[5]=0,n[6]=0,n[7]=0,n[8]=1,n}function JG(n,e){return n[0]=e[0],n[1]=e[1],n[2]=0,n[3]=e[2],n[4]=e[3],n[5]=0,n[6]=e[4],n[7]=e[5],n[8]=1,n}function YG(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,y=i*o,v=i*l,b=i*c,x=a*o,C=a*l,k=a*c;return n[0]=1-m-b,n[3]=p-k,n[6]=y+C,n[1]=p+k,n[4]=1-d-b,n[7]=v-x,n[2]=y-C,n[5]=v+x,n[8]=1-d-m,n}function KG(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15],M=t*l-r*o,I=t*c-i*o,A=t*d-a*o,D=r*c-i*l,E=r*d-a*l,V=i*d-a*c,N=p*x-m*b,U=p*C-y*b,_=p*k-v*b,B=m*C-y*x,R=m*k-v*x,X=y*k-v*C,j=M*X-I*R+A*B+D*_-E*U+V*N;return j?(j=1/j,n[0]=(l*X-c*R+d*B)*j,n[1]=(c*_-o*X-d*U)*j,n[2]=(o*R-l*_+d*N)*j,n[3]=(i*R-r*X-a*B)*j,n[4]=(t*X-i*_+a*U)*j,n[5]=(r*_-t*R-a*N)*j,n[6]=(x*V-C*E+k*D)*j,n[7]=(C*A-b*V-k*I)*j,n[8]=(b*E-x*A+k*M)*j,n):null}function XG(n,e,t){return n[0]=2/e,n[1]=0,n[2]=0,n[3]=0,n[4]=-2/t,n[5]=0,n[6]=-1,n[7]=1,n[8]=1,n}function QG(n){return"mat3("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+")"}function ZG(n){return Math.hypot(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])}function eW(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n}function qE(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n}function tW(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n}function nW(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n}function rW(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]}function iW(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=e[0],y=e[1],v=e[2],b=e[3],x=e[4],C=e[5],k=e[6],M=e[7],I=e[8];return Math.abs(t-m)<=et*Math.max(1,Math.abs(t),Math.abs(m))&&Math.abs(r-y)<=et*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(i-v)<=et*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(a-b)<=et*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-x)<=et*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(l-C)<=et*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(c-k)<=et*Math.max(1,Math.abs(c),Math.abs(k))&&Math.abs(d-M)<=et*Math.max(1,Math.abs(d),Math.abs(M))&&Math.abs(p-I)<=et*Math.max(1,Math.abs(p),Math.abs(I))}var aW=jE,oW=qE;var ie={};wc(ie,{add:()=>WW,adjoint:()=>hW,clone:()=>lW,copy:()=>cW,create:()=>sW,determinant:()=>mW,equals:()=>jW,exactEquals:()=>$W,frob:()=>GW,fromQuat:()=>RW,fromQuat2:()=>DW,fromRotation:()=>TW,fromRotationTranslation:()=>KE,fromRotationTranslationScale:()=>AW,fromRotationTranslationScaleOrigin:()=>MW,fromScaling:()=>wW,fromTranslation:()=>CW,fromValues:()=>uW,fromXRotation:()=>kW,fromYRotation:()=>LW,fromZRotation:()=>EW,frustum:()=>_W,getRotation:()=>IW,getScaling:()=>XE,getTranslation:()=>PW,identity:()=>JE,invert:()=>fW,lookAt:()=>BW,mul:()=>qW,multiply:()=>YE,multiplyScalar:()=>zW,multiplyScalarAndAdd:()=>HW,ortho:()=>NW,perspective:()=>VW,perspectiveFromFieldOfView:()=>OW,rotate:()=>vW,rotateX:()=>SW,rotateY:()=>bW,rotateZ:()=>xW,scale:()=>yW,set:()=>dW,str:()=>FW,sub:()=>JW,subtract:()=>QE,targetTo:()=>UW,translate:()=>gW,transpose:()=>pW});function sW(){var n=new It(16);return It!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function lW(n){var e=new It(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function cW(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function uW(n,e,t,r,i,a,o,l,c,d,p,m,y,v,b,x){var C=new It(16);return C[0]=n,C[1]=e,C[2]=t,C[3]=r,C[4]=i,C[5]=a,C[6]=o,C[7]=l,C[8]=c,C[9]=d,C[10]=p,C[11]=m,C[12]=y,C[13]=v,C[14]=b,C[15]=x,C}function dW(n,e,t,r,i,a,o,l,c,d,p,m,y,v,b,x,C){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n[4]=a,n[5]=o,n[6]=l,n[7]=c,n[8]=d,n[9]=p,n[10]=m,n[11]=y,n[12]=v,n[13]=b,n[14]=x,n[15]=C,n}function JE(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function pW(n,e){if(n===e){var t=e[1],r=e[2],i=e[3],a=e[6],o=e[7],l=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=r,n[9]=a,n[11]=e[14],n[12]=i,n[13]=o,n[14]=l}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function fW(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15],M=t*l-r*o,I=t*c-i*o,A=t*d-a*o,D=r*c-i*l,E=r*d-a*l,V=i*d-a*c,N=p*x-m*b,U=p*C-y*b,_=p*k-v*b,B=m*C-y*x,R=m*k-v*x,X=y*k-v*C,j=M*X-I*R+A*B+D*_-E*U+V*N;return j?(j=1/j,n[0]=(l*X-c*R+d*B)*j,n[1]=(i*R-r*X-a*B)*j,n[2]=(x*V-C*E+k*D)*j,n[3]=(y*E-m*V-v*D)*j,n[4]=(c*_-o*X-d*U)*j,n[5]=(t*X-i*_+a*U)*j,n[6]=(C*A-b*V-k*I)*j,n[7]=(p*V-y*A+v*I)*j,n[8]=(o*R-l*_+d*N)*j,n[9]=(r*_-t*R-a*N)*j,n[10]=(b*E-x*A+k*M)*j,n[11]=(m*A-p*E-v*M)*j,n[12]=(l*U-o*B-c*N)*j,n[13]=(t*B-r*U+i*N)*j,n[14]=(x*I-b*D-C*M)*j,n[15]=(p*D-m*I+y*M)*j,n):null}function hW(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15];return n[0]=l*(y*k-v*C)-m*(c*k-d*C)+x*(c*v-d*y),n[1]=-(r*(y*k-v*C)-m*(i*k-a*C)+x*(i*v-a*y)),n[2]=r*(c*k-d*C)-l*(i*k-a*C)+x*(i*d-a*c),n[3]=-(r*(c*v-d*y)-l*(i*v-a*y)+m*(i*d-a*c)),n[4]=-(o*(y*k-v*C)-p*(c*k-d*C)+b*(c*v-d*y)),n[5]=t*(y*k-v*C)-p*(i*k-a*C)+b*(i*v-a*y),n[6]=-(t*(c*k-d*C)-o*(i*k-a*C)+b*(i*d-a*c)),n[7]=t*(c*v-d*y)-o*(i*v-a*y)+p*(i*d-a*c),n[8]=o*(m*k-v*x)-p*(l*k-d*x)+b*(l*v-d*m),n[9]=-(t*(m*k-v*x)-p*(r*k-a*x)+b*(r*v-a*m)),n[10]=t*(l*k-d*x)-o*(r*k-a*x)+b*(r*d-a*l),n[11]=-(t*(l*v-d*m)-o*(r*v-a*m)+p*(r*d-a*l)),n[12]=-(o*(m*C-y*x)-p*(l*C-c*x)+b*(l*y-c*m)),n[13]=t*(m*C-y*x)-p*(r*C-i*x)+b*(r*y-i*m),n[14]=-(t*(l*C-c*x)-o*(r*C-i*x)+b*(r*c-i*l)),n[15]=t*(l*y-c*m)-o*(r*y-i*m)+p*(r*c-i*l),n}function mW(n){var e=n[0],t=n[1],r=n[2],i=n[3],a=n[4],o=n[5],l=n[6],c=n[7],d=n[8],p=n[9],m=n[10],y=n[11],v=n[12],b=n[13],x=n[14],C=n[15],k=e*o-t*a,M=e*l-r*a,I=e*c-i*a,A=t*l-r*o,D=t*c-i*o,E=r*c-i*l,V=d*b-p*v,N=d*x-m*v,U=d*C-y*v,_=p*x-m*b,B=p*C-y*b,R=m*C-y*x;return k*R-M*B+I*_+A*U-D*N+E*V}function YE(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=e[8],y=e[9],v=e[10],b=e[11],x=e[12],C=e[13],k=e[14],M=e[15],I=t[0],A=t[1],D=t[2],E=t[3];return n[0]=I*r+A*l+D*m+E*x,n[1]=I*i+A*c+D*y+E*C,n[2]=I*a+A*d+D*v+E*k,n[3]=I*o+A*p+D*b+E*M,I=t[4],A=t[5],D=t[6],E=t[7],n[4]=I*r+A*l+D*m+E*x,n[5]=I*i+A*c+D*y+E*C,n[6]=I*a+A*d+D*v+E*k,n[7]=I*o+A*p+D*b+E*M,I=t[8],A=t[9],D=t[10],E=t[11],n[8]=I*r+A*l+D*m+E*x,n[9]=I*i+A*c+D*y+E*C,n[10]=I*a+A*d+D*v+E*k,n[11]=I*o+A*p+D*b+E*M,I=t[12],A=t[13],D=t[14],E=t[15],n[12]=I*r+A*l+D*m+E*x,n[13]=I*i+A*c+D*y+E*C,n[14]=I*a+A*d+D*v+E*k,n[15]=I*o+A*p+D*b+E*M,n}function gW(n,e,t){var r=t[0],i=t[1],a=t[2],o,l,c,d,p,m,y,v,b,x,C,k;return e===n?(n[12]=e[0]*r+e[4]*i+e[8]*a+e[12],n[13]=e[1]*r+e[5]*i+e[9]*a+e[13],n[14]=e[2]*r+e[6]*i+e[10]*a+e[14],n[15]=e[3]*r+e[7]*i+e[11]*a+e[15]):(o=e[0],l=e[1],c=e[2],d=e[3],p=e[4],m=e[5],y=e[6],v=e[7],b=e[8],x=e[9],C=e[10],k=e[11],n[0]=o,n[1]=l,n[2]=c,n[3]=d,n[4]=p,n[5]=m,n[6]=y,n[7]=v,n[8]=b,n[9]=x,n[10]=C,n[11]=k,n[12]=o*r+p*i+b*a+e[12],n[13]=l*r+m*i+x*a+e[13],n[14]=c*r+y*i+C*a+e[14],n[15]=d*r+v*i+k*a+e[15]),n}function yW(n,e,t){var r=t[0],i=t[1],a=t[2];return n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*a,n[9]=e[9]*a,n[10]=e[10]*a,n[11]=e[11]*a,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function vW(n,e,t,r){var i=r[0],a=r[1],o=r[2],l=Math.hypot(i,a,o),c,d,p,m,y,v,b,x,C,k,M,I,A,D,E,V,N,U,_,B,R,X,j,oe;return l<et?null:(l=1/l,i*=l,a*=l,o*=l,c=Math.sin(t),d=Math.cos(t),p=1-d,m=e[0],y=e[1],v=e[2],b=e[3],x=e[4],C=e[5],k=e[6],M=e[7],I=e[8],A=e[9],D=e[10],E=e[11],V=i*i*p+d,N=a*i*p+o*c,U=o*i*p-a*c,_=i*a*p-o*c,B=a*a*p+d,R=o*a*p+i*c,X=i*o*p+a*c,j=a*o*p-i*c,oe=o*o*p+d,n[0]=m*V+x*N+I*U,n[1]=y*V+C*N+A*U,n[2]=v*V+k*N+D*U,n[3]=b*V+M*N+E*U,n[4]=m*_+x*B+I*R,n[5]=y*_+C*B+A*R,n[6]=v*_+k*B+D*R,n[7]=b*_+M*B+E*R,n[8]=m*X+x*j+I*oe,n[9]=y*X+C*j+A*oe,n[10]=v*X+k*j+D*oe,n[11]=b*X+M*j+E*oe,e!==n&&(n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n)}function SW(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[4],o=e[5],l=e[6],c=e[7],d=e[8],p=e[9],m=e[10],y=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=a*i+d*r,n[5]=o*i+p*r,n[6]=l*i+m*r,n[7]=c*i+y*r,n[8]=d*i-a*r,n[9]=p*i-o*r,n[10]=m*i-l*r,n[11]=y*i-c*r,n}function bW(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[8],p=e[9],m=e[10],y=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i-d*r,n[1]=o*i-p*r,n[2]=l*i-m*r,n[3]=c*i-y*r,n[8]=a*r+d*i,n[9]=o*r+p*i,n[10]=l*r+m*i,n[11]=c*r+y*i,n}function xW(n,e,t){var r=Math.sin(t),i=Math.cos(t),a=e[0],o=e[1],l=e[2],c=e[3],d=e[4],p=e[5],m=e[6],y=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=a*i+d*r,n[1]=o*i+p*r,n[2]=l*i+m*r,n[3]=c*i+y*r,n[4]=d*i-a*r,n[5]=p*i-o*r,n[6]=m*i-l*r,n[7]=y*i-c*r,n}function CW(n,e){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function wW(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function TW(n,e,t){var r=t[0],i=t[1],a=t[2],o=Math.hypot(r,i,a),l,c,d;return o<et?null:(o=1/o,r*=o,i*=o,a*=o,l=Math.sin(e),c=Math.cos(e),d=1-c,n[0]=r*r*d+c,n[1]=i*r*d+a*l,n[2]=a*r*d-i*l,n[3]=0,n[4]=r*i*d-a*l,n[5]=i*i*d+c,n[6]=a*i*d+r*l,n[7]=0,n[8]=r*a*d+i*l,n[9]=i*a*d-r*l,n[10]=a*a*d+c,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function kW(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r,n[6]=t,n[7]=0,n[8]=0,n[9]=-t,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function LW(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=0,n[2]=-t,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=t,n[9]=0,n[10]=r,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function EW(n,e){var t=Math.sin(e),r=Math.cos(e);return n[0]=r,n[1]=t,n[2]=0,n[3]=0,n[4]=-t,n[5]=r,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function KE(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=r+r,c=i+i,d=a+a,p=r*l,m=r*c,y=r*d,v=i*c,b=i*d,x=a*d,C=o*l,k=o*c,M=o*d;return n[0]=1-(v+x),n[1]=m+M,n[2]=y-k,n[3]=0,n[4]=m-M,n[5]=1-(p+x),n[6]=b+C,n[7]=0,n[8]=y+k,n[9]=b-C,n[10]=1-(p+v),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function DW(n,e){var t=new It(3),r=-e[0],i=-e[1],a=-e[2],o=e[3],l=e[4],c=e[5],d=e[6],p=e[7],m=r*r+i*i+a*a+o*o;return m>0?(t[0]=(l*o+p*r+c*a-d*i)*2/m,t[1]=(c*o+p*i+d*r-l*a)*2/m,t[2]=(d*o+p*a+l*i-c*r)*2/m):(t[0]=(l*o+p*r+c*a-d*i)*2,t[1]=(c*o+p*i+d*r-l*a)*2,t[2]=(d*o+p*a+l*i-c*r)*2),KE(n,e,t),n}function PW(n,e){return n[0]=e[12],n[1]=e[13],n[2]=e[14],n}function XE(n,e){var t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=Math.hypot(t,r,i),n[1]=Math.hypot(a,o,l),n[2]=Math.hypot(c,d,p),n}function IW(n,e){var t=new It(3);XE(t,e);var r=1/t[0],i=1/t[1],a=1/t[2],o=e[0]*r,l=e[1]*i,c=e[2]*a,d=e[4]*r,p=e[5]*i,m=e[6]*a,y=e[8]*r,v=e[9]*i,b=e[10]*a,x=o+p+b,C=0;return x>0?(C=Math.sqrt(x+1)*2,n[3]=.25*C,n[0]=(m-v)/C,n[1]=(y-c)/C,n[2]=(l-d)/C):o>p&&o>b?(C=Math.sqrt(1+o-p-b)*2,n[3]=(m-v)/C,n[0]=.25*C,n[1]=(l+d)/C,n[2]=(y+c)/C):p>b?(C=Math.sqrt(1+p-o-b)*2,n[3]=(y-c)/C,n[0]=(l+d)/C,n[1]=.25*C,n[2]=(m+v)/C):(C=Math.sqrt(1+b-o-p)*2,n[3]=(l-d)/C,n[0]=(y+c)/C,n[1]=(m+v)/C,n[2]=.25*C),n}function AW(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=i+i,d=a+a,p=o+o,m=i*c,y=i*d,v=i*p,b=a*d,x=a*p,C=o*p,k=l*c,M=l*d,I=l*p,A=r[0],D=r[1],E=r[2];return n[0]=(1-(b+C))*A,n[1]=(y+I)*A,n[2]=(v-M)*A,n[3]=0,n[4]=(y-I)*D,n[5]=(1-(m+C))*D,n[6]=(x+k)*D,n[7]=0,n[8]=(v+M)*E,n[9]=(x-k)*E,n[10]=(1-(m+b))*E,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function MW(n,e,t,r,i){var a=e[0],o=e[1],l=e[2],c=e[3],d=a+a,p=o+o,m=l+l,y=a*d,v=a*p,b=a*m,x=o*p,C=o*m,k=l*m,M=c*d,I=c*p,A=c*m,D=r[0],E=r[1],V=r[2],N=i[0],U=i[1],_=i[2],B=(1-(x+k))*D,R=(v+A)*D,X=(b-I)*D,j=(v-A)*E,oe=(1-(y+k))*E,me=(C+M)*E,xe=(b+I)*V,se=(C-M)*V,Se=(1-(y+x))*V;return n[0]=B,n[1]=R,n[2]=X,n[3]=0,n[4]=j,n[5]=oe,n[6]=me,n[7]=0,n[8]=xe,n[9]=se,n[10]=Se,n[11]=0,n[12]=t[0]+N-(B*N+j*U+xe*_),n[13]=t[1]+U-(R*N+oe*U+se*_),n[14]=t[2]+_-(X*N+me*U+Se*_),n[15]=1,n}function RW(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t+t,l=r+r,c=i+i,d=t*o,p=r*o,m=r*l,y=i*o,v=i*l,b=i*c,x=a*o,C=a*l,k=a*c;return n[0]=1-m-b,n[1]=p+k,n[2]=y-C,n[3]=0,n[4]=p-k,n[5]=1-d-b,n[6]=v+x,n[7]=0,n[8]=y+C,n[9]=v-x,n[10]=1-d-m,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function _W(n,e,t,r,i,a,o){var l=1/(t-e),c=1/(i-r),d=1/(a-o);return n[0]=a*2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a*2*c,n[6]=0,n[7]=0,n[8]=(t+e)*l,n[9]=(i+r)*c,n[10]=(o+a)*d,n[11]=-1,n[12]=0,n[13]=0,n[14]=o*a*2*d,n[15]=0,n}function VW(n,e,t,r,i){var a=1/Math.tan(e/2),o;return n[0]=a/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==Infinity?(o=1/(r-i),n[10]=(i+r)*o,n[14]=2*i*r*o):(n[10]=-1,n[14]=-2*r),n}function OW(n,e,t,r){var i=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),l=Math.tan(e.rightDegrees*Math.PI/180),c=2/(o+l),d=2/(i+a);return n[0]=c,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=-((o-l)*c*.5),n[9]=(i-a)*d*.5,n[10]=r/(t-r),n[11]=-1,n[12]=0,n[13]=0,n[14]=r*t/(t-r),n[15]=0,n}function NW(n,e,t,r,i,a,o){var l=1/(e-t),c=1/(r-i),d=1/(a-o);return n[0]=-2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*d,n[11]=0,n[12]=(e+t)*l,n[13]=(i+r)*c,n[14]=(o+a)*d,n[15]=1,n}function BW(n,e,t,r){var i,a,o,l,c,d,p,m,y,v,b=e[0],x=e[1],C=e[2],k=r[0],M=r[1],I=r[2],A=t[0],D=t[1],E=t[2];return Math.abs(b-A)<et&&Math.abs(x-D)<et&&Math.abs(C-E)<et?JE(n):(p=b-A,m=x-D,y=C-E,v=1/Math.hypot(p,m,y),p*=v,m*=v,y*=v,i=M*y-I*m,a=I*p-k*y,o=k*m-M*p,v=Math.hypot(i,a,o),v?(v=1/v,i*=v,a*=v,o*=v):(i=0,a=0,o=0),l=m*o-y*a,c=y*i-p*o,d=p*a-m*i,v=Math.hypot(l,c,d),v?(v=1/v,l*=v,c*=v,d*=v):(l=0,c=0,d=0),n[0]=i,n[1]=l,n[2]=p,n[3]=0,n[4]=a,n[5]=c,n[6]=m,n[7]=0,n[8]=o,n[9]=d,n[10]=y,n[11]=0,n[12]=-(i*b+a*x+o*C),n[13]=-(l*b+c*x+d*C),n[14]=-(p*b+m*x+y*C),n[15]=1,n)}function UW(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=r[0],c=r[1],d=r[2],p=i-t[0],m=a-t[1],y=o-t[2],v=p*p+m*m+y*y;v>0&&(v=1/Math.sqrt(v),p*=v,m*=v,y*=v);var b=c*y-d*m,x=d*p-l*y,C=l*m-c*p;return v=b*b+x*x+C*C,v>0&&(v=1/Math.sqrt(v),b*=v,x*=v,C*=v),n[0]=b,n[1]=x,n[2]=C,n[3]=0,n[4]=m*C-y*x,n[5]=y*b-p*C,n[6]=p*x-m*b,n[7]=0,n[8]=p,n[9]=m,n[10]=y,n[11]=0,n[12]=i,n[13]=a,n[14]=o,n[15]=1,n}function FW(n){return"mat4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+", "+n[4]+", "+n[5]+", "+n[6]+", "+n[7]+", "+n[8]+", "+n[9]+", "+n[10]+", "+n[11]+", "+n[12]+", "+n[13]+", "+n[14]+", "+n[15]+")"}function GW(n){return Math.hypot(n[0],n[1],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}function WW(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n[4]=e[4]+t[4],n[5]=e[5]+t[5],n[6]=e[6]+t[6],n[7]=e[7]+t[7],n[8]=e[8]+t[8],n[9]=e[9]+t[9],n[10]=e[10]+t[10],n[11]=e[11]+t[11],n[12]=e[12]+t[12],n[13]=e[13]+t[13],n[14]=e[14]+t[14],n[15]=e[15]+t[15],n}function QE(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n[4]=e[4]-t[4],n[5]=e[5]-t[5],n[6]=e[6]-t[6],n[7]=e[7]-t[7],n[8]=e[8]-t[8],n[9]=e[9]-t[9],n[10]=e[10]-t[10],n[11]=e[11]-t[11],n[12]=e[12]-t[12],n[13]=e[13]-t[13],n[14]=e[14]-t[14],n[15]=e[15]-t[15],n}function zW(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n[4]=e[4]*t,n[5]=e[5]*t,n[6]=e[6]*t,n[7]=e[7]*t,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12]*t,n[13]=e[13]*t,n[14]=e[14]*t,n[15]=e[15]*t,n}function HW(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n[4]=e[4]+t[4]*r,n[5]=e[5]+t[5]*r,n[6]=e[6]+t[6]*r,n[7]=e[7]+t[7]*r,n[8]=e[8]+t[8]*r,n[9]=e[9]+t[9]*r,n[10]=e[10]+t[10]*r,n[11]=e[11]+t[11]*r,n[12]=e[12]+t[12]*r,n[13]=e[13]+t[13]*r,n[14]=e[14]+t[14]*r,n[15]=e[15]+t[15]*r,n}function $W(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]&&n[4]===e[4]&&n[5]===e[5]&&n[6]===e[6]&&n[7]===e[7]&&n[8]===e[8]&&n[9]===e[9]&&n[10]===e[10]&&n[11]===e[11]&&n[12]===e[12]&&n[13]===e[13]&&n[14]===e[14]&&n[15]===e[15]}function jW(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=n[4],l=n[5],c=n[6],d=n[7],p=n[8],m=n[9],y=n[10],v=n[11],b=n[12],x=n[13],C=n[14],k=n[15],M=e[0],I=e[1],A=e[2],D=e[3],E=e[4],V=e[5],N=e[6],U=e[7],_=e[8],B=e[9],R=e[10],X=e[11],j=e[12],oe=e[13],me=e[14],xe=e[15];return Math.abs(t-M)<=et*Math.max(1,Math.abs(t),Math.abs(M))&&Math.abs(r-I)<=et*Math.max(1,Math.abs(r),Math.abs(I))&&Math.abs(i-A)<=et*Math.max(1,Math.abs(i),Math.abs(A))&&Math.abs(a-D)<=et*Math.max(1,Math.abs(a),Math.abs(D))&&Math.abs(o-E)<=et*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-V)<=et*Math.max(1,Math.abs(l),Math.abs(V))&&Math.abs(c-N)<=et*Math.max(1,Math.abs(c),Math.abs(N))&&Math.abs(d-U)<=et*Math.max(1,Math.abs(d),Math.abs(U))&&Math.abs(p-_)<=et*Math.max(1,Math.abs(p),Math.abs(_))&&Math.abs(m-B)<=et*Math.max(1,Math.abs(m),Math.abs(B))&&Math.abs(y-R)<=et*Math.max(1,Math.abs(y),Math.abs(R))&&Math.abs(v-X)<=et*Math.max(1,Math.abs(v),Math.abs(X))&&Math.abs(b-j)<=et*Math.max(1,Math.abs(b),Math.abs(j))&&Math.abs(x-oe)<=et*Math.max(1,Math.abs(x),Math.abs(oe))&&Math.abs(C-me)<=et*Math.max(1,Math.abs(C),Math.abs(me))&&Math.abs(k-xe)<=et*Math.max(1,Math.abs(k),Math.abs(xe))}var qW=YE,JW=QE;var at={};wc(at,{add:()=>m6,calculateW:()=>i6,clone:()=>d6,conjugate:()=>l6,copy:()=>f6,create:()=>IS,dot:()=>v1,equals:()=>x6,exactEquals:()=>b6,exp:()=>h1,fromEuler:()=>c6,fromMat3:()=>g1,fromValues:()=>p6,getAngle:()=>e6,getAxisAngle:()=>Zz,identity:()=>Qz,invert:()=>s6,len:()=>v6,length:()=>S1,lerp:()=>y6,ln:()=>m1,mul:()=>g6,multiply:()=>f1,normalize:()=>AS,pow:()=>a6,random:()=>o6,rotateX:()=>t6,rotateY:()=>n6,rotateZ:()=>r6,rotationTo:()=>C6,scale:()=>y1,set:()=>h6,setAxes:()=>T6,setAxisAngle:()=>p1,slerp:()=>wh,sqlerp:()=>w6,sqrLen:()=>S6,squaredLength:()=>b1,str:()=>u6});var K={};wc(K,{add:()=>QW,angle:()=>vz,bezier:()=>uz,ceil:()=>ZW,clone:()=>YW,copy:()=>KW,create:()=>Sh,cross:()=>wd,dist:()=>Lz,distance:()=>r1,div:()=>kz,divide:()=>n1,dot:()=>bh,equals:()=>Cz,exactEquals:()=>xz,floor:()=>ez,forEach:()=>Pz,fromValues:()=>kc,hermite:()=>cz,inverse:()=>sz,len:()=>vS,length:()=>ZE,lerp:()=>lz,max:()=>nz,min:()=>tz,mul:()=>Tz,multiply:()=>t1,negate:()=>oz,normalize:()=>Cd,random:()=>dz,rotateX:()=>mz,rotateY:()=>gz,rotateZ:()=>yz,round:()=>rz,scale:()=>iz,scaleAndAdd:()=>az,set:()=>XW,sqrDist:()=>Ez,sqrLen:()=>Dz,squaredDistance:()=>i1,squaredLength:()=>a1,str:()=>bz,sub:()=>wz,subtract:()=>e1,transformMat3:()=>fz,transformMat4:()=>pz,transformQuat:()=>hz,zero:()=>Sz});function Sh(){var n=new It(3);return It!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function YW(n){var e=new It(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function ZE(n){var e=n[0],t=n[1],r=n[2];return Math.hypot(e,t,r)}function kc(n,e,t){var r=new It(3);return r[0]=n,r[1]=e,r[2]=t,r}function KW(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n}function XW(n,e,t,r){return n[0]=e,n[1]=t,n[2]=r,n}function QW(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function e1(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function t1(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}function n1(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n}function ZW(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n}function ez(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n}function tz(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n}function nz(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n}function rz(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n}function iz(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function az(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n}function r1(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return Math.hypot(t,r,i)}function i1(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2];return t*t+r*r+i*i}function a1(n){var e=n[0],t=n[1],r=n[2];return e*e+t*t+r*r}function oz(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function sz(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n}function Cd(n,e){var t=e[0],r=e[1],i=e[2],a=t*t+r*r+i*i;return a>0&&(a=1/Math.sqrt(a)),n[0]=e[0]*a,n[1]=e[1]*a,n[2]=e[2]*a,n}function bh(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function wd(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2];return n[0]=i*c-a*l,n[1]=a*o-r*c,n[2]=r*l-i*o,n}function lz(n,e,t,r){var i=e[0],a=e[1],o=e[2];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n}function cz(n,e,t,r,i,a){var o=a*a,l=o*(2*a-3)+1,c=o*(a-2)+a,d=o*(a-1),p=o*(3-2*a);return n[0]=e[0]*l+t[0]*c+r[0]*d+i[0]*p,n[1]=e[1]*l+t[1]*c+r[1]*d+i[1]*p,n[2]=e[2]*l+t[2]*c+r[2]*d+i[2]*p,n}function uz(n,e,t,r,i,a){var o=1-a,l=o*o,c=a*a,d=l*o,p=3*a*l,m=3*c*o,y=c*a;return n[0]=e[0]*d+t[0]*p+r[0]*m+i[0]*y,n[1]=e[1]*d+t[1]*p+r[1]*m+i[1]*y,n[2]=e[2]*d+t[2]*p+r[2]*m+i[2]*y,n}function dz(n,e){e=e||1;var t=Br()*2*Math.PI,r=Br()*2-1,i=Math.sqrt(1-r*r)*e;return n[0]=Math.cos(t)*i,n[1]=Math.sin(t)*i,n[2]=r*e,n}function pz(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[3]*r+t[7]*i+t[11]*a+t[15];return o=o||1,n[0]=(t[0]*r+t[4]*i+t[8]*a+t[12])/o,n[1]=(t[1]*r+t[5]*i+t[9]*a+t[13])/o,n[2]=(t[2]*r+t[6]*i+t[10]*a+t[14])/o,n}function fz(n,e,t){var r=e[0],i=e[1],a=e[2];return n[0]=r*t[0]+i*t[3]+a*t[6],n[1]=r*t[1]+i*t[4]+a*t[7],n[2]=r*t[2]+i*t[5]+a*t[8],n}function hz(n,e,t){var r=t[0],i=t[1],a=t[2],o=t[3],l=e[0],c=e[1],d=e[2],p=i*d-a*c,m=a*l-r*d,y=r*c-i*l,v=i*y-a*m,b=a*p-r*y,x=r*m-i*p,C=o*2;return p*=C,m*=C,y*=C,v*=2,b*=2,x*=2,n[0]=l+p+v,n[1]=c+m+b,n[2]=d+y+x,n}function mz(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function gz(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function yz(n,e,t,r){var i=[],a=[];return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],n[0]=a[0]+t[0],n[1]=a[1]+t[1],n[2]=a[2]+t[2],n}function vz(n,e){var t=kc(n[0],n[1],n[2]),r=kc(e[0],e[1],e[2]);Cd(t,t),Cd(r,r);var i=bh(t,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function Sz(n){return n[0]=0,n[1]=0,n[2]=0,n}function bz(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function xz(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}function Cz(n,e){var t=n[0],r=n[1],i=n[2],a=e[0],o=e[1],l=e[2];return Math.abs(t-a)<=et*Math.max(1,Math.abs(t),Math.abs(a))&&Math.abs(r-o)<=et*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-l)<=et*Math.max(1,Math.abs(i),Math.abs(l))}var wz=e1,Tz=t1,kz=n1,Lz=r1,Ez=i1,vS=ZE,Dz=a1,Pz=function(){var n=Sh();return function(e,t,r,i,a,o){var l,c;for(t||(t=3),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2];return e}}();var or={};wc(or,{add:()=>wS,ceil:()=>Iz,clone:()=>SS,copy:()=>xS,create:()=>o1,cross:()=>Bz,dist:()=>qz,distance:()=>u1,div:()=>jz,divide:()=>c1,dot:()=>LS,equals:()=>PS,exactEquals:()=>DS,floor:()=>Az,forEach:()=>Xz,fromValues:()=>bS,inverse:()=>Nz,len:()=>Yz,length:()=>xh,lerp:()=>ES,max:()=>Rz,min:()=>Mz,mul:()=>$z,multiply:()=>l1,negate:()=>Oz,normalize:()=>kS,random:()=>Uz,round:()=>_z,scale:()=>TS,scaleAndAdd:()=>Vz,set:()=>CS,sqrDist:()=>Jz,sqrLen:()=>Kz,squaredDistance:()=>d1,squaredLength:()=>Ch,str:()=>zz,sub:()=>Hz,subtract:()=>s1,transformMat4:()=>Fz,transformQuat:()=>Gz,zero:()=>Wz});function o1(){var n=new It(4);return It!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function SS(n){var e=new It(4);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e}function bS(n,e,t,r){var i=new It(4);return i[0]=n,i[1]=e,i[2]=t,i[3]=r,i}function xS(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n}function CS(n,e,t,r,i){return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n}function wS(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n}function s1(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n}function l1(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n}function c1(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n}function Iz(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n[3]=Math.ceil(e[3]),n}function Az(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n[2]=Math.floor(e[2]),n[3]=Math.floor(e[3]),n}function Mz(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n[2]=Math.min(e[2],t[2]),n[3]=Math.min(e[3],t[3]),n}function Rz(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n[2]=Math.max(e[2],t[2]),n[3]=Math.max(e[3],t[3]),n}function _z(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n[2]=Math.round(e[2]),n[3]=Math.round(e[3]),n}function TS(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function Vz(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n[2]=e[2]+t[2]*r,n[3]=e[3]+t[3]*r,n}function u1(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return Math.hypot(t,r,i,a)}function d1(n,e){var t=e[0]-n[0],r=e[1]-n[1],i=e[2]-n[2],a=e[3]-n[3];return t*t+r*r+i*i+a*a}function xh(n){var e=n[0],t=n[1],r=n[2],i=n[3];return Math.hypot(e,t,r,i)}function Ch(n){var e=n[0],t=n[1],r=n[2],i=n[3];return e*e+t*t+r*r+i*i}function Oz(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=-e[3],n}function Nz(n,e){return n[0]=1/e[0],n[1]=1/e[1],n[2]=1/e[2],n[3]=1/e[3],n}function kS(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),n[0]=t*o,n[1]=r*o,n[2]=i*o,n[3]=a*o,n}function LS(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3]*e[3]}function Bz(n,e,t,r){var i=t[0]*r[1]-t[1]*r[0],a=t[0]*r[2]-t[2]*r[0],o=t[0]*r[3]-t[3]*r[0],l=t[1]*r[2]-t[2]*r[1],c=t[1]*r[3]-t[3]*r[1],d=t[2]*r[3]-t[3]*r[2],p=e[0],m=e[1],y=e[2],v=e[3];return n[0]=m*d-y*c+v*l,n[1]=-(p*d)+y*o-v*a,n[2]=p*c-m*o+v*i,n[3]=-(p*l)+m*a-y*i,n}function ES(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n[2]=o+r*(t[2]-o),n[3]=l+r*(t[3]-l),n}function Uz(n,e){e=e||1;var t,r,i,a,o,l;do t=Br()*2-1,r=Br()*2-1,o=t*t+r*r;while(o>=1);do i=Br()*2-1,a=Br()*2-1,l=i*i+a*a;while(l>=1);var c=Math.sqrt((1-o)/l);return n[0]=e*t,n[1]=e*r,n[2]=e*i*c,n[3]=e*a*c,n}function Fz(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3];return n[0]=t[0]*r+t[4]*i+t[8]*a+t[12]*o,n[1]=t[1]*r+t[5]*i+t[9]*a+t[13]*o,n[2]=t[2]*r+t[6]*i+t[10]*a+t[14]*o,n[3]=t[3]*r+t[7]*i+t[11]*a+t[15]*o,n}function Gz(n,e,t){var r=e[0],i=e[1],a=e[2],o=t[0],l=t[1],c=t[2],d=t[3],p=d*r+l*a-c*i,m=d*i+c*r-o*a,y=d*a+o*i-l*r,v=-o*r-l*i-c*a;return n[0]=p*d+v*-o+m*-c-y*-l,n[1]=m*d+v*-l+y*-o-p*-c,n[2]=y*d+v*-c+p*-l-m*-o,n[3]=e[3],n}function Wz(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=0,n}function zz(n){return"vec4("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}function DS(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]}function PS(n,e){var t=n[0],r=n[1],i=n[2],a=n[3],o=e[0],l=e[1],c=e[2],d=e[3];return Math.abs(t-o)<=et*Math.max(1,Math.abs(t),Math.abs(o))&&Math.abs(r-l)<=et*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=et*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-d)<=et*Math.max(1,Math.abs(a),Math.abs(d))}var Hz=s1,$z=l1,jz=c1,qz=u1,Jz=d1,Yz=xh,Kz=Ch,Xz=function(){var n=o1();return function(e,t,r,i,a,o){var l,c;for(t||(t=4),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],n[3]=e[l+3],a(n,n,o),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2],e[l+3]=n[3];return e}}();function IS(){var n=new It(4);return It!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function Qz(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function p1(n,e,t){t=t*.5;var r=Math.sin(t);return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=Math.cos(t),n}function Zz(n,e){var t=Math.acos(e[3])*2,r=Math.sin(t/2);return r>et?(n[0]=e[0]/r,n[1]=e[1]/r,n[2]=e[2]/r):(n[0]=1,n[1]=0,n[2]=0),t}function e6(n,e){var t=v1(n,e);return Math.acos(2*t*t-1)}function f1(n,e,t){var r=e[0],i=e[1],a=e[2],o=e[3],l=t[0],c=t[1],d=t[2],p=t[3];return n[0]=r*p+o*l+i*d-a*c,n[1]=i*p+o*c+a*l-r*d,n[2]=a*p+o*d+r*c-i*l,n[3]=o*p-r*l-i*c-a*d,n}function t6(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+o*l,n[1]=i*c+a*l,n[2]=a*c-i*l,n[3]=o*c-r*l,n}function n6(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c-a*l,n[1]=i*c+o*l,n[2]=a*c+r*l,n[3]=o*c-i*l,n}function r6(n,e,t){t*=.5;var r=e[0],i=e[1],a=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+i*l,n[1]=i*c-r*l,n[2]=a*c+o*l,n[3]=o*c-a*l,n}function i6(n,e){var t=e[0],r=e[1],i=e[2];return n[0]=t,n[1]=r,n[2]=i,n[3]=Math.sqrt(Math.abs(1-t*t-r*r-i*i)),n}function h1(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=Math.exp(a),c=o>0?l*Math.sin(o)/o:0;return n[0]=t*c,n[1]=r*c,n[2]=i*c,n[3]=l*Math.cos(o),n}function m1(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=Math.sqrt(t*t+r*r+i*i),l=o>0?Math.atan2(o,a)/o:0;return n[0]=t*l,n[1]=r*l,n[2]=i*l,n[3]=.5*Math.log(t*t+r*r+i*i+a*a),n}function a6(n,e,t){return m1(n,e),y1(n,n,t),h1(n,n),n}function wh(n,e,t,r){var i=e[0],a=e[1],o=e[2],l=e[3],c=t[0],d=t[1],p=t[2],m=t[3],y,v,b,x,C;return v=i*c+a*d+o*p+l*m,v<0&&(v=-v,c=-c,d=-d,p=-p,m=-m),1-v>et?(y=Math.acos(v),b=Math.sin(y),x=Math.sin((1-r)*y)/b,C=Math.sin(r*y)/b):(x=1-r,C=r),n[0]=x*i+C*c,n[1]=x*a+C*d,n[2]=x*o+C*p,n[3]=x*l+C*m,n}function o6(n){var e=Br(),t=Br(),r=Br(),i=Math.sqrt(1-e),a=Math.sqrt(e);return n[0]=i*Math.sin(2*Math.PI*t),n[1]=i*Math.cos(2*Math.PI*t),n[2]=a*Math.sin(2*Math.PI*r),n[3]=a*Math.cos(2*Math.PI*r),n}function s6(n,e){var t=e[0],r=e[1],i=e[2],a=e[3],o=t*t+r*r+i*i+a*a,l=o?1/o:0;return n[0]=-t*l,n[1]=-r*l,n[2]=-i*l,n[3]=a*l,n}function l6(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n}function g1(n,e){var t=e[0]+e[4]+e[8],r;if(t>0)r=Math.sqrt(t+1),n[3]=.5*r,r=.5/r,n[0]=(e[5]-e[7])*r,n[1]=(e[6]-e[2])*r,n[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;r=Math.sqrt(e[i*3+i]-e[a*3+a]-e[o*3+o]+1),n[i]=.5*r,r=.5/r,n[3]=(e[a*3+o]-e[o*3+a])*r,n[a]=(e[a*3+i]+e[i*3+a])*r,n[o]=(e[o*3+i]+e[i*3+o])*r}return n}function c6(n,e,t,r){var i=.5*Math.PI/180;e*=i,t*=i,r*=i;var a=Math.sin(e),o=Math.cos(e),l=Math.sin(t),c=Math.cos(t),d=Math.sin(r),p=Math.cos(r);return n[0]=a*c*p-o*l*d,n[1]=o*l*p+a*c*d,n[2]=o*c*d-a*l*p,n[3]=o*c*p+a*l*d,n}function u6(n){return"quat("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")"}var d6=SS,p6=bS,f6=xS,h6=CS,m6=wS,g6=f1,y1=TS,v1=LS,y6=ES,S1=xh,v6=S1,b1=Ch,S6=b1,AS=kS,b6=DS,x6=PS,C6=function(){var n=Sh(),e=kc(1,0,0),t=kc(0,1,0);return function(r,i,a){var o=bh(i,a);return o<-.999999?(wd(n,e,i),vS(n)<1e-6&&wd(n,t,i),Cd(n,n),p1(r,n,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(wd(n,i,a),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=1+o,AS(r,r))}}(),w6=function(){var n=IS(),e=IS();return function(t,r,i,a,o,l){return wh(n,r,o,l),wh(e,i,a,l),wh(t,n,e,2*l*(1-l)),t}}(),T6=function(){var n=yS();return function(e,t,r,i){return n[0]=r[0],n[3]=r[1],n[6]=r[2],n[1]=i[0],n[4]=i[1],n[7]=i[2],n[2]=-t[0],n[5]=-t[1],n[8]=-t[2],AS(e,g1(e,n))}}();var Tr={};wc(Tr,{add:()=>P6,angle:()=>Y6,ceil:()=>I6,clone:()=>k6,copy:()=>E6,create:()=>x1,cross:()=>G6,dist:()=>iH,distance:()=>k1,div:()=>rH,divide:()=>T1,dot:()=>F6,equals:()=>Z6,exactEquals:()=>Q6,floor:()=>A6,forEach:()=>sH,fromValues:()=>L6,inverse:()=>B6,len:()=>eH,length:()=>E1,lerp:()=>W6,max:()=>R6,min:()=>M6,mul:()=>nH,multiply:()=>w1,negate:()=>N6,normalize:()=>U6,random:()=>z6,rotate:()=>J6,round:()=>_6,scale:()=>V6,scaleAndAdd:()=>O6,set:()=>D6,sqrDist:()=>aH,sqrLen:()=>oH,squaredDistance:()=>L1,squaredLength:()=>D1,str:()=>X6,sub:()=>tH,subtract:()=>C1,transformMat2:()=>H6,transformMat2d:()=>$6,transformMat3:()=>j6,transformMat4:()=>q6,zero:()=>K6});function x1(){var n=new It(2);return It!=Float32Array&&(n[0]=0,n[1]=0),n}function k6(n){var e=new It(2);return e[0]=n[0],e[1]=n[1],e}function L6(n,e){var t=new It(2);return t[0]=n,t[1]=e,t}function E6(n,e){return n[0]=e[0],n[1]=e[1],n}function D6(n,e,t){return n[0]=e,n[1]=t,n}function P6(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}function C1(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n}function w1(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n}function T1(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n}function I6(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n}function A6(n,e){return n[0]=Math.floor(e[0]),n[1]=Math.floor(e[1]),n}function M6(n,e,t){return n[0]=Math.min(e[0],t[0]),n[1]=Math.min(e[1],t[1]),n}function R6(n,e,t){return n[0]=Math.max(e[0],t[0]),n[1]=Math.max(e[1],t[1]),n}function _6(n,e){return n[0]=Math.round(e[0]),n[1]=Math.round(e[1]),n}function V6(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n}function O6(n,e,t,r){return n[0]=e[0]+t[0]*r,n[1]=e[1]+t[1]*r,n}function k1(n,e){var t=e[0]-n[0],r=e[1]-n[1];return Math.hypot(t,r)}function L1(n,e){var t=e[0]-n[0],r=e[1]-n[1];return t*t+r*r}function E1(n){var e=n[0],t=n[1];return Math.hypot(e,t)}function D1(n){var e=n[0],t=n[1];return e*e+t*t}function N6(n,e){return n[0]=-e[0],n[1]=-e[1],n}function B6(n,e){return n[0]=1/e[0],n[1]=1/e[1],n}function U6(n,e){var t=e[0],r=e[1],i=t*t+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=e[0]*i,n[1]=e[1]*i,n}function F6(n,e){return n[0]*e[0]+n[1]*e[1]}function G6(n,e,t){var r=e[0]*t[1]-e[1]*t[0];return n[0]=n[1]=0,n[2]=r,n}function W6(n,e,t,r){var i=e[0],a=e[1];return n[0]=i+r*(t[0]-i),n[1]=a+r*(t[1]-a),n}function z6(n,e){e=e||1;var t=Br()*2*Math.PI;return n[0]=Math.cos(t)*e,n[1]=Math.sin(t)*e,n}function H6(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i,n[1]=t[1]*r+t[3]*i,n}function $6(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[2]*i+t[4],n[1]=t[1]*r+t[3]*i+t[5],n}function j6(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[3]*i+t[6],n[1]=t[1]*r+t[4]*i+t[7],n}function q6(n,e,t){var r=e[0],i=e[1];return n[0]=t[0]*r+t[4]*i+t[12],n[1]=t[1]*r+t[5]*i+t[13],n}function J6(n,e,t,r){var i=e[0]-t[0],a=e[1]-t[1],o=Math.sin(r),l=Math.cos(r);return n[0]=i*l-a*o+t[0],n[1]=i*o+a*l+t[1],n}function Y6(n,e){var t=n[0],r=n[1],i=e[0],a=e[1],o=t*t+r*r;o>0&&(o=1/Math.sqrt(o));var l=i*i+a*a;l>0&&(l=1/Math.sqrt(l));var c=(t*i+r*a)*o*l;return c>1?0:c<-1?Math.PI:Math.acos(c)}function K6(n){return n[0]=0,n[1]=0,n}function X6(n){return"vec2("+n[0]+", "+n[1]+")"}function Q6(n,e){return n[0]===e[0]&&n[1]===e[1]}function Z6(n,e){var t=n[0],r=n[1],i=e[0],a=e[1];return Math.abs(t-i)<=et*Math.max(1,Math.abs(t),Math.abs(i))&&Math.abs(r-a)<=et*Math.max(1,Math.abs(r),Math.abs(a))}var eH=E1,tH=C1,nH=w1,rH=T1,iH=k1,aH=L1,oH=D1,sH=function(){var n=x1();return function(e,t,r,i,a,o){var l,c;for(t||(t=2),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],a(n,n,o),e[l]=n[0],e[l+1]=n[1];return e}}();var Th=ie.create(),P1=["x","y","z"],Xr=[K.fromValues(1,0,0),K.fromValues(0,1,0),K.fromValues(0,0,1)],V7=K.fromValues(0,0,0),Td=or.fromValues(0,0,0,0),kh=K.fromValues(1,1,1),O7=K.fromValues(Infinity,Infinity,Infinity),N7=at.create();function kd(n){return n[0]*n[1]*n[2]}function qo(n){return`${n[0]},${n[1]},${n[2]}`}function I1(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[4]*i+t[8]*a,n[1]=t[1]*r+t[5]*i+t[9]*a,n[2]=t[2]*r+t[6]*i+t[10]*a,n}function Lh(n,e,t){let r=e[0],i=e[1],a=e[2];return n[0]=t[0]*r+t[1]*i+t[2]*a,n[1]=t[4]*r+t[5]*i+t[6]*a,n[2]=t[8]*r+t[9]*i+t[10]*a,n}function lH(n,e,t){let r=t.length,i=0;for(let o=0;o<r;++o)i+=(n[o]-e[o])**2;let a=0;for(let o=0;o<r;++o){let l=n[o];a-=(l-t[o])*(e[o]-l)}return a/Math.max(i,1e-6)}function A1(n,e,t,r){let i=n.length,a=lH(e,t,r);a=Math.max(0,Math.min(1,a));for(let o=0;o<i;++o){let l=e[o];n[o]=l+a*(t[o]-l)}return n}function Ys(n,e){let t=e[0],r=e[1],i=e[2],a=e[4],o=e[5],l=e[6],c=e[8],d=e[9],p=e[10];return n[0]=t,n[1]=r,n[2]=i,n[3]=a,n[4]=o,n[5]=l,n[6]=c,n[7]=d,n[8]=p,n}function Ks(n,e){let t=e[0],r=e[1],i=e[2],a=e[3],o=e[4],l=e[5],c=e[6],d=e[7],p=e[8],m=e[9],y=e[10],v=e[11],b=e[12],x=e[13],C=e[14],k=e[15];n[0]=a+t,n[1]=d+o,n[2]=v+p,n[3]=k+b,n[4]=a-t,n[5]=d-o,n[6]=v-p,n[7]=k-b,n[8]=a+r,n[9]=d+l,n[10]=v+m,n[11]=k+x,n[12]=a-r,n[13]=d-l,n[14]=v-m,n[15]=k-x;let M=a+i,I=d+c,A=v+y,D=k+C,E=a-i,V=d-c,N=v-y,U=k-C,_=Math.sqrt(M**2+I**2+A**2);n[16]=M/_,n[17]=I/_,n[18]=A/_,n[19]=D/_;let B=Math.sqrt(E**2+V**2+N**2);return n[20]=E/B,n[21]=V/B,n[22]=N/B,n[23]=U/B,n}function Eh(n,e,t,r,i,a,o){for(let l=0;l<6;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}return!0}function M1(n,e,t,r,i,a,o){for(let l=0;l<4;++l){let c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3];if(Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a)+m<0)return!1}{let l=5,c=o[l*4],d=o[l*4+1],p=o[l*4+2],m=o[l*4+3],y=Math.max(c*n,c*r)+Math.max(d*e,d*i)+Math.max(p*t,p*a),v=Math.min(c*n,c*r)+Math.min(d*e,d*i)+Math.min(p*t,p*a),b=Math.abs(m)*1e-6;if(v>-m+b||y<-m-b)return!1}return!0}function Xs(n,e,t,r=!1){let i=t.length,a=[],o=r?1:e+1,l=r?e+1:1;for(let c=0;c<i;++c){let d=t[c];for(let p=0;p<e;++p)n[p*o+d*l]!==0&&(a[p]=!0)}return uE(a,!0)}function MS(n,e,t){for(let r=0;r<3;++r){let i=t[r];for(let a=0;a<3;++a)n[r+a*3]=i*e[r+a*3]}return n}function R1(n){if(n[15]===1){let o=2/Math.abs(n[10]),l=2/Math.abs(n[0]),c=2/Math.abs(n[5]);return l*c*o}let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return 4/(n[0]*n[5])/3*(Math.abs(i)**3-Math.abs(r)**3)}function Dh(n){if(n[15]===1)return 2/Math.abs(n[10]);let e=n[10],t=n[14],r=2*t/(2*e-2),i=(e-1)*r/(e+1);return Math.abs(i-r)}function _1(n){return n[2]=0,n[6]=0,n[10]=0,n[14]=0,n}var Lc=K.create();function V1(n,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){Lc[0]=2*(t&1)-1,Lc[1]=2*(t>>>1&1)-1,Lc[2]=2*(t>>>2&1)-1,K.transformMat4(Lc,Lc,n);for(let r=0;r<3;++r){let i=Lc[r];e[r]=Math.min(e[r],i),e[r+3]=Math.max(e[r+3],i)}}}function RS(n){return("0"+n.toString(16)).slice(-2)}function O1(n){return Array.prototype.map.call(n,RS).join("")}function N1(n){if(!/^(?:[0-9a-fA-F]{2})*$/.test(n))throw new Error("Invalid hex-encoded string");let e=n.length/2,t=new Uint8Array(e);for(let r=0;r<e;++r)t[r]=parseInt(n.substr(r*2,2),16);return t}function cH(n){let e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{let r=n.match(e);if(r!==null)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),parseFloat(r[4])]}let t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{let r=n.match(t);if(r!==null)return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(n)}.`)}function _S(n){try{if(typeof n!="string")throw new Error(`Expected string, but received ${JSON.stringify(n)}.`);let e=document.createElement("canvas").getContext("2d");e.fillStyle=n;let t=cH(e.fillStyle);return or.fromValues(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function ga(n){return _S(n).subarray(0,3)}function Ld(n){let e=n[3]===void 0?3:4,t=0;for(let r=0;r<e;r++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(n[e-1-r]*255)));return t}function Za(n){return K.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255)}function Ed(n){return or.fromValues((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255,(n>>>24&255)/255)}function In(n){if(n[3]===void 0||n[3]===1){let e="#";for(let t=0;t<3;++t)e+=RS(Math.min(255,Math.max(0,Math.round(n[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(n[t]*255)));return e+=`, ${$E(n[3])})`,e}}function VS(n){return n<=.03928?n/12.92:((n+.055)/1.055)**2.4}function uH(n){let[e,t,r]=n;return .2126*VS(e)+.7152*VS(t)+.0722*VS(r)}function Dd(n){return uH(n)<=.179}var Jo=class extends Ge{constructor(e){super(K.clone(e));this.defaultValue=e}toString(){return In(this.value)}toJSON(){if(!K.equals(this.value,this.defaultValue))return In(this.value)}reset(){this.value=K.clone(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ga(e);K.equals(t,r)||(this.value=r)}},OS=class extends Ge{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(e!==void 0)return In(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}let{value:t}=this,r=ga(e);(t===void 0||!K.equals(t,r))&&(this.value=r)}};var G;(function(c){c[c.UINT8=0]="UINT8",c[c.INT8=1]="INT8",c[c.UINT16=2]="UINT16",c[c.INT16=3]="INT16",c[c.UINT32=4]="UINT32",c[c.INT32=5]="INT32",c[c.UINT64=6]="UINT64",c[c.FLOAT32=7]="FLOAT32"})(G||(G={}));var Ph={[0]:!1,[1]:!0,[2]:!1,[3]:!0,[4]:!1,[5]:!0,[6]:!1,[7]:void 0},Ih={[0]:1,[1]:1,[2]:2,[3]:2,[4]:4,[5]:4,[6]:8,[7]:4},B1={[0]:Uint8Array,[1]:Int8Array,[2]:Uint16Array,[3]:Int16Array,[4]:Uint32Array,[5]:Int32Array,[6]:Uint32Array,[7]:Float32Array},j7={[0]:1,[1]:1,[2]:1,[3]:1,[4]:1,[5]:1,[6]:2,[7]:1};var An;(function(t){t[t.LITTLE=0]="LITTLE",t[t.BIG=1]="BIG"})(An||(An={}));function dH(){let n=Uint16Array.of(4386);return new Uint8Array(n.buffer)[0]===17?1:0}var eo=dH();function pH(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);for(let t=0,r=e.length;t<r;t+=4){let i=e[t];e[t]=e[t+3],e[t+3]=i,i=e[t+1],e[t+1]=e[t+2],e[t+2]=i}}function U1(n,e,t=eo){e!==t&&pH(n)}function jn(n){let e=typeof n;if(e==="number"||e==="string"){let t=parseFloat(""+n);if(!Number.isNaN(t))return t}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(n)}.`)}function ct(n){let e=jn(n);if(Number.isFinite(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function Ah(n){let e=jn(n);if(Number.isFinite(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function Lt(n){let e=ct(n);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function Pd(n,e,t=jn){Z(e),n[0]=n[1]=n[2]=0;for(let r of Object.keys(e))switch(r){case"x":n[0]=t(e[r]);break;case"y":n[1]=t(e[r]);break;case"z":n[2]=t(e[r]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(e)}.`)}return n}function Ec(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let r=0;r<t;++r)if(!Number.isFinite(parseFloat(e[r])))throw new Error("Non-finite value.");for(let r=0;r<t;++r)n[r]=parseFloat(e[r]);return n}function NS(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let r=0;r<t;++r){let i=parseInt(e[r],void 0);if(!Number.isInteger(i))throw new Error("Non-integer value.")}for(let r=0;r<t;++r)n[r]=parseInt(e[r],void 0);return n}function Mn(n){if(typeof n=="object"){if(n===null)return"null";if(Array.isArray(n)){let a="[",o=n.length,l=0;if(l<o)for(a+=Mn(n[l]);++l<o;)a+=",",a+=Mn(n[l]);return a+="]",a}let e="{",t=Object.keys(n).sort(),r=0,i=t.length;if(r<i){let a=t[r];for(e+=JSON.stringify(a),e+=":",e+=Mn(n[a]);++r<i;)e+=",",a=t[r],e+=JSON.stringify(a),e+=":",e+=Mn(n[a])}return e+="}",e}return JSON.stringify(n)}var F1=/('(?:[^'\\]|(?:\\.))*')/,G1=/("(?:[^"\\]|(?:\\.))*")/,fH=new RegExp(`${F1.source}|${G1.source}`),hH=new RegExp(`${G1.source}|${F1.source}`),mH=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,gH=/^((?:[^"'\\]|(?:\\.))*)'/;function yH(n,e,t,r){if(n.length>=2&&n.charAt(0)===e&&n.charAt(n.length-1)===e){let i=n.substr(1,n.length-2),a=t;for(;i.length>0;){let o=i.match(r);if(o===null){a+=i;break}a+=o[1],o[2]===t?(a+="\\",a+=t):a+=e,i=i.substr(o.index+o[0].length)}return a+=t,a}return n}function vH(n,e,t){let r=/[&_,]/g,i,a,o;t==='"'?(i="'",a=mH,o=fH):(i='"',a=gH,o=hH);let l="";for(;n.length>0;){let c=n.match(o),d,p;if(c===null)d=n,n="",p="";else{d=n.substr(0,c.index),n=n.substr(c.index+c[0].length);let m=c[1];m!==void 0?p=yH(m,i,t,a):p=c[2]}l+=d.replace(r,e),l+=p}return l}function SH(n){return vH(n,",",'"')}function Mh(n){return JSON.parse(SH(n))}function Qr(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);if(e!==void 0&&n.length!==e)throw new Error(`Expected array of length ${e}, but received: ${JSON.stringify(n)}.`);return n}function Te(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${JSON.stringify(n)}.`);return n.map(e)}function Je(n,e,t){let r=n.length;if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected length ${r} array, but received: ${JSON.stringify(e)}.`);for(let i=0;i<r;++i)n[i]=t(e[i],i);return n}function Z(n){if(typeof n!="object"||n==null||Array.isArray(n))throw new Error(`Expected JSON object, but received: ${JSON.stringify(n)}.`);return n}function ft(n){let e=parseInt(n,10);if(!Number.isInteger(e))throw new Error(`Expected integer, but received: ${JSON.stringify(n)}.`);return e}function Bt(n){let e=ft(n);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function Rh(n,e){let t=e.get(n);if(t===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(e.keys()))}, but received: ${JSON.stringify(n)}.`);return t}function ae(n){if(typeof n!="string")throw new Error(`Expected string, but received: ${JSON.stringify(n)}.`);return n}function rn(n){if(n!==void 0)return ae(n)}function mi(n){if(n!==void 0)return ft(n)}function W1(n){if(n!==void 0){if(typeof n=="boolean")return n;if(n==="true")return!0;if(n==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(n)}`)}}function $(n,e,t){let r=Object.prototype.hasOwnProperty.call(n,e)?n[e]:void 0;try{return t(r)}catch(i){throw new Error(`Error parsing ${JSON.stringify(e)} property: ${i.message}`)}}function pe(n,e,t,r){return $(n,e,i=>i===void 0?r:t(i))}function Vi(n,e){Z(n);let t=new Map;for(let r of Object.keys(n))try{t.set(r,e(n[r]))}catch(i){throw new Error(`Error parsing value associated with key ${JSON.stringify(r)}: ${i.message}`)}return t}function _h(n){if(typeof n!="number"||!Number.isFinite(n)||n<0||n>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(n)}.`);return n}function gi(n){if(n==="")return{};if(n.startsWith("{"))return Mh(n);{let e={},t=n.split(/[&;]/);for(let r of t){let i=r.match(/^([^=&;]+)=([^&;]*)$/);if(i===null)throw new Error(`Invalid query string part: ${JSON.stringify(r)}.`);e[i[1]]=decodeURIComponent(i[2])}return e}}function z1(n){if(n===void 0)return"";let e=Object.keys(n);return e.length===0?"":e.some(t=>typeof n[t]!="string")?JSON.stringify(n):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(n[t])}`).join("&")}function _t(n,e){if(typeof n=="string"&&n.match(/^[a-zA-Z]/)!==null&&(n=n.toUpperCase(),e.hasOwnProperty(n)))return e[n];throw new Error(`Invalid enum value: ${JSON.stringify(n)}.`)}function H1(n){return Je(K.create(),n,ct)}function $1(n){return Je(K.create(),n,Lt)}function j1(n){return Je(K.create(),n,Bt)}function vn(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(typeof e!="string")throw new Error(`Expected string, received: ${JSON.stringify(e)}.`);return n}function q1(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${JSON.stringify(n)}.`);for(let e of n)if(!Number.isInteger(e))throw new Error(`Expected integer, received: ${JSON.stringify(e)}.`);return n}function ya(n){if(typeof n!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(n)}`);return n}function Oi(n){for(let e in n)return n}var J1=2**-1074,BS=new Float64Array(1),Yo=new Uint32Array(BS.buffer);function Y1(n,e){if(isNaN(n)||isNaN(e))return NaN;if(n===e)return e;if(n===0)return e<0?-J1:J1;BS[0]=n;let t=eo===An.LITTLE?0:1,r=1-t;return e>n==n>0?Yo[t]===4294967295?(Yo[t]=0,Yo[r]+=1):Yo[t]+=1:Yo[t]===0?(Yo[t]=4294967295,Yo[r]-=1):Yo[t]-=1,BS[0]}var US=new Uint32Array(2),Id=4294967296,FS=[];for(let n=2;n<=36;++n){let e=Math.floor(32/Math.log2(n)),t=Math.pow(n,e),r=`^[0-${String.fromCharCode("0".charCodeAt(0)+Math.min(9,n-1))}`;n>10&&(r+=`a-${String.fromCharCode("a".charCodeAt(0)+n-11)}`,r+=`A-${String.fromCharCode("A".charCodeAt(0)+n-11)}`),r+=`]{1,${Math.ceil(64/Math.log2(n))}}$`;let a=new RegExp(r);FS[n]={lowDigits:e,lowBase:t,pattern:a}}function K1(n,e){n>>>=0,e>>>=0;let t=n&65535,r=n>>>16,i=e&65535,a=e>>>16,l=(t*i>>>16)+r*i,c=l>>>16;l=(l&65535)+t*a,c+=l>>>16;let d=c>>>16;return c=(c&65535)+r*a,d+=c>>>16,((d&65535)<<16|c&65535)>>>0}var yi=class{constructor(e=0,t=0){this.low=e;this.high=t}clone(){return new yi(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,r=this.high;if(r===0)return t.toString(e);r*=Id;let{lowBase:i,lowDigits:a}=FS[e],o=r%i;r=Math.floor(r/i),t+=o,r+=Math.floor(t/i),t=t%i;let l=t.toString(e);return r.toString(e)+"0".repeat(a-l.length)+l}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return yi.less(e,t)?e:t}static max(e,t){return yi.less(e,t)?t:e}static random(){return crypto.getRandomValues(US),new yi(US[0],US[1])}tryParseString(e,t=10){let{lowDigits:r,lowBase:i,pattern:a}=FS[t];if(!a.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;let o=e.length-r,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t),d,p;if(i===Id)d=c,p=l;else{let m=Math.imul(c,i)>>>0;d=K1(c,i)+(Math.imul(Math.floor(c/Id),i)>>>0),p=l+m,p>=Id&&(++d,p-=Id)}return p>>>0!==p||d>>>0!==d?!1:(this.low=p,this.high=d,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${JSON.stringify(e)}.`);return this}static parseString(e,t=10){return new yi().parseString(e,t)}valid(){let{low:e,high:t}=this;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i<<r,e.high=a<<r|i>>>32-r):(e.low=0,e.high=i<<r-32),e}static rshift(e,t,r){let{low:i,high:a}=t;return r===0?(e.low=i,e.high=a):r<32?(e.low=i>>>r|a<<32-r,e.high=a>>>r):(e.low=a>>>r-32,e.high=0),e}static or(e,t,r){return e.low=t.low|r.low,e.high=t.high|r.high,e}static xor(e,t,r){return e.low=t.low^r.low,e.high=t.high^r.high,e}static and(e,t,r){return e.low=t.low&r.low,e.high=t.high&r.high,e}static add(e,t,r){let i=t.low+r.low,a=t.high+r.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static addUint32(e,t,r){let i=t.low+r,a=t.high,o=i>>>0;return o!==i&&(a+=1),e.low=o,e.high=a>>>0,e}static decrement(e,t){let{low:r,high:i}=t;return r===0&&(i-=1),e.low=r-1>>>0,e.high=i>>>0,e}static increment(e,t){let{low:r,high:i}=t;return r===4294967295&&(i+=1),e.low=r+1>>>0,e.high=i>>>0,e}static subtract(e,t,r){let i=t.low-r.low,a=t.high-r.high,o=i>>>0;return o!==i&&(a-=1),e.low=o,e.high=a>>>0,e}static absDifference(e,t,r){return yi.less(t,r)?yi.subtract(e,r,t):yi.subtract(e,t,r)}static multiplyUint32(e,t,r){let{low:i,high:a}=t;return e.low=Math.imul(i,r)>>>0,e.high=Math.imul(a,r)+K1(i,r)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}},Q=yi;Q.ZERO=new yi(0,0),Q.ONE=new yi(1,0);var Dc={[G.UINT8]:[0,255],[G.INT8]:[-128,127],[G.UINT16]:[0,65535],[G.INT16]:[-32768,32767],[G.UINT32]:[0,4294967295],[G.INT32]:[-2147483648,2147483647],[G.UINT64]:[Q.ZERO,new Q(4294967295,4294967295)],[G.FLOAT32]:[0,1]};function Ur(n,e){if(typeof e=="number"){let t=n[0],r=n[1];return(e-t)/(r-t)}else{let t=n[0],r=n[1],i;Q.compare(e,t)<0?i=-Q.subtract(Zr,t,e).toNumber():i=Q.subtract(Zr,e,t).toNumber();let a=Q.absDifference(Zr,r,t).toNumber();return Q.compare(t,r)>0&&(a*=-1),i/a}}function va(n,e,t){if(typeof n[0]=="number"){let r=n[0],i=n[1],a=r*(1-t)+i*t;if(e!==G.FLOAT32){let o=Dc[e];a=Math.round(a),a=Math.max(o[0],a),a=Math.min(o[1],a)}return a}else{let r=n[0],i=n[1];Q.compare(r,i)>0&&([r,i]=[i,r],t=1-t);let a=Q.subtract(Zr,i,r).toNumber(),o=new Q;return t<=0?(Zr.setFromNumber(a*-t),Q.subtract(o,r,Q.min(Zr,r))):t>=1?(Zr.setFromNumber(a*(t-1)),Q.add(o,i,Zr),Q.less(o,i)&&(o.low=o.high=4294967295)):(Zr.setFromNumber(a*t),Q.add(o,r,Zr),Q.less(o,r)&&(o.low=o.high=4294967295)),o}}function Qs(n,e){return typeof e=="number"?Math.min(Math.max(n[0],e),n[1]):Q.min(Q.max(n[0],e),n[1])}function Zs(n,e){return[Qs(n,e[0]),Qs(n,e[1])]}function GS(n){if(kr(n[0],n[1])<=0)return n;throw new Error(`Invalid interval: [${n[0]}, ${n[1]}]`)}function X1(n){return kr(n[0],n[1])<=0?n:[n[1],n[0]]}function kr(n,e){return typeof n=="number"?n-e:Q.compare(n,e)}var Zr=new Q,bH=new Q;function Q1(n,e){return typeof e=="number"?Math.abs(e-n[0])<Math.abs(e-n[1])?0:1:Q.less(Q.absDifference(Zr,n[0],e),Q.absDifference(bH,n[1],e))?0:1}function to(n,e){let t;switch(typeof e!="string"?t=""+e:t=e,n){case G.UINT64:return Q.parseString(t);case G.FLOAT32:{let r=parseFloat(t);if(!Number.isFinite(r))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return r}default:{let r=parseInt(t),i=Dc[n];if(!Number.isInteger(r)||r<i[0]||r>i[1])throw new Error(`Invalid ${G[n].toLowerCase()} value: ${JSON.stringify(t)}`);return r}}}function Ad(n,e){return Je(new Array(2),n,t=>to(e,t))}function vi(n,e,t){return n===G.UINT64?Q.equal(e[0],t[0])&&Q.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function WS(n,e,t=Dc[e]){if(!vi(e,n,t))return e===G.UINT64?[n[0].toString(),n[1].toString()]:n}function Md(n,e,t){switch(n){case G.FLOAT32:return Y1(e,t*Infinity);case G.UINT64:let r=e;return t===-1?r.low===0&&r.high===0?r:Q.decrement(new Q,r):r.low===4294967295&&r.high===4294967295?r:Q.increment(new Q,r);default:{let i=Dc[n];return Math.max(i[0],Math.min(i[1],e+t))}}}function Z1(n,e){switch(n){case G.FLOAT32:return 0;case G.UINT64:return .5/Q.absDifference(Zr,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function Pc(n,e){switch(n){case G.FLOAT32:return 1;case G.UINT64:{let t=Q.absDifference(Zr,e[0],e[1]).toNumber();return t/(t+1)}default:{let t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function Vh(n=128){let e=Math.ceil(n/32),t=new Uint32Array(e);crypto.getRandomValues(t);let r="";for(let i=0;i<e;++i)r+=("00000000"+t[i].toString(16)).slice(-8);return r}function eD(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t=65536;for(let r=0,i=e.length;r<i;r+=t)crypto.getRandomValues(e.subarray(r,Math.min(i,r+t)));return n}function zS(){let n=new Uint32Array(1);return crypto.getRandomValues(n),n[0]}var Rd=class extends z{constructor(e){super();this.id=e;this.changed=new re}},ze;(function(i){i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID"})(ze||(ze={}));var Ni=[0,1,2,3],Ko={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, true);dv.setUint8(${e} + 2, ${n} >>> 16);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(n){return Ld(ga(n))},serializeJson(n){return In(Za(n))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, true);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, true);`},deserializeJson(n){return Ld(_S(n))},serializeJson(n){return In(Ed(n))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setFloat32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(n){return jn(n)},serializeJson(n){return n}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(n){return ft(n)},serializeJson(n){return n}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setInt32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(n){return ft(n)},serializeJson(n){return n}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(n){return ft(n)},serializeJson(n){return n}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setInt16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(n){return ft(n)},serializeJson(n){return n}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(n,e){return`dv.setUint8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getUint8(${e});`},deserializeJson(n){return ft(n)},serializeJson(n){return n}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(n,e){return`dv.setInt8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getInt8(${e});`},deserializeJson(n){return ft(n)},serializeJson(n){return n}}};function HS(n,e){let t=0,r=e.length,i=new Array(r);for(let l=0;l<r;++l)i[l]=l;let a=l=>Ko[e[l].type].alignment(n);i.sort((l,c)=>a(c)-a(l));let o=new Array(r);for(let l=0;l<r;++l){let c=i[l],d=e[c],p=Ko[d.type],m=p.serializedBytes(n),y=p.alignment(n);t+=(y-t%y)%y,o[c]=t,t+=m}return t+=(4-t%4)%4,{serializedBytes:t,offsets:o}}var _d=class{constructor(e,t){this.rank=e;this.propertySpecs=t;if(t.length===0){this.serializedBytes=0,this.serialize=this.deserialize=()=>{};return}let r="",i="",{serializedBytes:a,offsets:o}=HS(e,t),l=t.length;for(let c=0;c<l;++c){let d=t[c],p=Ko[d.type],m=`properties[${c}]`,y=`offset + ${o[c]}`;r+=p.serializeCode(m,y,e),i+=p.deserializeCode(m,y,e)}this.serializedBytes=a,this.serialize=new Function("dv","offset","isLittleEndian","properties",r),this.deserialize=new Function("dv","offset","isLittleEndian","properties",i)}};function $S(n,e){let t=n.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:r,enumLabels:i}=n;if(r!==void 0){let a=r.indexOf(e);if(a!==-1)return`${i[a]} (${t})`}return t}function tD(n,e){switch(n.type){case"rgb":return In(Za(e));case"rgba":return In(Ed(e));default:return $S(n,e)}}function xH(n){let e=ae(n);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(n)}`);return e}function CH(n){if(ae(n),!Object.prototype.hasOwnProperty.call(Ko,n))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return n}function wH(n){let e=new Set;for(let t of n){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function TH(n){Z(n);let e=$(n,"id",xH),t=$(n,"type",CH),r=pe(n,"description",ae),i=pe(n,"default",l=>Ko[t].deserializeJson(l),0),a,o;switch(t){case"rgb":case"rgba":break;default:{let l=G[t.toUpperCase()];a=pe(n,"enum_values",c=>Te(c,d=>to(l,d))),a!==void 0&&(o=$(n,"enum_labels",c=>Je(new Array(a.length),c,ae)))}}return{type:t,identifier:e,description:r,default:i,enumValues:a,enumLabels:o}}function kH(n){let e=n.default;return{id:n.identifier,description:n.description,type:n.type,default:e===0?void 0:Ko[n.type].serializeJson(e)}}function nD(n){if(!(n===void 0||n.length===0))return n.map(kH)}function Oh(n){if(n===void 0)return[];let e=Te(n,TH);return wH(e),e}function jS(n,e,t,r,i){for(let a=0;a<r;++a)n.setFloat32(e,i[a],t),e+=4;return e}function qS(n,e,t,r,i,a){return e=jS(n,e,t,r,i),e=jS(n,e,t,r,a),e}function JS(n,e,t,r,i){for(let a=0;a<r;++a)i[a]=n.getFloat32(e,t),e+=4;return e}function YS(n,e,t,r,i,a){return e=JS(n,e,t,r,i),e=JS(n,e,t,r,a),e}var Sn={[1]:{icon:"\uA579",description:"Line",toJSON(n){return{pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}},restoreState(n,e,t){n.pointA=$(e,"pointA",r=>Je(new Float32Array(t),r,ct)),n.pointB=$(e,"pointB",r=>Je(new Float32Array(t),r,ct))},serializedBytes(n){return 2*4*n},serialize(n,e,t,r,i){qS(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return YS(n,e,t,r,a,o),{type:1,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[0]:{icon:"\u26AC",description:"Point",toJSON:n=>({point:Array.from(n.point)}),restoreState:(n,e,t)=>{n.point=$(e,"point",r=>Je(new Float32Array(t),r,ct))},serializedBytes:n=>n*4,serialize:(n,e,t,r,i)=>{jS(n,e,t,r,i.point)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r);return JS(n,e,t,r,a),{type:0,point:a,id:i,properties:[]}},visitGeometry(n,e){e(n.point,!1)}},[2]:{icon:"\u2751",description:"Bounding Box",toJSON:n=>({pointA:Array.from(n.pointA),pointB:Array.from(n.pointB)}),restoreState:(n,e,t)=>{n.pointA=$(e,"pointA",r=>Je(new Float32Array(t),r,ct)),n.pointB=$(e,"pointB",r=>Je(new Float32Array(t),r,ct))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){qS(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return YS(n,e,t,r,a,o),{type:2,pointA:a,pointB:o,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[3]:{icon:"\u25CE",description:"Ellipsoid",toJSON:n=>({center:Array.from(n.center),radii:Array.from(n.radii)}),restoreState:(n,e,t)=>{n.center=$(e,"center",r=>Je(new Float32Array(t),r,ct)),n.radii=$(e,"radii",r=>Je(new Float32Array(t),r,Ah))},serializedBytes:n=>2*4*n,serialize(n,e,t,r,i){qS(n,e,t,r,i.center,i.radii)},deserialize:(n,e,t,r,i)=>{let a=new Float32Array(r),o=new Float32Array(r);return YS(n,e,t,r,a,o),{type:3,center:a,radii:o,id:i,properties:[]}},visitGeometry(n,e){e(n.center,!1),e(n.radii,!0)}}};function Nh(n,e){let t=Sn[n.type].toJSON(n,e.rank);t.type=ze[n.type].toLowerCase(),t.id=n.id,t.description=n.description||void 0;let{relatedSegments:r}=n;if(r!==void 0&&r.some(i=>i.length!==0)&&(t.segments=r.map(i=>i.map(a=>a.toString()))),e.properties.length!==0){let i=e.properties;t.props=n.properties.map((a,o)=>Ko[i[o].type].serializeJson(a))}return t}function LH(n,e,t=!1){Z(n);let r=$(n,"type",c=>_t(c,ze)),i=$(n,"id",t?rn:ae)||Bh(),a=$(n,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);let d=Qr(c);return d.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(d[0])?[Te(d,p=>Q.parseString(p))]:Te(Qr(c,e.relationships.length),p=>Te(p,m=>Q.parseString(m)))}),o=$(n,"props",c=>{let d=e.properties;return c===void 0?d.map(p=>p.default):Te(Qr(c,e.properties.length),(p,m)=>Ko[d[m].type].deserializeJson(p))}),l={id:i,description:$(n,"description",rn),relatedSegments:a,properties:o,type:r};return Sn[r].restoreState(l,n,e.rank),l}var no=class extends z{constructor(e,t=[],r=[]){super();this.relationships=t;this.properties=r;this.annotationMap=new Map;this.changed=new re;this.readonly=!1;this.childAdded=new qe;this.childUpdated=new qe;this.childDeleted=new qe;this.pending=new Set;this.references=new Map;this.rank_=e,this.annotationPropertySerializer=new _d(e,r)}get rank(){return this.rank_}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=Bh();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new Rd(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let r of this)t.has(r.id)||e.push(Nh(r,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&Te(e,r=>{let i=LH(r,this);t.set(i.id,i)});for(let r of this.references.values()){let{id:i}=r,a=t.get(i);r.value=a||null,r.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}},KS=class extends no{constructor(e,t,r){super(e.value.sourceRank,r,t);this.watchableTransform=e;this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let r=e.sourceRank,i=t.sourceRank;if(i===r&&(t.inputSpace===e.inputSpace||Ee(t.inputSpace.ids.slice(0,r),e.inputSpace.ids.slice(0,r))))return;let{ids:a}=e.inputSpace,o=t.inputSpace.ids,l=[];for(let d=0;d<r;++d){let p=o.indexOf(a[d]);p>=i&&(p=-1),l.push(p)}let c=d=>{let p=new Float32Array(r);for(let m=0;m<r;++m){let y=l[m];p[m]=y===-1?0:d[m]}return p};for(let d of this.annotationMap.values())switch(d.type){case 0:d.point=c(d.point);break;case 1:case 2:d.pointA=c(d.pointA),d.pointB=c(d.pointB);break;case 3:d.center=c(d.center),d.radii=c(d.radii);break}this.rank_!==r&&(this.rank_=r,this.annotationPropertySerializer=new _d(this.rank_,this.properties)),this.changed.dispatch()}},EH="Data Bounds";function Bh(){return Vh(160)}function DH(n){return{type:2,id:"data-bounds",description:EH,pointA:new Float32Array(n.lowerBounds),pointB:new Float32Array(n.upperBounds),properties:[]}}function Wn(n){let e=new no(n.lowerBounds.length);return e.readonly=!0,e.add(DH(n)),e}function PH(n,e){let{rank:t}=e,r=0,i=[],a=e.serializedBytes;for(let y of Ni){i[y]=r;let b=n[y].length;r+=(Sn[y].serializedBytes(t)+a)*b,r+=(4-r%4)%4}let o=e.serialize,l=[],c=[],d=new ArrayBuffer(r),p=new DataView(d),m=eo===An.LITTLE;for(let y of Ni){let v=n[y];l[y]=v.map(M=>M.id),c[y]=new Map(v.map((M,I)=>[M.id,I]));let b=Sn[y],x=b.serialize,C=b.serializedBytes(t),k=i[y];for(let M of v)x(p,k,m,t,M),k+=C,o(p,k,m,M.properties),k+=a}return{data:new Uint8Array(d),typeToIds:l,typeToOffset:i,typeToIdMaps:c}}var XS=class{constructor(e){this.propertySerializer=e;this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return PH(this.annotations,this.propertySerializer)}};function QS(n){if(n==null)return n;let{relatedSegments:e}=n;if(e!==void 0)for(let t=0,r=e.length;t<r;++t){let i=e[t];i!==void 0&&(e[t]=i.map(a=>new Q(a.low,a.high)))}return n}function Ye(n){let e=-1;return Object.assign(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,n()}))},{flush:()=>{e!==-1&&(e=-1,n())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}var Ic=class{constructor(){this.map=new Map}get(e,t){let{map:r}=this,i=r.get(e);return i===void 0?(i=t(),i.registerDisposer(()=>{r.delete(e)}),r.set(e,i)):i.addRef(),i}},Vd=class extends Ic{get(e,t){return typeof e!="string"&&(e=Mn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new Sd(t())).value}};var IH=!1;function rD(n){let e={antialias:!1,stencil:!0};IH&&(console.log("DEBUGGING via preserveDrawingBuffer"),e.preserveDrawingBuffer=!0);let t=n.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new Ic,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(let r of["EXT_color_buffer_float"])if(!t.getExtension(r))throw new Error(`${r} extension not available`);for(let r of["EXT_float_blend"])t.getExtension(r);return t}var Ac=class{constructor(){this.width=0;this.height=0;this.logicalWidth=0;this.logicalHeight=0;this.visibleLeftFraction=0;this.visibleTopFraction=0;this.visibleWidthFraction=0;this.visibleHeightFraction=0}};function Uh(n,e){let t=1/n.visibleWidthFraction,r=1/n.visibleHeightFraction,i=-1-(-1+2*n.visibleLeftFraction)*t,a=-1-(-1+2*n.visibleTopFraction)*r;a=-a,e[0]=e[0]*t+e[3]*i,e[4]=e[4]*t+e[7]*i,e[8]=e[8]*t+e[11]*i,e[12]=e[12]*t+e[15]*i,e[1]=e[1]*r+e[3]*a,e[5]=e[5]*r+e[7]*a,e[9]=e[9]*r+e[11]*a,e[13]=e[13]*r+e[15]*a}function Fh(n,e){return n.width===e.width&&n.height===e.height&&n.logicalWidth===e.logicalWidth&&n.logicalHeight===e.logicalHeight&&n.visibleLeftFraction===e.visibleLeftFraction&&n.visibleTopFraction===e.visibleTopFraction}var Gh=class extends z{constructor(e,t,r){super();this.context=e;this.element=t;this.visibility=r;this.boundsGeneration=-1;this.canvasRelativeClippedLeft=0;this.canvasRelativeClippedTop=0;this.canvasRelativeLogicalLeft=0;this.canvasRelativeLogicalTop=0;this.renderViewport=new Ac;this.boundsObserversRegistered=!1;this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){let{context:e}=this;e.ensureBoundsUpdated();let{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;let{element:r}=this;!this.boundsObserversRegistered&&e.monitorPanel(r)&&(this.boundsObserversRegistered=!0);let i=r.getBoundingClientRect(),a=e.container,o=e.canvasRect,{canvas:l}=e,{width:c,height:d}=l,p=c/o.width,m=d/o.height,y=o.left,v=o.top,b=this.canvasRelativeLogicalLeft=Math.round((i.left-y)*p+r.clientLeft),x=this.canvasRelativeLogicalTop=Math.round((i.top-v)*m+r.clientTop),C=r.clientWidth,k=r.clientHeight,M=b+C,I=x+k,A=x,D=b,E=M,V=I;for(let B=r.parentElement;B!==null&&B!==a;B=B.parentElement){let R=B.getBoundingClientRect();R.x===0&&R.y===0&&R.width===0&&R.height===0||(D=Math.max(D,(R.left-y)*p),A=Math.max(A,(R.top-v)*m),E=Math.min(E,(R.right-y)*p),V=Math.min(V,(R.bottom-v)*m))}A=this.canvasRelativeClippedTop=Math.round(Math.max(A,0)),D=this.canvasRelativeClippedLeft=Math.round(Math.max(D,0)),E=Math.round(Math.min(E,c)),V=Math.round(Math.min(V,d));let N=this.renderViewport,U=N.width=Math.max(0,E-D),_=N.height=Math.max(0,V-A);N.logicalWidth=C,N.logicalHeight=k,N.visibleLeftFraction=(D-b)/C,N.visibleTopFraction=(A-x)/k,N.visibleWidthFraction=U/C,N.visibleHeightFraction=_/k}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:r,renderViewport:{width:i,height:a}}=this,o=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let l=this.context.canvas.height-o;e.viewport(r,l,i,a),e.scissor(r,l,i,a)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:r,logicalWidth:i,logicalHeight:a}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+a),i,a),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+r),t,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}},Wh=class extends Gh{constructor(e,t,r){super(e,t,r);this.canvas=document.createElement("canvas");this.canvasRenderingContext=this.canvas.getContext("2d");let{canvas:i}=this;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:r,logicalHeight:i}=e;t.width=r,t.height=i;let{canvasRenderingContext:a}=this;a==null||a.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,r,i,0,0,r,i)}},ZS=class extends lt{constructor(){super(Float64Array.of(0,0,1,1),e=>Je(new Float64Array(4),e,_h))}toJSON(){let{value:e}=this,[t,r,i,a]=e;if(!(t===0&&r==0&&i===1&&a===1))return Array.from(e)}},eb=class extends z{constructor(e){super();this.container=e;this.canvas=document.createElement("canvas");this.updateStarted=new re;this.updateFinished=new re;this.changed=this.updateFinished;this.panels=new Set;this.resizeGeneration=0;this.boundsGeneration=-1;this.orderedPanels=[];this.frameNumber=0;this.panelAncestors=new Map;this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()};this.resizeObserver=new ResizeObserver(this.resizeCallback);this.scheduleRedraw=this.registerCancellable(Ye(()=>this.draw()));let{canvas:t,resizeObserver:r}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",r.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",i=>{console.log(`Lost WebGL context: ${i.statusMessage}`),i.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=rD(t)}monitorPanel(e){let{panelAncestors:t,container:r}=this;if(!r.contains(e))return!1;for(;e!==r;){let i=t.get(e);if(i!==void 0){++i.count;break}let a=e.parentElement;i={parent:a,count:1},t.set(e,i),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=a}return!0}unmonitorPanel(e){let{panelAncestors:t,container:r}=this;for(;e!==r;){let i=t.get(e);if(i.count!==1){--i.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=i.parent}}applyWindowedViewportToElement(e,t){let[r,i,a,o]=t,l=1/a,c=1/o;e.style.position="absolute",e.style.top=`${-c*i*100}%`,e.style.left=`${-l*r*100}%`,e.style.width=`${l*100}%`,e.style.height=`${c*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels)if(!!e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:t,panels:r}=this;t.length!==r.size&&(t.push(...r),t.sort((i,a)=>i.drawOrder-a.drawOrder));for(let i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();let{renderViewport:a}=i;a.width===0||a.height===0||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){let{width:e,height:t}=this.canvas,r=new Float32Array(e*t);for(let i of this.panels){if(!i.shouldDraw)continue;let a=i.getDepthArray();if(a===void 0)continue;let{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:l,renderViewport:{width:c,height:d}}=i;for(let p=0;p<d;++p){let m=(d-1-p)*c;r.set(a.subarray(m,m+c),(o+p)*c+l)}}return r}};function Mc(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]+t[i];return n}function zh(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]-t[i];return n}function iD(n,e,t,r){let i=n.length;for(let a=0;a<i;++a)n[a]=e[a]+t[a]*r;return n}function aD(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=e[i]*t;return n}function Rc(n){let e=1;for(let t=0,r=n.length;t<r;++t)e*=n[t];return e}function oD(n,e,t){let r=n.length;for(let i=0;i<r;++i)n[i]=Math.min(e[i],t[i]);return n}var ro=new Float32Array(0),tb=new Float64Array(0),_X=Float64Array.of(1,1,1);var Od=class extends Ac{constructor(){super(...arguments);this.globalPosition=ro;this.projectionMat=ie.create();this.viewMatrix=ie.create();this.invViewMatrix=ie.create();this.viewProjectionMat=ie.create();this.invViewProjectionMat=ie.create()}};function sD(n,e){return n.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&Fh(n,e)&&Ee(n.globalPosition,e.globalPosition)&&Ee(n.projectionMat,e.projectionMat)&&Ee(n.viewMatrix,e.viewMatrix)}function Hh(n){let{viewMatrix:e,viewProjectionMat:t}=n;ie.invert(e,n.invViewMatrix),ie.multiply(t,n.projectionMat,e),ie.invert(n.invViewProjectionMat,t)}function el(n,e,t,r,i,a,o,l,c){for(let d=0;d<o;++d)for(let p=0;p<c;++p){let m=0;for(let y=0;y<l;++y)m+=t[d+r*y]*i[y+a*p];n[d+e*p]=m}return n}function nb(n,e,t){for(let r=0;r<t;++r){let i=e*r;n.fill(0,i,i+t),n[i+r]=1}return n}function sr(n,e,t=e){return nb(new n(e*t),e,Math.min(e,t))}function rb(n,e,t=!0){let r=e.length,i=t?r+1:r,a=new n(i*(r+1));t&&(a[a.length-1]=1);for(let o=0;o<r;++o)a[(i+1)*o]=e[o];return a}function lD(n,e,t){for(let r=0;r<t;++r)for(let i=0;i<t;++i)if(n[r*e+i]!=(r===i?1:0))return!1;return!0}function $h(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=o*r,c=o*e;for(let d=0;d<i;++d)n[c+d]=t[l+d]}return n}function Nd(n,e,t,r){$h(n,e+1,t,r+1,r,r);for(let i=0;i<r;++i)n[(e+1)*e+i]=t[(r+1)*r+i];n[n.length-1]=1;for(let i=r;i<e;++i)n[(e+1)*i+i]=1;return n}var Si;function AH(n,e,t){let r=1;(Si===void 0||Si.length<t)&&(Si=new Uint32Array(t));for(let i=0;i<t;++i)Si[i]=i;for(let i=0;i<t;++i){let a=e*i,o=i;{let d=Math.abs(n[a+i]);for(let p=i+1;p<t;++p){let m=Math.abs(n[a+p]);m>d&&(d=m,o=p)}}if(i!==o){r*=-1;for(let d=0;d<t;++d){let p=e*d,m=n[p+i];n[p+i]=n[p+o],n[p+o]=m}{let d=Si[i];Si[i]=Si[o],Si[o]=d}}let l=n[a+i],c=1/l;r*=l;for(let d=0;d<t;++d)n[e*d+i]*=c;n[a+i]=c;for(let d=0;d<t;++d){if(d===i)continue;let p=-n[e*i+d];for(let m=0;m<t;++m){let y=e*m;n[y+d]+=p*n[y+i]}n[e*i+d]=p*c}}for(let i=0;i<t;++i){let a=Si[i];for(;a!==i;){let o=e*i,l=e*a;for(let d=0;d<t;++d){let p=o+d,m=l+d,y=n[p];n[p]=n[m],n[m]=y}let c=Si[i]=Si[a];Si[a]=a,a=c}}return r}function _c(n,e,t,r,i){return $h(n,e,t,r,i,i),AH(n,e,i)}function cD(n,e,t,r,i,a){for(let o=0;o<a;++o){let l=e*o,c=r*o;for(let d=0;d<i;++d)if(n[l+d]!==t[c+d])return!1}return!0}function ei(n,e,t,r,i){for(let a=0;a<i;++a){let o=e[t*i+a];for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}function jh(n,e,t,r,i){for(let a=0;a<i;++a){let o=0;for(let l=0;l<i;++l)o+=e[t*l+a]*r[l];n[a]=o}return n}var qh=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"c",exponent:-2},{prefix:"m",exponent:-3},{prefix:"\xB5",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],MH=[{prefix:"u",exponent:-6},...qh],Vc=new Map;Vc.set("",{unit:"",exponent:0});var RH=new Map;for(let{prefix:n,exponent:e}of MH){RH.set(e,n);for(let t of["m","s","Hz","rad/s"])Vc.set(`${n}${t}`,{unit:t,exponent:e})}function ib(n){let e=Math.log10(n),t=qh.length,r=cE(0,t,i=>qh[i].exponent<=e);return qh[Math.min(r,t-1)]}function ab(n,e,t={}){let{precision:r=6,elide1:i=!0}=t,a=n,o="";if(e!==""){let c=ib(n);o=c.prefix,a=Bd(n,-c.exponent)}if(i&&a===1)return{scale:"",unit:e,prefix:o};let l;if(r!=0){a<1||a>=1e3?l=a.toPrecision(r):l=a.toFixed(r);let c=l.indexOf("e"),d,p;c!==-1?(d=l.substring(0,c),p=l.substring(c)):(d=l,p="");let m=d.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);m!==null&&(d=d.substring(0,d.length-m[1].length),d.endsWith(".")&&(d=d.substring(0,d.length-1)),l=d+p)}else l=a.toString();return{scale:l,unit:e,prefix:o}}function Bi(n,e,t){let{scale:r,unit:i,prefix:a}=ab(n,e,t);return`${r}${a}${i}`}function Xo(n){if(n==="")return{scale:1,unit:""};let e=n.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;let t=e[1],r=t===void 0?1:Number(t);if(Number.isNaN(r))return;let i="";if(e[2]!==void 0){let a=Vc.get(e[2]);if(a===void 0)return;i=a.unit,a.exponent>0?r*=10**a.exponent:r/=10**-a.exponent}if(!(r<=0||!Number.isFinite(r)))return{scale:r,unit:i}}function Jh(n){let e=Vc.get(n);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(n)}`);return e}function Bd(n,e){return e>=0?n*10**e:n/10**-e}var _H=0;function tl(){return++_H}function VH(n,e){return Ee(n.lowerBounds,e.lowerBounds)&&Ee(n.upperBounds,e.upperBounds)}function OH(n,e){return n===void 0?e===void 0:e===void 0?!1:n.explicit===e.explicit&&Ee(n.coordinates,e.coordinates)&&Ee(n.labels,e.labels)}function NH(n,e){let t=new Map;for(let r=0,i=n.length;r<i;++r)t.set(n[r],e[r]);return n=Array.from(t.keys()),n.sort((r,i)=>r-i),e=Array.from(n,r=>t.get(r)),{coordinates:n,labels:e}}function uD(n){if(n.length===1)return n[0];let e=new Map,t=!1;for(let a of n){a.explicit&&(t=!0);let{coordinates:o,labels:l}=a;for(let c=0,d=o.length;c<d;++c)e.set(o[c],l[c])}let r=Array.from(e.keys());r.sort((a,o)=>a-o);let i=Array.from(r,a=>e.get(a));return{explicit:t,coordinates:r,labels:i}}function dD(n){if(n=n.filter(e=>e!==void 0),n.length!==0)return uD(n)}function BH(n,e){return Ee(n.transform,e.transform)&&VH(n.box,e.box)}function Yh(n,e){return n.valid===e.valid&&n.rank===e.rank&&Ee(n.names,e.names)&&Ee(n.ids,e.ids)&&Ee(n.timestamps,e.timestamps)&&Ee(n.units,e.units)&&Ee(n.scales,e.scales)&&yd(n.boundingBoxes,e.boundingBoxes,BH)&&yd(n.coordinateArrays,e.coordinateArrays,OH)}function He(n){let{names:e,units:t,scales:r}=n,{valid:i=!0,rank:a=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:l=e.map((m,y)=>-y),boundingBoxes:c=[]}=n,{coordinateArrays:d=new Array(a)}=n,{bounds:p=FH(c,a)}=n;return{valid:i,rank:a,names:e,timestamps:o,ids:l,units:t,scales:r,boundingBoxes:c,bounds:p,coordinateArrays:d}}var ti=He({valid:!1,names:[],units:[],scales:tb,boundingBoxes:[]}),Ui=He({valid:!0,names:[],units:[],scales:tb,boundingBoxes:[]});function UH(n){let[e,t]=Qr(n,2),r=Lt(e),i=ae(t),a=Vc.get(i);if(a===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return{unit:a.unit,scale:Bd(r,a.exponent)}}function nl(n,e=!1){if(n===void 0)return ti;Z(n);let t=Fd(Object.keys(n),e),r=t.length,i=new Array(r),a=new Float64Array(r),o=new Array(r);for(let l=0;l<r;++l)$(n,t[l],c=>{if(Array.isArray(c)){let{unit:d,scale:p}=UH(c);i[l]=d,a[l]=p}else{Z(c);let d=$(c,"coordinates",q1),p=$(c,"labels",vn),m=d.length;if(m!==p.length)throw new Error(`Length of coordinates array (${m}) does not match length of labels array (${p.length})`);i[l]="",a[l]=1,o[l]={explicit:!0,...NH(d,p)}}});return He({valid:!1,names:t,units:i,scales:a,coordinateArrays:o})}function ob(n){let{rank:e}=n;if(e===0)return;let{names:t,units:r,scales:i,coordinateArrays:a}=n,o={};for(let l=0;l<e;++l){let c=t[l],d=a[l];(d==null?void 0:d.explicit)?o[c]={coordinates:Array.from(d.coordinates),labels:d.labels}:o[c]=[i[l],r[l]]}return o}var rl=class extends Ge{constructor(){super(ti)}toJSON(){return ob(this.value)}reset(){this.value=ti}restoreState(e){this.value=nl(e)}};function sb(n,e){let t=(n+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,n),e)),t}function pD(n,e){let{lowerBounds:t,upperBounds:r}=e,i=n.length;for(let a=0;a<i;++a)n[a]=sb(t[a],r[a]);return n}function qn(n){let e=n.lowerBounds.length;return{box:n,transform:sr(Float64Array,e,e+1)}}function lb(n,e,t){let{box:{lowerBounds:r,upperBounds:i},transform:a}=n,o=r.length,l=t,c=a[l*o+e],d=c,p=c,m=!1;for(let y=0;y<o;++y){let v=a[l*y+e];if(v===0)continue;let b=v*r[y],x=v*i[y];d+=Math.min(b,x),p+=Math.max(b,x),m=!0}if(!!m)return{lower:d,upper:p}}function FH(n,e){let t=new Float64Array(e),r=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);for(let i of n)for(let a=0;a<e;++a){let o=lb(i,a,e);if(o===void 0)continue;let{lower:l,upper:c}=o;t[a]=t[a]===Number.NEGATIVE_INFINITY?l:Math.min(t[a],l),r[a]=r[a]===Number.POSITIVE_INFINITY?c:Math.max(r[a],c)}return{lowerBounds:t,upperBounds:r}}function GH(n,e,t){let{transform:r,box:i}=n,a=t.length,o=i.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<a;++c){let d=t[c];if(d!==-1)for(let p=0;p<=o;++p)l[p*e+d]=r[p*a+c]}return{transform:l,box:i}}function cb(n,e){let t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*n);return r[e]=1,{transform:r,box:t}}function ub(n,e,t){if(e===t)return n;let{box:r}=n,i=r.lowerBounds.length,a=new Float64Array((i+1)*t);return $h(a,t,n.transform,e,e,i+1),{box:r,transform:a}}function fD(n,e){let{rank:t,sourceRank:r}=n;if(t!==e.rank||r!==e.sourceRank)return!1;let{inputSpace:i}=n,{inputSpace:a}=e;return!Ee(a.scales,i.scales)||!Ee(a.units,i.units)||!Ee(e.outputSpace.names,n.outputSpace.names)?!1:yD(n.transform,t,n.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function Et(n){return{rank:n.rank,sourceRank:n.rank,inputSpace:n,outputSpace:n,transform:sr(Float64Array,n.rank+1)}}function WH(n,e,t,r){let{transform:i,box:a}=n,o=n.box.lowerBounds.length,l=r.length,c=new Float64Array((o+1)*l);for(let d=0;d<l;++d){let p=r[d];for(let y=0;y<o;++y){let v=0;for(let b=0;b<l;++b){let x=t[b];v+=e[(l+1)*b+d]*i[l*y+b]*(x/p)}c[l*y+d]=v}let m=e[(l+1)*l+d];for(let y=0;y<l;++y){let v=t[y];m+=e[(l+1)*y+d]*i[l*o+y]*(v/p)}c[o*l+d]=m}return{transform:c,box:a}}function hD(n,e,t){return n.boundingBoxes.map(r=>WH(r,e,n.scales,t))}function db(n,e,t){let r=He({valid:n.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:hD(n,e,t.scales),coordinateArrays:t.coordinateArrays});return Yh(r,t)?t:r}function pb(n,e=!1){if(e){let t=Number(n);if(Number.isInteger(t)&&t>=0)return!0}return n.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function Oc(n,e=!1){let t=new Set;for(let r of n){if(!pb(r,e)||t.has(r))return!1;t.add(r)}return!0}function Ud(n){let e=n.length,t=new Array(e);t.fill(!0);for(let r=0;r<e;++r){let i=n[r];if(!pb(i)){t[r]=!1;continue}let a=n.indexOf(i,r+1);a!==-1&&(t[r]=!1,t[a]=!1)}return t}function Qo(n){return n.endsWith("'")}function fb(n){return n.endsWith("'")||n.endsWith("^")}function mD(n){return n.endsWith("^")}function gD(n){return!fb(n)}function zH(n,e,t){let r=new Float64Array(n),i=e.length,a=(i+1)*i;for(let o=0;o<i;++o)r[a+o]*=e[o]/t[o];return r}function yD(n,e,t,r,i,a){if(!cD(n,e+1,r,i+1,e,e))return!1;for(let o=0;o<e;++o){let l=n[(e+1)*e+o],c=r[(i+1)*i+o];if(l*(t[o]/a[o])!==c)return!1}for(let o=e;o<i;++o)if(r[(i+1)*i+o]!==0)return!1;for(let o=e;o<i;++o){for(let l=0;l<e;++l)if(r[(i+1)*l+o]!==0)return!1;for(let l=0;l<i;++l){let c=r[(i+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function HH(n,e){if(!e.includes(n))return n;let[,t,r]=n.match(/^([^']*)('?)$/);for(let i=0;;++i){let a=`${t}${i}${r}`;if(!e.includes(a))return a}}function $H(n,e){let{inputSpace:t,transform:r}=n,{ids:i,rank:a}=t,{rank:o,names:l,units:c,scales:d}=e,p=new Array(a);p.fill(!0);let m=[],y=e.ids.map((j,oe)=>{let me=i.indexOf(j);return me!==-1?p[me]=!1:m.push(oe),me}),{outputSpace:v}=n,{names:b,units:x,scales:C,ids:k,timestamps:M,coordinateArrays:I}=v,A=p,D=[],E=[],V=new Float64Array(o),N=[],U=[],_=new Array(o),B=0,R=new Float64Array((o+1)**2);R[R.length-1]=1;for(let j=0;j<a;++j)if(!A[j]){D[B]=b[j],N[B]=k[j],E[B]=x[j],V[B]=C[j],U[B]=M[j],_[B]=I[j];for(let oe=0;oe<o;++oe){let me=y[oe];me!==-1&&(R[oe*(o+1)+B]=r[me*(a+1)+j])}R[o*(o+1)+B]=r[a*(a+1)+j],++B}for(let j of m)N[B]=tl(),D[B]=HH(l[j],D),V[B]=d[j],E[B]=c[j],R[j*(o+1)+B]=1,++B;let X=He({valid:e.valid,rank:o,names:D,ids:N,timestamps:U,units:E,scales:V,boundingBoxes:hD(e,R,V),coordinateArrays:_});return{rank:o,sourceRank:n.sourceRank,inputSpace:e,outputSpace:X,transform:R}}function vD(n){let e=db(n.inputSpace,n.transform,n.outputSpace);return e===n.outputSpace?n:{rank:n.rank,sourceRank:n.sourceRank,inputSpace:n.inputSpace,transform:n.transform,outputSpace:e}}var Kh=class{constructor(e,t=!1){this.mutableSourceRank=t;this.value_=void 0;this.changed=new re;this.inputSpaceChanged=new re;this.defaultTransform=vD(e);let r=this;this.outputSpace={changed:r.changed,get value(){return r.value.outputSpace},set value(i){let{value:a}=r;if(Yh(a.outputSpace,i)||a.rank!==i.rank)return;let o=zH(a.transform,a.outputSpace.scales,i.scales);r.value_={sourceRank:a.sourceRank,rank:a.rank,inputSpace:a.inputSpace,outputSpace:db(a.inputSpace,o,i),transform:o},r.changed.dispatch()}},this.inputSpace={changed:r.inputSpaceChanged,get value(){return r.value.inputSpace},set value(i){let{value:a}=r;Yh(a.inputSpace,i)||(r.value_=$H(a,i),r.inputSpaceChanged.dispatch(),r.changed.dispatch())}}}set value(e){let t=this.value;e!==t&&(this.value_=vD(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:r,inputSpace:i,outputSpace:a,sourceRank:o}=e,{defaultTransform:l,mutableSourceRank:c}=this,{inputSpace:d,rank:p,transform:m,outputSpace:y}=l,{units:v,scales:b}=i,x=o===t&&Ee(b,c?a.scales:d.scales)&&Ee(v,c?a.units:d.units),C=yD(m,p,y.scales,r,t,a.scales),k=Ee(y.names,a.names);if(!(C&&k&&x))return{sourceRank:o,transform:C?void 0:r,outputSpace:e.outputSpace,inputSpace:x?void 0:i}}set transform(e){let{value:t}=this,{inputSpace:r}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:r,transform:e,outputSpace:db(r,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){let B=e.inputSpace||e.outputSpace,R=B.rank,X=He({rank:R,names:B.names.map((j,oe)=>`${oe}`),units:B.units,scales:B.scales,coordinateArrays:B.coordinateArrays});this.value={rank:R,transform:e.transform||sr(Float64Array,R+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:X};return}let{inputSpace:t,sourceRank:r,outputSpace:i,transform:a,rank:o}=this.defaultTransform,{inputSpace:l,sourceRank:c,outputSpace:d,transform:p}=e,m=e.outputSpace.rank,y=t.names,v=l!==void 0?l.names:y,b=new Array(r);for(let B=0;B<r;++B){let R=v.indexOf(y[B]);R>=c&&(R=-1),b[B]=R}let x=m-c+r;for(let B=c;B<m;++B)b[r+B-c]=B;let C=new Float64Array(x),k=new Array(x),M=[];for(let B=0;B<r;++B){let R=b[B];R===-1||l===void 0?(C[B]=t.scales[B],M[B]=t.units[B],k[B]=t.coordinateArrays[B]):(C[B]=l.scales[R],M[B]=l.units[R],k[B]=dD([t.coordinateArrays[B],l.coordinateArrays[R]]))}let I=l||d,A=y.slice(0,r),D=i.names.slice(0,r),E=i.coordinateArrays.slice(0,r),V=new Float64Array(x),N=[];for(let B=0;B<x;++B){let R=b[B];R===-1?(V[B]=i.scales[B],N[B]=i.units[B],E[B]=i.coordinateArrays[B]):(D[B]=d.names[R],N[B]=d.units[R],V[B]=d.scales[R],E[B]=d.coordinateArrays[R])}if(!Oc(D)){this.reset();return}for(let B=r;B<x;++B){let R=B-r+c;C[B]=I.scales[R],M[B]=I.units[R],A[B]=`${B}`}let U=new Float64Array((x+1)**2);U[U.length-1]=1;for(let B=0;B<x;++B){let R=b[B],X;R===-1||p===void 0?B>=r?X=0:X=a[o*(o+1)+B]*(i.scales[B]/V[B]):X=p[m*(m+1)+R],U[x*(x+1)+B]=X;for(let j=0;j<x;++j){let oe=b[j],me;R===-1!=(oe===-1)?me=0:R===-1||p===void 0?R>=r||oe>=r?me=R===oe?1:0:me=a[j*(o+1)+B]:me=p[oe*(m+1)+R],U[j*(x+1)+B]=me}}let _=t.boundingBoxes.map(B=>ub(B,o,x));for(let B=r;B<x;++B)_.push(cb(x,B));for(let B=0;B<x;++B){if(U[x*(x+1)+B]!==0)continue;let X;for(let oe=0;oe<x;++oe){let me=U[oe*(x+1)+B];if(me!==0)if(me===1)if(X===void 0)X=oe;else{X=null;break}else{X=null;break}}if(X==null)continue;let j=k[X];j!==void 0&&(j.explicit&&(j={...j,explicit:!1}),E[B]=dD([j,E[B]]))}this.value={rank:x,transform:U,sourceRank:r,outputSpace:He({rank:x,names:D,scales:V,units:N,coordinateArrays:E}),inputSpace:He({rank:x,names:A,scales:C,units:M,coordinateArrays:k,boundingBoxes:_})}}toJSON(){return mb(this.spec)}restoreState(e){this.spec=hb(e)}};function jH(n,e=!1){let t=ae(n);if(!pb(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function Fd(n,e=!1){let t=Te(n,r=>jH(r,e));if(!Oc(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}var Nc=class{constructor(e,t){this.combined=e;this.bindings=new Set;this.retainCount=0;this.prevCombined=this.combined.value;this.dimensionRefCounts=new Map;this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()};this.includeDimensionPredicate_=t}getRenameValidity(e){let t=this.combined.value.names,r=Ud(e),i=e.length;for(let a=0;a<i;++a){if(!r[a])continue;let o=e[a];if(t.includes(o))continue;let l=!0;for(let c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}r[a]=l}return r}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){let{combined:e,bindings:t}=this,r=this.retainCount>0?1:0;if(t.size===0&&!r){e.value=ti;return}let i=this.includeDimensionPredicate_,a=e.value,o=Array.from(a.names),l=Array.from(a.units),c=Array.from(a.scales),d=Array.from(a.ids),p=Array.from(a.timestamps),m=a.names.map(()=>r?1:0),y=[],v=!1;for(let D of t){let{space:{value:E},prevValue:V,mappedDimensionIds:N}=D;v=v||E.valid;let{names:U,units:_,scales:B,ids:R,timestamps:X}=E,j=[],oe=[];y.push(oe),D.mappedDimensionIds=j,D.prevValue=E;let me=U.length;for(let xe=0;xe<me;++xe){let se=U[xe];if(!i(se))continue;if(V!==void 0){let je=R[xe],Be=V.ids.indexOf(je);if(Be!==-1){let Pe=N[Be];if(Pe!==void 0){let ge=d.indexOf(Pe);if(ge!==-1){j[xe]=Pe,++m[ge],oe[xe]=ge;let $e=X[xe];$e!==void 0&&!($e<=p[ge])&&(o[ge]=se,c[ge]=B[xe],l[ge]=_[xe],p[ge]=$e);continue}}}}let Se=o.indexOf(se);if(Se!==-1){j[xe]=d[Se],++m[Se],oe[xe]=Se;continue}Se=o.length,oe[xe]=Se,m[Se]=1+r,o[Se]=se,l[Se]=_[xe],c[Se]=B[xe],p[Se]=X[xe];let Ie=tl();d[Se]=Ie,j[xe]=Ie}}let{dimensionRefCounts:b}=this;b.clear();let x=0,C=o.length;for(let D of t){let{space:{value:E}}=D,V=y[x++],{rank:N}=E,U=Array.from(E.names),_=Array.from(E.timestamps),B=Float64Array.from(E.scales),R=Array.from(E.units);for(let X=0;X<N;++X){let j=V[X];j!==void 0&&(R[X]=l[j],B[X]=c[j],_[X]=p[j],U[X]=o[j])}for(let X of U){let j=b.get(X);j===void 0?j=1:++j,b.set(X,j)}if(!Ee(R,E.units)||!Ee(B,E.scales)||!Ee(U,E.names)||!Ee(_,E.timestamps)){let X=He({valid:E.valid,ids:E.ids,scales:B,units:R,names:U,timestamps:_,boundingBoxes:E.boundingBoxes,coordinateArrays:E.coordinateArrays});D.prevValue=X,D.space.value=X}}{for(let E=0;E<C;++E)i(o[E])||(m[E]=0);let D=(E,V)=>m[V]!==0;o=o.filter(D),l=l.filter(D),c=c.filter(D),d=d.filter(D),p=p.filter(D),m=m.filter(D),C=o.length}let k=[],M=new Array(C);for(let D=0,E=a.rank;D<E;++D){let V=a.coordinateArrays[D];if(!(V==null?void 0:V.explicit))continue;let N=d.indexOf(a.ids[D]);N!==-1&&(M[N]=[V])}for(let D of t){let{space:{value:E}}=D,{rank:V,boundingBoxes:N,coordinateArrays:U}=E,_=E.names.map(B=>o.indexOf(B));for(let B of N)k.push(GH(B,C,_));for(let B=0;B<V;++B){let R=U[B];if(R===void 0)continue;let X=_[B],j=M[X];j===void 0?M[X]=[R]:j.push(R)}}let I=new Array(C);for(let D=0;D<C;++D){let E=M[D];E!==void 0&&(I[D]=uD(E))}let A=He({valid:v,ids:d,names:o,units:l,scales:new Float64Array(c),boundingBoxes:k,coordinateArrays:I});if(r)for(let D=0;D<C;++D)--m[D];Yh(a,A)||(this.prevCombined=A,e.value=A)}retain(){return++this.retainCount,()=>{--this.retainCount==0&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:r}=this;r.size===0&&this.combined.changed.add(this.handleCombinedChanged),r.add(t);let i=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),a=()=>{i();let{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),a}};function Xh(n,e,t,r,i){let a=i.length,o=new n((a+1)**2);o[o.length-1]=1;for(let l=0;l<a;++l){let c=r[l];o[(a+1)*a+l]=e[(t+1)*t+c];for(let d=0;d<a;++d){let p=i[d];o[(a+1)*d+l]=e[(t+1)*p+c]}}return o}function SD(n){if(n===void 0)return;let e=new Float64Array(16);if(Array.isArray(n))if(n.length===16)for(let t=0;t<4;++t)for(let r=0;r<4;++r)e[t*4+r]=ct(n[r*4+t]);else{Qr(n,4);for(let t=0;t<4;++t){let r=Qr(n[t],4);for(let i=0;i<4;++i)e[i*4+t]=ct(r[i])}}else{Z(n);let t=at.create(),r=K.create(),i=K.fromValues(1,1,1);pe(n,"rotation",o=>{Ec(t,o),at.normalize(t,t)}),pe(n,"translation",o=>{Ec(r,o)}),pe(n,"scale",o=>{Ec(i,o)});let a=ie.create();ie.fromRotationTranslationScale(a,t,r,i),e.set(a)}return{sourceRank:3,transform:e,outputSpace:He({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function hb(n){if(n===void 0)return;let e=Z(n),t=$(e,"outputDimensions",nl),r=t.rank,i=$(e,"sourceRank",l=>{if(l===void 0)return r;if(!Number.isInteger(l)||l<0||l>r)throw new Error(`Expected integer in range [0, ${r}] but received: ${JSON.stringify(l)}`);return l}),a=pe(e,"inputDimensions",l=>{let c=nl(l,!0);if(c.rank!==r)throw new Error(`Expected rank of ${r}, but received rank of: ${c.rank}`);return c});return{transform:pe(e,"matrix",l=>{let c=new Float64Array((r+1)**2),d=Qr(l,r);c[c.length-1]=1;for(let p=0;p<r;++p)try{let m=Qr(d[p],r+1);for(let y=0;y<=r;++y)c[(r+1)*y+p]=ct(m[y])}catch(m){throw new Error(`Error in row ${p}: ${m.message}`)}return c}),outputSpace:t,inputSpace:a,sourceRank:i}}function mb(n){if(n===void 0)return;let{transform:e,outputSpace:t,inputSpace:r,sourceRank:i}=n,a,o=t.rank;if(e!==void 0){a=[];for(let l=0;l<o;++l){let c=[];a[l]=c;for(let d=0;d<=o;++d)c[d]=e[(o+1)*d+l]}}return{sourceRank:i===o?void 0:i,matrix:a,outputDimensions:ob(t),inputDimensions:r===void 0?void 0:ob(r)}}function qH(n,e,t){let{box:r,transform:i}=n,a=n.box.lowerBounds.length,o=e.length,l=new Float64Array((a+1)*o);for(let c=0;c<o;++c)for(let d=0;d<=a;++d){let p=e[c];l[c+d*o]=i[p+d*t]}if(!l.every(c=>c===0))return{transform:l,box:r}}function Qh(n,e){let{ids:t,names:r,scales:i,units:a,timestamps:o,coordinateArrays:l}=n;return He({rank:e.length,valid:n.valid,ids:e.map(c=>t[c]),names:e.map(c=>r[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>i[c]),units:e.map(c=>a[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:n.boundingBoxes.map(c=>qH(c,e,n.rank)).filter(c=>c!==void 0)})}function Zh(n,e,t){return e===t?n:Qh(n,dE(n.rank,t,e))}function gb(n,e){let{transform:t,rank:r}=n,i=Xs(t,r,[e]);if(i.length!==1)return;let[a]=i,o=t[(r+1)*a+e],{inputSpace:l}=n;return{scale:l.scales[a]*o,unit:l.units[a]}}function yb(n,e){let{scales:t,units:r}=n.defaultInputSpace;return e<t.length?{scale:t[e],unit:r[e]}:void 0}var mQ={channelCoordinateSpace:Ui,shape:new Uint32Array(0),numChannels:1,coordinates:new Uint32Array(0)};function bD(n){let{rank:e}=n,{bounds:{lowerBounds:t,upperBounds:r}}=n;if(t.some(l=>l!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(l=>!Number.isInteger(l)||l<=0||l>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");let i=new Uint32Array(r),a=Rc(i),o=new Uint32Array(a*e);for(let l=0;l<a;++l){let c=l;for(let d=0;d<e;++d){let p=c%i[d];c=(c-p)/i[d],o[l*e+d]=p}}return{channelCoordinateSpace:n,shape:i,numChannels:a,coordinates:o}}function vb(n,e,t,r,i,a){let{scales:o}=t,{scales:l,rank:c}=i,d=e+1;for(let p=0;p<c;++p){let m=a[p];if(m===-1)continue;let y=l[p];for(let v=0;v<e;++v){let b=r[v],x=o[b];n[d*v+m]*=x/y}}}function JH(n,e,t,r,i=Ui){let{inputSpace:a,rank:o,sourceRank:l,outputSpace:c,transform:d}=t,{names:p}=a,{names:m}=c,y;if(r!==void 0)y=Array.from(r.modelSubspaceDimensionIndices);else{y=[];for(let _=0;_<l;++_)y[_]=_}let v=y.length;for(let _=l;_<o;++_)y.push(_);let b=Xs(t.transform,o,y,!0),x=y.length,C=y.map(_=>p[_]||`${_}`),k=b.map(_=>m[_]);if(x!==b.length)return{error:"Rank mismatch between model subspace dimensions ("+C.join(", ")+") and corresponding layer/global dimensions ("+k.join(", ")+")"};let M=Xh(Float32Array,d,o,b,y),I=b.map(_=>m[_]),A=e.names.map(_=>I.indexOf(_)),D=n.names.map(_=>I.indexOf(_));vb(M,x,a,y,n,D),vb(M,x,a,y,e,A);let E=i.names.map(_=>I.indexOf(_));vb(M,x,a,y,i,E);let V=[],N=i.rank;if(r!==void 0){let{subsourceToModelSubspaceTransform:_}=r;v!==x&&(_=Nd(new Float32Array((x+1)**2),x,_,v)),M=el(new Float32Array((x+1)**2),x+1,M,x+1,_,x+1,x+1,x+1,x+1)}let U=new Uint32Array(N);for(let _=0;_<N;++_){let B=i.bounds.lowerBounds[_],R=i.bounds.upperBounds[_];if(B!==0||!Number.isInteger(R)||R<=0||R>=2**32)return{error:`Channel dimension ${i.names[_]} must have lower bound of 0 and positive integer upper bound`};U[_]=R;let X=E[_],j=-1;if(X!==-1)for(let oe=0;oe<x;++oe){let me=M[X+oe*(x+1)];if(me!==0){if(me!==1||j!==-1)return{error:`Channel dimension ${k[X]} must map to a single source dimension`};j=oe}}V[_]=j}return{rank:x,unpaddedRank:v,modelDimensionNames:C,layerDimensionNames:k,localToRenderLayerDimensions:A,globalToRenderLayerDimensions:D,channelToRenderLayerDimensions:E,modelToRenderLayerTransform:M,channelToModelDimensions:V,channelSpaceShape:U}}function YH(n,e){return n===e?!0:n.error!==void 0||e.error!==void 0?!1:Ee(n.modelDimensionNames,e.modelDimensionNames)&&Ee(n.layerDimensionNames,e.layerDimensionNames)&&Ee(n.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&Ee(n.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&Ee(n.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&Ee(n.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&Ee(n.channelSpaceShape,e.channelSpaceShape)}function em(n,e,t,r,i){return fn((a,o,l,c)=>JH(a,o,l,r,c),[n,e,t,i===void 0?Yr(void 0):i],YH)}function xD(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=0,l=r[a];if(l!==-1){let c=i[l];c!==-1&&(o=e[c])}n[a]=o}}function CD(n,e,t,r){let{globalToRenderLayerDimensions:i}=t;for(let a=0;a<3;++a){let o=r[a];if(o!==-1){let l=i[o];l!==-1&&(n[l]=e[a])}}}function tm(n,e){let t=n.rank,r=n.unpaddedRank,i;r!==t&&e!==void 0&&(e=Nd(new Float32Array((t+1)**2),t,e,r)),e!==void 0?(i=new Float32Array((t+1)*(t+1)),el(i,t+1,n.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):i=n.modelToRenderLayerTransform;let a=new Float32Array((t+1)*(t+1)),o=_c(a,t+1,i,t+1,t+1);if(o===0)throw new Error("Transform is singular");let{globalToRenderLayerDimensions:l,localToRenderLayerDimensions:c,channelToRenderLayerDimensions:d}=n,p=l.length,m=c.length,y=p+m,v=new Float32Array((y+1)*t);for(let D=0;D<t;++D){for(let E=0;E<p;++E){let V=l[E];V!==-1&&(v[D+E*t]=a[D+V*(t+1)])}for(let E=0;E<m;++E){let V=c[E];V!==-1&&(v[D+(p+E)*t]=a[D+V*(t+1)])}v[D+y*t]=a[D+t*(t+1)]}let b=d.length,x=new Array(b),C=[];for(let D=0;D<b;++D){let E=d[D],V=-1;if(E!==-1){for(let N=0;N<t;++N){let U=i[E+N*(t+1)];if(U!==0){if(U!==1||V!==-1)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must map with stride 1 to a single data chunk dimensions`);V=N}}if(V!==-1){if(i[E+t*(t+1)]!==0)throw new Error(`Channel dimension ${n.layerDimensionNames[E]} must have an offset of 0 in the chunk coordinate space`);C.push(V)}}x[D]=V}let{channelSpaceShape:k}=n,M=Rc(k),I=C.length,A=new Uint32Array(M*I);for(let D=0;D<M;++D){let E=D,V=0;for(let N=0;N<b;++N){let U=E%k[N];E=(E-U)/k[N],x[N]!==-1&&(A[D*I+V]=U,++V)}}return{layerRank:t,modelTransform:n,chunkToLayerTransform:i,layerToChunkTransform:a,chunkToLayerTransformDet:o,combinedGlobalLocalRank:y,combinedGlobalLocalToChunkTransform:v,channelToChunkDimensionIndices:x,chunkChannelDimensionIndices:C,numChannels:M,chunkChannelCoordinates:A,channelSpaceShape:k}}function nm(n,e){let{globalToRenderLayerDimensions:t}=n,r=[],i=[];for(let a=0;a<3;++a){let o=e[a];if(o==-1)continue;let l=t[o];i.push(l),l!==-1&&r.push(l)}for(let a=i.length;a<3;++a)i[a]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:i}}function rm(n,e){let{chunkToLayerTransform:t,modelTransform:r}=n,i=r.rank,{layerDisplayDimensionIndices:a,displayToLayerDimensionIndices:o}=e,l=a.length,c=Xs(t,i,a);if(c.length!==l){let{modelDimensionNames:m,layerDimensionNames:y}=r;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(a,v=>y[v]).join(",\xA0")}) and corresponding chunk dimensions (${Array.from(c,v=>m[v]).join(",\xA0")})`)}let d=ie.create();for(let m=0;m<3;++m){let y=o[m];if(y!==-1){for(let v=0;v<l;++v){let b=c[v];d[v*4+m]=t[b*(i+1)+y]}d[12+m]=t[i*(i+1)+y]}}let p=ie.create();ie.invert(p,d);for(let m=c.length;m<3;++m)c[m]=-1;return{modelTransform:n.modelTransform,chunkTransform:n,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:p,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function io(n,e,t,r,i){let a=e.length,o=t.length,l=n.length,c=!0;for(let d=0;d<r;++d){let p=d,m=0;for(let y=0;y<a;++y)m+=i[p+y*r]*e[y];p+=a*r;for(let y=0;y<o;++y)m+=i[p+y*r]*t[y];m+=i[p+o*r],d<l?n[d]=m:(m<0||m>=1)&&(c=!1)}return c}function wD(n,e,t){n.fill(0),n[15]=1;let r=!0,{displayDimensionIndices:i}=e,{globalToRenderLayerDimensions:a,modelToRenderLayerTransform:o}=t,l=t.rank;for(let c=0;c<3;++c){let d=i[c];if(d===-1){r=!1;continue}let p=a[d];if(p===-1){r=!1;continue}n[c+12]=o[p+l*(l+1)];for(let m=0;m<3;++m)n[c+4*m]=o[p+(l+1)*m]}if(!r){let{globalDimensionNames:c}=e,d=Array.from(i.filter(p=>p!==-1),p=>c[p]).join(",\xA0");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(",\xA0")}) to display dimensions (${d}) does not have full rank`)}}var il=class{constructor(e,t,r){this.size=K.clone(e),this.transform=ie.clone(t),this.finiteRank=r;let i=ie.create(),a=_c(i,4,t,4,4);if(a===0)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=a}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new il(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return K.transformMat4(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return I1(e,t,this.transform)}globalToLocalNormal(e,t){return Lh(e,t,this.transform)}};var TD=class{constructor(){this.name="CancellationError";this.message="CANCELED"}toString(){return"CANCELED"}},Gd=new TD;var Sb=()=>{},At={isCanceled:!1,add:()=>Sb,remove:Sb},ao=class{cancel(){let{handlers:e}=this;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let{handlers:t}=this;return t===null?(e(),Sb):(t===void 0&&(t=this.handlers=new Set),t.add(e),()=>{this.remove(e)})}remove(e){let{handlers:t}=this;t!=null&&t.delete(e)}},bb=class extends ao{constructor(){super(...arguments);this.consumers=new Set}addConsumer(e=At){let{consumers:t}=this;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}};function kD(n,e){return new Promise((t,r)=>{if(n===At){e(t,r,At);return}let i=new ao,a=n.add(()=>{i.cancel()});e(o=>{a(),t(o)},o=>{a(),r(o)},i)})}var im=!(typeof Window!="undefined"&&self instanceof Window),LD=!1,ED=!1,xb="rpc.promise.response",DD="rpc.promise.cancel",PD=new Map;function zt(n,e){PD.set(n,e)}var ID=class extends Error{constructor(e,t){super(t);this.name=e;this.message=t}};function am(n,e){zt(n,function(t){let r=t.id,i=new ao,a=e.call(this,t,i);this.set(r,{promise:a,cancellationToken:i}),a.then(({value:o,transfers:l})=>{this.delete(r),this.invoke(xb,{id:r,value:o},l)},o=>{this.delete(r),this.invoke(xb,{id:r,error:o.message,errorName:o.name})})})}zt(DD,function(n){let e=n.id,t=this.get(e);if(t!==void 0){let{cancellationToken:r}=t;r.cancel()}});zt(xb,function(n){let e=n.id,{resolve:t,reject:r}=this.get(e);this.delete(e),n.hasOwnProperty("value")?t(n.value):n.errorName===Gd.name?r(Gd):r(new ID(n.errorName,n.error))});var KH=im?-1:0,Cb=class{constructor(e){this.target=e;this.objects=new Map;this.nextId=KH;e.onmessage=t=>{let r=t.data;ED&&console.log("Received message",r),PD.get(r.functionName).call(this,r)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(e===void 0)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e,ED&&console.trace("Sending message",t),this.target.postMessage(t,r)}promiseInvoke(e,t,r=At,i){return kD(r,(a,o,l)=>{let c=t.id=this.newId();this.set(c,{resolve:a,reject:o}),this.invoke(e,t,i),l.add(()=>{this.invoke(DD,{id:c})})})}newId(){return im?this.nextId--:this.nextId++}},Rn=class extends z{constructor(){super(...arguments);this.rpc=null;this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){LD&&console.log(`[${im}] #rpc object = ${this.rpc.numObjects}`);let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}};function XH(n,e,t={}){e!=null&&n.initializeSharedObject(e,t.id)}var oo=class extends Rn{constructor(e,t={}){super();XH(this,e,t)}};zt("SharedObject.dispose",function(n){let e=this.get(n.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");LD&&console.log(`[${im}] #rpc objects: ${this.numObjects}`),e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});zt("SharedObject.refCountReachedZero",function(n){let e=this.get(n.id),t=n.gen;e.counterpartRefCountReachedZero(t)});var AD=new Map;function _n(n){return e=>{e.prototype.RPC_TYPE_ID=n}}function Zo(n){return e=>{if(n!==void 0)e.prototype.RPC_TYPE_ID=n;else if(n=e.prototype.RPC_TYPE_ID,n===void 0)throw new Error("RPC_TYPE_ID should have already been defined");AD.set(n,e)}}zt("SharedObject.new",function(n){let e=this,t=n.type,r=AD.get(t),i=new r(e,n);--i.refCount});var om=!1,QH=!1,ZH=ie.create();function e$(n,e){let t=0,r=Math.abs(n.detTransform),{transform:i,size:a}=n;for(let o=0;o<3;++o){let l=0;for(let d=0;d<3;++d)l+=e[d*4+2]*i[4*o+d];let c=a[o];t+=Math.abs(l)*c,r*=c}return r/t}function MD(n,e,t){let{curPositionInChunks:r,fixedPositionWithinChunk:i}=n,{nonDisplayLowerClipBound:a,nonDisplayUpperClipBound:o}=n,{rank:l,chunkDataSize:c}=n.source.spec;if(!io(r,e,t,n.layerRank,n.fixedLayerToChunkTransform))return!1;for(let d=0;d<l;++d){let p=r[d];if(p<a[d]||p>=o[d])return om&&console.log("excluding source",n,`because of chunkDim=${d}, sum=${p}`,a,o,n.fixedLayerToChunkTransform),!1;let m=c[d],y=r[d]=Math.floor(p/m);i[d]=p-y*m}return!0}function t$(n,e){let t=e.length,r=0;if(om&&console.log(e),t>1){let i=0;for(let a=0;a<t;++a){let o=e[a],{chunkLayout:l}=o,c=e$(l,n);om&&console.log(`chunksize = ${l.size}, sliceArea = ${c}`),c>i&&(i=c,r=a)}}return r}var Bc=new il(K.create(),ie.create(),0),wb=class extends Od{constructor(){super(...arguments);this.viewportNormalInGlobalCoordinates=K.create();this.viewportNormalInCanonicalCoordinates=K.create();this.centerDataPosition=K.create();this.pixelSize=0}};function n$(n,e){if(n.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||n.pixelSize!==e.pixelSize)return!0;let{viewMatrix:t}=n,{viewMatrix:r}=e;for(let i=0;i<12;++i)if(t[i]!==r[i])return!0;return!1}var Tb=class extends Rn{constructor(e){super();this.projectionParameters=e;this.visibleLayers=new Map;this.visibleSourcesStale=!0;this.registerDisposer(e.changed.add((t,r)=>{n$(t,r)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,{allSources:i,visibleSources:a,displayDimensionRenderInfo:o}]of t){if(a.length=0,o!==e||i.length===0)continue;let l=t$(this.projectionParameters.value.viewMatrix,i.map(d=>d[0])),c=i[l];for(let d of r.filterVisibleSources(this,c))a.push(d);a.reverse(),om&&console.log("visible sources chosen",a)}}},kb=18;function Wd(n){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:r=kb,chunkToViewTransform:i,displayRank:a,minBlockSize:o,maxBlockSize:l}=n,{lowerVoxelBound:c=new Uint32Array(e)}=n,d=new Float32Array(e);for(let v=0;v<e;++v){let b=0;for(let x=0;x<a;++x){let C=i[v*a+x];b+=C*C}d[v]=Math.sqrt(b)}let p=new Uint32Array(e);o!==void 0?p.set(o):p.fill(1);let m=new Array(e);for(let v=0;v<e;++v){let b=Number.POSITIVE_INFINITY;d[v]===0?b=p[v]:(t!==void 0&&(b=Math.pow(2,Math.floor(Math.log2(t[v]-c[v])))),l!==void 0&&(b=Math.min(b,l[v]))),m[v]=b}function y(){let v=Infinity,b=-1;for(let x=0;x<e;++x){if(p[x]>=m[x])continue;let C=p[x]*d[x];C<v&&(v=C,b=x)}return b}r-=Math.log2(Rc(p));for(let v=0;v<r;++v){let b=y();if(b===-1)break;p[b]*=2}return p}function r$(n){let e=[],{displayRank:t,chunkToViewTransform:r,rank:i}=n;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[Wd(n)];for(let a=0;a<3;++a){let o=(a+2)%3,l=new Float32Array(r);for(let c=0;c<i;++c)l[c*t+o]=0;e[a]=Wd({...n,chunkToViewTransform:l})}return e}var ni;(function(t){t[t.ISOTROPIC=0]="ISOTROPIC",t[t.FLAT=1]="FLAT"})(ni||(ni={}));function RD(n){if(n.chunkDataSizes!==void 0)return n.chunkDataSizes;let{chunkLayoutPreference:e=0}=n;switch(e){case 0:return[Wd(n)];case 1:return r$(n)}}function Uc(n){let{rank:e,chunkDataSize:t,upperVoxelBound:r}=n,{lowerVoxelBound:i=new Float32Array(e)}=n,a=new Float32Array(e),o=new Float32Array(e);for(let l=0;l<e;++l)a[l]=Math.floor(i[l]/t[l]),o[l]=Math.floor((r[l]-1)/t[l]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:o,lowerVoxelBound:i,upperVoxelBound:r}}function*_D(n,e,t){let r=n.projectionParameters.value.pixelSize*1.1,i=t[0].effectiveVoxelSize,a=e.renderScaleTarget.value,o=p=>{let m=r*a;for(let y=0;y<3;++y){let v=p[y];if(v>m&&v>1.01*i[y])return!0}return!1},l=(p,m)=>{let y=r*a;for(let v=0;v<3;++v){let b=p[v],x=m[v];if(Math.abs(y-b)<Math.abs(y-x)&&b<1.01*x)return!0}return!1},c=t.length-1,d;for(;;){let p=t[c];if(d!==void 0&&!l(p.effectiveVoxelSize,d)||(yield p,c===0||!o(p.effectiveVoxelSize)))break;d=p.effectiveVoxelSize,--c}}var VD="SliceView",OD="sliceview/RenderLayer",ND="SliceView.addVisibleLayer",BD="SliceView.removeVisibleLayer",Lb=new Float32Array(3),Eb=new Float32Array(3),UD=ie.create(),FD=new Float32Array(24);function GD(n,e,t,r){let i=Lb,a=Eb,{lowerChunkDisplayBound:o,upperChunkDisplayBound:l}=e;for(let m=0;m<3;++m)i[m]=Math.max(i[m],o[m]),a[m]=Math.min(a[m],l[m]);let{curPositionInChunks:c,chunkDisplayDimensionIndices:d}=e;function p(){if(!r(i[0],i[1],i[2],a[0],a[1],a[2],n))return;let m=0,y=Math.max(0,a[0]-i[0]),v=y;for(let k=1;k<3;++k){let M=Math.max(0,a[k]-i[k]);v*=M,M>y&&(y=M,m=k)}if(v===0)return;if(v===1){c[d[0]]=i[0],c[d[1]]=i[1],c[d[2]]=i[2],t(i,n);return}let b=i[m],x=a[m],C=Math.floor(.5*(b+x));a[m]=C,p(),a[m]=x,i[m]=C,p(),i[m]=b}p()}function sm(n,e,t,r){if(!MD(t,n.globalPosition,e))return;let{size:i}=t.chunkLayout,a=ie.multiply(UD,n.viewProjectionMat,t.chunkLayout.transform);for(let d=0;d<3;++d){let p=i[d];for(let m=0;m<4;++m)a[4*d+m]*=p}let o=FD;Ks(o,a);let l=Lb,c=Eb;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),GD(o,t,r,Eh)}function WD(n,e,t,r,i){if(!MD(t,n.globalPosition,e))return;let{size:a}=r,o=ie.multiply(UD,n.viewProjectionMat,r.transform);for(let y=0;y<3;++y){let v=a[y];for(let b=0;b<4;++b)o[4*y+b]*=v}let l=ZH;ie.invert(l,o);let c=Lb,d=Eb,p=.001;for(let y=0;y<3;++y){let v=l[12+y]+p/a[y],b=Math.abs(l[y]),x=Math.abs(l[4+y]);c[y]=Math.floor(v-b-x),d[y]=Math.floor(v+b+x+1)}let m=FD;for(let y=0;y<3;++y){let v=o[4*y],b=o[4*y+1],x=o[4*y+2];m[y]=v,m[4+y]=-v,m[8+y]=+b,m[12+y]=-b,m[16+y]=+x,m[20+y]=-x}{let y=3,v=o[4*y],b=o[4*y+1],x=o[4*y+2];m[y]=1+v,m[4+y]=1-v,m[8+y]=1+b,m[12+y]=1-b,m[16+y]=x,m[20+y]=-x}QH&&(console.log("clippingPlanes",m),console.log("modelViewProjection",o.join(",")),console.log(`lower=${c.join(",")}, upper=${d.join(",")}`)),GD(m,t,i,M1)}function Fc(n,e){let{finiteRank:t}=e;if(t===3)return e;Bc.finiteRank=t,K.copy(Bc.size,e.size);let r=ie.copy(Bc.transform,e.transform),i=ie.copy(Bc.invTransform,e.invTransform);Bc.detTransform=e.detTransform;let{invViewMatrix:a,width:o,height:l}=n,c=Dh(n.projectionMat);for(let d=t;d<3;++d){let p=a[12+d],m=p,y=p,v=Math.abs(a[d]*o);m-=v,y+=v;let b=Math.abs(a[d+4]*l);m-=b,y+=b;let x=Math.abs(a[d+8]*c);m-=x,y+=x;let C=Math.max(1,y-m);r[12+d]=m,r[5*d]=C}return ie.invert(i,r),Bc}var zD="annotation.MetadataChunkSource",HD="annotation.GeometryChunkSource",$D="annotation.SubsetGeometryChunkSource",jD="annotation.reference.add",qD="annotation.reference.delete",JD="annotation.commit",YD="annotation.commit",KD="annotation/SpatiallyIndexedRenderLayer",XD="annotation/PerspectiveRenderLayer:updateSources",QD="annotation/RenderLayer",ZD="annotation/RenderLayer.updateSegmentation",i$=Ft.create();function eP(n,e,t,r,i,a){let{displayDimensionRenderInfo:o,viewMatrix:l,projectionMat:c,width:d,height:p}=n,{voxelPhysicalScales:m}=o,y=Math.abs(Ft.determinant(Ys(i$,l))),v=kd(m),b=R1(c)/y*v;if(r.length===0)return;let x=r[0],C=Math.abs(x.chunkLayout.detTransform)*v,{lowerClipDisplayBound:k,upperClipDisplayBound:M}=x;for(let N=0;N<3;++N)C*=M[N]-k[N];let I=Math.min(C,b),A=d*p,E=A/t**2/I,V=0;for(let N=r.length-1;N>=0&&V<E;--N){let U=r[N],_=U.source.spec,{chunkLayout:B}=U,R=kd(B.size)*Math.abs(B.detTransform)*v,{limit:X,rank:j}=_,{nonDisplayLowerClipBound:oe,nonDisplayUpperClipBound:me}=U,xe=1;for(let $e=0;$e<j;++$e){let ht=me[$e]-oe[$e];Number.isFinite(ht)&&(xe/=ht)}let se=X*xe/R,Se=!0,Ie=V+se,je=Math.pow(1/Ie,1/3),Be=Math.sqrt(A/(Ie*I)),Pe=(E-V)*R/xe,ge=Math.min(1,Pe/_.limit);sm(n,e,U,()=>{Se&&(i(U,N),Se=!1),a(U,N,ge,je,Be)}),V=Ie}}var tP=Symbol("objectId"),a$=0;function St(n){if(n instanceof Object){let e=n[tP];return e===void 0&&(e=n[tP]=a$++),`o${e}`}else return""+JSON.stringify(n)}var Db=!1,Pb;(function(t){t[t.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",t[t.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(Pb||(Pb={}));function o$(n){n=n.replace("\0","");let e=[];for(let t of n.split(`
`)){let r=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);r!==null?e.push({message:r[3].trim(),file:parseInt(r[1],10),line:parseInt(r[2],10)}):(r=t.match(/^ERROR:\s*(.+)$/),r!==null?e.push({message:r[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}var nP=class extends Error{constructor(e,t,r,i){let a=`Error compiling ${Pb[e].toLowerCase()} shader: ${r}`;super(a);this.name="ShaderCompilationError",this.log=r,this.message=a,this.shaderType=e,this.source=t,this.errorMessages=i}},rP=class extends Error{constructor(e,t,r){let i=`Error linking shader: ${r}`;super(i);this.name="ShaderLinkError",this.log=r,this.message=i,this.vertexSource=e,this.fragmentSource=t}};function iP(n,e,t){var r=n.createShader(t);if(n.shaderSource(r,e),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){let i=n.getShaderInfoLog(r)||"";if(Db){let a=e.replace("<","&lt;").replace(">","&gt;").split(`
`),o="<pre>";o+=i.replace("<","&lt;").replace(">","&gt;")+`
`,a.forEach((c,d)=>{o+=`${d+1}: ${c}
`}),o+=`
</pre>`,console.log(o);let l=window.open("about:blank","_blank");if(l!==null)try{l.document.write(o)}catch(c){}}throw new nP(t,e,i,o$(i))}return r}var zd,aP=class extends z{constructor(e,t,r,i,a,o){super();this.gl=e;this.vertexSource=t;this.fragmentSource=r;this.attributes=new Map;this.uniforms=new Map;this.vertexShaderInputBinders={};let l=this.vertexShader=iP(e,t,e.VERTEX_SHADER),c=this.fragmentShader=iP(e,r,e.FRAGMENT_SHADER),d=e.createProgram();if(e.attachShader(d,l),e.attachShader(d,c),Db&&(o==null?void 0:o.length)&&(e.transformFeedbackVaryings(d,o.map(y=>y.name),WebGL2RenderingContext.INTERLEAVED_ATTRIBS),this.vertexDebugOutputs=o),e.linkProgram(d),!e.getProgramParameter(d,e.LINK_STATUS)){let y=e.getProgramInfoLog(d)||"";throw new rP(t,r,y)}this.program=d;let{uniforms:p,attributes:m}=this;if(i)for(let y of i)p.set(y,e.getUniformLocation(d,y));if(a)for(let y of a)m.set(y,e.getAttribLocation(d,y))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){zd=this,this.gl.useProgram(this.program)}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}};function oP(n,e,t,r,i){if(n.drawArraysInstanced(e,t,r,i),!Db||!(zd==null?void 0:zd.vertexDebugOutputs))return;let{vertexDebugOutputs:a}=zd,o=0;for(let y of a)o+=s$[y.typeName];let l=n.createBuffer(),c=o*r*i;n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l),n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,c,WebGL2RenderingContext.DYNAMIC_DRAW),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,l),n.beginTransformFeedback(WebGL2RenderingContext.POINTS),n.enable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.drawArraysInstanced(WebGL2RenderingContext.POINTS,t,r,i),n.disable(WebGL2RenderingContext.RASTERIZER_DISCARD),n.endTransformFeedback(),n.bindBufferBase(WebGL2RenderingContext.TRANSFORM_FEEDBACK_BUFFER,0,null),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,l);let d=new Uint8Array(c);n.getBufferSubData(WebGL2RenderingContext.ARRAY_BUFFER,0,d,0,c),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),n.deleteBuffer(l);let p=0,m=new Float32Array(d.buffer);for(let y=0;y<i;++y)for(let v=0;v<r;++v){let b=`i=${y} v=${v}:`;for(let x of a)switch(b+=` ${x.name}=`,x.typeName){case"float":b+=`${m[p++]}`;break;case"vec2":b+=`${m[p++]},${m[p++]}`;break;case"vec3":b+=`${m[p++]},${m[p++]},${m[p++]}`;break;case"vec4":b+=`${m[p++]},${m[p++]},${m[p++]},${m[p++]}`;break}console.log(b)}}var Ib=class{constructor(){this.code="";this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}},lm={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D},s$={float:4,vec2:8,vec3:12,vec4:16},ri=class{constructor(e){this.gl=e;this.nextSymbolID=0;this.nextTextureUnit=0;this.uniformsCode="";this.attributesCode="";this.varyingsCodeVS="";this.varyingsCodeFS="";this.fragmentExtensionsSet=new Set;this.fragmentExtensions="";this.vertexCode=new Ib;this.vertexMain="";this.fragmentCode=new Ib;this.outputBufferCode="";this.fragmentMain="";this.required=new Set;this.uniforms=new Array;this.attributes=new Array;this.initializers=[];this.textureUnits=new Map;this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let r=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,r),r}addTextureSampler(e,t,r,i){let a=this.allocateTextureUnit(r,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer(o=>{if(i){let l=new Int32Array(i);for(let c=0;c<i;++c)l[c]=c+a;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),a)}),a}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,r){return this.attributes.push(t),r!==void 0&&(this.attributesCode+=`layout(location = ${r})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,r=""){this.varyingsCodeVS+=`${r} out ${e} ${t};
`,this.varyingsCodeFS+=`${r} in ${e} ${t};
`}addOutputBuffer(e,t,r){r!==null&&(this.outputBufferCode+=`layout(location = ${r}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,r){return this.uniforms.push(t),r!=null?this.uniformsCode+=`uniform ${e} ${t}[${r}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,r=new aP(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);r.textureUnits=this.textureUnits;let{initializers:i}=this;if(i.length>0){r.bind();for(let a of i)a(r)}return r}};function Sa(){return new Ge(void 0)}function es(n){return new lt(n,ae)}function Hd(n,e,t){let r=new Map,{parameters:i,fallbackParameters:a,shaderError:o,encodeParameters:l=C=>C,extraParameters:c=Yr(void 0),encodeExtraParameters:d=C=>C,getContextKey:p,defineShader:m}=t;o!==void 0&&(o.value=void 0);let{encodeContext:y=p}=t,v=Mn(t.memoizeKey);function b(C,k,M){let I=JSON.stringify({id:v,context:y(C),parameters:l(k),extraParameters:d(M)});return e.memoize.get(I,()=>{let A=new ri(e);return m(A,C,k,M),A.build()})}function x(C){let k=p(C),M=r.get(k);M===void 0&&(M={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:i.value,extraParameters:c.value},r.set(k,M));let I=i.changed.count,A=c.changed.count;if(I===M.parametersGeneration&&A===M.extraParametersGeneration)return M;let D=M.parameters=i.value,E=M.extraParameters=c.value,V=M.shader;M.parametersGeneration=I,M.extraParametersGeneration=A;let N=null;try{N=b(C,D,E),M.fallback=!1,a!==void 0&&(a.value=D),o!==void 0&&(o.value=null)}catch(U){if(o!==void 0&&(o.value=U),a!==void 0)try{let _=a.value;N=b(C,_,E),M.parameters=_,M.fallback=!0}catch{}}return V!==null&&V.dispose(),M.shader=N,M}return n.registerDisposer(()=>{for(let C of r.values()){let{shader:k}=C;k!==null&&k.dispose()}}),x}function ii(n,e,t){return Hd(n,e,{...t,getContextKey:r=>r,encodeContext:r=>St(r),defineShader:(r,i,a,o)=>(r.require(i),t.defineShader(r,a,o))})}function Fi(n,e=1,t=0){return`
#line ${t} ${e}
`+n}var sP=rt(Ct());var Mt=class{constructor(e,t=e){this.value_=e;this.defaultValue=t;this.changed=new re}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}},Lr=class extends z{constructor(e,t={}){super();this.model=e;this.element=document.createElement("input");let{element:r}=this;r.type="checkbox";let i=()=>{var o;let a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(o=a?t.enableTitle:t.disableTitle)!=null?o:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(r,"change",function(a){e.value=this.checked}),r.addEventListener("mousedown",a=>{a.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}},lr=class extends z{constructor(e,t){super();this.model=e;this.element=t;this.initialDisplay=this.element.style.display;this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,sP.default)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}};var lP="SharedWatchableValue.changed",Gt=class extends oo{constructor(e,t={}){super(e,t);this.updatingValue_=!1;e!==void 0&&(this.base=new Ge(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;e!==null&&e.invoke(lP,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new Gt;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return Gt.makeFromExisting(e,new Ge(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}};Gt=Ut([Zo("SharedWatchableValue")],Gt);zt(lP,function(n){let e=this.get(n.id);e.updatingValue_=!0,e.base.value=n.value,e.updatingValue_=!1});var Vt=class extends Ge{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}};Vt.VISIBLE=Number.POSITIVE_INFINITY,Vt.IGNORED=Number.NEGATIVE_INFINITY;var so=class extends Vt{constructor(){super(...arguments);this.contributors=new Map}add(e){let{contributors:t}=this,r=e.changed.add(()=>{this.update()}),i=()=>{t.delete(i),r(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}};function ba(n){return class extends n{constructor(){super(...arguments);this.visibility=new so}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(Gt.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var en=class{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e;this.bufferType=t;this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,r=WebGL2RenderingContext.FLOAT,i=!1,a=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,r,i,a,o)}bindToVertexAttribI(e,t,r=WebGL2RenderingContext.UNSIGNED_INT,i=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,r,i,a)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let r=this.gl;this.bind(),r.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,r,i){let a=new en(e,r);return a.setData(t,i),a}};function lo(n,e,t,...r){return n.memoize.get(Mn({id:"getMemoizedBuffer",getter:St(t),args:r}),()=>{let i=new Sd(en.fromData(n,t(...r),e,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i})}function l$(n=-1,e=-1,t=1,r=1,i=1,a=1){return gd(new Float32Array([n,e,n,r,t,r,t,e]),2,i,a)}function ts(n,e=-1,t=-1,r=1,i=1,a=1,o=1){return lo(n,WebGL2RenderingContext.ARRAY_BUFFER,l$,e,t,r,i,a,o).value}function co(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function cP(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function uP(n,e,t,r,i=WebGL2RenderingContext.RGBA8,a=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),co(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,i,t,r,0,a,o,null),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function dP(n,e,t){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function Ab(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain("v4f_fragColor = getValue0();")}function pP(n,e=Ab,t=1){return n.memoize.get(`elementWiseTextureShader:${t}:${St(e)}`,()=>{let r=new ri(n);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",t),r.addInitializer(i=>{let a=[];for(let o=0;o<t;++o)a[o]=o;n.uniform1iv(i.uniform("uSampler"),a)});for(let i=0;i<t;++i)r.addFragmentCode(`
vec4 getValue${i}() {
  return texture(uSampler[${i}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(e),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}function fP(n){return n.memoize.get("trivialColorShader",()=>{let e=new ri(n);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}var Mb=class extends z{constructor(){super(...arguments);this.width=Number.NaN;this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}},hP=class extends Mb{constructor(e,t){super();this.gl=e;this.internalformat=t;this.renderbuffer=null;this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}},mP=class extends hP{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16);this.gl=e;this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}},Rb=class extends mP{constructor(e){super(e,!0)}};var gP=class extends z{constructor(e){super();this.gl=e;this.framebuffer=this.gl.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}},xa=class extends Mb{constructor(e,t,r,i){super();this.gl=e;this.internalFormat=t;this.format=r;this.dataType=i;this.texture=e.createTexture()}performResize(){uP(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}},_b=class extends xa{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,r=WebGL2RenderingContext.DEPTH_COMPONENT,i=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,r,i)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}};function al(n,e,t=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,i=WebGL2RenderingContext.UNSIGNED_BYTE){let a=new Array;for(let o=0;o<e;++o)a[o]=new xa(n,t,r,i);return a}var Gi=class extends z{constructor(e,t){super();this.gl=e;this.width=Number.NaN;this.height=Number.NaN;this.fullAttachmentList=new Array;this.attachmentVerified=!1;this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];let{framebuffer:r=new gP(e),colorBuffers:i,depthBuffer:a}=t;this.framebuffer=this.registerDisposer(r),this.colorBuffers=i,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let{fullAttachmentList:o}=this;i.forEach((l,c)=>{this.registerDisposer(l),o[c]=e.COLOR_ATTACHMENT0+c})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:r,depthBuffer:i}=this;i!==void 0?(i.resize(e,t),i.attachToFramebuffer()):r.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((a,o)=>{a.resize(e,t),a.attachToFramebuffer(r.COLOR_ATTACHMENT0+o)}),r.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),r.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,r,i,a=1,o=1){let{gl:l}=this;try{this.bindSingle(e),l.readPixels(t,r,a,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}},Ca=class extends z{constructor(e,t){super();this.gl=e;this.shader=t;this.copyVertexPositionsBuffer=ts(this.gl);this.copyTexCoordsBuffer=ts(this.gl,0,0,1,1);this.registerDisposer(t)}draw(...e){let{gl:t,shader:r}=this;r.bind();let i=e.length;for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,Th);let a=r.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(a,2);let o=r.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(a),t.disableVertexAttribArray(o);for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=Ab,r=1){return e.memoize.get(`OffscreenCopyHelper:${r}:${St(t)}`,()=>new Ca(e,pP(e,t,r)))}};var yP=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,vP=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,tn=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,SP=[tn,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],cm=[tn,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],$d=[tn,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],Vb=[tn,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],c$=[tn,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],bP=[c$,$d,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],xP=[Vb,$d,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],Ob=[tn,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],CP=[tn,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],Nb=[tn,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],Bb=`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`,um=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,Ub=[tn,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],Fb=`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`,ol=[tn,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],Gb=`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`,wP=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,TP=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,kP=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,LP=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,EP=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,dm=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,DP=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,PP=[dm,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],IP=[dm,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function Xt(n,e=1){switch(n){case G.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case G.UINT8:case G.INT8:case G.UINT16:case G.INT16:case G.UINT32:case G.INT32:case G.UINT64:{let t=Ph[n]?"":"u",r=Ih[n]*8;if(e===1)return`${t}int${r}_t`;if(e>1&&e*r<=32)return`${t}int${r}x${e}_t`;break}}throw new Error(`No shader type for ${G[n]}[${e}].`)}var sl={[G.UINT8]:Nb,[G.INT8]:Bb,[G.UINT16]:Ub,[G.INT16]:Fb,[G.UINT32]:ol,[G.INT32]:Gb,[G.UINT64]:tn,[G.FLOAT32]:um};function u$(n,e){return e===1?n:n==="float"?`vec${e}`:`${n[0]}vec${e}`}var d$={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function ns(n,e,t,r,i,a,o=1){let l=0,c=a*o;for(;c>0;){let m=Math.min(4,c),y=u$(e,m);c-=m,n.addAttribute("highp "+y,`a${i}${l}`),++l}c=a*o;let d="";for(let m=0;m<o;++m){d+=`highp ${e}[${a}] get${i}${m}() {
  highp ${e}[${a}] result;
`;for(let y=0;y<a;++y){let v=m*a+y,b=Math.floor(v/4),x=v%4;d+=`  result[${y}] = a${i}${b}`,(x!==0||v!==c-1)&&(d+=`[${x}]`),d+=`;
`}d+=`  return result;
`,d+=`}
`}n.addVertexCode(d);let p=d$[t];n.addInitializer(m=>{let y=[];for(let v=0;v<l;++v)y[v]=m.attribute(`a${i}${v}`);m.vertexShaderInputBinders[i]={enable(v){let{gl:b}=m;for(let x=0;x<l;++x){let C=y[x];b.enableVertexAttribArray(C),b.vertexAttribDivisor(C,v)}},disable(){let{gl:v}=m;for(let b=0;b<l;++b){let x=y[b];v.vertexAttribDivisor(x,0),v.disableVertexAttribArray(x)}},bind(v,b){let{gl:x}=m;for(let C=0;C<l;++C){let k=y[C],M=Math.min(4,c-4*C);e==="float"?x.vertexAttribPointer(k,M,t,r,v,b):x.vertexAttribIPointer(k,Math.min(4,c-4*C),t,v,b),b+=p*M}}}})}var p$=!1,jd=class extends z{constructor(e,t,r=new so){super();this.channels=e;this.bounds=t;this.visibility=r;this.framebuffers=[];this.producerVisibility=new so;this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this;for(;t.length<this.channels.value.length;){let r=new Gi(e,{colorBuffers:al(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(r)}return t}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}},AP=Symbol("histogramDataSamplerTextureUnit"),MP=Symbol("histogramDepthTextureUnit"),Wb=4096,f$=2**14,qd=class extends z{constructor(e){super();this.gl=e;this.shader=this.registerDisposer((()=>{let e=new ri(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",AP),e.addTextureSampler("sampler2D","uDepthSampler",MP),e.addVertexCode(LP),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})());this.inputIndexBuffer=this.registerDisposer(lo(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(Wb)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new qd(e))}compute(e,t,r,i,a){let{gl:o}=this,{shader:l}=this,c=i.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let d=l.textureUnit(AP),p=l.textureUnit(MP);o.activeTexture(WebGL2RenderingContext.TEXTURE0+p),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),co(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+d);let m=i.frameNumber;i.frameNumber=a;for(let y=0;y<e;++y)if(o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r[y].texture),co(o),c[y].bind(256,1),a!==m&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,Wb,f$/Wb),p$){let v=new Float32Array(256*4);o.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,v);let b=new Float32Array(256);for(let x=0;x<256;++x)b[x]=v[x*4];console.log("histogram",b.join(" "))}o.disable(WebGL2RenderingContext.BLEND)}};var zb={[G.UINT8]:"vec2",[G.INT8]:"vec2",[G.UINT16]:"vec2",[G.INT16]:"vec2",[G.FLOAT32]:"vec2",[G.UINT32]:"Uint32LerpParameters",[G.INT32]:"Int32LerpParameters",[G.UINT64]:"Uint64LerpParameters"},Jd={[G.UINT8]:"",[G.INT8]:"",[G.UINT16]:"",[G.INT16]:"",[G.FLOAT32]:"",[G.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[G.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[G.UINT64]:[tn,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]};function Yd(n){let t=`
float computeInvlerp(${Xt(n)} inputValue, vec2 p) {
  float outputValue = float(toRaw(inputValue));
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;return[sl[n],t]}function RP(n){let e=Xt(n),t=n===G.INT32?"int":"uint",r=zb[n];return[sl[n],Jd[n],`
float computeInvlerp(${e} inputValue, ${r} p) {
  ${t} v = toRaw(inputValue);
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
`]}var h$={[G.UINT8]:Yd(G.UINT8),[G.INT8]:Yd(G.INT8),[G.UINT16]:Yd(G.UINT16),[G.INT16]:Yd(G.INT16),[G.FLOAT32]:Yd(G.FLOAT32),[G.UINT32]:RP(G.UINT32),[G.INT32]:RP(G.INT32),[G.UINT64]:[tn,$d,Vb,Ob,Jd[G.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function Kd(n){let t=`
${Xt(n)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return n===G.FLOAT32?t+=`return inputValue;
`:t+=`return ${G[n].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[sl[n],t]}function _P(n){let e=Xt(n),t=zb[n];return[sl[n],Jd[n],EP,n===G.UINT32?dm:PP,n===G.UINT32?DP:IP,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}var m$={[G.UINT8]:Kd(G.UINT8),[G.INT8]:Kd(G.INT8),[G.UINT16]:Kd(G.UINT16),[G.INT16]:Kd(G.INT16),[G.FLOAT32]:Kd(G.FLOAT32),[G.UINT32]:_P(G.UINT32),[G.INT32]:_P(G.INT32),[G.UINT64]:[tn,$d,cm,bP,xP,Ob,CP,Jd[G.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function VP(n,e,t){let r=`uLerpParams_${e}`,i=`uLerpBounds_${e}`,a=`uLerpScalar_${e}`,o="";switch(t){case G.INT8:case G.UINT8:case G.INT16:case G.UINT16:case G.FLOAT32:n.addUniform("vec2",r);break;case G.INT32:case G.UINT32:{let l=zb[t];n.addUniform(`${t===G.INT32?"i":"u"}vec2`,i),n.addUniform("float",a),o+=`
#define ${r} ${l}(${i}[0], int(${i}[1]), ${a})
`;break}case G.UINT64:{n.addUniform("uvec3",i),n.addUniform("float",a),o+=`
#define ${r} Uint64LerpParameters(uint64_t(${i}.xy), int(${i}[2]), ${a})
`;break}}return[Jd[t],o]}function pm(n,e,t,r=!1){return[sl[t],VP(n,e,t),h$[t],`
float ${e}(${Xt(t)} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`]}function OP(n,e,t){return[sl[t],VP(n,e,t),m$[t],`
${Xt(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}var ll=new Q;function Gc(n,e,t,r){let{gl:i}=n;switch(t){case G.INT8:case G.UINT8:case G.INT16:case G.UINT16:case G.FLOAT32:i.uniform2f(n.uniform(`uLerpParams_${e}`),r[0],1/(r[1]-r[0]));break;case G.INT32:case G.UINT32:{let a=r[0],o=r[1]-a,l=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),c=Math.pow(2,l)/o,d=n.uniform(`uLerpBounds_${e}`);t===G.UINT32?i.uniform2ui(d,a,l):i.uniform2i(d,a,l),i.uniform1f(n.uniform(`uLerpScalar_${e}`),c);break}case G.UINT64:{let a=r[0],o=r[1];Q.absDifference(ll,o,a);let l=ll.high>0?32+Math.ceil(Math.log2(ll.high)):Math.ceil(Math.log2(ll.low)),c=Math.max(0,l-24);Q.rshift(ll,ll,c);let d=1/ll.low;Q.compare(a,o)>0&&(d*=-1);let p=n.uniform(`uLerpBounds_${e}`);i.uniform3ui(p,a.low,a.high,c),i.uniform1f(n.uniform(`uLerpScalar_${e}`),d)}}}function g$(n){let e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return n.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function y$(n){let e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,t=0,r=n;e:for(;n.length;){let i=n.match(e);if(i===null)break;let a=i[0];switch(a.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){n=n.substring(a.length);break e}break}n=n.substring(a.length)}return t!==0?-1:r.length-n.length}function v$(n){let e=[],t=new Map;if(n===void 0)return{errors:e,parameters:t};let r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;n=n.trim(),n.length!=0;){let i=n.match(r);if(i===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=i[1];n=n.substring(i[0].length);let o=y$(n);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(n.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${a}: ${l}`);break}t.has(a)?e.push(`Duplicate #uicontrol parameter: ${a}`):t.set(a,l),n=n.substring(o),n=n.trim(),n.length>0&&!n.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),n=n.substring(1)}return{parameters:t,errors:e}}function S$(n,e){let t,r,i,a,o=[];n!=="float"&&n!=="uint"&&n!=="int"&&o.push("type must be float, int, or uint");for(let[l,c]of e){let d=()=>{if(typeof c!="number"){o.push(`Expected ${l} argument to be a number`);return}return(n==="int"||n==="uint")&&(Number.isInteger(c)||o.push(`Expected ${l} argument to be an integer`),n==="uint"&&c<0&&o.push(`Expected ${l} argument to be an unsigned integer`)),c};l==="min"?t=d():l==="max"?r=d():l==="default"?a=d():l==="step"?i=d():o.push(`Invalid parameter: ${l}`)}return t===void 0&&o.push("min must be specified"),r===void 0&&o.push("max must be specified"),t!==void 0&&r!==void 0&&(t>r&&o.push("min must be less than max"),i===void 0&&(n==="float"?i=(r-t)/100:i=1),a!==void 0?(a<t||a>r)&&o.push("default must be within valid range"):n==="float"?a=(t+r)/2:a=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:n,min:t,max:r,step:i,default:a},errors:void 0}}function b$(n,e){let t=!1,r=[];n!=="bool"&&r.push("type must be bool");for(let[i,a]of e)if(i==="default"){if(typeof a!="boolean"){r.push(`Expected ${i} argument to be a boolean`);continue}t=a}else r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:n,default:t},errors:void 0}}function x$(n,e){let t="white",r=[];n!=="vec3"&&r.push("type must be vec3");for(let[i,a]of e)i==="default"?typeof a!="string"?r.push("Expected default argument to be a string"):t=a:r.push(`Invalid parameter: ${i}`);return r.length>0?{errors:r}:{control:{type:"color",valueType:n,defaultString:t,default:ga(t)},errors:void 0}}function NP(n,e){typeof n=="number"&&(n=[n]);let t=new Array(e);return Je(t,n,r=>{if(!Number.isInteger(r)||r<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(r)}`);return r}),t}function C$(n,e,t){let r=[],{imageData:i}=t;if(i===void 0)return r.push("invlerp control not supported"),{errors:r};n!=="invlerp"&&r.push("type must be invlerp");let a=new Array(i.channelRank).fill(0),{dataType:o}=i,l=!0,c=Dc[o],d;for(let[p,m]of e)try{switch(p){case"range":{c=Ad(m,o);break}case"window":{d=GS(Ad(m,o));break}case"clamp":{typeof m!="boolean"?r.push(`Invalid clamp value: ${JSON.stringify(m)}`):l=m;break}case"channel":{a=NP(m,a.length);break}default:r.push(`Invalid parameter: ${p}`);break}}catch(y){r.push(`Invalid ${p} value: ${y.message}`)}return r.length>0?{errors:r}:{control:{type:"invlerp",dataType:o,clamp:l,default:{range:c,window:d!=null?d:X1(c),channel:a}},errors:void 0}}var w$=new Map([["slider",S$],["color",x$],["invlerp",C$],["checkbox",b$]]);function uo(n,e={}){n=g$(n);let t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,r=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,i=[],a=new Map,o=n.replace(t,(l,c,d)=>{var A;let p=c.match(r),m=()=>Math.max(0,n.substring(0,d).split(`
`).length-1);if(p===null)return i.push({line:m(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let y=p[1],v=p[2],b=(A=p[3])!=null?A:y,x=p[4],{parameters:C,errors:k}=v$(x);for(let D of k)i.push({line:m(),message:D});if(a.has(v)&&i.push({line:m(),message:`Duplicate definition for control ${v}`}),k.length>0)return"";let M=w$.get(b);if(M===void 0)return i.push({line:m(),message:`Invalid control type ${b}`}),"";let I=M(y,C,e);if(I.errors!==void 0){for(let D of I.errors)i.push({line:m(),message:D});return""}return a.set(v,I.control),""});return{source:n,code:o,errors:i,controls:a}}function BP(n){return`u_shaderControl_${n}`}function Wi(n,e){let{builderValues:t}=n;for(let[r,i]of n.parseResult.controls){let a=BP(r),o=t[r];switch(i.type){case"invlerp":{let l=[pm(e,a,i.dataType,i.clamp),`
float ${a}() {
  return ${a}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(l),e.addFragmentCode(`#define ${r} ${a}
`);break}case"checkbox":{let l=`#define ${r} ${o.value}
`;e.addFragmentCode(l),e.addVertexCode(l);break}default:{e.addUniform(`highp ${i.valueType}`,a),e.addVertexCode(`#define ${r} ${a}
`),e.addFragmentCode(`#define ${r} ${a}
`);break}}}}function T$(n){let e={};for(let[t,r]of n)e[t]=r;return e}function UP(n){if(n!==void 0)return JSON.stringify(T$(n))}var FP=class{constructor(){this.changed=new re;this.controls=void 0}get value(){return this.controls}set value(e){UP(e)!==UP(this.controls)&&(this.controls=e,this.changed.dispatch())}};function k$(n,e,t){return n===void 0?t:(Z(n),{range:pe(n,"range",r=>Ad(r,e),t.range),window:pe(n,"window",r=>GS(Ad(r,e)),t.window),channel:pe(n,"channel",r=>NP(r,t.channel.length),t.channel)})}var GP=class extends lt{constructor(e,t){super(t,r=>k$(r,e,t));this.dataType=e;this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:r},dataType:i,defaultValue:a}=this,o=WS(e,i,a.range),l=WS(t,i,a.window),c=Ee(a.channel,r)?void 0:r;if(!(o===void 0&&l===void 0&&c===void 0))return{range:o,window:l,channel:c}}};function WP(n){switch(n.type){case"slider":return{trackable:new lt(n.default,e=>{let t;if(n.valueType==="float"?t=ct(e):t=ft(e),t<n.min||t>n.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${n.min}, ${n.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new Jo(n.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new GP(n.dataType,n.default),getBuilderValue:e=>({channel:e.channel,dataType:n.dataType})};case"checkbox":return{trackable:new Mt(n.default),getBuilderValue:e=>({value:e})}}}function zP(n,e){return JSON.stringify(n)+"\0"+e.source}function rs(n){let e={};for(let[t,r]of n.controls){let{trackable:i,getBuilderValue:a}=WP(r);e[t]=a(i.value)}return{builderValues:e,parseResult:n,key:zP(e,n)}}var po=class extends z{constructor(e,t=Yr({}),r){super();this.fragmentMain=e;this.dataContext=t;this.channelCoordinateSpaceCombiner=r;this.changed=new re;this.controls=new FP;this.fragmentMainGeneration=-1;this.dataContextGeneration=-1;this.parseErrors_=[];this.processedFragmentMain_="";this.controlsGeneration=-1;this.parseResultChanged=new re;this.state_=new Map;this.unparsedJson=void 0;this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=fn((l,c)=>{let d={};for(let[p,{trackable:m,getBuilderValue:y}]of c){let v=y(m.value);d[p]=v}return{key:zP(d,l),parseResult:l,builderValues:d}},[this.parseResult,this],(l,c)=>l.key===c.key);let a=fn(l=>{let c=[];for(let{control:d,trackable:p}of l.values())d.type==="invlerp"&&c.push({channel:p.value.channel});return c},[this],(l,c)=>yd(l,c,(d,p)=>Ee(d.channel,p.channel))),o=ir(l=>{let c=[];for(let{control:d,trackable:p}of l.values())d.type==="invlerp"&&c.push(p.value.window);return c},this);this.histogramSpecifications=this.registerDisposer(new jd(a,o))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let r=this.dataContext.value;if(r===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let i=this.parseResult_=uo(this.fragmentMain.value,r);this.parseErrors_=i.errors,this.processedFragmentMain_=i.code,i.errors.length===0&&(this.controls.value=i.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(t===void 0)return;let r=!1,{state_:i,unparsedJson:a}=this;for(let[o,l]of i)if(t.get(o)===void 0){l.trackable.changed.remove(this.changed.dispatch),i.delete(o),r=!0;continue}for(let[o,l]of t){let c=i.get(o);if(c!==void 0&&JSON.stringify(c.control)!==JSON.stringify(l)&&(c.trackable.changed.remove(this.changed.dispatch),c=void 0),c===void 0){let{trackable:d,getBuilderValue:p}=WP(l);c={control:l,trackable:d,getBuilderValue:p},c.trackable.changed.add(this.changed.dispatch),i.set(o,c),r=!0}if(a!==void 0&&a.hasOwnProperty(o)){r=!0;try{c.trackable.restoreState(a[o])}catch{}}}a!==void 0&&(r=!0),this.unparsedJson=void 0,r&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;let{state:t}=this;if(Z(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,a]of t){let{trackable:o}=a;if(o.reset(),e.hasOwnProperty(i))try{o.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;let r={},i=!0;for(let[a,o]of e){let l=o.trackable.toJSON();l!==void 0&&(r[a]=l,i=!1)}if(!i)return r}};function HP(n,e,t,r,i){let a=BP(t),o=e.uniform(a);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":n.uniform1i(o,i);break;case"float":n.uniform1f(o,i)}break;case"color":n.uniform3fv(o,i);break;case"invlerp":Gc(e,a,r.dataType,i.range);break;case"checkbox":break}}function ai(n,e,t,r){let{state:i}=t;if(t.controls.value===r)for(let[a,o]of i)HP(n,e,a,o.control,o.trackable.value);else for(let[a,o]of r){let l=i.get(a),c=l!==void 0&&JSON.stringify(l.control)===JSON.stringify(o)?l.trackable.value:o.default;HP(n,e,a,o,c)}}function $P(n,e){return{defineShader(t,r){let i=`prop_${r}`,a=`a_${i}`;t.addAttribute(`${n}`,a),t.addVertexCode(`${n} ${i}() { return ${a}; }`),t.addInitializer(o=>{let l=o.attribute(a),{gl:c}=o;o.vertexShaderInputBinders[i]=l===-1?{enable(){},disable(){},bind(){}}:{enable(d){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,d)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(d,p){e(c,l,d,p)}}})}}}function Hb(n,e,t,r){return $P(n,(i,a,o,l)=>{i.vertexAttribPointer(a,e,t,r,o,l)})}function Wc(n,e,t){return $P(n,(r,i,a,o)=>{r.vertexAttribIPointer(i,e,t,a,o)})}var L$={rgb:Hb("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:Hb("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:Hb("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:Wc("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:Wc("highp int",1,WebGL2RenderingContext.INT),uint16:Wc("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:Wc("highp int",1,WebGL2RenderingContext.SHORT),uint8:Wc("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:Wc("highp int",1,WebGL2RenderingContext.BYTE)},fo=class extends z{constructor(e,t,r,i,a,o,l){super();this.gl=e;this.annotationType=t;this.rank=r;this.properties=i;this.shaderControlState=a;this.fallbackShaderParameters=o;this.shaderError=l;let c=this.serializedGeometryBytesPerAnnotation=Sn[t].serializedBytes(r),{offsets:d,serializedBytes:p}=HS(r,i);this.serializedBytesPerAnnotation=p+c,this.propertyOffsets=d}getDependentShader(e,t){return ii(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(r,i)=>{let{rank:a,properties:o}=this,l=[],c=i.parseResult.code;for(let m=0,y=o.length;m<y;++m){let v=o[m],b=`prop_${v.identifier}`;if(!c.match(new RegExp(`\\b${b}\\b`)))continue;l.push(m),L$[v.type].defineShader(r,v.identifier,a)}let{propertyOffsets:d}=this;r.addInitializer(m=>{let y=l.map(b=>m.vertexShaderInputBinders[`prop_${o[b].identifier}`]),v=y.length;m.vertexShaderInputBinders.properties={enable(b){for(let x=0;x<v;++x)y[x].enable(b)},bind(b,x){for(let C=0;C<v;++C)y[C].bind(b,x+d[l[C]])},disable(){for(let b=0;b<v;++b)y[b].disable()}}}),r.addUniform("highp vec3","uColor"),r.addUniform("highp uint","uSelectedIndex"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec3","uSubspaceMatrix",a),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp float","uModelClipBounds",a*2),r.addUniform("highp uint","uPickID"),r.addVarying("highp uint","vPickID","flat"),r.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),r.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let p=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;r.addVertexCode(p),r.addFragmentCode(p),r.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${a}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${a}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${a} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),Wi(i,r),r.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(let[m,y]of $b)m!==this.annotationType&&y.defineShaderNoOpSetters(r);t(r),r.addVertexCode(`
#define main userMain
`+Fi(i.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let r=`
void setPartIndex(${t.map((i,a)=>`highp uint partIndex${a}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((i,a)=>`highp uint pickOffset${a} = pickBaseOffset + partIndex${a};`).join(`
`)}
`;return t.length===0&&(r+=`
  highp uint pickOffset0 = pickBaseOffset;
`),r+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((i,a)=>` || selectedIndex == pickOffset${a}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(r),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,r){let{shader:i,parameters:a}=e(t.renderContext.emitter);if(i===null)return;i.bind();let{gl:o}=this,{renderContext:l}=t,{annotationLayer:c}=t;if(ai(o,i,this.shaderControlState,a.parseResult.controls),o.uniform3fv(i.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(i.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(i.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),l.emitPickID&&o.uniform1ui(i.uniform("uPickID"),t.basePickId),l.emitColor){let p=c.state.displayState.color.value;o.uniform3f(i.uniform("uColor"),p[0],p[1],p[2]),o.uniform1ui(i.uniform("uSelectedIndex"),t.selectedIndex)}let d=i.vertexShaderInputBinders.properties;d.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),d.bind(this.serializedBytesPerAnnotation,t.bufferOffset+this.serializedGeometryBytesPerAnnotation),r(i),d.disable()}},$b=new Map;function is(n,e){$b.set(n,e)}function as(n){return $b.get(n)}var dt;(function(c){c[c.GPU_MEMORY=0]="GPU_MEMORY",c[c.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",c[c.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",c[c.DOWNLOADING=3]="DOWNLOADING",c[c.QUEUED=4]="QUEUED",c[c.NEW=5]="NEW",c[c.FAILED=6]="FAILED",c[c.EXPIRED=7]="EXPIRED"})(dt||(dt={}));var fm=8,wa;(function(l){l[l.FIRST_TIER=0]="FIRST_TIER",l[l.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",l[l.VISIBLE=0]="VISIBLE",l[l.PREFETCH=1]="PREFETCH",l[l.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",l[l.RECENT=2]="RECENT",l[l.LAST_TIER=2]="LAST_TIER"})(wa||(wa={}));var jb=3,Xd;(function(t){t[t.totalTime=0]="totalTime",t[t.totalChunks=1]="totalChunks"})(Xd||(Xd={}));var Ta;(function(r){r[r.numChunks=0]="numChunks",r[r.systemMemoryBytes=1]="systemMemoryBytes",r[r.gpuMemoryBytes=2]="gpuMemoryBytes"})(Ta||(Ta={}));var ka=3,E$=2,qb=fm*jb*ka+E$;function os(n,e){return n*jb+e}function Jb(n){return fm*jb*ka+n}var jP="ChunkQueueManager",qP="ChunkManager",JP="ChunkSource.invalidate",YP="ChunkQueueManager.requestChunkStatistics",KP="ChunkManager.chunkLayerStatistics",cl=class{constructor(){this.numVisibleChunksNeeded=0;this.numVisibleChunksAvailable=0;this.numPrefetchChunksNeeded=0;this.numPrefetchChunksAvailable=0}};var XP=!1,Er=class{constructor(e){this.source=e;this.state=dt.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=dt.GPU_MEMORY}freeGPUMemory(e){this.state=dt.SYSTEM_MEMORY}};function QP(n){if(typeof n!="number"||n<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(n)}`);return n}var zc=class{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new lt(t,QP),this.itemLimit=new lt(e,QP)}},Qd=class extends Rn{constructor(e,t,r,i){super();this.gl=t;this.frameNumberCounter=r;this.capacities=i;this.visibleChunksChanged=new re;this.pendingChunkUpdates=null;this.pendingChunkUpdatesTail=null;this.chunkUpdateDeadline=null;this.chunkUpdateDelay=30;this.enablePrefetch=new Mt(!0,!0);let a=o=>({itemLimit:this.registerDisposer(Gt.makeFromExisting(e,o.itemLimit)).rpcId,sizeLimit:this.registerDisposer(Gt.makeFromExisting(e,o.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:a(i.gpuMemory),systemMemoryCapacity:a(i.systemMemory),downloadCapacity:a(i.download),computeCapacity:a(i.compute),enablePrefetch:this.registerDisposer(Gt.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e=this.chunkUpdateDeadline,t;e===null||Date.now()<e?t=0:t=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),t)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;!e&&t===null&&(t=Date.now()+30);let r=!1,i=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let a=this.pendingChunkUpdates;if(a==null)break;if(this.applyChunkUpdate(a)&&(r=!0),++i,(this.pendingChunkUpdates=a.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return r&&this.visibleChunksChanged.dispatch(),i}handleFetch_(e,t){let{resolve:r,reject:i,cancellationToken:a}=t.promise;if(a.isCanceled){i(Gd);return}let o=t.key,l=e.chunks.get(o);if(!l){i(new Error(`No chunk found at ${o} for source ${e.constructor.name}`));return}let c=l.data;if(!c){i(new Error(`At ${o} for source ${e.constructor.name}: chunk has no data`));return}r({value:c})}applyChunkUpdate(e){let t=!1,{rpc:r}=this,i=r.get(e.source);if(XP&&console.log(`${Date.now()} Chunk.update processed: ${i.rpcId} ${e.id} ${e.state}`),e.promise!==void 0)this.handleFetch_(i,e);else if(e.id===void 0){for(let a of i.chunks.keys())i.deleteChunk(a);t=!0}else{let a=e.state;if(a===dt.EXPIRED)i.deleteChunk(e.id);else{let o,l=e.id;e.new?(o=i.getChunk(e),i.addChunk(l,o)):o=i.chunks.get(l);let c=o.state;if(a!==c)switch(a){case dt.GPU_MEMORY:o.copyToGPU(this.gl),t=!0;break;case dt.SYSTEM_MEMORY:o.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${dt[a]}`)}}}return t}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke(YP,{queue:this.rpcId}),r=new Map;for(let[i,a]of t){let o=e.get(i);o!==void 0&&r.set(o,a)}return r}};Qd=Ut([_n(jP)],Qd);function ZP(n,e){let t=n.get(e.source);XP&&console.log(`${Date.now()} Chunk.update received: ${t.rpcId} ${e.id} ${e.state} with chunkDataSize ${e.chunkDataSize}`);let r=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){r.applyChunkUpdate(e)&&r.visibleChunksChanged.dispatch();return}let i=r.pendingChunkUpdatesTail;i==null?(r.pendingChunkUpdates=e,r.pendingChunkUpdatesTail=e,r.scheduleChunkUpdate()):(i.nextUpdate=e,r.pendingChunkUpdatesTail=e)}zt("Chunk.update",function(n){ZP(this,n)});am("Chunk.retrieve",function(n,e){return new Promise((t,r)=>{n.promise={resolve:t,reject:r,cancellationToken:e},ZP(this,n)})});zt(KP,function(n){let e=this.get(n.id);for(let t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(let t of n.layers){let r=this.get(t.id);if(r===void 0)continue;let i=r.layerChunkProgressInfo;i.numVisibleChunksAvailable=t.numVisibleChunksAvailable,i.numVisibleChunksNeeded=t.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(i)}e.layerChunkStatisticsUpdated.dispatch()});var Zd=class extends Rn{constructor(e){super();this.chunkQueueManager=e;this.memoize=new Vd;this.prevStatisticsLayers=[];this.layerChunkStatisticsUpdated=new re;this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(e,t){let r=e.encodeOptions(t);r.constructorId=St(e);let i=Mn(r);return this.memoize.get(i,()=>{let a=new e(this,t);return a.initializeCounterpart(this.rpc,{}),a.key=r,a})}};Zd=Ut([_n(qP)],Zd);var Jn=class extends Rn{constructor(e,t={}){super();this.chunkManager=e;this.chunks=new Map;this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===dt.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(JP,{id:this.rpcId})}static encodeOptions(e){return{}}};function mt(n,e){let t=class extends n{constructor(...i){super(...i);let a=i[1];this.parameters=a.parameters}initializeCounterpart(i,a){a.parameters=this.parameters,super.initializeCounterpart(i,a)}static encodeOptions(i){return Object.assign({parameters:i.parameters},super.encodeOptions(i))}};return t=Ut([_n(e.RPC_ID)],t),t}var La=class extends Rn{constructor(e){super();this.layerChunkProgressInfo=e}};var eI=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function tI(n,e,t){n.registerDisposer(e.visibleSegments.changed.add(t)),n.registerDisposer(e.segmentEquivalences.changed.add(t))}function nI(n,e,t){n.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),n.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Fr(n){return`${n.low},${n.high}`}function D$(n){return!!(n.high>>>31)}function Yb(n){return n.useTemporaryVisibleSegments.value?n.temporaryVisibleSegments:n.visibleSegments}function P$(n){return n.useTemporarySegmentEquivalences.value?n.temporarySegmentEquivalences:n.segmentEquivalences}function Ea(n,e){let t=Yb(n),r=P$(n),i=r.disjointSets.highBitRepresentative.value;for(let a of t)if(!!r.disjointSets.isMinElement(a))for(let o of r.setElements(a))i&&D$(o)||e(o,a)}var dI=rt(Ct());var Kb=rt(Ct());var rI="rendered_view.addLayer",iI="rendered_view.removeLayer",aI="SharedProjectionParameters",oI="SharedProjectionParameters.changed";var Dr;(function(r){r[r.info=0]="info",r[r.warning=1]="warning",r[r.error=2]="error"})(Dr||(Dr={}));var zi=class{constructor(){this.changed=new re;this.messages=[];this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(let e of this.children)yield*e}};var cr;(function(r){r[r.DATA=0]="DATA",r[r.ANNOTATION=1]="ANNOTATION",r[r.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(cr||(cr={}));function sI(){return new gS([0,1,2])}var hm=class extends z{constructor(){super(...arguments);this.role=0;this.messages=new zi;this.layerChanged=new re;this.redrawNeeded=new re;this.layerChunkProgressInfo=new cl}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,r,i){}},ep=class extends hm{constructor(){super(...arguments);this.visibility=new so}attach(e){}};function ss(n,e,t){let{state:r}=t;if(r===void 0||r.transform!==n||r.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),r=t.state={transform:n,displayDimensionRenderInfo:e,modelTransform:void 0},n.error!==void 0){t.messages.addMessage({severity:Dr.error,message:n.error});return}try{let i=ie.create();wD(i,e,n),r.modelTransform=i}catch(i){t.messages.addMessage({severity:Dr.error,message:i.message})}}return r.modelTransform}var tp=class extends z{constructor(e){super();this.renderViewport=new Ac;this.changed=new qe;let{parametersConstructor:t=Od,navigationState:r,update:i,isEqual:a=sD}=e;this.oldValue_=new t,this.value_=new t;let o=()=>{let{oldValue_:c,value_:d}=this;c.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,Object.assign(c,this.renderViewport);let{globalPosition:p}=c,m=r.position.value,y=m.length;p.length!==y&&(c.globalPosition=p=new Float32Array(y)),p.set(m),i(c,r),!a(c,d)&&(this.value_=c,this.oldValue_=d,this.changed.dispatch(d,c))},l=this.update=this.registerCancellable((0,Kb.default)(o,0));this.registerDisposer(r.changed.add(l)),o()}setViewport(e){Fh(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}},ul=class extends Rn{constructor(e,t,r=10){super();this.base=t;this.updateInterval=r;this.update=this.registerCancellable((0,Kb.default)((e,t)=>{let r;if(t.displayDimensionRenderInfo!==e.displayDimensionRenderInfo)r=t;else{let{displayDimensionRenderInfo:i,...a}=t;r=a}this.rpc.invoke(oI,{id:this.rpcId,value:r})},this.updateInterval));this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}};ul=Ut([_n(aI)],ul);var bn=40,lI=.5,cI=-4;function np(n){return(Math.log2(n)-cI)/lI}function uI(n){return 2**(n*lI+cI)}function Hi(n){return new lt(n,Lt)}var Da=class{constructor(){this.visibility=new so;this.changed=new re;this.frameNumber=-1;this.spatialScales=new Map;this.numHistogramRows=1;this.value=new Uint32Array(bn*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,r,i){let{spatialScales:a,numHistogramRows:o,value:l}=this,c=a.get(e);if(c===void 0&&(c=a.size,a.set(e,c)),c>=o){this.numHistogramRows=o*=2;let p=new Uint32Array(o*bn*2);p.set(l),this.value=l=p}let d=c*bn*2+Math.min(Math.max(0,Math.round(np(t))),bn-1);l[d]+=r,l[d+bn]+=i}};var Hc=class extends hm{constructor(e,t,r){super();this.chunkManager=e;this.multiscaleSource=t;this.rpcId=null;this.visibleSources=new Map;this.visibleSourcesList_=[];var a;let{renderScaleTarget:i=Hi(1)}=r;this.renderScaleTarget=i,this.renderScaleHistogram=r.renderScaleHistogram,this.transform=r.transform,this.localPosition=r.localPosition,this.dataHistogramSpecifications=this.registerDisposer((a=r.dataHistogramSpecifications)!=null?a:new jd(Yr([]),Yr([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){let{dataHistogramSpecifications:e}=this;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:r}=this,i=r.get(e);i!==void 0?++i.refCount:(r.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,r=t.get(e);r.refCount!==1?--r.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(let r of e.values())t.push(r);t.sort((r,i)=>r.chunkTransform.chunkToLayerTransformDet-i.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){let e=this.registerDisposer(new La(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(Gt.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Gt.makeFromExisting(t,this.renderScaleTarget)).rpcId}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return _D(e,this,t)}};Hc.prototype.RPC_TYPE_ID=OD;var Pa=class extends ep{draw(e,t){}isReady(e,t){return!0}};var pI=class extends Tb{},I$=ba(pI);function A$(n){return{source:n.source.addCounterpartRef(),effectiveVoxelSize:n.effectiveVoxelSize,layerRank:n.layerRank,nonDisplayLowerClipBound:n.nonDisplayLowerClipBound,nonDisplayUpperClipBound:n.nonDisplayUpperClipBound,lowerClipBound:n.lowerClipBound,upperClipBound:n.upperClipBound,lowerClipDisplayBound:n.lowerClipDisplayBound,upperClipDisplayBound:n.upperClipDisplayBound,chunkDisplayDimensionIndices:n.chunkDisplayDimensionIndices,lowerChunkDisplayBound:n.lowerChunkDisplayBound,upperChunkDisplayBound:n.upperChunkDisplayBound,fixedLayerToChunkTransform:n.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:n.combinedGlobalLocalToChunkTransform,chunkLayout:n.chunkLayout.toObject()}}function rp(n){return n.map(e=>e.map(A$))}function Xb(n,e){for(let t of e)for(let{source:r}of t)n.removeSource(r),r.dispose()}var $c=class extends I${constructor(e,t,r,i){super(new tp({parametersConstructor:wb,navigationState:r,update:(l,c)=>{let{invViewMatrix:d,centerDataPosition:p}=l;c.toMat4(d);let{canonicalVoxelFactors:m,voxelPhysicalScales:y}=l.displayDimensionRenderInfo;for(let D=0;D<3;++D)p[D]=d[12+D];let{logicalWidth:v,logicalHeight:b,projectionMat:x,viewportNormalInGlobalCoordinates:C,viewportNormalInCanonicalCoordinates:k}=l,{relativeDepthRange:M}=c;ie.ortho(x,-v/2,v/2,b/2,-b/2,-M,M),Uh(l,x),Hh(l);let{viewMatrix:I}=l;for(let D=0;D<3;++D){let E=C[D]=I[D*4+2];k[D]=E/m[D]}K.normalize(C,C),K.normalize(k,k);let A=0;for(let D=0;D<3;++D){let E=y[D],V=d[D];A+=(E*V)**2}A=Math.sqrt(A),l.pixelSize=A}}));this.chunkManager=e;this.layerManager=t;this.navigationState=r;this.wireFrame=i;this.gl=this.chunkManager.gl;this.viewChanged=new re;this.renderingStale=!0;this.visibleChunksStale=!0;this.visibleLayerList=new Array;this.offscreenFramebuffer=this.registerDisposer(new Gi(this.gl,{colorBuffers:al(this.gl,1),depthBuffer:new _b(this.gl)}));this.histogramInputTextures=[];this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer];this.histogramGenerator=qd.get(this.gl);this.updateVisibleLayers=this.registerCancellable((0,dI.default)(()=>{this.updateVisibleLayersNow()},0));this.registerDisposer(r),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((l,c)=>{l.displayDimensionRenderInfo!==c.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let a=this.chunkManager.rpc,o=this.sharedProjectionParameters=this.registerDisposer(new ul(a,this.projectionParameters));this.initializeCounterpart(a,{chunkManager:e.rpcId,projectionParameters:o.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(e,t,r){WD(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{r(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:r}of this.visibleLayers.values())for(let i of r){let a=Fc(this.projectionParameters.value,i.chunkLayout),{source:o}=i,{chunks:l}=o;this.forEachVisibleChunk(i,a,c=>{let d=l.get(c);++t,d&&d.state===dt.GPU_MEMORY&&++e})}return e===t}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:r}=e;r!==void 0&&t.push(r.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:r}=this,{displayDimensionRenderInfo:i}=this.projectionParameters.value,a=this.rpc,o={id:this.rpcId},l=!1;r.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof Hc){r.push(c);let d=t.get(c);if(d===void 0){let p=[],m=new zi;d={messages:m,allSources:this.getTransformedSources(c,m),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:p,lastSeenGeneration:e,displayDimensionRenderInfo:i},p.push(c.messages.addChild(d.messages)),t.set(c.addRef(),d),this.bindVisibleRenderLayer(c,p)}else{d.lastSeenGeneration=e;let p=c.transform.changed.count;if(d.transformGeneration===p&&d.displayDimensionRenderInfo===i)continue;let m=d.allSources;d.allSources=this.getTransformedSources(c,d.messages),Xb(c,m),d.visibleSources.length=0,d.displayDimensionRenderInfo=i,d.transformGeneration=p}o.layerId=c.rpcId,o.sources=rp(d.allSources),this.flushBackendProjectionParameters(),a.invoke(ND,o),l=!0}for(let[c,d]of t)d.lastSeenGeneration!==e&&(o.layerId=c.rpcId,a.invoke(BD,o),t.delete(c),Xb(c,d.allSources),Xa(d.disposers),c.dispose(),l=!0);return l&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),l}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,r=t[e];if(r===void 0){let{gl:i,histogramInputTextures:a,offscreenFramebuffer:o}=this;a.length<e&&a.push(...al(i,e-a.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let l=[o.colorBuffers[0].addRef()];for(let c=0;c<e;++c)l.push(a[c].addRef());r=this.registerDisposer(new Gi(i,{colorBuffers:l,depthBuffer:o.depthBuffer.addRef()})),t[e]=r}return r}updateRendering(){let e=this.projectionParameters.value,{width:t,height:r}=e;if(!this.renderingStale||!this.valid||t===0||r===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:i,offscreenFramebuffer:a}=this;a.bind(t,r),i.disable(i.SCISSOR_TEST),i.clearColor(0,0,0,0),i.colorMask(!0,!0,!0,!0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=0,l=this.wireFrame.value,c={sliceView:this,projectionParameters:e,wireFrame:l};for(let d of this.visibleLayerList){let p=l?0:d.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(p).bind(t,r);for(let y=0;y<p;++y)i.clearBufferfv(WebGL2RenderingContext.COLOR,1+y,Td);i.enable(WebGL2RenderingContext.DEPTH_TEST),i.depthFunc(WebGL2RenderingContext.LESS),i.clearDepth(1),i.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),d.setGLBlendMode(i,o),d.draw(c),++o}i.disable(WebGL2RenderingContext.BLEND),i.disable(WebGL2RenderingContext.DEPTH_TEST),a.unbind()}disposed(){for(let[e,t]of this.visibleLayers)Xb(e,t.allSources),Xa(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let r=op(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,i=>e.getSources(i),t,e);for(let i of r)for(let a of i)e.addSource(a.source,a.chunkTransform);return r}};$c=Ut([_n(VD)],$c);var ip=class extends Jn{constructor(e,t){super(e,t);this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}},ap=class extends Er{constructor(e,t){super(e);this.chunkGridPosition=t.chunkGridPosition,this.state=dt.SYSTEM_MEMORY}},dl=class extends z{constructor(e,t){super();this.gl=e;this.copyVertexPositionsBuffer=ts(this.gl);this.textureCoordinateAdjustment=new Float32Array(4);let r=new ri(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler"),r.addInitializer(i=>{e.uniform1i(i.uniform("uSampler"),0)}),r.addUniform("vec4","uColorFactor"),r.addUniform("vec4","uBackgroundColor"),r.addUniform("mat4","uProjectionMatrix"),r.addUniform("vec4","uTextureCoordinateAdjustment"),r.require(t),r.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),r.addAttribute("vec4","aVertexPosition"),r.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(r.build())}draw(e,t,r,i,a,o,l,c){let{gl:d,shader:p,textureCoordinateAdjustment:m}=this;m[0]=a,m[1]=o,m[2]=l-a,m[3]=c-o,p.bind(),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e),d.disable(WebGL2RenderingContext.BLEND),d.uniformMatrix4fv(p.uniform("uProjectionMatrix"),!1,t),d.uniform4fv(p.uniform("uColorFactor"),r),d.uniform4fv(p.uniform("uBackgroundColor"),i),d.uniform4fv(p.uniform("uTextureCoordinateAdjustment"),m);let y=p.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(y,2),d.drawArrays(d.TRIANGLE_FAN,0,4),d.disableVertexAttribArray(y),d.bindTexture(d.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${St(t)}`,()=>new dl(e,t))}},Qb=class{constructor(e){this.chunkManager=e}};function op(n,e,t,r,i){r.clearMessages();let a=k=>(r.addMessage({severity:Dr.error,message:k}),[]);if(e.error!==void 0)return a(e.error);let o=e.rank,l=e.unpaddedRank,{displayDimensionIndices:c,displayRank:d,canonicalVoxelFactors:p}=n,m=nm(e,c),{displayToLayerDimensionIndices:y}=m,v=new Float32Array(d*l),{modelToRenderLayerTransform:b}=e;for(let k=0;k<d;++k){let M=y[k];if(M===-1)continue;let I=p[k];for(let A=0;A<l;++A)v[d*A+k]=b[(o+1)*A+M]*I}let x=t({displayRank:d,multiscaleToViewTransform:v,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:C}=n;try{let k=M=>{let{chunkSource:I}=M,{spec:A}=I,{lowerClipBound:D=A.lowerVoxelBound,upperClipBound:E=A.upperVoxelBound}=M,V=tm(e,M.chunkToMultiscaleTransform),{chunkDataSize:N}=A,{channelToChunkDimensionIndices:U}=V,_=new Float32Array(l),B=new Float32Array(l);_.set(D),B.set(E);let R=U.length,{channelSpaceShape:X}=e;for(let Ae=0;Ae<R;++Ae){let Xe=U[Ae];if(Xe===-1)continue;let qt=X[Ae];if(N[Xe]!==qt)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[Ae]]+` has extent ${qt} but corresponding chunk dimension has extent ${N[Xe]}`);_[Xe]=Number.NEGATIVE_INFINITY,B[Xe]=Number.POSITIVE_INFINITY}let j=rm(V,m),oe=K.create(),me=K.create(),xe=K.create(),se=K.create(),Se=K.create(),{numChunkDisplayDims:Ie,chunkDisplayDimensionIndices:je}=j,{combinedGlobalLocalToChunkTransform:Be,layerRank:Pe,combinedGlobalLocalRank:ge}=V,$e=new Float32Array(Be);for(let Ae=0;Ae<Ie;++Ae){let Xe=je[Ae];for(let qt=0;qt<=ge;++qt)$e[Xe+qt*Pe]=0;Xe<l?(Se[Ae]=A.chunkDataSize[Xe],oe[Ae]=A.lowerChunkBound[Xe],me[Ae]=A.upperChunkBound[Xe],xe[Ae]=D[Xe],se[Ae]=E[Xe],_[Xe]=Number.NEGATIVE_INFINITY,B[Xe]=Number.POSITIVE_INFINITY):(Se[Ae]=1,oe[Ae]=0,me[Ae]=1,xe[Ae]=0,se[Ae]=1)}Se.fill(1,Ie),oe.fill(0,Ie),me.fill(1,Ie),xe.fill(0,Ie),se.fill(1,Ie);let ht=new il(Se,j.displaySubspaceModelMatrix,Ie),Dt=ht.localSpatialVectorToGlobal(K.create(),kh);for(let Ae=0;Ae<d;++Ae)Dt[Ae]*=C[Ae];return Dt.fill(1,d),{layerRank:Pe,lowerClipBound:D,upperClipBound:E,nonDisplayLowerClipBound:_,nonDisplayUpperClipBound:B,renderLayer:i,source:I,lowerChunkDisplayBound:oe,upperChunkDisplayBound:me,lowerClipDisplayBound:xe,upperClipDisplayBound:se,effectiveVoxelSize:Dt,chunkLayout:ht,chunkDisplayDimensionIndices:je,fixedLayerToChunkTransform:$e,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:V.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:V,chunkDisplayTransform:j}};return x.map(M=>M.map(I=>k(I)))}catch(k){for(let D of x)for(let{chunkSource:E}of D)E.dispose();let{globalDimensionNames:M}=n,A=`Cannot render (${Array.from(n.displayDimensionIndices.filter(D=>D!==-1),D=>M[D]).join(",\xA0")}) cross section: ${k.message}`;return a(A)}}var pl=null,M$=200,Ke=class{constructor(e=!1){if(pl===null){pl=document.createElement("ul"),pl.id="statusContainer";let r=document.getElementById("neuroglancer-container");r?r.appendChild(pl):document.body.appendChild(pl)}let t=document.createElement("li");this.element=t,e===!0&&(e=M$),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,pl.appendChild(t)}dispose(){pl.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let r=new Ke(t.delay);r.setText(t.initialMessage);let i=r.dispose.bind(r);return e.then(i,a=>{let o;a instanceof Error?o=a.message:o=""+a;let{errorPrefix:l=""}=t;r.setErrorMessage(l+o),r.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new Ke;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let r=this.showMessage(e);return window.setTimeout(()=>r.dispose(),t),r}};function Zb(n){let e=0,{typeToIds:t}=n;for(let r of Ni)e+=as(r).pickIdsPerInstance*t[r].length;return e}var ex=class{constructor(e){this.bufferValid=!1;this.numPickIds=0;this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}},fI=class extends Er{constructor(e,t){super(e);t.data!==void 0&&(this.data=new ex(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},tx=class extends ap{constructor(e,t){super(e,t);t.data!==void 0&&(this.data=new ex(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}},fl=class extends ip{constructor(e,t){super(e,t);this.immediateChunkUpdates=!0;(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:a}=this.spec,o=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);_c(o,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let l=0;l<i;++l)for(let c=0;c<i+1;++c)o[(i+1)*c+l]/=a[l]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new tx(this,e)}};fl=Ut([_n(HD)],fl);var mm=class extends Jn{constructor(e,t,r){super(e,{});this.parent=t;this.relationshipIndex=r;this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new fI(this,e)}};mm=Ut([_n($D)],mm);var hI=class extends Er{constructor(e,t){super(e);this.annotation=QS(t.annotation)}},gm=class extends Jn{constructor(e,t){super(e);this.parent=t}getChunk(e){return new hI(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:r}=this.parent,i=r.get(e);i!==void 0&&(i.value=t.annotation,i.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,r=t.get(e);r!==void 0&&(r.value=void 0,r.changed.dispatch())}};gm=Ut([_n(zD)],gm);function ym(n,e,t){let{rank:r}=t,i=e.type,{serializedAnnotations:a}=n,o=a.typeToIds[i],l=a.typeToIdMaps[i],c=Sn[i],d=c.serializedBytes(r),p=d+t.serializedBytes,m=l.get(e.id),y=0;if(m===void 0){m=l.size,o.push(e.id),l.set(e.id,m);let C=new Uint8Array(a.data.length+p);y=a.typeToOffset[i]+p*m,C.set(a.data.subarray(0,y),0),C.set(a.data.subarray(y),y+p),a.data=C;for(let k of Ni)k>i&&(a.typeToOffset[k]+=p)}else y=a.typeToOffset[i]+p*m;let v=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength),b=a.typeToOffset[i]+m*p,x=eo===An.LITTLE;c.serialize(v,b,x,r,e),b+=d,t.serialize(v,b,x,e.properties),n.bufferValid=!1}function vm(n,e,t,r){let{serializedAnnotations:i}=n,a=i.typeToIdMaps[e],o=a.get(t);if(o===void 0)return!1;let l=i.typeToIds[e],c=Sn[e],{rank:d}=r,m=c.serializedBytes(d)+r.serializedBytes;l.splice(o,1),a.delete(t);for(let C=o,k=l.length;C<k;++C)a.set(l[C],C);let{typeToOffset:y}=i,v=y[e]+m*o,{data:b}=i,x=new Uint8Array(b.length-m);x.set(b.subarray(0,v),0),x.set(b.subarray(v+m),v),i.data=x;for(let C of Ni)C>e&&(y[C]-=m);return n.bufferValid=!1,!0}function R$(){let n=[],e=[],t=[];for(let r of Ni)n[r]=[],e[r]=0,t[r]=new Map;return new tx(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:n,typeToIdMaps:t})}var $i=class extends Rn{constructor(e,t){super();this.chunkManager=e;this.metadataChunkSource=this.registerDisposer(new gm(this.chunkManager,this));this.spatiallyIndexedSources=new Set;this.temporary=R$();this.references=new Map;this.localUpdates=new Map;this.numCommitsInProgress=0;this.changed=new re;this.readonly=!1;this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializer=new _d(this.rank,this.properties);let r=this.segmentFilteredSources=[],{relationships:i}=t;this.relationships=i;for(let a=0,o=i.length;a<o;++a)r.push(this.registerDisposer(new mm(e,this,a)))}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(let r of this.segmentFilteredSources)r.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(r=>r.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=Bh();let r=new Rd(e.id);return r.value=e,this.references.set(r.id,r),r.registerDisposer(()=>{this.references.delete(r.id)}),this.applyLocalUpdate(r,!1,t,e),r}applyLocalUpdate(e,t,r,i){let{localUpdates:a}=this,{id:o}=e,l=this.localUpdates.get(o),c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},a.set(o,l),this.forEachPossibleChunk(c,d=>{let{data:p}=d;p!==void 0&&vm(p,c.type,o,this.annotationPropertySerializer)}),i!==null&&ym(this.temporary.data,i,this.annotationPropertySerializer)):(i===null?vm(this.temporary.data,c.type,c.id,this.annotationPropertySerializer):ym(this.temporary.data,i,this.annotationPropertySerializer),e.value=i),r)if(l.commitInProgress!==void 0)l.pendingCommit=i;else{if(i===null&&l.existingAnnotation===void 0){a.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(JD,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let r=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);i!==void 0&&(i.annotation=t||null),r!==void 0&&(r.value=t||null,r.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new Rd(e),this.references.set(e,t),this.rpc.invoke(jD,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke(qD,{id:this.rpcId,annotation:e})});let r=this.metadataChunkSource.chunks.get(e);return r!==void 0&&(t.value=r.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:r}=e;if(r!==void 0){let c=r.length,{segmentFilteredSources:d}=this;for(let p=0;p<c;++p){let m=r[p];if(m===void 0)return;let y=d[p];for(let v of m){let b=y.chunks.get(Fr(v));b!==void 0&&t(b)}}}let{rank:i}=this,a=new Float32Array(i),o=new Float32Array(i),l=new Float32Array(i);for(let c of this.spatiallyIndexedSources){switch(e.type){case ze.POINT:ei(a,c.multiscaleToChunkTransform,i+1,e.point,i),o.set(a);break;case ze.LINE:case ze.AXIS_ALIGNED_BOUNDING_BOX:ei(a,c.multiscaleToChunkTransform,i+1,e.pointA,i),ei(o,c.multiscaleToChunkTransform,i+1,e.pointB,i);break;case ze.ELLIPSOID:ei(a,c.multiscaleToChunkTransform,i+1,e.center,i),jh(o,c.multiscaleToChunkTransform,i+1,e.radii,i);for(let m=0;m<i;++m){let y=a[m],v=o[m];a[m]=y-v,o[m]=y+v}break}let d=1;for(let m=0;m<i;++m){let y=a[m],v=o[m],b=Math.min(y,v),x=Math.max(y,v);a[m]=Math.ceil(b-1),o[m]=Math.floor(x+1),d*=o[m]-a[m]}let{chunks:p}=c;for(let m=0;m<d;++m){let y=m;for(let b=0;b<i;++b){let x=a[b],k=o[b]-x,M=l[b]=y%k;y=(y-M)/k}let v=p.get(l.join());v!==void 0&&t(v)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&r.reference.id!==t.id){if(r.commitInProgress===null)throw new Error("Received invalid successful update notification");r.reference.id=t.id,this.references.delete(e),this.references.set(t.id,r.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,r),r.reference.value!==null&&(r.reference.value.id=t.id,vm(this.temporary.data,r.type,e,this.annotationPropertySerializer),ym(this.temporary.data,r.reference.value,this.annotationPropertySerializer)),r.reference.changed.dispatch()}r.existingAnnotation=t||void 0,r.commitInProgress=void 0;let{pendingCommit:i}=r;r.pendingCommit=void 0,t===null&&(i=void 0),i!==void 0?(i!==null&&(i.id=t.id),this.sendCommitRequest(r,i)):this.revertLocalUpdate(r)}disposed(){let{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ke(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ke().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(r),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){vm(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializer);let{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,a=>{let{data:o}=a;o!==void 0&&ym(o,t,this.annotationPropertySerializer)});let{reference:r}=e,{id:i}=r;r.value=t||null,r.changed.dispatch(),r.dispose(),this.localUpdates.delete(i)}*[Symbol.iterator](){}};zt(YD,function(n){let e=this.get(n.id),t=n.annotationId,r=n.error;if(r!==void 0)e.handleFailedUpdate(t,r);else{let i=QS(n.newAnnotation);e.handleSuccessfulUpdate(t,i)}});var mI="CredentialsProvider",gI="CredentialsProvider.get";var sp=class extends Rn{constructor(e,t){super();this.provider=e;this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}};sp=Ut([_n(mI)],sp);am(gI,function(n,e){return this.get(n.providerId).get(n.invalidCredentials,e).then(r=>({value:r}))});function lp(n,e){if(e===void 0)return;let t=n.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:St(e)},()=>new sp(e.addRef(),n.rpc)),r=t.addCounterpartRef();return t.dispose(),r}function Rt(){return function(n){class e extends n{constructor(...r){super(...r);var a;let i=r[1];this.credentialsProvider=(a=i.credentialsProvider)==null?void 0:a.addRef()}initializeCounterpart(r,i){let{credentialsProvider:a}=this;i.credentialsProvider=lp(this.chunkManager,a),super.initializeCounterpart(r,i)}static encodeOptions(r){let i=super.encodeOptions(r),{credentialsProvider:a}=r;return i.credentialsProvider=a===void 0?void 0:St(a),i}}return e}}function ho(n,e){return n<e?-1:n>e?1:0}var yI={offset:0,completions:[]};function Gr(n,e){return e.offset+=n,e}function Sm(n,e){let t=[];for(let r of e)r.startsWith(n)&&t.push({value:r});return t.sort((r,i)=>ho(r.value,i.value)),t}function xn(n,e,t,r){let i=[];for(let a of e){let o=t(a);o.startsWith(n)&&i.push({value:o,description:r(a)})}return i.sort((a,o)=>ho(a.value,o.value)),i}async function _$(n,e,t){if(n.startsWith("{"))return yI;let i=n.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],a=n.length-i.length,o=i.indexOf("=");if(o===-1){let l=await e(i);return{offset:l.offset+a,completions:l.completions.map(c=>({...c,value:`${c.value}=`}))}}return Gr(a+o+1,await t(i.substring(0,o),i.substring(o+1)))}async function bm(n,e){return _$(n,async t=>{let r=[];for(let i of e){let a=i.key;a.value.startsWith(t)&&r.push(a)}return{offset:0,completions:r}},async(t,r)=>{for(let i of e)if(i.key.value===t)return{offset:0,completions:i.values.filter(a=>a.value.startsWith(r))};return yI})}var xm=class extends Error{constructor(e){super(`Redirected to: ${e}`);this.redirectTarget=e}};function vI(n,e){e===void 0&&(n.indexOf("/")===-1?e=":":e="/");let t=n.lastIndexOf(e);return t===-1?0:t+1}function V$(n,e){let t=vI(n,e);return n.substring(t)}var bi;(function(t){t[t.annotations=0]="annotations",t[t.equivalences=1]="equivalences"})(bi||(bi={}));function Cm(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}var Ht=class extends z{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}},nx="local://annotations",wm="local://equivalences",SI=class extends Ht{get description(){return"Local in-memory"}async get(e){switch(e.url){case nx:{let{transform:t}=e,r;if(t===void 0){let i=e.globalCoordinateSpace.value,{rank:a,names:o,scales:l,units:c}=i,d=He({rank:a,scales:l,units:c,names:o.map((m,y)=>`${y}`)}),p=He({rank:a,scales:l,units:c,names:o});r={rank:a,sourceRank:a,inputSpace:d,outputSpace:p,transform:sr(Float64Array,a+1)}}else r=Et(Ui);return{modelTransform:r,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case wm:return{modelTransform:Et(Ui),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:xn(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}},bI=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/,rx=class extends z{constructor(e){super();this.credentialsManager=e;this.dataSources=new Map([["local",new SI]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){let t=e.match(bI);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');let[,r,i]=t,a=this.dataSources.get(r);if(a===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(r)}.`);return[a,i,r]}async get(e){let t=new Set,{cancellationToken:r=At}=e,i=e.url;for(;;){let[a,o,l]=this.getProvider(e.url);t.add(e.url);try{return a.get({...e,url:i,providerProtocol:l,providerUrl:o,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager})}catch(c){if(c instanceof xm){let d=c.redirectTarget;if(t.has(d))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);i=d;continue}throw c}}}convertLegacyUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}normalizeUrl(e){try{let[t,r,i]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:r,providerProtocol:i,registry:this})}catch{return e.url}}async completeUrl(e){let{url:t,cancellationToken:r=At}=e,i=t.match(bI),a=i[1];if(a===void 0)return Promise.resolve({offset:0,completions:xn(t,this.dataSources,([o])=>`${o}://`,([,o])=>o.description)});{let o=this.dataSources.get(a);if(o!==void 0){let l=await o.completeUrl({registry:this,url:t,providerUrl:i[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return Gr(a.length+3,l)}throw null}}suggestLayerName(e){let[t,r]=this.getProvider(e);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=t.suggestLayerName;return i!==void 0?i(r):V$(r)}findSourceGroup(e){let[t,r,i]=this.getProvider(e);return(t.findSourceGroup||vI)(r)+i.length+3}};var ji=class extends Error{constructor(e,t,r){let i=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;r&&(i+=`: ${r}`),i+=".",super(i),this.name="HttpError",this.message=i,this.url=e,this.status=t,this.statusText=r}static fromResponse(e){return new ji(e.url,e.status,e.statusText)}static fromRequestError(e,t){if(t instanceof TypeError){let r;return typeof e=="string"?r=e:r=e.url,new ji(r,0,"Network or CORS error")}return t}};async function ls(n,e){let t;try{t=await fetch(n,e)}catch(r){throw ji.fromRequestError(n,r)}if(!t.ok)throw ji.fromResponse(t);return t}function Tm(n){return n.arrayBuffer()}function $t(n){return n.json()}async function hl(n,e,t,r=At){if(r===At){let o=await ls(n,e);return await t(o)}let i=new AbortController,a=r.add(()=>i.abort());try{let o=await ls(n,{...e,signal:i.signal});return await t(o)}finally{a()}}var hre=new Q;function ml(n){let e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/,t=n.match(e);if(t===null)throw new Error(`Invalid URL: ${JSON.stringify(n)}`);return{protocol:t[1],host:t[2],path:t[3]}}function gl(n){return n instanceof ji?n.status===0||n.status===403||n.status===404:!1}async function cs(n,e,t,r,i,a,o=At){let l;e:for(;;){l=await n.get(l,o);t:for(;;)try{return await hl(typeof e=="function"?e(l.credentials):e,i(l.credentials,t),r,o)}catch(c){if(c instanceof ji){if(a(c,l.credentials)==="refresh")continue e;continue t}throw c}}}function Ia(n,e,t,r,i=At){return n===void 0?hl(e,t,r,i):cs(n,e,t,r,(a,o)=>{if(!a.accessToken)return o;let l=new Headers(o.headers);return l.set("Authorization",`${a.tokenType} ${a.accessToken}`),{...o,headers:l}},(a,o)=>{let{status:l}=a;if(l===401)return"refresh";if(l===504||l===503)return"retry";if(l===403&&!o.accessToken)return"refresh";throw a},i)}var ix="google-brainmaps";function yl(n,e,t,r=At){return Ia(e,`${n.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?$t:Tm,r)}var mo;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(mo||(mo={}));var km=class{};km.RPC_ID="brainmaps/VolumeChunkSource";var Lm=class{};Lm.RPC_ID="brainmaps/MultiscaleMeshSource";var Em=class{};Em.RPC_ID="brainmaps/MeshSource";var Dm=class{};Dm.RPC_ID="brainmaps/SkeletonSource";var Pm=class{};Pm.RPC_ID="brainmaps/Annotation";var Im=class{};Im.RPC_ID="brainmaps/AnnotationSpatialIndex";var xI="mesh/MeshLayer",CI="mesh/MultiscaleMeshLayer",wI="mesh/FragmentSource",TI="mesh/MultiscaleFragmentSource",xi;(function(r){r[r.float32=0]="float32",r[r.uint10=1]="uint10",r[r.uint16=2]="uint16"})(xi||(xi={}));function kI(n,e,t){return n&1|e<<1&2|t<<2&4}var Am=!1;function O$(n,e,t,r,i,a,o){let{octree:l,lodScales:c,chunkGridSpatialOrigin:d,chunkShape:p}=n,m=c.length-1,y=e[0],v=e[4],b=e[8],x=e[1],C=e[5],k=e[9],M=e[3],I=e[7],A=e[11],D=e[15],E=M>0?0:1,V=I>0?0:1,N=A>0?0:1,U=t[4*4],_=t[4*4+1],B=t[4*4+2],R=t[4*4+3];function X(Dt,Ae,Xe){return M*Dt+I*Ae+A*Xe+D}function j(Dt,Ae,Xe,qt,Me,Bn){return X(Dt+E*(qt-Dt),Ae+V*(Me-Ae),Xe+N*(Bn-Xe))}let oe=X(-R*U,-R*_,-R*B),me=n.clipLowerBound[0],xe=n.clipLowerBound[1],se=n.clipLowerBound[2],Se=n.clipUpperBound[0],Ie=n.clipUpperBound[1],je=n.clipUpperBound[2],Be=Math.sqrt((y*i)**2+(x*a)**2),Pe=Math.sqrt((v*i)**2+(C*a)**2),ge=Math.sqrt((b*i)**2+(k*a)**2),$e=Math.max(Be,Pe,ge);function ht(Dt,Ae,Xe){let qt=1<<Dt,Me=Ae*5,Bn=l[Me],Oe=l[Me+1],ln=l[Me+2],pi=l[Me+3],aa=l[Me+4],_r=Bn*qt*p[0]+d[0],oa=Oe*qt*p[1]+d[1],le=ln*qt*p[2]+d[2],ke=_r+qt*p[0],fe=oa+qt*p[1],Re=le+qt*p[2];if(_r=Math.max(_r,me),oa=Math.max(oa,xe),le=Math.max(le,se),ke=Math.min(ke,Se),fe=Math.min(fe,Ie),Re=Math.min(Re,je),Eh(_r,oa,le,ke,fe,Re,t)){let tt=Math.max(oe,j(_r,oa,le,ke,fe,Re))/$e;if(Xe===0||tt*r<Xe){let ce=c[Dt];if(ce!==0&&o(Dt,Ae,ce/tt,aa>>>31),Dt>0&&(ce===0||tt*r<ce)){let De=ce===0?Xe:ce,ot=(aa&2147483647)>>>0;for(let Qe=pi;Qe<ot;++Qe)ht(Dt-1,Qe,De)}}}}ht(m,l.length/5-1,0)}function ax(n,e,t,r,i,a,o,l){let{lodScales:c}=n,d=0;for(;d+1<c.length&&c[d+1]!==0;)++d;let p=3,m=[],y=0,v=0;function b(k,M){for(Am&&console.log(`emitChunksUpTo: stackDepth=${y}, targetStackIndex=${k}, subChunkIndex=${M}, priorSubChunkIndex=${v}`);;){if(y===0)return;let I=y-1,A=d-I,D=m[I*p],E=A===0?1:8,V=m[I*p+1],N=m[I*p+2];if(k===y){let U=M&E-1;v!==U&&D!==-1&&(Am&&console.log(`  drawing chunk because priorSubChunkIndex (${v}) != endSubChunk (${U})`),l(A,D,v,U,N)),v=U+1;return}v!==E&&D!==-1&&l(A,D,v,E,N),v=V+1,--y}}let x=0;Am&&(console.log(""),console.log("Starting to draw"));let{octree:C}=n;O$(n,e,t,r,i,a,(k,M,I,A)=>{if(!A&&!o(k,M,I)){x=Math.max(k,x);return}if(k<x)return;x=0;let D=M*5,E=C[D],V=C[D+1],N=C[D+2],U=kI(E,V,N),_=d-k;b(_,U);let B=_*p;m[B]=A?-1:M,m[B+1]=U,m[B+2]=I,Am&&console.log(`Adding to stack: lod=${k}, row=${m[B]}, subChunkIndex=${U}`),v=0,y=_+1}),b(0,0)}function LI(n){if(n.length%5!=0)throw new Error("Invalid length");let e=n.length/5,t=new Set;function r(i){if(t.has(i))throw new Error("Previously seen node");if(t.add(i),i<0||i>=e)throw new Error("Invalid node reference");let a=n[i*5],o=n[i*5+1],l=n[i*5+2],c=n[i*5+3],d=n[i*5+4];if(c<0||d<0||d<c||d>e||c+8<d)throw new Error("Invalid child references");for(let p=c;p<d;++p){let m=n[p*5],y=n[p*5+1],v=n[p*5+2];if(m>>>1!==a||y>>>1!==o||v>>>1!=l)throw new Error("invalid child");r(p)}}if(e!==0&&(r(e-1),t.size!==e))throw new Error("Orphan nodes in octree")}function ox(n,e,t){return`${n}/${e}:${t}`}var Wr=class extends ep{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}};var N$=3432918353,B$=461845907;function jc(n,e){return e>>>=0,n>>>=0,e=Math.imul(e,N$)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,B$)>>>0,n=(n^e)>>>0,n=(n<<13|n>>>19)>>>0,n=n*5+3864292196>>>0,n}var Mm=3,U$=.9,us=!1,Aa=0,Ma=0,EI=0,DI=0,qc=class{constructor(e=qc.generateHashSeeds(Mm)){this.hashSeeds=e;this.loadFactor=U$;this.size=0;this.emptyLow=4294967295;this.emptyHigh=4294967295;this.maxRehashAttempts=5;this.maxAttempts=5;this.generation=0;this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=qc.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=new Array(t);for(let c=0;c<t;++c)r[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:i}=this;if(i===-1){e:for(;;){i=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let d=this.getHash(c,i,i);for(let p=0;p<t;++p)if(r[p]===d)continue e}this.mungedEmptyKey=i;break}}let{table:a,emptyLow:o,emptyHigh:l}=this;for(let c=0;c<t;++c){let d=r[c];a[d]===o&&a[d+1]===l&&(a[d]=i,a[d+1]=i)}try{e(a)}finally{for(let c=0;c<t;++c){let d=r[c];a[d]===i&&a[d+1]===i&&(a[d]=o,a[d+1]=l)}}}static generateHashSeeds(e=Mm){return eD(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=jc(i,t),i=jc(i,r),this.entryStride*(i&this.tableSize-1)}*keys(e=new Q){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this;for(let o=0,l=a.length;o<l;o+=i){let c=a[o],d=a[o+1];(c!==t||d!==r)&&(e.low=c,e.high=d,yield e)}}indexOfPair(e,t){let{table:r,emptyLow:i,emptyHigh:a}=this;if(e===i&&t===a)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){let c=this.getHash(o,e,t);if(r[c]===e&&r[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let{emptyLow:e,emptyHigh:t,table:r,entryStride:i}=this,a,o;for(;a=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(a===e&&o===t)&&!this.hasPair(a,o)););this.emptyLow=a,this.emptyHigh=o;for(let l=0,c=r.length;l<c;l+=i)r[l]===e&&r[l+1]===t&&(r[l]=a,r[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let{table:r}=this;return r[t]=this.emptyLow,r[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,entryStride:t,emptyLow:r,emptyHigh:i}=this,a=e.length;for(let o=0;o<a;o+=t)e[o]=r,e[o+1]=i}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}swapPending(e,t){let r=Aa,i=Ma;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){Aa=e[t],Ma=e[t+1]}backupPending(){EI=Aa,DI=Ma}restorePending(){Aa=EI,Ma=DI}tryToInsert(){us&&console.log(`tryToInsert: ${Aa}, ${Ma}`);let e=0,{emptyLow:t,emptyHigh:r,maxAttempts:i,table:a}=this,o=this.hashSeeds.length,l=Math.floor(Math.random()*o);for(;;){let c=this.getHash(l,Aa,Ma);if(this.swapPending(a,c),Aa===t&&Ma===r)return!0;if(++e===i)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){us&&console.log("rehash begin"),this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{emptyLow:r,emptyHigh:i,entryStride:a}=this;for(let o=0,l=e.length;o<l;o+=a){let c=e[o],d=e[o+1];if((c!==r||d!==i)&&(this.storePending(e,o),!this.tryToInsert()))return us&&console.log("rehash failed"),!1}return us&&console.log("rehash end"),!0}grow(e){us&&console.log(`grow: ${e}`);let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let i=0;i<this.maxRehashAttempts;++i)if(this.rehash(t,r)){us&&console.log("grow end");return}r*=2}}insertInternal(){for(++this.generation,Aa===this.emptyLow&&Ma===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}},Rm=class extends qc{add(e){let{low:t,high:r}=e;return this.hasPair(t,r)?!1:(us&&console.log(`add: ${t},${r}`),Aa=t,Ma=r,this.insertInternal(),!0)}[Symbol.iterator](){return this.keys()}};Rm.prototype.entryStride=2;var cp=0,up=0,PI=0,II=0,Jc=class extends qc{set(e,t){let{low:r,high:i}=e;return this.hasPair(r,i)?!1:(us&&console.log(`add: ${r},${i} -> ${t.low},${t.high}`),Aa=r,Ma=i,cp=t.low,up=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(r===-1)return!1;let{table:i}=this;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=cp,i=up;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),cp=e[t+2],up=e[t+3]}backupPending(){super.backupPending(),PI=cp,II=up}restorePending(){super.restorePending(),cp=PI,up=II}[Symbol.iterator](){return this.entries()}*entries(e=[new Q,new Q]){let{emptyLow:t,emptyHigh:r,entryStride:i}=this,{table:a}=this,[o,l]=e;for(let c=0,d=a.length;c<d;c+=i){let p=a[c],m=a[c+1];(p!==t||m!==r)&&(o.low=p,o.high=m,l.low=a[c+2],l.high=a[c+3],yield e)}}};Jc.prototype.entryStride=4;var qi=class{},vl=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],F$=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],_m=["","r","rg","rgb","rgba"],G$=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],W$=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],z$=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],H$=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],AI=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],$$=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],j$=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function Yc(n){return n===G.FLOAT32?"":Ph[n]?"i":"u"}function Ci(n,e,t=1){switch(e){case G.UINT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=G$[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint8Array,n.samplerPrefix="u",n;case G.INT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=W$[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Int8Array,n.samplerPrefix="i",n;case G.UINT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=z$[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint16Array,n.samplerPrefix="u",n;case G.INT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=H$[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Int16Array,n.samplerPrefix="i",n;case G.UINT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=AI[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case G.INT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=$$[t],n.textureFormat=vl[t],n.texelType=WebGL2RenderingContext.INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Int32Array,n.samplerPrefix="i",n;case G.UINT64:if(t<1||t>2)break;return n.texelsPerElement=1,n.textureInternalFormat=AI[t*2],n.textureFormat=vl[t*2],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=2*t,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case G.FLOAT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=j$[t],n.textureFormat=F$[t],n.texelType=WebGL2RenderingContext.FLOAT,n.arrayElementsPerTexel=t,n.arrayConstructor=Float32Array,n.samplerPrefix="",n}throw new Error(`No supported texture format for ${G[e]}[${t}].`)}function ds(n,e,t){let{arrayConstructor:r,arrayElementsPerTexel:i,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=e,{maxTextureSize:c}=n,d=t.length/i;if(d*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+d);let p=Math.ceil(d/c),m=Math.ceil(Math.log2(p)),y=(1<<m)*l,v=Math.ceil(d/(1<<m)),b=y*v*i;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT));let x=sE(t,b);n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),co(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,y,v,0,o,e.texelType,x)}function MI(n,e,t,r,i){let{arrayConstructor:a,textureInternalFormat:o,textureFormat:l,texelsPerElement:c}=e;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),co(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,r*c,i,0,l,e.texelType,t)}function RI(n,e,t,r,i,a){let{arrayConstructor:o,textureInternalFormat:l,textureFormat:c,texelsPerElement:d}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),cP(n),n.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,r*d,i,a,0,c,e.texelType,t)}function q$(n){switch(n){case G.UINT8:return Nb;case G.INT8:return Bb;case G.UINT16:return Ub;case G.INT16:return Fb;case G.UINT32:return ol;case G.INT32:return Gb;case G.UINT64:return tn;case G.FLOAT32:return um}}function _I(n,e,t,r,i,a){let o=Xt(i,a),l=[q$(i)],c=`
${o} ${n}(${r} index) {
`;switch(i){case G.UINT8:case G.UINT16:case G.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${_m[a]};
  return result;
`;break;case G.INT8:case G.INT16:case G.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${_m[a]};
  return result;
`;break;case G.UINT64:l.push(SP),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${_m[a*2]});
`;break;case G.FLOAT32:l.push(um),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${_m[a]};
`;break}return c+=`
}
`,l.push(c),l}var go=class{constructor(e){this.key=e;this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let r=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let i=0;i<e;++i)r+=`
  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);
`;return r+=`
}
`,[TP,r]}getAccessor(e,t,r,i=1){let a=Yc(r);return[this.getReadTextureValueCode(1,a),..._I(e,this.readTextureValue,t,"highp uint",r,i)]}},sx=class{constructor(e,t){this.key=e;this.textureDims=t;this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){let{textureDims:r}=this,i=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${r} p`;for(let a=0;a<e;++a)i+=`, out ${t}vec4 output${a}`;i+=`) {
`;for(let a=0;a<e;++a)i+=`
  output${a} = texelFetch(sampler, ivec${r}(p.x * ${e} + ${a}, p.y
                                         ${r===3?", p.z":""}), 0);
`;return i+=`
}
`,i}getAccessor(e,t,r,i=1){let a=Yc(r);return[this.getReadTextureValueCode(1,a),..._I(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,r,i)]}};var lx=[tn,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],J$=Ci(new qi,G.UINT64,1),Sl=class extends z{constructor(e,t){super();this.gl=e;this.hashTable=t;this.generation=-1;this.texture=null;this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:r,texture:i}=this;this.generation=t,r.activeTexture(WebGL2RenderingContext.TEXTURE0+r.tempTextureUnit),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey(a=>{ds(this.gl,J$,a)}),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}},Vm=class{constructor(e,t=Mm){this.prefix=e;this.numAlternatives=t;this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`);this.accessHelper=new go(`gpuhashtable_${this.prefix}`);this.samplerName=this.prefix+"_sampler";this.hashSeedsName=this.prefix+"_seeds";this.hashKeyMask=this.prefix+"_keyMask";this.readTable=this.prefix+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:r,numAlternatives:i,hashKeyMask:a}=this;e.addUniform("highp uint",t,i),e.addUniform("highp uint",a),e.addTextureSampler("usampler2D",r,this.textureUnitSymbol),e.addFragmentCode(lx),e.addFragmentCode(tn),e.addFragmentCode(cm),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,G.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<i;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${a};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,r){r.copyToGPU();let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r.texture),e.uniform1ui(t.uniform(this.hashKeyMask),r.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),r.hashTable.hashSeeds)}disable(e,t){let r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}},dp=class extends Vm{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:r,hashKeyMask:i}=this,a=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)a+=`
  {
    uint h = hashCombine(${r}[${o}], x) & ${i};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get getFunctionName(){return`${this.prefix}_get`}};function bl(n,e,t,r){e*=6;let i=Math.floor(e),a=e-i,o=r*(1-t),l=r*(1-t*a),c=r*(1-t*(1-a));switch(i%6){case 0:n[0]=r,n[1]=c,n[2]=o;break;case 1:n[0]=l,n[1]=r,n[2]=o;break;case 2:n[0]=o,n[1]=r,n[2]=c;break;case 3:n[0]=o,n[1]=l,n[2]=r;break;case 4:n[0]=c,n[1]=o,n[2]=r;break;case 5:n[0]=r,n[1]=o,n[2]=l;break}return n}function VI(n,e,t,r){let i=Math.max(Math.max(e,t),r),a=Math.min(Math.min(e,t),r);if(n[2]=i,a===i)n[0]=0,n[1]=0;else{let o=i-a;n[1]=o/i,e===i?n[0]=(t-r)/o:t===i?n[0]=2+(r-e)/o:n[0]=4+(e-t)/o,n[0]/=6,n[0]<0&&(n[0]+=1),n[0]>1&&(n[0]-=1)}return n}var OI=2,cx=class{constructor(e){this.prefix=e;this.seedName=this.prefix+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(tn),e.addFragmentCode(lx),e.addFragmentCode(vP);let r=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${OI} v;
`;for(let i=0;i<OI;++i)r+=`
  v[${i}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;r+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(r)}enable(e,t,r){e.uniform1ui(t.uniform(this.seedName),r)}},NI=new Float32Array(3);function ux(n){return`rgb(${n[0]*100}%,${n[1]*100}%,${n[2]*100}%)`}var pp=class{constructor(e=zS()){this.hashSeed=e;this.changed=new re}static getDefault(){return new pp(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let r=jc(this.hashSeed,t.low);r=jc(r,t.high);let i=(r&255)/255,a=(r>>8&255)/255;return bl(e,i,.5+.5*a,1),e}computeCssColor(e){return this.compute(NI,e),ux(NI)}randomize(){this.hashSeed=zS(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}},dx=class{constructor(e){this.prefix=e;this.hashMapShaderManager=new dp("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec3 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,r){this.hashMapShaderManager.enable(e,t,r)}disable(e,t){this.hashMapShaderManager.disable(e,t)}};var Om='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowLeftIconTitle"><path d="M9 6l-6 6 6 6"></path><path d="M21 12H4"></path><path stroke-linecap="round" d="M3 12h1"></path></svg>';var Nm='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowRightIconTitle"><path d="M15 18l6-6-6-6"></path><path d="M3 12h17"></path><path stroke-linecap="round" d="M21 12h-1"></path></svg>';var px=class{constructor(e){this.parents=new Array;this.parentPriorities=new Array;this.bindings=new Map;if(e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(let[t,r]of e.bindings)this.bindings.set(t,r)}}addParent(e,t){let{parents:r,parentPriorities:i}=this,a=0,{length:o}=r;for(;a<o&&t<i[a];)++a;return r.splice(a,0,e),i.splice(a,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;++a)if(o=t[a].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;a<i;++a)if(o=t[a].get(e),o!==void 0)return o}*getAll(e){let{parents:t,parentPriorities:r}=this,i=r.length,a=0,o;for(;a<i&&r[a]>0;)o=t[a].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);a<i;)o=t[a].get(e),o!==void 0&&(yield o)}*entries(){let{parents:e,parentPriorities:t}=this,r=t.length,i=0;for(;i<r&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<r;++i)yield*e[i].entries()}};var jt;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(jt||(jt={}));function Y$(n){return(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.metaKey?4:0)|(n.shiftKey?8:0)}function fx(n,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=n,t}function K$(n,e,t){let r="";return e&1&&(r+="control+"),t&1&&(r+="control?+"),e&2&&(r+="alt+"),t&2&&(r+="alt?+"),e&4&&(r+="meta+"),t&4&&(r+="meta?+"),e&8&&(r+="shift+"),t&8&&(r+="shift?+"),r+=n,r}function BI(n){let e=n.indexOf(":"),t;if(e!==-1&&(t=n.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);let r=n.substring(e+1).split("+"),i,a=0,o=0;e:for(let l of r)switch(l){case"control":a|=1;break;case"control?":o|=1;break;case"alt":a|=2;break;case"alt?":o|=2;break;case"meta":a|=4;break;case"meta?":o|=4;break;case"shift":a|=8;break;case"shift?":o|=8;break;default:if(i===void 0)i=l;else{i=void 0;break e}}if(i===void 0||a&o)throw new Error(`Invalid event identifier: ${JSON.stringify(n)}`);return{phase:t,keyName:i,modifiers:a,optionalModifiers:o}}function*X$(n,e,t){t===0&&(yield fx(n,e));for(let r=0;r<16;++r)(r&(e|t))===r&&(r&e)===e&&(yield fx(n,r))}function*UI(n){let{phase:e}=n,t=X$(n.keyName,n.modifiers,n.optionalModifiers);if(e===void 0)for(let r of t)yield`at:${r}`,yield`bubble:${r}`;else for(let r of t)yield`${e}:${r}`}function Q$(n,e){let t=K$(n.keyName,n.modifiers,n.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}var Fe=class extends px{static fromObject(e,t={}){let r=new Fe;if(r.label=t.label,t.parents!==void 0)for(let[i,a]of t.parents)r.addParent(i,a);for(let i of Object.keys(e))r.set(i,e[i]);return r}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let r=BI(e),i=Q$(r,t);for(let a of UI(r))super.set(a,i)}delete(e){for(let t of UI(BI(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,r]of this.entries())t.set(r.originalEventIdentifier,r.action);for(let[r,i]of t)e.push(`${r}\u2192${i}`);return e.join(", ")}};function hx(n,e,t){if(t===void 0)return;t.stopPropagation!==!1&&n.stopPropagation();let r=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),i=!n.target.dispatchEvent(r);(t.preventDefault!==!1||i)&&n.preventDefault()}var Bm=[];Bm[Event.AT_TARGET]="at";Bm[Event.CAPTURING_PHASE]="capture";Bm[Event.BUBBLING_PHASE]="bubble";function mx(n,e,t,r,i){let a=Bm[t]+":"+n,o=i.get(a);hx(e,r,o)}function Um(n,e,t,r){mx(fx(n,Y$(e)),e,e.eventPhase,t,r)}function ue(n,e,t,r){return Gn(n,`action:${e}`,t,r)}var gx;function Z$(){if(gx===void 0){let n=new Fe;n.set("keyl","recolor"),n.set("keyx","clear-segments"),n.set("keys","toggle-show-slices"),n.set("keyb","toggle-scale-bar"),n.set("keyv","toggle-default-annotations"),n.set("keya","toggle-axis-lines"),n.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)n.set("digit"+e,"toggle-layer-"+e),n.set("control+digit"+e,"select-layer-"+e),n.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){let t=String.fromCharCode(97+e),r=String.fromCharCode(65+e);n.set(`shift+key${t}`,`tool-${r}`)}n.set("keyn","add-layer"),n.set("keyh","help"),n.set("space","toggle-layout"),n.set("shift+space","toggle-layout-alternative"),n.set("backslash","toggle-show-statistics"),gx=n}return gx}var yx;function Kc(){return yx===void 0&&(yx=Fe.fromObject({"control+mousedown2":"select-position"})),yx}var vx;function FI(){return vx===void 0&&(vx=Fe.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[Kc(),0]]})),vx}var Sx;function GI(){return Sx===void 0&&(Sx=Fe.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[Kc(),0]]})),Sx}var bx;function ej(){return bx===void 0&&(bx=Fe.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[GI(),Number.NEGATIVE_INFINITY]]})),bx}var xx;function tj(){return xx===void 0&&(xx=Fe.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[GI(),Number.NEGATIVE_INFINITY]]})),xx}function WI(n){n.global.addParent(Z$(),Number.NEGATIVE_INFINITY),n.sliceView.addParent(tj(),Number.NEGATIVE_INFINITY),n.perspectiveView.addParent(ej(),Number.NEGATIVE_INFINITY)}function We(n){for(;;){let e=n.firstChild;if(!e)break;n.removeChild(e)}}function ut(n){let{parentElement:e}=n;return e?(e.removeChild(n),!0):!1}function Vn(n,e=Math.max(1,n.value.length)){let t=`${e}ch`;n.style.width!==t&&(n.style.width="0px",n.offsetWidth,n.style.width=t)}function Yn(n,e){let t=n.firstElementChild;for(let r of e)r!==t&&n.insertBefore(r,t),t=r.nextElementSibling;for(;t!==null;){let r=t.nextElementSibling;n.removeChild(t),t=r}}function fp(n){return n instanceof HTMLElement?!!(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n.isContentEditable):!1}function zI(n){let e=n.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}var Xc,hp=[];function nj(){if(Xc===void 0){let n=Xc=document.createElement("div");n.classList.add("neuroglancer-drag-status"),document.body.appendChild(n)}return Xc}function rj(){Xc!==void 0&&(We(Xc),Xc.style.display="none")}function HI(n){let e=nj();We(e),typeof n=="string"?e.appendChild(document.createTextNode(n)):e.appendChild(n()),e.style.display=""}function $I(n,e){fh(hp,t=>!(t.target===n&&t.operation===e))}function Pr(n,e,t){$I(n,e),hp.push({target:n,operation:e,status:t}),HI(t)}function hn(n,e){$I(n,e);let t=hp.length===0?void 0:hp[hp.length-1];t===void 0?rj():HI(t.status)}var ij=300,aj=100,wi={side:"right",col:0,row:Infinity,flex:1,size:ij,minSize:aj,visible:!1},ur=class{constructor(e=wi,t=e){this.defaultValue=e;this.value=t;this.changed=new qe;this.locationChanged=new qe;this.locationChanged.add(this.changed.dispatch);let r=this;this.watchableVisible={get value(){return r.visible},set value(i){r.visible=i},changed:r.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:r}=this;for(let i in r)r[i]!==e[i]&&(t[i]=r[i]);return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;Z(e);let r={side:pe(e,"side",i=>{if(i!=="left"&&i!=="right"&&i!=="top"&&i!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(i)}`);return i},t.side),col:pe(e,"col",ct,t.col),row:pe(e,"row",ct,t.row),flex:pe(e,"flex",ct,t.flex),size:pe(e,"size",Bt,t.size),visible:pe(e,"visible",ya,t.visible),minSize:t.minSize};this.value=r,this.locationChanged.dispatch()}};function Kn(n,e,t){let{document:r}=n.view,i=n.clientX,a=n.clientY,o=p=>{let m=p.clientX-i,y=p.clientY-a;i=p.clientX,a=p.clientY,e(p,m,y)},l=n.button,c=p=>{r.removeEventListener("pointermove",o,!0),r.removeEventListener("pointerup",d,!1),t!==void 0&&t(p,p.clientX-i,p.clientY-a)},d=p=>{p.button===l&&c(p)};r.addEventListener("pointermove",o,!0),r.addEventListener("pointerup",d,!1),r.addEventListener("pointercancel",c,!1)}var jI='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="closeIconTitle"><path d="M6.34314575 6.34314575L17.6568542 17.6568542M6.34314575 17.6568542L17.6568542 6.34314575"></path></svg>';function it(n){let{title:e,onClick:t,href:r}=n,i;r!==void 0?(i=document.createElement("a"),i.href=r,i.target="_blank"):i=document.createElement("div"),e!==void 0&&(i.title=e),t!==void 0&&i.addEventListener("click",t);let{svg:a}=n;return i.className="neuroglancer-icon",a!==void 0&&(i.innerHTML=a),n.text!==void 0&&i.appendChild(document.createTextNode(n.text)),i}function Qc(n={}){return it({svg:jI,...n})}var xl="neuroglancer-drag-over",qI={row:"row",column:"col"},oj={left:"right",right:"left",top:"bottom",bottom:"top"},ps={left:"column",right:"column",top:"row",bottom:"row"},Fm={left:"row",right:"row",top:"column",bottom:"column"},Zc={row:"width",column:"height"},JI={row:"left",column:"top"},sj={row:"right",column:"bottom"},YI={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},Gm={left:-1,right:1,top:-1,bottom:1},zr=class extends z{constructor(e,t=new ur){super();this.sidePanelManager=e;this.location=t;this.element=document.createElement("div");this.visibility=new Vt(Vt.VISIBLE);let{element:r}=this;r.classList.add("neuroglancer-side-panel"),r.draggable=!0,r.addEventListener("dragstart",i=>{this.sidePanelManager.startDrag(this.makeDragSource(),i),r.style.backgroundColor="black",setTimeout(()=>{r.style.backgroundColor=""},0),Pr(r,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),r.addEventListener("dragend",i=>{this.sidePanelManager.endDrag(),hn(r,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{let t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){let t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");let{title:r}=e,i;r!==void 0&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=r,t.appendChild(i));let a=Qc({title:"Close panel",onClick:()=>{this.close()}});return a.style.order="100",t.appendChild(a),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:a}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}},Cx=class extends z{constructor(e,t,r=new Vt(Vt.VISIBLE)){super();this.display=e;this.center=t;this.visibility=r;this.element=document.createElement("div");this.centerColumn=document.createElement("div");this.beforeRender=new qe;this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")};this.registeredPanels=new Set;this.layoutNeedsUpdate=!1;this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:i,centerColumn:a}=this;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",a.style.display="flex",a.style.flex="1",a.style.flexDirection="column",a.style.flexBasis="0px",a.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),!!this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,Gm[e]*Infinity,0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,r,i,a=!1){let o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";let l=10,c=ps[i],d=Fm[i];return o.style[Zc[d]]=`${l}px`,o.style[Zc[c]]="100%",a?(o.style.position="absolute",o.style[i]="50%",o.style[YI[i]]="-${size/2}px"):(o.style.position="relative",o.style[YI[oj[i]]]=`-${l}px`),o.addEventListener("dragenter",p=>{!this.hasDroppablePanel()||(o.classList.add(xl),p.preventDefault(),Pr(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{hn(o,"drop"),o.classList.remove(xl)}),o.addEventListener("dragover",p=>{!this.hasDroppablePanel()||p.preventDefault()}),o.addEventListener("drop",p=>{let{dragSource:m}=this;if(m===void 0)return;hn(o,"drop"),o.classList.remove(xl);let y=ps[e];m.dropAsNewPanel({side:e,row:y==="column"?r:t,col:y==="row"?r:t}),this.dragSource=void 0,p.preventDefault(),p.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)==null||t.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e==null||e.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let o of this.registeredPanels)e[o.location.value.side].push(o);let t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),r=this;function*i(){yield r.sides.left.outerDropZoneElement,yield*t("left"),yield r.centerColumn,yield*t("right"),yield r.sides.right.outerDropZoneElement}Yn(this.element,i());function*a(){yield r.sides.top.outerDropZoneElement,yield*t("top"),yield r.center,yield*t("bottom"),yield r.sides.bottom.outerDropZoneElement}Yn(this.centerColumn,a())}makeCrossGutter(e,t){let r=document.createElement("div");r.style.position="relative";let i=Fm[e];r.className=`neuroglancer-resize-gutter-${i==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();let l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let d=l.element.getBoundingClientRect()[Zc[i]],p=l.minSize,m=()=>{Pr(r,"drag",`Drag to resize, current ${Zc[i]} is ${l.crossSize}px`)};m(),Kn(o,(y,v,b)=>{let x=i==="row"?v:b;d-=Gm[e]*x,l.crossSize=Math.max(p,Math.round(d)),m(),this.invalidateLayout()},()=>{hn(r,"drag")})});let a=this.makeDropZone(e,t-Gm[e]*.5,0,e,!0);return r.appendChild(a),r}makeFlexGutter(e,t,r){let i=document.createElement("div");i.style.position="relative";let a=ps[e];i.className=`neuroglancer-resize-gutter-${a==="row"?"horizontal":"vertical"}`,i.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();let c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;let{cells:d}=c,p=d[r];if(p===void 0||!p.registeredPanel.location.visible)return;let m=r+1;for(;m<d.length&&!d[m].registeredPanel.location.visible;)++m;if(m===d.length)return;let y=d[m],v=()=>{Pr(i,"drag",`Drag to resize, current ${Zc[a]} ratio is ${p.registeredPanel.location.value.flex} : ${y.registeredPanel.location.value.flex}`)};v(),Kn(l,b=>{let x=p.registeredPanel.panel,C=y.registeredPanel.panel;if(x===void 0||C===void 0)return;let k=x.element.getBoundingClientRect(),M=C.element.getBoundingClientRect(),I=Math.max(.1,Math.min(.9,a==="column"?(b.clientY-k.top)/(M.bottom-k.top):(b.clientX-k.left)/(M.right-k.left))),A=p.registeredPanel.location.value,D=y.registeredPanel.location.value,E=A.flex+D.flex;p.registeredPanel.location.value={...A,flex:Math.round(I*E*100)/100},y.registeredPanel.location.value={...D,flex:Math.round((1-I)*E*100)/100},v(),p.registeredPanel.location.locationChanged.dispatch(),y.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{hn(i,"drag")})});let o=this.makeDropZone(e,t,r+.5,JI[ps[e]],!0);return i.appendChild(o),i}renderSide(e,t,r){let i=qI[Fm[e]],a=qI[ps[e]];r.sort((c,d)=>{let p=c.location.value,m=d.location.value,y=p[a]-m[a];return y!==0?y:p[i]-m[i]});let o=this;function*l(){let c=0,d=r.length,p=0;for(;c<d;){let m=r[c].location.value[a],y=c,v=0,b=0;do{let M=r[y].location.value;if(M[a]!==m)break;M.visible&&(++v,b=Math.max(b,M.minSize)),++y}while(y<d);let x=v>0,C=t[p];if(C===void 0){let M=o.makeCrossGutter(e,p),I=document.createElement("div");I.className=`neuroglancer-side-panel-${ps[e]}`,C=t[p]={element:I,gutterElement:M,cells:[],crossSize:-1,minSize:b,visible:x,beginDropZone:o.makeDropZone(e,p,-Infinity,JI[ps[e]]),endDropZone:o.makeDropZone(e,p,Infinity,sj[ps[e]])}}else C.visible=x,C.minSize=b,C.crossSize=Math.max(C.crossSize,b);function*k(){yield C.beginDropZone;let M=0;for(let I=c,A=0;I<y;++I,++A){let D=r[I],E=C.cells[A];E===void 0?E=C.cells[A]={registeredPanel:D,gutterElement:void 0}:E.registeredPanel=D;let V=E.registeredPanel.location.value;C.crossSize==-1&&(C.crossSize=Math.max(b,V.size)),(V[a]!==p||V[i]!==A||V.visible&&V.size!==C.crossSize)&&(E.registeredPanel.location.value={...V,[a]:p,[i]:A,size:V.visible?C.crossSize:V.size},E.registeredPanel.location.changed.dispatch());let N=V.visible&&o.visibility.visible,{panel:U}=D;if(!N){U!==void 0&&(U.dispose(),D.panel=void 0);continue}++M,U===void 0&&(U=D.panel=D.makePanel()),U.element.style.flex=v>1?`${V.flex}`:"1",yield U.element,M===v?E.gutterElement=void 0:(E.gutterElement===void 0&&(E.gutterElement=o.makeFlexGutter(e,p,A)),yield E.gutterElement)}yield C.endDropZone}Yn(C.element,k()),C.cells.length=y-c,x&&(C.element.style[Zc[Fm[e]]]=`${C.crossSize}px`,Gm[e]>0?(yield C.gutterElement,yield C.element):(yield C.element,yield C.gutterElement)),c=y,++p}t.length=p}return l()}};function Ir(n,e="text/plain"){let t=!1,r=Gn(document,"copy",i=>{let{clipboardData:a}=i;a!==null&&(a.setData(e,n),t=!0),i.stopPropagation(),i.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return t}var On=class extends z{constructor(e,t,r){super();this.target=e;this.eventMap=t;this.registerEventListener(e,"wheel",i=>{r!==void 0&&r(i),this.dispatch("wheel",i)}),this.registerEventListener(e,"click",i=>{r!==void 0&&r(i),this.dispatch(`click${i.button}`,i)}),this.registerEventListener(e,"dblclick",i=>{r!==void 0&&r(i),this.dispatch(`dblclick${i.button}`,i)}),this.registerEventListener(e,"mousedown",i=>{r!==void 0&&r(i),this.dispatch(`mousedown${i.button}`,i)}),this.registerEventListener(e,"mouseup",i=>{r!==void 0&&r(i),this.dispatch(`mouseup${i.button}`,i)})}dispatch(e,t){Um(e,t,t,this.eventMap)}};var dr=class extends z{constructor(e,t){super();this.element=it({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");let r=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(r)),r()}};var KI='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="copyIconTitle"><rect width="12" height="14" x="8" y="7"></rect><polyline points="16 3 4 3 4 17"></polyline></svg>';function Ar(n={}){return it({svg:KI,...n})}var XI=class extends z{constructor(e){super();this.redraw=e}},Xn=class extends z{constructor(e,t,r=new Vt(Vt.VISIBLE)){super();this.model=e;this.render=t;this.visibility=r;this.element=document.createElement("div");this.generation=-1;this.currentViewDisposer=void 0;this.debouncedUpdateView=this.registerCancellable(Ye(()=>this.updateView()));this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(r.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this;if(e.changed.count===this.generation)return;this.disposeCurrentView();let r=this.currentViewDisposer=new XI(this.debouncedUpdateView);this.render(e.value,this.element,r)}disposeCurrentView(){let{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),We(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}};function Wm(n={}){return it({text:"\u2197",...n})}function wx(n){return n.closest(".neuroglancer-selection-details")}var Tx=class extends zr{constructor(e,t,r,i){super(e,t.location);this.sidePanelManager=e;this.state=t;this.manager=r;this.selectedLayer=i;this.body=document.createElement("div");let{element:a,body:o}=this;a.classList.add("neuroglancer-selection-details"),this.registerDisposer(new On(this.element,Kc()));let{titleBar:l}=this.addTitleBar({title:"Selection"}),c=it({svg:Om,title:"Previous selection",onClick:()=>{this.state.goBack()}}),d=it({svg:Nm,title:"Next selection",onClick:()=>{this.state.goForward()}});l.appendChild(c),l.appendChild(d),l.appendChild(this.registerDisposer(new dr(t.pin,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Xn(t,(p,m,y)=>{if(!t.location.visible||(c.style.visibility=t.canGoBack()?"visible":"hidden",d.style.visibility=t.canGoForward()?"visible":"hidden",p===void 0))return;let{position:v}=p;if(v!==void 0){let b=document.createElement("div");b.classList.add("neuroglancer-selection-details-position");let x=Ar({title:"Copy position",onClick:()=>{Ir(M.map(A=>Math.floor(A)).join(", "))}});b.appendChild(x);let{coordinateSpace:{rank:C,names:k},position:M}=p;for(let A=0;A<C;++A){let D=document.createElement("span");D.classList.add("neuroglancer-selection-details-position-dimension");let E=document.createElement("span");E.classList.add("neuroglancer-selection-details-position-dimension-name"),E.textContent=k[A];let V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(M[A]).toString(),D.appendChild(E),D.appendChild(V),b.appendChild(D)}let I=Wm({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=M}});b.appendChild(I),m.appendChild(b)}for(let b of p.layers){let{layer:x}=b;m.appendChild(y.registerDisposer(new Xn({value:void 0,changed:x.managedLayer.layerChanged},(C,k,M)=>{if(x.wasDisposed||!x.isReady)return;let I=document.createElement("div");if(I.classList.add("neuroglancer-selection-details-layer-body"),!x.displaySelectionState(b.state,I,M))return;let A=document.createElement("div");k.appendChild(A),A.classList.add("neuroglancer-selection-details-layer");let D=document.createElement("div");D.classList.add("neuroglancer-selection-details-layer-title"),D.textContent=x.managedLayer.name,D.addEventListener("click",()=>{this.selectedLayer.layer=x.managedLayer,this.selectedLayer.visible=!0}),D.title="Click to show layer side panel",A.appendChild(D),A.appendChild(I)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}};var QI='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="filterIconTitle"><path d="M10 12.261L4.028 3.972h16L14 12.329V17l-4 3z"></path></svg>';function ZI(n={}){return it({svg:QI,...n})}var Ji=class{constructor(e,t,r){this.key=e;this.value=t;this.label=r}toString(){let{key:e,value:t,label:r}=this,i;return t===void 0?i=`${e}`:i=`${e}\u2192${t}`,r===void 0?i:`${i} ${r}`}},kx=class extends z{constructor(){super(...arguments);this.selectedSegment=new Q;this.baseSelectedSegment=new Q;this.hasSelectedSegment=!1;this.changed=new re}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let{selectedSegment:r,baseSelectedSegment:i}=this,a=0,o=0,l=0,c=0,d;if(e==null)d=!1;else if(typeof e=="number")a=l=e,o=c=0,d=!0;else if(e instanceof Ji){let p=e.value||e.key;a=p.low,o=p.high,l=e.key.low,c=e.key.high,d=!0}else e instanceof Q?(a=l=e.low,o=c=e.high,d=!0):d=!1;t&&a===0&&o===0&&(d=!1),d?d&&(!this.hasSelectedSegment||r.low!==a||r.high!==o||i.low!==l||i.high!==c)&&(r.low=a,r.high=o,i.low=l,i.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&Q.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let r=e.get(t),i;r!==void 0&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}};function mp(n){n.useTemporarySegmentEquivalences.value=!1,n.useTemporaryVisibleSegments.value=!1,n.temporaryVisibleSegments.clear(),n.temporarySegmentEquivalences.clear()}function Lx(n,e,t=!1){let r,i,a,o;if(typeof e=="number"?r=new Q(e,0):typeof e=="string"?r=Q.parseString(e):r=t?e.clone():e,n==null)return r;let{segmentEquivalences:l,segmentPropertyMap:{value:c}}=n.segmentationGroupState.value;return l.size!==0?(i=l.get(r),Q.equal(i,r)?a=void 0:a=i):i=r,o=c==null?void 0:c.getSegmentLabel(i),o===void 0&&a==null?r:new Ji(r,a,o)}function fs(n,e){if(e instanceof Ji)return e;let t=Lx(n,e);return t instanceof Q?new Ji(t):t}function eA(n,e){let{length:t}=e;n.value<t&&(n.value=t)}function hs(n,e){return Kr(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),n.segmentationGroupState.value.maxIdLength)}var Ex=(()=>{let n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry");let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),n.appendChild(e);let t=Ar({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");let r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");let i=r.childElementCount;r.appendChild(t);let a=e.childElementCount;e.appendChild(r);let o=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);let c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");let d=e.childElementCount;e.appendChild(c);let p=document.createElement("div");p.classList.add("neuroglancer-segment-list-entry-id");let m=c.childElementCount;c.appendChild(p);let y=document.createElement("span");y.classList.add("neuroglancer-segment-list-entry-name");let v=n.childElementCount;n.appendChild(y);let b=ZI({title:"Filter by label"});b.classList.add("neuroglancer-segment-list-entry-filter");let x=n.childElementCount;return n.appendChild(b),{template:n,copyContainerIndex:a,copyIndex:i,visibleIndex:o,idContainerIndex:d,idIndex:m,labelIndex:v,filterIndex:x,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),lj=(()=>{let n=Ex,e=n.template.cloneNode(!0),t=e.children[0],r=t.children[n.idContainerIndex],i=r.childElementCount,a=r.children[n.idIndex].cloneNode(!0);a.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(a);let o=t.children[n.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[n.copyIndex].cloneNode(!0)),{...n,template:e,unmappedIdIndex:i,unmappedCopyIndex:l}})();function cj(n){let e=Ex,t=e.template.cloneNode(!0),r=[];for(let i=0;i<n;++i){r.push(t.childElementCount);let a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry-extra-property"),a.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,t.appendChild(a)}return{...e,template:t,numericalPropertyIndices:r}}var tA=new WeakMap;function uj(n){let e=d=>{let p=d.currentTarget,m=p.dataset.id,y=Yi;y.tryParseString(m),n.segmentSelectionState.set(y),wx(p)||n.selectSegment(y,!1)},t=d=>{let p=d.currentTarget,m=p.dataset.id,y=Yi;y.tryParseString(m),n.selectSegment(y,wx(p)?"toggle":!0)},r=()=>{n.segmentSelectionState.set(null)},i=d=>{let p=d.currentTarget.parentElement.parentElement;Ir(p.dataset.id),d.stopPropagation()},a=d=>{let p=d.currentTarget.parentElement;Ir(p.dataset.unmappedId),d.stopPropagation()},o=d=>{let m=d.currentTarget.parentElement.parentElement.dataset.id,y=Yi;y.tryParseString(m);let{visibleSegments:v}=n.segmentationGroupState.value;v.set(y,!v.has(y)),d.stopPropagation()},l=d=>{let m=d.currentTarget.parentElement.dataset.id,y=Yi;y.tryParseString(m),n.filterBySegmentLabel(y),d.stopPropagation()},c=d=>{if(d.button!==2||d.ctrlKey||d.altKey||d.metaKey||d.shiftKey)return;let m=d.currentTarget.dataset.id,y=Yi;y.tryParseString(m),n.moveToSegment(y)};return(d,p)=>{let{children:m}=d,y=m[0].children;d.addEventListener("mousedown",c);let v=y[p.copyContainerIndex];p.unmappedCopyIndex!==-1&&v.children[p.unmappedCopyIndex].addEventListener("click",a),v.children[p.copyIndex].addEventListener("click",i),d.addEventListener("mouseenter",e),d.addEventListener("mouseleave",r),y[p.visibleIndex].addEventListener("click",o),m[p.filterIndex].addEventListener("click",l),d.addEventListener("action:select-position",t)}}var Cl=class{constructor(e,t){this.displayState=e;this.template=t;if(e!==void 0){let r=tA.get(e);r===void 0&&(r=uj(e),tA.set(e,r)),this.registerEventHandlers=r}}static make(e,t){return new Cl(e,t?lj:Ex)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(fs(t,e))}getWithNormalizedId(e){var y,v;let{displayState:t}=this,{template:r}=this,i=r.template.cloneNode(!0),a=e.key,o=(y=e.value)!=null?y:a,l=o.toString();i.dataset.id=l;let{children:c}=i,d=c[0].children,p=d[r.idContainerIndex];p.children[r.idIndex].textContent=l;let{unmappedIdIndex:m}=r;if(t!==void 0?this.registerEventHandlers(i,r):d[r.visibleIndex].style.display="none",m!==-1){let b=p.children[m];if(Q.equal(a,o)){b.style.display="none";let x=d[r.copyContainerIndex];x.children[r.unmappedCopyIndex].style.display="none"}else{let x=a.toString();i.dataset.unmappedId=x,b.textContent=x,t!==void 0&&eA(t.segmentationGroupState.value.maxIdLength,x)}}return c[r.labelIndex].textContent=(v=e.label)!=null?v:"",t!==void 0&&(this.updateWithId(i,o),eA(t.segmentationGroupState.value.maxIdLength,l)),i}update(e){let t=Yi,r=e.dataset.id;r!==void 0&&(t.parseString(r),this.updateWithId(e,t))}updateWithId(e,t){let{children:r}=e,i=r[0].children,{template:a}=this,{displayState:o}=this,{segmentSelectionState:l}=o,{visibleSegments:c}=o.segmentationGroupState.value;i[a.visibleIndex].checked=c.has(t),e.dataset.selected=(l.hasSelectedSegment&&Q.equal(l.selectedSegment,t)).toString();let d=i[a.idContainerIndex];nA(d.children[a.idIndex],Ix(this.displayState,t));let{unmappedIdIndex:p}=a;if(p!==-1){let m,y;if(o.baseSegmentColoring.value&&(m=e.dataset.unmappedId)!==void 0){let v=Yi;v.parseString(m),y=Ix(this.displayState,v)}else y=kh;nA(d.children[p],y)}}};function nA(n,e){n.style.backgroundColor=ux(e),n.style.color=Dd(e)?"white":"black"}var Dx=class extends Cl{constructor(e,t,r){var c;let i=e.segmentationGroupState.value.segmentPropertyMap.value,a=((c=i==null?void 0:i.numericalProperties)!=null?c:[]).filter(r),o=cj(a.length);super(e,o);this.parentElement=t,this.segmentPropertyMap=i,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var a,o,l;let t=super.getWithNormalizedId(e),{numericalProperties:r}=this,{numericalPropertyIndices:i}=this.template;if(i.length>0){let c=(l=(o=this.segmentPropertyMap)==null?void 0:o.getSegmentInlineIndex((a=e.value)!=null?a:e.key))!=null?l:-1;if(c!==-1){let{numericalPropertyWidths:d}=this;for(let p=0,m=i.length;p<m;++p){let y=r[p].values[c];if(!isNaN(y)){let v=y.toString(),b=v.length;b>d[p]&&(d[p]=b,this.parentElement.style.setProperty(`--neuroglancer-column-${p}-width`,`${b}ch`)),t.children[i[p]].textContent=v}}}}return t}makeHeaderLabel(e,t,r){let i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(r.style.textAlign="left");let a=document.createElement("span");a.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(a),a.textContent="\u25B2";let o=zI(i).width;return this.parentElement.style.setProperty(t,`${o}px`),r.appendChild(i),{id:e,label:i,sortIcon:a}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:r}=t,i=r[0].children,a=i[e.copyContainerIndex];a.style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",r[e.filterIndex].style.visibility="hidden";let o=i[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",r[e.labelIndex])],{numericalProperties:c}=this,{numericalPropertyIndices:d}=this.template;for(let p=0,m=d.length;p<m;++p){let y=c[p],v=this.makeHeaderLabel(y.id,`--neuroglancer-column-${p}-label-width`,t.children[d[p]]),{description:b}=y;b&&(v.label.title=b),l.push(v)}return{container:t,propertyLabels:l}}};function gp(n,e){return Cl.make(n!=null?n:void 0,!0).getWithNormalizedId(e)}function ms(n,e,t){e.registerDisposer(Qa((r,i)=>{tI(r,i,t)},n.segmentationGroupState)),e.registerDisposer(Qa((r,i)=>{r.registerDisposer(i.segmentColorHash.changed.add(t)),r.registerDisposer(i.segmentDefaultColor.changed.add(t))},n.segmentationColorGroupState)),e.registerDisposer(n.saturation.changed.add(t)),e.registerDisposer(n.segmentSelectionState.changed.add(t)),e.registerDisposer(n.baseSegmentColoring.changed.add(t))}function Px(n,e){let t=e.redrawNeeded.dispatch;ms(n,e,t),e.registerDisposer(Qa((r,i)=>{nI(r,i,t)},n.segmentationGroupState))}function dj(n,e){Px(n,e),e.registerDisposer(n.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function yp(n,e){dj(n,e),e.registerDisposer(n.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}var rA=or.create(),Yi=new Q;function Ix(n,e,t=rA){if(n==null)return t.fill(1),t;let r=n.segmentationColorGroupState.value,{segmentStatedColors:i}=r;if(i.size!==0&&r.segmentStatedColors.get(e,Yi))return t[0]=(Yi.low&255)/255,t[1]=((Yi.low&65280)>>>8)/255,t[2]=((Yi.low&16711680)>>>16)/255,t;let a=r.segmentDefaultColor.value;return a!==void 0?(t[0]=a[0],t[1]=a[1],t[2]=a[2],t):(r.segmentColorHash.compute(t,e),t)}function pj(n,e,t=1){let r=rA;r[3]=t,Ix(n,e,r);let i=n.saturation.value;n.segmentSelectionState.isSelected(e)&&(i>.5?i=i-=.5:i+=.5);for(let a=0;a<3;++a)r[a]=r[a]*i+(1-i);return r[0]*=t,r[1]*=t,r[2]*=t,r}function Ax(n,e={}){for(let t of eI)e[t]=n[t].rpcId;return e}var fj=ba(La),eu=class extends fj{constructor(e,t,r){super(r);this.chunkManager=e;this.displayState=t}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,Ax(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(Gt.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(Gt.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}};function vp(n,e,t,r,i){let a=Math.min(1,n.objectAlpha.value),o=n.baseSegmentColoring.value;Ea(n.segmentationGroupState.value,(l,c)=>{let d=r==null?void 0:r.registerUint64(e,l),p=t?pj(n,o?l:c,a):void 0;i(l,p,d,c)})}var hj=ie.create(),Ti=Ft.create(),iA=!1;function aA(n,e){e.vertexBuffer=en.fromData(n,e.meshData.vertexPositions,n.ARRAY_BUFFER,n.STATIC_DRAW),e.indexBuffer=en.fromData(n,e.meshData.indices,n.ELEMENT_ARRAY_BUFFER,n.STATIC_DRAW),e.normalBuffer=en.fromData(n,e.meshData.vertexNormals,n.ARRAY_BUFFER,n.STATIC_DRAW)}function oA(n){n.vertexBuffer.dispose(),n.indexBuffer.dispose(),n.normalBuffer.dispose()}var mj=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function sA(n){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,r){r.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,n,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}var gj={[xi.float32]:sA(WebGL2RenderingContext.FLOAT),[xi.uint16]:sA(WebGL2RenderingContext.UNSIGNED_SHORT),[xi.uint10]:{defineShader:n=>{n.addAttribute("highp uint","aVertexPosition"),n.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(n,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(n,e)=>{n.disableVertexAttribArray(e.attribute("aVertexPosition"))}}},Mx=class{constructor(e,t){this.fragmentRelativeVertices=e;this.vertexPositionFormat=t;this.tempLightVec=new Float32Array(4);this.vertexPositionHandler=gj[this.vertexPositionFormat]}beginLayer(e,t,r,i){let{lightDirection:a,ambientLighting:o,directionalLighting:l}=r,c=this.tempLightVec;K.scale(c,a,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);let d=i.silhouetteRendering.value;d>0&&e.uniform1f(t.uniform("uSilhouettePower"),d)}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginModel(e,t,r,i){let{projectionParameters:a}=r;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,ie.multiply(hj,a.viewProjectionMat,i)),Ys(Ti,i),MS(Ti,Ti,a.displayDimensionRenderInfo.canonicalVoxelFactors),Ft.invert(Ti,Ti),Ft.transpose(Ti,Ti),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,Ti)}drawFragmentHelper(e,t,r,i,a){this.vertexPositionHandler.bind(e,t,r);let{meshData:o}=r;r.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),r.indexBuffer.bind();let{indices:l}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,a-i,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*l.BYTES_PER_ELEMENT)}drawFragment(e,t,r){let{meshData:i}=r,{indices:a}=i;this.drawFragmentHelper(e,t,r,0,a.length)}drawMultiscaleFragment(e,t,r,i,a){let o=r.meshData.subChunkOffsets[i],l=r.meshData.subChunkOffsets[a];this.drawFragmentHelper(e,t,r,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer(fn(r=>r>0,[e.displayState.silhouetteRendering]));return ii(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(r,i)=>{this.vertexPositionHandler.defineShader(r),r.addAttribute("highp vec2","aVertexNormal"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec4","uLightDirection"),r.addUniform("highp vec4","uColor"),r.addUniform("highp mat3","uNormalMatrix"),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp uint","uPickID"),i&&r.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(r.addUniform("highp vec3","uFragmentOrigin"),r.addUniform("highp vec3","uFragmentShape")),r.addVertexCode(mj);let a="";this.fragmentRelativeVertices?a+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:a+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,a+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,i&&(a+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),r.setVertexMain(a),r.setFragmentMain("emit(vColor, uPickID);")}})}},zm=class extends Wr{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new Mx(!1,xi.float32);this.getShader=this.meshShaderManager.makeGetter(this);yp(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new eu(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=xI,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=ss(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState),a.beginModel(r,l,e,o);let c=this.source.chunks,d=0,p=0,{renderScaleHistogram:m}=this.displayState,y=this.source.fragmentSource.chunks;vp(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(v,b,x)=>{let C=Fr(v),k=c.get(C);if(++d,k!==void 0){++p,e.emitColor&&a.setColor(r,l,b),e.emitPickID&&a.setPickID(r,l,x),d+=k.fragmentIds.length;for(let M of k.fragmentIds){let I=y.get(`${C}/${M}`);I!==void 0&&I.state===dt.GPU_MEMORY&&(a.drawFragment(r,l,I),++p)}}}),e.emitColor&&(m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),m.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,p,d-p)),a.endLayer(r,l)}isReady(){let{displayState:e,source:t}=this,r=!0,i=t.fragmentSource.chunks;return Ea(e.segmentationGroupState.value,a=>{let o=Fr(a),l=t.chunks.get(o);if(l===void 0){r=!1;return}for(let c of l.fragmentIds){let d=i.get(`${o}/${c}`);if(d===void 0||d.state!==dt.GPU_MEMORY){r=!1;return}}}),r}},lA=class extends Er{constructor(e,t){super(e);this.fragmentIds=t.fragmentIds}},cA=class extends Er{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),aA(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),oA(this)}},Mr=class extends Jn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new Hm(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new lA(this,e)}},Hm=class extends Jn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new cA(this,e)}};Hm=Ut([_n(wI)],Hm);function uA(n,e,t,r){let i=n.get(ox(e,t,r));return i!==void 0&&i.state===dt.GPU_MEMORY}var Sp=class extends Wr{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.meshShaderManager=new Mx(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat);this.getShader=this.meshShaderManager.makeGetter(this);yp(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new eu(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=CI,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:r,displayState:i,meshShaderManager:a}=this;if(i.objectAlpha.value<=0)return;let o=ss(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;let{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),a.beginLayer(r,l,e,this.displayState);let{renderScaleHistogram:c}=this.displayState;e.emitColor&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Ys(Ti,o),MS(Ti,Ti,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let d=Math.pow(Math.abs(Ft.determinant(Ti)),1/3),{chunks:p}=this.source,m=this.source.fragmentSource.chunks,{projectionParameters:y}=e,v=ie.multiply(ie.create(),y.viewProjectionMat,o),b=Ks(new Float32Array(24),v),x=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:C}=this.source.format;a.beginModel(r,l,e,o);let k=0,M=0;vp(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(I,A,D)=>{let E=Fr(I),V=p.get(E);if(++k,V===void 0)return;++M;let{manifest:N}=V,{octree:U,chunkShape:_,chunkGridSpatialOrigin:B,vertexOffsets:R}=N;if(iA)try{LI(U)}catch(X){console.log(`invalid octree for object=${I}: ${X.message}`)}e.emitColor&&a.setColor(r,l,A),e.emitPickID&&a.setPickID(r,l,D),ax(N,v,b,x,y.width,y.height,(X,j,oe)=>{let me=uA(m,E,X,j);return e.emitColor&&c.add(N.lodScales[X]*d,oe,me?1:0,me?0:1),me},(X,j,oe,me)=>{let xe=ox(E,X,j),se=m.get(xe),Se=U[5*j],Ie=U[5*j+1],je=U[5*j+2],Be=1<<X;if(C&&(r.uniform3f(l.uniform("uFragmentOrigin"),B[0]+Se*_[0]*Be+R[X*3+0],B[1]+Ie*_[1]*Be+R[X*3+1],B[2]+je*_[2]*Be+R[X*3+2]),r.uniform3f(l.uniform("uFragmentShape"),_[0]*Be,_[1]*Be,_[2]*Be)),iA){let Pe=`lod=${X}, chunkIndex=${j}, subChunkBegin=${oe}, subChunkEnd=${me}, uFragmentOrigin=${[B[0]+Se*_[0]*Be+R[X*3+0],B[1]+Ie*_[1]*Be+R[X*3+1],B[2]+je*_[2]*Be+R[X*3+2]]}, uFragmentShape=${[_[0]*Be,_[1]*Be,_[2]*Be]}`,ge=e.pickIDs.registerUint64(this,I,1,Pe);e.emitPickID&&a.setPickID(r,l,ge)}a.drawMultiscaleFragment(r,l,se,oe,me)})}),c.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,M,k-M),a.endLayer(r,l)}isReady(e,t){let{displayState:r}=this;if(r.objectAlpha.value<=0)return!0;let i=ss(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(i===void 0)return!1;let{chunks:a}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:l}=e,c=ie.multiply(ie.create(),l.viewProjectionMat,i),d=Ks(new Float32Array(24),c),p=this.displayState.renderScaleTarget.value,m=!0;return Ea(r.segmentationGroupState.value,y=>{if(!m)return;let v=Fr(y),b=a.get(v);if(b===void 0){m=!1;return}let{manifest:x}=b;ax(x,c,d,p,l.width,l.height,(C,k)=>(m=m&&uA(o,v,C,k),m),()=>{})}),m}getObjectPosition(e){let t=this.displayState.transform.value;if(t.error!==void 0)return;let r=this.source.chunks.get(Fr(e));if(r===void 0)return;let{manifest:i}=r,{clipLowerBound:a,clipUpperBound:o}=i,{rank:l}=t,c=new Float32Array(l);for(let p=0;p<3;++p)c[p]=(a[p]+o[p])/2;let d=new Float32Array(l);return ei(d,t.modelToRenderLayerTransform,l+1,c,l),d}},dA=class extends Er{constructor(e,t){super(e);this.manifest=t.manifest}},pA=class extends Er{constructor(e,t){super(e);this.meshData=t}copyToGPU(e){super.copyToGPU(e),aA(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),oA(this)}},yo=class extends Jn{constructor(e,t){super(e,t);this.fragmentSource=this.registerDisposer(new $m(this.chunkManager,this));this.format=t.format}static encodeOptions(e){return{format:e.format,...super.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new dA(this,e)}},$m=class extends Jn{constructor(e,t){super(e);this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new pA(this,e)}};$m=Ut([_n(TI)],$m);var fA="skeleton/SkeletonLayer";function Cn(n,e,t){pe(n,e,r=>t.restoreState(r))}var oi=class extends z{constructor(){super(...arguments);this.children=new Map;this.changed=new re}add(e,t){let{children:r}=this;if(r.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);let r=t.get(e);this.children.delete(e),r.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){let e=this.baseJSON();for(let[t,r]of this.children)e[t]=r.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){Z(e);for(let[t,r]of this.children)try{if(e.hasOwnProperty(t)){let i=e[t];if(i===void 0)continue;r.restoreState(i)}}catch(i){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${i.message}`)}}},jm=class extends oi{constructor(){super(...arguments);this.lastState={}}restoreState(e){Z(e),this.lastState=e,super.restoreState(e)}reset(){this.lastState={},super.reset()}baseJSON(){let e=Object.assign(super.baseJSON(),this.lastState);for(let t of this.children.keys())delete e[t];return e}toJSON(){let e=super.toJSON();return this.lastState=e,e}add(e,t){let r=super.add(e,t),i=this.lastState[e];return i!==void 0&&(t.reset(),t.restoreState(i)),r}},hA=new WeakMap;function Hr(n){let e=hA.get(n),t=n.changed.count;if(e!==void 0&&e.generation===t)return e;let r;if(n instanceof oi){r=n.baseJSON();for(let[i,a]of n.children)r[i]=Hr(a).value}else r=n.toJSON();return e===void 0?(e={generation:t,value:r},hA.set(n,e)):(e.generation=t,e.value=r),e}var gs=class{constructor(e,t,r=t){this.enumType=e;this.value_=t;this.defaultValue=r;this.changed=new re}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=_t(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}};var bp=6;var tu=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function nu(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,bp*e,t)}var qm=bp;function ys(n,e){n.addVertexCode(tu),n.addUniform("highp vec3","uCircleParams"),n.addVarying("highp vec4","vCircleCoord"),n.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),n.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function vs(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function Ss(n,e,t){nu(n,e,t)}var vo=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;var ki=bp;function pr(n,e=!1){n.addVertexCode(tu),n.addUniform("highp vec3","uLineParams"),n.addVarying("highp float","vLineCoord"),n.addVarying("highp float","vLineFeatherFraction"),e&&(n.addVarying("highp float","vEndpointFraction"),n.addVarying("highp float","vLineCoordT"),n.addVarying("highp float","vLineBorderStartFraction")),n.addVertexCode(kP),n.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&n.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),n.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function fr(n,e,t){nu(n,e,t)}function hr(n,e,t){let{gl:r}=n;r.uniform3f(n.uniform("uLineParams"),1/e.width,1/e.height,t)}function Rr(n){n.addAttribute("int","aDummyVertexId",0),n.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}var Qn=class extends z{constructor(e){super();this.buffer=new en(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:r}=t;t.bind(),e>this.size&&(this.size=e,r.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),r.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),r.vertexAttribDivisor(0,0),r.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new Qn(e))}};var yj=ie.create(),mA=`void main() {
  emitDefault();
}
`,xp=[],vj=Ci(new qi,G.FLOAT32,3),Rx=class extends z{constructor(e,t){super();this.base=e;this.targetIsSliceView=t;this.textureAccessHelper=new go("vertexData");this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl));this.edgeShaderGetter=ii(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),pr(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(vo);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Wi(t,e),e.setFragmentMainFunction(Fi(t.parseResult.code))}});this.nodeShaderGetter=ii(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),ys(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(vo);let{vertexAttributes:i}=this,a=i.length;for(let o=1;o<a;++o){let l=i[o];e.addVarying(`highp ${l.glslDataType}`,`vCustom${o}`),r+=`vCustom${o} = readAttribute${o}(vertexIndex);
`,e.addFragmentCode(`#define ${l.name} vCustom${o}
`)}e.setVertexMain(r),Wi(t,e),e.setFragmentMainFunction(Fi(t.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){Rr(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let r=this.vertexAttributes.length;for(let i=xp.length;i<r;++i)xp[i]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${i}`);this.vertexAttributes.forEach((i,a)=>{e.addTextureSampler(`${Yc(i.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,xp[a]),e.addVertexCode(t.getAccessor(`readAttribute${a}`,`uVertexAttributeSampler${a}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,r,i){let{viewProjectionMat:a}=r.projectionParameters,o=ie.multiply(yj,a,i);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}drawSkeleton(e,t,r,i,a){let{vertexAttributes:o}=this,l=o.length,{vertexAttributeTextures:c}=i;for(let d=0;d<l;++d){let p=WebGL2RenderingContext.TEXTURE0+t.textureUnit(xp[d]);e.activeTexture(p),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c[d])}{t.bind();let d=t.attribute("aVertexIndex");i.indexBuffer.bindToVertexAttribI(d,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(d,1),hr(t,a,this.targetIsSliceView?1:0),fr(e,1,i.numIndices/2),e.vertexAttribDivisor(d,0),e.disableVertexAttribArray(d)}r!==null&&(r.bind(),vs(r,a,{featherWidthInPixels:this.targetIsSliceView?1:0}),Ss(r.gl,2,i.numVertices))}endLayer(e,t){let{vertexAttributes:r}=this,i=r.length;for(let a=0;a<i;++a){let o=t.textureUnit(xp[a])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}},ru;(function(t){t[t.LINES=0]="LINES",t[t.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(ru||(ru={}));var _x=class extends gs{constructor(e,t=e){super(ru,e,t)}},Vx=class extends lt{constructor(e,t=e){super(e,Lt,t)}},Ox=class{constructor(){this.compound=new oi;this.shader=es(mA);this.shaderControlState=new po(this.shader);this.params2d={mode:new _x(1),lineWidth:new Vx(2)};this.params3d={mode:new _x(0),lineWidth:new Vx(1)};let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(t!==void 0)return e}},Nx=class extends z{constructor(e,t,r){super();this.chunkManager=e;this.source=t;this.displayState=r;this.layerChunkProgressInfo=new cl;this.redrawNeeded=new re;this.fallbackShaderParameters=new Ge(rs(uo(mA)));yp(r,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:i}=r;this.registerDisposer(i.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let a=this.sharedObject=this.registerDisposer(new eu(e,r,this.layerChunkProgressInfo));a.RPC_TYPE_ID=fA,a.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let o=this.vertexAttributes=[bj];for(let[l,c]of t.vertexAttributes)o.push({name:l,dataType:c.dataType,numComponents:c.numComponents,webglDataType:Sj(c.dataType),glslDataType:c.numComponents>1?`vec${c.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,r,i,a){let o=i.lineWidth.value,{gl:l,source:c,displayState:d}=this;if(d.objectAlpha.value<=0)return;let p=ss(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,a);if(p===void 0)return;let m;i.mode.value===1?m=Math.max(5,o*2):m=o;let y=r.edgeShaderGetter(e.emitter),v=r.nodeShaderGetter(e.emitter),{shader:b,parameters:x}=y,{shader:C,parameters:k}=v;if(b===null||C===null)return;let{shaderControlState:M}=this.displayState.skeletonRenderingOptions;b.bind(),r.beginLayer(l,b,e,p),ai(l,b,M,x.parseResult.controls),l.uniform1f(b.uniform("uLineWidth"),o),C.bind(),r.beginLayer(l,C,e,p),l.uniform1f(C.uniform("uNodeDiameter"),m),ai(l,C,M,k.parseResult.controls);let I=c.chunks;vp(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(A,D,E)=>{let V=Fr(A),N=I.get(V);N===void 0||N.state!==dt.GPU_MEMORY||(D!==void 0&&(b.bind(),r.setColor(l,b,D),C.bind(),r.setColor(l,C,D)),E!==void 0&&(b.bind(),r.setPickID(l,b,E),C.bind(),r.setPickID(l,C,E)),r.drawSkeleton(l,b,C,N,e.projectionParameters))}),r.endLayer(l,b)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let r=e.chunks,i=!0;return Ea(t.segmentationGroupState.value,a=>{let o=Fr(a),l=r.get(o);if(l===void 0||l.state!==dt.GPU_MEMORY){i=!1;return}}),i}},Cp=class extends Wr{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Rx(this.base,!1));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}},Jm=class extends Pa{constructor(e){super();this.base=e;this.renderHelper=this.registerDisposer(new Rx(this.base,!0));this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d;this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}};function Sj(n){switch(n){case G.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${G[n]}`)}}var bj={dataType:G.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"},gA=class extends Er{constructor(e,t){super(e);this.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=r.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:r,vertexAttributeOffsets:i}=this,a=this.vertexAttributeTextures=[];for(let o=0,l=i.length;o<l;++o){let c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),ds(e,t[o],r.subarray(i[o],o+1!==l?i[o+1]:r.length)),a[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=en.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0,this.indexBuffer.dispose()}},xj=new Map;function Cj(n){let e=[vj];for(let t of n.values())e.push(Ci(new qi,t.dataType,t.numComponents));return e}var Ki=class extends Jn{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=Cj(this.vertexAttributes)),e}getChunk(e){return new gA(this,e)}constructor(e,t){super(e,t)}get vertexAttributes(){return xj}};var gt;(function(r){r[r.UNKNOWN=0]="UNKNOWN",r[r.IMAGE=1]="IMAGE",r[r.SEGMENTATION=2]="SEGMENTATION"})(gt||(gt={}));function Ym(n){let{rank:e,dataType:t,compressedSegmentationBlockSize:r}=n,{baseVoxelOffset:i=new Float32Array(e)}=n;return{...Uc(n),compressedSegmentationBlockSize:r,baseVoxelOffset:i,dataType:t}}function Bx(n){let{rank:e,compressedSegmentationBlockSize:t,dataType:r,lowerVoxelBound:i,upperVoxelBound:a}=n;if(t===void 0&&e===3&&(n.volumeType===2||n.volumeSourceOptions.discreteValues===!0)&&(r===G.UINT32||r===G.UINT64)){let{volumeSourceOptions:{displayRank:o,multiscaleToViewTransform:l},chunkToMultiscaleTransform:c,chunkToViewTransform:d}=n;d===void 0&&(d=el(new Float32Array(e*o),o,l,o,c,e+1,o,e,e));let{maxCompressedSegmentationBlockSize:p,chunkDataSize:m}=n;return Ym({...n,compressedSegmentationBlockSize:Float32Array.from(Wd({rank:e,chunkToViewTransform:d,displayRank:o,lowerVoxelBound:i,upperVoxelBound:a,maxVoxelsPerChunkLog2:9,maxBlockSize:p===void 0?m:oD(new Uint32Array(e),m,p)}))})}return Ym(n)}function $r(n){let{rank:e}=n,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:r,modelChannelDimensionIndices:i},chunkToMultiscaleTransform:a}=n,o=el(new Float32Array(t*e),t,r,t,a,e+1,t,e,e),{minBlockSize:l}=n;l===void 0?(l=new Uint32Array(e),l.fill(1)):l=new Uint32Array(l);let{lowerVoxelBound:c,upperVoxelBound:d}=n;if(i.length!==0)for(let m of Xs(a,e,i)){let y=d[m];c!==void 0&&(y-=c[m]),l[m]=y}let{chunkDataSizes:p=RD({...n,minBlockSize:l,chunkToViewTransform:o,displayRank:t})}=n;return p.map(m=>Bx({...n,chunkDataSize:m,chunkToViewTransform:o}))}function Km(n,e,t,r){let{dataType:i}=e;e.defineShader(n,t);let a="",o="";if(t===0)a+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(a+=", "),a+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;n.addFragmentCode(yP);let l=`
${Xt(i)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${Xt(i)} getInterpolatedDataValue(${a}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${Xt(i)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${Xt(i)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${Xt(i)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;n.addFragmentCode(l),t<=1&&n.addFragmentCode(`
${Xt(i)} getDataValue() { return getDataValue(0); }
${Xt(i)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var yA=new Array;function Xm(n){yA.push(n)}function wj(n,e){for(let t of yA){let r=t(n,e);if(r!=null)return r}throw new Error("No chunk format handler found.")}var Nn=class extends ip{constructor(e,t){super(e,t);this.chunkFormatHandler=this.registerDisposer(wj(e.chunkQueueManager.gl,this.spec));let r=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(r),this.tempPositionWithinChunk=new Uint32Array(r)}static encodeSpec(e){let t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let r=this.spec.rank,i=this.tempChunkGridPosition,a=this.tempPositionWithinChunk,{spec:o}=this;{let{chunkDataSize:x}=o;for(let C=0;C<r;++C){let k=e[C],M=x[C],I=Math.floor(k/M);i[C]=I,a[C]=Math.floor(k-M*I)}}let l=this.chunks.get(i.join());if(l===void 0)return null;let c=l.chunkDataSize;for(let x=0;x<3;++x)if(a[x]>=c[x])return;if(t.channelSpaceShape.length===0)return l.getValueAt(a);let{numChannels:d,chunkChannelCoordinates:p,chunkChannelDimensionIndices:m}=t,y=m.length,v=0,b=new Array(d);for(let x=0;x<d;++x){for(let C=0;C<y;++C)a[m[C]]=p[v++];b[x]=l.getValueAt(a)}return b}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}},Ux=class extends ap{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t);this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}},Qt=class extends Qb{};var vA=class extends mt(Rt()(Nn),km){},SA=class extends mt(Rt()(yo),Lm){},bA=class extends mt(Rt()(Mr),Em){},xA=class extends mt(Rt()(Ki),Dm){},CA=class extends mt(Rt()(fl),Im){},wp=new Map;wp.set("UINT8",G.UINT8);wp.set("FLOAT",G.FLOAT32);wp.set("UINT32",G.UINT32);wp.set("UINT64",G.UINT64);function Tj(n){Z(n);try{return{corner:$(n,"corner",e=>Pd(K.create(),e,ct)),size:$(n,"size",e=>Pd(K.create(),e,Lt)),metadata:$(n,"metadata",rn)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}var wA=class{constructor(e){try{Z(e),this.numChannels=$(e,"channelCount",Bt),this.dataType=$(e,"channelType",t=>Rh(t,wp)),this.voxelSize=$(e,"pixelSize",t=>Pd(K.create(),t,Lt)),this.upperVoxelBound=$(e,"volumeSize",t=>Pd(K.create(),t,Bt)),this.boundingBoxes=$(e,"boundingBox",t=>t===void 0?[]:Te(t,Tj))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}};function kj(n){return Z(n),{name:$(n,"name",ae),type:$(n,"type",ae)}}function Lj(n){try{return Z(n),$(n,"meshes",e=>e===void 0?[]:Te(e,kj))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}var Ej="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",Fx="([0-9]+)",TA=new RegExp(`^(.*)_${Fx}x${Fx}x${Fx}_lod([0-9]+)_${Ej}$`);function Dj(n,e){let t=new Map,r=n.scales[0],i=new Set;for(let o of e){if(o.type!=="TRIANGLES")continue;let l=o.name.match(TA);if(l===null)continue;let c=l[1],d=t.get(c);d===void 0&&(d={key:c,chunkShape:K.create(),lods:[]},t.set(c,d));let p=parseInt(l[5]);if(d.lods[p]!==void 0){i.add(c);continue}let m=K.fromValues(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),y=new Uint32Array(3);for(let v=0;v<3;++v)y[v]=Math.ceil(r.upperVoxelBound[v]/m[v]);d.lods[p]={info:o,scale:parseFloat(l[6]),relativeBlockShape:m,gridShape:y}}let a=[];e:for(let o of t.values()){if(i.has(o.key))continue e;let l=o.lods[0];if(l===void 0)continue e;let c=l.relativeBlockShape;K.multiply(o.chunkShape,c,r.voxelSize);for(let d=1;d<o.lods.length;++d){let p=o.lods[d];if(p===void 0)continue e;let{relativeBlockShape:m}=p;for(let y=0;y<3;++y){let v=m[y],b=c[y];if(v<b||v%b!=0)continue e;m[y]=v/b}}c.fill(1),a.push(o)}return a}function Pj(n,e){let t=Dj(n,e),r=[],i=o=>{r.some(l=>l.name===o.name)||r.push(o)},a=new Set;for(let o of t){i({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(let l of o.lods)a.add(l.info)}for(let o of e)i({single:o,multi:void 0,name:o.name,partOfMultiscale:a.has(o)});return r}var kA=class{constructor(e){try{Z(e);let t=this.scales=$(e,"geometry",o=>Te(o,l=>new wA(l)));if(t.length===0)throw new Error("Expected at least one scale.");let r=t[0],i=this.numChannels=r.numChannels,a=this.dataType=r.dataType;for(let o=1,l=t.length;o<l;++o){let c=t[o];if(c.dataType!==a)throw new Error(`Scale ${o} has data type ${G[c.dataType]} but scale 0 has data type ${G[a]}.`);if(c.numChannels!==i)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(r.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){let t=this.scales[0],r=["x","y","z"],i=["m","m","m"],a=Array.from(t.voxelSize,c=>c/1e9),o=[0,0,0],l=Array.from(t.upperVoxelBound);return e&&(r.push("c^"),i.push(""),a.push(1),o.push(0),l.push(this.numChannels)),He({names:r,units:i,scales:Float64Array.from(a),boundingBoxes:[qn({lowerBounds:new Float64Array(r.length),upperBounds:Float64Array.from(l)})]})}},LA=class extends Qt{constructor(e,t,r,i,a,o,l){super(e);this.instance=t;this.credentialsProvider=r;this.volumeId=i;this.changeSpec=a;this.multiscaleVolumeInfo=o;this.encoding=l.encoding,this.jpegQuality=l.jpegQuality,this.chunkLayoutPreference=l.chunkLayoutPreference;let c=gt.IMAGE;this.dataType===G.UINT64&&(c=gt.SEGMENTATION),this.volumeType=c}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=mo.RAW;this.dataType===G.UINT64&&this.volumeType===gt.SEGMENTATION?t=mo.COMPRESSED_SEGMENTATION:this.volumeType===gt.IMAGE&&this.dataType===G.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==mo.RAW&&e.discreteValues!==!0&&(t=mo.JPEG);let r=t===mo.JPEG?this.jpegQuality:void 0,i=this.scales[0],{upperVoxelBound:a}=i,o=K.create(),{rank:l}=this;return rr(this.scales.map((c,d)=>{K.divide(o,c.voxelSize,i.voxelSize);let p=c.upperVoxelBound,m,{numChannels:y}=c,v=new Float32Array((l+1)**2);v[(l+1)*l+l]=1;let b=new Float32Array(l);y!==1&&(p=Float32Array.of(...p,y),m=Uint32Array.of(1,1,1,y),v[(l+1)*3+3]=1,b[3]=y);for(let x=0;x<3;++x)v[(l+1)*x+x]=o[x],b[x]=a[x]/o[x];return $r({rank:l,minBlockSize:m,chunkToMultiscaleTransform:v,dataType:c.dataType,upperVoxelBound:p,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:K.fromValues(64,64,64)}).map(x=>({chunkSource:this.chunkManager.getChunkSource(vA,{credentialsProvider:this.credentialsProvider,spec:x,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:d,encoding:t,jpegQuality:r,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:b}))}))}};function Ij(n){let e=ie.create(),t=n.scales[0].voxelSize;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}function Aj(n){let e=n.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(n)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});let r=gi(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:r}}function Mj(n){try{return Z(n),{id:$(n,"id",ae),label:$(n,"label",ae),description:$(n,"description",rn)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function Rj(n){try{return Z(n),$(n,"project",e=>e===void 0?[]:Te(e,Mj))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function EA(n,e){try{return Z(n),$(n,e,t=>t===void 0?[]:Te(t,ae))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function _j(n){return $(n,"changeStackId",e=>e===void 0?void 0:Te(e,ae))}var Vj=mt(Rt()($i),Pm),DA=class extends Vj{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t});this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}getSources(){let{upperVoxelBound:e}=this.parameters,t=Uc({rank:3,chunkDataSize:e,upperVoxelBound:e}),r=ie.create();return[[{chunkSource:this.chunkManager.getChunkSource(CA,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:r,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:r}]]}},Oj=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}],Qm=class extends Ht{constructor(e,t){super();this.instance=e;this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:St(this.credentialsProvider)},()=>yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(r=>new kA(r)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:St(this.credentialsProvider)},()=>yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(r=>Lj(r)))}get(e){let{volumeId:t,changeSpec:r,meshName:i,parameters:a}=Aj(e.providerUrl);Z(a);let o=pe(a,"encoding",p=>_t(p,mo)),l=pe(a,"jpegQuality",p=>{let m=ft(p);if(m<1||m>100)throw new Error(`Expected integer in range [1, 100], but received: ${p}`);return m},70),c=pe(a,"chunkLayout",p=>_t(p,ni)),d={encoding:o,chunkLayoutPreference:c,jpegQuality:l};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:r,brainmapsOptions:d},async()=>{let[p,m]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),y=new LA(e.chunkManager,this.instance,this.credentialsProvider,t,r,p,d),v={modelTransform:Et(p.getModelSpace(p.numChannels!==1)),subsources:[{id:i===void 0?"default":"volume",subsource:{volume:y},default:i===void 0}]},b=Wn(p.box);p.scales[0].boundingBoxes.forEach((M,I)=>{b.add({type:ze.AXIS_ALIGNED_BOUNDING_BOX,description:M.metadata,pointA:M.corner,pointB:K.add(K.create(),M.corner,M.size),id:`boundingBox${I}`,properties:[]})}),v.subsources.push({id:"bounds",subsource:{staticAnnotations:b},default:!0});let C=Pj(p,m),k=(M,I)=>{let A,{single:D}=M;if(D!==void 0)D.type==="TRIANGLES"?A=e.chunkManager.getChunkSource(bA,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:D.name,changeSpec:r}}):A=e.chunkManager.getChunkSource(xA,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:M.name,changeSpec:r}});else{let E=M.multi;A=e.chunkManager.getChunkSource(SA,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:xi.float32},parameters:{instance:this.instance,volumeId:t,info:E,changeSpec:r}})}v.subsources.push({id:i===void 0?`/${M.name}`:"default",subsource:{mesh:A},subsourceToModelSubspaceTransform:Ij(p),modelSubspaceDimensionIndices:[0,1,2],default:I})};if(i!==void 0){let M=C.find(I=>I.name===i);if(M===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(M)}`);k(M,!0)}else{let M=!0;for(let I of C)I.partOfMultiscale||(k(I,M),M=!1)}return r!==void 0&&v.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(DA,{parameters:{volumeId:t,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:p.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),v})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=yl(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(i=>Rj(i)),r=`${this.instance.description} project list`;return Ke.forPromise(t,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let r=yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(a=>EA(a,"datasetIds")),i=`${this.instance.description} dataset list`;return Ke.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),r})}getVolumeList(e,t,r){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${r}:getVolumeList`},()=>{let i=yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${r}`,responseType:"json"}).then(o=>{let l=EA(o,"volumeId"),c=t.length+r.length+2,d=[];for(let p of l)d.push(p.substring(c));return d}),a=`${this.instance.description} volume list`;return Ke.forPromise(i,{delay:!0,initialMessage:`Retrieving ${a}`,errorPrefix:`Error retrieving ${a}`}),i})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let r=yl(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(a=>_j(a)),i=`change stacks for ${t}`;return Ke.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),r})}async completeUrl(e){let{providerUrl:t}=e,r=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(r===null)throw null;let[,i,a,o,l,c,d]=r;if(d!==void 0)return Gr(t.length-d.length,await bm(d,Oj));if(c!==void 0){let m=`${i}:${a}:${o}`,y=await this.getMeshesInfo(e.chunkManager,m),v=[],b=new Set;for(let x of y)if(!!x.name.startsWith(c))switch(x.type){case"LINE_SEGMENTS":v.push({value:x.name,description:"Skeletons"});break;case"TRIANGLES":{v.push({value:x.name,description:"Mesh (single-resolution)"});let C=x.name.match(TA);if(C!==null){let k=C[1];if(b.has(k))break;b.add(k),v.push({value:k,description:"Mesh (multi-resolution)"})}break}}return v.sort((x,C)=>ho(x.value,C.value)),{offset:t.length-c.length,completions:v}}if(l!==void 0){let m=`${i}:${a}:${o}`,y=await this.getChangeStackList(e.chunkManager,m);if(y===void 0)throw null;return{offset:t.length-l.length,completions:Sm(l,y)}}if(o!==void 0)return{offset:t.length-o.length,completions:Sm(o,await this.getVolumeList(e.chunkManager,i,a))};if(a!==void 0){let m=await this.getDatasetList(e.chunkManager,i);return{offset:t.length-a.length,completions:Sm(a,m.map(y=>`${y}:`))}}let p=await this.getProjectList(e.chunkManager);return{offset:0,completions:xn(i,p,m=>`${m.id}:`,m=>m.label)}}},PA={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};var IA=new Map;function an(n,e){IA.set(n,e)}function Zm(n){let e=new rx(n.credentialsManager);for(let[t,r]of IA)e.register(t,r(n));return e}an("brainmaps",n=>new Qm(PA,n.credentialsManager.getCredentialsProvider(ix)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS!="undefined")for(let[n,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))an(`brainmaps-${n}`,t=>new Qm(e,t.credentialsManager.getCredentialsProvider(ix)));var AA="boss";function wl(n,e,t,r,i=At){return cs(n,e,t,r,a=>{let o=new Headers(t.headers);return o.set("Authorization",`Bearer ${a}`),{...t,headers:o}},a=>{let{status:o}=a;if(o===403||o===401)return"refresh";if(o===504)return"retry";throw a},i)}var MA=class{},eg=class extends MA{static stringify(e){return`boss:volume:${e.baseUrl}/${e.collection}/${e.experiment}/${e.channel}/${e.resolution}/${e.encoding}`}};eg.RPC_ID="boss/VolumeChunkSource";var tg=class{static stringify(e){return`boss:mesh:${e.baseUrl}`}};tg.RPC_ID="boss/MeshChunkSource";var RA=class extends mt(Rt()(Nn),eg){},_A=class extends mt(Rt()(Mr),tg){},Gx=new Map;Gx.set("image",gt.IMAGE);Gx.set("annotation",gt.SEGMENTATION);var Nj=new Set(["npz","jpeg"]),Bj=Uint32Array.of(512,512,16),Tl;(function(i){i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS"})(Tl||(Tl={}));function Uj(n){switch(n){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function Fj(n,e){Z(n);let t=$(n,"voxel_unit",d=>_t(d,Tl)),r=Uj(t),i=new Float32Array(3),a=new Float64Array(3),o=new Float64Array(3),l=new Float64Array(3),c=["x","y","z"];for(let d=0;d<3;++d){let p=c[d];i[d]=$(n,`${p}_voxel_size`,Lt),a[d]=i[d]/r,o[d]=$(n,`${p}_start`,ft),l[d]=$(n,`${p}_stop`,ft)}return e.coordFrame={voxelSizeBaseInMeters:a,voxelSizeBaseInOriginalUnits:i,voxelOffsetBase:o,imageSizeBase:l,voxelUnit:t,names:c},e}function Gj(n){let e=Gx.get(n);return e===void 0&&(e=gt.UNKNOWN),e}function Wj(n){Z(n);let e=$(n,"type",ae),t=!1;return $(n,"downsample_status",ae)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:$(n,"description",ae),volumeType:Gj(e),dataType:$(n,"datatype",i=>_t(i,G)),downsampled:t,scales:[],key:$(n,"name",ae)}}function zj(n,e,t,r,i,a){Z(n);let o=$(n,"channels",l=>Te(l,c=>$j(e,t,r,a,i,c)));return Promise.all(o).then(l=>{let c=new Map;l.forEach(p=>{c.set(p.key,p)});let d={channels:c,scalingLevels:$(n,"num_hierarchy_levels",ft),coordFrameKey:$(n,"coord_frame",ae),coordFrame:void 0,key:$(n,"name",ae),collection:$(n,"collection",ae)};return Qj(e,t,r,d)})}var VA=class extends Qt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.credentialsProvider=r;this.experimentInfo=i;this.parameters=o;this.meshPath=void 0;this.meshUrl=void 0;if(a===void 0){let m=Array.from(i.channels.keys());if(m.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(m)}`);a=m[0]}let l=i.channels.get(a);if(l===void 0)throw new Error(`Specified channel ${JSON.stringify(a)} is not one of the supported channels ${JSON.stringify(Array.from(i.channels.keys()))}`);if(this.channel=a,this.channelInfo=l,this.scales=l.scales,i.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(i.key)} does not have a valid coordinate frame`);this.coordinateFrame=i.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[l.scales[0]]),this.experiment=i.key;let c=rn(o.window);if(c!==void 0){let m=Tr.create(),y=c.split(/,/);if(y.length===2)m[0]=ct(y[0]),m[1]=ct(y[1]);else if(y.length===1)m[0]=0,m[1]=ct(y[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(c)}`);if(this.window=m,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(c)}.`)}let d=rn(o.meshurl);d!==void 0&&(this.meshUrl=d);let p=rn(o.encoding);if(p===void 0)p=this.volumeType===gt.IMAGE?"jpeg":"npz";else if(!Nj.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p}get dataType(){return this.channelInfo.dataType===G.UINT16?G.UINT8:this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){return rr(this.scales.map(t=>{let{downsampleFactors:r,imageSize:i}=t,a=this.coordinateFrame.voxelOffsetBase,o=K.create();for(let c=0;c<3;++c)o[c]=Math.ceil(a[c]);let l=ie.create();for(let c=0;c<3;++c)l[5*c]=r[c],l[12+c]=a[c];return $r({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:l,chunkDataSizes:[Bj],baseVoxelOffset:o,upperVoxelBound:i,volumeSourceOptions:e}).map(c=>({chunkSource:this.chunkManager.getChunkSource(RA,{credentialsProvider:this.credentialsProvider,spec:c,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:t.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:l}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(_A,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}},Hj=/^([^\/?]+)\/([^\/?]+)(?:\/([^\/?]+))?(?:\?(.*))?$/;function OA(n,e,t,r,i){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,type:"boss:getExperimentInfo"},()=>wl(t,`${e}/latest/collection/${i}/experiment/${r}/`,{},$t).then(a=>zj(a,n,e,t,i,r)))}function $j(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:i,experiment:r,channel:a,type:"boss:getChannelInfo"},()=>wl(t,`${e}/latest/collection/${i}/experiment/${r}/channel/${a}/`,{},$t).then(Wj))}function jj(n,e,t,r,i,a){return n.memoize.getUncounted({hostname:e,collection:r,experiment:i.key,channel:a,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>wl(t,`${e}/latest/downsample/${r}/${i.key}/${a}/`,{},$t)).then(o=>Jj(o,i,a))}function qj(n,e){Z(n);let t=$(n,"voxel_size",o=>Vi(o,$1)),r=$(n,"extent",o=>Vi(o,j1)),i=$(n,"num_hierarchy_levels",ft),a=new Array;for(let o=0;o<i;o++){let l=String(o),c=t.get(l),d=r.get(l);if(c===void 0||d===void 0)throw new Error(`Missing voxel_size/extent for resolution ${l}.`);let p=new Float32Array(3);for(let m=0;m<3;++m)p[m]=c[m]=e[m];a[o]={downsampleFactors:p,imageSize:d,key:l}}return a}function Jj(n,e,t){let r=e.coordFrame;if(r===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);let i=e.channels.get(t);if(i===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return i.scales=qj(n,r.voxelSizeBaseInOriginalUnits),e.channels.set(t,i),e}function Yj(n,e,t,r){let i=r.match(Hj);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=gi(i[4]||"");return n.memoize.getUncounted({hostname:e,path:r,type:"boss:getVolume"},async()=>{let d=await OA(n,e,t,o,a),p=await jj(n,e,t,a,d,l),m=new VA(n,e,t,p,l,c),y=p.coordFrame,v={lowerBounds:y.voxelOffsetBase,upperBounds:Float64Array.from(y.imageSizeBase,(C,k)=>y.voxelOffsetBase[k]+C)},b=He({rank:3,names:y.names,units:["m","m","m"],scales:y.voxelSizeBaseInMeters,boundingBoxes:[qn(v)]});return{modelTransform:Et(b),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:Wn(v)}}]}})}var NA=/^((?:http|https):\/\/[^\/?]+)\/(.*)$/;function Kj(n,e,t){return n.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>wl(t,`${e}/latest/collection/`,{},$t).then(r=>$(r,"collections",i=>Te(i,ae))))}function Xj(n,e,t,r){return n.memoize.getUncounted({hostname:e,collection:r,type:"boss:getExperiments"},()=>wl(t,`${e}/latest/collection/${r}/experiment/`,{},$t).then(i=>$(i,"experiments",a=>Te(a,ae))))}function Qj(n,e,t,r){let i=r.coordFrameKey;return n.memoize.getUncounted({hostname:e,coordinateframe:i,experimentInfo:r,type:"boss:getCoordinateFrame"},()=>wl(t,`${e}/latest/coord/${i}/`,{},$t).then(a=>Fj(a,r)))}function Zj(n,e,t,r){let i=r.match(/^(?:([^\/]+)(?:\/?([^\/]*)(?:\/?([^\/]*)(?:\/?([^\/]*)?))?)?)?$/);if(i===null||i[1]===void 0)return Promise.reject(null);if(i[2]===void 0){let a=i[1]||"";return Kj(n,e,t).then(o=>({offset:0,completions:xn(a,o,l=>l+"/",()=>{})}))}if(i[3]===void 0){let a=i[2]||"";return Xj(n,e,t,i[1]).then(o=>({offset:i[1].length+1,completions:xn(a,o,l=>l+"/",()=>{})}))}return OA(n,e,t,i[2],i[1]).then(a=>{let o=xn(i[3],a.channels,l=>l[0],l=>`${l[1].channelType} (${G[l[1].dataType]})`);return{offset:i[1].length+i[2].length+2,completions:o}})}function eq(n){let e=n.match(/^(?:https:\/\/[^.]+([^\/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${n}.`);return`https://auth${e[1]}/auth`}var Wx=class extends Ht{constructor(e){super();this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){let t=eq(e);return this.credentialsManager.getCredentialsProvider(AA,t)}get(e){let t=e.providerUrl.match(NA);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let r=this.getCredentialsProvider(e.providerUrl);return Yj(e.chunkManager,t[1],r,t[2])}async completeUrl(e){let t=e.providerUrl.match(NA);if(t===null)throw null;let r=t[1],i=this.getCredentialsProvider(t[1]),a=t[2],o=await Zj(e.chunkManager,r,i,a);return Gr(t[1].length+1,o)}};an("boss",n=>new Wx(n.credentialsManager));var zx="DVID";function tq(n){return n.text()}function BA(n,e,t=At){return nq(n,e.url,{method:e.method,body:e.payload},e.responseType===""?tq:e.responseType==="json"?$t:Tm,t)}function nq(n,e,t,r,i=At){return cs(n,e,t,r,(a,o)=>{let l={...o};return a.token&&(l.headers={...l.headers,Authorization:`Bearer ${a}`}),l},a=>{let{status:o}=a;if(o===403||o===401)return"refresh";if(o===504)return"retry";throw a},i)}var si;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(si||(si={}));var ng=class{},rg=class extends ng{};rg.RPC_ID="dvid/VolumeChunkSource";var ig=class extends ng{};ig.RPC_ID="dvid/SkeletonSource";var ag=class extends ng{};ag.RPC_ID="dvid/MeshSource";var og=new Map;og.set("uint8",G.UINT8);og.set("uint32",G.UINT32);og.set("uint64",G.UINT64);var UA=class{constructor(e){this.obj=e;Z(e),$(e,"TypeName",ae)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}},FA=class{constructor(e,t,r){this.obj=e;this.name=t;this.base=r}},GA=class extends mt(Rt()(Nn),rg){},WA=class extends mt(Rt()(Ki),ig){},zA=class extends mt(Rt()(Mr),ag){},Tp=class extends FA{constructor(e,t,r,i,a){super(e,t,r);this.encoding=i;let o=$(e,"Extended",Z),l=$(o,"Values",d=>Te(d,Z));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;let c=new Set(a);if(i===si.COMPRESSED_SEGMENTATIONARRAY){let d=$(o,"MaxDownresLevel",Bt);this.numLevels=d+1}else for(;c.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=$(l[0],"DataType",d=>Rh(d,og)),this.voxelSize=$(o,"VoxelSize",d=>Je(K.create(),d,Lt)),this.blockSize=$(o,"BlockSize",d=>Je(K.create(),d,Lt)),this.lowerVoxelBound=$(o,"MinPoint",d=>NS(K.create(),d)),this.upperVoxelBoundInclusive=$(o,"MaxPoint",d=>NS(K.create(),d))}get volumeType(){return this.encoding===si.COMPRESSED_SEGMENTATION||this.encoding===si.COMPRESSED_SEGMENTATIONARRAY?gt.SEGMENTATION:gt.IMAGE}getSources(e,t,r,i){let{encoding:a}=this,o=[],l=64;for(let c=0;c<this.numLevels;++c){let d=Math.pow(2,c),p=Math.pow(2,-c),m=K.create(),y=K.create();for(let k=0;k<3;++k){let M=Math.floor(this.lowerVoxelBound[k]*p);m[k]=M-M%l;let I=Math.ceil((this.upperVoxelBoundInclusive[k]+1)*p);y[k]=I,I%l!=0&&(y[k]+=l-I%l)}let v=t.dataInstanceKey;a!==si.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(v+="_"+c.toString());let b={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:v,dataScale:c.toString(),encoding:a},x=ie.create();for(let k=0;k<3;++k)x[5*k]=d,x[12+k]=m[k]*d;let C=$r({rank:3,chunkToMultiscaleTransform:x,dataType:this.dataType,baseVoxelOffset:m,upperVoxelBound:K.subtract(K.create(),y,m),volumeType:this.volumeType,volumeSourceOptions:r,compressedSegmentationBlockSize:a===si.COMPRESSED_SEGMENTATION||a===si.COMPRESSED_SEGMENTATIONARRAY?K.fromValues(8,8,8):void 0}).map(k=>({chunkSource:e.getChunkSource(GA,{spec:k,parameters:b,credentialsProvider:i}),chunkToMultiscaleTransform:x}));o.push(C)}return rr(o)}};function rq(n,e,t){Z(n);let r=$(n,"Base",i=>new UA(i));switch(r.typeName){case"uint8blk":case"grayscale8":let i=r.compressionName.indexOf("jpeg")!==-1;return new Tp(n,e,r,i?si.JPEG:si.RAW,t);case"labels64":case"labelblk":return new Tp(n,e,r,si.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new Tp(n,e,r,si.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(r.typeName)} is not supported.`)}}var kp=class{constructor(e){this.errors=[];this.dataInstances=new Map;this.vnodes=new Set;if(e instanceof kp){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}Z(e),this.alias=$(e,"Alias",ae),this.description=$(e,"Description",ae);let t=$(e,"DataInstances",Z),r=Object.keys(t);for(let o of r)try{this.dataInstances.set(o,rq(t[o],o,r))}catch(l){let c=`Failed to parse data instance ${JSON.stringify(o)}: ${l.message}`;console.log(c),this.errors.push(c)}let i=$(e,"DAG",Z),a=$(i,"Nodes",Z);for(let o of Object.keys(a))this.vnodes.add(o)}};function iq(n){try{let e=Vi(n,r=>new kp(r)),t=new Map;for(let[r,i]of e){t.set(r,i);for(let a of i.vnodes)if(a!==r){let o=new kp(i);t.set(a,o)}}for(let[r,i]of t)i.uuid=r;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}var HA=class{constructor(e){this.repositories=iq(e)}getNode(e){let t=[];for(let r of this.repositories.keys())r.startsWith(e)&&t.push(r);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}};function $A(n,e,t){return n.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{let r=BA(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(a=>new HA(a)),i=`repository info for DVID server ${e}`;return Ke.forPromise(r,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),r})}var jA=class extends Qt{constructor(e,t,r,i,a,o){super(e);this.baseUrl=t;this.nodeKey=r;this.dataInstanceKey=i;this.info=a;this.credentialsProvider=o}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}},aq=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/]+)(\?.*)?$/;function qA(n){if(n.startsWith("https"))return n+"/api/server/token"}function oq(n){let e=n.match(aq);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(n)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},r=e[4];if(r&&r.length>1){let i=gi(r.substring(1));i.user&&(t.user=i.user)}return t.authServer=qA(t.baseUrl),t}function sq(n,e,t,r){let i=e.baseUrl,a=e.nodeKey,o=e.dataInstanceKey,l=t,c={lowerBounds:new Float64Array(l.lowerVoxelBound),upperBounds:Float64Array.from(l.upperVoxelBoundInclusive,y=>y+1)},d=He({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(l.voxelSize,y=>y/1e9),boundingBoxes:[qn(c)]}),p=new jA(n.chunkManager,i,a,o,l,r),m={modelTransform:Et(d),subsources:[{id:"default",subsource:{volume:p},default:!0}]};if(l.meshSrc){let y=ie.create();for(let v=0;v<3;++v)y[5*v]=1/l.voxelSize[v];m.subsources.push({id:"meshes",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(zA,{parameters:{...e,dataInstanceKey:l.meshSrc},credentialsProvider:r})},subsourceToModelSubspaceTransform:y})}return l.skeletonSrc&&m.subsources.push({id:"skeletons",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(WA,{parameters:{...e,dataInstanceKey:l.skeletonSrc},credentialsProvider:r})}}),m.subsources.push({id:"bounds",subsource:{staticAnnotations:Wn(c)},default:!0}),m}function lq(n){let e=oq(n.providerUrl),{baseUrl:t,nodeKey:r,dataInstanceKey:i}=e;return n.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:t,nodeKey:r,dataInstanceKey:i},async()=>{let a=n.credentialsManager.getCredentialsProvider(zx,{dvidServer:e.baseUrl,authServer:e.authServer}),l=(await $A(n.chunkManager,t,a)).getNode(r);if(l===void 0)throw new Error(`Invalid node: ${JSON.stringify(r)}.`);let c=l.dataInstances.get(i);if(!(c instanceof Tp))throw new Error(`Invalid data instance ${i}.`);return sq(n,e,c,a)})}function cq(n,e){return{offset:0,completions:xn(e,n.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function uq(n,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:xn(e,n.repositories.values(),a=>a.uuid+"/",a=>`${a.alias}: ${a.description}`)};let r=t[1],i=n.getNode(r);return Gr(r.length+1,cq(i,t[2]))}async function dq(n){let e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/,r=n.providerUrl.match(e);if(r===null)throw null;let i=r[1],a=r[2],o=qA(i),l=await $A(n.chunkManager,i,n.credentialsManager.getCredentialsProvider(zx,{dvidServer:i,authServer:o}));return Gr(i.length+1,uq(l,a))}var Hx=class extends Ht{constructor(e){super();this.credentialsManager=e}get description(){return"DVID"}get(e){return lq(e)}completeUrl(e){return dq(e)}};an("dvid",n=>new Hx(n.credentialsManager));var JA=class{},YA=class extends JA{},sg=class extends YA{};sg.RPC_ID="render/TileChunkSource";var pq=new Set(["jpg","raw16"]),fq=mt(Nn,sg),KA=class extends fq{},hq=new Set(["COMPLETE","READ_ONLY"]),mq=new Set(["LOADING"]);function gq(n){let e=Te(n,Z);if(e.length<1)throw new Error("No stacks found for owner object.");let t=new Map,r=$(e[0],"stackId",vq);for(let i of e){let a=$(i,"stackId",yq),o=Sq(i);if(o!==void 0){let l=o.project,c=t.get(l);if(c===void 0){let d=new Map;t.set(l,{stacks:d}),c=t.get(l)}c.stacks.set(a,o)}}return{owner:r,projects:t}}function yq(n){return Z(n),$(n,"stack",ae)}function vq(n){return Z(n),$(n,"owner",ae)}function Sq(n){Z(n);let e=$(n,"state",ae),t=[],r=K.create(),i=K.create();if(hq.has(e)){let l=$(n,"stats",Z);r=xq(l),i=bq(l),l.hasOwnProperty("channelNames")&&(t=Cq(l))}else if(!mq.has(e))return;let a=$(n,"currentVersion",wq),o=$(n,"stackId",Tq);return{lowerVoxelBound:r,upperVoxelBound:i,voxelResolution:a,project:o,channels:t}}function bq(n){Z(n);let e=$(n,"stackBounds",Z),t=K.create();return t[0]=$(e,"maxX",jn)+1,t[1]=$(e,"maxY",jn)+1,t[2]=$(e,"maxZ",jn)+1,t}function xq(n){Z(n);let e=$(n,"stackBounds",Z),t=K.create();return t[0]=$(e,"minX",jn),t[1]=$(e,"minY",jn),t[2]=$(e,"minZ",jn),t}function Cq(n){return Z(n),$(n,"channelNames",e=>Te(e,ae))}function wq(n){Z(n);let e=K.create();try{e[0]=$(n,"stackResolutionX",jn),e[1]=$(n,"stackResolutionY",jn),e[2]=$(n,"stackResolutionZ",jn)}catch(t){e[0]=1,e[1]=1,e[2]=1}return e}function Tq(n){return Z(n),$(n,"project",ae)}var XA=class extends Qt{constructor(e,t,r,i,a,o,l){super(e);this.baseUrl=t;this.ownerInfo=r;this.project=a;this.parameters=l;let c=r.projects.get(a);if(c===void 0)throw new Error(`Specified project ${JSON.stringify(a)} does not exist for specified owner ${JSON.stringify(r.owner)}`);if(i===void 0){let y=Array.from(c.stacks.keys());if(y.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(y)}`);i=y[0]}let d=c.stacks.get(i);if(d===void 0)throw new Error(`Specified stack ${JSON.stringify(i)} is not one of the supported stacks: `+JSON.stringify(Array.from(c.stacks.keys())));this.stack=i,this.stackInfo=d,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=mi(l.minIntensity),this.maxIntensity=mi(l.maxIntensity),this.maxTileSpecsToRender=mi(l.maxTileSpecsToRender),this.filter=W1(l.filter),this.minX=mi(l.minX),this.minY=mi(l.minY),this.minZ=mi(l.minZ),this.maxX=mi(l.maxX),this.maxY=mi(l.maxY),this.maxZ=mi(l.maxZ),this.minX!==void 0&&(d.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(d.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(d.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(d.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(d.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(d.upperVoxelBound[2]=this.maxZ);let p=rn(l.encoding);if(p===void 0)p="jpg";else if(!pq.has(p))throw new Error(`Invalid encoding: ${JSON.stringify(p)}.`);this.encoding=p,this.numLevels=mi(l.numlevels),this.dims=K.create();let m=mi(l.tilesize);m===void 0&&(m=1024),this.dims[0]=m,this.dims[1]=m,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?G.UINT16:G.UINT8}get volumeType(){return gt.IMAGE}get rank(){return 3}getSources(e){let t=[],r=this.numLevels;r===void 0&&(r=kq(this.stackInfo,this.dims[0]));let{lowerVoxelBound:i,upperVoxelBound:a}=this.stackInfo;for(let o=0;o<r;o++){let l=ie.create(),c=Uint32Array.of(1,1,1);for(let x=0;x<2;++x)l[5*x]=Math.pow(2,o),c[x]=this.dims[x];let d=K.create(),p=K.create(),m=K.create(),y=K.create();for(let x=0;x<3;x++){let C=l[5*x],k=m[x]=i[x]/C,M=y[x]=a[x]/C;d[x]=Math.floor(k),p[x]=Math.ceil(M)}let v=Ym({rank:3,chunkDataSize:c,dataType:this.dataType,lowerVoxelBound:d,upperVoxelBound:p}),b=this.chunkManager.getChunkSource(KA,{spec:v,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:b,chunkToMultiscaleTransform:l,lowerClipBound:m,upperClipBound:y}])}return rr(t)}};function kq(n,e){let t=0;for(let i=0;i<2;i++)t=Math.max(t,n.upperVoxelBound[i]);if(e>=t)return 1;let r=0;for(;t>e;)t=t/2,r++;return r}function lg(n,e,t){return n.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>ls(`${e}/render-ws/v1/owner/${t}/stacks`).then(r=>r.json()).then(gq))}var Lq=/^([^\/?]+)(?:\/([^\/?]+))?(?:\/([^\/?]+))(?:\/([^\/?]*))?(?:\?(.*))?$/,QA=/^((?:(?:(?:http|https):\/\/[^,\/]+)[^\/?]))\/(.*)$/;function Eq(n,e){let t,r;{let p=e.match(QA);if(p===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=p[1],r=p[2]}let i=r.match(Lq);if(i===null)throw new Error(`Invalid volume path ${JSON.stringify(r)}`);let a=i[1],o=i[2],l=i[3],c=i[4],d=gi(i[5]||"");return n.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:r},async()=>{let p=await lg(n,t,a),m=new XA(n,t,p,l,o,c,d),y=He({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(m.stackInfo.voxelResolution,b=>b/1e9),boundingBoxes:[qn({lowerBounds:new Float64Array(m.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(m.stackInfo.upperVoxelBound)})]});return{modelTransform:Et(y),subsources:[{id:"default",default:!0,subsource:{volume:m}},{id:"bounds",default:!0,subsource:{staticAnnotations:Wn(y.bounds)}}]}})}async function Dq(n,e,t){let r=t.match(/^(?:([^\/]+)(?:\/([^\/]*))?(?:\/([^\/]*))?(\/.*?)?)?$/);if(r===null||r[2]===void 0)throw null;if(r[3]===void 0){let p=r[2]||"",m=await lg(n,e,r[1]),y=xn(p,m.projects,v=>v[0]+"/",()=>{});return{offset:r[1].length+1,completions:y}}if(r[4]===void 0){let p=r[3]||"",y=(await lg(n,e,r[1])).projects.get(r[2]);if(y===void 0)throw null;let v=xn(p,y.stacks,b=>b[0]+"/",b=>b[1].project);return{offset:r[1].length+r[2].length+2,completions:v}}let i=r[4].substr(1)||"",o=(await lg(n,e,r[1])).projects.get(r[2]);if(o===void 0)throw null;let l=o.stacks.get(r[3]);if(l===void 0)throw null;let c=l.channels;if(c.length===0)throw null;let d=xn(i,c,p=>p,()=>{});return{offset:r[1].length+r[2].length+r[3].length+3,completions:d}}async function Pq(n,e){let t=n.match(QA);if(t===null)throw null;let r=t[1],i=t[2],a=await Dq(e,r,i);return Gr(t[1].length+1,a)}var $x=class extends Ht{get description(){return"Render"}get(e){return Eq(e.chunkManager,e.providerUrl)}completeUrl(e){return Pq(e.providerUrl,e.chunkManager)}};an("render",()=>new $x);var Lp;(function(r){r[r.RAW=0]="RAW",r[r.JPEG=1]="JPEG",r[r.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(Lp||(Lp={}));var cg=class{};cg.RPC_ID="precomputed/VolumeChunkSource";var ug=class{};ug.RPC_ID="precomputed/MeshSource";var Ep;(function(t){t[t.RAW=0]="RAW",t[t.GZIP=1]="GZIP"})(Ep||(Ep={}));var dg;(function(t){t[t.IDENTITY=0]="IDENTITY",t[t.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(dg||(dg={}));var pg=class{};pg.RPC_ID="precomputed/MultiscaleMeshSource";var fg=class{};fg.RPC_ID="precomputed/SkeletonSource";var hg=class{};hg.RPC_ID="precomputed/AnnotationSpatialIndexSource";var mg=class{};mg.RPC_ID="precomputed/AnnotationSource";var gg=class{};gg.RPC_ID="precomputed/IndexedSegmentPropertySource";function ZA(n,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,n^=e,n=(n<<13|n>>>19)>>>0,n=Math.imul(n,5)+3864292196>>>0,n}function Iq(n,e){return n^=e,n^=n>>>16,n=Math.imul(n,2246822507)>>>0,n^=n>>>13,n*=3266489909,n^=n>>>16,n>>>0}function jx(n,e,t){let r=n;return r=ZA(r,e),r=ZA(r,t),Iq(r,8)}var qx=class extends Jn{constructor(e,t){super(e,t);this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}};function Aq(n,e,t){let r=n.length-1;for(;;){if(e=e&r,n[e]===0){n[e]=t;return}++e}}function yg(n,e){return e<=255?new Uint8Array(n):e<=65535?new Uint16Array(n):new Uint32Array(n)}function Mq(n){let e=n.length/2,t=Math.ceil(Math.log2(e))+1,r=2**t,i=yg(r,e+1);for(let a=0;a<e;++a){let o=n[2*a],l=n[2*a+1];Aq(i,jx(0,o,l),a+1)}return i}function Rq(n,e,t,r){let i=jx(0,t,r),a=n.length-1;for(;;){i=i&a;let o=n[i];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===r)return o;++i}}var vg=class{constructor(e){this.inlineProperties=e.inlineProperties}},eM=class{constructor(e){this.segmentPropertyMap=e;var r;let{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=Mq(t.ids)),this.tags=t==null?void 0:t.properties.find(i=>i.type==="tags"),this.labels=t==null?void 0:t.properties.find(i=>i.type==="label"),this.numericalProperties=(r=t==null?void 0:t.properties.filter(i=>i.type==="number"))!=null?r:[]}getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return t===void 0?-1:Rq(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(t===-1)return;let{labels:r,tags:i}=this,a="";if(r!==void 0&&(a=r.values[t]),i!==void 0){let{tags:o,values:l}=i,c=l[t];for(let d=0,p=c.length;d<p;++d){let m=o[c.charCodeAt(d)];a.length>0&&(a+=" "),a+="#",a+=m}}if(a.length!==0)return a}};function tM(n,e,t){for(let r=0,i=t.length;r<i;++r)e[t[r]]=n[r]}function _q(n){let e=n.length;if(e===0)return!0;let t=n[0],r=n[1];for(let i=0;i<e;i+=2){let a=n[i],o=n[i+1];if((o-r||a-t)<=0)return!1;t=a,r=o}return!0}function nM(n){let{ids:e}=n;if(_q(e))return n;let t=e.length/2,r=yg(t,t-1);for(let o=0;o<t;++o)r[o]=o;r.sort((o,l)=>{let c=e[o*2],d=e[o*2+1],p=e[l*2],m=e[l*2+1];return d-m||c-p});let i=new Uint32Array(t*2);for(let o=0;o<t;++o){let l=r[o];i[o*2]=e[l*2],i[o*2+1]=e[l*2+1]}let a=n.properties.map(o=>{let{values:l}=o,c=new l.constructor(t);for(let d=0;d<t;++d)c[d]=l[r[d]];return{...o,values:c}});return{ids:i,properties:a}}function Vq(n,e,t){let r=new Array(e);return r.fill(""),tM(n.values,r,t),{...n,values:r}}function Oq(n,e,t){let r=new Float32Array(e);return r.fill(Number.NaN),tM(n.values,r,t),{...n,values:r}}function rM(n,e,t){let{type:r}=n;return r==="label"||r==="description"||r==="string"||r==="tags"?Vq(n,e,t):Oq(n,e,t)}function Nq(n,e){if(n===void 0)return e;if(e===void 0)return n;let t=0,r=n.ids.length/2,i=e.ids.length/2,a=new Uint32Array(r),o=new Uint32Array(i),l=n.ids,c=e.ids;hE(r,i,(m,y)=>{let v=l[2*m+1],b=l[2*m],x=c[2*y+1],C=c[2*y];return v-x||b-C},m=>{a[m]=t,++t},m=>{o[m]=t,++t},(m,y)=>{a[m]=t,o[y]=t,++t});let d;if(t===r)d=l;else if(t===i)d=c;else{d=new Uint32Array(t*2);for(let m=0;m<r;++m){let y=a[m];d[2*y]=l[2*m],d[2*y+1]=l[2*m+1]}for(let m=0;m<i;++m){let y=o[m];d[2*y]=c[2*m],d[2*y+1]=c[2*m+1]}}let p=[];if(t===r)p.push(...n.properties);else for(let m of n.properties)p.push(rM(m,t,a));if(t===i)p.push(...e.properties);else for(let m of e.properties)p.push(rM(m,t,o));return{ids:d,properties:p}}function Bq(n,e){return new vg({inlineProperties:Nq(n.inlineProperties,e.inlineProperties)})}function Uq(n){for(;;){if(n.length===0)return;if(n.length===1)return n[0];let e=[];for(let t=0,r=n.length;t<r;t+=2)t+1===r?e.push(n[t]):e.push(Bq(n[t],n[t+1]));n=e}}function iM(n,e){return n.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>St(t))},()=>{let t=Uq(e);if(t!==void 0)return new eM(t)})}var Fq=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function aM(n,e){var p;if(e.match(Fq)!==null){let m=e.split(/[\s,]+/),y=[],v=new Set;for(let b=0,x=m.length;b<x;++b){let C=m[b];if(C==="")continue;let k=new Q;if(!k.tryParseString(C))continue;let M=k.toString();v.has(M)||(v.add(M),y.push(k))}return y.sort(Q.compare),{ids:y}}let t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(p=n==null?void 0:n.segmentPropertyMap.inlineProperties)==null?void 0:p.properties,i=n==null?void 0:n.tags,a=(i==null?void 0:i.tags)||[],o=a.map(m=>m.toLowerCase()),l=n==null?void 0:n.labels,c=[],d;for(let m=0;m<e.length;m=d){let y=e.indexOf(" ",m),v;if(y===-1?d=y=e.length:d=y+1,v=e.substring(m,y),v.length===0)continue;let b=(C,k)=>{let M=C.toLowerCase(),I=o.indexOf(M);if(I===-1){c.push({begin:k,end:y,message:`Invalid tag: ${C}`});return}if(C=a[I],t.includeTags.includes(C)||t.excludeTags.includes(C)){c.push({begin:k,end:y,message:`Duplicate tag: ${C}`});return}return C};if(v.startsWith("#")){let C=b(v.substring(1),m+1);C!==void 0&&t.includeTags.push(C);continue}if(v.startsWith("-#")){let C=b(v.substring(2),m+2);C!==void 0&&t.excludeTags.push(C);continue}if(v.startsWith("<")||v.startsWith(">")){let C=v.substring(1).toLowerCase();if(C!=="id"&&C!=="label"){let k=r==null?void 0:r.find(M=>M.id.toLowerCase()===C&&(M.type==="number"||M.type==="label"||M.type==="string"));if(k===void 0){c.push({begin:m+1,end:y,message:`Invalid field: ${C}`});continue}C=k.id}if(t.sortBy.find(k=>k.fieldId===C)!==void 0){c.push({begin:m+1,end:y,message:`Duplicate sort field: ${C}`});continue}t.sortBy.push({order:v[0],fieldId:C});continue}if(v.startsWith("|")){let C=v.substring(1).toLowerCase();if(C==="id"||C==="label")continue;let k=r==null?void 0:r.find(M=>M.id.toLowerCase()===C&&(M.type==="number"||M.type==="string"));if(k===void 0){c.push({begin:m+1,end:y,message:`Invalid field: ${C}`});continue}if(C=k.id,t.sortBy.find(M=>M.fieldId===C)||t.includeColumns.find(M=>M===C))continue;t.includeColumns.push(C);continue}if(v.startsWith("/")){if(t.regexp!==void 0){c.push({begin:m,end:y,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){c.push({begin:m,end:y,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0)continue;try{t.regexp=new RegExp(v.substring(1))}catch(C){c.push({begin:m,end:y,message:"Invalid regular expression syntax"})}continue}let x=v.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(x!==null){let C=x[1].toLowerCase(),k=x[2],M=n==null?void 0:n.numericalProperties.find(U=>U.id.toLowerCase()===C);if(M===void 0)continue;C=M.id;let I;try{I=to(M.dataType,x[3])}catch(U){c.push({begin:m+x[1].length+x[2].length,end:y,message:U.message});continue}let A=t.numericalConstraints.find(U=>U.fieldId===C);A===void 0&&(A={fieldId:C,bounds:M.bounds},t.numericalConstraints.push(A));let D=Qs(M.bounds,A.bounds[0]),E=Qs(M.bounds,A.bounds[1]),V=E,N=D;switch(k){case"<":V=Md(M.dataType,I,-1);break;case"<=":V=I;break;case"=":V=N=I;break;case">=":N=I;break;case">":N=Md(M.dataType,I,1);break}if(N=kr(D,N)>0?D:N,V=kr(E,V)<0?E:V,kr(N,V)>0){c.push({begin:m,end:y,message:"Constraint would not match any values"});continue}A.bounds=[N,V];continue}if(t.regexp!==void 0){c.push({begin:m,end:y,message:"Prefix cannot be combined with regular expression"});continue}l!==void 0&&(t.prefix!==void 0?t.prefix+=` ${v}`:t.prefix=v)}return c.length>0?{errors:c}:(t.sortBy.length===0&&t.sortBy.push({fieldId:lM(n),order:"<"}),t)}function Jx(n){return"\\u"+n.toString(16).padStart(4,"0")}function oM(n,e){var k;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){let{ids:M}=e;return{query:e,total:-1,explicitIds:M,count:M.length}}let t=(k=n==null?void 0:n.segmentPropertyMap)==null?void 0:k.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};let r=t==null?void 0:t.properties,i=t.ids.length/2,a=yg(i,i);for(let M=0;M<i;++M)a[M]=M;let o=M=>{let I=a.length,A=0;for(let D=0;D<I;++D){let E=a[D];M(E)&&(a[A]=E,++A)}a=a.subarray(0,A)};if(e.regexp!==void 0||e.prefix!==void 0){let M=n.labels.values,{regexp:I,prefix:A}=e;I!==void 0&&o(D=>M[D].match(I)!==null),A!==void 0&&o(D=>M[D].startsWith(A))}let{includeTags:l,excludeTags:c}=e,d=n.tags;if(l.length>0||c.length>0){let{values:M,tags:I}=d,A=[];for(let U of l)A.push([I.indexOf(U),1]);for(let U of c)A.push([I.indexOf(U),0]);A.sort((U,_)=>U[0]-_[0]);let D="^",E=0,V=U=>{U<E||(D+=`[${Jx(E)}-${Jx(U)}]*`)};for(let[U,_]of A)V(U-1),_&&(D+=Jx(U)),E=U+1;V(65535),D+="$";let N=new RegExp(D);o(U=>M[U].match(N)!==null)}let p,m,{numericalConstraints:y}=e;if(y.length>0){let M=n.numericalProperties,I=y.length,A=2**I-1;p=yg(a.length,A);for(let V=0;V<I;++V){let N=y[V],U=M.find(j=>j.id===N.fieldId),{values:_}=U,B=2**V,[R,X]=N.bounds;for(let j=0,oe=a.length;j<oe;++j){let me=_[a[j]];p[j]|=B*(me>=R&&me<=X)}}m=a,a=m.slice();let D=a.length,E=0;for(let V=0;V<D;++V)p[V]===A&&(a[E]=a[V],++E);a=a.subarray(0,E)}let v=[];if(d!==void 0){let M=[],{tags:I,values:A}=d,D=new Uint32Array(I.length);for(let E=0,V=a.length;E<V;++E){let N=A[a[E]];for(let U=0,_=N.length;U<_;++U)++D[N.charCodeAt(U)]}for(let E=0,V=I.length;E<V;++E){let N=D[E],U=I[E],_={tag:U,tagIndex:E,count:D[E]};e.includeTags.includes(U)||e.excludeTags.includes(U)?M.push(_):N>0&&v.push(_)}M.push(...v),v=M}let b=(M,I)=>{if(M.type!=="number"){let{values:A}=M;a.sort((D,E)=>ho(A[D],A[E])*I)}else{let A=M.values;a.sort((D,E)=>(A[D]-A[E])*I)}},x=M=>{d!==void 0&&b(d,M);let I=n==null?void 0:n.labels;I!==void 0&&b(I,M)},{sortBy:C}=e;for(let M=C.length-1;M>=0;--M){let{fieldId:I,order:A}=C[M],D=A==="<"?1:-1;if(I==="id"){if(M+1===C.length){if(A==="<")continue;a.reverse();continue}a.sort((E,V)=>D*(E-V));continue}else I==="label"?x(D):b(r.find(E=>E.id===I),D)}return{query:e,intermediateIndices:m,intermediateIndicesMask:p,indices:a,tags:v,count:a.length,total:i}}function Gq(n,e,t){let r=256,{values:i}=e,[a,o]=t,l=o<=a?0:r/(o-a),c=new Uint32Array(r+2),{numericalConstraints:d}=n.query,p=d.findIndex(m=>m.fieldId===e.id);if(p===-1){let m=n.indices;for(let y=0,v=m.length;y<v;++y){let b=i[m[y]];isNaN(b)||++c[Math.min(r-1,Math.max(-1,(b-a)*l))+1>>>0]}}else{let m=n.intermediateIndices,y=n.intermediateIndicesMask,v=2**d.length-1-2**p;for(let b=0,x=m.length;b<x;++b)if((y[b]&v)==v){let k=i[m[b]];isNaN(k)||++c[Math.min(r-1,Math.max(-1,(k-a)*l))+1>>>0]}}return{queryResult:n,histogram:c,window:t}}function sM(n,e,t,r){if(n===void 0){t.length=0,r.length=0;return}let{numericalProperties:i}=n,a=i.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let l=0;l<a;++l){let c=t[l],d=r[l],p=i[l];c!==void 0&&c.queryResult===e&&vi(p.dataType,c.window,d)||(t[l]=Gq(e,p,d))}}function lM(n){return(n==null?void 0:n.tags)||(n==null?void 0:n.labels)?"label":"id"}function cM(n,e){let{ids:t}=e;if(t!==void 0)return t.map(l=>l.toString()).join(", ");let r="";e=e;let{prefix:i,regexp:a}=e;i!==void 0?r=i:a!==void 0&&(r=`/${a}`);for(let l of e.includeTags)r.length>0&&(r+=" "),r+=`#${l}`;for(let l of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${l}`;for(let l of e.numericalConstraints){let{fieldId:c,bounds:d}=l,[p,m]=d,y=n.numericalProperties.find(v=>v.id===c);if(!vi(y.dataType,y.bounds,d)){if(kr(p,m)===0){r.length>0&&(r+=" "),r+=`${c}=${p}`;continue}if(kr(p,y.bounds[0])>0){r.length>0&&(r+=" ");let v=Md(y.dataType,p,-1),b=p.toString(),x=v.toString();y.dataType!==G.FLOAT32||b.length<=x.length?r+=`${c}>=${b}`:r+=`${c}>${x}`}if(kr(m,y.bounds[1])<0){r.length>0&&(r+=" ");let v=Md(y.dataType,m,1),b=m.toString(),x=v.toString();y.dataType!==G.FLOAT32||b.length<=x.length?r+=`${c}<=${b}`:r+=`${c}<${x}`}}}let{sortBy:o}=e;if(o.length===1){let l=o[0];l.order==="<"&&l.fieldId===lM(n)&&(o=[])}for(let l of o)r.length>0&&(r+=" "),r+=`${l.order}${l.fieldId}`;for(let l of e.includeColumns)r.length>0&&(r+=" "),r+=`|${l}`;return r}var Yx=new Q;function Dp(n,e,t){if(e===void 0)return;let{explicitIds:r}=e;if(r!==void 0){r.forEach(t);return}let{indices:i}=e;if(i!==void 0){let{ids:a}=n==null?void 0:n.segmentPropertyMap.inlineProperties;for(let o=0,l=i.length;o<l;++o){let c=i[o];Yx.low=a[c*2],Yx.high=a[c*2+1],t(Yx,o)}}}function uM(n,e,t){if(t.size===0)return 0;let r=0;return Dp(n,e,i=>{t.has(i)&&++r}),r}function Kx(n,e,t,r){let i=n.includeTags.filter(o=>o!==e),a=n.excludeTags.filter(o=>o!==e);return r===!0&&(t?i:a).push(e),{...n,includeTags:i,excludeTags:a}}function dM(n){return n.ids!==void 0?!1:n.errors!==void 0?!0:!(n.numericalConstraints.length>0||n.includeTags.length>0||n.excludeTags.length>0||n.prefix||n.regexp)}function Sg(n,e){if(n===void 0||n.ids!==void 0||n.errors!==void 0)return!1;let{sortBy:t,includeColumns:r}=n;return t.find(i=>i.fieldId===e)!==void 0||r.includes(e)}async function Wq(n,e,t,r,i){let a=await Ia(n,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(r)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},$t,i);Z(a);let o=pe(a,"prefixes",vn,[]),l=pe(a,"items",c=>Te(c,d=>(Z(d),$(d,"name",ae))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function pM(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await Wq(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function zq(n,e,t,r,i){let a=await Ia(n,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(r)}`,{},p=>p.text(),i),o=new DOMParser().parseFromString(a,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let p=0,m=l.snapshotLength;p<m;++p)c.push(l.snapshotItem(p).textContent||"");let d=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let p=0,m=d.snapshotLength;p<m;++p)c.push(d.snapshotItem(p).textContent||"");return c}async function Xx(n,e,t,r,i){if(!r.startsWith("/"))throw null;let o=await zq(n,t,r.substring(1),"/",i),l=r.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}function Hq(n,e){return n.getCredentialsProvider("middleauthapp",new URL(e).origin)}function bg(n,e,t){let r=/^\/([^\/]+)/,i=t.match(r);if(i!==null)return n.getCredentialsProvider("gcs",{bucket:i[1]})}function mr(n,e){let t=ml(n);switch(t.protocol){case"gs":case"gs+xml":return{credentialsProvider:e.getCredentialsProvider("gcs",{bucket:t.host}),url:n};case"gs+ngauth+http":return{credentialsProvider:bg(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:bg(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:bg(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:bg(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return n=n.substr("middleauth+".length),{credentialsProvider:Hq(e,n),url:n};default:return{credentialsProvider:void 0,url:n}}}async function Xi(n,e,t,r,i=At){let a=ml(e);switch(a.protocol){case"gs":return Ia(n,`https://www.googleapis.com/storage/v1/b/${a.host}/o/${encodeURIComponent(a.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,t,r,i);case"gs+xml":return Ia(n,`https://storage.googleapis.com/${a.host}${a.path}`,t,r,i);default:return Ia(n,e,t,r,i)}}async function $q(n,e){let{text:t,contentType:r}=await hl(n,{headers:{accept:"text/html"}},async l=>({text:await l.text(),contentType:l.headers.get("content-type")}),e);if(r!=="text/html")return[];let i=new DOMParser().parseFromString(t,r),a=i.evaluate("//a/@href",i,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),o=[];for(let l=0,c=a.snapshotLength;l<c;++l){let p=a.snapshotItem(l).textContent;p&&o.push(new URL(p,n).toString())}return o}async function jq(n,e){let t=n.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(t===null)throw null;let r=await $q(t[1],e),i=t[1].length,a=[];for(let o of r)!o.startsWith(n)||a.push({value:o.substring(i)});return{offset:i,completions:a}}var qq=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"https://"},{value:"http://"}];async function Li(n,e,t){if(!e.includes("://"))return{offset:0,completions:xn(e,qq,m=>m.value,m=>m.description)};let{url:r,credentialsProvider:i}=mr(e,n),a=e.length-r.length,o;try{o=ml(r)}catch{throw null}let{protocol:l,host:c,path:d}=o,p=await(async()=>{if(l==="gs+xml"&&d.length>0)return await Xx(i,`${l}://${c}`,`https://storage.googleapis.com/${c}`,d,t);if(l==="gs"&&d.length>0)return await pM(i,`${l}://${c}`,c,d,t);let m=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com))(\/.*)$/);if(m!==null)return await Xx(i,m[1],m[1],m[2],t);if((l==="http"||l==="https")&&d.length>0)return await jq(r,t);throw null})();return{offset:a+p.offset,completions:p.completions}}var fM=class extends mt(Rt()(Nn),cg){},hM=class extends mt(Rt()(Mr),ug){},mM=class extends mt(Rt()(yo),pg){},gM=class extends mt(Rt()(Ki),fg){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}};function kl(n,e){let t=n.split("/");for(let r of e.split("/")){if(r===".."&&t.length!==0){t.length=t.length-1;continue}t.push(r)}return t.join("/")}var yM=class{constructor(e,t){Z(e);let r=t===1?3:4,i=this.resolution=new Float64Array(r),a=this.voxelOffset=new Float32Array(r),o=this.size=new Float32Array(r);if(r===4&&(i[3]=1,o[3]=t),$(e,"resolution",c=>Je(i.subarray(0,3),c,Lt)),pe(e,"voxel_offset",c=>Je(a.subarray(0,3),c,ft)),$(e,"size",c=>Je(o.subarray(0,3),c,Bt)),this.chunkSizes=$(e,"chunk_sizes",c=>Te(c,d=>{let p=new Uint32Array(r);return r===4&&(p[3]=t),Je(p.subarray(0,3),d,Bt),p})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=$(e,"sharding",xg),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=$(e,"encoding",c=>_t(c,Lp)))===Lp.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=$(e,"compressed_segmentation_block_size",c=>Je(K.create(),c,Bt))),this.key=$(e,"key",ae)}};function Jq(n){Z(n);let e=$(n,"data_type",k=>_t(k,G)),t=$(n,"num_channels",Bt),r=$(n,"type",k=>_t(k,gt)),i=$(n,"mesh",rn),a=$(n,"skeletons",rn),o=$(n,"segment_properties",rn),l=$(n,"scales",k=>Te(k,M=>new yM(M,t)));if(l.length===0)throw new Error("Expected at least one scale");let c=l[0],d=t===1?3:4,p=new Float64Array(d),m=new Float64Array(d),y=new Float64Array(d),v=["x","y","z"],b=["m","m","m"];for(let k=0;k<3;++k)p[k]=c.resolution[k]/1e9,m[k]=c.voxelOffset[k],y[k]=m[k]+c.size[k];d===4&&(p[3]=1,y[3]=t,v[3]="c^",b[3]="");let C=He({rank:d,names:v,units:b,scales:p,boundingBoxes:[qn({lowerBounds:m,upperBounds:y})]});return{dataType:e,volumeType:r,mesh:i,skeletons:a,segmentPropertyMap:o,scales:l,modelSpace:C}}var vM=class extends Qt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){let t=this.info.scales[0].resolution,{rank:r}=this;return rr(this.info.scales.map(i=>{let{resolution:a}=i,o=r+1,l=new Float32Array(o*o);l[l.length-1]=1;let{lowerBounds:c,upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,p=new Float32Array(r),m=new Float32Array(r);for(let y=0;y<3;++y){let v=a[y]/t[y];l[o*y+y]=v,l[o*r+y]=i.voxelOffset[y]*v,p[y]=c[y]/v,m[y]=d[y]/v}return r===4&&(l[o*3+3]=1,p[3]=c[3],m[3]=d[3]),$r({rank:r,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(y=>({chunkSource:this.chunkManager.getChunkSource(fM,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:kl(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:p,upperClipBound:m}))}))}},Yq=mt(Rt()($i),mg),SM=class extends mt(Rt()(fl),hg){},bM=class extends Yq{constructor(e,t){let{parameters:r}=t;super(e,{rank:r.rank,relationships:r.relationships.map(i=>i.name),properties:r.properties,parameters:r});this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(SM,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}};function Kq(n,e,t){return n.getChunkSource(hM,{parameters:t,credentialsProvider:e})}function xM(n){return $(n,"transform",e=>{let t=ie.create();return e!==void 0&&Je(t.subarray(0,12),e,ct),ie.transpose(t,t),t})}function Xq(n){Z(n);let e=$(n,"@type",ae),t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{let i=$(n,"lod_scale_multiplier",Lt),a=$(n,"vertex_quantization_bits",Bt),o=xM(n),l=$(n,"sharding",xg);t={lodScaleMultiplier:i,transform:o,sharding:l,vertexQuantizationBits:a}}}let r=$(n,"segment_properties",rn);return{metadata:t,segmentPropertyMap:r}}async function Qq(n,e,t){let r;try{r=await iu(n,e,t)}catch(i){if(gl(i))return{metadata:void 0};throw i}return Xq(r)}function CM(n){return n===void 0?Ep.RAW:_t(n,Ep)}function xg(n){if(n===void 0)return;Z(n);let e=$(n,"@type",ae);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);let t=$(n,"hash",c=>_t(c,dg)),r=$(n,"preshift_bits",ft),i=$(n,"shard_bits",ft),a=$(n,"minishard_bits",ft),o=$(n,"minishard_index_encoding",CM),l=$(n,"data_encoding",CM);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:a,minishardIndexEncoding:o,dataEncoding:l}}function Zq(n){Z(n);let e=$(n,"@type",ae);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);let t=xM(n),r=new Map;$(n,"vertex_attributes",o=>{o!==void 0&&Te(o,l=>{Z(l);let c=$(l,"id",ae);if(c==="")throw new Error("vertex attribute id must not be empty");if(r.has(c))throw new Error(`duplicate vertex attribute id ${JSON.stringify(c)}`);let d=$(l,"data_type",m=>_t(m,G)),p=$(l,"num_components",Bt);r.set(c,{dataType:d,numComponents:p})})});let i=$(n,"sharding",xg),a=$(n,"segment_properties",rn);return{metadata:{transform:t,vertexAttributes:r,sharding:i},segmentPropertyMap:a}}async function e5(n,e,t){let r=await iu(n,e,t);return Zq(r)}function wM(){return He({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function TM(n,e,t){let{metadata:r,segmentPropertyMap:i}=await Qq(n,e,t);if(r===void 0)return{source:Kq(n,e,{url:t,lod:0}),transform:ie.create(),segmentPropertyMap:i};let a,{vertexQuantizationBits:o}=r;if(o===10)a=xi.uint10;else if(o===16)a=xi.uint16;else throw new Error(`Invalid vertex quantization bits: ${o}`);return{source:n.getChunkSource(mM,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:a}}),transform:r.transform,segmentPropertyMap:i}}async function kM(n,e,t){let{metadata:r,segmentPropertyMap:i}=await e5(n,e,t);return{source:n.getChunkSource(gM,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:i}}function iu(n,e,t){return n.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:St(e)},async()=>await Xi(e,`${t}/info`,{},$t))}function LM(n){let e=ie.create(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function t5(n,e,t,r){let i=Jq(r),a=new vM(n.chunkManager,e,t,i),{modelSpace:o}=i,l=[{id:"default",default:!0,subsource:{volume:a}},{id:"bounds",default:!0,subsource:{staticAnnotations:Wn(o.bounds)}}];if(i.segmentPropertyMap!==void 0){let c=kl(t,i.segmentPropertyMap),d=await iu(n.chunkManager,e,c),p=Cg(n.chunkManager,e,d,c);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:p}})}if(i.mesh!==void 0){let c=kl(t,i.mesh),{source:d,transform:p}=await TM(n.chunkManager,e,c),m=LM(i);ie.multiply(m,m,p),l.push({id:"mesh",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}if(i.skeletons!==void 0){let c=kl(t,i.skeletons),{source:d,transform:p}=await kM(n.chunkManager,e,c),m=LM(i);ie.multiply(m,m,p),l.push({id:"skeletons",default:!0,subsource:{mesh:d},subsourceToModelSubspaceTransform:m})}return{modelTransform:Et(o),subsources:l}}async function n5(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await kM(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=kl(t,a),c=await iu(n.chunkManager,e,l),d=Cg(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:Et(wM()),subsources:o}}function Qx(n,e){return Z(e),{url:kl(n,$(e,"key",ae)),sharding:$(e,"sharding",xg)}}var EM=class{constructor(e,t){this.url=e;Z(t);let r=$(t,"dimensions",nl),{rank:i}=r,a=$(t,"lower_bound",l=>Je(new Float64Array(i),l,ct)),o=$(t,"upper_bound",l=>Je(new Float64Array(i),l,ct));this.coordinateSpace=He({rank:i,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[qn({lowerBounds:a,upperBounds:o})]}),this.parameters={type:$(t,"annotation_type",l=>_t(l,ze)),rank:i,relationships:$(t,"relationships",l=>Te(l,c=>{let d=Qx(e,c),p=$(c,"id",ae);return{...d,name:p}})),properties:$(t,"properties",Oh),byId:$(t,"by_id",l=>Qx(e,l))},this.spatialIndices=$(t,"spatial",l=>Te(l,c=>{let d=Qx(e,c),p=$(c,"grid_shape",C=>Je(new Float32Array(i),C,Bt)),m=$(c,"chunk_size",C=>Je(new Float32Array(i),C,Lt)),y=$(c,"limit",Bt),v=new Float32Array(i);for(let C=0;C<i;++C)v[C]=p[C]*m[C];let b=sr(Float32Array,i+1);for(let C=0;C<i;++C)b[(i+1)*i+C]=a[C];let x={limit:y,chunkToMultiscaleTransform:b,...Uc({rank:i,chunkDataSize:m,upperVoxelBound:v})};return x.upperChunkBound=p,{parameters:d,spec:x,limit:y}})),this.spatialIndices.reverse()}};async function r5(n,e,t,r){let i=new EM(t,r);return{modelTransform:Et(i.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:n.chunkManager.getChunkSource(bM,{credentialsProvider:e,metadata:i,parameters:i.parameters})}}]}}async function DM(n,e,t){let{source:r,transform:i,segmentPropertyMap:a}=await TM(n.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:i}];if(a!==void 0){let l=kl(t,a),c=await iu(n.chunkManager,e,l),d=Cg(n.chunkManager,e,c,l);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:d}})}return{modelTransform:Et(wM()),subsources:o}}function i5(n){Z(n);let e=new Q,t=$(n,"ids",a=>{a=vn(a);let o=a.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(a[c]))throw new Error(`Invalid uint64 id: ${JSON.stringify(a[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),r=t.length/2,i=$(n,"properties",a=>Te(a,o=>{Z(o);let l=$(o,"id",ae),c=pe(o,"description",ae),d=$(o,"type",m=>{if(m!=="label"&&m!=="description"&&m!=="string"&&m!=="tags"&&m!=="number")throw new Error(`Invalid property type: ${JSON.stringify(m)}`);return m});if(d==="tags"){let m=$(o,"tags",vn),y=pe(o,"tag_descriptions",vn);if(y===void 0)y=new Array(m.length),y.fill("");else if(y.length!==m.length)throw new Error(`Expected tag_descriptions to have length: ${m.length}`);let v=$(o,"values",b=>{if(!Array.isArray(b)||b.length!==r)throw new Error(`Expected ${r} values, but received: ${b.length}`);return b.map(x=>String.fromCharCode(...x))});return{id:l,description:c,type:d,tags:m,tagDescriptions:y,values:v}}if(d==="number"){let m=$(o,"data_type",x=>_t(x,G));if(m===G.UINT64)throw new Error("uint64 properties not supported");let y=$(o,"values",x=>{if(!Array.isArray(x)||x.length!==r)throw new Error(`Expected ${r} values, but received: ${x.length}`);return B1[m].from(x)}),v=Infinity,b=-Infinity;for(let x=y.length-1;x>=0;--x){let C=y[x];C<v&&(v=C),C>b&&(b=C)}return{id:l,description:c,type:d,dataType:m,values:y,bounds:[v,b]}}let p=$(o,"values",m=>{if(vn(m),m.length!==r)throw new Error(`Expected ${r} values, but received: ${m.length}`);return m});return{id:l,description:c,type:d,values:p}}));return nM({ids:t,properties:i})}var cpe=mt(Rt()(qx),gg);function Cg(n,e,t,r){try{let i=$(t,"@type",ae);if(i!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(i)}`);let a=pe(t,"inline",i5);return new vg({inlineProperties:a})}catch(i){throw new Error(`Error parsing segment property map: ${i.message}`)}}async function a5(n,e,t,r){return{modelTransform:Et(Ui),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Cg(n.chunkManager,e,r,t)}}]}}var o5=/^([^#]*)(?:#(.*))?$/;function Zx(n){let[,e,t]=n.match(o5);e.endsWith("/")&&(e=e.substring(0,e.length-1));let r=gi(t||"");return{url:e,parameters:r}}function PM(n,e){let t=z1(e);return t&&(n+=`#${t}`),n}var eC=class extends Ht{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){let{url:t,parameters:r}=Zx(e.providerUrl);return e.providerProtocol+"://"+PM(t,r)}convertLegacyUrl(e){let{url:t,parameters:r}=Zx(e.providerUrl);return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+PM(t,r)}get(e){let{url:t,parameters:r}=Zx(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:r},async()=>{let{url:i,credentialsProvider:a}=mr(t,e.credentialsManager),o;try{o=await iu(e.chunkManager,a,i)}catch(d){if(gl(d)&&r.type==="mesh")return await DM(e,a,i);throw d}Z(o);let l=pe(o,"redirect",ae);if(l!==void 0)throw new xm(l);let c=pe(o,"@type",ae);switch(c){case"neuroglancer_skeletons":return await n5(e,a,i);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await DM(e,a,i);case"neuroglancer_annotations_v1":return await r5(e,a,i,o);case"neuroglancer_segment_properties":return await a5(e,a,i,o);case"neuroglancer_multiscale_volume":case void 0:return await t5(e,a,i,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}completeUrl(e){return Li(e.credentialsManager,e.providerUrl,e.cancellationToken)}};an("precomputed",()=>new eC);var IM="nifti/getNiftiVolumeInfo",wg=class{};wg.RPC_ID="nifti/VolumeChunkSource";var AM=class extends mt(Rt()(Nn),wg){},MM=class extends Qt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.url=r;this.info=i}get dataType(){return this.info.dataType}get volumeType(){return gt.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,r=sr(Float32Array,t.rank+1),i=Bx({rank:t.rank,volumeType:gt.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:r,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(AM,{credentialsProvider:this.credentialsProvider,spec:i,parameters:{url:this.url}}),chunkToMultiscaleTransform:r}]]}};function s5(n,e,t,r){return n.rpc.promiseInvoke(IM,{chunkManager:n.addCounterpartRef(),credentialsProvider:lp(n,e),url:t},r)}function l5(n,e,t){return n.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{let{url:r,credentialsProvider:i}=mr(t,e),a=await s5(n,i,r,At),o=new MM(n,i,r,a),l={lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.volumeSize)},c=He({rank:a.rank,names:a.sourceNames,scales:a.sourceScales,units:a.units,boundingBoxes:[qn(l)]}),d=He({rank:a.rank,names:a.viewNames,scales:a.viewScales,units:a.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:Wn(l)}}],modelTransform:{sourceRank:a.rank,rank:a.rank,inputSpace:c,outputSpace:d,transform:a.transform}}})}var tC=class extends Ht{get description(){return"Single NIfTI file"}get(e){return l5(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return Li(e.credentialsManager,e.providerUrl,e.cancellationToken)}};an("nifti",()=>new tC);var Pp;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(Pp||(Pp={}));var Tg=class{};Tg.RPC_ID="n5/VolumeChunkSource";var RM=class extends mt(Rt()(Nn),Tg){},_M=class extends Qt{constructor(e,t,r,i){super(e);this.credentialsProvider=t;this.multiscaleMetadata=r;this.scales=i;let a,o;if(i.forEach((m,y)=>{if(m!==void 0){if(o===void 0&&(o=y),a!==void 0&&m.dataType!==a)throw new Error(`Scale s${y} has data type ${G[m.dataType]} but expected ${G[a]}.`);a=m.dataType}}),a===void 0)throw new Error("At least one scale must be specified.");let l=r.scales[o],c=i[o];this.dataType=a,this.volumeType=gt.IMAGE,this.baseScaleIndex=o;let d=r.modelSpace,{rank:p}=d;this.modelSpace=He({names:d.names,scales:d.scales,units:d.units,boundingBoxes:[{transform:rb(Float64Array,l.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(p),upperBounds:new Float64Array(c.size)}}],coordinateArrays:d.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){let{}=this,{scales:t,rank:r}=this,i=this.multiscaleMetadata.scales;return rr(t.filter(a=>a!==void 0).map((a,o)=>{let l=i[o],c=rb(Float32Array,l.downsamplingFactor);return $r({rank:r,chunkToMultiscaleTransform:c,dataType:a.dataType,upperVoxelBound:a.size,volumeType:this.volumeType,chunkDataSizes:[a.chunkSize],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(RM,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:l.url,encoding:a.encoding}}),chunkToMultiscaleTransform:c}))}))}},VM=class{constructor(e){Z(e),this.dataType=$(e,"dataType",r=>_t(r,G)),this.size=Float32Array.from($(e,"dimensions",r=>Te(r,Bt))),this.chunkSize=$(e,"blockSize",r=>Je(new Uint32Array(this.size.length),r,Bt));let t;pe(e,"compression",r=>{t=$(r,"type",i=>_t(i,Pp))}),t===void 0&&(t=$(e,"compressionType",r=>_t(r,Pp))),this.encoding=t}};function c5(n,e,t){return Promise.all(t.scales.map(async r=>{let i=await OM(n,e,r.url,!0);if(i!==void 0)return new VM(i)}))}function u5(n){let{protocol:e,host:t,path:r}=ml(n);r.endsWith("/")&&(r=r.substring(0,r.length-1));let i=[];for(;;){i.push(`${e}://${t}${r}/attributes.json`);let a=r.lastIndexOf("/");if(a===-1)break;r=r.substring(0,a)}return i}function d5(n,e,t,r){return n.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:St(e)},()=>Xi(e,t,{},$t).then(i=>{try{return Z(i)}catch(a){throw new Error(`Error reading attributes from ${t}: ${a.message}`)}}).catch(i=>{if(gl(i))return r?void 0:{};throw i}))}async function OM(n,e,t,r){let i=u5(t),a=await Promise.all(i.map((o,l)=>d5(n,e,o,r&&l===i.length-1)));if(a.indexOf(void 0)===-1)return a.reverse(),Object.assign({},...a)}function bs(n,e){if(n!==-1&&e!==n)throw new Error(`Rank mismatch, received ${e} but expected ${n}`);return e}function NM(n){return Float64Array.from(Te(n,Lt))}function BM(n){let e=Qr(n);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:Te(e,i=>{let a=NM(i);return t=bs(t,a.length),a}),single:void 0,rank:t}}function p5(n){let e=Qr(n);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return BM(e);let t=NM(n);return{all:void 0,single:t,rank:t.length}}var f5=["x","y","z","t","c"];function h5(n){let e=f5.slice(0,n);for(;e.length<n;)e.push(`d${e.length+1}`);return e}function m5(n,e){Z(e);let t=-1,r=pe(e,"resolution",y=>{let v=Float64Array.from(Te(y,Lt));return t=bs(t,v.length),v}),i=pe(e,"axes",y=>{let v=Te(y,ae);return t=bs(t,v.length),v}),a=pe(e,"units",y=>{let v=Te(y,Jh);return t=bs(t,v.length),v}),o={unit:"m",exponent:-9},l,c;pe(e,"downsamplingFactors",y=>{let{single:v,all:b,rank:x}=p5(y);t=bs(t,x),v!==void 0&&(l=v),b!==void 0&&(c=b)}),pe(e,"pixelResolution",y=>{o=$(y,"unit",Jh),pe(y,"dimensions",v=>{r=Float64Array.from(Te(v,Lt)),t=bs(t,r.length)})}),pe(e,"scales",y=>{let{all:v,rank:b}=BM(y);t=bs(t,b),c=v});let d=pe(e,"dimensions",y=>{let v=Te(y,Bt);return t=bs(t,v.length),v});if(t===-1)throw new Error("Unable to determine rank of dataset");a===void 0&&(a=new Array(t),a.fill(o)),r===void 0&&(r=new Float64Array(t),r.fill(1));for(let y=0;y<t;++y)r[y]=Bd(r[y],a[y].exponent);let p=new Array(t);i!==void 0&&pe(e,"coordinateArrays",y=>{Z(y);for(let v=0;v<t;++v){let b=i[v];if(Object.prototype.hasOwnProperty.call(y,b)){let x=vn(y[b]);p[v]={explicit:!1,labels:x,coordinates:Array.from(x,(C,k)=>k)},a[v]={unit:"",exponent:0},r[v]=1}}}),i===void 0&&(i=h5(t));let m=He({rank:t,valid:!0,names:i,scales:r,units:a.map(y=>y.unit),coordinateArrays:p});if(d===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:m,url:n,attributes:e,scales:c.map((y,v)=>({url:`${n}/s${v}`,downsamplingFactor:y}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:m,url:n,attributes:e,scales:[{url:n,downsamplingFactor:l}]}}var nC=class extends Ht{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{let{url:r,credentialsProvider:i}=mr(t,e.credentialsManager),a=await OM(e.chunkManager,i,r,!1),o=m5(r,a),l=await c5(e.chunkManager,i,o),c=new _M(e.chunkManager,i,o,l);return{modelTransform:Et(c.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:c}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:Wn(c.modelSpace.bounds)}}]}})}completeUrl(e){return Li(e.credentialsManager,e.providerUrl,e.cancellationToken)}};an("n5",()=>new nC);var Ll;(function(r){r[r.RAW=0]="RAW",r[r.GZIP=1]="GZIP",r[r.BLOSC=2]="BLOSC"})(Ll||(Ll={}));var kg=class{};kg.RPC_ID="zarr/VolumeChunkSource";var So=new Map;So.set("|u1",{endianness:An.LITTLE,dataType:G.UINT8});So.set("|i1",{endianness:An.LITTLE,dataType:G.INT8});for(let[n,e]of[["<",An.LITTLE],[">",An.BIG]]){for(let t of["u","i"])So.set(`${n}${t}8`,{endianness:e,dataType:G.UINT64});So.set(`${n}u2`,{endianness:e,dataType:G.UINT16}),So.set(`${n}i2`,{endianness:e,dataType:G.INT16}),So.set(`${n}u4`,{endianness:e,dataType:G.UINT32}),So.set(`${n}i4`,{endianness:e,dataType:G.INT32}),So.set(`${n}f4`,{endianness:e,dataType:G.FLOAT32})}function UM(n){let e=So.get(n);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(n)}`);return e}var FM=class extends mt(Rt()(Nn),kg){};function GM(n){return pe(n,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e})}function g5(n){try{Z(n),$(n,"zarr_format",l=>{if(l!==2)throw new Error(`Expected 2 but received: ${JSON.stringify(l)}`)});let e=$(n,"shape",l=>Te(l,c=>{if(typeof c!="number"||!Number.isInteger(c)||c<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(c)}`);return c})),t=$(n,"chunks",l=>Je(new Array(e.length),l,c=>{if(typeof c!="number"||!Number.isInteger(c)||c<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(c)}`);return c})),r=$(n,"order",l=>{if(l!=="C"&&l!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(l)}`);return l}),i=GM(n),a=$(n,"dtype",l=>UM(ae(l))),o=$(n,"compressor",l=>{if(l===null)return Ll.RAW;Z(l);let c=$(l,"id",ae);switch(c){case"blosc":return Ll.BLOSC;case"gzip":return Ll.GZIP;case"zlib":return Ll.GZIP;default:throw new Error(`Unsupported compressor: ${JSON.stringify(c)}`)}});return{rank:e.length,shape:e,chunks:t,order:r,dataType:a.dataType,encoding:{compressor:o,endianness:a.endianness},dimensionSeparator:i}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}var WM=class extends Qt{constructor(e,t,r,i,a,o){super(e);this.credentialsProvider=t;this.url=r;this.separator=i;this.metadata=a;this.attrs=o;this.dataType=a.dataType,this.volumeType=gt.IMAGE;let l=pe(o,"_ARRAY_DIMENSIONS",c=>Je(new Array(a.rank),c,ae));l===void 0&&(l=Array.from(a.shape,(c,d)=>`d${d}`)),this.modelSpace=He({names:l,scales:Float64Array.from(a.shape,()=>1),units:Array.from(a.shape,()=>""),boundingBoxes:[qn({lowerBounds:new Float64Array(a.rank),upperBounds:Float64Array.from(a.shape)})]})}get rank(){return this.metadata.rank}getSources(e){let{metadata:t}=this,{rank:r,chunks:i,shape:a}=t,o,l,c;if(t.order==="F")o=Uint32Array.from(i),l=Float32Array.from(a),c=sr(Float32Array,r+1);else{o=new Uint32Array(r),l=new Float32Array(r),c=new Float32Array((r+1)**2),c[(r+1)**2-1]=1;for(let d=0;d<r;++d)o[d]=i[r-1-d],l[d]=a[r-1-d],c[d+(r-1-d)*(r+1)]=1}return rr([$r({rank:r,chunkToMultiscaleTransform:c,dataType:t.dataType,upperVoxelBound:l,volumeType:this.volumeType,chunkDataSizes:[o],volumeSourceOptions:e}).map(d=>({chunkSource:this.chunkManager.getChunkSource(FM,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:c}))])}};function y5(n,e,t){return n.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:St(e)},async()=>{try{let r=await Xi(e,t+"/.zattrs",{},$t);return Z(r),r}catch(r){if(gl(r))return{};throw r}})}function v5(n,e,t){return n.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:St(e)},async()=>{let r=await Xi(e,t+"/.zarray",{},$t);return g5(r)})}var S5=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}],rC=class extends Ht{get description(){return"Zarr data source"}get(e){let[,t,r]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),i=gi(r||"");Z(i);let a=GM(i);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:a},async()=>{let{url:o,credentialsProvider:l}=mr(t,e.credentialsManager),[c,d]=await Promise.all([v5(e.chunkManager,l,o),y5(e.chunkManager,l,o)]);if(c.dimensionSeparator!==void 0&&a!==void 0&&c.dimensionSeparator!==a)throw new Error(`Explicitly specified dimension separator ${JSON.stringify(a)} does not match value in .zarray ${JSON.stringify(c.dimensionSeparator)}`);let p=new WM(e.chunkManager,l,o,a||c.dimensionSeparator||".",c,d);return{modelTransform:Et(p.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:p}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:Wn(p.modelSpace.bounds)}}]}})}async completeUrl(e){let[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?Gr(e.providerUrl.length-t.length,await bm(t,S5)):await Li(e.credentialsManager,e.providerUrl,e.cancellationToken)}};an("zarr",()=>new rC);var zM="single_mesh/SingleMeshLayer",HM="single_mesh/getSingleMeshInfo",iC="",$M=class{},Lg=class extends $M{};Lg.RPC_ID="single_mesh/SingleMeshSource";var jM=class extends z{constructor(e){super();this.gl=e;this.buffer=this.registerDisposer(new en(e))}resize(e){let t;if(e<256){let r=t=new Uint8Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let r=t=new Uint16Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let r=t=new Uint32Array(e);for(let i=0;i<e;++i)r[i]=i;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let r=e.attribute("aIndexRaw");r>=0&&(this.bindToVertexAttrib(r),t!==0&&this.gl.vertexAttribDivisor(r,t))}};function qM(n,e,t=!1){let r=e.attribute("aIndexRaw");r>=0&&(t&&n.vertexAttribDivisor(r,0),n.disableVertexAttribArray(r))}function JM(n){return n.memoize.get("IndexBuffer",()=>new jM(n))}function YM(n){n.addAttribute("highp uint","aIndexRaw"),n.addVertexCode(ol),n.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}var aC=class{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let r=t.attribute(this.name);e.bindToVertexAttribI(r,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}};function KM(n,e){return en.fromData(n,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}var XM=`void main() {
  emitGray();
}
`,oC=class{constructor(){this.shaderError=Sa();this.fragmentMain=es(XM);this.shaderControlState=new po(this.fragmentMain)}};function sC(n){return Xt(n.dataType,n.numComponents)}var El=[],QM=Ci(new qi,G.FLOAT32,3),b5=QM;function x5(n){return n.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function lC(n){let e=new Set,t=[];for(let r of n){let i=x5(r),a="",o=0;for(;e.has(i+a);)a=""+ ++o;t.push(i+a)}return t}var ZM=class{constructor(e,t){this.attributeNames=e;this.attributeInfo=t;this.tempLightVec=new Float32Array(4);this.textureAccessHelper=new go("vertexData");this.indexBufferHelper=new aC("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:r}=this;r.defineShader(e);let{attributeNames:i}=this,a=2+i.length;for(let l=El.length;l<a;++l)El[l]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${l}`);a=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",El[a++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",El[a++]),e.addVertexCode(r.getAccessor("readVertexPosition","uVertexAttributeSampler0",G.FLOAT32,3)),e.addVertexCode(r.getAccessor("readVertexNormal","uVertexAttributeSampler1",G.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((l,c)=>{e.addTextureSampler(`${Yc(l.dataType)}sampler2D`,`uVertexAttributeSampler${a}`,El[a]);let d=sC(l);e.addVarying(`highp ${d}`,`vCustom${c}`),e.addFragmentCode(`
#define ${i[c]} vCustom${c}
`),e.addVertexCode(r.getAccessor(`readAttribute${c}`,`uVertexAttributeSampler${a}`,l.dataType,l.numComponents)),o+=`vCustom${c} = readAttribute${c}(${t});
`,++a}),e.addVertexMain(o)}defineShader(e){e.require(YM),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(vo),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,r){let{lightDirection:i,ambientLighting:a,directionalLighting:o,projectionParameters:l}=r,{viewProjectionMat:c}=l;e.uniformMatrix4fv(t.uniform("uProjection"),!1,c);let d=this.tempLightVec;K.scale(d,i,o),d[3]=a,e.uniform4fv(t.uniform("uLightDirection"),d)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginObject(e,t,r){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,r)}bindVertexData(e,t,r){let i=0,a=l=>{let c=WebGL2RenderingContext.TEXTURE0+t.textureUnit(El[i]);e.activeTexture(c),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),++i};a(r.vertexTexture),a(r.normalTexture);let{attributeNames:o}=this;r.vertexAttributeTextures.forEach((l,c)=>{o[c]!==void 0&&a(l)})}disableVertexData(e,t){let r=2,i=this.attributeInfo.length,{attributeNames:a}=this;for(let o=0;o<i;++o)a[o]!==void 0&&++r;for(let o=0;o<r;++o){let l=t.textureUnit(El[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(l),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,r,i){i.ensure(r.numIndices).bind(t),this.bindVertexData(e,t,r.vertexData),this.indexBufferHelper.bind(r.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,r.numIndices)}endLayer(e,t){qM(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}},eR=class{copyToGPU(e,t){let r=(i,a)=>{let o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),ds(e,a,i),o};this.vertexTexture=r(this.vertexPositions,QM),this.normalTexture=r(this.vertexNormals,b5),this.vertexAttributeTextures=this.vertexAttributes.map((i,a)=>r(i,t[a])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let r of t)e.deleteTexture(r);t.length=0}},tR=class extends Er{constructor(e,t){super(e);let r=this.vertexData=new eR;r.vertexPositions=t.vertexPositions,r.vertexNormals=t.vertexNormals,r.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=KM(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}};function C5(n){return n.map(e=>Ci(new qi,e.dataType,e.numComponents))}var nR=class extends mt(Rt()(Jn),Lg){constructor(){super(...arguments);this.attributeTextureFormats=C5(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new tR(this,e)}},w5=ba(Rn),rR=class extends w5{},cC=class extends Wr{constructor(e,t,r){super();this.source=e;this.displayState=t;this.transform=r;this.shaderManager=new ZM(lC(this.source.info.vertexAttributes.map(e=>e.name)),this.source.info.vertexAttributes);this.shaders=new Map;this.sharedObject=this.registerDisposer(new rR);this.shaderGetter=ii(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new Ge(rs(uo(XM))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Wi(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(Fi(t.parseResult.code))}});this.countingBuffer=this.registerDisposer(JM(this.gl));this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));let{sharedObject:i}=this;i.visibility.add(this.visibility),i.RPC_TYPE_ID=zM,i.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let r=ss(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return;let i=this.source.chunks.get(iC);if(i===void 0||i.state!==dt.GPU_MEMORY)return;let a=this.shaderGetter(e.emitter),{shader:o,parameters:l}=a;if(o===null)return;let{gl:c}=this,d=this.shaderManager;o.bind(),d.beginLayer(c,o,e),ai(c,o,this.displayState.shaderControlState,l.parseResult.controls);let{pickIDs:p}=e;d.beginObject(c,o,r),e.emitPickID&&d.setPickID(c,o,p.register(this,i.numIndices/3)),d.drawFragment(c,o,i,this.countingBuffer),d.endLayer(c,o)}transformPickedValue(e){let{pickedOffset:t}=e,r=this.source.chunks.get(iC);if(r===void 0)return;let i=t*3,{indices:a}=r;if(i>=a.length)return;let o=a[i],l=[],{attributeNames:c}=this.shaderManager;return r.vertexData.vertexAttributes.forEach((d,p)=>{let m=c[p];m!==void 0&&l.push(`${m}=${d[o].toPrecision(6)}`)}),l.join(", ")}};function T5(n,e,t){return n.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{let{url:r,credentialsProvider:i}=mr(t,e);return{info:await n.rpc.promiseInvoke(HM,{chunkManager:n.addCounterpartRef(),credentialsProvider:lp(n,i),parameters:{meshSourceUrl:r}}),url:r,credentialsProvider:i}})}async function Eg(n,e,t){let{info:r,url:i,credentialsProvider:a}=await T5(n,e,t);return n.getChunkSource(nR,{credentialsProvider:a,parameters:{meshSourceUrl:i,info:r}})}var uC=class extends Ht{get description(){return"VTK mesh file"}async get(e){let t=await Eg(e.chunkManager,e.credentialsManager,e.url),r=He({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:Et(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return Li(e.credentialsManager,e.providerUrl,e.cancellationToken)}};an("vtk",()=>new uC);var dC=class extends Ht{get description(){return"Wavefront OBJ mesh file"}async get(e){let t=await Eg(e.chunkManager,e.credentialsManager,e.url),r=He({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:Et(r),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return Li(e.credentialsManager,e.providerUrl,e.cancellationToken)}};an("obj",()=>new dC);var yC=rt(Ct());var xs=class extends z{};function Dg(n){let e,t,r;return(i,a)=>t!==void 0&&(e===void 0||i===void 0||e.generation!==i.generation)?(e===void 0&&r.addConsumer(a),t):(e=void 0,r=new bb,t=n(i,r).then(o=>(e=o,r=void 0,o),o=>{throw r.isCanceled&&(r=void 0,t=void 0),o}),t)}function Pg(n){let e=0;return Dg((t,r)=>n(r).then(i=>({generation:++e,credentials:i})))}var iR=class{constructor(){this.providers=new Map;this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let r=this.providers.get(e);if(r===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return r(t,this.topLevelManager)}},Ig=class extends z{constructor(e){super();this.base=e;this.memoize=new Vd}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}},pC=class extends Ig{constructor(){super(new iR);this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}},fC=class extends xs{constructor(e,t){super();this.baseProvider=e;this.anonymousCredentials=t;this.anonymous=!0;this.get=Dg(e=>this.anonymous&&e===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e)))}};function aR(n){return new Error(`Nggraph server ${n} does not allow requests from Neuroglancer instance ${self.origin}`)}async function k5(n){let e=new Ke(!1);function t(i,a){e.element.textContent=i+" ";let o=document.createElement("button");o.textContent=a,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${n}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${n}...`,"Retry")})}let r=new Promise((i,a)=>{function o(l){if((l.origin||l.originalEvent.origin)!==n||typeof l.data!="string")return;let d=()=>{window.removeEventListener("message",o,!1)};l.data==="badorigin"?(d(),a(aR(n))):(d(),i(l.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${n} login required.`,"Login");try{return{token:await r}}finally{e.dispose()}}var hC=class extends xs{constructor(e){super();this.serverUrl=e;this.get=Pg(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await k5(this.serverUrl);case 403:throw aR(this.serverUrl);default:throw ji.fromResponse(e)}})}};var Ip=class{},Ap=class extends z{constructor(e,t){super();this.graph=e;this.segmentsState=t}};function au(n){return!(n.high>>>31)}var mC=new Q(4294967295,4294967295);var Ag=Symbol("disjoint_sets:rank"),bo=Symbol("disjoint_sets:parent"),Mg=Symbol("disjoint_sets:next"),Mp=Symbol("disjoint_sets:prev");function gC(n){let e=n,t=n[bo];for(;t!==n;)n=t,t=n[bo];for(n=e[bo];t!==n;)e[bo]=t,e=n,n=e[bo];return t}function L5(n,e){let t=n[Ag],r=e[Ag];return t>r?(e[bo]=n,n):(n[bo]=e,t===r&&(e[Ag]=r+1),e)}function E5(n,e){let t=n[Mp],r=e[Mp];e[Mp]=t,t[Mg]=e,n[Mp]=r,r[Mg]=n}function*oR(n){let e=n;do yield e,e=e[Mg];while(e!==n)}function D5(n){n[bo]=n,n[Ag]=0,n[Mg]=n[Mp]=n}var ou=Symbol("disjoint_sets:min");function sR(n){return n[bo]===n}var Dl=class{constructor(){this.map=new Map;this.highBitRepresentative=new Ge(!1);this.generation=0}get(e){let t=e.toString(),r=this.map.get(t);return r===void 0?e:gC(r)[ou]}isMinElement(e){let t=this.get(e);return t===e||Q.equal(t,e)}makeSet(e){let t=e.toString(),{map:r}=this,i=r.get(t);return i===void 0?(i=e.clone(),D5(i),i[ou]=i,r.set(t,i),i):gC(i)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let r=L5(e,t);E5(e,t);let i=e[ou],a=t[ou];return r[ou]=Q.less(i,a)!==this.highBitRepresentative.value?i:a,!0}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}deleteSet(e){let{map:t}=this,r=!1;for(let i of this.setElements(e))t.delete(i.toString()),r=!0;return r}*setElements(e){let t=e.toString(),r=this.map.get(t);r===void 0?yield e:yield*oR(r)}clear(){let{map:e}=this;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=gC(t)[ou],yield e}*roots(){for(let e of this.map.values())sR(e)&&(yield e)}[Symbol.iterator](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(sR(t)){let r=new Array;for(let i of oR(t))r.push(i);r.sort(Q.compare),e.push(r)}return e.sort((t,r)=>Q.compare(t[0],r[0])),e.map(t=>t.map(r=>r.toString()))}};var P5="^(https?://[^/]+)/(.*)$";function I5(n){return Z(n),{id:$(n,"id",e=>Q.parseString(ae(e))),baseSegments:$(n,"base_segment_ids",e=>Te(e,t=>Q.parseString(ae(t)))),baseSegmentParents:$(n,"base_segment_parent_ids",e=>Te(e,t=>Q.parseString(ae(t)))),name:$(n,"name",ae),tags:$(n,"tags",vn),numVoxels:$(n,"num_voxels",ft),bounds:$(n,"bounds",e=>Te(e,t=>ct(t))),lastLogId:$(n,"last_log_id",e=>e==null?null:Q.parseString(ae(e)))}}var lR=0,cR=class extends Ap{constructor(e,t){super(e,t);this.debouncedVisibleSegmentsChanged=this.registerCancellable((0,yC.default)(()=>this.visibleSegmentsChanged(),0));this.segmentQueries=new Map;this.ignoreVisibleSegmentsChanged=!1;this.segmentEquivalencesChanged=this.registerCancellable((0,yC.default)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;t.clear();for(let[r,i]of e){if(i.current===void 0||au(i.id))continue;let{id:a,baseSegments:o}=i.current;if(o.length>0){for(let l of o)t.link(l,a);i.addedEquivalences=!0}else i.addedEquivalences=!1}},0));let r=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(r)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:r}=this.segmentsState,i=r.get(e);if(au(i)||!Q.equal(r.get(t),i))return;let a=this.segmentQueries.get(i.toString());if(a===void 0)return;let{current:o}=a;if(o===void 0)return;let{baseSegments:l,baseSegmentParents:c}=o,d=c.length,p=new Dl;for(let b=0;b<d;++b){let x=l[b],C=c[b];Q.equal(x,t)||Q.equal(C,t)||(p.link(x,C),console.log(`Linking ${x} - ${C} == ${e}? ${Q.equal(e,x)} ${Q.equal(e,C)} :: unioned with include = ${Q.equal(e,p.get(x))}, with exclude = ${Q.equal(t,p.get(x))}`))}let m=[],y=[],v=p.get(e);for(let b of l)Q.equal(p.get(b),v)?m.push(b):y.push(b);return console.log("include = "+m.map(b=>b.toString()).join(",")),console.log("exclude = "+y.map(b=>b.toString()).join(",")),{includeRepresentative:i,includeBaseSegments:m,excludeRepresentative:mC,excludeBaseSegments:y}}registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:lR,disposer:this.graph.watchSegment(e,i=>this.handleSegmentUpdate(t.id.toString(),i))},r=e.toString();this.segmentQueries.set(r,t),console.log(`adding to segmentQueries: ${r}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let r=this.segmentQueries.get(e);if(t==="invalid"){r.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(r.id),this.segmentsState.temporaryVisibleSegments.delete(r.id)}finally{this.ignoreVisibleSegmentsChanged=!1}r.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){r.current=void 0,r.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}r.current=t;let i=r.id,a=t.id;if(Q.equal(a,i))r.current=t,au(r.id)||this.segmentEquivalencesChanged();else{r.id=a;let o=a.toString(),l=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${a}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(i)&&(this.segmentsState.visibleSegments.delete(i),this.segmentsState.visibleSegments.add(a)),this.segmentsState.temporaryVisibleSegments.has(i)&&(this.segmentsState.temporaryVisibleSegments.delete(i),this.segmentsState.temporaryVisibleSegments.add(a))}finally{this.ignoreVisibleSegmentsChanged=!1}l===void 0?(console.log(`adding to segmentQueries due to rename -> ${a}`),this.segmentQueries.set(o,r),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof l.current!="object"||l.current.lastLogId===null||Q.less(l.current.lastLogId,t.lastLogId))&&(l.current=t,this.segmentEquivalencesChanged()),r.disposer())}}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,r=++lR,i=a=>{for(let o of a){if(Q.equal(o,mC))continue;let l=o.toString(),c=t.get(l);if(c!==void 0){c.seenGeneration=r;continue}this.registerVisibleSegment(o.clone())}};i(e.visibleSegments),i(e.temporaryVisibleSegments);for(let[a,o]of t)o.seenGeneration!==r&&(console.log(`removing from segmentQueries due to seenGeneration: ${a}`),t.delete(a),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}},uR=class extends Ip{constructor(e,t,r){super();this.chunkManager=e;this.serverUrl=t;this.entityName=r;this.startingWebsocket=!1;this.websocket=void 0;this.watchesById=new Map;this.watches=new Set;this.nextWatchId=0;this.numOpenFailures=0}get highBitRepresentative(){return!0}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new Ke(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let o=1e3*Math.min(16,2**t);await new Promise(l=>setTimeout(l,o))}let r=(await SC(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,i=new URL("/graph/watch/"+encodeURIComponent(r.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let a=new WebSocket(i.href);a.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},a.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=a,this.nextWatchId=0;try{for(let o of this.watches){a.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));let l=this.nextWatchId++;o.watchId=l,this.watchesById.set(l,o)}}catch{}},a.onmessage=o=>{let l,c;try{let d=JSON.parse(o.data);Z(d);let p=$(d,"watch_id",ft),m=this.watchesById.get(p);if(m===void 0)return;c=m;let y=$(d,"state",ae);y==="invalid"||y==="error"?l=y:l=$(d,"info",I5)}catch(d){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,d);return}console.log("got update",l),c.callback(l)}})()}connect(e){return new cR(this,e)}trackSegment(e,t){return this.watchSegment(e,r=>{if(r==="invalid")t(null);else{if(r==="error")return;t(r.id)}})}watchSegment(e,t){let r={callback:t,segment:e,watchId:-1};this.watches.add(r);let{websocket:i}=this;if(i!==void 0)try{i.send(JSON.stringify({watch:{segment_id:e.toString()}}));let o=this.nextWatchId++;r.watchId=o,this.watchesById.set(o,r)}catch{}else this.startWebsocket();return()=>{let{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){let l=r.watchId;this.watchesById.delete(l);try{o.send(JSON.stringify({unwatch:{watch_id:l}}))}catch{}}this.watches.delete(r)}}async merge(e,t){let r=await bC(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Z(r),$(r,"merged",i=>Q.parseString(i))}async split(e,t){let r=await bC(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return Z(r),{include:$(r,"include",i=>Q.parseString(i)),exclude:$(r,"exclude",i=>Q.parseString(i))}}};function dR(n){let e=n.match(P5);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(n)}`);return{serverUrl:e[1],id:e[2]}}function vC(n,e,t,r,i=At){return cs(n,`${e}${t}`,r,$t,(a,o)=>{let l=new Headers(o.headers);return l.set("Authorization",a.token),{...o,headers:l}},a=>{let{status:o}=a;if(o===401)return"refresh";throw a},i)}function A5(n,e,t,r,i=At){return vC(fR(n,e),e,t,r,i)}var pR=class extends xs{constructor(e,t,r){super();this.parentCredentialsProvider=e;this.serverUrl=t;this.entityName=r;this.get=Pg(async()=>{let e=await vC(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}};function fR(n,e){return n.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new hC(e))}function SC(n,e,t){return n.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new pR(fR(n,e),e,t))}function bC(n,e,t,r,i,a=At){return vC(SC(n,e,t),e,r,i,a)}function M5(n){return Z(n),$(n,"entities",e=>Te(e,t=>{Z(t);let r=$(t,"entity",ae),i=$(t,"entity_type",ae),a=$(t,"access_role",ae);return{id:r,entityType:i,accessRole:a}}))}var xC=class extends Ht{get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:r}=dR(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:r},async()=>{let i=SC(e.chunkManager,t,r),{entityType:a}=(await i.get()).credentials;if(a!="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(a)}`);let{datasource_url:o}=await bC(e.chunkManager,t,r,"/graph/config",{method:"POST"}),l=await e.registry.get({...e,url:o}),c=new uR(e.chunkManager,t,r),d=[...l.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:c}}];return{modelTransform:l.modelTransform,subsources:d}})}async completeUrl(e){let{serverUrl:t,id:r}=dR(e.providerUrl),i=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>M5(await A5(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:xn(r,i,a=>a.id,a=>`${a.entityType} (${a.accessRole})`)}}};an("nggraph",()=>new xC);var Rg;(function(r){r[r.JPEG=0]="JPEG",r[r.NPZ=1]="NPZ",r[r.RAW=2]="RAW"})(Rg||(Rg={}));var _g=class{},Vg=class extends _g{};Vg.RPC_ID="python/VolumeChunkSource";var Og=class extends _g{};Og.RPC_ID="python/MeshSource";var Ng=class extends _g{};Ng.RPC_ID="python/SkeletonSource";function CC(n){class e extends n{constructor(...r){super(...r);let i=r[1],a=this.dataSource=this.registerDisposer(i.dataSource.addRef());this.generation=i.generation;let o=i.parameters.key;a.registerSource(o,this)}static encodeOptions(r){let i=super.encodeOptions(r);return i.dataSource=St(r.dataSource),i}}return e}var hR=class extends CC(mt(Nn,Vg)){},Bg=class extends CC(mt(Mr,Og)){};function mR(n,e,t,r,i,a){let o=n.length,l=new Float32Array(o);l.fill(1);let c=[l.slice()],d=1,p=e.length;if(p===0)return c;for(;!(c.length>=i||d>=r||l.every((b,x)=>n[x]/b<=a));){let m=e[0],y=b=>l[b]*t[b];for(let b=1;b<p;++b){let x=e[b];y(x)<y(m)&&(m=x)}l[m]*=2,d*=2;let v=y(m);for(let b=0;b<p&&d<r;++b){let x=e[b];if(x===m)continue;let C=y(x);Math.abs(C-v)>Math.abs(C*2-v)&&(l[x]*=2,d*=2)}c.push(new Float32Array(l))}return c}function wC(n){Z(n);let e={...$(n,"coordinateSpace",nl),valid:!0},{rank:t}=e;e.coordinateArrays.forEach(a=>{a!==void 0&&(a.explicit=!1)});let r=nb(new Float32Array((t+1)*(t+1)),t+1,t+1),i=$(n,"voxelOffset",a=>Je(new Float64Array(t),a,ct));for(let a=0;a<t;++a)r[(t+1)*t+a]=i[a];return{subsourceToModelTransform:r,baseModelSpace:e,voxelOffset:i}}var gR=class extends Qt{constructor(e,t,r,i){super(t);this.dataSource=e;this.key=r;this.response=i;let{baseModelSpace:a,subsourceToModelTransform:o,voxelOffset:l}=wC(i);this.dataType=$(i,"dataType",y=>_t(y,G)),this.volumeType=$(i,"volumeType",y=>_t(y,gt)),this.encoding=$(i,"encoding",y=>_t(y,Rg));let c=a.rank;this.subsourceToModelTransform=o;let d=$(i,"shape",y=>Je(new Float32Array(c),y,Bt));this.shape=d,this.maxDownsampling=$(i,"maxDownsampling",y=>y===null?Number.POSITIVE_INFINITY:ft(y)),this.maxDownsampledSize=$(i,"maxDownsampledSize",y=>y===null?Number.POSITIVE_INFINITY:ft(y)),this.maxDownsamplingScales=$(i,"maxDownsamplingScales",y=>y===null?Number.POSITIVE_INFINITY:ft(y)),this.downsamplingLayout=$(i,"downsamplingLayout",y=>y==="2d"?ni.FLAT:ni.ISOTROPIC),this.chunkLayoutPreference=$(i,"chunkLayout",y=>_t(y,ni));let p={lowerBounds:l,upperBounds:Mc(new Float64Array(c),l,d)},m=He({rank:c,names:a.names,scales:a.scales,units:a.units,boundingBoxes:[qn(p)],coordinateArrays:a.coordinateArrays});this.modelSpace=m,this.generation=$(i,"generation",y=>y),this.maxVoxelsPerChunkLog2=pe(i,"maxVoxelsPerChunkLog2",Bt,kb)}get rank(){return this.modelSpace.rank}getSources(e){let t=[],{rank:r,volumeType:i,dataType:a,shape:o,encoding:l}=this,c=new Float32Array(r),{multiscaleToViewTransform:d,modelChannelDimensionIndices:p}=e;for(let b=0;b<r;++b){let x=0;for(let C=0;C<3;++C){let k=d[b*3+C];x+=k*k}x!==0&&t.push(b),c[b]=Math.sqrt(x)}let m=(b,x,C)=>{let k=new Float32Array((r+1)**2);k[k.length-1]=1;for(let D=0;D<r;++D)k[(r+2)*D]=b[D];let M=new Float32Array(r),I=new Float32Array(r);for(let D=0;D<r;++D)M[D]=Math.ceil(o[D]/b[D]),I[D]=o[D]/b[D];let A=new Uint32Array(r);A.fill(1);for(let D of x)A[D]=4294967295;for(let D of p)A[D]=4294967295;return $r({chunkToMultiscaleTransform:k,rank:r,dataType:a,volumeType:i,maxBlockSize:A,upperVoxelBound:M,volumeSourceOptions:e,chunkLayoutPreference:C}).map(D=>({chunkSource:this.chunkManager.getChunkSource(hR,{spec:D,dataSource:this.dataSource,generation:this.generation,parameters:{key:this.key,scaleKey:b.join(),encoding:l}}),chunkToMultiscaleTransform:k,upperClipBound:I}))},y=b=>mR(this.shape,b,c,this.maxDownsampling,this.maxDownsamplingScales,this.maxDownsampledSize).map(x=>m(x,b,ni.ISOTROPIC)[0]),{downsamplingLayout:v}=this;return v===ni.FLAT?[y([t[0],t[1]]),y([t[0],t[2]]),y([t[1],t[2]])]:rr(mR(this.shape,t,c,this.maxDownsampling,this.maxDownsamplingScales,this.maxDownsampledSize).map(b=>m(b,t,this.chunkLayoutPreference)))}getMeshSource(){let{skeletonVertexAttributes:e}=this;return e!==void 0?this.chunkManager.getChunkSource(TC,{dataSource:this.dataSource,generation:this.generation,parameters:{key:this.key,vertexAttributes:e}}):this.chunkManager.getChunkSource(Bg,{dataSource:this.dataSource,generation:this.generation,parameters:{key:this.key}})}},TC=class extends CC(mt(Ki,Ng)){get vertexAttributes(){return this.parameters.vertexAttributes}};function R5(n){return Z(n),{dataType:$(n,"dataType",e=>_t(e,G)),numComponents:$(n,"numComponents",Bt)}}function _5(n,e,t){return e.chunkManager.memoize.getUncounted({type:"python:VolumeDataSource",key:t},async()=>{let r=await(await ls(`../../neuroglancer/info/${t}`)).json(),i=new gR(n,e.chunkManager,t,r);console.log("volume source");let a={modelTransform:Et(i.modelSpace),subsources:[{id:"default",default:!0,subsource:{volume:i},subsourceToModelSubspaceTransform:i.subsourceToModelTransform},{id:"bounds",default:!0,subsource:{staticAnnotations:Wn(i.modelSpace.bounds)}}]};if(i.rank===3&&i.dataType!==G.FLOAT32){let o=new Float32Array(i.subsourceToModelTransform),{scales:l,rank:c}=i.modelSpace;for(let d=0;d<c;++d)o[(c+2)*d]=1/l[d];a.subsources.push({id:"meshes",default:!0,subsourceToModelSubspaceTransform:o,subsource:{mesh:e.chunkManager.getChunkSource(Bg,{dataSource:n,generation:i.generation,parameters:{key:t}})}})}return a})}function V5(n,e,t){return console.log("In getMeshDataSource"),e.chunkManager.memoize.getUncounted({type:"python:MeshDataSource",key:t},async()=>{let r=await(await ls(`../../neuroglancer/meshinfo/${t}`)).json(),{baseModelSpace:i,subsourceToModelTransform:a}=wC(r),o=$(r,"generation",d=>d);console.log(n);let l=e.chunkManager.getChunkSource(Bg,{dataSource:n,generation:o,parameters:{key:t}});return{modelTransform:Et(i),subsources:[{id:"ssvmesh",default:!0,subsourceToModelSubspaceTransform:a,subsource:{mesh:l}}]}})}function O5(n,e,t){return e.chunkManager.memoize.getUncounted({type:"python:SkeletonDataSource",key:t},async()=>{let r=await(await ls(`../../neuroglancer/skeletoninfo/${t}`)).json(),{baseModelSpace:i,subsourceToModelTransform:a}=wC(r),o=$(r,"attributes",p=>Vi(p,R5)),l=$(r,"generation",p=>p),c=e.chunkManager.getChunkSource(TC,{dataSource:n,generation:l,parameters:{key:t,vertexAttributes:o}});return console.log("skeleton source"),console.log(c),{modelTransform:Et(i),subsources:[{id:"default",subsourceToModelSubspaceTransform:a,default:!0,subsource:{mesh:c}}]}})}var kC=class extends Ht{constructor(){super(...arguments);this.sources=new Map;this.sourceGenerations=new Map}registerSource(e,t){let r=this.sources.get(e);r===void 0&&(r=new Set,this.sources.set(e,r));let i=this.sourceGenerations.get(e);i!==void 0&&(t.generation=i),r.add(t),t.registerDisposer(()=>{r.delete(t),r.size===0&&this.sources.delete(e)})}setSourceGeneration(e,t){let{sourceGenerations:r}=this;if(r.get(e)===t)return;r.set(e,t);let i=this.sources.get(e);if(i!==void 0)for(let a of i)a.generation!==t&&(a.generation=t,a.invalidateCache())}deleteSourceGeneration(e){this.sourceGenerations.delete(e)}get description(){return"Python-served volume"}get(e){let t=e.providerUrl.match("^(volume|skeleton|mesh)/(.*)$");if(t===null)throw new Error(`Invalid Python data source URL: ${JSON.stringify(e.providerUrl)}`);let r=t[2];return t[1]==="volume"?_5(this,e,r):t[1]==="skeleton"?O5(this,e,r):V5(this,e,r)}};var Kg=rt(Ct()),a_=rt(Pl());function G5(n){return typeof n=="boolean"?{enabled:n}:(Z(n),{enabled:pe(n,"enabled",ya)})}function Il(n,e=void 0){return typeof n=="string"?{url:n,transform:e,enableDefaultSubsources:!0,subsources:new Map}:(Z(n),{url:$(n,"url",ae),transform:$(n,"transform",hb)||e,enableDefaultSubsources:pe(n,"enableDefaultSubsources",ya,!0),subsources:pe(n,"subsources",t=>Vi(t,G5),new Map)})}function W5(n){return n.enabled}function vR(n){let e=mb(n.transform),t={},r=!0;for(let[i,a]of n.subsources){let o=W5(a);o!==void 0&&(t[i]=o,r=!1)}return e===void 0&&r&&n.enableDefaultSubsources===!0?n.url:{url:n.url,transform:e,subsources:r?void 0:t,enableDefaultSubsources:n.enableDefaultSubsources===!0?void 0:!1}}var SR=class{constructor(e,t,r,i,a){this.loadedDataSource=e;this.subsourceEntry=t;this.subsourceSpec=r;this.subsourceIndex=i;this.activated=void 0;this.guardValues=[];this.messages=new zi;this.isActiveChanged=new re;let o;r===void 0||r.enabled===void 0?o=t.default&&a:o=r.enabled;let l=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:c}=t;if(c===void 0){c=new Array(l);for(let p=0;p<l;++p)c[p]=p}let{subsourceToModelSubspaceTransform:d=sr(Float32Array,c.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=d,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(Ee(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;let r=this.activated=new z;e(r),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:Dr.error,message:e});let{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:r,transform:i}=this.loadedDataSource;return t.registerDisposer(em(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,i,this,e))}},Ug=class extends z{constructor(e,t,r){super();this.layerDataSource=e;this.dataSource=t;this.error=void 0;this.enabledSubsourcesChanged=new re;this.activatedSubsourcesChanged=new re;this.messages=new zi;t.canChangeModelSpaceRank?(this.transform=new Kh(Et(He({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new Kh(t.modelTransform),r.transform!==void 0&&(this.transform.spec=r.transform);let i=r.subsources;this.enableDefaultSubsources=r.enableDefaultSubsources,this.subsources=t.subsources.map((a,o)=>new SR(this,a,i.get(a.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(let e of this.subsources){let{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}},LC=class extends z{constructor(e,t=void 0){super();this.layer=e;this.changed=new re;this.messages=new zi;this.loadState_=void 0;this.specGeneration=-1;this.refCounted_=void 0;this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=Cm():this.spec=t}get spec(){let{loadState:e}=this;if(e!==void 0&&e.error===void 0){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,r=>{let i=e.enableDefaultSubsources&&r.subsourceEntry.default;return[r.subsourceEntry.id,{enabled:r.enabled!==i?r.enabled:void 0}]}))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){let c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let r=new z,i=r.registerDisposer(mh(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=r,this.spec_=e;let a=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new ao;this.messages.addMessage({severity:Dr.info,message:"Loading data source"}),o.get({chunkManager:a,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then(c=>{if(r.wasDisposed)return;this.messages.clearMessages();let d=r.registerDisposer(new Ug(this,c,e));d.registerDisposer(t.addCoordinateSpace(d.transform.outputSpace)),d.registerDisposer(d.transform.changed.add(this.changed.dispatch)),this.loadState_=d,d.registerDisposer(d.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),i()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:Dr.error,message:c.message}),this.changed.dispatch())}),r.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){let{loadState:e}=this;return e===void 0||e.error!==void 0?vR(this.spec):vR({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let r=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==r?t.enabled:void 0}]}))})}};var on;(function(r){r[r.LINKED=0]="LINKED",r[r.RELATIVE=1]="RELATIVE",r[r.UNLINKED=2]="UNLINKED"})(on||(on={}));var Fg;(function(t){t[t.LINKED=0]="LINKED",t[t.UNLINKED=2]="UNLINKED"})(Fg||(Fg={}));var bR=class extends gs{constructor(e=0){super(on,e)}},xR=class extends gs{constructor(e=0){super(Fg,e)}},Gg=K.create(),CR=at.create();function Rp(n,e,t,r){let i=!1,a=!1,o;n.registerDisposer(e);let l=()=>{if(!a){switch(i=!0,t.value){case 2:if(r.isValid(n))break;case 0:r.assign(n,e);break;case 1:r.add(n,e,o);break}i=!1}},c=()=>{if(!i)switch(t.value){case 2:break;case 0:r.assign(e,n);break;case 1:r.subtract(e,n,o);break}},d=2,p=()=>{let m=t.value;if(m!==d)switch(m){case 2:o=void 0;break;case 0:o=void 0,r.assign(n,e);break;case 1:o=r.difference(n,e);break}d=m,n.changed.dispatch()};return n.registerDisposer(n.changed.add(c)),n.registerDisposer(e.changed.add(l)),n.registerDisposer(t.changed.add(p)),p(),n}function wR(n,e,t,r){return Rp(n,e,t,r)}var Qi=class extends z{constructor(e){super();this.coordinateSpace=e;this.coordinates_=ro;this.changed=new re;this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=ro,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;let{coordinates_:r}=this;r.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:r}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:p}=this;if(!(p!==void 0&&p.length===r)){p=this.coordinates_=new Float32Array(r),pD(p,e.bounds);for(let m=0;m<r;++m)p[m]=Math.floor(p[m])+.5}this.changed.dispatch();return}let i=new Float32Array(r),a=this.coordinates_,{ids:o,scales:l}=e,{ids:c,scales:d}=t;for(let p=0;p<r;++p){let m=o[p],y=c.indexOf(m);y===-1?i[p]=sb(e.bounds.lowerBounds[p],e.bounds.upperBounds[p]):i[p]=a[y]*(d[y]/l[p])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(Te(e,ct)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{coordinates_:e}=this,t=e.length;for(let r=0;r<t;++r)e[r]=Math.floor(e[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:r}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){let r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return zh(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();let{value:a}=t;r!==void 0&&a.length===r.length&&(iD(e.value,a,r,i),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}Z(t),Cn(t,"voxelCoordinates",e)}}}};function TR(n,e,t){if(t===void 0||Object.keys(t).length===0){n.value=0;return}Z(t),n.value=2,$(t,"value",r=>{r!==void 0&&e.restoreState(r)}),$(t,"link",r=>n.restoreState(r))}var su=class{constructor(e,t=new bR){this.peer=e;this.link=t}get changed(){return this.value.changed}toJSON(){let{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){TR(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}},EC=class extends su{constructor(e,t=new xR){super(e,t)}},_p=class extends su{constructor(){super(...arguments);this.value=Rp(new Qi(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:Qi.getOffset,add:Qi.addOffset,subtract:(e,t,r)=>{Qi.addOffset(e,t,r,-1)}})}};function z5(n){return n[0]===0&&n[1]===0&&n[2]===0&&n[3]===1}var xo=class extends z{constructor(e){super();this.changed=new re;e==null&&(e=at.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(at.normalize(this.orientation,this.orientation),!z5(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{Ec(this.orientation,e),at.normalize(this.orientation,this.orientation)}catch(t){at.identity(this.orientation)}this.changed.dispatch()}reset(){at.identity(this.orientation),this.changed.dispatch()}snap(){let e=Ft.create();Ft.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,a=0;for(let o=0;o<3;++o){let l=e[r*3+o];e[r*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(i)&&(i=l,a=o)}e[r*3+a]=Math.sign(i),t[a]=!0}at.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new xo(at.multiply(at.create(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{i||(a=!0,at.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),a=!1)}));let a=!1,o=at.invert(at.create(),t);return r.registerDisposer(r.changed.add(()=>{a||(i=!0,at.multiply(e.orientation,r.orientation,o),e.changed.dispatch(),i=!1)})),r}assign(e){at.copy(this.orientation,e.orientation),this.changed.dispatch()}},lu=class extends su{constructor(){super(...arguments);this.value=Rp(new xo,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let r=at.create();return at.multiply(r,at.invert(r,t.orientation),e.orientation)},add:(e,t,r)=>{at.multiply(e.orientation,t.orientation,r),e.changed.dispatch()},subtract:(e,t,r)=>{at.multiply(e.orientation,t.orientation,at.invert(CR,r)),e.changed.dispatch()}})}},Wg=class extends z{constructor(e){super();this.coordinateSpace=e;this.changed=new re;this.curCoordinateSpace=ti;this.value_={factors:new Float64Array(0)};this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=ti,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:r}=this,{factors:i}=r,{names:a,rank:o}=this.curCoordinateSpace;for(let l=0;l<o;++l){let c=i[l];c!==1&&(e[a[l]]=c,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:r,rank:i}=t,a=new Float64Array(i);if(a.fill(-1),e!==void 0){let o=Z(e);for(let l=0;l<i;++l)a[l]=$(o,r[l],c=>c===void 0?1:Lt(c))}this.value_={factors:a},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:r}=this;if(r===e)return t;let{ids:i}=r,{ids:a,rank:o}=e,l=t.factors,c=new Float64Array(o);c.fill(1);for(let d=0;d<o;++d){let p=a[d],m=i.indexOf(p);m!==-1&&(c[d]=l[m])}return Ee(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}};function kR(n,e,t,r,i){if(t===r)return e;let{ids:a}=t,{rank:o,ids:l}=r,c=new n(o);for(let d=0;d<o;++d){let p=l[d],m=a.indexOf(p);c[d]=m===-1?i(d):e[m]}return c}var DC=class extends su{constructor(){super(...arguments);this.value=Rp(new Wg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:r}=e.value,i=e.coordinateSpace.value,a=t.value.factors;return{coordinateSpace:i,offsets:zh(new Float64Array(r.length),r,a)}},add:(e,t,r)=>{let i=kR(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Mc(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,r)=>{let i=kR(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(zh(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}};function LR(n,e,t){let{rank:r,names:i,units:a}=n,{displayRank:o,displayDimensionIndices:l}=e,c=new Float64Array(3),d=new Float64Array(3),p,{factors:m}=t,y=new Array(3),v=new Float64Array(3);if(c.fill(1),d.fill(1),v.fill(1),y.fill(""),o===0)p=1;else{p=Number.POSITIVE_INFINITY;let{scales:b}=n;for(let x=0;x<o;++x){let C=l[x],k=d[x]=m[C]*b[C];p=Math.min(p,k),y[x]=a[C],v[x]=b[C]}for(let x=0;x<o;++x)c[x]=d[x]/p}return{globalRank:r,globalDimensionNames:i,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:y,displayDimensionScales:v,canonicalVoxelFactors:c,voxelPhysicalScales:d,canonicalVoxelPhysicalSize:p}}function H5(n,e){return Ee(n.globalDimensionNames,e.globalDimensionNames)&&Ee(n.displayDimensionIndices,e.displayDimensionIndices)&&Ee(n.canonicalVoxelFactors,e.canonicalVoxelFactors)&&Ee(n.voxelPhysicalScales,e.voxelPhysicalScales)&&n.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&Ee(n.displayDimensionUnits,e.displayDimensionUnits)&&Ee(n.displayDimensionScales,e.displayDimensionScales)}var Vp=class extends z{constructor(e,t){super();this.relativeDisplayScales=e;this.displayDimensions=t;this.changed=new re;this.curRelativeDisplayScales=this.relativeDisplayScales.value;this.curDisplayDimensions=this.displayDimensions.value;this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value;this.value_=LR(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales);this.registerDisposer(e),this.registerDisposer(t);let r=()=>{this.value};this.registerDisposer(e.changed.add(r)),this.registerDisposer(t.changed.add(r))}get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:r},curRelativeDisplayScales:i,curDisplayDimensions:a,curCoordinateSpace:o}=this,l=this.value_;if(i!==e||a!==r||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=r,this.curCoordinateSpace=t;let c=LR(t,r,e);H5(l,c)||(this.value_=l=c,this.changed.dispatch())}return l}},zg=class extends z{constructor(e){super();this.coordinateSpace=e;this.changed=new re;this.default_=!0;this.value_=void 0;this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}let r=new Int32Array(3),{ids:i}=t.coordinateSpace,{ids:a}=e,o=t.displayDimensionIndices,l=t.displayRank,c=0;for(let d=0;d<l;++d){let p=a.indexOf(i[o[d]]);p!==-1&&(r[c]=p,++c)}if(r.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,r),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let i=0;i<t;++i)r[i]=i;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}let t=Fd(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:r}}=this,i=new Int32Array(3);i.fill(-1);let{names:a}=r,o=0;for(let l of t){let c=a.indexOf(l);c!==-1&&(i[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(r,o,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:r,displayDimensionIndices:i,coordinateSpace:{names:a}}=e;if(r!==0){for(let o=0;o<r;++o)t[o]=a[i[o]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:r}=e.value;this.setDimensionIndices(t,r)}}},PC=class extends EC{constructor(e){super(e);this.value=wR(new zg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}},Ra=class extends z{constructor(e,t,r){super();this.position=e;this.displayDimensionRenderInfo=t;this.orientation=r;this.changed=new re;this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(r.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=Gg){let{coordinateSpace:{value:r},value:i}=this.position,{displayDimensionIndices:a,displayRank:o}=this.displayDimensions.value;if(r===void 0)return!1;t.fill(0);for(let l=0;l<o;++l){let c=a[l];t[l]=i[c]}if(e(t)!==!1){for(let l=0;l<o;++l){let c=a[l];i[c]=t[l]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){ie.fromQuat(e,this.orientation.orientation);let{value:r}=this.position,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){let l=a[o],c=t/i[o];e[o]*=c,e[4+o]*=c,e[8+o]*=c,e[12+o]=r[l]||0}}toMat3(e,t){Ft.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:r,displayRank:i}=this.displayDimensionRenderInfo.value;for(let a=0;a<i;++a){let o=t/r[a];e[a]*=o,e[3+a]*=o,e[6+a]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:r}=this,{value:i}=r,{bounds:{lowerBounds:a,upperBounds:o}}=r.coordinateSpace.value,l=i[e]+t;if(t>0){let c=o[e];Number.isFinite(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{let c=a[e];Number.isFinite(c)&&(l=Math.max(l,Math.floor(c)))}i[e]=l,r.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;let r=K.transformQuat(Gg,e,this.orientation.orientation),{position:i}=this,{value:a}=i,{displayDimensionIndices:o,displayRank:l}=this.displayDimensions.value,{bounds:{lowerBounds:c,upperBounds:d}}=i.coordinateSpace.value;for(let p=0;p<l;++p){let m=o[p],y=r[p];if(y===0)continue;let v=a[m]+y;if(y>0){let b=d[m];Number.isFinite(b)&&(v=Math.min(v,Math.ceil(b-1)))}else{let b=c[m];Number.isFinite(b)&&(v=Math.max(v,Math.floor(b)))}t&&(v=Math.floor(v)+.5),a[m]=v}this.position.changed.dispatch()}rotateRelative(e,t){var r=at.create();at.setAxisAngle(r,e,t);var i=this.orientation.orientation;at.multiply(i,i,r),this.orientation.changed.dispatch()}rotateAbsolute(e,t,r){let{coordinateSpace:{value:i},value:a}=this.position;if(i===void 0)return;let{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:l,displayRank:c}}}=this,{scales:d}=i,p=at.create();at.setAxisAngle(p,e,t);let m=this.orientation.orientation,y=Gg;Gg.fill(0);for(let b=0;b<c;++b){let x=l[b],C=r[x]-a[x];y[b]=C*d[x]*o[x]}let v=at.invert(CR,m);K.transformQuat(y,y,v),at.multiply(m,p,m),K.transformQuat(y,y,m);for(let b=0;b<c;++b){let x=l[b];a[x]=r[x]-y[b]/(d[x]*o[x])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:r}=this.displayDimensions.value,{position:i}=this,a=i.coordinateSpace.value.rank;for(let o=0;o<a;++o)if(r.indexOf(o)===-1&&e--==0){this.translateDimensionRelative(o,t);return}}},cu=class extends su{constructor(e,t){super(e);this.value=(()=>{let r=new e.constructor(t),i=(d,p)=>{d.assign(p)},a=(d,p)=>d.value/p.value*(d.canonicalVoxelPhysicalSize/p.canonicalVoxelPhysicalSize),o=(d,p,m)=>{d.setPhysicalScale(p.value*m,p.canonicalVoxelPhysicalSize)},l=(d,p,m)=>{d.setPhysicalScale(p.value/m,p.canonicalVoxelPhysicalSize)},c=d=>d.coordinateSpaceValue.valid&&d.canonicalVoxelPhysicalSize!==0;return Rp(r,this.peer,this.link,{assign:i,isValid:c,difference:a,add:o,subtract:l}),r})()}};function Al(n){return{changed:n.changed,toJSON(){return n.toJSON()},restoreState(e){TR(n.link,n.value.legacyJsonView,e)},reset(){n.reset()}}}var IC=class extends z{constructor(e){super();this.displayDimensionRenderInfo=e;this.changed=new re;this.curCanonicalVoxelPhysicalSize=0;this.value_=Number.NaN;this.legacyValue_=Number.NaN;this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:r}}}}=this,{curCanonicalVoxelPhysicalSize:i}=this;if(!(!Number.isNaN(e)&&t===i)){if(!Number.isNaN(e)){i!==0&&(this.value_=e*(i/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!r.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=Lt(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=Lt(t)}}}setPhysicalScale(e,t){let r=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/r)}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}},AC=class extends IC{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}},MC=class extends IC{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:l}=this;return 2*100*Math.tan(Math.PI/8)*1e-9*e/l}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:r}}}=this,{canonicalVoxelFactors:i,displayDimensionIndices:a}=this.displayDimensionRenderInfo.value,o=i.reduce((l,c,d)=>{let p=a[d],m=(r[p]-t[p])*c;return Math.max(l,m)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}},Op=class extends z{constructor(e,t){super();this.defaultValue=e;this.displayDimensionRenderInfo=t;this.changed=new re;this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,r=this.canonicalVoxelPhysicalSize;t!==r&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=r/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:r}=this.displayDimensionRenderInfo.value;e=e*(t/r)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}},Hg=class extends EC{constructor(e,t){super(e);this.value=wR(new Op(e.defaultValue,t),this.peer,this.link,{assign:(r,i)=>r.assign(i),isValid:()=>!0})}},_a=class extends z{constructor(e,t,r){super();this.pose=e;this.zoomFactor=t;this.depthRange=r;this.changed=new re;this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(r),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}};var Ml='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="plusIconTitle"><path d="M20 12L4 12M12 4L12 20"></path></svg>';function $g(n={}){return it({svg:Ml,...n})}var ER='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle"><path d="M18 9l-6-6-6 6"></path><path d="M12 21V4"></path><path stroke-linecap="round" d="M12 3v1"></path></svg>';var $5=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),j5=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]),sn=class extends z{constructor(e,t){super();this.target=e;this.eventMap=t;this.modifierShortcutsAreGlobal=!0;this.allShortcutsAreGlobal=!1;this.allowSpaceKeyOnButtons=!1;this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var r=t.target;let{tagName:i}=r;if(r===this.target)return!1;var a=i==="TEXTAREA"||i==="INPUT"||i==="BUTTON"||i==="SELECT",o=!a&&(r.isContentEditable||r.ownerDocument&&r.ownerDocument.designMode==="on");return!a&&!o||this.allShortcutsAreGlobal||$5.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:i==="INPUT"&&j5.has(r.type)?e!=="enter":i==="INPUT"||i==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){let t=q5(e);this.shouldIgnoreEvent(t,e)||Um(t,e,e,this.eventMap)}};function q5(n){return n.code.toLowerCase()}function Np(n,e=n.value){n.style.minWidth=e.length+1+"ch"}var DR="neuroglancer-coordinate-space-transform-singleton";function PR(n,e){let t;n===Number.NEGATIVE_INFINITY?t="(-\u221E,":t=`[${Math.floor(n)},`;let r;return e===Number.POSITIVE_INFINITY?r="+\u221E)":r=`${Math.floor(e)})`,{lower:t,upper:r}}var IR=Fe.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function AR(){let n=document.createElement("div"),e=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),n.appendChild(e);let t=document.createElement("div"),r=document.createElement("span");r.innerHTML=ER,t.appendChild(r);let i=document.createTextNode("");return t.appendChild(i),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),n.appendChild(t),{cellElement:n,inputElement:e,suggestionElement:t}}function MR(n,e,t,r,i){if(e===void 0||e.scale===t&&e.unit===r)n.style.display="none";else{n.style.display="";let a=Bi(e.scale,e.unit,{elide1:!1});n.lastChild.textContent=a,n.title=`${i}${a}`}}function RR(){let n=document.createElement("input");return n.spellcheck=!1,n.autocomplete="off",n.size=1,n.placeholder=" ",n.classList.add("neuroglancer-coordinate-space-transform-output-name"),n}function _R(n,e,t){let r=n.map(y=>Xo(y.value));if(r.includes(void 0))return!1;let i=Float64Array.from(r,y=>y.scale),a=Array.from(r,y=>y.unit),o=t.value,{scales:l,units:c,rank:d}=o;for(let y=0;y<d;++y)e[y]||(i[y]=l[y],a[y]=c[y]);if(Ee(l,i)&&Ee(c,a))return!1;let p=o.timestamps.map((y,v)=>i[v]===l[v]&&a[v]===c[v]?y:Date.now()),m=He({valid:o.valid,rank:o.rank,scales:i,units:a,timestamps:p,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=m,!0}function VR(n,e,t,r){let i=new Float64Array(n.scales),a=Array.from(n.units);if(i[e]===t&&a[e]===r)return n;let o=Array.from(n.timestamps);return i[e]=t,a[e]=r,o[e]=Date.now(),{...n,scales:i,units:a,timestamps:o}}var RC=class extends z{constructor(e,t,r){super();this.transform=e;this.localCombiner=t;this.globalCombiner=r;this.element=document.createElement("div");this.coefficientContainer=document.createElement("div");this.translationContainer=document.createElement("div");this.outputNameContainer=document.createElement("div");this.outputScaleContainer=document.createElement("div");this.inputNameContainer=document.createElement("div");this.inputScaleContainer=document.createElement("div");this.inputLowerBoundsContainer=document.createElement("div");this.inputUpperBoundsContainer=document.createElement("div");this.coefficientElements=[];this.inputNameElements=[];this.outputNameElements=[];this.outputScaleElements=[];this.outputScaleSuggestionElements=[];this.inputScaleSuggestionElements=[];this.inputScaleElements=[];this.inputBoundsElements=[];this.outputBoundsElements=[];this.addSourceDimensionIcon=it({svg:Ml,text:"S"});this.addOutputDimensionIcon=it({svg:Ml,text:"V"});this.addOutputDimensionCell=document.createElement("div");this.addOutputDimensionInput=RR();this.inputScaleModified=[];this.outputScaleModified=[];this.curSourceRank=-1;this.curRank=-1;this.curTransform=void 0;this.addingSourceDimension=!1;this.resetToIdentityButton=it({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=sr(Float64Array,t+1)}});this.resetToDefaultButton=it({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:r}=t,i=r.ids.map(()=>tl());e.value={...t,outputSpace:{...r,ids:i}}}});let{element:i}=this,a=this.registerDisposer(new sn(i,IR));a.allShortcutsAreGlobal=!0,i.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new On(i,IR));let o=Ye(()=>this.updateView());this.registerDisposer(e.changed.add(o));let{coefficientContainer:l,translationContainer:c,outputNameContainer:d,inputNameContainer:p,inputScaleContainer:m,inputLowerBoundsContainer:y,inputUpperBoundsContainer:v,outputScaleContainer:b,addOutputDimensionCell:x,addOutputDimensionIcon:C,addSourceDimensionIcon:k,resetToIdentityButton:M,resetToDefaultButton:I}=this;l.style.display="contents",c.style.display="contents",d.style.display="contents",p.style.display="contents",m.style.display="contents",b.style.display="contents",y.style.display="contents",v.style.display="contents";let A=document.createElement("div");A.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),M.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),I.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),A.appendChild(M),A.appendChild(I),i.appendChild(A);for(let[U,_]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){let B=document.createElement("div");B.classList.add(`neuroglancer-coordinate-space-transform-${U}-label`),B.classList.add("neuroglancer-coordinate-space-transform-label"),B.textContent=_,i.appendChild(B)}e.mutableSourceRank&&x.appendChild(k),x.appendChild(C),x.classList.add("neuroglancer-coordinate-space-transform-output-extend");let D="Embed in additional output dimension",E="Extend to additional source dimension";C.title=D,k.title=E,x.appendChild(this.addOutputDimensionInput),x.dataset.isActive="false",C.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=D,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),k.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=E,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),i.appendChild(l),i.appendChild(d),i.appendChild(p),i.appendChild(m),i.appendChild(b),i.appendChild(y),i.appendChild(v),l.appendChild(c),i.addEventListener("input",U=>{let{target:_}=U;if(_ instanceof HTMLInputElement){Np(_);let B=this.inputScaleElements.indexOf(_);if(B!==-1){this.inputScaleModified[B]=!0,this.updateScaleValidity(_);return}if(B=this.outputScaleElements.indexOf(_),B!==-1){this.outputScaleModified[B]=!0,this.updateScaleValidity(_);return}if(B=this.outputNameElements.indexOf(_),B!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(_)){this.updateCoefficientValidity(_);return}}});let V=(U,_,B)=>{ue(i,U,R=>{R.stopPropagation();let X=R.target;if(!(X instanceof HTMLInputElement)||B!==0&&(X.selectionStart!==X.selectionEnd||X.selectionStart!==(B===1?X.value.length:0)))return;let j=this.getElementGridPosition(X);if(j===void 0)return;let oe=this.getElementByGridPosition(j.row+_,j.col+B);oe!==null&&(oe.focus(),R.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);let N=(U,_)=>{U.addEventListener("focusout",B=>{let{relatedTarget:R}=B;R instanceof Node&&U.contains(R)||_(B)})};N(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),N(d,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),N(m,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),N(b,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ue(i,"cancel",U=>{this.curTransform=void 0,this.updateView(),U.target.blur()}),ue(l,"commit",()=>{this.updateModelTransform()}),ue(d,"commit",()=>{this.updateModelOutputNames()}),ue(m,"commit",()=>{this.updateModelInputScales()}),ue(b,"commit",()=>{this.updateModelOutputScales()}),i.addEventListener("focusin",U=>{let{target:_}=U;_ instanceof HTMLInputElement&&_.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));let{coefficientElements:r,inputBoundsElements:i,inputScaleElements:a}=this;for(let o=0;o<t;++o){let l=e[o];for(let p=0;p<=t;++p){let m=r[t*p+o],y=p<t&&e[p];m.dataset.willBeDeleted=(l||y).toString()}a[o].dataset.willBeDeleted=l.toString();let{lower:c,upper:d}=i[o];c.dataset.willBeDeleted=l.toString(),d.dataset.willBeDeleted=l.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(c=>c.value),{value:{sourceRank:r,rank:i},mutableSourceRank:a}=this.transform;if(e.length!==i+1)return;let o=Ud(t),l=new Array(i);l.fill(!1);for(let c=0;c<=i;++c){let d=o[c];t[c].length===0&&(a||c>=r)&&(d=!0,l[c]=!0),e[c].dataset.isValid=d.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=Xo(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:r}=this.transform.value;if(t!==-1)return{row:t%r,col:Math.floor(t/r)}}{let t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:r}=this.transform.value;return e===-1?t<0||t>=r?null:this.inputScaleElements[t]:t===-2?e<0||e>r?null:this.outputNameElements[e]:t===-1?e<0||e>=r?null:this.outputScaleElements[e]:e<0||e>=r||t<0||t>r?null:this.coefficientElements[t*r+e]}dimensionRefCount(e){return(Qo(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return _R(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return _R(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(M=>M.value),{value:t,mutableSourceRank:r}=this.transform,{outputSpace:i,rank:a,sourceRank:o}=t;if(e.length!==a+1)return;let l=[],c=[],d=e[a].length!==0,p=o;for(let M=0;M<=a;++M){let I=e[M];if(I.length===0){if(M<o){if(!r)return!1;--p}continue}c.push(I),l.push(M)}if(!Oc(c))return!1;let m=i.names;if(!d&&Ee(m,c))return!0;let y=t.inputSpace,v=t.outputSpace,b=t.transform;if(d){this.addingSourceDimension&&++p;let M=e[a],I=(Qo(M)?this.localCombiner:this.globalCombiner).combined.value,A=I.names.indexOf(M),D,E;A!==-1?(D=I.units[A],E=I.scales[A]):(D="",E=1);let V=y.boundingBoxes.map(N=>ub(N,a,a+1));this.addingSourceDimension||V.push(cb(a+1,a)),y=He({valid:y.valid,rank:a+1,names:[...y.names,""],ids:[...y.ids,tl()],timestamps:[...y.timestamps,Date.now()],scales:Float64Array.from([...y.scales,E]),units:[...y.units,D],boundingBoxes:V,coordinateArrays:[...y.coordinateArrays,void 0]}),v=He({valid:i.valid,rank:a+1,names:[...i.names,M],ids:[...i.ids,tl()],timestamps:[...i.timestamps,Date.now()],scales:Float64Array.from([...i.scales,E]),units:[...i.units,D],coordinateArrays:[...i.coordinateArrays,void 0]}),b=Nd(new Float64Array((a+2)**2),a+1,b,a)}b=Xh(Float64Array,b,y.rank,l,l),y=Qh(y,l),v=Qh(v,l);let x=v.ids.map((M,I)=>{let A=l[I];if(A===a)return M;let D=c[I],E=m[A];return D===E||this.dimensionRefCount(E)===1&&this.dimensionRefCount(D)===(m.includes(D)?1:0)?M:tl()}),C=v.timestamps.map((M,I)=>{let A=l[I];return A===a||c[I]===m[A]?M:Date.now()});v={...v,names:c,ids:x,timestamps:C};let k={rank:v.rank,sourceRank:p,outputSpace:v,inputSpace:y,transform:b};return this.transform.value=k,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,r=new Float64Array((t+1)**2);r[r.length-1]=1;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=e[a*t+i],l=parseFloat(o.value);if(!Number.isFinite(l))return!1;r[a*(t+1)+i]=l}return this.transform.transform=r,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:r}=this,{names:i}=e;for(let a=0;a<t;++a){let o=r[a];o.value=i[a],o.dataset.isValid="true",Np(o)}r[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:r}=this;for(let i=0;i<t;++i)for(let a=0;a<=t;++a){let o=r[a*t+i];o.value=e[a*(t+1)+i].toString(),o.dataset.isValid="true",Np(o)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,r=e.sourceRank;if(this.curSourceRank===r&&this.curRank===t)return;let{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o}=this,{element:l,coefficientElements:c,outputNameElements:d,outputScaleElements:p,outputScaleSuggestionElements:m,inputScaleSuggestionElements:y,outputBoundsElements:v,coefficientContainer:b,translationContainer:x,outputNameContainer:C,inputNameContainer:k,inputScaleContainer:M,inputLowerBoundsContainer:I,inputUpperBoundsContainer:A,outputScaleContainer:D}=this;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,We(b),We(x),b.appendChild(x),We(C),We(k),We(M),We(I),We(A),We(D),a.length=0,o.length=0,i.length=0,p.length=0,m.length=0,y.length=0,c.length=0,d.length=0,v.length=0;for(let E=0;E<t;++E){let V=N=>{N.classList.add("neuroglancer-coordinate-space-transform-input"),E>=r&&N.classList.add(DR)};{let N=document.createElement("div");N.classList.add("neuroglancer-coordinate-space-transform-input-name"),V(N),N.style.gridRowStart="sourceNames",N.style.gridColumnStart=`sourceDim ${E+1}`,k.appendChild(N),a.push(N)}{let{cellElement:N,inputElement:U,suggestionElement:_}=AR();N.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),V(N),N.style.gridRowStart="sourceScales",N.style.gridColumnStart=`sourceDim ${E+1}`,M.appendChild(N),o.push(U),y.push(_);let B=E;_.addEventListener("click",()=>{let R=yb(this.transform,B);R!==void 0&&(this.transform.inputSpace.value=VR(this.transform.inputSpace.value,B,R.scale,R.unit))})}{let N=document.createElement("div");V(N),N.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),N.style.gridRowStart="sourceLower",N.style.gridColumnStart=`sourceDim ${E+1}`,I.appendChild(N);let U=document.createElement("div");V(U),U.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),U.style.gridRowStart="sourceUpper",U.style.gridColumnStart=`sourceDim ${E+1}`,A.appendChild(U),i.push({lower:N,upper:U})}}for(let E=0;E<t;++E){for(let V=0;V<=t;++V){let N=document.createElement("input");N.classList.add("neuroglancer-coordinate-space-transform-coeff"),N.spellcheck=!1,N.autocomplete="off",N.size=1,N.style.gridRowStart=`outputDim ${E+1}`,N.placeholder=" ",N.style.gridColumnStart=`sourceDim ${V+1}`,c[V*t+E]=N,V===t?N.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):V==r&&N.classList.add(DR),(V===t?x:b).appendChild(N)}{let{cellElement:V,suggestionElement:N,inputElement:U}=AR();V.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputScales";let _=E;N.addEventListener("click",()=>{let{value:B}=this.transform,R=gb(B,_);R!==void 0&&(this.transform.outputSpace.value=VR(B.outputSpace,_,R.scale,R.unit))}),m.push(N),D.appendChild(V),p.push(U)}{let V=document.createElement("div");V.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),V.style.gridRowStart=`outputDim ${E+1}`,V.style.gridColumnStart="outputNames";let N=RR();N.title="Rebind to a different dimension",E>=r?N.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(N.title+=", or delete to remove source dimension"),N.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",d.push(N),C.appendChild(V),V.appendChild(N);let U=document.createElement("div");U.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(U);let _=document.createElement("div");_.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),V.appendChild(_),v.push({lower:U,upper:_}),V.addEventListener("mousedown",B=>{B.target!==N&&(N.focus(),B.preventDefault())})}}d.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",C.appendChild(this.addOutputDimensionCell),this.curSourceRank=r,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:r}=this.transform.value,{inputBoundsElements:i,inputNameElements:a,inputScaleElements:o,inputScaleSuggestionElements:l}=this,{names:c,scales:d,units:p,bounds:{lowerBounds:m,upperBounds:y}}=e;for(let v=0;v<t;++v){let b=o[v],x=d[v],C=p[v];b.value=Bi(x,C,{elide1:!1}),b.dataset.isValid="true",Np(b);let k;if(v<r){let D=c[v];D||(D=`${v}`),a[v].textContent=D,k=`source dimension ${D}`,b.title=`Override scale of ${k}`}else k="singleton dimension",b.title=`Set extent of ${k}`;let{lower:M,upper:I}=PR(m[v],y[v]),A=i[v];A.lower.textContent=M,A.lower.title=`Lower bound of ${k}`,A.upper.title=`Upper bound of ${k}`,A.upper.textContent=I,MR(l[v],yb(this.transform,v),x,C,`Revert scale of ${k} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:r,units:i,scales:a,bounds:{lowerBounds:o,upperBounds:l}}=e.outputSpace,{outputScaleElements:c,outputBoundsElements:d,outputScaleSuggestionElements:p}=this;for(let m=0;m<t;++m){let y=c[m],v=a[m],b=i[m];y.value=Bi(v,b,{elide1:!1}),Np(y);let x=r[m];y.dataset.isValid="true";let C=`Change coordinates of ${Qo(x)?"local":"global"} dimension ${x}`;y.title=`${C} (does not rescale the source)`;let{lower:k,upper:M}=PR(o[m],l[m]),I=d[m];I.lower.textContent=k,I.upper.textContent=M,MR(p[m],gb(e,m),v,b,`${C} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:r,mutableSourceRank:i,defaultTransform:a}}=this,{rank:o}=r;this.resetToIdentityButton.style.visibility=e||!lD(r.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!i&&(e||t||!fD(a,r))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){ut(this.element),super.disposed()}};var VC=rt(Ct());function OR(n,e,{horizontal:t=!1,vertical:r=!0,topMargin:i=6,bottomMargin:a=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:d=!0}={}){let p=e.getBoundingClientRect();if(t){let m=n.ownerDocument.documentElement.clientWidth,y=p.right,v=m-p.left;y>v?(n.style.left="",n.style.right=`${m-p.right}px`,d&&(n.style.maxWidth=y-o+"px")):(n.style.right="",n.style.left=`${p.left}px`,d&&(n.style.maxWidth=v-l+"px"))}if(r){let m=n.ownerDocument.documentElement.clientHeight,y=p.top-i,v=m-p.bottom-a;n.style.left=`${p.left}px`,n.style.width=`${p.width}px`,y>v*3?(n.style.top="",n.style.bottom=`${m-p.top}px`,c&&(n.style.maxHeight=y+"px")):(n.style.top=`${p.bottom}px`,n.style.bottom="",c&&(n.style.maxHeight=v+"px"))}}function NR(n){let e=n[Symbol.iterator](),{value:t,done:r}=e.next();if(r)return"";let i=t.length;for(;i>0;){let{value:a,done:o}=e.next();if(o)break;let l=0;for(;l<i&&t.charCodeAt(l)===a.charCodeAt(l);++l);i=l}return t.substring(0,i)}var BR=10,jg=.5,UR=class{constructor(){this.anchorIndex=0;this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,r=0;for(let i of e){if(r+=i.retainCount,t<r)break;let{deleteCount:a}=i;if(t<r+a){t=r;break}let{insertCount:o}=i;t=t-a+o,r+=o-o}this.anchorIndex=t}},_C=class{constructor(){this.startIndex=0;this.endIndex=0;this.anchorIndex=0;this.anchorOffset=0;this.scrollOffset=0}},FR=class{constructor(){this.itemSize=[];this.totalKnownSize=0;this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!=null?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,r=0){for(;t<e;++t)r+=this.getEstimatedSize(t);for(;t>e;--t)r-=this.getEstimatedSize(t-1);return r}getRangeSize(e,t){var o;let r=0,{itemSize:i,averageSize:a}=this;for(let l=e;l<t;++l)r+=(o=i[l])!=null?o:a;return r}splice(e){let{itemSize:t}=this;t=this.itemSize=pE(t,e),this.totalKnownSize=t.reduce((r,i)=>r+i,0),this.numItemsInTotalKnownSize=t.reduce(r=>r+1,0)}};function J5(n,e,t,r,i,a){let{anchorIndex:o,anchorClientOffset:l}=a,c=i.getEstimatedOffset(o),d,p,m,y,v;if(r===0||i.totalKnownSize===0)d=Math.max(0,o-BR/2),p=Math.min(t,d+BR),v=o,m=0,y=l;else{let b=i.getEstimatedTotalSize(),x=Math.max(0,b-r);y=c-l,y=Math.max(0,Math.min(x,y));let C=y-2*jg*r,k=y-jg*r,M=y+r+jg*r,I=c-l+r+2*jg*r;d=Math.min(t,e.startIndex);let A=i.getEstimatedOffset(d,o,c);if(A<C)for(;d+1<t;++d){let E=i.getEstimatedSize(d);if(A+E>=k)break;A+=E}if(A>=k)for(;A>C&&d>0;--d)A-=i.getEstimatedSize(d-1);p=Math.min(t,e.endIndex);let D=i.getEstimatedOffset(p,o,c);if(D<M)for(;D<=I&&p+1<=t;++p)D+=i.getEstimatedSize(p);else if(D>=I)for(;p>d;--p){let E=i.getEstimatedSize(p-1);if(D-E<M)break;D-=E}for(v=o,m=c;v<d;++v)m+=i.getEstimatedSize(v);for(;v>p;--v)m-=i.getEstimatedSize(v-1)}n.startIndex=d,n.endIndex=p,n.anchorIndex=v,n.anchorOffset=m,n.scrollOffset=y}function Y5(n,e){let t=e.getEstimatedOffset(n.anchorIndex),r=n.anchorOffset;n.anchorOffset=t,n.scrollOffset+=t-r}function K5(n,e){return n.startIndex<e.startIndex||n.endIndex>e.endIndex}var Rl=class extends z{constructor(e){super();this.element=document.createElement("div");this.scrollContent=document.createElement("div");this.header=document.createElement("div");this.body=document.createElement("div");this.topItems=document.createElement("div");this.bottomItems=document.createElement("div");this.renderedItems=[];this.renderGeneration=-1;this.listGeneration=-1;this.newRenderedItems=[];this.state=new UR;this.renderParams=new _C;this.newRenderParams=new _C;this.sizes=new FR;this.debouncedUpdateView=this.registerCancellable(Ye(()=>this.updateView()));this.resizeObserver=new ResizeObserver(()=>this.updateView());let{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let r=this.source=e.source;this.sizes.itemSize.length=r.length;let{element:i,header:a,body:o,scrollContent:l,topItems:c,bottomItems:d}=this;this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.disconnect()),i.appendChild(l),i.style.overflowAnchor="none",l.appendChild(a),l.appendChild(o),a.style.position="sticky",a.style.zIndex="1",a.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",a.style.width="min-content",a.style.minWidth="100%",d.style.width="min-content",d.style.minWidth="100%"):(l.style.width="100%",a.style.width="100%",d.style.width="100%"),o.appendChild(c),o.appendChild(d),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",d.style.height="0",d.style.position="relative",i.addEventListener("scroll",()=>{let p=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-p,this.renderParams.scrollOffset=p,this.debouncedUpdateView()}),r.changed!==void 0&&this.registerDisposer(r.changed.add(p=>{this.sizes.splice(p),this.state.splice(p),this.renderedItems.length=0,this.debouncedUpdateView()})),r.renderChanged!==void 0&&this.registerDisposer(r.renderChanged.add(this.debouncedUpdateView))}updateView(){let{element:e}=this;if(e.offsetHeight===0)return;let t=e.clientHeight-this.header.offsetHeight,{source:r,state:i,sizes:a}=this,o=r.length,{body:l,topItems:c,bottomItems:d}=this,{changed:p,renderChanged:m}=r,y;for(;;){y=this.newRenderParams;let x=this.renderParams;J5(y,x,o,t,a,i);let C;if(m!==void 0&&m.count!==this.renderGeneration||p!==void 0&&p.count!==this.listGeneration?(this.renderGeneration=m===void 0?-1:m.count,this.listGeneration=p===void 0?-1:p.count,C=!0,this.renderedItems.length=0):C=!1,!C&&!K5(y,x)){x.scrollOffset=y.scrollOffset,y=x;break}this.renderParams=y,this.newRenderParams=x;let k=this.renderedItems,M=this.newRenderedItems;M.length=0,this.renderedItems=M,this.newRenderedItems=k;let{source:I}=this,{render:A}=I,{startIndex:D,endIndex:E,anchorIndex:V}=y;function*N(U,_){for(let B=U;B<_;++B){let R=k[B];R===void 0&&(R=A.call(I,B)),M[B]=R,yield R}}Yn(c,N(D,V)),Yn(d,N(V,E));for(let U=D;U<E;++U){let R=M[U].getBoundingClientRect().height,X=a.itemSize[U];X!==void 0&&(a.totalKnownSize-=X,--a.numItemsInTotalKnownSize),a.itemSize[U]=R,a.totalKnownSize+=R,++a.numItemsInTotalKnownSize}}Y5(y,a),i.anchorIndex=y.anchorIndex,i.anchorClientOffset=y.anchorOffset-y.scrollOffset;let v=a.getRangeSize(y.startIndex,y.anchorIndex),b=a.getEstimatedTotalSize();l.style.height=`${b}px`,c.style.top=`${y.anchorOffset-v}px`,d.style.top=`${y.anchorOffset}px`,e.scrollTop=y.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:r}=this.renderParams,{renderedItems:i}=this;for(let a=t;a<r;++a){let o=i[a];o!==void 0&&e(o,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),r=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>i&&r>i+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){ut(this.element)}};var OC="neuroglancer-multiline-autocomplete-completion-active",X5=!1;function Q5(n){let e=document.createElement("div");return e.textContent=n.value,e}function*GR(n){for(;n.length>0;){let e=n.match(/[:/_]+/);if(e===null){yield n;return}let t=e.index+e[0].length;yield n.substring(0,t),n=n.substring(t)}}function WR(n){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=n.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=n.description||"",e.appendChild(t),e}var Z5=Fe.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),eJ=200,NC=class extends z{constructor(e){super();this.element=document.createElement("div");this.inputElement=document.createElement("span");this.hintElement=document.createElement("span");this.completionsVirtualList=void 0;this.onCommit=new qe;this.onInput=new qe;this.prevInputValue="";this.completionsVisible=!1;this.activeCompletionPromise=null;this.activeCompletionCancellationToken=void 0;this.hasFocus=!1;this.completionResult=null;this.dropdownContentsStale=!0;this.hasResultForDropdown=!1;this.commonPrefix="";this.completionDisabled=-1;this.activeIndex=-1;this.dropdownStyleStale=!0;this.resizeHandler=()=>{!this.completionsVisible||this.updateDropdownStyle()};this.resizeObserver=new ResizeObserver(this.resizeHandler);this.debouncedUpdateHintState=this.registerCancellable((0,VC.default)(()=>this.updateHintState(),0));this.completer=e.completer;let{delay:t=eJ}=e,r=this.scheduleUpdateCompletions=(0,VC.default)(()=>{let c=this.activeCompletionCancellationToken=new ao,d=this.activeCompletionPromise=this.completer(this.value,c);d!==null&&d.then(p=>{this.activeCompletionPromise===d&&(this.setCompletions(p),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{r.cancel()});let{element:i,inputElement:a,hintElement:o}=this;i.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,i.appendChild(document.createTextNode("\u200B")),i.appendChild(a),i.appendChild(o),a.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",c=>{let{clipboardData:d}=c;if(d!==null){let p=window.getSelection();p!==null&&!p.isCollapsed&&p.containsNode(a,!0)&&d.setData("text/plain",p.toString())}c.preventDefault(),c.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let c=this.getSelectionRange(),{completionDisabled:d}=this;c!==void 0&&c.begin===d&&c.end===d||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),i.addEventListener("pointerdown",c=>{let{target:d}=c;if(d instanceof Node){if(a.contains(d))return;let{completionsVirtualList:p}=this;if(p!==void 0&&p.element.contains(d))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),c.stopPropagation(),c.preventDefault())}),i.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let c=document.createRange(),{childNodes:d}=a;c.setStart(a,0),d.length===0?c.setEnd(a,0):c.setEndAfter(d[d.length-1]);let p=window.getSelection();p!==null&&(p.removeAllRanges(),p.addRange(c)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{if(this.hasFocus){if(X5)return;this.hasFocus=!1,this.updateDropdown()}this.debouncedUpdateHintState();let c=window.getSelection();c!==null&&c.containsNode(this.inputElement,!0)&&c.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});let l=this.registerDisposer(new sn(a,Z5));l.allShortcutsAreGlobal=!0,ue(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ue(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ue(a,"home",()=>{this.moveCaretToBeginningOfInput()}),ue(a,"end",()=>{this.moveCaretToEndOfInput()}),ue(a,"choose-active-completion-or-prefix",c=>{this.selectActiveCompletion(!0)&&c.preventDefault()}),ue(a,"commit",c=>{if(this.selectActiveCompletion(!1))c.stopPropagation();else{let d=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,d)}}),ue(a,"cancel",c=>{c.stopPropagation(),this.cancel()&&(c.detail.preventDefault(),c.detail.stopPropagation())})}disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(e===null||e.rangeCount===0)return;let t=e.getRangeAt(0),{inputElement:r}=this,i=document.createRange();i.setStart(r,0),i.setEnd(t.startContainer,t.startOffset);let a=i.toString().length,o=e.toString().length;return{begin:a,end:a+o}}setValueAndSelection(e,t=void 0){let r=this.completionDisabled!==-1;this.onInput.dispatch(e);let{inputElement:i}=this;We(i);let a=0,o=t!==void 0?document.createRange():void 0,l=!0;for(let c of GR(e)){l||i.appendChild(document.createElement("wbr")),l=!1;let d=a+c.length,p=document.createTextNode(c);if(i.appendChild(p),o!==void 0){let{begin:m,end:y}=t;m>=a&&m<=d&&o.setStart(p,m-a),y>=a&&y<=d&&o.setEnd(p,y-a)}a=d}if(o!==void 0){l&&(o.setStart(i,0),o.setEnd(i,0));let c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=r&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){let{value:e}=this;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(t===void 0)return;let r=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==r;i=i.parentElement){let a=i.dataset.completionIndex;if(a!==void 0){this.selectCompletion(Number(a));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this,r=this.completionResult.completions.length;t===-1?e>0?t=0:t=r-1:t=(t+e+r)%r,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){let{completionsVirtualList:e,element:t}=this;e!==void 0&&OR(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();let r=this.completionResult,{makeElement:i=Q5}=r;e=this.completionsVirtualList=new Rl({source:{length:r.completions.length,render:a=>{let o=r.completions[a],l=i.call(r,o);return l.classList.add("neuroglancer-multiline-autocomplete-completion"),l.dataset.completionIndex=`${a}`,this.activeIndex===a&&l.classList.add(OC),l}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);let{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(t.length===0)return;let r=this.prevInputValue;if(r!==void 0){if(this.completionResult=e,t.length===1){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(r)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let i=NR(function*(){for(let o of e.completions)yield o.value}()),a=this.getCompletedValue(i);a.startsWith(r)&&(this.commonPrefix=a,this.setHintValue(a))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);let{hintElement:r}=this;We(r);let i=!0;for(let a of GR(e)){i||r.appendChild(document.createElement("wbr")),i=!1;let o=document.createTextNode(a);r.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:r}=this;if(r!==void 0){if(t!==-1){let i=r.getItemElement(t);i!==void 0&&i.classList.remove(OC)}if(e!==-1){let i=r.getItemElement(e);i!==void 0&&i.classList.add(OC),r.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,r=this.prevInputValue;return r===void 0?"":r.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:r}=t,i=r[r.length-1];i===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));let a=window.getSelection();a!==null&&(a.removeAllRanges(),a.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;let{completionResult:i}=this;if(i!==null&&i.completions.length===1)t=0;else{let{commonPrefix:a}=this;return a.length>this.value.length?(this.value=a,this.moveCaretToEndOfInput(),!0):!1}}let r=this.getCompletedValueByIndex(t);return this.value===r?!1:(this.value=r,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;let e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";let{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),ut(this.element),this.cancelActiveCompletion(),super.disposed()}};var wn=class extends z{constructor(e=new Vt(Vt.VISIBLE)){super();this.visibility=e;this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){ut(this.element),super.disposed()}},zR=class extends z{constructor(){super(...arguments);this.changed=new re;this.options=new Map;this.optionsChanged=new re;this.selectedValue=void 0;this.defaultValue=void 0;this.ready_=!0}get value(){let{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){let{options:r}=this;if(r.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);r.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}},HR=class extends z{constructor(e,t,r=new Vt(Vt.VISIBLE),i=!1){super();this.getter=e;this.selected=t;this.visibility=r;this.invalidateByDefault=i;this.element=document.createElement("div");this.tabs=new Map;this.tabVisibilityChanged=new qe;this.debouncedUpdateSelectedTab=this.registerCancellable(Ye(()=>this.updateSelectedTab()));let{element:a}=this;a.className="neuroglancer-stack-view",this.registerDisposer(r.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){let{tabs:t}=this,r=t.get(e);r!==void 0&&(r.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){let t=this.tabs.get(e);t!==void 0&&(t.visibility.value=Vt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,r=t.get(e);r===void 0&&(r=this.getter(e),this.element.appendChild(r.element),t.set(e,r)),r.element.style.display="",r.visibility.value=Vt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){let{tabs:t}=this;for(let[r,i]of t)e!==void 0&&e(r)||(t.delete(r),i.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),ut(this.element),super.disposed()}},BC=class extends zR{};function tJ(n,e){let t="neuroglancer-selected-tab-label";e?n.classList.add(t):n.classList.remove(t)}var UC=class extends z{constructor(e,t=new Vt(Vt.VISIBLE)){super();this.visibility=t;this.element=document.createElement("div");this.tabBar=document.createElement("div");this.tabLabels=new Map;this.tabsGeneration=-1;this.debouncedUpdateView=this.registerCancellable(Ye(()=>this.updateTabs()));this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:r,tabBar:i}=this;r.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",r.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let a=this.stack=this.registerDisposer(new HR(e.makeTab,e.selectedTab,this.visibility));r.appendChild(a.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add(()=>this.updateTabLabelStyles())),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,r]of this.tabLabels)tJ(r,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{let e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:r})=>r===t)!==void 0)}We(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:r}=this;for(let{id:i,label:a}of this.tabs.value){let o=document.createElement("div");o.classList.add("neuroglancer-tab-label"),o.textContent=a,o.addEventListener("click",()=>{this.selectedTab.value=i}),r!==void 0&&r(i,o),t.set(i,o),e.appendChild(o)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){We(this.tabBar),this.tabLabels.clear(),ut(this.element),super.disposed()}};var $R=class extends NC{constructor(e){let{manager:t}=e.source.layer,r=(a,o)=>t.dataSourceProviderRegistry.completeUrl({url:a,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:WR,offset:l.offset,showSingleResult:!0}));super({completer:r,delay:0});this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new Ge(!1);let i=a=>{a!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}},FC=class extends z{constructor(e){super();this.model=e;this.element=document.createElement("ul");this.generation=-1;this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable(Ye(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>ut(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:r}=this;We(r);let i=new Set;for(let a of e){let o=`${a.severity} ${a.message}`;if(i.has(o))continue;i.add(o);let l=document.createElement("li");r.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${Dr[a.severity]}`),l.textContent=a.message}}},jR=class extends z{constructor(e,t){super();this.loadedSubsource=t;this.element=document.createElement("div");let{element:r}=this;r.classList.add("neuroglancer-layer-data-source-subsource");let i=document.createElement("label"),a=document.createElement("span"),o=()=>{i.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));let l=this.registerDisposer(new Lr({get value(){return t.enabled},set value(b){t.enabled=b,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(l.element);let c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");let{id:d}=t.subsourceEntry;d!=="default"&&(c.textContent=d),i.appendChild(c),a.classList.add("neuroglancer-layer-data-sources-source-type");let p=this.registerDisposer(new FC(this.loadedSubsource.messages));r.appendChild(i),i.appendChild(a),r.appendChild(p.element);let m="",{subsource:y}=t.subsourceEntry,{volume:v}=y;if(v instanceof Qt)m=`${G[v.dataType].toLowerCase()} volume`;else if(y.mesh instanceof Mr)m="meshes (single-res.)";else if(y.mesh instanceof yo)m="meshes (multi-res.)";else if(y.mesh instanceof Ki)m="skeletons";else if(y.segmentPropertyMap!==void 0)m="segment property map";else if(y.local!==void 0)switch(y.local){case bi.annotations:m="Local annotations";break;case bi.equivalences:m="local segmentation graph";break}else y.staticAnnotations!==void 0?m="default annotations":y.annotation!==void 0?m="annotations":y.singleMesh!==void 0?m="single mesh":y.segmentationGraph!==void 0&&(m="segmentation graph");a.textContent=m}},qR=class extends z{constructor(e){super();this.source=e;this.element=document.createElement("div");let{element:t}=this,r=document.createElement("label");r.classList.add("neuroglancer-layer-data-sources-source-default"),r.appendChild(this.registerDisposer(new Lr({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(a){if(e.enableDefaultSubsources!==a){if(e.enableDefaultSubsources=a,a)for(let o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),r.appendChild(document.createTextNode("Enable default subsource set")),r.title="Enable the default set of subsources for this data source.",t.appendChild(r);for(let a of e.subsources)t.appendChild(this.registerDisposer(new jR(e,a)).element);let{transform:i}=e;if(i.mutableSourceRank||i.value.sourceRank!==0){let a=this.registerDisposer(new RC(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(a.element)}this.registerDisposer(()=>ut(this.element))}},JR=class extends z{constructor(e,t){super();this.tab=e;this.source=t;this.element=document.createElement("div");this.seenGeneration=0;this.generation=-1;let r=this.urlInput=this.registerDisposer(new $R(this)),i=(o,l)=>{let{source:c}=this,d=c.spec,p=this.source.layer;if(o=p.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==r.value&&(r.disableCompletion(),r.setValueAndSelection(o,{begin:o.length,end:o.length})),r.dirty.value=!1,o&&o===d.url){l&&e.detectedLayerConstructor!==void 0&&YR(c.layer);return}if(p instanceof Zi)try{let m=p.manager.dataSourceProviderRegistry.suggestLayerName(o);qg(p.managedLayer,m)}catch{}c.spec={...d,url:o}};r.onCommit.add(i);let{element:a}=this;a.classList.add("neuroglancer-layer-data-source"),a.appendChild(r.element),a.appendChild(this.registerDisposer(new FC(t.messages)).element),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:r}=this;if(r!==void 0){if(r.source===t)return;r.dispose(),r=this.loadedView=void 0}t instanceof Ug&&(r=this.loadedView=new qR(t),this.element.appendChild(r.element))}disposed(){let{loadedView:e}=this;e!==void 0&&e.dispose(),ut(this.element),super.disposed()}};function YR(n){if(n instanceof Zi){let e=n.detectedLayerConstructor;if(e!==void 0)return Bp(n.managedLayer,e),!0}return!1}var GC=class extends wn{constructor(e){super();this.layer=e;this.generation=-1;this.sourceViews=new Map;this.addDataSourceIcon=$g({title:"Add additional data source"});this.layerTypeDetection=document.createElement("div");this.layerTypeElement=document.createElement("span");this.dataSourcesContainer=document.createElement("div");this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:r}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),r.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:i}=this;if(i.style.alignSelf="start",i.addEventListener("click",()=>{let o=this.layer.addDataSource(void 0);this.updateView();let l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Zi){let{layerTypeDetection:o,layerTypeElement:l}=this;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{YR(e)})}let a=this.reRender=Ye(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(a)),this.registerDisposer(this.visibility.changed.add(a)),this.updateView()}updateLayerTypeDetection(){let e=(()=>{let r=this.layer;if(!(r instanceof Zi))return;let i=r.detectedLayerConstructor;if(i!==void 0){for(let a of this.sourceViews.values())if(a.urlInput.dirty.value)return;return i}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){let{layerTypeElement:r}=this;r.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:r}=this,{layer:i}=this;function*a(){let o=!0,{dataSources:l}=i;for(let c of l){let d=r.get(c);d===void 0&&(d=new JR(this,c),d.registerDisposer(d.urlInput.dirty.changed.add(this.reRender)),r.set(c,d)),d.seenGeneration=t,d.updateView();let p=c.spec.url;l.length===1&&p===""&&setTimeout(()=>{d.urlInput.inputElement.focus()},0),o=c.spec.url.length===0,yield d.element}o||(yield this.addDataSourceIcon)}Yn(this.dataSourcesContainer,a.call(this));for(let[o,l]of r)l.seenGeneration!==t&&(l.dispose(),r.delete(o))}this.updateLayerTypeDetection()}};var Jg="tab",KR="tabs",XR="panels",QR={...wi,row:0},WC={...wi,visible:!0,row:0},uu=class extends z{constructor(e){super();this.panels=e;this.layer=this.panels.layer;this.location=new ur(WC);this.tabsChanged=new qe;this.selectedTab=new Ge(void 0);this.tabs=[]}initialize(){let{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var a;e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:r}=t.manager.root;if(((a=r.layer)==null?void 0:a.layer)!==t||this!==t.panels.panels[0])return;let i=this.location.value;r.location.value!==i&&(r.location.value=i,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)})}normalizeTabs(){let{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,r=o=>{var l;return(l=t.get(o).order)!=null?l:0};e.sort((o,l)=>r(o)-r(l));let{selectedTab:i}=this,a=i.value;(a===void 0||!e.includes(a))&&(i.value=e[0])}pin(){var a;let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(((a=t.layer)==null?void 0:a.layer)!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;let{panels:r}=this,i=e.registerDisposer(new uu(r));r.panels.splice(0,1,i),r.panels.push(this),r.updateTabs(),i.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var l;let{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;let{layer:r}=this,{selectedLayer:i}=r.manager.root,a=(l=i.layer)==null?void 0:l.layer;i.visible&&a!=null&&a!=r&&a.panels.panels[0].pin(),e.panels.splice(t,1);let[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)r.unregisterDisposer(o);else{e.panels.push(o);for(let c=1,d=e.panels.length;c<d;++c){let p=e.panels[c];p.explicitTabs===void 0&&(p.explicitTabs=new Set(p.tabs))}}this.explicitTabs=void 0,e.updateTabs(),i.layer=r.managedLayer,i.location.value=this.location.value,i.location.locationChanged.dispatch(),i.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:r}=this;{let{explicitTabs:o}=this;o!==void 0&&o.delete(e)}let{layer:i}=this,a=i.registerDisposer(new uu(r));a.location.value=t,a.explicitTabs=new Set([e]),r.panels.splice(1,0,a),r.updateTabs(),a.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),r.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:i}=this;i!==void 0&&i.delete(e)}{let{explicitTabs:i}=t;i!==void 0&&i.add(e)}let{panels:r}=this;r.updateTabs(),t.selectedTab.value=e,r.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(t!==void 0)for(let i of this.tabs)t.add(i);let{panels:r}=this;r.removePanel(this)}},zC=class{constructor(e){this.layer=e;this.specificationChanged=new qe;this.updating=!1;this.panels=[e.registerDisposer(new uu(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=pe(e,Jg,ae);let{layer:r}=this,{tabs:i}=r,a=new Set(i.options.keys());pe(e,XR,o=>Te(o,l=>{Z(l);let c=new uu(this);c.location.restoreState(l),!!c.location.visible&&(c.selectedTab.value=pe(l,Jg,ae),c.explicitTabs=pe(l,KR,d=>{let p=new Set;for(let m of vn(d))!a.has(m)||(a.delete(m),p.add(m));return p}),c.explicitTabs===void 0?(c.tabs=Array.from(a),a.clear()):c.tabs=Array.from(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),r.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Array.from(a),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var o;let{layer:e}=this,{tabs:t}=e,r=new Set(t.options.keys()),{panels:i}=this;this.updating=!0;let a=l=>{let c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Array.from(r),r.clear();else{l.tabs=Array.from(l.explicitTabs);for(let d of l.tabs)r.delete(d)}Ee(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<i.length;){let c=i[l];if(c.location.visible&&(a(c),c.tabs.length!==0)){++l;continue}i.splice(l,1),e.unregisterDisposer(c)}if(a(i[0]),i[0].tabs.length===0){let{selectedLayer:l}=this.layer.manager.root;((o=l.layer)==null?void 0:o.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var r;let{panels:e}=this,t={};if(t[Jg]=e[0].selectedTab.value,e.length>1){let i=[];for(let a=1,o=e.length;a<o;++a){let l=e[a],c=(r=l.location.toJSON())!=null?r:{};c[Jg]=l.selectedTab.value;let{explicitTabs:d}=l;d!==void 0&&(c[KR]=Array.from(d)),i.push(c)}t[XR]=i}return t}};var ZR=rt(Ct());var nJ=/^[A-Z]$/,e_=class extends z{constructor(e,t){super();this.tool=e;this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ue(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}},Co=class extends z{constructor(e){super();this.layer=e;this.changed=new qe;this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this,{keyBinding:t}=this;t!==void 0&&e.toolBinder.set(t,void 0)}},Up=class extends z{constructor(e){super();this.layer=e;this.changed=new qe}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}};function t_(n,e){var i;if(e===void 0)return;typeof e=="string"&&(e={type:e}),Z(e);let t=$(e,"type",ae),r=(i=HC.get(n.constructor))==null?void 0:i.get(t);if(r===void 0&&(r=iJ.get(t)),r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}function rJ(n,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),Z(e);let t=$(e,"type",ae),r=n_.get(t);if(r===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return r(n,e)}var n_=new Map,iJ=new Map,HC=new Map;function Fp(n,e){n_.set(n,e)}function _l(n,e,t){let r=HC.get(n);r===void 0&&(r=new Map,HC.set(n,r)),r.set(e,t)}var $C=class extends z{constructor(e){super();this.layer=e;this.changed=new qe}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=rJ(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(e!==void 0)return e.toJSON()}},jC=class extends z{constructor(){super(...arguments);this.bindings=new Map;this.changed=new qe;this.debounceDeactivate=this.registerCancellable((0,ZR.default)(()=>this.deactivate(),1))}get(e){return this.bindings.get(e)}set(e,t){let{bindings:r}=this,i=r.get(e);if(i!==void 0){i.keyBinding=void 0,r.delete(e);let a=i.layer.toolBinder;a.bindings.delete(e),a.jsonToKey.delete(JSON.stringify(i.toJSON())),this.destroyTool(i),a.changed.dispatch()}if(t!==void 0){let a=t.layer.toolBinder,o=JSON.stringify(t.toJSON()),l=a.jsonToKey.get(o);if(l!==void 0){let c=a.bindings.get(l);c.keyBinding=void 0,r.delete(l),a.bindings.delete(l),a.jsonToKey.delete(o),this.destroyTool(c)}a.bindings.set(e,t),t.keyBinding=e,a.jsonToKey.set(o,e),r.set(e,t),a.changed.dispatch()}this.changed.dispatch()}activate(e,t){var o;let r=this.get(e);if(r===void 0){this.deactivate();return}if(this.debounceDeactivate.cancel(),r===((o=this.activeTool)==null?void 0:o.tool))return;let i=new e_(r,t);this.activeTool=i;let a=`Key${e}`;return i.registerEventListener(window,"keyup",l=>{l.code===a&&this.debounceDeactivate()}),i.registerEventListener(window,"blur",()=>{this.debounceDeactivate()}),r.activate(i),r}destroyTool(e){var t;((t=this.activeTool)==null?void 0:t.tool)===e&&this.deactivate(),e.dispose()}disposed(){this.deactivate(),super.disposed()}deactivate(){this.debounceDeactivate.cancel();let e=this.activeTool;e!==void 0&&(this.activeTool=void 0,e.dispose())}},qC=class{constructor(e){this.layer=e;this.bindings=new Map;this.jsonToKey=new Map;this.changed=new qe;e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let r=t_(this.layer,t);r!==void 0&&this.set(e,r)}removeJsonString(e){let t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(e.size===0)return;let t={};for(let[r,i]of e)t[r]=i.toJSON();return t}clear(){let{globalBinder:e,bindings:t}=this;if(t.size!==0){for(let[r,i]of t)i.keyBinding=void 0,e.bindings.delete(r),e.destroyTool(i);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){Z(e);for(let[t,r]of Object.entries(e)){if(!t.match(nJ))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);let i=t_(this.layer,r);if(i===void 0)return;this.set(t,i)}}}},Yg=class extends z{constructor(e,t){super();this.layer=e;this.toolJson=t;this.element=document.createElement("div");this.toolJsonString=JSON.stringify(this.toolJson);let{element:r}=this;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(Ye(()=>this.updateView())))),this.updateView(),r.title="click \u2192 bind key, dbclick \u2192 unbind",r.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),JC(this,r,i=>this.layer.toolBinder.setJson(i,this.toolJson))}updateView(){let{toolBinder:e}=this.layer,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t!=null?t:" "}};function JC(n,e,t){let r;e.addEventListener("mousedown",i=>{if(i.button!==0||r!==void 0)return;i.preventDefault(),i.stopPropagation(),r=new z,n.registerDisposer(r),r.registerDisposer(new Ke(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",o=>{let{code:l}=o,c=l.match(/^Key([A-Z])$/);if(c===null)return;o.stopPropagation(),o.preventDefault();let d=c[1];t(d)},{capture:!0}),r.registerEventListener(window,"mouseup",o=>{o.button!==0||r===void 0||(o.preventDefault(),o.stopPropagation(),n.unregisterDisposer(r),r.dispose(),r=void 0)})}),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation()})}function YC(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(n.registerDisposer(new Yg(e,t.toolJson)).element);let i=document.createElement("div");return i.classList.add("neuroglancer-tool-button-label"),i.textContent=t.label,t.title&&(i.title=t.title),r.appendChild(i),r}function aJ(n){let e=n.registerDisposer(new Ke(!1));e.element.classList.add("neuroglancer-tool-status");let t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);let{inputEventMapBinder:r}=n;return n.inputEventMapBinder=(i,a)=>{let o=document.createElement("div");o.textContent=i.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),r(i,a)},{message:e,content:t}}function Gp(n){let{message:e,content:t}=aJ(n),r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-header-container"),i.appendChild(r),t.appendChild(i);let a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),t.appendChild(a),{message:e,body:a,header:r}}function r_(n,e){n.remove(e)}function i_(n,e){n.add(e)}var o_="tool",s_="toolBindings",KC="localPosition",l_="localDimensions",c_="source",oJ="transform",u_="pick",d_=class{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}},Ei=class extends z{constructor(e){super();this.managedLayer=e;this.pick=new Mt(!0,!0);this.layersChanged=new re;this.readyStateChanged=new re;this.specificationChanged=new re;this.renderLayers=new Array;this.loadingCounter=1;this.tabs=this.registerDisposer(new BC);this.panels=new zC(this);this.tool=this.registerDisposer(new $C(this));this.toolBinder=new qC(this);this.dataSourcesChanged=new re;this.dataSources=[];this.localCoordinateSpaceCombiner.includeDimensionPredicate=fb,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new GC(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=ro,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let r=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:i}=r;if(i!==0){let o=pe(t,KC,l=>Je(new Float32Array(i),l,ct));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=pe(t,"annotationId",ae))!==void 0&&(e.annotationSourceIndex=pe(t,"annotationSource",ft,0),e.annotationPartIndex=pe(t,"annotationPart",ft),e.annotationSubsource=pe(t,"annotationSubsource",ae)),e.value=t.value}displaySelectionState(e,t,r){return!1}selectionStateToJson(e,t){let r={};if(e.localPositionValid){let{localPosition:i}=e;i.length>0&&(r.localPosition=Array.from(i))}return e.annotationId!==void 0&&(r.annotationId=e.annotationId,r.annotationPart=e.annotationPartIndex,r.annotationSource=e.annotationSourceIndex,r.annotationSubsource=e.annotationSubsource),e.value!=null&&(r.value=e.value),r}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let r=this.localPosition.value,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():i.set(r),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let r=t.localPosition,{localPosition:i}=e;i.length!==r.length?e.localPosition=r.slice():e.localPosition.set(r),e.annotationId=t.annotationId,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){let t=new LC(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(let t of this.dataSources){let{loadState:r}=t;if(!(r===void 0||r.error!==void 0))for(let i of r.subsources)if(i.enabled)yield i;else{let{activated:a}=i;i.messages.clearMessages(),a!==void 0&&(a.dispose(),i.activated=void 0,r.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter==0&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter==1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),r=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,r,i){return e===void 0?[]:[Il(e,r)]}getDataSourceSpecifications(e){let t,r=$(e,c_,a=>Array.isArray(a)?a.map(o=>Il(o)):typeof a=="object"?[Il(a)]:(t=a,[])),i=$(e,oJ,SD);return r.push(...this.getLegacyDataSourceSpecifications(t,e,i,r)),r=r.filter(a=>a.url),r.length===0&&r.push(Cm()),r}restoreState(e){this.tool.restoreState(e[o_]),this.toolBinder.restoreState(e[s_]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[l_]),this.localPosition.restoreState(e[KC]),this.constructor.supportsPickOption&&this.pick.restoreState(e[u_]);for(let t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:r}=this,i=t.indexOf(e);if(i===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(r.dispatch),e.userLayer=void 0,e.dispose(),r.dispatch()}disposed(){let{layersChanged:e}=this;Xa(this.dataSources);for(let t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let r,{renderLayers:i}=this,{pickedRenderLayer:a}=t;if(a!==null&&i.indexOf(a)!==-1&&(r=a.transformPickedValue(t),r=this.transformPickedValue(r),r!=null))return r;for(let o of i)if(r=o.getValueAt(e),r!=null)break;return this.transformPickedValue(r)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[c_]:sJ(this.dataSources),[o_]:this.tool.toJSON(),[s_]:this.toolBinder.toJSON(),[l_]:this.localCoordinateSpace.toJSON(),[KC]:this.localPosition.toJSON(),[u_]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:r}=this.manager.root,{localPosition:i}=this;uS(r.value,t,e.globalToRenderLayerDimensions),uS(i.value,t,e.localToRenderLayerDimensions),i.changed.dispatch(),r.changed.dispatch()}};Ei.supportsPickOption=!1;function sJ(n){if(n.length!==0)return n.length===1?n[0].toJSON():n.map(e=>e.toJSON())}var Wp=class extends z{constructor(e,t){super();this.manager=t;this.localCoordinateSpace=new rl;this.localCoordinateSpaceCombiner=new Nc(this.localCoordinateSpace,Qo);this.localPosition=this.registerDisposer(new Qi(this.localCoordinateSpace));this.nonArchivedLayerIndex=-1;this.readyStateChanged=new re;this.layerChanged=new re;this.specificationChanged=new re;this.containers=new Set;this.layer_=null;this.visible=!0;this.archived=!1;this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){let r=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{r.forEach(i=>i())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(let{layerManager:t}of this.manager.root.subsets)!t.has(this)||t.removeManagedLayer(this)}else{for(let{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}},Xg=class extends z{constructor(){super();this.managedLayers=new Array;this.layerSet=new Set;this.layersChanged=new re;this.readyStateChanged=new re;this.specificationChanged=new re;this.boundPositions=new WeakSet;this.numDirectUsers=0;this.nonArchivedLayerIndexGeneration=-1;this.renderLayerToManagedLayerMapGeneration=-1;this.renderLayerToManagedLayerMap_=new Map;this.scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,Kg.default)(()=>this.removeLayersWithSingleRef(),0));this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let r of this.managedLayers)r.archived||(r.nonArchivedLayerIndex=t++);for(let r of this.managedLayers)r.archived&&(r.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let r of this.managedLayers)if(!r.archived){if(t===e)return r;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(let r of this.managedLayers){let i=r.layer;if(i!==null)for(let a of i.renderLayers)t.set(a,r)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(r=>e(r)?!0:(this.unbindManagedLayer(r),this.layerSet.delete(r),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers==1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers==0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,i_),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,r_),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let r=this.managedLayers.length;if(e===t||e<0||e>=r||t<0||t>=r)return;let[i]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,i),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,r=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++r;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(t.layer!==null)for(let r of t.layer.renderLayers)yield r}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let r of t.layer.renderLayers)yield r}}}invokeAction(e){let t=new d_;for(let r of this.managedLayers){if(r.layer===null||!r.visible)continue;let i=r.layer;i.handleAction(e,t);for(let a of i.renderLayers)a.handleAction(e)}for(let r of t.callbacks)r()}},XC=class{constructor(){this.changed=new re;this.coordinateSpace=ti;this.position=ro;this.unsnappedPosition=ro;this.active=!1;this.displayDimensions=void 0;this.pickedRenderLayer=null;this.pickedValue=new Q(0,0);this.pickedOffset=0;this.pickedAnnotationLayer=void 0;this.pickedAnnotationId=void 0;this.pickedAnnotationBuffer=void 0;this.pickedAnnotationBufferOffset=void 0;this.pickedAnnotationType=void 0;this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}},QC=class extends z{constructor(e,t){super();this.layerManager=e;this.mouseState=t;this.changed=new re;this.needsUpdate=!0;this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let r of this.layerManager.managedLayers){let i=r.layer;if(r.visible&&i!==null){let{selectionState:a}=i;i.resetSelectionState(a),a.generation=t,i.captureSelectionState(a,e)}}}get(e){this.update();let{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let r=t.layer;if(r){let i=this.get(r);i!==void 0&&(e[t.name]=r.selectionStateToJson(i,!0))}}return e}},p_=10,ZC={...wi,minSize:150,row:1},f_={...ZC,visible:!0},ew=class extends z{constructor(e,t){super();this.coordinateSpace=e;this.layerSelectedValues=t;this.changed=new re;this.history=[];this.historyIndex=0;this.location=new ur(ZC);this.pin=new Ge(!0);this.registerDisposer(ar((r,i)=>{i||(this.capture(!0),r.registerDisposer(t.changed.add(r.registerCancellable((0,a_.default)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>p_&&t.splice(0,t.length-p_),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,r=!0){if(r===!1&&(!this.location.visible||this.pin.value))return;let i={};e.initializeSelectionState(i),t(i)&&(this.location.visible=!0,r===!0?this.pin.value=!0:r==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:i}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let{value:e}=this,t;if(this.location.visible){if(t=this.location.toJSON(f_),this.pin.value&&e!==void 0){let r={};for(let i of e.layers){let{layer:a}=i,o=a.selectionStateToJson(i.state,!1);Object.keys(o).length===0&&(o=void 0),r[i.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=r}}else t=this.location.toJSON(ZC),t=Oi(t),t!==void 0&&(t.visible=!1);return t}select(){let{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){let t=lJ(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}Z(e),this.location.restoreState(e,f_);let t=this.coordinateSpace.value,r=pe(e,"position",a=>Je(new Float32Array(t.rank),a,ct)),i=[];pe(e,"layers",a=>{Z(a);let{layerManager:o}=this.layerSelectedValues;for(let[l,c]of Object.entries(a)){let d=o.getLayerByName(l);if(d===void 0)return;let p=d.layer;if(p===null)return;Z(c);let m={};p.initializeSelectionState(m),p.selectionStateFromJson(m,c),i.push({layer:p,state:m})}}),this.pin.value=i.length>0||r!==void 0,this.value={position:r,coordinateSpace:t,layers:i}}};function lJ(n){let{mouseState:e}=n;if(!e.active)return;let t=[];for(let r of n.layerManager.managedLayers){let i=r.layer;if(i===null)continue;let a=n.get(i);if(a===void 0)continue;let o={};i.initializeSelectionState(o),i.copySelectionState(o,a),t.push({layer:i,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}var h_=class extends z{constructor(e){super();this.view=e;this.messages=new zi;this.seenGeneration=-1;this.state=void 0}},cJ=0,m_=class extends z{constructor(e,t,r,i,a,o){super();this.layerManager=e;this.renderLayerType=t;this.view=r;this.roles=i;this.layerAdded=a;this.visibility=o;this.visibleLayers_=new Map;this.debouncedUpdateVisibleLayers=this.registerCancellable((0,Kg.default)(()=>this.updateVisibleLayers(),0));this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++cJ,{visibleLayers_:t,renderLayerType:r,layerAdded:i,roles:a}=this;for(let o of this.layerManager.readyRenderLayers())if(o instanceof r&&a.has(o.role)){let l=o,c=t.get(l);c===void 0&&(c=new h_(this.view),c.registerDisposer(l.messages.addChild(c.messages)),c.registerDisposer(l.addRef()),c.registerDisposer(l.visibility.add(this.visibility)),t.set(l,c),i(l,c),l.attach(c)),c.seenGeneration=e}for(let[o,l]of t)l.seenGeneration!==e&&(t.delete(o),l.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}};function Qg(n,e,t,r,i){return r.registerDisposer(new m_(n,e,r,t,(a,o)=>{o.registerDisposer(a.redrawNeeded.add(()=>r.scheduleRedraw()));let{backend:l}=a;l&&(l.rpc.invoke(rI,{layer:l.rpcId,view:r.rpcId}),o.registerDisposer(()=>l.rpc.invoke(iI,{layer:l.rpcId,view:r.rpcId}))),i!==void 0&&i(a,o),r.scheduleRedraw(),o.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}var tw=class extends z{constructor(e){super();this.layerManager=e;this.changed=new re;this.location=new ur(QR);this.registerDisposer(e),this.location.changed.add(()=>{var r,i;this.changed.dispatch();let t=(i=(r=this.layer)==null?void 0:r.layer)!=null?i:void 0;if(t!==void 0){let a=this.location.value;if(a.visible){let o=t.panels.panels[0];o.location.value!==a&&(o.location.value=a,o.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){let{managedLayers:r}=this.layerManager;r.length>0?t=this.layer=r[0]:e=!1}if(e===!0&&t!==void 0){let r=t.layer;(r===null||r.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;t!==null&&t instanceof Zi&&(t.dataSources.some(r=>r.spec.url.length!==0)||wo(e))}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){let r=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(r);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let a=e.layer;if(a!==null){let o=a.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(r),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),Oi(e)}restoreState(e){if(e===void 0){this.reset();return}Z(e),this.location.restoreState(e);let t=$(e,"layer",rn),r=t!==void 0?this.layerManager.getLayerByName(t):void 0;r===void 0&&(this.visible=!1),this.layer=r}reset(){this.location.reset(),this.layer=void 0}},nw=class extends z{constructor(e,t){super();this.layerManager=e;this.filter=t;this.changed=new re;this.validate=(0,Kg.default)(()=>{let{layerName_:e}=this;if(e!==void 0){let t=this.layerManager.getLayerByName(e);t!==void 0&&this.filter(t)?(this.layer_=t,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0);this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:r}=this;if(r!==void 0)if(!this.layerManager.layerSet.has(r)||!this.filter(r))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{let{name:i}=r;i!==this.layerName_&&(this.layerName_=i,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){let t=rn(e);this.layerName=t}toJSON(){let{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}},Zg=class extends z{constructor(e,t,r,i){super();this.layerManager=e;this.layer=t;this.predicate=r;this.getGroup=i;this.linkedLayers_=new Set;this.changed=new re;this.linkedLayersChanged=new re;this.root_=t;let a=this;this.root={get value(){return a.root_},changed:a.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;let t=ae(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:r,root_:i}=this;if(i===r){let{linkedLayers_:o}=this;if(o.size!==0){for(let l of o){let c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}let a=t(i);a.linkedLayers_.delete(r),a.linkedLayersChanged.dispatch(),this.root_=r,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:r}=t,{layerManager:i}=this,a=i.getLayerByName(e);if(a===void 0||a===r)return;let o=a.layer;o!==null&&(!this.predicate(o)||this.linkToLayer(o))}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,r=t(e).root_;if(r===this.layer)return;let i=t(r);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=r,this.changed.dispatch()}disposed(){this.isolate(!1)}};function g_(n,e){let t=pe(e,"type",ae,"auto");n.archived=pe(e,"archived",ya,!1),n.archived?n.visible=!1:n.visible=pe(e,"visible",ya,!0);let r=Hp.get(t)||Zi;return n.layer=new r(n),e}function y_(n,e){try{let t=n.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw wo(n),t}}function v_(n,e){try{Z(e),g_(n,e),y_(n,e)}catch(t){throw wo(n),t}}function S_(n,e){try{v_(n,e)}catch(t){new Ke().setErrorMessage(t instanceof Error?t.message:""+t)}}function rw(n,e,t){let r=new Wp(e,n);return v_(r,t),r}var iw=class extends z{constructor(){super(...arguments);this.changed=new re}},aw=class extends iw{constructor(e,t,r,i,a,o,l,c,d){super();this.display=e;this.dataSourceProviderRegistry=t;this.layerManager=r;this.chunkManager=i;this.selectionState=a;this.selectedLayer=o;this.coordinateSpace=l;this.globalPosition=c;this.toolBinder=d;this.coordinateSpaceCombiner=new Nc(this.coordinateSpace,gD);this.subsets=new Set;this.layerSelectedValues=this.selectionState.layerSelectedValues;this.registerDisposer(r.layersChanged.add(this.changed.dispatch)),this.registerDisposer(r.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(Z(e),t=Object.entries(e).map(([i,a])=>typeof a=="string"?{name:i,source:a}:(Z(a),{...a,name:i})));let r=[];for(let i of t){Z(i);let a=this.layerManager.getUniqueLayerName($(i,"name",ae)),o=new Wp(a,this);try{g_(o,i),this.layerManager.addManagedLayer(o),r.push({managedLayer:o,spec:i})}catch(l){o.dispose(),new Ke().setErrorMessage(`Error creating layer ${JSON.stringify(a)}: `+(l instanceof Error)?l.message:""+l)}}for(let{managedLayer:i,spec:a}of r)try{y_(i,a)}catch(o){new Ke().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let r of this.layerManager.managedLayers){let i=r.toJSON();i!=null&&(e.push(i),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}},zp=class extends iw{constructor(e){super();this.master=e;this.changed=new re;this.layerManager=this.registerDisposer(new Xg);this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,r=[];for(let i of new Set(Te(e,ae))){let a=t.getLayerByName(i);if(a===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(i)}`);a.archived||r.push(a)}this.layerManager.clear();for(let i of r)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}},Hp=new Map,ow=new Map,b_=[n=>{let{volume:e}=n;if(e===void 0)return;let t=ow.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function ea(n,e=n.type){Hp.set(e,n)}function Cs(n){b_.push(n)}function ey(n,e){ow.set(n,e)}function Bp(n,e){let t=n.layer;if(t===null)return;let r=t.toJSON(),i=new e(n);i.restoreState(r),i.initializationDone(),n.layer=i}function qg(n,e){return e!==n.name?(e=n.manager.root.layerManager.getUniqueLayerName(e),n.name=e,n.layerChanged.dispatch(),!0):!1}function wo(n){if(!n.wasDisposed)for(let e of n.containers)e.removeManagedLayer(n)}function sw(n,e){return n===void 0?e:e===void 0?n:n.priority<e.priority?e:n}function uJ(n){let e;for(let r of b_)e=sw(e,r(n));let{volume:t}=n;if(t!==void 0){let r=ow.get(t.volumeType);r!==void 0&&(e=sw(e,{layerConstructor:r,priority:0}))}return e}function x_(n){let e;for(let t of n){let{subsourceEntry:r}=t,{subsource:i}=r;e=sw(e,uJ(i))}return e}var Zi=class extends Ei{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=x_(e))==null?void 0:t.layerConstructor}};Zi.type="new",Zi.typeAbbreviation="new";var ty=class extends Ei{activateDataSubsources(e){var r;let t=(r=x_(e))==null?void 0:r.layerConstructor;t!==void 0&&Bp(this.managedLayer,t)}};ty.type="auto",ty.typeAbbreviation="auto";function ny(n,e){let t=rw(n,"new layer",{type:"new"});n.add(t),e.layer=t,e.visible=!0}ea(Zi);ea(ty);var lw=rt(Ct());var C_=class{static insertAfter(n,e){let t=n.next0;e.next0=t,e.prev0=n,n.next0=e,t.prev0=e}static insertBefore(n,e){let t=n.prev0;e.prev0=t,e.next0=n,n.prev0=e,t.next0=e}static front(n){let e=n.next0;return e===n?null:e}static back(n){let e=n.prev0;return e===n?null:e}static pop(n){let e=n.next0,t=n.prev0;return e.prev0=t,t.next0=e,n.next0=null,n.prev0=null,n}static*iterator(n){for(let e=n.next0;e!==n;e=e.next0)yield e}static*reverseIterator(n){for(let e=n.prev0;e!==n;e=e.prev0)yield e}static initializeHead(n){n.next0=n.prev0=n}},Vl=C_;var w_=class{constructor(){Vl.initializeHead(this)}},cw=new w_,dJ=window.top===window,uw=(0,lw.default)(()=>{if(!dJ)return;let{activeElement:n}=document;if(n===null||n===document.body){let e=Vl.front(cw);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{uw()},!0);window.addEventListener("blur",()=>{uw()},!0);var To=class extends z{constructor(e){super();this.element=e;this.prev0=null;this.next0=null;this.lastFocusedElement=null;this.scheduleUpdateFocus=this.registerCancellable((0,lw.default)(()=>{let{activeElement:e}=document,{element:t}=this;t.contains(e)||fp(e)||(e!=null&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0));e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),Vl.insertBefore(cw,this),this.registerEventListener(e,"focus",()=>{Vl.pop(this),Vl.insertAfter(cw,this)}),uw()}disposed(){Vl.pop(this),super.disposed()}};var ry=0,pJ=Fe.fromObject({escape:{action:"close"}}),ta=class extends z{constructor(){super();this.keyMap=new Fe;this.keyMap.addParent(pJ,Number.NEGATIVE_INFINITY),++ry;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new To(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new sn(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--ry,document.body.removeChild(this.container),super.disposed()}};var fJ=K.create(),hJ=K.create(),iy=.001,T_=.001;function k_(n){let e=0;for(var t=0;t<3;++t)n[t]<0&&(e+=1<<t);return e}var ay=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),L_=(()=>{let n=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],i=new Int32Array(8*8*6);for(let a=0;a<8;++a)for(let o=0;o<t.length;++o){let l=e[a]*8+t[o];i[a*8*6+o]=n[r[l]]}return i})();function Ol(n){n.addUniform("highp vec3","uPlaneNormal"),n.addUniform("highp float","uPlaneDistance"),n.addUniform("highp ivec2","uVertexIndex",24),n.addUniform("highp vec3","uVertexBasePosition",8),n.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),ay)}),n.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${T_}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${iy}) && (lambda <= (1.0 + ${iy}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function E_(n,e,t,r,i,a,o,l=!0){let c=k_(i),d=L_.subarray(c*48,(c+1)*48),p=[0,0],m=[K.create(),K.create()],y=K.create(),v=K.create(),b=x=>ay.subarray(x*3,x*3+3);for(let x=0;x<4;++x){for(let k=0;k<2;++k)p[k]=d[2*(o*4+x)+k],K.multiply(m[k],n,b(p[k])),K.add(m[k],m[k],a),K.min(m[k],m[k],t),K.max(m[k],m[k],e);K.subtract(y,m[1],m[0]);let C=K.dot(y,i);if(Math.abs(C)>T_){let k=(r-K.dot(m[0],i))/C;if(k>=-iy&&k<=1+iy)return l&&console.log(`vertex ${o}, e = ${x}, good, lambda=${k}, denom=${C}, v0=${m[0].join()}, vDir=${y.join()}`),k=Math.max(0,Math.min(1,k)),K.scaleAndAdd(v,m[0],y,k),v;l&&console.log(`vertex ${o}, e = ${x}, skipped, denom = ${C}, vDir = ${y.join()}, v0=${m[0].join()}, v1=${m[1].join()}uPlaneNormal = ${qo(i)}, lambda=${k}`)}else l&&console.log(`vertex ${o}, e = ${x}, skipped, deom = ${C}, vDir = ${qo(y)}, uPlaneNormal = ${qo(i)}, uLowerClipBound=${e.join()}, uUpperClipBound=${t.join()}, chunkSize=${n}, uVertexBasePosition(v0)=${b(p[0]).join()}, uVertexBasePosition(v1)=${b(p[1]).join()}, uTranslation=${a.join()}`)}}function mJ(n,e,t){let{gl:r}=n;r.uniform3fv(n.uniform("uPlaneNormal"),e),r.uniform1f(n.uniform("uPlaneDistance"),t);let i=k_(e);r.uniform2iv(n.uniform("uVertexIndex"),L_.subarray(i*48,(i+1)*48))}function du(n,e,t,r,i){let a=Lh(fJ,e,r);K.normalize(a,a);let o=K.dot(K.transformMat4(hJ,t,i),a);mJ(n,a,o)}var dw=!1,D_=.001,P_=ie.create();function gJ(n,e){if(Rr(n),Ol(n),n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),e){pr(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${ki};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}n.addVarying("highp vec3","vChunkPosition"),n.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${D_} * abs(uPlaneNormal);
`)}function yJ(n,e,t,r,i,a,o){let l=K.create(),c=K.create(),d=K.fromValues(Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])),p=K.create();for(let m=0;m<6;++m){let y=E_(n,e,t,r,i,a,m);if(y===void 0){console.log("no intersection found");return}K.transformMat4(l,y,o);let v=m!==0&&K.equals(l,p);K.copy(p,l),K.sub(c,y,a),K.scaleAndAdd(c,c,d,D_),console.log(`${v?"SKIPPED":"OUTPUT"} vertex ${m}, at ${l}, vChunkPosition = ${c}, uTranslation=${a.join()}, position=${y.join()}`)}}function vJ(n,e,t){t&&hr(n,e,1)}function SJ(n,e,t,r,i,a){let o=t.projectionParameters.value,{centerDataPosition:l}=o;du(e,o.viewportNormalInGlobalCoordinates,l,a.transform,a.invTransform),n.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,ie.multiply(P_,r,a.transform)),n.uniform3fv(e.uniform("uLowerClipBound"),i.lowerClipDisplayBound),n.uniform3fv(e.uniform("uUpperClipBound"),i.upperClipDisplayBound),dw&&(window.debug_sliceView_uLowerClipBound=i.lowerClipDisplayBound,window.debug_sliceView_uUpperClipBound=i.upperClipDisplayBound,window.debug_sliceView=t,window.debug_sliceView_dataToDevice=ie.clone(P_),window.debug_sliceView_chunkLayout=a)}function bJ(n,e,t){n.uniform3fv(e.uniform("uChunkDataSize"),t),dw&&(window.debug_sliceView_chunkDataSize=t)}function xJ(n,e,t,r){if(n.uniform3fv(e.uniform("uTranslation"),t),r?fr(e.gl,6,1):n.drawArrays(n.TRIANGLE_FAN,0,6),dw){let a=window.debug_sliceView.projectionParameters.value,o=window.debug_sliceView_chunkDataSize,l=window.debug_sliceView_uLowerClipBound,c=window.debug_sliceView_uUpperClipBound,d=window.debug_sliceView_dataToDevice,p=window.debug_sliceView_chunkLayout;console.log(`Drawing chunk: ${t.join()} of data size ${o.join()}, projection`,d);let m=p.globalToLocalNormal(K.create(),a.viewportNormalInGlobalCoordinates),y=K.dot(K.transformMat4(K.create(),a.centerDataPosition,p.invTransform),m);yJ(o,l,c,y,m,t,d)}}function CJ(n,e,t){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t}var $p=class extends Hc{constructor(e,t){let{shaderError:r=Sa(),shaderParameters:i}=t;super(e.chunkManager,e,t);let{gl:a}=this;this.vertexIdHelper=this.registerDisposer(Qn.get(a)),this.shaderParameters=i;let{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?Yr(ti):o,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let l=this.registerDisposer(fn((c,d)=>({numChannelDimensions:c.rank,dataHistogramChannelSpecifications:d}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Hd(this,a,{memoizeKey:`volume/RenderLayer:${St(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:i,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:l,defineShader:(c,d,p,m)=>{let{chunkFormat:y,dataHistogramsEnabled:v}=d,{dataHistogramChannelSpecifications:b,numChannelDimensions:x}=m;if(gJ(c,y===null),c.addOutputBuffer("vec4","v4f_fragData0",0),c.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),y===null)return;Km(c,y,x,"vChunkPosition");let C=b.length;if(v&&C>0){let k="",{dataType:M}=y;for(let I=0;I<C;++I){let{channel:A}=b[I],D=`out_histogram${I}`;c.addOutputBuffer("vec4",D,1+I);let E=`getDataValue(${A.join(",")})`,V=`invlerpForHistogram${I}`;c.addFragmentCode(pm(c,V,M,!1)),c.addFragmentCode(`
float getHistogramValue${I}() {
  return invlerpForHistogram${I}(${E});
}
`),k+=`{
float x = getHistogramValue${I}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${D} = vec4(x, x, x, 1.0);
}`}c.addFragmentCode(`void userMain();
void main() {
  ${k}
  userMain();
}
#define main userMain
`)}this.defineShader(c,p)},getContextKey:c=>{var d;return`${(d=c.chunkFormat)==null?void 0:d.shaderKey}/${c.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:r,chunkTransform:i}of this.visibleSourcesList){if(!io(t,e,this.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))continue;let a=r.getValueAt(t,i);if(a!=null)return a}return null}beginChunkFormat(e,t,r){let{gl:i}=this,a=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:a}),{shader:l,parameters:c,fallback:d}=o;if(l!==null&&(l.bind(),vJ(l,r,t===null),t!==null)){if(a){let{dataHistogramChannelSpecifications:p}=o.extraParameters,m=p.length,y=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<m;++v)Gc(l,`invlerpForHistogram${v}`,t.dataType,y[v])}this.initializeShader(e,l,c,d),t.beginDrawing(i,l)}return o}endSlice(e,t,r){}draw(e){let{sliceView:t}=e,r=t.visibleLayers.get(this),{visibleSources:i}=r;if(i.length===0)return;let{projectionParameters:a,wireFrame:o}=e,{gl:l}=this;this.vertexIdHelper.enable();let c=K.create(),{renderScaleHistogram:d}=this;d!==void 0&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let p,m=null,y,v=K.create(),b=()=>{m!==null&&(y!==null&&y.endDrawing(l,m),this.endSlice(t,m,p.parameters))},x=!0;for(let C of i){let k=Fc(a,C.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:M}}=C,I=C.source,{fixedPositionWithinChunk:A,chunkDisplayDimensionIndices:D}=C;for(let X of D)A[X]=0;let E=o?null:I.chunkFormat;if(E!==y&&(y=E,b(),p=this.beginChunkFormat(t,E,a),m=p.shader),m===null)continue;let V=I.chunks;v.fill(1);let N=k.size,U,_=I.spec.rank;SJ(l,m,t,a.viewProjectionMat,C,k),E!==null&&E.beginSource(l,m),x=!0;let B=0,R=0;if(t.forEachVisibleChunk(C,k,X=>{let j=V.get(X);if(j&&j.state===dt.GPU_MEMORY){let oe=j.chunkDataSize;if(oe!==U){U=oe;for(let xe=0;xe<3;++xe){let se=D[xe];v[xe]=se===-1||se>=_?1:U[se]}bJ(l,m,v)}let{chunkGridPosition:me}=j;for(let xe=0;xe<3;++xe){let se=D[xe];c[xe]=se===-1||se>=_?0:N[xe]*me[se]}E!==null&&E.bindChunk(l,m,j,A,D,M,x),x=!1,xJ(l,m,c,o),++B}else++R}),(B!==0||R!==0)&&d!==void 0){let{effectiveVoxelSize:X}=C,j=CJ(X[0],X[1],X[2]);d.add(j,j/a.pixelSize,B,R)}}if(b(),this.vertexIdHelper.disable(),!e.wireFrame){let C=this.getDataHistogramCount();C>0&&t.computeHistograms(C,this.dataHistogramSpecifications)}}};var ws;(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ADDITIVE=1]="ADDITIVE"})(ws||(ws={}));var I_=new Map([[0,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)}],[1,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE)}]]);function A_(n=0){return new gs(ws,n)}var M_=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function R_(n=M_){return es(n)}function pw(n,e){n.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),n.addFragmentCode(vo),Wi(e,n),n.setFragmentMainFunction(Fi(e.parseResult.code))}var fw=class extends $p{constructor(e,t){var o,l,c;let{opacity:r,blendMode:i,shaderControlState:a}=t;super(e,{...t,fallbackShaderParameters:new Ge(rs(uo(M_,{imageData:{dataType:e.dataType,channelRank:(c=(l=(o=t.channelCoordinateSpace)==null?void 0:o.value)==null?void 0:l.rank)!=null?c:0}}))),encodeShaderParameters:d=>d.key,shaderParameters:a.builderState,dataHistogramSpecifications:a.histogramSpecifications});this.shaderControlState=a,this.opacity=r,this.blendMode=i,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),pw(e,t)}initializeShader(e,t,r){let{gl:i}=this;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),ai(i,t,this.shaderControlState,r.parseResult.controls)}setGLBlendMode(e,t){let r=this.blendMode.value;r===ws.ADDITIVE||t>0?(e.enable(e.BLEND),I_.get(r)(e)):e.disable(WebGL2RenderingContext.BLEND)}};function Nl(n=.5){return new lt(n,_h)}function oy(n){try{return n()}catch(e){return{error:e.message}}}function __(n){if(n.error!==void 0)throw new Error(n.error);return n}var Bl=class extends z{constructor(e,t){super();this.register=e;this.changed=new re;this.disposerMap=new Map;if(t===void 0)this.map=new Map;else{let r=this.map=new Map(t),{disposerMap:i}=this;for(let[a,o]of r){let l=new z;i.set(a,l),e(l,o,a)}}}get value(){return this.map}set(e,t){let{map:r,disposerMap:i}=this,a=i.get(e);return a!==void 0&&a.dispose(),a=new z,i.set(e,a),r.set(e,t),this.register(a,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:r}=this,i=r.get(e);return i!==void 0?(i.dispose(),r.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let r of t.values())r.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let r of t.values())r.dispose();e.clear(),t.clear(),super.disposed()}};var V_=class extends Ge{},O_=class extends Bl{constructor(){super((e,{showMatches:t,segmentationState:r})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(r.changed.add(this.changed.dispatch)),e.registerDisposer(ar((i,a)=>{if(a==null)return;let{segmentationGroupState:o}=a;i.registerDisposer(o.changed.add(this.changed.dispatch)),i.registerDisposer(ar((l,c)=>{let{visibleSegments:d}=c,p=d.size===0;l.registerDisposer(d.changed.add(()=>{let m=d.size===0;m!==p&&(p=m,this.changed.dispatch())}))},o))},r))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new Ge(void 0),showMatches:new Mt(!1)},super.set(e,t)),t}},N_=`
void main() {
  setColor(defaultColor());
}
`,hw=class extends z{constructor(){super(...arguments);this.shader=es(N_);this.shaderControls=new po(this.shader);this.fallbackShaderControls=new Ge(rs(uo(N_)));this.shaderError=Sa();this.color=new Jo(K.fromValues(1,1,0));this.relationshipStates=this.registerDisposer(new O_);this.ignoreNullSegmentFilter=new Mt(!0);this.displayUnfiltered=ir((e,t)=>{for(let r of e.values())if(r.showMatches.value){if(!t)return!1;let i=r.segmentationState.value;if(i!=null&&i.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);this.hoverState=new V_(void 0)}},pu=class extends z{constructor(e){super();let{transform:t,localPosition:r,source:i,role:a=cr.ANNOTATION}=e;this.transform=t,this.localPosition=r,this.source=this.registerDisposer(i),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(ir(o=>oy(()=>tm(__(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}};var jp=12,mw=8,wJ=6,B_=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function U_(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*wJ*e,t)}var F_=0,sy=F_+1,Zn=sy+mw,gw=Zn+jp,TJ=gw+6,kJ=Float32Array.from([0,0,0,0,0,1,Zn+0,1,0,0,1,0,1,Zn+1,0,1,0,0,1,1,Zn+2,1,1,0,1,1,1,Zn+3,0,0,0,0,1,0,Zn+4,0,0,1,0,1,1,Zn+5,1,0,0,1,1,0,Zn+6,1,0,1,1,1,1,Zn+7,0,0,0,1,0,0,Zn+8,0,0,1,1,0,1,Zn+9,0,1,0,1,1,0,Zn+10,0,1,1,1,1,1,Zn+11]),G_=ie.create(),Ts=new Float32Array(6),yw=class extends fo{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl))}defineShader(e){Rr(e);let{rank:t}=this;ns(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,r){ie.invert(G_,t.modelViewProjectionMatrix),V1(G_,Ts);let{numChunkDisplayDims:i}=t.chunkDisplayTransform;for(let a=0;a<i;++a)Ts[a]=0,Ts[a+3]=0;for(let a=i;a<3;++a){let o=Math.abs(Ts[a+3]-Ts[a]);Ts[a]-=o,Ts[a+3]+=o}super.enable(e,t,a=>{let o=a.vertexShaderInputBinders.Bounds;o.enable(1);let{gl:l}=this;l.uniform3fv(a.uniform("uModelSpaceBoundOffsets"),Ts),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:c}=this;c.enable(),r(a),c.disable(),o.disable()})}};function W_(n){n.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function z_(n){n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function vw(n){z_(n),n.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function LJ(n){W_(n),n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}var H_=class extends yw{constructor(){super(...arguments);this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(en.fromData(this.gl,gd(kJ,7,1,ki)));this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),pr(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),vw(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});this.boxCornerOffsetsBuffer=this.registerDisposer(en.fromData(this.gl,gd(ay,3,1,qm)));this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),ys(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),vw(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${sy}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset1"),a=r.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(a,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),hr(r,e.renderContext.projectionParameters,1),fr(t,jp,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(a)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,r=>{let i=r.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),vs(r,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Ss(r.gl,mw,e.count),t.disableVertexAttribArray(i)})}draw(e){this.drawEdges(e),this.drawCorners(e)}},$_=class extends yw{constructor(){super(...arguments);this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),Ol(e),pr(e),e.addVarying("highp float","vClipCoefficient"),vw(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${ki};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{let{rank:t}=this;super.defineShader(e),Ol(e),e.addVarying("highp float","vClipCoefficient"),LJ(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,r){super.enable(e,t,i=>{let a=t.renderContext.sliceView.projectionParameters.value;du(i,a.viewportNormalInGlobalCoordinates,a.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),r(i)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{oP(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{hr(t,e.renderContext.projectionParameters,1),fr(t.gl,6,e.count)})}};function EJ(n,e){let t=n.length;for(let r=0;r<t;++r){let i=e[r],a=e[r+t],o=n[r];n[r]=Math.abs(i-o)<Math.abs(a-o)?i:a}}is(ze.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:$_,perspectiveViewRenderHelper:H_,defineShaderNoOpSetters(n){z_(n),W_(n)},pickIdsPerInstance:TJ,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r>=sy&&r<Zn?EJ(n,a):r>=Zn&&r<gw},getRepresentativePoint(n,e,t){t===F_||t>=sy&&t<Zn||t>=Zn&&t<gw,n.set(e.pointA)},updateViaRepresentativePoint(n,e,t){let r=e.length,{pointA:i,pointB:a}=n,o=new Float32Array(r),l=new Float32Array(r);for(let c=0;c<r;++c){let d=o[c]=e[c];l[c]=a[c]+(d-i[c])}return{...n,pointA:o,pointB:l}}});var fu=0,Sw=fu+1,DJ=Sw+2;function j_(n){n.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function q_(n){n.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}var bw=class extends fo{constructor(){super(...arguments);this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl));this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),pr(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),j_(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),ys(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),q_(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${qm};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){Rr(e);let{rank:t}=this;ns(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{hr(t,e.renderContext.projectionParameters,1),fr(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{vs(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Ss(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};function PJ(n,e){let t=n.length;A1(n,e.subarray(0,t),e.subarray(t),n)}function IJ(n,e,t){let r=n.length,i=r*t;for(let a=0;a<r;++a)n[a]=e[i+a]}is(ze.LINE,{sliceViewRenderHelper:bw,perspectiveViewRenderHelper:bw,defineShaderNoOpSetters(n){j_(n),q_(n)},pickIdsPerInstance:DJ,snapPosition(n,e,t,r){let i=n.length,a=new Float32Array(e,t,i*2);r===fu?PJ(n,a):IJ(n,a,r-Sw)},getRepresentativePoint(n,e,t){n.set(t===fu||t===Sw?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r={...n},i=e.length;switch(t){case fu:{let{pointA:a,pointB:o}=n,l=new Float32Array(i),c=new Float32Array(i);for(let d=0;d<i;++d){let p=l[d]=e[d];c[d]=o[d]+(p-a[d])}return{...n,pointA:l,pointB:c}}case fu+1:return{...n,pointA:new Float32Array(e)};case fu+2:return{...n,pointB:new Float32Array(e)}}return r}});var xw=class extends fo{constructor(){super(...arguments);this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{Rr(e),ys(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{Rr(t),pr(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});this.shaderGetter2d=this.makeShaderGetter2d(2);this.shaderGetter1d=this.makeShaderGetter2d(1);this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl))}defineShaderCommon(e){let{rank:t}=this;ns(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset);let{vertexIdHelper:o}=this;o.enable(),r(i),o.disable(),a.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,r=>{vs(r,e.renderContext.projectionParameters,{featherWidthInPixels:1}),Ss(r.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,r=>{hr(r,e.renderContext.projectionParameters,1),fr(r.gl,1,e.count)});break}}};is(ze.POINT,{sliceViewRenderHelper:xw,perspectiveViewRenderHelper:xw,defineShaderNoOpSetters(n){n.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(n,e,t){n.set(new Float32Array(e,t,n.length))},getRepresentativePoint(n,e){n.set(e.point)},updateViaRepresentativePoint(n,e){return{...n,point:new Float32Array(e)}}});var J_=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,Y_=[J_,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`];function K_(n,e){let t=[[n[0],n[1],n[2]],[n[3],n[4],n[5]],[n[6],n[7],n[8]]];return{A:t[0][0],B:t[0][1]+t[1][0],C:t[1][1],D:-2*e[0]*t[0][0]-e[1]*(t[0][1]+t[1][0])+e[2]*(t[0][2]+t[2][0]),E:-e[0]*(t[0][1]+t[1][0])-2*e[1]*t[1][1]+e[2]*(t[1][2]+t[2][1]),F:e[0]*e[0]*t[0][0]+e[0]*e[1]*(t[0][1]+t[1][0])-e[0]*e[2]*(t[0][2]+t[2][0])+e[1]*e[1]*t[1][1]-e[1]*e[2]*(t[1][2]+t[2][1])+e[2]*e[2]*t[2][2]-1}}var AJ=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,X_=[J_,AJ,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function Q_(n){let e=n.A,t=n.B/2,r=n.C,i=n.D,a=n.E,o=n.F,l=2*(t*t-e*r),c=(r*i-t*a)/l,d=(e*a-t*i)/l,p=1/(e*c*c+2*t*c*d+r*d*d-o),m=p*e,y=p*t,v=p*r,b=m+v,x=Math.sqrt((m-v)*(m-v)+4*y*y),C=(b+x)/2,k=(b-x)/2,M=1/Math.sqrt(C),I=1/Math.sqrt(k),A;m>=v?A=Tr.fromValues(C-v,y):A=Tr.fromValues(y,C-m),Tr.normalize(A,A);let D=Tr.fromValues(-A[1],A[0]);return{k:Tr.fromValues(c,d),u1:A,u2:D,a:M,b:I,lambda1:C,lambda2:k,m11:m,m12:y,m22:v,valid:C>0&&k>0}}function MJ(n,e){let t=new Float32Array((n+1)*(e+1)*3),r=0;for(let i=0;i<=n;++i){let a=i*Math.PI/n,o=Math.sin(a),l=Math.cos(a);for(let c=0;c<=e;++c){let d=c*2*Math.PI/e,p=Math.sin(d),m=Math.cos(d);t[r++]=m*o,t[r++]=l,t[r++]=p*o}}return t}function RJ(n,e){let t=new Uint16Array(n*e*6),r=0;for(let i=0;i<n;i++)for(let a=0;a<e;a++){let o=i*(e+1)+a,l=o+e+1;t[r++]=o,t[r++]=l,t[r++]=o+1,t[r++]=l,t[r++]=l+1,t[r++]=o+1}return t}var Cw=class extends z{constructor(e,t,r){super();this.vertexBuffer=this.registerDisposer(lo(e,WebGL2RenderingContext.ARRAY_BUFFER,MJ,t,r)).value,this.indexBuffer=this.registerDisposer(lo(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,RJ,t,r)).value,this.numIndices=t*r*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let r=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(r)}};var Z_=ie.create(),_J=!1,ww=class extends fo{defineShader(e){let{rank:t}=this;ns(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,r){super.enable(e,t,i=>{let a=i.vertexShaderInputBinders.CenterAndRadii;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset),r(i),a.disable()})}},e2=class extends ww{constructor(){super(...arguments);this.sphereRenderHelper=this.registerDisposer(new Cw(this.gl,10,10));this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=this.tempLightVec,{lightDirection:a,ambientLighting:o,directionalLighting:l}=e.renderContext;K.scale(i,a,l),i[3]=o,r.uniform4fv(t.uniform("uLightDirection"),i),r.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,ie.transpose(ie.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}},t2=class extends ww{constructor(){super(...arguments);this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Rr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(Y_),e.addVertexCode(X_),e.addVertexCode(tu),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:r}=t,i=e.renderContext.sliceView.projectionParameters.value,a=ie.multiply(Z_,e.renderSubspaceInvModelMatrix,i.invViewMatrix);r.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,a),r.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);let o=Z_;ie.invert(o,a),r.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);let{vertexIdHelper:l}=this;if(l.enable(),nu(r,1,e.count),l.disable(),_J){let c=K.fromValues(3406.98779296875,3234.910400390625,4045),d=K.fromValues(10,10,10),p=Ft.create();p[0]=1/(d[0]*d[0]),p[4]=1/(d[1]*d[1]),p[8]=1/(d[2]*d[2]);let m=Ft.fromMat4(Ft.create(),a),y=Ft.multiply(Ft.create(),Ft.transpose(Ft.create(),m),p);Ft.multiply(y,y,m);let v=K.transformMat4(K.create(),c,o);console.log("Aviewport",y),console.log("cViewport",v);let b=K_(y,v),x=Q_(b);console.log(b),console.log(x)}})}};is(ze.ELLIPSOID,{sliceViewRenderHelper:t2,perspectiveViewRenderHelper:e2,defineShaderNoOpSetters(n){n.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(n,e){n.set(e.center)},updateViaRepresentativePoint(n,e){return{...n,center:new Float32Array(e)}}});var n2=ie.create(),r2=K.create();function i2(n){n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}var a2={defineShader(n){i2(n),pr(n),n.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),n.setVertexMain(`
int edgeIndex = gl_VertexID / ${ki};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){hr(n,e,1)},draw(n,e,t){let{gl:r}=n,i=n2,{chunkLayout:a}=e;ie.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=r2;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),fr(r,jp,1)}},o2={defineShader(n){Ol(n),i2(n),pr(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${ki};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){hr(n,e,1)},draw(n,e,t){let{gl:r}=n,i=n2,{chunkLayout:a}=e;ie.multiply(i,t.viewProjectionMat,a.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),a.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);let o=a.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,d=r2;for(let p=0;p<3;++p){let m=c[p];d[p]=(m===-1?0:l[m])*o[p]}r.uniform3fv(n.uniform("uTranslation"),d),du(n,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,a.transform,a.invTransform),fr(r,6,1)}};var VJ=ie.create();function OJ(n){if(n!==void 0)return e=>{let{relatedSegments:t}=e;if(t===void 0)return!1;for(let r=0,i=t.length;r<i;++r){let a=n[r];if(a==null)continue;let{visibleSegments:o,segmentEquivalences:l}=a.segmentationGroupState.value;for(let c of t[r])if(o.has(l.get(c)))return!0}return!1}}function NJ(n,e){let t=new XS(n.annotationPropertySerializer);for(let r of n)(e===void 0||e(r))&&t.add(r);return t.serialize()}var ly=class extends ba(La){constructor(e,t,r,i){super(i);this.chunkManager=e;this.source=t;this.segmentationStates=r;this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});let a=()=>{let o={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(ZD,o)};this.registerDisposer(r.changed.add(a))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(e!==void 0)return e.map(t=>t==null?t:Ax(t.segmentationGroupState.value))}};ly=Ut([_n(QD)],ly);var Tw=class extends z{constructor(e,t){super();this.chunkManager=e;this.state=t;this.layerChunkProgressInfo=new cl;this.numPickIds=0;this.generation=-1;this.redrawNeeded=new re;this.serializedAnnotations=void 0;this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()};this.segmentationStates=this.registerDisposer(fn(e=>{let{displayState:t,source:r}=this.state,{relationshipStates:i}=t;return t.displayUnfiltered.value?void 0:r.relationships.map(a=>{let o=i.get(a);return o.showMatches.value?o.segmentationState.value:void 0})},[this.state.displayState.relationshipStates],(e,t)=>e===void 0||t===void 0?e===t:Ee(e,t)));this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(ar((i,a)=>{if(this.handleChangeAffectingBuffer(),a!==void 0)for(let o of a)o!=null&&i.registerDisposer(Qa((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof no||(this.sharedObject=this.registerDisposer(new ly(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:r}=this.state;this.registerDisposer(r.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){let{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof no){let t=e.changed.count;if(this.generation!==t){let{buffer:r}=this;r===void 0&&(r=this.buffer=this.registerDisposer(new en(this.chunkManager.gl))),this.generation=t;let i=this.serializedAnnotations=NJ(e,OJ(this.segmentationStates.value));r.setData(this.serializedAnnotations.data),this.numPickIds=Zb(i)}}}};function s2(n){let{chunkTransform:e}=n,{unpaddedRank:t}=e.modelTransform,r=new Float32Array(t*2),i=new Float32Array(t*3);i.fill(0),r.fill(1,t);let{numChunkDisplayDims:a,chunkDisplayDimensionIndices:o}=n;for(let l=0;l<a;++l){let c=o[l];r[t+c]=0,i[c*3+l]=1}return{modelClipBounds:r,renderSubspaceTransform:i}}function l2(n,e,t){t.clearMessages();let r=c=>{t.addMessage({severity:Dr.error,message:c})};if(n.error!==void 0)return r(n.error);let i=nm(n.modelTransform,e.displayDimensionIndices),a;try{a=rm(n,i)}catch(c){return r(c.message)}let{modelClipBounds:o,renderSubspaceTransform:l}=s2(a);return{chunkTransform:n,chunkDisplayTransform:a,modelClipBounds:o,renderSubspaceTransform:l}}function kw(n,e){class t extends n{constructor(i,a){super();this.base=i;this.renderScaleHistogram=a;this.curRank=-1;this.renderHelpers=[];this.isAnnotation=!0;let o=i.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let l of this.renderHelpers)l.dispose()}),this.role=i.state.role,this.registerDisposer(i.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){let{rank:i}=this.base.source;if(i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);let{renderHelpers:a,gl:o}=this;for(let d of a)d.dispose();let{properties:l}=this.base.source,{displayState:c}=this.base.state;for(let d of Ni){let p=as(d),m=p[e],y=a[d]=new m(o,d,i,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);y.pickIdsPerInstance=p.pickIdsPerInstance,y.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(i){super.attach(i),this.handleRankChanged();let{chunkTransform:a}=this,o=i.view.displayDimensionRenderInfo.value;i.state={chunkTransform:a,displayDimensionRenderInfo:o,chunkRenderParameters:l2(a,o,i.messages)}}updateAttachmentState(i){let a=i.state;this.handleRankChanged();let{chunkTransform:o}=this,l=i.view.displayDimensionRenderInfo.value;return a!==void 0&&a.chunkTransform===o&&a.displayDimensionRenderInfo===l?a.chunkRenderParameters:(a.chunkTransform=o,a.displayDimensionRenderInfo=l,a.chunkRenderParameters=l2(o,l,i.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(i,a){let{modelClipBounds:o}=a,l=this.curRank,{chunkTransform:c}=a;io(o.subarray(0,l),i.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(i,a,o,l=1){if(!i.bufferValid){let{buffer:c}=i;c===void 0&&(c=i.buffer=new en(this.gl));let{serializedAnnotations:d}=i;c.setData(d.data),i.numPickIds=Zb(d),i.bufferValid=!0}this.drawGeometry(i,a,o,l)}drawGeometry(i,a,o,l=1){let{base:c}=this,{chunkDisplayTransform:d}=o,{serializedAnnotations:p}=i,{typeToIdMaps:m,typeToOffset:y}=p,v=0;a.emitPickID&&(v=a.pickIDs.register(this,i.numPickIds,0,0,i));let b=c.hoverState.value,x=ie.multiply(VJ,a.projectionParameters.viewProjectionMat,d.displaySubspaceModelMatrix),C={annotationLayer:c,renderContext:a,selectedIndex:0,basePickId:v,buffer:i.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:x,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:d.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:d.displaySubspaceInvModelMatrix,chunkDisplayTransform:d};for(let k of Ni){let M=m[k],I=M.size;if(I>0){let A=as(k),D=4294967295;if(b!==void 0){let E=M.get(b.id);E!==void 0&&(D=E*A.pickIdsPerInstance)}I=Math.round(I*l),C.count=I,C.bufferOffset=y[k],C.selectedIndex=D,this.renderHelpers[k].draw(C),C.basePickId+=I*A.pickIdsPerInstance}}}updateMouseState(i,a,o,l){let c=l,{serializedAnnotations:d}=c,{typeToIds:p,typeToOffset:m}=d,y=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(let b of Ni){let x=p[b],C=as(b),k=Sn[b],{pickIdsPerInstance:M}=C;if(o<x.length*M){let I=Math.floor(o/M),A=x[I],D=o%M;i.pickedAnnotationId=A,i.pickedAnnotationLayer=this.base.state,i.pickedOffset=D,i.pickedAnnotationBuffer=d.data.buffer,i.pickedAnnotationType=b,i.pickedAnnotationBufferOffset=d.data.byteOffset+m[b]+I*(k.serializedBytes(y)+this.base.source.annotationPropertySerializer.serializedBytes);let E=this.tempChunkPosition,{chunkToLayerTransform:V,combinedGlobalLocalToChunkTransform:N,layerRank:U}=v,{globalToRenderLayerDimensions:_}=v.modelTransform,{position:B}=i;if(!io(E,B,this.base.state.localPosition.value,U,N))return;C.snapPosition(E,i.pickedAnnotationBuffer,i.pickedAnnotationBufferOffset,D);let R=_.length;for(let X=0;X<R;++X){let j=_[X];if(j===-1)continue;let oe=V[(y+1)*y+j];for(let me=0;me<y;++me)oe+=E[me]*V[me*(U+1)+j];!Number.isFinite(oe)||(B[X]=oe)}return}o-=x.length*M}}transformPickedValue(i){let{pickedAnnotationBuffer:a}=i;if(a===void 0)return;let{properties:o}=this.base.source;if(o.length===0)return;let{pickedAnnotationBufferOffset:l,pickedAnnotationType:c}=i,d=Sn[c],{rank:p,annotationPropertySerializer:m}=this.base.source,y=d.serializedBytes(p),v=new Array(o.length);return m.deserialize(new DataView(a),l+y,An.LITTLE===eo,v),tD(o[0],v[0])}isReady(){let{base:i}=this,{source:a}=i;if(!(a instanceof $i))return!0;let{value:o}=this.base.segmentationStates;if(o===void 0)return!0;for(let l=0,c=o.length;l<c;++l){let d=o[l];if(d===null)return!1;if(d===void 0)continue;let p=a.segmentFilteredSources[l].chunks,m=!1;if(Ea(d.segmentationGroupState.value,y=>{let v=Fr(y);p.has(v)||(m=!0)}),m)return!1}return!0}}return t}var c2=n=>class extends n{constructor(){super(...arguments);this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,r){let i=this.updateAttachmentState(r);if(this.curRank===0||i===void 0)return;this.updateModelClipBounds(t,i);let{source:a}=this.base;if(a instanceof no){let{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,i)}else{let{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(a.temporary.data,t,i);let{value:l}=this.base.segmentationStates,c=0,d=0;if(l!==void 0)for(let p=0,m=l.length;p<m;++p){let y=l[p];if(y==null)continue;let v=a.segmentFilteredSources[p].chunks;Ea(y.segmentationGroupState.value,b=>{let x=Fr(b),C=v.get(x);if(C!==void 0&&C.state===dt.GPU_MEMORY){let{data:k}=C;if(k===void 0)return;this.drawGeometryChunkData(k,t,i),++c}else++d})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,d)}}},u2=kw(Wr,"perspectiveViewRenderHelper"),Lw=class extends c2(u2){},d2=n=>{class e extends n{constructor(r){super(r.annotationLayer,r.renderScaleHistogram);this.wireFrameRenderHelper=this instanceof Pa?o2:a2;this.wireFrameShaderGetter=ii(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof Pa}`,parameters:Yr(void 0),defineShader:r=>{this.wireFrameRenderHelper.defineShader(r)}});this.renderScaleTarget=r.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let i=this.registerDisposer(new La(this.layerChunkProgressInfo)),a=this.base.chunkManager.rpc;i.RPC_TYPE_ID=KD,i.initializeCounterpart(a,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(Gt.makeFromExisting(a,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Gt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}attach(r){super.attach(r),r.state.sources=r.registerDisposer(ar((i,a,o)=>{let l=op(o,a,c=>this.base.state.source.getSources(c),r.messages,this);for(let c of l)for(let d of c)i.registerDisposer(d.source),Object.assign(d,s2(d.chunkDisplayTransform));return r.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(XD,{layer:this.backend.rpcId,view:r.view.rpcId,sources:rp(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,r.view.displayDimensionRenderInfo))}draw(r,i){let a=this.updateAttachmentState(i);if(this.curRank===0||a===void 0)return;let o=i.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(r,a);let{renderScaleHistogram:l}=this;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:c}=r,d;if(r.wireFrame){let{shader:p}=this.wireFrameShaderGetter(r.emitter);if(p===null)return;p.bind(),this.wireFrameRenderHelper.initialize(p,c),d=p}eP(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(p,m,y,v,b)=>{let x=p.source.chunks.get(p.curPositionInChunks.join()),C;if(x===void 0||x.state!==dt.GPU_MEMORY)C=0;else{let{data:k}=x;if(k===void 0)return;d!==void 0?this.wireFrameRenderHelper.draw(d,p,c):this.drawGeometryChunkData(k,r,a,y),C=1}l.add(v,b,C,1-C)})}}return e},p2=d2(u2),f2=d2(kw(Pa,"sliceViewRenderHelper")),h2=c2(kw(Pa,"sliceViewRenderHelper"));var qp=class extends z{constructor(e,t=()=>K.fromValues(1,0,0)){super();this.model=e;this.getDefaultColor=t;this.element=document.createElement("input");let{element:r}=this;r.classList.add("neuroglancer-color-widget"),r.type="color",r.addEventListener("change",()=>this.updateModel()),r.addEventListener("input",()=>this.updateModel()),r.addEventListener("wheel",i=>{i.stopPropagation(),i.preventDefault(),this.adjustHueViaWheel(i)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!=null?e:this.getDefaultColor()}updateView(){this.element.value=In(this.getRGB())}updateModel(){this.model.value=ga(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),r=K.create();VI(r,t[0],t[1],t[2]);let{deltaY:i}=e,a=Math.round(r[0]*256);a+=i>0?1:i<0?-1:0,a=(a+256)%256,r[0]=a/256,bl(r,r[0],r[1],r[2]),this.model.value=r}};var m2='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="binIconTitle"><path d="M19 6L5 6M14 5L10 5M6 10L6 20C6 20.6666667 6.33333333 21 7 21 7.66666667 21 11 21 17 21 17.6666667 21 18 20.6666667 18 20 18 19.3333333 18 16 18 10"></path></svg>';function Di(n={}){let e=it({svg:m2,...n}),t=e.firstElementChild;return t.style.fill="white",e}var g2=class extends z{constructor(){super(...arguments);this.changed=new re;this.isLoadingChanged=new re;this.states=[];this.relationships=[];this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount==0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let r=e.sourceIndex-t.sourceIndex;return r!==0?r:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let r of t.source.relationships)e.add(r);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}};function BJ(n,e){switch(e.type){case ze.AXIS_ALIGNED_BOUNDING_BOX:case ze.LINE:Mc(n,e.pointA,e.pointB),aD(n,n,.5);break;case ze.POINT:n.set(e.point);break;case ze.ELLIPSOID:n.set(e.center);break}}function y2(n,e,t){e.error===void 0&&n.setLayerPosition(e.modelTransform,t)}function v2(n,e,t){let{layerRank:r}=e,i=new Float32Array(r);Sn[n.type].visitGeometry(n,(a,o)=>{i.set(a);let l=new Float32Array(r);(o?jh:ei)(l,e.chunkToLayerTransform,r+1,i,r),t(l,o)})}var S2=class extends wn{constructor(e,t){super();this.layer=e;this.displayState=t;this.previousSelectedState=void 0;this.previousHoverId=void 0;this.previousHoverAnnotationLayerState=void 0;this.virtualListSource={length:0,render:e=>this.render(e),changed:new qe};this.virtualList=new Rl({source:this.virtualListSource});this.listElements=[];this.updated=!1;this.mutableControls=document.createElement("div");this.headerRow=document.createElement("div");this.attachedAnnotationStates=new Map;this.forceUpdateView=()=>{this.updated=!1,this.updateView()};this.globalDimensionIndices=[];this.localDimensionIndices=[];this.curCoordinateSpaceGeneration=-1;this.prevCoordinateSpaceGeneration=-1;this.columnWidths=[];this.gridTemplate="";this.selectedAnnotationState=ir((e,t)=>{var l;if(e===void 0)return;let{layer:r}=this,i=(l=e.layers.find(c=>c.layer===r))==null?void 0:l.state;if(i===void 0)return;let{annotationId:a}=i;if(a===void 0)return;let o=this.annotationStates.states.find(c=>c.sourceIndex===i.annotationSourceIndex&&(i.annotationSubsource===void 0||c.subsourceId===i.annotationSubsource));if(o!==void 0)return{annotationId:a,annotationLayerState:o,pin:t}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin);this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(e.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let r=document.createElement("div");r.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);let i=this.registerDisposer(new qp(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new lr(ir(y=>y.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),i.element)),r.appendChild(i.element);let{mutableControls:a}=this,o=it({text:Sn[ze.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new Dw(this.layer,{})}});a.appendChild(o);let l=it({text:Sn[ze.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new uy(this.layer,{})}});a.appendChild(l);let c=it({text:Sn[ze.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new dy(this.layer,{})}});a.appendChild(c);let d=it({text:Sn[ze.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new Aw(this.layer,{})}});a.appendChild(d),r.appendChild(a),this.element.appendChild(r),this.element.appendChild(this.headerRow);let{virtualList:p}=this;p.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(p.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let m=FI();this.registerDisposer(new On(this.virtualList.element,m)),this.virtualList.element.title=m.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,r=new Map;for(let[i,a]of t)e.includes(i)||(t.delete(i),a.refCounted.dispose());for(let i of e){let a=t.get(i);if(a!==void 0){r.set(i,a);continue}let o=i.source,l=new z;o instanceof no&&(l.registerDisposer(o.childAdded.add(c=>this.addAnnotationElement(c,i))),l.registerDisposer(o.childUpdated.add(c=>this.updateAnnotationElement(c,i))),l.registerDisposer(o.childDeleted.add(c=>this.deleteAnnotationElement(c,i)))),l.registerDisposer(i.transform.changed.add(this.forceUpdateView)),r.set(i,{refCounted:l,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=r,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,r=[],i=[];for(let a=0,o=t.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[a]!==-1})&&r.push(a);for(let a=0,o=e.rank;a<o;++a)this.annotationStates.states.some(l=>{let c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[a]!==-1})&&i.push(a);(!Ee(r,this.globalDimensionIndices)||!Ee(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=r,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,r=!1){let i=this.attachedAnnotationStates.get(e);if(i==null)return;let a=i.idToIndex.get(t);if(a===void 0)return;let o=i.listOffset+a;return r&&this.virtualList.scrollItemIntoView(a),this.virtualList.getItemElement(o)}clearSelectionClass(){let{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let r=this.getRenderedAnnotationListElement(t,e);r!==void 0&&r.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;let r=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);r!==void 0&&r.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e=this.displayState.hoverState.value,t,r;e!==void 0&&(t=e.id,r=e.annotationLayerState);let{previousHoverId:i,previousHoverAnnotationLayerState:a}=this;if(t===i&&r===a||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=r,t===void 0))return;let o=this.getRenderedAnnotationListElement(r,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:r}=this.listElements[e];return this.makeAnnotationListElement(t,r)}setColumnWidth(e,t){t+=2;let{columnWidths:r}=this;r[e]>t||(r[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:i}=this;i.length=0;let{headerRow:a}=this,o=document.createElement("div");o.style.gridColumn="symbol";let l=document.createElement("div");l.style.gridColumn="delete",We(a),a.appendChild(o);let c=0,d="[symbol] 2ch",p=(v,b)=>{let x=document.createElement("div");x.classList.add("neuroglancer-annotations-view-dimension");let C=document.createElement("span");C.classList.add("neuroglancer-annotations-view-dimension-name"),C.textContent=v.names[b];let k=document.createElement("scale");k.classList.add("neuroglancer-annotations-view-dimension-scale"),k.textContent=Bi(v.scales[b],v.units[b],{precision:2}),x.appendChild(C),x.appendChild(k),x.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,k.textContent.length+C.textContent.length+3),d+=` [dim] var(--neuroglancer-column-${c}-width)`,++c,a.appendChild(x)},m=this.layer.manager.root.coordinateSpace.value;for(let v of this.globalDimensionIndices)p(m,v);let y=this.layer.localCoordinateSpace.value;for(let v of this.localDimensionIndices)p(y,v);a.appendChild(l),d+=" [delete] 2ch",this.gridTemplate=d,a.style.gridTemplateColumns=d,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;t.length=0;for(let[i,a]of this.attachedAnnotationStates){if(i.source.readonly||(e=!0),i.chunkTransform.value.error!==void 0)continue;let{source:o}=i,l=Array.from(o);a.annotations=l;let{idToIndex:c}=a;c.clear();for(let d=0,p=l.length;d<p;++d)c.set(l[d].id,d);for(let d of l)t.push({state:i,annotation:d})}let r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.annotations.length;r.annotations.push(e),r.idToIndex.set(e.id,i);let a=r.listOffset+i;this.listElements.splice(a,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let i=r.idToIndex.get(e.id);if(i!==void 0){let a=r.listOffset+i;r.annotations[i]=e,this.listElements[a].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let r=this.attachedAnnotationStates.get(t);if(r!==void 0){let{idToIndex:i}=r,a=i.get(e);if(a!==void 0){let o=r.listOffset+a,{annotations:l}=r;l.splice(a,1),i.delete(e);for(let c=a,d=l.length;c<d;++c)i.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){let r=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.style.gridTemplateColumns=this.gridTemplate;let a=document.createElement("div");a.className="neuroglancer-annotation-icon",a.textContent=Sn[e.type].icon,i.appendChild(a);let o,l=()=>{t.source.readonly||o===void 0&&(o=Di({title:"Delete annotation",onClick:p=>{p.stopPropagation(),p.preventDefault();let m=t.source.getReference(e.id);try{t.source.delete(m)}finally{m.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(o))},c=0;if(v2(e,r,(p,m)=>{++c;let y=document.createElement("div");y.className="neuroglancer-annotation-position",i.appendChild(y);let v=0,b=(x,C)=>{for(let k of x){let M=C[k];if(M!==-1){let I=Math.floor(p[M]),A=document.createElement("div"),D=I.toString();A.textContent=D,A.classList.add("neuroglancer-annotation-coordinate"),A.style.gridColumn=`dim ${v+1}`,this.setColumnWidth(v,D.length),y.appendChild(A)}++v}};b(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),b(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;let p=document.createElement("div");p.classList.add("neuroglancer-annotation-description"),p.textContent=e.description,i.appendChild(p)}a.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),i.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),i.addEventListener("action:select-position",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),i.addEventListener("action:pin-annotation",p=>{p.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),i.addEventListener("action:move-to-annotation",p=>{p.stopPropagation(),p.preventDefault();let{layerRank:m}=r,y=new Float32Array(m),v=new Float32Array(m);BJ(y,e),ei(v,r.chunkToLayerTransform,m+1,y,m),y2(this.layer,r,v)});let d=this.selectedAnnotationState.value;return d!==void 0&&d.annotationLayerState===t&&d.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}},b2=class extends wn{constructor(e){super();this.layer=e;this.layerView=this.registerDisposer(new S2(this.layer,this.layer.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}};function cy(n){let e=[],{relationships:t}=n.source,{relationshipStates:r}=n.displayState;for(let i=0,a=t.length;i<a;++i){let o=r.get(t[i]).segmentationState.value;if(o!=null&&o.segmentSelectionState.hasSelectedSegment){e[i]=[o.segmentSelectionState.selectedSegment.clone()];continue}e[i]=[]}return e}var Ew=class extends Up{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}},x2="annotatePoint",C2="annotateLine",w2="annotateBoundingBox",T2="annotateSphere",Dw=class extends Ew{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=Jp(e,t);if(r===void 0)return;let i={id:"",description:"",relatedSegments:cy(t),point:r,type:ze.POINT,properties:t.source.properties.map(o=>o.default)},a=t.source.add(i,!0);this.layer.selectAnnotation(t,a.id,!0),a.dispose()}}get description(){return"annotate point"}toJSON(){return x2}};function Jp(n,e){let t=e.chunkTransform.value;if(t.error!==void 0)return;let r=new Float32Array(t.modelTransform.unpaddedRank);if(!!io(r,n.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return r}var Pw=class extends Ew{trigger(e){let{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){let r=()=>{let i=this.inProgressAnnotation,a=i.reference,o=this.getUpdatedAnnotation(a.value,e,t);JSON.stringify(Nh(o,t.source))!==JSON.stringify(Nh(a.value,t.source))&&(i.annotationLayer.source.update(a,o),this.layer.selectAnnotation(t,a.id,!0))};if(this.inProgressAnnotation===void 0){let i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0);let a=e.changed.add(r),o=()=>{a(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:o}}else r(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}},Iw=class extends Pw{getInitialAnnotation(e,t){let r=Jp(e,t);return{id:"",type:this.annotationType,description:"",pointA:r,pointB:r,properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=Jp(t,r);return i===void 0?e:{...e,pointB:i}}},uy=class extends Iw{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),{pointA:a,pointB:o}=i,l=a.length;for(let c=0;c<l;++c)a[c]===o[c]&&(o[c]+=1);return i}toJSON(){return w2}};uy.prototype.annotationType=ze.AXIS_ALIGNED_BOUNDING_BOX;var dy=class extends Iw{get description(){return"annotate line"}getInitialAnnotation(e,t){let r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=cy(t),r}getUpdatedAnnotation(e,t,r){let i=super.getUpdatedAnnotation(e,t,r),a=this.initialRelationships,o=cy(r);return a===void 0?i.relatedSegments=o:i.relatedSegments=Array.from(o,(l,c)=>{let d=a[c];return l=l.filter(p=>d.findIndex(m=>Q.equal(p,m))===-1),[...d,...l]}),i}toJSON(){return C2}};dy.prototype.annotationType=ze.LINE;var Aw=class extends Pw{getInitialAnnotation(e,t){let r=Jp(e,t);return{type:ze.ELLIPSOID,id:"",description:"",segments:cy(t),center:r,radii:K.fromValues(0,0,0),properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){let i=Jp(t,r);if(i===void 0)return e;let a=e.center,o=a.length;for(let l=0;l<o;++l)i[l]=Math.abs(a[l]-i[l]);return{...e,radii:i}}get description(){return"annotate ellipsoid"}toJSON(){return T2}};Fp(x2,(n,e)=>new Dw(n,e));Fp(w2,(n,e)=>new uy(n,e));Fp(C2,(n,e)=>new dy(n,e));Fp(T2,(n,e)=>new Aw(n,e));var UJ=Fe.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function FJ(n,e,t,r){return new Xn(t,(i,a,o)=>{let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),i!=null&&o.registerDisposer(hs(i,l));let c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");let d=Ar({title:"Copy segment IDs",onClick:()=>{Ir(e.map(b=>b.toString()).join(", "))}});c.appendChild(d);let p;if(i!=null&&(p=document.createElement("input"),p.type="checkbox",p.addEventListener("change",()=>{let{visibleSegments:b}=i.segmentationGroupState.value,x=e.some(C=>!b.has(C));for(let C of e)b.set(C,x)}),c.appendChild(p)),r!==void 0){let b=Di({title:"Remove all IDs",onClick:()=>{r([])}});c.appendChild(b)}let m=document.createElement("span");if(m.classList.add("neuroglancer-related-segment-list-title"),m.textContent=n,c.appendChild(m),r!==void 0){let b=$g({title:"Add related segment ID",onClick:()=>{let x=new z,C=o.registerDisposer(mh(x)),k=document.createElement("div");k.classList.add("neuroglancer-segment-list-entry"),k.classList.add("neuroglancer-segment-list-entry-new");let M=Ar({});if(M.classList.add("neuroglancer-segment-list-entry-copy"),k.appendChild(M),i!=null){let V=document.createElement("input");V.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),V.type="checkbox",k.appendChild(V)}let I=Di({title:"Cancel adding new segment ID",onClick:()=>{C()}});I.classList.add("neuroglancer-segment-list-entry-delete"),k.appendChild(I);let A=document.createElement("input");A.autocomplete="off",A.spellcheck=!1,A.classList.add("neuroglancer-segment-list-entry-id");let D=x.registerDisposer(new sn(A,UJ));D.allShortcutsAreGlobal=!0;let E=()=>{let V=new Q;if(V.tryParseString(A.value))return A.dataset.valid="true",V;A.dataset.valid="false"};E(),A.addEventListener("input",()=>{E()}),A.addEventListener("blur",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),ue(A,"cancel",C),ue(A,"commit",()=>{let V=E();V!==void 0&&r([...e,V]),C()}),k.appendChild(A),l.appendChild(k),A.focus(),x.registerDisposer(()=>{A.value="",k.remove()})}});c.appendChild(b)}l.appendChild(c);let y=[],v=Cl.make(i!=null?i:void 0,!1);for(let b of e){let x=v.get(b);if(y.push(x),r!==void 0){let C=Di({title:"Remove ID",onClick:k=>{r(e.filter(M=>!Q.equal(M,b))),k.stopPropagation()}});C.classList.add("neuroglancer-segment-list-entry-delete"),x.children[0].appendChild(C)}l.appendChild(x)}if(i!=null){let b=o.registerCancellable(Ye(()=>{let{visibleSegments:x}=i.segmentationGroupState.value,C=0;for(let k of e)x.has(k)&&++C;for(let k of y)v.update(k);p.checked=C===e.length&&C>0,p.indeterminate=C>0&&C<e.length}));b(),b.flush(),ms(i,o,b),o.registerDisposer(i.segmentationGroupState.changed.add(b))}a.appendChild(l)})}var k2="annotationColor";function hu(n){class e extends n{constructor(...r){super(...r);this.annotationStates=this.registerDisposer(new g2);this.annotationDisplayState=new hw;this.annotationCrossSectionRenderScaleHistogram=new Da;this.annotationCrossSectionRenderScaleTarget=Hi(8);this.annotationProjectionRenderScaleHistogram=new Da;this.annotationProjectionRenderScaleTarget=Hi(8);this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new b2(this)});let i,a=()=>{let l=this.isReady;l&&i!==void 0?(i(),i=void 0):!l&&i===void 0&&(i=this.annotationStates.markLoading())};this.readyStateChanged.add(a),a();let{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){let{pickedAnnotationLayer:l}=o;if(l!==void 0&&this.annotationStates.states.includes(l)){let c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(r){}restoreState(r){super.restoreState(r),this.annotationDisplayState.color.restoreState(r[k2])}captureSelectionState(r,i){super.captureSelectionState(r,i);let a=i.pickedAnnotationLayer;a===void 0||!this.annotationStates.states.includes(a)||(r.annotationId=i.pickedAnnotationId,r.annotationPartIndex=i.pickedOffset,r.annotationSourceIndex=a.sourceIndex,r.annotationSubsource=a.subsourceId)}displayAnnotationState(r,i,a){if(r.annotationId===void 0)return!1;let o=this.annotationStates.states.find(c=>c.sourceIndex===r.annotationSourceIndex&&(r.annotationSubsource===void 0||c.subsourceId===r.annotationSubsource));if(o===void 0)return!1;let l=a.registerDisposer(o.source.getReference(r.annotationId));return i.appendChild(a.registerDisposer(new Xn(a.registerDisposer(new bd(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:d},p,m)=>{if(c==null){let A=document.createElement("div");A.classList.add("neuroglancer-selection-annotation-status"),A.textContent=c===null?"Annotation not found":"Loading...",p.appendChild(A);return}let y=d.error===void 0?d.layerRank:0,v=document.createElement("div");v.classList.add("neuroglancer-selected-annotation-details-position-grid"),v.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${y}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,p.appendChild(v);let b=Sn[c.type],x=document.createElement("div");if(x.className="neuroglancer-selected-annotation-details-icon",x.textContent=b.icon,v.appendChild(x),y!==0){let{layerDimensionNames:A}=d.modelTransform;for(let D=0;D<y;++D){let E=document.createElement("div");E.classList.add("neuroglancer-selected-annotation-details-position-dim"),E.textContent=A[D],E.style.gridColumn=`dim ${D+1}`,v.appendChild(E)}v2(c,d,(D,E)=>{let V=Ar({title:"Copy position",onClick:()=>{Ir(D.map(N=>Math.floor(N)).join(", "))}});V.style.gridColumn="copy",v.appendChild(V);for(let N=0;N<y;++N){let U=document.createElement("div");U.classList.add("neuroglancer-selected-annotation-details-position-coord"),U.style.gridColumn=`coord ${N+1}`,U.textContent=Math.floor(D[N]).toString(),v.appendChild(U)}if(!E){let N=Wm({title:"Move to position",onClick:()=>{y2(this,d,D)}});N.style.gridColumn="move",v.appendChild(N)}})}if(!o.source.readonly){let A=Di({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});A.classList.add("neuroglancer-selected-annotation-details-delete"),v.appendChild(A)}let{relationships:C,properties:k}=o.source,M=o.source.readonly,{relatedSegments:I}=c;for(let A=0,D=C.length;A<D;++A){let E=I===void 0?[]:I[A];if(E.length===0&&M)continue;let V=A,N=C[A];p.appendChild(m.registerDisposer(FJ(N,E,o.displayState.relationshipStates.get(N).segmentationState,M?void 0:U=>{let _=l.value;if(_==null)return;let{relatedSegments:B}=_;B===void 0?B=o.source.relationships.map(()=>[]):B=B.slice(),B[V]=U;let R={..._,relatedSegments:B};o.source.update(l,R),o.source.commit(l)})).element)}for(let A=0,D=k.length;A<D;++A){let E=k[A],V=document.createElement("label");V.classList.add("neuroglancer-annotation-property");let N=document.createElement("span");N.classList.add("neuroglancer-annotation-property-label"),N.textContent=E.identifier,V.appendChild(N);let{description:U}=E;U!==void 0&&(V.title=U);let _=c.properties[A],B=document.createElement("span");switch(B.classList.add("neuroglancer-annotation-property-value"),E.type){case"rgb":{let R=Za(_),X=In(R);B.textContent=X,B.style.backgroundColor=X,B.style.color=Dd(R)?"white":"black";break}case"rgba":{let R=Za(_>>>8);B.textContent=In(Ed(_)),B.style.backgroundColor=In(Za(_>>>8)),B.style.color=Dd(R)?"white":"black";break}default:B.textContent=$S(E,_);break}V.appendChild(B),p.appendChild(V)}if(!o.source.readonly||c.description)if(o.source.readonly){let A=document.createElement("div");A.className="neuroglancer-annotation-details-description",A.textContent=c.description||"",p.appendChild(A)}else{let A=document.createElement("textarea");A.value=c.description||"",A.rows=3,A.className="neuroglancer-annotation-details-description",A.placeholder="Description",A.addEventListener("change",()=>{let D=A.value;o.source.update(l,{...c,description:D||void 0}),o.source.commit(l)}),p.appendChild(A)}})).element),!0}displaySelectionState(r,i,a){let o=this.displayAnnotationState(r,i,a);return super.displaySelectionState(r,i,a)&&(o=!0),o}addLocalAnnotations(r,i,a){let{subsourceEntry:o}=r,l=new pu({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:i,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:a});this.addAnnotationLayerState(l,r)}addStaticAnnotations(r){let{subsourceEntry:i}=r,{staticAnnotations:a}=i.subsource;return a===void 0?!1:(r.activate(()=>{this.addLocalAnnotations(r,a,cr.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(r,i){let a=i.activated;a.registerDisposer(this.annotationStates.add(r));let o=new Tw(this.manager.chunkManager,r.addRef());if(o.source instanceof $i){let l=new f2({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(l.messages));let c=new p2({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});a.registerDisposer(i.messages.addChild(c.messages)),a.registerDisposer(ar((d,p)=>{p&&(d.registerDisposer(this.addRenderLayer(l.addRef())),d.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let l=new h2(o,this.annotationCrossSectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}{let l=new Lw(o.addRef(),this.annotationProjectionRenderScaleHistogram);a.registerDisposer(this.addRenderLayer(l)),a.registerDisposer(i.messages.addChild(l.messages))}}selectAnnotation(r,i,a){this.manager.root.selectionState.captureSingleLayerState(this,o=>(o.annotationId=i,o.annotationSourceIndex=r.sourceIndex,o.annotationSubsource=r.subsourceId,!0),a)}toJSON(){let r=super.toJSON();return r[k2]=this.annotationDisplayState.color.toJSON(),r}}return e}var L2="volume_rendering/VolumeRenderingRenderLayer",E2="volume_rendering/VolumeRenderingRenderLayer/update",py=64,GJ=Ft.create();function D2(n,e,t){let r=0,i=0;for(let d=0;d<3;++d){let p=n[16+d],m=p*e[d],y=p*t[d];r+=Math.min(m,y),i+=Math.max(m,y)}let a=-n[19],o=Math.max(a,r),l=n[23],c=Math.min(l,i);return{near:a,far:l,adjustedNear:o,adjustedFar:c}}function Mw(n,e,t,r,i,a){if(r.length===0)return;let{viewMatrix:o,projectionMat:l,displayDimensionRenderInfo:c}=n,{voxelPhysicalScales:d}=c,p=kd(d),y=(Dh(l)/py)**3,v=Ft.determinant(Ys(GJ,o)),b=D=>{let E=r[D];return Math.abs(E.chunkLayout.detTransform*v)},x=r.length-1,C=b(x);for(let D=x-1;D>=0;--D){let E=b(D);if(Math.abs(E-y)<Math.abs(C-y))C=E,x=D;else break}let k=Math.pow(C*p/v,1/3),M=Math.pow(C,1/3)*n.width/(2*l[0]),I=!0,A=r[x];sm(n,e,A,(D,E)=>{I&&(i(A,x,k,M,E),I=!1),a(A,x,D)})}var WJ=ie.create(),zJ=new Float32Array(24),Rw=class extends Wr{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}constructor(e){super();this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));let t=this.registerDisposer(fn(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=Hd(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l})=>`${St(o)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c},d,p)=>{if(d.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Rr(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addVarying("highp vec4","vNormalizedPosition"),o.addVertexCode(B_),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),Km(o,c,p,"curChunkPosition"),o.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),o.addFragmentCode(vo),Wi(d,o),o.addFragmentCode(`
#define main userMain
`+Fi(d.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(Qn.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:r}=this.multiscaleSource,i=this.registerDisposer(new La(this.layerChunkProgressInfo)),a=r.rpc;i.RPC_TYPE_ID=L2,i.initializeCounterpart(a,{chunkManager:r.rpcId,localPosition:this.registerDisposer(Gt.makeFromExisting(a,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Gt.makeFromExisting(a,this.renderScaleTarget)).rpcId}),this.backend=i}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(ar((t,r,i)=>{let a=op(i,r,o=>this.multiscaleSource.getSources(o),e.messages,this);for(let o of a)for(let l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(E2,{layer:this.backend.rpcId,view:e.view.rpcId,sources:rp(a)}),this.redrawNeeded.dispatch(),a},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;let r=t.state.sources.value;if(r.length===0)return;let i=0,a=0,o=null,l,c,d=K.create(),{gl:p}=this;this.vertexIdHelper.enable();let{renderScaleHistogram:m}=this;m.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let y=()=>{o!==null&&(l!==null&&l.endDrawing(p,o),(C!==0||k!==0)&&m.add(i,a,C,k))},v=!0,{projectionParameters:b}=e,x,C=0,k=0,M,I=this.multiscaleSource.rank,A=K.create();p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),Mw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],(D,E,V,N)=>{i=V,a=N;let U=Fc(b,D.chunkLayout),_=D.source,{fixedPositionWithinChunk:B,chunkDisplayDimensionIndices:R}=D;for(let ge of R)B[ge]=0;let X=_.chunkFormat;if(X!==l&&(l=X,y(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:X}),o=c.shader,o!==null&&(o.bind(),X!==null&&(ai(p,o,this.shaderControlState,c.parameters.parseResult.controls),X.beginDrawing(p,o),X.beginSource(p,o)))),M=void 0,o===null)return;x=_.chunks,d.fill(1);let j=ie.multiply(WJ,b.viewProjectionMat,U.transform);p.uniformMatrix4fv(o.uniform("uModelViewProjectionMatrix"),!1,j);let oe=zJ;Ks(oe,j),ie.invert(j,j),p.uniformMatrix4fv(o.uniform("uInvModelViewProjectionMatrix"),!1,j);let{near:me,far:xe,adjustedNear:se,adjustedFar:Se}=D2(oe,D.lowerClipDisplayBound,D.upperClipDisplayBound),je=(Se-se)/(py-1)/(xe-me);p.uniform1f(o.uniform("uBrightnessFactor"),je);let Be=(se-me)/(xe-me),Pe=(Se-me)/(xe-me);p.uniform1f(o.uniform("uNearLimitFraction"),Be),p.uniform1f(o.uniform("uFarLimitFraction"),Pe),p.uniform1i(o.uniform("uMaxSteps"),py),p.uniform3fv(o.uniform("uLowerClipBound"),D.lowerClipDisplayBound),p.uniform3fv(o.uniform("uUpperClipBound"),D.upperClipDisplayBound)},D=>{if(o===null)return;let E=D.curPositionInChunks.join(),V=x.get(E);if(V!==void 0&&V.state===dt.GPU_MEMORY){let N=D.chunkLayout.size,U=V.chunkDataSize,{chunkDisplayDimensionIndices:_,fixedPositionWithinChunk:B,chunkTransform:{channelToChunkDimensionIndices:R}}=D,{}=D;if(U!==M){M=U;for(let j=0;j<3;++j){let oe=_[j];d[j]=oe===-1||oe>=I?1:M[oe]}p.uniform3fv(o.uniform("uChunkDataSize"),d)}let{chunkGridPosition:X}=V;for(let j=0;j<3;++j){let oe=_[j];A[j]=oe===-1||oe>=I?0:N[j]*X[oe]}l!=null&&l.bindChunk(p,o,V,B,_,R,v),v=!1,p.uniform3fv(o.uniform("uTranslation"),A),U_(p,1,1),++C}else++k}),p.disable(WebGL2RenderingContext.CULL_FACE),y(),this.vertexIdHelper.disable()}isReady(e,t){let r=t.state.sources.value;if(r.length===0)return!0;let i=!1;return Mw(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},a=>{let o=a.source.chunks.get(a.curPositionInChunks.join());(o===void 0||o.state!==dt.GPU_MEMORY)&&(i=!0)}),i}};var HJ=Fe.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}}),P2=class{constructor(e){this.id=e;this.element=document.createElement("div");this.nameContainer=document.createElement("div");this.nameElement=document.createElement("input");this.lowerElement=document.createElement("div");this.upperElement=document.createElement("div");let{element:t,nameContainer:r,nameElement:i,lowerElement:a,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),r.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),r.appendChild(i),a.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(r),t.appendChild(a),t.appendChild(o),r.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",r.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.addEventListener("dblclick",()=>{i.disabled=!1,i.focus(),i.select()}),i.addEventListener("focus",()=>{i.select()})}},_w=class extends z{constructor(e){super();this.combiner=e;this.element=document.createElement("div");this.dimensionWidgets=[];this.curCoordinateSpace=void 0;this.dragSource=void 0;this.coordinateSpace=this.combiner.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let r=this.registerCancellable(Ye(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(r));let i=this.registerDisposer(new sn(t,HJ));i.allShortcutsAreGlobal=!0,this.registerDisposer(ue(t,"cancel",a=>{this.forceUpdateView();let{target:o}=a;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this;r.value=Zh(r.value,e,t)}makeNewDimensionWidget(e){let t=new P2(e);return t.nameContainer.addEventListener("dragstart",r=>{this.dragSource=t,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",r=>{let{dragSource:i}=this;if(i===void 0||i===t)return;let{dimensionWidgets:a}=this,o=a.indexOf(i),l=a.indexOf(t);o===-1||l===-1||(r.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",r=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",r=>{t.nameElement.disabled=!0;let{relatedTarget:i}=r;this.dimensionWidgets.some(a=>a.nameElement===i)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{let{nameElement:r}=t;Vn(r),this.updateNameValidity()}),ue(t.nameElement,"commit",()=>{this.updateNames()}),ue(t.nameElement,"tab-forward",r=>this.selectAdjacentField(r,t,1)),ue(t.nameElement,"tab-backward",r=>this.selectAdjacentField(r,t,-1)),t}selectAdjacentField(e,t,r){e.stopPropagation();let{dimensionWidgets:i}=this,a=i.indexOf(t);if(a===-1)return;let o=a+r;if(o<0||o>=i.length)return;let l=i[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(Ee(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,r=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map(o=>r.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*a(){let{names:o,rank:l,bounds:{lowerBounds:c,upperBounds:d}}=e;for(let p=0;p<l;++p){let m=i[p];m.nameElement.value=o[p],delete m.nameElement.dataset.isValid,Vn(m.nameElement),m.lowerElement.textContent=c[p].toString(),m.upperElement.textContent=d[p].toString(),yield m.element}}Yn(t,a.call(this))}};function ks(n={}){return it({text:"?",...n})}function I2(n,e,t,r){let i=document.createElement("label");i.classList.add("neuroglancer-layer-control-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-container");let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),a.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),i.appendChild(a);let{control:c,controlElement:d}=t.makeControl(e,n,{labelContainer:a,labelTextContainer:l,display:e.manager.root.display,visibility:r});return d.classList.add("neuroglancer-layer-control-control"),i.appendChild(d),{controlContainer:i,label:o,labelContainer:a,labelTextContainer:l,control:c}}var fy=class extends Co{constructor(e,t){super(e);this.options=t}activate(e){let{options:t}=this,{layer:r}=this,{isValid:i}=t;if(i!==void 0&&!i(r).value)return;let{header:a,body:o}=Gp(e),{controlContainer:l,control:c,labelContainer:d}=I2(e,r,t,new Vt(Vt.VISIBLE));a.appendChild(d),o.appendChild(l),t.activateTool(e,c)}get description(){var t;let{options:e}=this;return(t=e.toolDescription)!=null?t:e.label}toJSON(){return this.options.toolJson}};function A2(n,e,t,r){let{controlContainer:i,label:a}=I2(n,e,t,r);return i.classList.add("neuroglancer-layer-options-control-container"),a.prepend(n.registerDisposer(new Yg(e,t.toolJson)).element),i}function mu(n,e,t,r){let{isValid:i}=r;return i===void 0?A2(n,e,r,t):n.registerDisposer(new Xn(i(e),(a,o,l)=>{!a||o.appendChild(A2(l,e,r,t))},t)).element}function hy(n,e){let{toolJson:t}=e,r=typeof t=="string"?t:t.type;_l(n,r,i=>new fy(i,e))}function Ls(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Lr(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}var Yp=class extends z{constructor(e){super();this.model=e;this.element=document.createElement("select");this.valueIndexMap=new Map;let{element:t,valueIndexMap:r}=this,i=0;for(let a of Object.keys(e.enumType))if(isNaN(Number(a))){let o=document.createElement("option");o.textContent=o.value=a.toLowerCase(),t.appendChild(o),r.set(e.enumType[a],i),++i}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",a=>{a.preventDefault(),a.stopPropagation(),this.adjustViaWheel(a)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:r}=e;r>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):r<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}};var $J=Fe.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function my(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new Yp(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap($J),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)})}}}var Vw=class extends z{constructor(e,{min:t=0,max:r=1,step:i=.01}={}){super();this.value=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");this.numericInputElement=document.createElement("input");let{element:a,inputElement:o,numericInputElement:l}=this;a.className="range-slider";let c=p=>{p.min=""+t,p.max=""+r,p.step=""+i,p.valueAsNumber=this.value.value,this.registerEventListener(p,"change",()=>this.inputValueChanged(p)),this.registerEventListener(p,"input",()=>this.inputValueChanged(p)),this.registerEventListener(p,"wheel",m=>{this.adjustViaWheel(p,m)})};o.type="range",c(o),l.type="number";let d=Math.max(t.toString().length,r.toString().length,Math.min(r,t+i).toString().length,Math.max(t,r-i).toString().length);l.style.width=d+2+"ch",c(l),a.appendChild(o),a.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let r=this.inputElement,{deltaY:i}=t;i>0?(r.stepUp(),this.inputValueChanged(e)):i<0&&(r.stepDown(),this.inputValueChanged(e))}disposed(){ut(this.element),super.disposed()}};var jJ=Fe.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function na(n){return{makeControl:(e,t)=>{let{value:r,options:i}=n(e),a=t.registerDisposer(new Vw(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(jJ),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(t.inputElement,r.detail)})}}}var M2='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="maximiseIconTitle"><polyline points="21 16 21 21 16 21"></polyline><polyline points="8 21 3 21 3 16"></polyline><polyline points="16 3 21 3 21 8"></polyline><polyline points="3 8 3 3 8 3"></polyline></svg>';function Es(n={}){return it({svg:M2,...n})}var R2=rt(Ct()),_2=rt(Pl());function gy(n,e){let t="";for(let r=0;r<=e&&(t=n.toFixed(r),parseFloat(t)!==n);++r);return t}var qJ=200,V2=Fe.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function JJ(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${gy(t,1)}p${e}`}return Math.round(n)+""}var Kp=class extends z{constructor(e,t){super();this.histogram=e;this.target=t;this.label=document.createElement("div");this.element=document.createElement("div");this.canvas=document.createElement("canvas");this.legend=document.createElement("div");this.legendRenderScale=document.createElement("div");this.legendSpatialScale=document.createElement("div");this.legendChunks=document.createElement("div");this.ctx=this.canvas.getContext("2d");this.hoverTarget=new Ge(void 0);this.throttledUpdateView=this.registerCancellable((0,_2.default)(()=>this.debouncedUpdateView(),qJ,{leading:!0,trailing:!0}));this.debouncedUpdateView=this.registerCancellable((0,R2.default)(()=>this.updateView(),0));let{canvas:r,label:i,element:a,legend:o,legendRenderScale:l,legendSpatialScale:c,legendChunks:d}=this;i.className="neuroglancer-render-scale-widget-prompt",a.className="neuroglancer-render-scale-widget",a.title=V2.describe(),o.className="neuroglancer-render-scale-widget-legend",a.appendChild(i),a.appendChild(r),a.appendChild(o),l.title="Target resolution of data in screen pixels",d.title="Number of chunks rendered",o.appendChild(l),o.appendChild(d),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new On(r,V2)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let p=y=>{let v=y.offsetX/r.width*bn;return uI(v)};this.registerEventListener(r,"pointermove",y=>{this.hoverTarget.value=[p(y),y.offsetY]}),this.registerEventListener(r,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ue(r,"set",y=>{this.target.value=p(y.detail)})),this.registerDisposer(ue(r,"adjust-via-wheel",y=>{this.adjustViaWheel(y.detail)})),this.registerDisposer(ue(r,"reset",y=>{this.reset(),y.preventDefault()}));let m=new ResizeObserver(()=>this.debouncedUpdateView());m.observe(r),this.registerDisposer(()=>m.disconnect()),this.updateView()}adjustViaWheel(e){let{deltaY:t}=e;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**Math.sign(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let{ctx:e}=this,{canvas:t}=this,r=t.width=t.offsetWidth,i=t.height=t.offsetHeight,a=this.target.value,o=this.hoverTarget.value;{let{legendRenderScale:E}=this,V=o===void 0?a:o[0],N=JJ(V);E.textContent=N+" px"}function l(E){return E*r/bn}e.clearRect(0,0,r,i);let{histogram:c}=this,{value:d,spatialScales:p}=c;c.visibility.visible||d.fill(0);let m=Array.from(p.keys());m.sort();let y=K.create(),v=1,b=p.size,x=0,C=0;for(let E=0;E<bn;++E){let V=0;for(let N=0;N<b;++N){let U=N*bn*2+E,_=d[U],B=d[U+bn];x+=_,C+=B,V+=_+B}v=Math.max(V,v)}let M=i/Math.log(1+v);function I(E){return i-Math.log(1+E)*M}let A;if(o!==void 0){let E=Math.floor(np(o[0]));if(E>=0&&E<bn){let V=0,N=o[1];for(let U=b-1;U>=0;--U){let _=m[U],B=p.get(_),R=2*B*bn+E,X=d[R]+d[R+bn];if(X===0)continue;let j=Math.round(I(V));if(V+=X,Math.round(I(V))<=N&&N<=j){A=_;break}}}}if(A!==void 0){x=0,C=0;let E=p.get(A),V=2*E*bn;for(let N=0;N<bn;++N){let U=V+N;x+=d[U],C+=d[U+bn]}Number.isFinite(A)?this.legendSpatialScale.textContent=Bi(A,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${x}/${x+C}`;let D=m.map(E=>{let V=E===A?.5:1,N;Number.isFinite(E)?N=(Math.log2(E)*.1%1+1)%1:N=0,bl(y,N,V,1);let U=In(y);bl(y,N,V,.5);let _=In(y);return[U,_]});for(let E=0;E<bn;++E){let V=0;for(let N=b-1;N>=0;--N){let U=m[N],B=p.get(U)*bn*2+E,R=d[B],X=d[B+bn],j=R+X;if(j===0)continue;let oe=Math.round(l(E)),me=Math.round(l(E+1)),xe=Math.round(I(V));V+=j;let se=Math.round(I(V)),Se=(R*se+X*xe)/j;e.fillStyle=D[N][1],e.fillRect(oe,se,me-oe,Se-se),e.fillStyle=D[N][0],e.fillRect(oe,Se,me-oe,xe-Se)}}{let E=a;e.fillStyle="#fff";let V=l(np(E)),N=1;e.fillRect(Math.floor(V),0,N,i)}if(o!==void 0){let E=o[0];e.fillStyle="#888";let V=l(np(E)),N=1;e.fillRect(Math.floor(V),0,N,i)}}},YJ=Fe.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function gu(n){return{makeControl:(e,t)=>{let{histogram:r,target:i}=n(e),a=t.registerDisposer(new Kp(r,i));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(YJ),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)}),e.bindAction("reset",r=>{r.stopPropagation(),r.preventDefault(),t.reset()})}}}var Ske=rt(B2());var Ul=rt(Ds()),G2=rt(F2()),W2=rt(Ct());(0,G2.default)(Ul.default);var KJ=500,ko=class extends z{constructor(e){super();this.state=e;this.changingValue=!1;this.debouncedValueUpdater=(0,W2.default)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},KJ);this.textEditor=(0,Ul.default)(i=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let r=new IntersectionObserver(i=>{i.some(a=>a.isIntersecting)&&this.textEditor.refresh()},{root:document.body});r.observe(this.element),this.registerDisposer(()=>r.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){let{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value,r,{shaderControlState:i}=this.state;i!==void 0?r=i.parseErrors.value:r=[],t===void 0&&r.length===0?this.setValidState(void 0):t!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{let a=[];for(let o of r)a.push({message:o.message,severity:"error",from:Ul.default.Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(let o of t.errorMessages)a.push({message:o.message,severity:"error",from:Ul.default.Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?a.push({message:t.log,severity:"error",from:Ul.default.Pos(0)}):a.push({message:t.message,severity:"error",from:Ul.default.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,ut(this.element),this.textEditor=void 0,super.disposed()}};var jw=rt(Ct());var XJ=0,QJ=1,ZJ=2;function Fl(n){let e=0,{deltaMode:t}=n;switch(t){case XJ:e=1/200;break;case QJ:e=1/10;break;case ZJ:e=2;break}return Math.exp(n.deltaY*e)}var z2=Fe.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}}),yy=class extends z{constructor(e,t,r,i){super();this.element=e;this.dataType=t;this.getModel=r;this.setModel=i;e.title=z2.describe(),this.registerDisposer(new On(e,z2)),ue(e,"set",a=>{let o=a.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;let d=Zs(l.window,l.range),p=Q1(d,c),m=y=>{let v=this.getModel();this.setModel(Xp(v,"range",p,y))};m(c),Kn(o,y=>{let v=this.getTargetValue(y);v!==void 0&&m(v)})}),ue(e,"adjust-window-via-drag",a=>{let o=a.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),d=l<.5?0:1,p=m=>{let y=this.getModel();this.setModel(Xp(y,"window",d,m))};Kn(o,m=>{let y=this.getModel().window,v=this.getTargetFraction(m);p(d===0?va([c,y[1]],this.dataType,-v/(1-v)):va([y[0],c],this.dataType,1/v))})}),ue(e,"zoom-via-wheel",a=>{let o=a.detail,l=Fl(o),c=this.getTargetFraction(o),{dataType:d}=this,p=this.getModel(),m=va(p.window,d,c*(1-l)),y=va(p.window,d,(1-c)*l+c);this.setModel({...p,window:[m,y],range:p.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return va(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(!!Number.isFinite(t))return this.getWindowLerp(t)}},H2=Symbol("histogramSamplerTexture");function Xp(n,e,t,r,i=!1){let a={...n},o=n[e];if(a[e]=[o[0],o[1]],a[e][t]=r,e==="window"&&kr(r,o[1-t])*(2*t-1)<0&&(a[e][1-t]=r),e==="range"&&i){let l=[n.window[0],n.window[1]];for(let c=0;c<2;++c)kr(r,l[c])*(2*c-1)>0&&(l[c]=r);a.window=l}return a}var e8=254,Qp=e8+1,$2=class extends Wh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.controller=this.registerDisposer(new yy(this.element,this.parent.dataType,()=>this.parent.trackable.value,e=>{this.parent.trackable.value=e}));this.dataValuesBuffer=this.registerDisposer(lo(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(Qp*ki);for(let t=0;t<Qp;++t)for(let r=0;r<ki;++r)e[t*ki+r]=t;return e})).value;this.lineShader=this.registerDisposer((()=>{let e=new ri(this.gl);return pr(e),e.addTextureSampler("sampler2D","uHistogramSampler",H2),e.addOutputBuffer("vec4","out_color",0),e.addAttribute("uint","aDataValue"),e.addUniform("float","uBoundsFraction"),e.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),e.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Qp-1} ? cumSum : total;
if (dataValue == ${Qp-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),e.build()})());this.regionCornersBuffer=ts(this.gl,0,-1,1,1);this.regionShader=this.registerDisposer((()=>{let e=new ri(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){let{lineShader:e,gl:t,regionShader:r,parent:{dataType:i,trackable:{value:a}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{r.bind(),t.uniform4f(r.uniform("uColor"),.2,.2,.2,1);let o=Ur(a.window,a.range[0]),l=Ur(a.window,a.range[1]),c=Pc(i,a.window);t.uniform2f(r.uniform("uBounds"),Math.min(o,l)*c,Math.max(o,l)*c+(1-c));let d=r.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(d,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(d)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:o}=this;e.bind(),hr(e,{width:o.logicalWidth,height:o.logicalHeight},1);let l=e.textureUnit(H2);t.uniform1f(e.uniform("uBoundsFraction"),Pc(i,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),co(t);let c=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(c,1,WebGL2RenderingContext.UNSIGNED_BYTE),fr(t,Qp,1),t.disableVertexAttribArray(c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}};function t8(){}var j2=class extends Wh{constructor(e){super(e.display,document.createElement("div"),e.visibility);this.parent=e;this.cornersBuffer=ts(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let r=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=ii(this,this.gl,{...r,memoizeKey:{id:"colorLegendShader",base:r.memoizeKey},defineShader:(i,a,o)=>{i.addOutputBuffer("vec4","v4f_fragData0",0),i.addAttribute("vec2","aVertexPosition"),i.addUniform("float","uLegendOffset"),i.addVarying("float","vLinearPosition"),i.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let l=this.parent.dataType,c=Xt(l);i.addFragmentCode(OP(i,"ng_colorLegendLerp",l)),i.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${c} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${c} getDataValue(int dummyChannel) {
  return getDataValue();
}
${c} getInterpolatedDataValue() {
  return getDataValue();
}
${c} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),r.defineShader(i,a,o)}})}drawIndirect(){let e=this.shaderGetter(t8),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();let{gl:r}=this;r.clearColor(0,0,0,0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),r.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:i}},dataType:a}=this.parent;Gc(t,"ng_colorLegendLerp",this.parent.dataType,i);let o=Z1(a,i);r.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.disable(WebGL2RenderingContext.STENCIL_TEST);let l=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT),r.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),r.disableVertexAttribArray(l)}isReady(){return!0}};function q2(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${n}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=n==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function J2(n,e,t){let r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${n}-bounds`);let i=[q2(n,0),q2(n,1)];for(let o=0;o<2;++o){let l=i[o];l.addEventListener("input",()=>{Y2(l)}),l.addEventListener("change",()=>{let c=t.value,d=c[n];try{let p=to(e,l.value);t.value=Xp(c,n,o,p,!0)}catch{Bw(l,d[o])}})}let a;return r.appendChild(i[0]),r.appendChild(i[1]),n==="range"&&(a=[document.createElement("div"),document.createElement("div"),document.createElement("div")],a[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(a[0],i[0]),r.insertBefore(a[1],i[1]),r.appendChild(a[2])),{container:r,inputs:i,spacers:a}}function Y2(n){Vn(n,Math.max(1,n.value.length+.1))}function Bw(n,e){let t;e instanceof Q||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),n.value=t,Y2(n)}function Uw(n){let e=n.value,{range:t}=e;n.value={...e,range:[t[1],t[0]]}}function K2(n,e,t){let r=e.value,i=va(r.range,n,.5-t/2),a=va(r.range,n,.5+t/2);e.value={...r,range:[i,a]}}function X2(n,e,t,r,i){let a=Math.exp(i),o=e.value,l=va(t,n,.5-a/2+r),c=va(t,n,.5+a/2+r);e.value={...o,range:[l,c]}}var Fw=class extends wn{constructor(e,t,r,i,a,o,l){super(e);this.display=t;this.dataType=r;this.trackable=i;this.histogramSpecifications=a;this.histogramIndex=o;this.legendShaderOptions=l;this.cdfPanel=this.registerDisposer(new $2(this));this.boundElements={range:J2("range",this.dataType,this.trackable),window:J2("window",this.dataType,this.trackable)};this.registerDisposer(a.visibility.add(this.visibility));let{element:c,boundElements:d}=this;if(l!==void 0){let m=this.registerDisposer(new j2(this));c.appendChild(m.element)}let p=m=>{let y=it({svg:m,title:"Invert range",onClick:()=>{this.invertRange()}});return d.range.spacers[1].appendChild(y),y};this.invertArrows=[p(Nm),p(Om)],c.appendChild(d.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(d.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(Ye(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){Uw(this.trackable)}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:r}=this;for(let m=0;m<2;++m)Bw(e.range.inputs[m],t.range[m]),Bw(e.window.inputs[m],t.window[m]);let i=kr(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";let a=Zs(t.window,t.range),o=e.range.spacers,l=Pc(r,t.window),c=Ur(t.window,a[i?1:0])*l,d=Ur(t.window,a[i?0:1])*l+(1-l);o[i?2:0].style.width=`${c*100}%`,o[i?0:2].style.width=`${(1-d)*100}%`;let{invertArrows:p}=this;p[i?1:0].style.display="",p[i?0:1].style.display="none"}};var Zp="neuroglancer-position",Q2=Fe.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),n8=[n=>n.nameElement,n=>n.coordinate,n=>n.scaleElement];function vy(n,e){let t=n.coordinateArrays[e];return t===void 0?t:n.units[e]!=""||n.scales[e]!==1?null:t}var Z2=class{constructor(e,t){this.coordinateSpace=e;this.container=document.createElement("div");this.nameContainer=document.createElement("span");this.nameElement=document.createElement("input");this.scaleContainer=document.createElement("span");this.scaleElement=document.createElement("input");this.coordinate=document.createElement("input");this.coordinateLabel=document.createElement("span");this.coordinateLabelWidth=0;this.dropdownOwner=void 0;this.modified=!1;this.draggingPosition=!1;this.hasFocus=!1;let{container:r,scaleElement:i,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:c,coordinateLabel:d}=this;r.title="",r.classList.add("neuroglancer-position-dimension"),r.draggable=!0,r.tabIndex=-1,r.appendChild(c),r.appendChild(i),c.appendChild(l),c.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(i),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),i.classList.add("neuroglancer-position-dimension-scale"),i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",r.appendChild(a),r.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let p=vy(e,t);if(p!=null){let m=0;for(let y of p.labels)m=Math.max(m,y.length);this.coordinateLabelWidth=m,d.style.width=`${m+2}ch`,r.appendChild(d)}o.required=!0,o.placeholder=" ",d.classList.add("neuroglancer-position-dimension-coordinate-label")}};function Gw(n,e,t,r){return Math.floor((n-e)*(r-1)/(t-e))}function r8(n,e,t){let{boundingBoxes:r,bounds:i}=n,a=Math.floor(i.lowerBounds[e]),o=Math.ceil(i.upperBounds[e]-1);if(!Number.isFinite(a)||!Number.isFinite(o))return;let l=[],c=p=>Gw(p,a,o,t),{rank:d}=n;for(let p of r){let m=lb(p,e,d);m!==void 0&&(m.lower=c(m.lower),m.upper=c(Math.ceil(m.upper-1)),l.push(m))}return l.sort((p,m)=>{let y=p.lower-m.lower;return y!==0?y:m.upper-m.upper}),fh(l,(p,m)=>{if(m===0)return!0;let y=l[m-1];return y.lower!==p.lower||y.upper!==p.upper}),{lowerBound:a,upperBound:o,normalizedBounds:l}}var Ww=10,zw=15,i8=10,Hw=Ww+zw+i8;function a8(n,e,t){e.clearRect(0,0,n.width,n.height);let{normalizedBounds:r}=t;function i(o){e.fillRect(0,o,Ww,1)}e.fillStyle="#fff";for(let{lower:o,upper:l}of r)i(o),i(l);let a=r.length;e.fillStyle="#ccc";for(let o=0;o<a;++o){let{lower:l,upper:c}=r[o],d=Math.floor(o*zw/a),p=Math.max(1,zw/a);e.fillRect(d+Ww,l,p,c+1-l)}}function eV(n,e){Vn(n,e.length+1)}function tV(n){let{value:e}=n;Vn(n),n.parentElement.dataset.isEmpty=e===""?"true":"false"}var Ps=class extends z{constructor(e,t,{copyButton:r=!0}={}){super();this.position=e;this.combiner=t;this.element=document.createElement("div");this.dimensionContainer=document.createElement("div");this.coordinateSpace=void 0;this.dimensionWidgets=new Map;this.dimensionWidgetList=[];this.dragSource=void 0;let{element:i,dimensionContainer:a}=this;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(Ye(()=>this.updateDimensions())))),i.className="neuroglancer-position-widget",a.style.display="contents",i.appendChild(a),r){let l=Ar({title:"Copy position to clipboard",onClick:()=>{let c=Ir(this.getPositionText());Ke.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(Zp,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,i.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(Ye(()=>this.updateView()))));let o=this.registerDisposer(new sn(i,Q2));o.allShortcutsAreGlobal=!0,this.registerDisposer(new On(i,Q2)),this.registerDisposer(ue(i,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:c}=l;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let r=document.createElement("canvas"),i=r.getContext("2d"),a=document.createElement("div"),o=document.createElement("div");o.appendChild(a);let l=document.createTextNode("");a.appendChild(l);let c=document.createElement("div"),d=document.createElement("div");o.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),d.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(o),t.appendChild(c),t.appendChild(d),t.appendChild(r);let p=100;r.width=Hw,r.height=p,c.style.marginTop=`${p-1}px`;let m,y,v,b=()=>{let I=this.dimensionWidgetList.indexOf(e);if(I===-1)return;let{coordinateSpace:A}=e,D=r8(A,I,p);if(D===void 0||A.bounds.lowerBounds[I]+1===A.bounds.upperBounds[I]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";let{lowerBound:E,upperBound:V}=D;m=E,y=V,l.textContent=E.toString(),c.textContent=V.toString(),a8(r,i,D);let N=this.position.value[I];if(N>=E&&N<=V&&(i.fillStyle="#f66",i.fillRect(0,Gw(N,E,V,p),Hw,1)),v!==void 0&&v>=E&&v<=V){i.fillStyle="#66f";let U=Gw(v,E,V,p);i.fillRect(0,U,Hw,1),d.textContent=v.toString();let _=a.clientHeight;a.style.visibility=U>_?"":"hidden",c.style.visibility=U<p-_?"":"hidden",d.style.display="",d.style.visibility="visible",d.style.marginTop=`${U}px`}else a.style.visibility="",d.style.display="none",c.style.visibility=""},x=e.dropdownOwner,C=x.registerCancellable(Ye(b));x.registerDisposer(this.position.changed.add(C));let k=I=>{if(m===void 0||y===void 0)return;let A=r.getBoundingClientRect(),D=(I.clientY-A.top)/A.height;return D=Math.max(0,D),D=Math.min(1,D),Math.round(D*(y-m))+m},M=I=>{let A=this.dimensionWidgetList.indexOf(e);if(A===-1)return;let D=k(I);if(D===void 0)return;let{position:E}=this,V=E.value;V[A]=D+.5,e.modified=!1,E.value=V};r.addEventListener("pointermove",I=>{v=k(I),C()}),r.addEventListener("pointerleave",()=>{v=void 0,C()}),r.addEventListener("pointerdown",I=>{I.preventDefault(),I.stopPropagation(),!(I.ctrlKey||I.altKey||I.shiftKey||I.metaKey)&&(Kn(I,A=>{e.dropdownOwner!==void 0&&(v=void 0,M(A),C(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),M(I))}),b()}openCoordinateArrayDropdown(e,t,r){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:i,labels:a}=r,o=[],l=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let c=0;c<l;++c){let d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let p=document.createElement("div");p.classList.add("neuroglancer-dimension-dropdown-coordinate");let m=document.createElement("div");m.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),m.textContent=a[c],p.textContent=i[c].toString(),d.appendChild(p),d.appendChild(m),d.addEventListener("click",()=>{let y=this.dimensionWidgetList.indexOf(e);if(y===-1)return;let{position:v}=this,b=v.value;b[y]=i[c]+.5,e.modified=!1,v.value=b}),t.appendChild(d),o.push({entryElement:d,coordinateElement:p,labelElement:m})}}openDropdown(e){if(e.dropdownOwner!==void 0)return;let t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();let r=e.dropdownOwner=new z,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),i.addEventListener("pointerenter",()=>{e.hasFocus=!0}),i.tabIndex=-1,e.container.appendChild(i);let a=vy(e.coordinateSpace,t);a==null?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,a),this.widgetWithOpenDropdown=e,r.registerDisposer(()=>{ut(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),r.registerEventListener(document,"pointerdown",o=>{let{target:l}=o;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;let{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let r=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(r===null)break;if(r[1]!==void 0&&document.execCommand("insertText",void 0,r[1]),r[2]!==void 0){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a===-1||a+1===i.length)break;let o=t.substring(r[0].length);e=i[a+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:r}=this.position;r.value=Zh(r.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){let r=new Z2(e,t);r.container.addEventListener("dragstart",i=>{this.dragSource=r,i.stopPropagation(),i.dataTransfer.setData("neuroglancer-dimension","")}),r.container.addEventListener("dragenter",i=>{let{dragSource:a}=this;if(a===void 0||a===r)return;let{dimensionWidgetList:o}=this,l=o.indexOf(a),c=o.indexOf(r);l===-1||c===-1||(i.preventDefault(),this.reorderDimensionTo(c,l))}),r.container.addEventListener("dragend",i=>{this.dragSource===r&&(this.dragSource=void 0)}),r.nameContainer.addEventListener("dblclick",()=>{r.nameElement.disabled=!1,r.nameElement.focus(),r.nameElement.select()}),r.scaleContainer.addEventListener("dblclick",()=>{r.scaleElement.disabled=!1,r.scaleElement.focus(),r.scaleElement.select()}),r.coordinate.addEventListener("focus",()=>{r.coordinate.select()}),r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",i=>{let{relatedTarget:a}=i;a instanceof Node&&r.container.contains(a)||(r.hasFocus=!1,this.updateDropdownVisibility(r))}),r.container.addEventListener("click",i=>{(!(i.target instanceof HTMLInputElement)||i.target.disabled)&&r.coordinate.focus()}),r.coordinate.addEventListener("paste",i=>{let a=r.coordinate,o=a.value,{clipboardData:l}=i;if(l===null)return;let c=l.getData("text"),{selectionEnd:d,selectionStart:p}=a;if(p!==0||d!==o.length){p==null&&(p=0),d==null&&(d=0);let m=c.match(/[^\-0-9\.]/);m!==null&&(c=c.substring(0,m.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(r,c);i.preventDefault(),i.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;let i=r.coordinate,a=i.value,{selectionDirection:o,selectionEnd:l,selectionStart:c}=i;c===null&&(c=0),l===null&&(l=c);let d="",p=/[^\-0-9\.]/g;d+=a.substring(0,c).replace(p,"");let m=d.length;d+=a.substring(c,l).replace(p,"");let y=d.length;d+=a.substring(l).replace(p,""),i.value=d,i.selectionStart=m,i.selectionEnd=y,i.selectionDirection=o,eV(i,d),l===c&&l===a.length&&a.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{let{nameElement:i}=r;Vn(i),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{let{scaleElement:i}=r;tV(i),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",i=>{let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.coordinate===a)||r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",i=>{r.nameElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.nameElement===a)||this.updateNames()||this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",i=>{r.scaleElement.disabled=!0;let{relatedTarget:a}=i;this.dimensionWidgetList.some(o=>o.scaleElement===a)||this.updateScales()||this.forceUpdateDimensions()}),ue(r.container,"adjust-via-wheel",i=>{let a=i.detail,{deltaY:o}=a;o!==0&&this.adjustDimension(r,Math.sign(o))}),ue(r.container,"adjust-up",()=>{this.adjustDimension(r,-1)}),ue(r.container,"adjust-down",()=>{this.adjustDimension(r,1)});for(let i of n8){let a=i(r);ue(a,"maybe-tab-forward",o=>{this.handleLeftRightMovement(o,r,1,i)}),ue(a,"maybe-tab-backward",o=>{this.handleLeftRightMovement(o,r,-1,i)}),ue(a,"tab-forward",()=>{this.selectAdjacentField(r,1,i)}),ue(a,"tab-backward",()=>{this.selectAdjacentField(r,-1,i)})}return ue(r.coordinate,"commit",()=>{this.updatePosition()}),ue(r.nameElement,"commit",()=>{this.updateNames()}),ue(r.scaleElement,"commit",()=>{this.updateScales()}),ue(r.coordinate,"delete-backward",i=>{i.stopPropagation();let{coordinate:a}=r;a.selectionStart===a.selectionEnd&&a.selectionStart===0&&(i.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),r}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=ti),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:r}=this;r.length=0;let{names:i,ids:a,scales:o,units:l}=e;Yn(this.dimensionContainer,a.map((c,d)=>{let p=t.get(c);p===void 0?(p=this.newDimension(e,d),t.set(c,p)):p.coordinateSpace=e;let m=i[d];p.nameElement.value=m,delete p.nameElement.dataset.isValid,Vn(p.nameElement);let y=vy(e,d);y===void 0?p.container.dataset.coordinateArray="none":y===null?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",y===null&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:v,prefix:b,unit:x}=ab(o[d],l[d]),C=`${v}${b}${x}`;return p.scaleElement.value=C,delete p.scaleElement.dataset.isValid,tV(p.scaleElement),r.push(p),p.container}));for(let[c,d]of t)d.coordinateSpace!==e&&(this.closeDropdown(d),t.delete(c))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,r){let{dimensionWidgetList:i}=this,a=i.indexOf(e);if(a!==-1)for(;;){if(a+=t,a<0||a>=i.length)return!1;let o=i[a],l=r(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,r=>r.coordinate)}handleLeftRightMovement(e,t,r,i){e.stopPropagation();let a=i(t);a.selectionStart!==a.selectionEnd||a.selectionStart!==(r===1?a.value.length:0)||this.selectAdjacentField(t,r,i)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=e.map(a=>a.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let a=0;a<r;++a)e[a].nameElement.dataset.isValid=i[a]===!1?"false":"true"}updateScaleValidity(e){let t=Xo(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){let r=this.dimensionWidgetList.indexOf(e);if(r===-1)return;this.updatePosition();let{position:i}=this;if(!i.valid)return;let a=i.coordinateSpace.value,{bounds:o}=a,l=Float32Array.from(i.value),c=Math.floor(l[r]+t);if(t>0){let d=o.upperBounds[r];Number.isFinite(d)&&(c=Math.min(c,Math.ceil(d-1)))}else{let d=o.lowerBounds[r];Number.isFinite(d)&&(c=Math.max(c,Math.floor(d)))}l[r]=c+.5,this.position.value=l,this.updateView()}updatePosition(){let{dimensionWidgetList:e}=this,{position:t}=this,{value:r}=t;if(r===void 0)return;let i=e.length;for(let a=0;a<i;++a){let o=e[a];o.modified=!1;let l=Number(o.coordinate.value);Number.isFinite(l)&&(r[a]=l+(Number.isInteger(l)?.5:0))}t.value=r}updateNames(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;let a=r.names;if(Ee(a,i))return!1;let o=r.timestamps.map((c,d)=>a[d]===i[d]?c:Date.now()),l={...r,names:i,timestamps:o};return t.value=l,!0}updateScales(){let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,r=t.value,i=e.map(m=>Xo(m.scaleElement.value));if(i.includes(void 0))return!1;let a=Float64Array.from(i,m=>m.scale),o=Array.from(i,m=>m.unit),{scales:l,units:c}=r;if(Ee(l,a)&&Ee(c,o))return!1;let d=r.timestamps.map((m,y)=>a[y]===l[y]&&o[y]===c[y]?m:Date.now()),p=He({valid:r.valid,rank:r.rank,scales:a,units:o,timestamps:d,ids:r.ids,names:r.names,boundingBoxes:r.boundingBoxes,coordinateArrays:r.coordinateArrays});return t.value=p,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e},dimensionWidgetList:t}=this,r=t.length;if(e===void 0)return;let i=this.coordinateSpace;for(let a=0;a<r;++a){let o=t[a],l=o.coordinate,c=Math.floor(e[a]),d=c.toString();eV(l,d),l.value=d;let p=vy(i,a),m="";if(p!=null){let{coordinates:v}=p,b=lE(v,c,(x,C)=>x-C);b!==v.length&&(m=p.labels[b])}let y=o.coordinateLabel;y.textContent=m}}disposed(){this.closeDropdown(),ut(this.element),super.disposed()}},$w=class extends z{constructor(e,t,r){super();this.element=e;this.mouseState=t;this.coordinateSpace=r;this.tempPosition=K.create();e.className="neuroglancer-mouse-position-widget";let i=this.registerCancellable(Ye(()=>this.updateView()));this.registerDisposer(t.changed.add(i)),this.registerDisposer(r.changed.add(i))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:r}}=this;if(t.active&&r!==void 0){let i=t.position,{rank:a,names:o}=r;for(let l=0;l<a;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(i[l])}`}this.element.textContent=e}disposed(){ut(this.element),super.disposed()}};var o8=Fe.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function nV(n){return{makeControl:(e,t,r)=>{let{watchableValue:i,channelCoordinateSpaceCombiner:a,dataType:o,defaultChannel:l,histogramSpecifications:c,legendShaderOptions:d,histogramIndex:p}=n(e);if(a!==void 0&&l.length!==0){let y=t.registerDisposer(new Qi(a.combined)),v=t.registerDisposer(new Ps(y,a,{copyButton:!1}));t.registerDisposer(y.changed.add(()=>{let x=y.value,C=Array.from(x,M=>Math.floor(M)),k=i.value;Ee(k.channel,C)||(i.value={...i.value,channel:C})}));let b=()=>{let x=y.value,C=i.value;Ee(x,C.channel)||(x.set(C.channel),y.changed.dispatch())};b(),t.registerDisposer(i.changed.add(b)),r.labelContainer.appendChild(v.element)}let m=t.registerDisposer(new Fw(r.visibility,r.display,o,i,c,p,l.length===0?d:void 0));return{control:m,controlElement:m.element}},activateTool:(e,t)=>{e.bindInputEventMap(o8),e.bindAction("adjust-contrast-via-wheel",r=>{r.stopPropagation();let i=Fl(r.detail);K2(t.dataType,t.trackable,i)}),e.bindAction("adjust-via-drag",r=>{r.stopPropagation();let i=r.detail.screenX,a=r.detail.screenY,o=t.trackable.value.range,l=o,c=i,d=a;Kn(r.detail,p=>{let m=t.trackable.value.range,y=p.screenX,v=p.screenY;vi(t.dataType,m,l)||(o=m,i=c,a=d),X2(t.dataType,t.trackable,o,(v-a)*2/screen.height,(y-i)*4/screen.width),l=t.trackable.value.range,c=y,d=v})}),e.bindAction("invert-range",r=>{r.stopPropagation(),Uw(t.trackable)})}}}var s8=Fe.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function Sy(n){return{makeControl:(e,t)=>{let r=n(e),i=t.registerDisposer(new qp(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(s8),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustHueViaWheel(r.detail)})}}}function rV(n,e){let{shaderControlState:t}=n,r=t.state.get(e);if(r===void 0)return;let{control:i}=r;switch(i.type){case"slider":return na(()=>({value:r.trackable,options:{min:i.min,max:i.max,step:i.step}}));case"color":return Sy(()=>r.trackable);case"checkbox":return Ls(()=>r.trackable);case"invlerp":{let a=0;for(let[o,{control:{type:l}}]of t.state){if(o===e)break;l==="invlerp"&&++a}return nV(()=>({dataType:i.dataType,defaultChannel:i.default.channel,watchableValue:r.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}}}function iV(n,e,t){return{label:t,toolJson:l8(t,e),makeControl:(r,i,a)=>{let o=n(r);return rV(o,t).makeControl(r,i,a)},activateTool:(r,i)=>{let a=n(r.tool.layer);return rV(a,t).activateTool(r,i)}}}var Lo=class extends wn{constructor(e,t,r,i={}){super(i.visibility);this.state=e;this.display=t;this.layer=r;this.options=i;this.controlDisposer=void 0;let{toolId:a=aV}=i;this.toolId=a;let{element:o}=this;o.style.display="contents";let{controls:l}=e;this.registerDisposer(l.changed.add(this.registerCancellable((0,jw.default)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),We(e));let t=this.controlDisposer=new z,r=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let i of this.state.state.keys())e.appendChild(mu(t,this.layer,this.visibility,iV(r,this.toolId,i)))}disposed(){var e;(e=this.controlDisposer)==null||e.dispose(),super.disposed()}},aV="shaderControl",oV="control";function l8(n,e){return{type:e,[oV]:n}}var sV=class extends fy{constructor(e,t,r,i){super(e,iV(()=>t,r,i));this.layerShaderControls=t;this.control=i;this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable((0,jw.default)(()=>{t.shaderControlState.state.get(i)===void 0&&this.unbind()}))))}activate(e){let{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}};function Is(n,e,t=aV){_l(n,t,(r,i)=>{let a=$(i,oV,ae);return new sV(r,e(r),t,a)})}var qw="opacity",Jw="blend",lV="shader",cV="shaderControls",Yw="crossSectionRenderScale",uV="channelDimensions",Kw="volumeRendering",c8="volumeRenderScale",u8=hu(Ei),As=class extends u8{constructor(e){super(e);this.opacity=Nl(.5);this.blendMode=A_();this.fragmentMain=R_();this.shaderError=Sa();this.dataType=new Ge(void 0);this.sliceViewRenderScaleHistogram=new Da;this.sliceViewRenderScaleTarget=Hi(1);this.volumeRenderingRenderScaleHistogram=new Da;this.volumeRenderingRenderScaleTarget=Hi(1);this.channelCoordinateSpace=new rl;this.channelCoordinateSpaceCombiner=new Nc(this.channelCoordinateSpace,mD);this.channelSpace=this.registerDisposer(ir(e=>oy(()=>bD(e)),this.channelCoordinateSpace));this.volumeRendering=new Mt(!1,!1);this.shaderControlState=this.registerDisposer(new po(this.fragmentMain,this.registerDisposer(fn((e,t)=>e===void 0?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));this.localCoordinateSpaceCombiner.includeDimensionPredicate=Qo,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new fV(this)}),this.tabs.default="rendering"}markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),r=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}activateDataSubsources(e){let t;for(let r of e){if(this.addStaticAnnotations(r))continue;let{subsourceEntry:i}=r,{subsource:a}=i,{volume:o}=a;if(!(o instanceof Qt)){r.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){r.deactivate(`Data type must be ${G[o.dataType].toLowerCase()}`);continue}t=o.dataType,r.activate(l=>{r.addRenderLayer(new fw(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let c=l.registerDisposer(new Rw({multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));l.registerDisposer(r.messages.addChild(c.messages)),l.registerDisposer(ar((d,p)=>{!p||d.registerDisposer(this.addRenderLayer(c.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[qw]),pe(e,Jw,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[lV]),this.shaderControlState.restoreState(e[cV]),this.sliceViewRenderScaleTarget.restoreState(e[Yw]),this.channelCoordinateSpace.restoreState(e[uV]),this.volumeRendering.restoreState(e[Kw])}toJSON(){let e=super.toJSON();return e[qw]=this.opacity.toJSON(),e[Jw]=this.blendMode.toJSON(),e[lV]=this.fragmentMain.toJSON(),e[cV]=this.shaderControlState.toJSON(),e[Yw]=this.sliceViewRenderScaleTarget.toJSON(),e[uV]=this.channelCoordinateSpace.toJSON(),e[Kw]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){let{value:r}=e;if(r==null)return!1;let i=this.channelSpace.value;if(i.error!==void 0)return!1;let{numChannels:a,coordinates:o,channelCoordinateSpace:{names:l,rank:c}}=i,d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid");let p="[copy] 0fr ";c!==0&&(p+=`repeat(${c}, [dim] 0fr [coord] 0fr) `),p+="[value] 1fr",d.style.gridTemplateColumns=p;for(let m=0;m<a;++m){let y=c===0?r:r[m],v=y==null?"":y.toString(),b=Ar({title:"Copy value",onClick:()=>{Ir(v)}});d.appendChild(b);for(let C=0;C<c;++C){let k=document.createElement("div");k.classList.add("neuroglancer-selection-details-value-grid-dim"),k.textContent=l[C],d.appendChild(k);let M=document.createElement("div");M.classList.add("neuroglancer-selection-details-value-grid-coord"),M.textContent=o[m*c+C].toString(),d.appendChild(M)}let x=document.createElement("div");x.classList.add("neuroglancer-selection-details-value-grid-value"),x.textContent=v,d.appendChild(x)}return t.appendChild(d),!0}displaySelectionState(e,t,r){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,r)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),pw(e,t)},initializeShader:e=>{let t=e.shader;ai(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}};As.type="image",As.typeAbbreviation="img";function dV(n){return new ko({shaderError:n.shaderError,fragmentMain:n.fragmentMain,shaderControlState:n.shaderControlState})}var pV=[{label:"Resolution (slice)",toolJson:Yw,...gu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Blending",toolJson:Jw,...my(n=>n.blendMode)},{label:"Volume rendering (experimental)",toolJson:Kw,...Ls(n=>n.volumeRendering)},{label:"Resolution (3d)",toolJson:c8,isValid:n=>n.volumeRendering,...gu(n=>({histogram:n.volumeRenderingRenderScaleHistogram,target:n.volumeRenderingRenderScaleTarget}))},{label:"Opacity",toolJson:qw,...na(n=>({value:n.opacity}))}];for(let n of pV)hy(As,n);var fV=class extends wn{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(dV(this.layer));let{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(let a of pV)t.appendChild(mu(this,e,this.visibility,a));let r=document.createElement("div");r.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(r),i.appendChild(Es({title:"Show larger editor view",onClick:()=>{new hV(this.layer)}})),i.appendChild(ks({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new _w(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Lo(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}},hV=class extends ta{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(dV(this.layer));this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};ea(As);ey(gt.IMAGE,As);Cs(n=>{let{volume:e}=n;if(e!==void 0&&e.volumeType===gt.UNKNOWN)return{layerConstructor:As,priority:-100}});Is(As,n=>({shaderControlState:n.shaderControlState,legendShaderOptions:n.getLegendShaderOptions()}));var bV=rt(Ct());var d8="DisjointUint64Sets",mV="DisjointUint64Sets.add",gV="DisjointUint64Sets.clear",yV="DisjointUint64Sets.highBitRepresentativeChanged",vV="DisjointUint64Sets.deleteSet",Va=class extends oo{constructor(){super(...arguments);this.disjointSets=new Dl;this.changed=new re}get value(){return this}static makeWithCounterpart(e,t){let r=new this;return r.disjointSets.highBitRepresentative=t,r.registerDisposer(t.changed.add(()=>{SV(r)})),r.initializeCounterpart(e),t.value&&SV(r),r}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(mV,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(gV,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(vV,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(e!==void 0){let t=[new Q,new Q];Te(e,r=>{Te(r,(i,a)=>{t[a%2].parseString(String(i),10),a!==0&&this.link(t[0],t[1])})})}}assignFrom(e){this.clear(),e instanceof Va&&(e=e.disjointSets);for(let[t,r]of e)this.link(t,r)}};Va=Ut([Zo(d8)],Va);var yu=new Q,Xw=new Q;zt(mV,function(n){let e=this.get(n.id);yu.low=n.al,yu.high=n.ah,Xw.low=n.bl,Xw.high=n.bh,e.disjointSets.link(yu,Xw)&&e.changed.dispatch()});zt(gV,function(n){let e=this.get(n.id);e.disjointSets.clear()&&e.changed.dispatch()});function SV(n){n.rpc.invoke(yV,{id:n.rpcId,value:n.disjointSets.highBitRepresentative.value})}zt(yV,function(n){let e=this.get(n.id);e.disjointSets.highBitRepresentative.value=n.value});zt(vV,function(n){let e=this.get(n.id);yu.low=n.l,yu.high=n.h,e.disjointSets.deleteSet(yu)&&e.changed.dispatch()});var Qw=class extends Ip{constructor(){super(...arguments);this.spanningTreeEdges=new Map;this.equivalences=new Va;this.connections=new Set;this.changed=new qe}link(e,t){this.equivalences.link(e,t);for(let r of this.connections)r.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(let t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)Zw(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r);o===void 0&&(o=new Set,a.set(r,o));let l=a.get(i);l===void 0&&(l=new Set,a.set(i,l)),o.add(i),l.add(r)}removeSpanningTreeEdge(e,t){let r=e.toString(),i=t.toString(),{spanningTreeEdges:a}=this,o=a.get(r),l=a.get(i);o.delete(i),o.size===0&&a.delete(r),l.delete(r),l.size===0&&a.delete(i)}*getSpanningTreeNeighbors(e){let t=new Q,r=this.spanningTreeEdges.get(e.toString());if(r!==void 0)for(let i of r)t.parseString(i),yield t}restoreState(e){let{equivalences:t,spanningTreeEdges:r}=this;if(t.clear(),r.clear(),e===void 0)return;let i=[new Q,new Q];Te(e,a=>{Te(a,(o,l)=>{i[l%2].parseString(String(o),10),l!==0&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])})})}toJSON(){let{spanningTreeEdges:e}=this;if(e.size===0)return;let t=new Array;for(let[r,i]of e){let a=Q.parseString(r);for(let o of i){let l=Q.parseString(o);Q.compare(a,l)>0||t.push([a,l])}}return t.sort((r,i)=>Q.compare(r[0],i[0])||Q.compare(r[1],i[1])),t.map(r=>r.map(i=>i.toString()))}get highBitRepresentative(){return!1}async merge(e,t){let{equivalences:r}=this;return Q.equal(r.get(e),r.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),r.get(e))}async split(e,t){let r=this.computeSplit(e,t);if(r===void 0)throw new Error("Segments are already split");let{includeBaseSegments:i,includeRepresentative:a,excludeBaseSegments:o,excludeRepresentative:l}=r,{equivalences:c}=this;this.deleteSet(e),this.linkAll(i),this.linkAll(o);let d=(y,v)=>{for(let b of y)for(let x of this.getSpanningTreeNeighbors(b))Q.equal(c.get(x),v)||this.removeSpanningTreeEdge(b,x)},p=c.get(e),m=c.get(t);d(i,p),d(o,m);for(let y of this.connections){let{visibleSegments:v}=y.segmentsState;v.has(l)&&(v.delete(l),v.add(a))}return this.normalizeAll(),this.changed.dispatch(),{include:p,exclude:m}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:r}=this,i=r.get(e);if(!Q.equal(i,r.get(t)))return;let a=new Dl;for(let m of r.setElements(i))if(!Q.equal(m,t))for(let y of this.getSpanningTreeNeighbors(m))Q.equal(y,t)||a.link(m,y);let o=[],l=[],c=a.get(e),d=e,p=t;for(let m of r.setElements(i))Q.equal(a.get(m),c)?(o.push(m),Q.compare(m,d)<0&&(d=m)):(l.push(m),Q.compare(m,p)<0&&(p=m));return o.sort(Q.compare),l.sort(Q.compare),{includeBaseSegments:o,includeRepresentative:d,excludeBaseSegments:l,excludeRepresentative:p}}connect(e){let t=new xV(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),Zw(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable((0,bV.default)(()=>Zw(e.visibleSegments,e.segmentEquivalences.disjointSets),0)))),this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}};function Zw(n,e){let t=[];for(let r of n){let i=e.get(r);Q.equal(r,i)||(t.push(i),n.delete(r))}for(let r of t)n.add(r)}var xV=class extends Ap{computeSplit(e,t){return this.graph.computeSplit(e,t)}};var e0=class{constructor(e){this.disjointSets=e;this.generation=Number.NaN;this.hashMap=new Jc}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:r}=this;r.clear();for(let[i,a]of e.mappings())r.set(i,a)}}},by=class extends $p{constructor(e,t){super(e,{shaderParameters:new bd(r=>({hasEquivalences:r.registerDisposer(fn(i=>i.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:r.registerDisposer(fn(i=>i.size!==0,[t.segmentStatedColors])),hasSegmentDefaultColor:r.registerDisposer(fn(i=>i!==void 0,[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition});this.displayState=t;this.segmentationGroupState=this.displayState.segmentationGroupState.value;this.segmentColorShaderManager=new cx("segmentColorHash");this.segmentStatedColorShaderManager=new dx("segmentStatedColor");this.hashTableManager=new Vm("visibleSegments");this.gpuHashTable=this.registerDisposer(Sl.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable));this.gpuTemporaryHashTable=Sl.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable);this.equivalencesShaderManager=new dp("equivalences");this.equivalencesHashMap=new e0(this.segmentationGroupState.segmentEquivalences.disjointSets);this.temporaryEquivalencesHashMap=new e0(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets);this.gpuEquivalencesHashTable=this.registerDisposer(Sl.get(this.gl,this.equivalencesHashMap.hashMap));this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Sl.get(this.gl,this.temporaryEquivalencesHashMap.hashMap));this.registerDisposer(this.shaderParameters),Px(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)==null||e.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let r=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;r+=`return x;
}
`,e.addFragmentCode(r),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(i+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),i+=`
  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if (uSelectedSegment == value.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let a=`vec3 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),a+=`
  vec3 rgb;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {
    return rgb;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),a+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),a+=`  return segmentColorHash(value);
`),a+=`
}
`,e.addFragmentCode(a),i+=`
  vec3 rgb = getMappedIdColor(valueForColor);
  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));
`,e.setFragmentMain(i)}initializeShader(e,t,r){let{gl:i}=this,{displayState:a,segmentationGroupState:o}=this,{segmentSelectionState:l}=this.displayState,{segmentDefaultColor:{value:c},segmentColorHash:{value:d}}=this.displayState,p=Yb(o),m=this.displayState.ignoreNullVisibleSet.value,y=0,v=0;if(l.hasSelectedSegment){let b=l.selectedSegment;y=b.low,v=b.high}if(i.uniform1f(t.uniform("uSelectedAlpha"),a.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),a.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),a.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),y,v),i.uniform1ui(t.uniform("uShowAllSegments"),p.hashTable.size||!m?0:1),this.hashTableManager.enable(i,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),r.hasEquivalences){let b=o.useTemporarySegmentEquivalences.value;(b?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,b?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(c===void 0?this.segmentColorShaderManager.enable(i,t,d):i.uniform3fv(t.uniform("uSegmentDefaultColor"),c),r.hasSegmentStatedColors){let b=this.displayState.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:x}=this;(x===void 0||x.hashTable!==b.hashTable)&&(x==null||x.dispose(),this.gpuSegmentStatedColorHashTable=x=Sl.get(i,b.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,x)}}endSlice(e,t,r){let{gl:i}=this;this.hashTableManager.disable(i,t),r.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),r.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,r)}};var wy=rt(Ct()),kV=rt(Pl());var xy="mergeSegments",Cy="splitSegments",p8=Fe.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),f8=Fe.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),CV=class extends Co{constructor(e){super(e);this.lastAnchorBaseSegment=new Ge(void 0);let t=()=>{let r=e.anchorSegment.value;if(r===void 0)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:a}=e.displayState.segmentationGroupState.value,o=a.get(r);if(!Q.equal(i.selectedSegment,o))return;let l=i.baseSelectedSegment;a.disjointSets.highBitRepresentative.value&&!au(l)||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return xy}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value,p=this.lastAnchorBaseSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let m=t.segmentEquivalences.get(d);return t.visibleSegments.has(m)?p===void 0||!Q.equal(t.segmentEquivalences.get(p),m)?{anchorSegment:d,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:p,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},i=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:m}=this.layer,y=m.segmentSelectionState.baseValue;return y===void 0||Q.equal(m.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))?{anchorSegment:d,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:d,otherSegment:y,error:void 0,anchorSegmentValid:!0}},{body:a,header:o}=Gp(e);o.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(p8),e.registerDisposer(()=>{mp(t)});let l=()=>{We(a);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:m,anchorSegmentValid:y,error:v}=i(),b=C=>{let k=gp(this.layer.displayState,C);return k.classList.add("neuroglancer-segment-list-entry-double-line"),k};if(p!==void 0&&a.appendChild(b(fs(d,p))),v!==void 0){let C=document.createElement("span");C.textContent=v,a.appendChild(C)}if(m!==void 0){let C=document.createElement("span");C.textContent=" merge ",a.appendChild(C),a.appendChild(b(fs(d,m)))}let{segmentEquivalences:x}=t;if(y){t.useTemporaryVisibleSegments.value=!0;let C=t.temporaryVisibleSegments;C.clear(),C.add(x.get(p)),m!==void 0&&C.add(x.get(m))}else{mp(t);return}};l(),e.registerDisposer(hs(this.layer.displayState,a));let c=e.registerCancellable(Ye(l));ms(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(c)),e.bindAction("merge-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:m,otherSegment:y,error:v}=i();if(!(m===void 0||y===void 0||v!==void 0))try{await p.merge(m,y),Ke.showTemporaryMessage("Merge performed")}catch(b){Ke.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,m=p.baseValue;if(m===void 0)return;let y=this.layer.anchorSegment.value;if(t.visibleSegments.add(m),y===void 0||!Q.equal(y,m)){this.layer.anchorSegment.value=m.clone();return}})}get description(){return"merge"}},wV=class extends Co{toJSON(){return Cy}activate(e){let t=this.layer.displayState.segmentationGroupState.value,r=()=>{let d=this.layer.anchorSegment.value;if(d===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};let p=t.segmentEquivalences.get(d);return t.visibleSegments.has(p)?{anchorSegment:d,error:void 0}:{anchorSegment:d,error:"Anchor segment must be in visible set"}},{body:i,header:a}=Gp(e);a.textContent="Split segments",i.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(f8);let o=()=>{let{anchorSegment:d,error:p}=r();if(d===void 0||p!==void 0)return{anchorSegment:d,error:p,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:m}=this.layer,y=m.segmentSelectionState.baseValue;return y===void 0||!Q.equal(m.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(d))||Q.equal(y,d)?{anchorSegment:d,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:d,otherSegment:y,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{mp(t)});let l=()=>{We(i);let{displayState:d}=this.layer,{anchorSegment:p,otherSegment:m,anchorSegmentValid:y,error:v}=o(),b,x;(()=>{let{segmentEquivalences:M}=t,{graphConnection:I}=this.layer;if(!y||I===void 0){mp(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,m!==void 0){let D=I.computeSplit(p,m);if(D!==void 0){b=new Ji(p,D.includeRepresentative),x=new Ji(m,D.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let E=D.includeRepresentative,V=D.excludeRepresentative,N=t.temporarySegmentEquivalences;N.clear();for(let _ of D.includeBaseSegments)N.link(_,E);for(let _ of D.excludeBaseSegments)N.link(_,V);let U=t.temporaryVisibleSegments;U.clear(),U.add(E),U.add(V);return}}t.useTemporarySegmentEquivalences.value=!1;let A=t.temporaryVisibleSegments;A.clear(),A.add(M.get(p))}})();let k=M=>{let I=gp(this.layer.displayState,M);return I.classList.add("neuroglancer-segment-list-entry-double-line"),I};if(p!==void 0&&i.appendChild(k(b!=null?b:fs(d,p))),v!==void 0){let M=document.createElement("span");M.textContent=v,i.appendChild(M)}if(x!==void 0){let M=document.createElement("span");M.textContent=" split ",i.appendChild(M),i.appendChild(k(x))}};e.registerDisposer(hs(this.layer.displayState,i)),l();let c=e.registerCancellable(Ye(l));ms(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.bindAction("split-segments",d=>{d.stopPropagation(),(async()=>{let{graph:{value:p}}=t;if(p===void 0)return;let{anchorSegment:m,otherSegment:y,error:v}=o();if(!(m===void 0||y===void 0||v!==void 0))try{await p.split(m,y),Ke.showTemporaryMessage("Split performed")}catch(b){Ke.showTemporaryMessage(`Split failed: ${b}`)}})()}),e.bindAction("set-anchor",d=>{d.stopPropagation();let{segmentSelectionState:p}=this.layer.displayState,m=p.baseValue;if(m===void 0)return;t.visibleSegments.add(m);let y=this.layer.anchorSegment.value;if(y===void 0||!Q.equal(y,m)){this.layer.anchorSegment.value=m.clone();return}})}get description(){return"split"}};function TV(){_l(er,xy,n=>new CV(n)),_l(er,Cy,n=>new wV(n))}var h8=new Q,LV=class extends z{constructor(e,t,r,i){super();this.query=e;this.segmentPropertyMap=t;this.segmentationDisplayState=r;this.parentElement=i;this.changed=new qe;this.explicitSegmentsVisible=!1;this.visibleSegmentsGeneration=-1;this.queryResult=new Ge(void 0);this.statusText=new Ge("");this.selectedMatches=0;this.matchStatusTextPrefix="";this.debouncedUpdate=(0,wy.default)(()=>this.update(),0);this.render=e=>{let{explicitSegments:t}=this,r,i=!1;if(t!==void 0&&e<t.length)r=t[e],i=this.explicitSegmentsVisible;else{t!==void 0&&(e-=t.length),r=h8;let o=this.queryResult.value.indices[e],{ids:l}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;r.low=l[o*2],r.high=l[o*2+1]}let a=this.segmentWidgetFactory.get(r);return i&&(a.dataset.visibleList="true"),a};this.update(),this.registerDisposer(r.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)==null?void 0:e.count)!=null?t:0}update(){var b;let e=this.query.value,{segmentPropertyMap:t}=this,r=this.queryResult.value,i;if(this.prevQuery===e)i=r;else{let x=aM(t,e);i=oM(t,x)}let a=[],o=!1,l="",{visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,d=c.changed.count,p=this.visibleSegmentsGeneration,m=dM(i.query);if(m){if(p!==d||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=d;let x=Array.from(c,k=>k.clone());x.sort(Q.compare);let{explicitSegments:C}=this;C===void 0?(this.explicitSegments=x,a.push({retainCount:0,insertCount:x.length,deleteCount:0})):a.push(...fE(C,x,Q.compare)),this.explicitSegments=x,o=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=d,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0),this.explicitSegmentsVisible=!1;let{explicitIds:y}=i;if(y!==void 0?this.explicitSegments=y:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==i&&(a.push({retainCount:0,deleteCount:(b=r==null?void 0:r.count)!=null?b:0,insertCount:i.count}),o=!0,this.queryResult.value=i),i.explicitIds!==void 0?l=`${i.count} ids`:m?l=`${i.count} listed ids`:i.total>0&&(l=`${i.count}/${i.total} matches`),r!==i||d!==p){let x=l,C=0;t!==void 0&&i.count>0&&(C=uM(t,i,c),x+=` (${C} visible)`),this.selectedMatches=C,this.statusText.value=x}this.prevQuery=e,this.matchStatusTextPrefix=l;let{explicitSegments:v}=this;this.length=(this.explicitSegmentsVisible?v.length:0)+i.count,o&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}},EV=Fe.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),m8=100;function DV(n){Vn(n,Math.max(1,n.value.length+.1))}function t0(n,e){let t;if(Number.isInteger(e))t=e.toString();else{let r=e.toString(),i=e.toPrecision(6);t=r.length<i.length?r:i}n.value=t,DV(n)}function g8(n,e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${n}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(n==="range"?"range":"for distribution"),t.addEventListener("input",()=>{DV(t)}),t}function y8(n,e,t){if(n===void 0||n.indices===void 0)return;let r=n.query,{sortBy:i,includeColumns:a}=r;Sg(r,t)?(i=i.filter(l=>l.fieldId!==t),a=a.filter(l=>l!==t)):a.push(t),e({...r,sortBy:i,includeColumns:a})}function PV(n,e,t){var d;let r=n==null?void 0:n.query,i=r==null?void 0:r.sortBy;if(i===void 0)return;let{includeColumns:a}=r,l=((d=i.find(p=>p.fieldId===t))==null?void 0:d.order)==="<"?">":"<",c=a.filter(p=>p!==t);for(let p of i)p.fieldId!=="id"&&p.fieldId!=="label"&&p.fieldId!==t&&c.push(p.fieldId);e({...r,sortBy:[{fieldId:t,order:l}],includeColumns:c})}function IV(n,e,t){var a,o;let r=(a=n==null?void 0:n.query)==null?void 0:a.sortBy,i=(o=r==null?void 0:r.find(l=>l.fieldId===t))==null?void 0:o.order;e.textContent=i===">"?"\u25BC":"\u25B2",e.style.visibility=i===void 0?"":"visible",e.title=`Sort by ${t} in ${i==="<"?"descending":"ascending"} order`}var AV=class extends z{constructor(e,t,r){super();this.segmentPropertyMap=e;this.queryResult=t;this.setQuery=r;this.propertyHistograms=[];this.bounds={window:new Ge([]),range:new Ge([])};this.throttledUpdate=this.registerCancellable((0,kV.default)(()=>this.updateHistograms(),100));this.debouncedRender=this.registerCancellable(Ye(()=>this.updateHistogramRenderings()));this.debouncedSetQuery=this.registerCancellable((0,wy.default)(()=>this.setQueryFromBounds(),200));let i=e==null?void 0:e.numericalProperties,a=[],o;if(i!==void 0&&i.length>0){o=document.createElement("details");let l=document.createElement("summary");l.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");let c=this.bounds.window.value;for(let d=0,p=i.length;d<p;++d){let m=i[d],y=this.makeNumericalPropertySummary(d,m);a.push(y),o.appendChild(y.element),c[d]=m.bounds}}this.listElement=o,this.properties=a,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;let t=e.query,r=[],i=this.bounds.range.value,{properties:a}=this;for(let o=0,l=a.length;o<l;++o){let c=a[o].property;r.push({fieldId:c.id,bounds:i[o]})}this.setQuery({...t,numericalConstraints:r})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:r}=this.properties[e],i=Zs(r.bounds,t.range);kr(i[0],i[1])>0&&(i=[i[1],i[0]]);let a=Zs(r.bounds,t.window),o=this.getBounds(e),{dataType:l}=this.properties[e].property;vi(l,a,o.window)||(this.bounds.window.value[e]=a,this.bounds.window.changed.dispatch()),vi(l,i,o.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,r,i){let o=this.segmentPropertyMap.numericalProperties[r].bounds;i=Qs(o,i);let l=this.getBounds(r),c=Xp(l,e,t,i,!0);this.setBounds(r,c)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if((e==null?void 0:e.indices)!==void 0){let{numericalConstraints:r}=e.query,{numericalProperties:i}=this.segmentPropertyMap,a=this.bounds.range.value,o=r.length,l=i.length;a.length=l;for(let c=0;c<l;++c)a[c]=i[c].bounds;for(let c=0;c<o;++c){let d=r[c],p=i.findIndex(m=>m.id===d.fieldId);a[p]=d.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(sM(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(e===void 0)return;let{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";let{properties:r}=this;for(let i=0,a=r.length;i<a;++i)this.updateNumericalPropertySummary(i,r[i],t[i])}makeNumericalPropertySummary(e,t){let r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let i=document.createElement("img");i.classList.add("neuroglancer-segment-query-result-numerical-plot");let a=new yy(i,t.dataType,()=>this.getBounds(e),p=>this.setBounds(e,p)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{y8(this.queryResult.value,this.setQuery,t.id)});let c=p=>{let m=document.createElement("div");m.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),m.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${p}`);let y=x=>{let C=g8(p,x);return C.addEventListener("change",()=>{if(this.bounds[p].value[e]!==void 0){try{let M=to(t.dataType,C.value);this.setBound(p,x,e,M),this.bounds[p].changed.dispatch()}catch{}t0(C,this.bounds[p].value[e][x])}}),C},v=[y(0),y(1)],b;if(p==="range"){b=[document.createElement("div"),document.createElement("div"),document.createElement("div")],b[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),b[1].appendChild(l);let x=document.createElement("span");x.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),x.appendChild(document.createTextNode(t.id)),x.appendChild(o),x.addEventListener("click",()=>{PV(this.queryResult.value,this.setQuery,t.id)}),b[1].appendChild(x);let{description:C}=t;C&&(b[1].title=C),m.appendChild(b[0]),m.appendChild(v[0]);let k=document.createElement("div");k.textContent="\u2264",k.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(k),m.appendChild(b[1]);let M=document.createElement("div");M.textContent="\u2264",M.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),m.appendChild(M),m.appendChild(v[1]),m.appendChild(b[2])}else m.appendChild(v[0]),m.appendChild(v[1]);return{container:m,spacers:b,inputs:v}},d={range:c("range"),window:c("window")};return r.appendChild(d.range.container),r.appendChild(i),r.appendChild(d.window.container),{property:t,controller:a,element:r,plotImg:i,boundElements:d,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,r){let i=t.bounds.window,a=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],{property:c}=t,d=this.queryResult.value,p=Sg(d==null?void 0:d.query,c.id);if(t.columnCheckbox.checked=p,t.columnCheckbox.title=p?"Remove column from result table":"Add column to result table",IV(d,t.sortIcon,c.id),t.propertyHistogram===r&&vi(c.dataType,i,a)&&vi(c.dataType,o,l))return;let{histogram:m}=r,y="http://www.w3.org/2000/svg",v=document.createElementNS(y,"svg");v.setAttribute("width","1"),v.setAttribute("height","1"),v.setAttribute("preserveAspectRatio","none");let b=document.createElementNS(y,"rect"),x=Ur(a,l[0]),C=Ur(a,l[1]);b.setAttribute("x",`${x}`),b.setAttribute("y","0"),b.setAttribute("width",`${C-x}`),b.setAttribute("height","1"),b.setAttribute("fill","#4f4f4f"),v.appendChild(b);let k=m.length,M=(U,_,B)=>{let R=document.createElementNS(y,"polyline"),X="",j=0;for(let Se=U;Se<B;++Se)j+=m[Se];if(j===0)return;let oe=Ur(a,r.window[0]),me=Ur(a,r.window[1]),xe=(Se,Ie)=>{let je=Se/(k-2);X+=` ${oe*(1-je)+me*je},${1-Ie}`};U!==0&&xe(U,0);let se=0;for(let Se=U;Se<_;++Se)se+=m[Se],xe(Se,se/j);return R.setAttribute("fill","none"),R.setAttribute("stroke-width","1px"),R.setAttribute("points",X),R.setAttribute("vector-effect","non-scaling-stroke"),R};{let U=M(0,k-1,k);U!==void 0&&(U.setAttribute("stroke","cyan"),v.appendChild(U))}if(!vi(c.dataType,c.bounds,l)){let U=Math.floor(Math.max(0,Math.min(1,Ur(r.window,l[0])))*(k-2)),_=Math.ceil(Math.max(0,Math.min(1,Ur(r.window,l[1])))*(k-2)),B=M(U,_,_);B!==void 0&&(B.setAttribute("stroke","white"),v.appendChild(B))}let I=new XMLSerializer().serializeToString(v);t.plotImg.src=`data:image/svg+xml;base64,${btoa(I)}`,t.propertyHistogram=r;for(let U=0;U<2;++U)i[U]=a[U],t0(t.boundElements.window.inputs[U],a[U]),o[U]=l[U],t0(t.boundElements.range.inputs[U],l[U]);let A=t.boundElements.range.spacers,D=Zs(a,l),E=Pc(c.dataType,a),V=Ur(a,D[0])*E,N=Ur(a,D[1])*E+(1-E);A[0].style.width=`${V*100}%`,A[2].style.width=`${(1-N)*100}%`}};function v8(n,e){let{tags:t}=n;if(t===void 0||t.length===0)return;let r=n.query,i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-tag-list");for(let{tag:a,count:o}of t){let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),c.textContent=a,i.appendChild(l);let d=r.includeTags.includes(a),p=r.excludeTags.includes(a),m;d?m="Remove tag from required set":p?m="Remove tag from excluded set":m="Add tag to required set",c.addEventListener("click",()=>{e(Kx(r,a,!0,!d&&!p))}),c.title=m;let y=d||p,v=x=>{let C=x?o:n.count-o,k=document.createElement("div");if(k.classList.add("neuroglancer-segment-query-result-tag-toggle"),k.classList.add(`neuroglancer-segment-query-result-tag-${x?"include":"exclude"}`),l.appendChild(k),!y&&C===0)return;let M=x?d:p;k.appendChild(new dr({get value(){return M},set value(I){e(Kx(r,a,x,I))},changed:gh},{text:x?"+":"-",enableTitle:`Add tag to ${x?"required":"exclusion"} set`,disableTitle:`Remove tag from ${x?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};v(!0),v(!1),l.appendChild(c);let b=document.createElement("span");b.classList.add("neuroglancer-segment-query-result-tag-count"),y||(b.textContent=o.toString()),l.appendChild(b)}return i}var n0=class extends wn{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Xn(e.displayState.segmentationGroupState.value.graph,(l,c,d)=>{if(l===void 0)return;let p=document.createElement("div");p.className="neuroglancer-segmentation-toolbox",p.appendChild(YC(d,e,{toolJson:xy,label:"Merge",title:"Merge segments"})),p.appendChild(YC(d,e,{toolJson:Cy,label:"Split",title:"Split segments"})),c.appendChild(p)})).element);let r=document.createElement("input");r.classList.add("neuroglancer-segment-list-query"),r.addEventListener("focus",()=>{r.select()});let i=this.registerDisposer(new sn(r,EV));i.allShortcutsAreGlobal=!0;let{segmentQuery:a}=this.layer.displayState,o=this.registerCancellable((0,wy.default)(()=>{a.value=r.value},2e3));r.autocomplete="off",r.title=EV.describe(),r.spellcheck=!1,r.placeholder="Enter cell type, #mito, ssv size or a combination",this.registerDisposer(Kr(l=>{r.value=l},a)),this.registerDisposer(Kr(l=>{Date.now()-l<100&&(setTimeout(()=>{r.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(r),t.appendChild(this.registerDisposer(new Xn(e.displayState.segmentPropertyMap,(l,c,d)=>{let p=se=>{r.focus(),r.select();let Se=cM(l,se);document.execCommand("insertText",!1,Se),a.value=Se,r.select()},m=d.registerDisposer(new LV(a,l,e.displayState,c)),y=e.displayState.segmentationGroupState.value,v=document.createElement("ul");v.classList.add("neuroglancer-segment-query-errors"),c.appendChild(v);let b=document.createElement("div");b.classList.add("neuroglancer-segment-query-result-statistics");let x=document.createElement("span"),C=document.createElement("input");C.type="checkbox",C.checked=!0,C.title="Deselect all segment IDs",C.addEventListener("change",()=>{y.visibleSegments.clear()});let k=Ar({title:"Copy visible segment IDs",onClick:()=>{let se=Array.from(y.visibleSegments,Se=>Se.clone());se.sort(Q.compare),Ir(se.join(", "))}}),M=document.createElement("span");x.appendChild(k),x.appendChild(C),x.appendChild(M);let I=document.createElement("span"),A=document.createElement("input"),D=Ar({onClick:()=>{o(),o.flush(),m.debouncedUpdate.flush();let se=m.queryResult.value;if(se===void 0)return;let Se=new Array(se.count);Dp(l,se,(Ie,je)=>{Se[je]=Ie.toString()}),Ir(Se.join(", "))}});A.type="checkbox";let E=()=>{o(),o.flush(),m.debouncedUpdate.flush();let se=m.queryResult.value;if(se===void 0)return;let{visibleSegments:Se}=y,{selectedMatches:Ie}=m,je=Ie!==se.count;if(je&&se.count-Ie>m8){if(!B)return B=!0,V.textContent=`Confirm: show ${se.count-Ie} segments?`,!1;B=!1,_()}return Dp(l,se,Be=>{Se.set(Be,je)}),!0};A.addEventListener("click",se=>{E()||se.preventDefault()});let V=document.createElement("span");I.appendChild(D),I.appendChild(A),I.appendChild(V),x.classList.add("neuroglancer-segment-list-status"),I.classList.add("neuroglancer-segment-list-status"),c.appendChild(b);let N=document.createElement("div");N.classList.add("neuroglancer-segment-query-result-statistics-separator"),c.appendChild(N),c.appendChild(I),c.appendChild(x);let U=-1,_=()=>{let se=y.visibleSegments.size;U!==se&&(U=se,M.textContent=`${se} visible in total`,C.checked=se>0,C.style.visibility=se?"visible":"hidden",k.style.visibility=se?"visible":"hidden"),V.textContent=m.statusText.value;let{numMatches:Se,selectedMatches:Ie}=m;D.style.visibility=Se?"visible":"hidden",D.title=`Copy ${Se} segment ID(s)`,A.style.visibility=Se?"visible":"hidden",Ie===0?(A.checked=!1,A.indeterminate=!1,A.title=`Show ${Se} segment ID(s)`):Ie===Se?(A.checked=!0,A.indeterminate=!1,A.title=`Hide ${Ie} segment ID(s)`):(A.checked=!0,A.indeterminate=!0,A.title=`Show ${Se-Ie} segment ID(s)`)};_(),m.statusText.changed.add(_),d.registerDisposer(y.visibleSegments.changed.add(_));let B=!1;d.registerEventListener(r,"input",()=>{o(),B&&(B=!1,_())}),ue(r,"cancel",()=>{r.focus(),r.select(),document.execCommand("delete"),r.blur(),r.value="",a.value="",B=!1,_()}),ue(r,"toggle-listed",E),ue(r,"hide-all",()=>{y.visibleSegments.clear()}),ue(r,"hide-listed",()=>{o(),o.flush(),m.debouncedUpdate.flush();let{visibleSegments:se}=y;if(a.value==="")se.clear();else{let Se=m.queryResult.value;if(Se===void 0)return;Dp(l,Se,Ie=>{se.delete(Ie)})}});let R=d.registerDisposer(new Rl({source:m,horizontalScroll:!0})),X=d.registerCancellable(Ye(()=>{m.updateRenderedItems(R)})),{displayState:j}=this.layer;d.registerDisposer(j.segmentSelectionState.changed.add(X)),d.registerDisposer(y.visibleSegments.changed.add(X)),d.registerDisposer(j.segmentColorHash.changed.add(X)),d.registerDisposer(j.segmentStatedColors.changed.add(X)),d.registerDisposer(j.segmentDefaultColor.changed.add(X)),R.element.classList.add("neuroglancer-segment-list"),d.registerDisposer(e.bindSegmentListWidth(R.element)),d.registerDisposer(new On(R.element,Kc()));let oe=d.registerDisposer(new AV(l,m.queryResult,p));{let{listElement:se}=oe;se!==void 0&&b.appendChild(se)}let me,xe=se=>{let Se=se==null?void 0:se.errors;if(We(v),Se!==void 0)for(let Ie of Se){let je=document.createElement("li");je.textContent=Ie.message,v.appendChild(je)}};Kr(se=>{if(m.segmentWidgetFactory=new Dx(m.segmentationDisplayState,m.parentElement,Ie=>Sg(se==null?void 0:se.query,Ie.id)),R.scrollToTop(),We(R.header),l!==void 0){let Ie=m.segmentWidgetFactory.getHeader();Ie.container.classList.add("neuroglancer-segment-list-header");for(let je of Ie.propertyLabels){let{label:Be,sortIcon:Pe,id:ge}=je;Be.addEventListener("click",()=>{PV(m.queryResult.value,p,ge)}),IV(se,Pe,ge)}R.header.appendChild(Ie.container)}if(xe(se),N.style.display="none",me==null||me.remove(),se===void 0)return;let{query:Se}=se;Se.errors!==void 0||Se.ids!==void 0||(me=v8(se,p),me!==void 0&&b.appendChild(me),(oe.properties.length>0||me!==void 0)&&(N.style.display=""))},m.queryResult),c.appendChild(R.element)})).element)}};var MV=rt(Ct());var Ty=class extends z{constructor(e){super();this.group=e;this.element=document.createElement("div");this.topRow=document.createElement("div");this.label=document.createElement("label");this.selectElement=document.createElement("select");this.linkedLayers=document.createElement("div");this.unlinkButton=document.createElement("button");let{element:t,label:r,topRow:i,selectElement:a,linkedLayers:o,unlinkButton:l}=this;i.appendChild(r),i.appendChild(a),i.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(i),t.appendChild(o),this.updateView();let c=(0,MV.default)(()=>this.updateView(),0);this.registerEventListener(a,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){let e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var l;let{selectElement:e,group:t}=this,{predicate:r}=t;We(e);let i=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=i?"":"none";let{linkedLayers:a}=this,o=t.linkedLayers.size!==0;if(a.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",We(a);for(let c of t.linkedLayers){let d=document.createElement("div");d.classList.add("neuroglancer-linked-layer-widget-layer");let p=Qc({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});d.appendChild(p),d.appendChild(document.createTextNode(c.managedLayer.name)),a.appendChild(d)}}else{e.style.display="";let c=document.createElement("option");e.appendChild(c);let d=0;for(let p of this.group.layerManager.managedLayers){let m=p.layer;if(m!==null&&m!==t.layer&&r(m)){++d;let y=document.createElement("option"),{name:v}=p;y.textContent=v,y.value=v,e.appendChild(y)}}e.value=(l=t.toJSON())!=null?l:"",this.element.style.display=d===0?"none":""}}};function RV(n){return new ko({fragmentMain:n.displayState.skeletonRenderingOptions.shader,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState})}var r0=class extends wn{constructor(e){super();this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new Ty(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new Ty(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of a0)t.appendChild(mu(this,e,this.visibility,i));let r=this.registerDisposer(new Xn(e.hasSkeletonsLayer,(i,a,o)=>{if(!i)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(Es({title:"Show larger editor view",onClick:()=>{new _V(this.layer)}})),l.appendChild(ks({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),a.appendChild(l);let d=o.registerDisposer(RV(this.layer));a.appendChild(d.element),a.appendChild(o.registerDisposer(new Lo(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:i0})).element),d.textEditor.refresh()},this.visibility));t.appendChild(r.element)}},_V=class extends ta{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(RV(this.layer));this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var Gl=class extends oo{constructor(){super(...arguments);this.hashTable=new Jc;this.changed=new qe}get value(){return this}static makeWithCounterpart(e){let t=new Gl;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[Symbol.iterator](){return this.hashTable.entries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){this.clear();for(let[t,r]of e)this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.entries())e[t.toString()]=r.toString();return e}};Gl=Ut([Zo("Uint64Map")],Gl);zt("Uint64Map.set",function(n){let e=this.get(n.id);e.set_(n.key,n.value)&&e.changed.dispatch()});zt("Uint64Map.delete",function(n){let e=this.get(n.id);e.delete_(n.key)&&e.changed.dispatch()});zt("Uint64Map.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var Ms=class extends oo{constructor(){super(...arguments);this.hashTable=new Rm;this.changed=new qe}get value(){return this}static makeWithCounterpart(e){let t=new Ms;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}add_(e){return this.hashTable.add(e)}add(e){if(this.add_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=new Array;for(let t of this)e.push(t.toString());return e.sort(),e}assignFrom(e){this.clear();for(let t of e)this.add(t)}};Ms=Ut([Zo("Uint64Set")],Ms);zt("Uint64Set.add",function(n){let e=this.get(n.id);e.add_(n.value)&&e.changed.dispatch()});zt("Uint64Set.delete",function(n){let e=this.get(n.id);e.delete_(n.value)&&e.changed.dispatch()});zt("Uint64Set.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});var VV='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="rotateIconTitle"><path d="M22 12l-3 3-3-3"></path><path d="M2 12l3-3 3 3"></path><path d="M19.016 14v-1.95A7.05 7.05 0 0 0 8 6.22"></path><path d="M16.016 17.845A7.05 7.05 0 0 1 5 12.015V10"></path><path stroke-linecap="round" d="M5 10V9"></path><path stroke-linecap="round" d="M19 15v-1"></path></svg>';var ef=class extends z{constructor(e){super();this.model=e;this.element=document.createElement("input");this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){ut(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!=null?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}};function ky(n,e){e?n.displayState.segmentDefaultColor.value=K.fromValues(1,0,0):n.displayState.segmentDefaultColor.value=void 0}function OV(){let n=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:r})=>{let i=document.createElement("input");i.type="radio",i.addEventListener("change",()=>{ky(e,!i.checked)}),r.prepend(i);let a=document.createElement("div");a.classList.add("neuroglancer-segmentation-color-seed-control");let o=t.registerDisposer(new ef(e.displayState.segmentColorHash));a.appendChild(o.element);let l=it({svg:VV,title:"Randomize",onClick:()=>n(e)});return a.appendChild(l),t.registerDisposer(Kr(c=>{let d=c===void 0;a.style.visibility=d?"":"hidden",i.checked=d},e.displayState.segmentDefaultColor)),{controlElement:a,control:o}},activateTool:e=>{let{layer:t}=e.tool;ky(t,!1),n(t)}}}function NV(){let n=Sy(e=>e.displayState.segmentDefaultColor);return{...n,makeControl:(e,t,r)=>{let i=n.makeControl(e,t,r),{controlElement:a}=i,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{ky(e,o.checked),o.checked&&a.click()}),r.labelTextContainer.prepend(o),t.registerDisposer(Kr(l=>{let c=l!==void 0;a.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),i},activateTool:(e,t)=>{ky(e.tool.layer,!0),n.activateTool(e,t)}}}var o0="selectedAlpha",s0="notSelectedAlpha",l0="objectAlpha",c0="saturation",u0="hideSegmentZero",d0="baseSegmentColoring",p0="ignoreNullVisibleSet",S8="mesh",b8="skeletons",BV="segments",Ly="equivalences",f0="colorSeed",UV="segmentColors",h0="meshRenderScale",m0="crossSectionRenderScale",Ey="skeletonRendering",x8="skeletonShader",FV="segmentQuery",g0="meshSilhouetteRendering",GV="linkedSegmentationGroup",WV="linkedSegmentationColorGroup",y0="segmentDefaultColor",zV="anchorSegment",i0="skeletonShaderControl",HV=class extends z{constructor(e){super();this.layer=e;this.specificationChanged=new qe;this.localGraph=new Qw;this.visibleSegments=this.registerDisposer(Ms.makeWithCounterpart(this.layer.manager.rpc));this.segmentPropertyMap=new Ge(void 0);this.graph=new Ge(void 0);this.segmentEquivalences=this.registerDisposer(Va.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(fn(e=>e!==void 0&&e.highBitRepresentative,[this.graph]))));this.localSegmentEquivalences=!1;this.maxIdLength=new Ge(1);this.hideSegmentZero=new Mt(!0,!0);this.segmentQuery=new lt("",ae);this.temporaryVisibleSegments=this.layer.registerDisposer(Ms.makeWithCounterpart(this.layer.manager.rpc));this.temporarySegmentEquivalences=this.layer.registerDisposer(Va.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.highBitRepresentative));this.useTemporaryVisibleSegments=this.layer.registerDisposer(Gt.make(this.layer.manager.rpc,!1));this.useTemporarySegmentEquivalences=this.layer.registerDisposer(Gt.make(this.layer.manager.rpc,!1));let{specificationChanged:t}=this;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){pe(e,u0,t=>this.hideSegmentZero.restoreState(t)),pe(e,Ly,t=>{this.localGraph.restoreState(t)}),pe(e,BV,t=>{let{segmentEquivalences:r,visibleSegments:i}=this;Te(t,a=>{let o=Q.parseString(String(a),10);i.add(r.get(o))})}),pe(e,FV,t=>this.segmentQuery.restoreState(t))}toJSON(){let e={};e[u0]=this.hideSegmentZero.toJSON();let{visibleSegments:t}=this;t.size>0&&(e[BV]=t.toJSON());let{segmentEquivalences:r}=this;return this.localSegmentEquivalences&&r.size>0&&(e[Ly]=r.toJSON()),e[FV]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}},$V=class extends z{constructor(e){super();this.layer=e;this.specificationChanged=new qe;this.segmentColorHash=pp.getDefault();this.segmentStatedColors=this.registerDisposer(new Gl);this.segmentDefaultColor=new OS;let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){pe(e,f0,t=>this.segmentColorHash.restoreState(t)),pe(e,y0,t=>this.segmentDefaultColor.restoreState(t)),pe(e,UV,t=>{let r=Vi(t,i=>ga(String(i)));for(let[i,a]of r){let o=Q.parseString(String(i)),l=new Q(Ld(a));this.segmentStatedColors.set(o,l)}})}toJSON(){let e={};e[f0]=this.segmentColorHash.toJSON(),e[y0]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let r=e[UV]={};for(let[i,a]of t)r[i.toString()]=In(Za(a.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}},v0=class extends z{constructor(e,t){super();this.linkedGroup=e;this.propertyName=t;this.value}get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:r}=this;r!==void 0&&(t.assignFrom(r),r.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)==null||e.dispose()}},jV=class{constructor(e){this.layer=e;this.segmentSelectionState=new kx;this.selectedAlpha=Nl(.5);this.saturation=Nl(1);this.notSelectedAlpha=Nl(0);this.silhouetteRendering=new lt(0,Ah,0);this.objectAlpha=Nl(1);this.ignoreNullVisibleSet=new Mt(!0,!0);this.skeletonRenderingOptions=new Ox;this.shaderError=Sa();this.renderScaleHistogram=new Da;this.renderScaleTarget=Hi(1);this.selectSegment=this.layer.selectSegment;this.transparentPickEnabled=this.layer.pick;this.baseSegmentColoring=new Mt(!1,!1);this.filterBySegmentLabel=this.layer.filterBySegmentLabel;this.moveToSegment=e=>{this.layer.moveToSegment(e)};this.linkedSegmentationGroup=this.layer.registerDisposer(new Zg(this.layer.manager.rootLayers,this.layer,e=>e instanceof er,e=>e.displayState.linkedSegmentationGroup));this.linkedSegmentationColorGroup=this.layer.registerDisposer(new Zg(this.layer.manager.rootLayers,this.layer,e=>e instanceof er,e=>e.displayState.linkedSegmentationColorGroup));this.originalSegmentationGroupState=this.layer.registerDisposer(new HV(this.layer));this.originalSegmentationColorGroupState=this.layer.registerDisposer(new $V(this.layer));e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new v0(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new v0(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new Tc(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new xd(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new xd(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.segmentDefaultColor=this.layer.registerDisposer(new xd(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.segmentQuery=this.layer.registerDisposer(new Tc(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new Tc(this.segmentationGroupState,t=>t.segmentPropertyMap))}},C8=hu(Ei),er=class extends C8{constructor(e){super(e);this.sliceViewRenderScaleHistogram=new Da;this.sliceViewRenderScaleTarget=Hi(1);this.segmentQueryFocusTime=new Ge(Number.NEGATIVE_INFINITY);this.selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=e.clone(),!0),t)};this.filterBySegmentLabel=e=>{let t=fs(this.displayState,e),{label:r}=t;!r||this.filterSegments(r)};this.filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};this.displayState=new jV(this);this.anchorSegment=new lt(void 0,e=>e===void 0?void 0:Q.parseString(e));this.has2dLayer=this.registerDisposer(ir(e=>e.some(t=>t instanceof by),{changed:this.layersChanged,value:this.renderLayers}));this.has3dLayer=this.registerDisposer(ir(e=>e.some(t=>t instanceof zm||t instanceof Sp||t instanceof Cp||t instanceof Jm),{changed:this.layersChanged,value:this.renderLayers}));this.hasSkeletonsLayer=this.registerDisposer(ir(e=>e.some(t=>t instanceof Cp),{changed:this.layersChanged,value:this.renderLayers}));this.registerDisposer(Qa((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(Qa((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new r0(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new n0(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return hs(this.displayState,e)}get volumeOptions(){return{volumeType:gt.SEGMENTATION}}activateDataSubsources(e){let t=[],r=this.displayState.linkedSegmentationGroup.root.value===this,i;for(let a of e){if(this.addStaticAnnotations(a))continue;let{volume:o,mesh:l,segmentPropertyMap:c,segmentationGraph:d,local:p}=a.subsourceEntry.subsource;if(o instanceof Qt){switch(o.dataType){case G.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new by(o,{...this.displayState,transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else l!==void 0?a.activate(()=>{let m={...this.displayState,transform:a.getRenderLayerTransform()};if(l instanceof Mr)a.addRenderLayer(new zm(this.manager.chunkManager,l,m));else if(l instanceof yo)a.addRenderLayer(new Sp(this.manager.chunkManager,l,m));else{let y=new Nx(this.manager.chunkManager,l,m);a.addRenderLayer(new Cp(y.addRef())),a.addRenderLayer(new Jm(y))}},this.displayState.segmentationGroupState.value):c!==void 0?r?(a.activate(()=>{}),t.push(c)):a.deactivate("Not supported on non-root linked segmentation layers"):d!==void 0?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=d,a.activate(m=>{this.graphConnection=m.registerDisposer(d.connect(this.displayState.segmentationGroupState.value)),m.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):p===bi.equivalences?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=this.displayState.originalSegmentationGroupState.localGraph,a.activate(m=>{this.graphConnection=m.registerDisposer(i.connect(this.displayState.segmentationGroupState.value)),m.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=iM(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=i}getLegacyDataSourceSpecifications(e,t,r,i){let a=super.getLegacyDataSourceSpecifications(e,t,r,i),o=pe(t,S8,c=>c===null?null:ae(c)),l=pe(t,b8,c=>c===null?null:ae(c));if(o!==void 0||l!==void 0)for(let c of a)c.enableDefaultSubsources=!1,c.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&a.push(Il(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&a.push(Il(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[Ly]!==void 0&&i.find(c=>c.url===wm)===void 0&&a.push({url:wm,enableDefaultSubsources:!0,transform:{outputSpace:Ui,sourceRank:0,transform:void 0,inputSpace:Ui},subsources:new Map}),a}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[o0]),this.displayState.saturation.restoreState(e[c0]),this.displayState.notSelectedAlpha.restoreState(e[s0]),this.displayState.objectAlpha.restoreState(e[l0]),this.displayState.baseSegmentColoring.restoreState(e[d0]),this.displayState.silhouetteRendering.restoreState(e[g0]),this.displayState.ignoreNullVisibleSet.restoreState(e[p0]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[Ey]);let r=e[x8];r!==void 0&&t.shader.restoreState(r),this.displayState.renderScaleTarget.restoreState(e[h0]),this.anchorSegment.restoreState(e[zV]),this.sliceViewRenderScaleTarget.restoreState(e[m0]);let i=pe(e,GV,ae);i!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(i);let a=pe(e,WV,o=>o===!1?void 0:ae(o),i);a!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(a),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var i;let e=super.toJSON();e[o0]=this.displayState.selectedAlpha.toJSON(),e[s0]=this.displayState.notSelectedAlpha.toJSON(),e[c0]=this.displayState.saturation.toJSON(),e[l0]=this.displayState.objectAlpha.toJSON(),e[d0]=this.displayState.baseSegmentColoring.toJSON(),e[p0]=this.displayState.ignoreNullVisibleSet.toJSON(),e[g0]=this.displayState.silhouetteRendering.toJSON(),e[zV]=this.anchorSegment.toJSON(),e[Ey]=this.displayState.skeletonRenderingOptions.toJSON(),e[h0]=this.displayState.renderScaleTarget.toJSON(),e[m0]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:r}=this.displayState;return e[GV]=t.toJSON(),r.root.value!==t.root.value&&(e[WV]=(i=r.toJSON())!=null?i:!1),e[Ly]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),r.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:Lx(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;let{segmentSelectionState:r}=this.displayState;if(r.hasSelectedSegment){let i=r.selectedSegment,{visibleSegments:a}=this.displayState.segmentationGroupState.value,o=!a.has(i);(o||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=o),t.defer(()=>{t.segmentationToggleSegmentState===o&&a.set(i,o)})}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let r=new Q,{value:i}=e;typeof i=="number"&&(i=i.toString()),typeof i!="string"||!r.tryParseString(i)?e.value=void 0:e.value=r}selectionStateToJson(e,t){let r=super.selectionStateToJson(e,t),{value:i}=e;return i instanceof Ji?t?r.value={key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:r.value=(i.value||i.key).toString():i instanceof Q&&(r.value=i.toString()),r}displaySegmentationSelection(e,t,r){let{value:i}=e,a;if((typeof i=="number"||typeof i=="string")&&(a=new Q,!a.tryParseString(i.toString())))return!1;if(i instanceof Q)a=i.clone();else if(i instanceof Ji)a=i.key.clone();else return!1;let{displayState:o}=this,l=fs(o,a),{segmentEquivalences:c,segmentPropertyMap:{value:d}}=this.displayState.segmentationGroupState.value,p=c.get(a),m=gp(this.displayState,l);if(ms(o,r,r.redraw),r.registerDisposer(hs(o,m)),m.classList.add("neuroglancer-selection-details-segment"),t.appendChild(m),d!==void 0){let{inlineProperties:y}=d.segmentPropertyMap;if(y!==void 0){let v=d.getSegmentInlineIndex(p);if(v!==-1){for(let b of y.properties)if(b.type!=="label"){if(b.type==="description"){let x=b.values[v];if(!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-description"),C.textContent=x,t.appendChild(C)}else if(b.type==="number"||b.type==="string"){let x=b.values[v];if(b.type==="number"?isNaN(x):!x)continue;let C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-property");let k=document.createElement("div");k.classList.add("neuroglancer-selection-details-segment-property-name"),k.textContent=b.id,b.description&&(k.title=b.description);let M=document.createElement("div");M.classList.add("neuroglancer-selection-details-segment-property-value"),M.textContent=x.toString(),C.appendChild(k),C.appendChild(M),t.appendChild(C)}}}}}return!0}displaySelectionState(e,t,r){let i=this.displaySegmentationSelection(e,t,r);return super.displaySelectionState(e,t,r)&&(i=!0),i}moveToSegment(e){for(let t of this.renderLayers){if(!(t instanceof Sp))continue;let r=t.getObjectPosition(e);if(r!==void 0){this.setLayerPosition(t.displayState.transform.value,r);return}}Ke.showTemporaryMessage(`No position information loaded for segment ${e}`)}};er.type="segmentation",er.typeAbbreviation="seg",er.supportsPickOption=!0;var w8=10;function qV(n){return[{label:`Skeleton mode (${n})`,toolJson:`${Ey}.mode${n}`,isValid:e=>e.hasSkeletonsLayer,...my(e=>e.displayState.skeletonRenderingOptions[`params${n}`].mode)},{label:`Line width (${n})`,toolJson:`${Ey}.lineWidth${n}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${n})`,title:`Skeleton line width (${n})`,...na(e=>({value:e.displayState.skeletonRenderingOptions[`params${n}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var a0=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:f0,...OV()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:y0,...NV()},{label:"Saturation",toolJson:c0,title:"Saturation of segment colors",...na(n=>({value:n.displayState.saturation}))},{label:"Opacity (on)",toolJson:o0,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...na(n=>({value:n.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:s0,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...na(n=>({value:n.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:m0,isValid:n=>n.has2dLayer,...gu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:h0,isValid:n=>n.has3dLayer,...gu(n=>({histogram:n.displayState.renderScaleHistogram,target:n.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:l0,isValid:n=>n.has3dLayer,title:"Opacity of meshes and skeletons",...na(n=>({value:n.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:g0,isValid:n=>n.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...na(n=>({value:n.displayState.silhouetteRendering,options:{min:0,max:w8,step:.1}}))},{label:"Hide segment ID 0",toolJson:u0,title:"Disallow selection and display of segment id 0",...Ls(n=>n.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:d0,title:"Color base segments individually",...Ls(n=>n.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:p0,...Ls(n=>n.displayState.ignoreNullVisibleSet)},...qV("2d"),...qV("3d")];for(let n of a0)hy(er,n);ea(er);ey(gt.SEGMENTATION,er);Cs(n=>{if(n.mesh!==void 0)return{layerConstructor:er,priority:1}});Is(er,n=>({shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState}),i0);TV();var JV="shader",YV="shaderControls",vu=class extends Ei{constructor(e){super(e);this.managedLayer=e;this.displayState=new oC;this.vertexAttributes=new Ge(void 0);this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new ZV(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[JV]),this.displayState.shaderControlState.restoreState(e[YV])}activateDataSubsources(e){let t=!1;for(let r of e){let{subsourceEntry:i}=r,{subsource:a}=i,{singleMesh:o}=a;if(o!==void 0){if(t){r.deactivate("Only one single-mesh source supported");continue}t=!0,r.activate(l=>{r.addRenderLayer(new cC(o,this.displayState,r.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,l.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}r.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[JV]=this.displayState.fragmentMain.toJSON(),e[YV]=this.displayState.shaderControlState.toJSON(),e}};vu.type="mesh",vu.typeAbbreviation="mesh";function KV(n){return new ko({fragmentMain:n.displayState.fragmentMain,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.shaderControlState})}var XV=class extends z{constructor(e){super();this.attributes=e;this.element=document.createElement("div");this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(t===void 0){We(e);return}let r=lC(t.map(a=>a.name)),i=t.length;for(let a=0;a<i;++a){let o=t[a],l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute";let c=document.createElement("div");c.className="neuroglancer-single-mesh-attribute-type",c.textContent=sC(o);let d=document.createElement("div");if(d.className="neuroglancer-single-mesh-attribute-name",d.textContent=r[a],l.appendChild(c),l.appendChild(d),o.min!==void 0&&o.max!==void 0){let p=document.createElement("neuroglancer-single-mesh-attribute-minmax");p.className="neuroglancer-single-mesh-attribute-range",p.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,l.appendChild(p)}e.appendChild(l)}}disposed(){ut(this.element)}};function QV(n){return new XV(n.vertexAttributes)}var ZV=class extends wn{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(QV(this.layer));this.codeWidget=this.registerDisposer(KV(this.layer));let{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");let r=document.createElement("div");r.className="neuroglancer-single-mesh-dropdown-top-row";let i=document.createElement("div");i.style.flex="1",r.appendChild(i),r.appendChild(Es({title:"Show larger editor view",onClick:()=>{new eO(this.layer)}})),r.appendChild(ks({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Lo(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}},eO=class extends ta{constructor(e){super();this.layer=e;this.attributeWidget=this.registerDisposer(QV(this.layer));this.codeWidget=this.registerDisposer(KV(this.layer));this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};ea(vu);Cs(n=>{if(n.singleMesh!==void 0)return{layerConstructor:vu,priority:2}});Is(vu,n=>({shaderControlState:n.displayState.shaderControlState}));var tO=rt(Ct());var S0=class extends z{constructor(e){super();this.ref=e;this.element=document.createElement("label");this.selectElement=document.createElement("select");this.registerDisposer(e);let{element:t,selectElement:r}=this;t.appendChild(r),this.updateView(),this.registerEventListener(r,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,tO.default)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:r}=t;We(e);let i=document.createElement("option");e.appendChild(i);for(let a of this.ref.layerManager.managedLayers)if(r(a)){let o=document.createElement("option"),{name:l}=a;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}};var T8="points",b0="annotations",nO="annotationProperties",rO="annotationRelationships",iO="crossSectionAnnotationSpacing",aO="projectionAnnotationSpacing",oO="shader",sO="shaderControls";function k8(n,e){e!==void 0&&Te(e,(t,r)=>{n.add({type:ze.POINT,id:""+r,point:H1(t),properties:[]})})}function L8(n){let e=n.layer;return e===null||e instanceof er}function E8(n){if(n===void 0)return null;let e=n.layer;return e===null||!(e instanceof er)?null:e.displayState}var lO="linkedSegmentationLayer",cO="filterBySegmentation",uO="ignoreNullSegmentFilter",dO=class extends z{constructor(e,t,r){super();this.layerManager=e;this.annotationStates=t;this.annotationDisplayState=r;this.changed=new re;this.curGeneration=-1;this.wasLoading=void 0;this.map=new Map;this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:r}=this,i=!1;for(let a of this.annotationStates.relationships){let o=r.get(a);o===void 0&&(o=this.addRelationship(a),i=!0),o.seenGeneration=e}if(!t)for(let[a,o]of r)o.seenGeneration!==e&&(r.delete(a),i=!0);i&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),r=new nw(this.layerManager.addRef(),L8);r.registerDisposer(r.changed.add(()=>{t.segmentationState.value=r.layerName===void 0?void 0:E8(r.layer)}));let{showMatches:i}=t,a={layerRef:r,showMatches:i,seenGeneration:-1};return r.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,a),a}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let{map:e}=this;if(e.size===0)return{};let t,r=[];for(let[i,a]of e){a.showMatches.value&&r.push(i);let{layerName:o}=a.layerRef;o!==void 0&&((t=t||{})[i]=o)}return r.sort(),{[lO]:t,[cO]:r.length===0?void 0:r}}restoreState(e){let{isLoading:t}=this.annotationStates;pe(e,lO,r=>{typeof r=="string"&&(r={segments:r}),Z(r);for(let i of Object.keys(r)){let a=ae(r[i]),o=this.map.get(i);if(o===void 0){if(!t)continue;o=this.addRelationship(i)}o.layerRef.layerName=a}for(let[i,a]of this.map)Object.prototype.hasOwnProperty.call(r,i)||(a.layerRef.layerName=void 0)}),pe(e,cO,r=>{typeof r=="boolean"&&(r=r===!0?["segments"]:[]);for(let i of vn(r)){let a=this.map.get(i);if(a===void 0){if(!t)continue;a=this.addRelationship(i)}a.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}},pO=class extends z{constructor(e,t){super();this.relationship=e;this.state=t;this.element=document.createElement("label");this.seenGeneration=-1;let{element:r}=this,i=this.registerDisposer(new Lr(t.showMatches)),a=new S0(t.layerRef);r.appendChild(i.element),r.appendChild(document.createTextNode(e)),r.appendChild(a.element)}},fO=class extends z{constructor(e){super();this.linkedSegmentationLayers=e;this.widgets=new Map;this.element=document.createElement("div");this.element.style.display="contents";let t=this.registerCancellable(Ye(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,r=t.changed.count,{widgets:i}=this;function*a(){for(let o of t.relationships){let l=i.get(o);l===void 0&&(l=new pO(o,e.get(o))),l.seenGeneration=r,yield l.element}}for(let[o,l]of i)l.seenGeneration!==r&&(l.dispose(),i.delete(o));Yn(this.element,a.call(this))}disposed(){super.disposed();for(let e of this.widgets.values())e.dispose()}},D8=hu(Ei),Rs=class extends D8{constructor(e){super(e);this.annotationProperties=new Ge(void 0);this.localAnnotationsJson=void 0;this.pointAnnotationsJson=void 0;this.linkedSegmentationLayers=this.registerDisposer(new dO(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new gO(this)}),this.tabs.default="annotations"}disposed(){let{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[b0],this.localAnnotationProperties=pe(e,nO,Oh),this.localAnnotationRelationships=pe(e,rO,vn,["segments"]),this.pointAnnotationsJson=e[T8],this.annotationCrossSectionRenderScaleTarget.restoreState(e[iO]),this.annotationProjectionRenderScaleTarget.restoreState(e[aO]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[uO]),this.annotationDisplayState.shader.restoreState(e[oO]),this.annotationDisplayState.shaderControls.restoreState(e[sO])}getLegacyDataSourceSpecifications(e,t,r,i){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,r,i);let a=pe(t,"voxelSize",l=>Je(new Float64Array(3),l,c=>Lt(c)/1e9)),o=["m","m","m"];if(a!==void 0){let l=He({rank:3,units:o,scales:a,names:["x","y","z"]});r===void 0?r={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:r={...r,inputSpace:l}}return[{url:nx,transform:r,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){var a;let t=!1,r;for(let o of e){let{subsourceEntry:l}=o,{local:c}=l.subsource,d=m=>r!==void 0&&Mn(m)!==Mn(r)?(o.deactivate("Annotation properties are not compatible"),!1):(r=m,!0);if(c===bi.annotations){if(t){o.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!d((a=this.localAnnotationProperties)!=null?a:[]))continue;o.activate(m=>{var b;let y=this.localAnnotations=new KS(o.loadedDataSource.transform,(b=this.localAnnotationProperties)!=null?b:[],this.localAnnotationRelationships);try{y.restoreState(this.localAnnotationsJson)}catch{}m.registerDisposer(()=>{y.dispose(),this.localAnnotations=void 0}),m.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{k8(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let v=new pu({localPosition:this.localPosition,transform:m.registerDisposer(em(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,o.loadedDataSource.transform,void 0)),source:y.addRef(),displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:cr.ANNOTATION});this.addAnnotationLayerState(v,o)});continue}let{annotation:p}=l.subsource;if(p!==void 0){if(!d(p.properties))continue;o.activate(()=>{let m=new pu({localPosition:this.localPosition,transform:o.getRenderLayerTransform(),source:p,displayState:this.annotationDisplayState,dataSource:o.loadedDataSource.layerDataSource,subsourceIndex:o.subsourceIndex,subsourceId:l.id,role:cr.ANNOTATION});this.addAnnotationLayerState(m,o)});continue}o.deactivate("Not compatible with annotation layer")}let i=this.annotationProperties.value;Mn(i)!==Mn(r)&&(this.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer(ir(i=>i.some(a=>a.source instanceof $i),this.annotationStates)),r=e.registerDisposer(new Xn(t,(i,a,o)=>{if(!!i){{let l=o.registerDisposer(new Kp(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",a.appendChild(l.element)}{let l=o.registerDisposer(new Kp(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",a.appendChild(l.element)}}}));e.element.insertBefore(r.element,e.element.firstChild);{let i=e.registerDisposer(new Lr(this.annotationDisplayState.ignoreNullSegmentFilter)),a=document.createElement("label");a.appendChild(document.createTextNode("Ignore null related segment filter")),a.title="Display all annotations if filtering by related segments is enabled but no segments are selected",a.appendChild(i.element),e.element.appendChild(a)}e.element.appendChild(e.registerDisposer(new fO(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[iO]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[aO]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[b0]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[b0]=this.localAnnotationsJson),e[nO]=nD(this.localAnnotationProperties);let{localAnnotationRelationships:t}=this;return e[rO]=t.length===1&&t[0]==="segments"?void 0:t,e[uO]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[oO]=this.annotationDisplayState.shader.toJSON(),e[sO]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};Rs.type="annotation",Rs.typeAbbreviation="ann";function hO(n){return new ko({shaderError:n.annotationDisplayState.shaderError,fragmentMain:n.annotationDisplayState.shader,shaderControlState:n.annotationDisplayState.shaderControls})}var mO=class extends ta{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(hO(this.layer));this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},gO=class extends wn{constructor(e){super();this.layer=e;this.codeWidget=this.registerDisposer(hO(this.layer));let{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Xn(e.annotationProperties,(a,o)=>{if(a===void 0||a.length===0)return;let l=document.createElement("div");o.appendChild(l),l.classList.add("neuroglancer-annotation-shader-property-list");for(let c of a){let d=document.createElement("div");d.classList.add("neuroglancer-annotation-shader-property");let p=document.createElement("span");p.classList.add("neuroglancer-annotation-shader-property-type"),p.textContent=c.type;let m=document.createElement("span");m.classList.add("neuroglancer-annotation-shader-property-identifier"),m.textContent=`prop_${c.identifier}`,d.appendChild(p),d.appendChild(m);let{description:y}=c;y!==void 0&&(d.title=y),l.appendChild(d)}})).element);let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let i=document.createElement("div");i.style.flex="1",i.textContent="Annotation shader:",r.appendChild(i),r.appendChild(Es({title:"Show larger editor view",onClick:()=>{new mO(this.layer)}})),r.appendChild(ks({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),t.appendChild(r),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Lo(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};ea(Rs);ea(Rs,"pointAnnotation");Cs(n=>{if(n.local===bi.annotations)return{layerConstructor:Rs,priority:100};if(n.annotation!==void 0)return{layerConstructor:Rs,priority:1}});Is(Rs,n=>({shaderControlState:n.annotationDisplayState.shaderControls}));var ik=rt(Ct());var yO=class extends xs{constructor(){super(...arguments);this.invalidCredentials=new lt(void 0,e=>e);this.validCredentials=new lt(void 0,e=>e);this.get=Dg(e=>new Promise(t=>{let r=this.validCredentials.value,i=e!==void 0?e.generation:null,a=l=>l!==void 0&&i!==l.generation;if(a(r)){t(r);return}this.invalidCredentials.value=i;let o;o=this.validCredentials.changed.add(()=>{let l=this.validCredentials.value;a(l)&&(o(),t(l))})}))}},vO=class extends fC{constructor(e){super(e,{accessToken:"",tokenType:""})}},x0=class{constructor(){this.inputState=new jm;this.outputState=new jm;this.memoize=new Ic}getCredentialsProvider(e,t){t===void 0&&(t=null);let r=Mn({key:e,parameters:t});return this.memoize.get(r,()=>{let i=new yO;return i.registerDisposer(this.inputState.add(r,i.validCredentials)),i.registerDisposer(this.outputState.add(r,i.invalidCredentials)),e==="gcs"?new vO(i):i})}};var Su=class{constructor(){this.eventActionMap=new Fe;this.changed=new re}reset(){this.eventActionMap.clear(),this.changed.dispatch()}restoreState(e){Z(e);let{eventActionMap:t}=this;for(let r of Object.keys(e)){let i=ae(e[r]);t.set(r,i)}this.changed.dispatch()}toJSON(){let e={};for(let[t,r]of this.eventActionMap.bindings)e[t]=r.action;return e}};var RN=rt(Ct());var Dy='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="controlsAltIconTitle"><circle cx="9" cy="6" r="2"></circle><path d="M4 6H7"></path><path d="M11 6H20"></path><circle cx="9" cy="18" r="2"></circle><path d="M4 18H7"></path><path d="M11 18H20"></path><circle cx="15" cy="12" r="2"></circle><path d="M4 12H13"></path><path d="M17 12L20 12"></path></svg>';var SO='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="layersIconTitle"><path d="M12 4L20 8.00004L12 12L4 8.00004L12 4Z"></path><path d="M20 12L12 16L4 12"></path><path d="M20 16L12 20L4 16"></path></svg>';var bO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="listIconTitle"><path d="M10 7L18 7M10 12L18 12M10 17L18 17"></path><line x1="7" y1="7" x2="7" y2="7"></line><line x1="7" y1="12" x2="7" y2="12"></line><line x1="7" y1="17" x2="7" y2="17"></line></svg>';var xO='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="settingsIconTitle"><path d="M5.03506429,12.7050339 C5.01187484,12.4731696 5,12.2379716 5,12 C5,11.7620284 5.01187484,11.5268304 5.03506429,11.2949661 L3.20577137,9.23205081 L5.20577137,5.76794919 L7.9069713,6.32070904 C8.28729123,6.0461342 8.69629298,5.80882212 9.12862533,5.61412402 L10,3 L14,3 L14.8713747,5.61412402 C15.303707,5.80882212 15.7127088,6.0461342 16.0930287,6.32070904 L18.7942286,5.76794919 L20.7942286,9.23205081 L18.9649357,11.2949661 C18.9881252,11.5268304 19,11.7620284 19,12 C19,12.2379716 18.9881252,12.4731696 18.9649357,12.7050339 L20.7942286,14.7679492 L18.7942286,18.2320508 L16.0930287,17.679291 C15.7127088,17.9538658 15.303707,18.1911779 14.8713747,18.385876 L14,21 L10,21 L9.12862533,18.385876 C8.69629298,18.1911779 8.28729123,17.9538658 7.9069713,17.679291 L5.20577137,18.2320508 L3.20577137,14.7679492 L5.03506429,12.7050339 Z"></path><circle cx="12" cy="12" r="1"></circle></svg>';var DN=rt(Ct());var Py=new pC;var VO=rt(Ct());function li(n,e){return t=>{t.style.flex=n,e(t)}}function _s(n,e){return t=>{t.style.display="flex",t.style.flexDirection=n;for(let r of e){let i=t.ownerDocument.createElement("div");t.appendChild(i),r(i)}}}var P8=ie.create();function Iy(n,e){let t=ie.identity(P8),{globalPosition:r,displayDimensionRenderInfo:{canonicalVoxelFactors:i,displayDimensionIndices:a}}=n;for(let o=0;o<3;++o){let l=a[o];t[12+o]=l===-1?0:r[l],t[5*o]=e/i[o]}return ie.multiply(t,n.viewProjectionMat,t),t}var Wl=class extends z{constructor(e){super();this.gl=e;this.vertexBuffer=this.registerDisposer(en.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(en.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(fP(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new Wl(e))}draw(e,t=!0){let r=this.trivialColorShader,i=this.gl;r.bind(),i.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,e);let a=r.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(a,4);let o=r.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(a),i.disableVertexAttribArray(o)}};var CO="perspective_view/PerspectiveView";var wO=!1,tf=class{constructor(){this.renderLayers=[null];this.pickData=[null];this.values=[0,0,0];this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,r=1,i=null){return this.register(e,r,t.low,t.high,i)}register(e,t=1,r=0,i=0,a=null){let{renderLayers:o,values:l}=this,c=this.nextPickID;this.nextPickID+=t;let d=o.length;o[d]=e;let p=d*3;return l[p]=c,l[p+1]=r,l[p+2]=i,this.pickData[d]=a,c}setMouseState(e,t){let{renderLayers:r,values:i}=this,a=0,o=r.length-1;for(;a<o;){let y=Math.ceil(a+(o-a)/2);i[y*3]>t?o=y-1:a=y}let l=e.pickedRenderLayer=r[a],c=a*3,d=e.pickedOffset=t-i[c];wO&&console.log(`Looking up pick ID ${t}: renderLayer`,l,`offset=${d}`);let{pickedValue:p}=e;p.low=i[c+1],p.high=i[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferOffset=void 0,e.pickedAnnotationType=void 0;let m=this.pickData[a];l!==null&&(wO&&console.log(`Picked value=${p}, offset=${d}, data=${this.pickData[a]}`),l.updateMouseState(e,p,d,m))}};var TO=rt(Pl());var kO=10,I8=1e3,A8=400,M8=500,R8=Math.PI/20,_8=20,V8=10;function LO(n,e){return Math.sqrt(n*n+e*e)}function EO(n){let[e,t]=n;e.identifier>t.identifier&&([t,e]=[e,t]);let r=e.clientX-t.clientX,i=e.clientY-t.clientY,a=LO(r,i),o=Math.atan2(r,i);return{distance:a,angle:o}}function O8(n,e){let t=Math.PI*2,r=Math.abs(n-e)%t;return Math.min(r,t-r)}var C0=class extends z{constructor(e,t){super();this.target=e;this.eventMap=t;this.prevTouches=new Map;this.moved=!1;this.prevAngle=0;this.rotated=!1;this.prevDistance=0;this.pinched=!1;this.prevCenterX=0;this.prevCenterY=0;this.translated=!1;this.startHold=this.registerCancellable((0,TO.default)((e,t,r,i)=>{let a={event:e,centerX:r,centerY:i};this.dispatch(`touchhold${e.targetTouches.length}`,e,a,t)},I8,{leading:!1,trailing:!0}));this.numPriorTaps=0;this.priorTapNumTouches=0;this.tapStartTime=0;this.tapEndTime=0;this.curTapNumTouches=0;this.registerEventListener(e,"touchstart",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchmove",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchend",r=>{this.handleTouchEvent(r)})}dispatch(e,t,r,i=t.eventPhase){mx(e,t,i,r,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;let t=new Map,{prevTouches:r,prevEvent:i}=this,a=0,o=0;for(let y of e.targetTouches)t.set(y.identifier,y),a+=y.clientX,o+=y.clientY;a/=t.size,o/=t.size;for(let[y,v]of r.entries()){let b=t.get(y);if(b===void 0)r.delete(y);else{let x=b.clientX-v.clientX,C=b.clientY-v.clientY;(Math.abs(x)>=kO||Math.abs(C)>=kO)&&(this.moved=!0)}}if(i===void 0||i.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,a,o),(i===void 0||i.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){let y=Date.now();if(e.targetTouches.length===0&&y-this.tapStartTime<A8){(this.curTapNumTouches!==this.priorTapNumTouches||y-this.tapEndTime>=M8)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=y,this.priorTapNumTouches=this.curTapNumTouches;let v={event:e,centerX:a,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,v)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=a,this.prevCenterY=o,this.translated=!1,t.size===2){let{distance:y,angle:v}=EO(t.values());this.prevDistance=y,this.prevAngle=v,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:l,prevCenterY:c,translated:d}=this,p=a-l,m=o-c;if(d===!1&&LO(p,m)>=V8&&(d=this.translated=!0),d===!0&&(p!==0||m!==0)){this.prevCenterX=a,this.prevCenterY=o;let y={event:e,deltaX:p,deltaY:m,centerX:a,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,y)}if(t.size===2){let{distance:y,angle:v}=EO(t.values()),{pinched:b,rotated:x,prevDistance:C,prevAngle:k}=this;b===!1&&Math.abs(y-C)>=_8&&(this.pinched=b=!0);let M=O8(v,k);if(x===!1&&M>=R8&&(this.rotated=x=!0),b===!0&&y!=C){this.prevDistance=y;let I={event:e,distance:y,prevDistance:C,centerX:a,centerY:o};this.dispatch("touchpinch",e,I)}x===!0&&v!==k&&(this.prevAngle=v,this.dispatch("touchrotate",e,{event:e,centerX:a,centerY:o,angle:v,prevAngle:k}))}}};var w0=K.create(),T0=class{constructor(){this.pickIDs=new tf;this.viewportWidth=0;this.viewportHeight=0;this.invTransform=ie.create();this.frameNumber=-1}},k0=class{constructor(){this.buffer=null;this.glWindowX=0;this.glWindowY=0}},N8=30,Tn=5,yt=1+Tn*2,bu=(()=>{let n=Tn**2,e=(i,a)=>(i-Tn)**2+(a-Tn)**2,t=new Uint32Array(yt*yt),r=0;for(let i=0;i<yt;++i)for(let a=0;a<yt;++a)e(i,a)>n||(t[r++]=a*yt+i);return t=t.subarray(0,r),t.sort((i,a)=>{let o=i%yt,l=(i-o)/yt,c=a%yt,d=(a-c)/yt;return e(o,l)-e(c,d)}),t})();function Ay(n,e,t,r,i,a,o){let l=r-Tn,c=i-Tn;if(!(l>=0&&c>=0&&l+yt<=a&&c+yt<=o))for(let d=0;d<yt;++d)for(let p=0;p<yt;++p){let m=l+p,y=c+d;(m<0||y<0||m>=a||y>=o)&&(n[e+(y*yt+m)*t]=0)}}var nf=class extends Gh{constructor(e,t,r){super(e,t,r.visibility);this.viewer=r;this.mouseX=-1;this.mouseY=-1;this.pickRequestPending=!1;this.mouseStateForcer=()=>this.blockOnPickRequest();this.pickingData=[new T0,new T0];this.pickRequests=[new k0,new k0];this.pickBufferContents=new Float32Array(2*4*yt*yt);this.pickTimerId=-1;this.nextPickRequestTime=0;this.pendingPickRequestTimerId=-1;this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,!!this.pickRequestPending&&this.attemptToIssuePickRequest()};this.inputEventMap=r.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP!="undefined"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new To(t)),this.registerDisposer(new sn(t,this.inputEventMap)),this.registerDisposer(new On(t,this.inputEventMap,i=>{this.onMousemove(i)})),this.registerDisposer(new C0(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",i=>{i.target!==t&&this.onMouseout()},!0),ue(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),ue(t,"snap",()=>{this.navigationState.pose.snap()}),ue(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),ue(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),ue(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),ue(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let i=0;i<3;++i){let a=P1[i];for(let o of[-1,1]){let l=o<0?"-":"+";ue(t,`rotate-relative-${a}${l}`,()=>{this.navigationState.pose.rotateRelative(Xr[i],o*.1)});let c=K.create();ue(t,`${a}${l}`,()=>{let{navigationState:d}=this,p=c;p[0]=0,p[1]=0,p[2]=0,p[i]=o,d.pose.translateVoxelsRelative(p,!0)})}}ue(t,"zoom-via-wheel",i=>{let a=i.detail;this.onMousemove(a,!1),this.zoomByMouse(Fl(a))}),ue(t,"adjust-depth-range-via-wheel",i=>{let a=i.detail;this.navigationState.depthRange.value*=Fl(a)}),ue(t,"translate-via-mouse-drag",i=>{Kn(i.detail,(a,o,l)=>{this.translateByViewportPixels(o,l)})}),ue(t,"translate-in-plane-via-touchtranslate",i=>{let{detail:a}=i;this.translateByViewportPixels(a.deltaX,a.deltaY)}),ue(t,"translate-z-via-touchtranslate",i=>{let{detail:a}=i,{navigationState:o}=this,l=w0;l[0]=0,l[1]=0,l[2]=a.deltaY+a.deltaX,o.pose.translateVoxelsRelative(l,!0)});for(let i of[1,10])ue(t,`z+${i}-via-wheel`,a=>{let o=a.detail,{navigationState:l}=this,c=w0,d=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(d>0?-1:1)*i,l.pose.translateVoxelsRelative(c,!0)});ue(t,"move-to-mouse-position",()=>{let{mouseState:i}=this.viewer;i.updateUnconditionally()&&(this.navigationState.position.value=i.position)}),ue(t,"snap",()=>this.navigationState.pose.snap()),ue(t,"move-annotation",i=>{let{mouseState:a}=this.viewer,o=a.pickedAnnotationId,l=a.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){i.stopPropagation();let c=l.source.getReference(o),d=c.value,p=as(d.type),m=a.pickedOffset,{chunkTransform:{value:y}}=l;if(y.error!==void 0)return;let{layerRank:v}=y,b=new Float32Array(v);p.getRepresentativePoint(b,d,a.pickedOffset);let x=Tr.set(Tr.create(),0,0);a.updateUnconditionally()&&Kn(i.detail,(C,k,M)=>{Tr.add(x,x,[k,M]);let I=new Float32Array(v);ei(I,y.chunkToLayerTransform,v+1,b,v);let A=w0,{displayDimensionIndices:D}=this.navigationState.pose.displayDimensions.value;xD(A,I,y.modelTransform,D),this.translateDataPointByViewportPixels(A,A,x[0],x[1]),CD(I,A,y.modelTransform,D);let E=new Float32Array(v);ei(E,y.layerToChunkTransform,v+1,I,v);let V=p.updateViaRepresentativePoint(d,E,m);l.source.update(c,V)},C=>{l.source.commit(c),c.dispose()})}}),ue(t,"delete-annotation",()=>{let{mouseState:i}=this.viewer,a=i.pickedAnnotationId,o=i.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&a!==void 0){let l=o.source.getReference(a);try{o.source.delete(l)}finally{l.dispose()}}}),ue(t,"zoom-via-touchpinch",i=>{let{detail:a}=i;this.handleMouseMove(a.centerX,a.centerY);let o=a.prevDistance/a.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:r}=t;r!==null&&e.deleteSync(r),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:r}=e;r===null?(r=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*yt*yt,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r);let{renderViewport:i}=this,a=this.mouseX-i.visibleLeftFraction*i.logicalWidth,o=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(a,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=a,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:l}=this;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+N8}completePickInternal(e){let{gl:t}=this,{pickBufferContents:r}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:i}=this,{frameNumber:a}=e;this.completePickRequest(e.glWindowX,e.glWindowY,r,i[0].frameNumber===a?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let r=this.context.frameNumber,i=-1;e&&(--r,i=r-1);let{pickRequests:a}=this,{gl:o}=this,l=!1,c=!1,d;for(let m of a){let{sync:y}=m;if(y===null)continue;let{frameNumber:v}=m;if(!c&&v>=r-1){if(t||o.getSyncParameter(y,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(m),c=!0;else if(v!==i){l=!0;continue}}o.deleteSync(y),m.sync=null,d=m}let{pickTimerId:p}=this;l&&p===-1?this.scheduleCheckForPickRequestCompletion():!l&&p!==-1&&(window.clearTimeout(p),this.pickTimerId=-1),!e&&d!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(d)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:r}=this;r[0]=r[1];let i=this.context.frameNumber,a=r[1];if(a.frameNumber=i,a.viewportWidth=e,a.viewportHeight=t,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:r}=this;return e<t?(r==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:r}=this;for(let i of r){let{sync:a}=i;if(a!==null)if(i.frameNumber<e-1)t.deleteSync(a);else continue;this.issuePickRequestInternal(i);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let r=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==r||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:r}=this,i=r.getBoundingClientRect(),a=e-(i.left+r.clientLeft),o=t-(i.top+r.clientTop),{mouseState:l}=this.viewer;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(a,o)}onMousemove(e,t=!0){let{element:r}=this;t&&e.target!==r||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;let{clientX:r,clientY:i}=e.targetTouches[0];this.handleMouseMove(r,i)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:r}=this;r!==-1&&window.clearTimeout(r);for(let i of this.pickRequests)t.deleteBuffer(i.buffer);super.disposed()}};var B8=[1.5,2,3,5,7.5,10];var DO=class{constructor(){this.allowedSignificands=B8;this.targetLengthInPixels=0;this.physicalSizePerPixel=0;this.prevPhysicalSizePerPixel=0;this.prevTargetLengthInPixels=0;this.prevPhysicalUnit="\0"}update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let r=t*e,i=Math.floor(Math.log10(r)),a=10**i,o=r/a,l=1;for(let p of this.allowedSignificands)if(Math.abs(p-o)<Math.abs(l-o))l=p;else break;let c=l*a,d=ib(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${d.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(i-d.exponent),!0}};function U8(n,e,t,r,i){let a=document.createElement("canvas"),o=a.getContext("2d"),l=i.textHeightInPixels*i.scaleFactor,c=`bold ${l}px ${i.fontName}`;o.font=c,o.fillStyle="white";let d=`${r}${n.physicalLength} ${n.physicalUnit}`,p=o.measureText(d),m=Math.max(n.lengthInPixels,p.width),y=i.barHeightInPixels*i.scaleFactor,v=i.barTopMarginInPixels*i.scaleFactor,b=y+v+l,x=i.paddingInPixels*i.scaleFactor,C=b+2*x,k=m+2*x;return a.width=k,a.height=C,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,k,C),o.fillStyle="white",o.fillText(d,k/2,C-x-y-v),o.fillRect(x,C-x-y,n.lengthInPixels,y),dP(e,t,a),{width:k,height:C}}var PO=class extends z{constructor(e,t=new DO){super();this.gl=e;this.dimensions=t;this.texture=null;this.width=0;this.height=0;this.label="";this.factor=1;this.priorOptions=void 0;this.prevLabel=""}update(e){let{dimensions:t,label:r}=this,{texture:i}=this;if(!t.update()&&i!==null&&e===this.priorOptions&&r==this.prevLabel)return;i===null&&(i=this.texture=this.gl.createTexture());let{width:a,height:o}=U8(t,this.gl,i,r,e);this.priorOptions=e,this.prevLabel=r,this.width=a,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}},rf=class extends z{constructor(e){super();this.gl=e;this.scaleBarCopyHelper=this.registerDisposer(Ca.get(this.gl));this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new PO(e)))}draw(e,t,r,i,a){let{scaleBars:o}=this,{displayRank:l,displayDimensionIndices:c,canonicalVoxelFactors:d,globalDimensionNames:p,displayDimensionUnits:m,displayDimensionScales:y}=t,{factors:v}=r,b=Math.min(a.maxWidthFraction*e.logicalWidth,a.maxWidthInPixels*a.scaleFactor),x=0;for(let I=0;I<l;++I){let A=c[I],D=m[I],E=v[A],V,N,U;for(V=0;V<x&&(N=o[V],U=N.dimensions,!(U.physicalBaseUnit===D&&N.factor===E));++V);V===x&&(++x,N=o[V],N.label="",U=N.dimensions,N.factor=E,U.physicalBaseUnit=D,U.targetLengthInPixels=b,U.physicalSizePerPixel=y[I]*i/d[I]),N.label+=`${p[A]} `}let{gl:C,scaleBarCopyHelper:k}=this,M=a.bottomPixelOffset*a.scaleFactor;for(let I=x-1;I>=0;--I){let A=o[I];x===1?A.label="":A.label+=": ",A.update(a),C.viewport(a.leftPixelOffset*a.scaleFactor-e.visibleLeftFraction*e.logicalWidth,M-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,A.width,A.height),k.draw(A.texture),M+=A.height+a.marginPixelsBetweenScaleBars*a.scaleFactor}}},F8={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},IO={...F8,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function G8(n){let e={...IO};for(let t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])$(n,t,r=>{r!==void 0&&(e[t]=jn(r))});return $(n,"fontName",t=>{t!==void 0&&(e.fontName=ae(t))}),e}var L0=class extends lt{constructor(){super(IO,G8)}};var ci;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(ci||(ci={}));var W8=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,z8=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,H8=[z8,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function E0(n){n.addOutputBuffer("vec4","out_color",0),n.addOutputBuffer("highp vec4","out_z",1),n.addOutputBuffer("highp vec4","out_pickId",2),n.addFragmentCode(W8)}function $8(n){n.addOutputBuffer("vec4","v4f_fragData0",0),n.addOutputBuffer("vec4","v4f_fragData1",1),n.addFragmentCode(H8)}var Eo=K.create(),AO=or.create(),j8=ie.create();function q8(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}var J8=ba(Rn),MO=class extends J8{constructor(e){super();this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new ul(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}},af=class extends nf{constructor(e,t,r){super(e,t,r);this.sliceViews=this.registerDisposer(new Bl((e,t,r)=>{e.registerDisposer(r),e.registerDisposer(r.visibility.add(this.visibility))}));this.axesLineHelper=this.registerDisposer(Wl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(dl.get(this.gl,E0));this.offscreenFramebuffer=this.registerDisposer(new Gi(this.gl,{colorBuffers:[new xa(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new xa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new xa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new Rb(this.gl)}));this.offscreenCopyHelper=this.registerDisposer(Ca.get(this.gl));this.transparencyCopyHelper=this.registerDisposer(Ca.get(this.gl,q8,2));this.scaleBars=this.registerDisposer(new rf(this.gl));this.projectionParameters=this.registerDisposer(new tp({navigationState:this.navigationState,update:(a,o)=>{let{invViewMatrix:l,projectionMat:c,logicalWidth:d,logicalHeight:p}=a,m=d/p,y=Math.PI/4,{relativeDepthRange:v}=o,x=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let C=Math.max(.1,1-v),k=1+v;ie.ortho(c,-m,m,-1,1,C,k)}else{let C=1/Math.tan(y/2);v/=C;let k=Math.max(.1,1-v),M=1+v;x*=C,ie.perspective(c,y,m,k,M)}Uh(a,c),o.pose.toMat4(l,x),ie.scale(l,l,K.set(Eo,1,-1,-1)),ie.translate(l,l,Xr[2]),Hh(a)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let i=this.sharedObject=this.registerDisposer(new MO(this));if(i.RPC_TYPE_ID=CO,i.initializeCounterpart(r.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=Qg(this.viewer.layerManager,Wr,this.viewer.visibleLayerRoles,this),ue(t,"rotate-via-mouse-drag",a=>{Kn(a.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative(Xr[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(Xr[0],-c/4*Math.PI/180)})}),ue(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(Xr[2],o.angle-o.prevAngle)}),ue(t,"rotate-out-of-plane-via-touchtranslate",a=>{let{detail:o}=a;this.navigationState.pose.rotateRelative(Xr[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Xr[0],-o.deltaY/4*Math.PI/180)}),r.showSliceViewsCheckbox){let a=this.registerDisposer(new Lr(r.showSliceViews));a.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(a.element),this.element.appendChild(o)}this.registerDisposer(r.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){let r=Eo,{viewProjectionMat:i,invViewProjectionMat:a,logicalWidth:o,logicalHeight:l}=this.projectionParameters.value,{pose:c}=this.viewer.navigationState;c.updateDisplayPosition(d=>{K.transformMat4(r,d,i),r[0]+=-2*e/o,r[1]+=2*t/l,K.transformMat4(d,r,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[o,l]of this.sliceViews)if((l||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:a}=this.visibleLayerTracker;for(let[o,l]of a)if(!o.isReady(i,l))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:r}}=this,i=t*r,a=new Float32Array(i*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}let o=new Float32Array(i);for(let l=0;l<i;++l)o[l]=a[l*4];return o}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-Tn,t-Tn,0,yt,yt),r.readPixelFloat32IntoBuffer(2,e-Tn,t-Tn,4*4*yt*yt,yt,yt)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,Ay(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let o=bu.length;for(let l=0;l<o;++l){let c=bu[l],d=r[4*c];if(d===0)continue;let p=c%yt,m=(c-p)/yt,y=1-d;Eo[0]=2*(e+p-Tn)/i.viewportWidth-1,Eo[1]=2*(t+m-Tn)/i.viewportHeight-1,Eo[2]=2*y-1,K.transformMat4(Eo,Eo,i.invTransform);let{position:v,unsnappedPosition:b}=a,{value:x}=this.navigationState.position,C=x.length;v.length!==C&&(v=a.position=new Float32Array(C)),b.length!==C&&(b=a.unsnappedPosition=new Float32Array(C)),v.set(x),a.coordinateSpace=this.navigationState.coordinateSpace.value;let k=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:M}=k;for(let A=0,D=M.length;A<D;++A)v[M[A]]=Eo[A];b.set(v);let I=r[4*yt*yt+4*c];i.pickIDs.setMouseState(a,I),a.displayDimensions=k,a.setActive(!0);return}a.setActive(!1)}translateDataPointByViewportPixels(e,t,r,i){let a=Eo,{viewProjectionMat:o,invViewProjectionMat:l,width:c,height:d}=this.projectionParameters.value;return K.transformMat4(a,t,o),a[0]+=2*r/c,a[1]+=-2*i/d,K.transformMat4(e,a,l)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new Gi(this.gl,{colorBuffers:al(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:r}=this.renderViewport,i=this.viewer.showSliceViews.value;for(let[x,C]of this.sliceViews)(C||i)&&x.updateRendering();let a=this.gl;this.offscreenFramebuffer.bind(t,r),a.disable(a.SCISSOR_TEST),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.stencilMask(4294967295),a.clearStencil(0),a.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let o=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(o[0],o[1],o[2],0),a.clear(a.DEPTH_BUFFER_BIT),a.clearBufferfv(WebGL2RenderingContext.COLOR,0,[o[0],o[1],o[2],0]),a.clearBufferfv(WebGL2RenderingContext.COLOR,1,Td),a.clearBufferfv(WebGL2RenderingContext.COLOR,2,Td),a.enable(a.DEPTH_TEST);let l=this.projectionParameters.value,c=K.create();K.transformQuat(c,Xr[2],this.navigationState.pose.orientation.orientation),K.scale(c,c,-1);let d=.2,p=1-d,m={wireFrame:this.viewer.wireFrame.value,projectionParameters:l,lightDirection:c,ambientLighting:d,directionalLighting:p,pickIDs:e.pickIDs,emitter:E0,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};ie.copy(e.invTransform,l.invViewProjectionMat);let{visibleLayers:y}=this.visibleLayerTracker,v=!1,b=!1;for(let[x,C]of y)x.isTransparent?v=!0:x.isAnnotation?b=!0:x.draw(m,C);if(this.drawSliceViews(m),b){a.enable(WebGL2RenderingContext.BLEND),a.depthFunc(WebGL2RenderingContext.LEQUAL),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[x,C]of y)x.isAnnotation&&x.draw(m,C);a.depthFunc(WebGL2RenderingContext.LESS),a.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),v){a.depthMask(!1),a.enable(WebGL2RenderingContext.BLEND);let{transparentConfiguration:x}=this;x.bind(t,r),this.gl.clearColor(0,0,0,1),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),m.emitter=$8,a.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),m.emitPickID=!1;for(let[C,k]of y)C.isTransparent&&C.draw(m,k);a.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(0),a.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(x.colorBuffers[0].texture,x.colorBuffers[1].texture),a.depthMask(!0),a.disable(WebGL2RenderingContext.BLEND),a.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(t,r),a.enable(WebGL2RenderingContext.STENCIL_TEST),a.drawBuffers([a.NONE,a.COLOR_ATTACHMENT1,a.COLOR_ATTACHMENT2]),m.emitter=E0,m.emitPickID=!0,m.emitColor=!1,a.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),a.stencilMask(2);for(let[C,k]of y)!C.isTransparent||!C.transparentPickEnabled||C.draw(m,k);a.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),a.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),a.stencilMask(0);for(let[C,k]of y)!C.isTransparent||C.transparentPickEnabled||C.draw(m,k)}if(a.stencilMask(4294967295),a.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){a.drawBuffers([a.COLOR_ATTACHMENT0]),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:x}=this,C=this.viewer.scaleBarOptions.value;x.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,C),a.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:r,ambientLighting:i,directionalLighting:a,projectionParameters:{viewProjectionMat:o}}=e,l=this.viewer.showSliceViews.value;for(let[c,d]of this.sliceViews){if(!d&&!l)continue;let{width:p,height:m,invViewMatrix:y,viewportNormalInCanonicalCoordinates:v}=c.projectionParameters.value;if(p===0||m===0||!c.valid)continue;let b=Math.abs(K.dot(r,v)),x=i+b*a,C=j8;ie.identity(C),C[0]=p/2,C[5]=-m/2,ie.multiply(C,y,C),ie.multiply(C,o,C);let k=AO,M=this.viewer.crossSectionBackgroundColor.value;k[0]=M[0],k[1]=M[1],k[2]=M[2],k[3]=1,t.draw(c.offscreenFramebuffer.colorBuffers[0].texture,C,or.fromValues(x,x,x,1),AO,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,r=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,i=e*r,{gl:a}=this;a.drawBuffers([a.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(Iy(t,i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}};var xu;(function(r){r[r.COLOR=0]="COLOR",r[r.PICK=1]="PICK",r[r.NUM_TEXTURES=2]="NUM_TEXTURES"})(xu||(xu={}));function Y8(n){n.addOutputBuffer("vec4","out_fragColor",0),n.addOutputBuffer("highp vec4","out_pickId",1),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function K8(n){n.addOutputBuffer("vec4","out_fragColor",null),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}var zl=K.create(),X8=K.create(),Q8=or.create(),Cu=class extends nf{constructor(e,t,r,i){super(e,t,i);this.sliceView=r;this.axesLineHelper=this.registerDisposer(Wl.get(this.gl));this.sliceViewRenderHelper=this.registerDisposer(dl.get(this.gl,K8));this.colorFactor=or.fromValues(1,1,1,1);this.pickIDs=new tf;this.offscreenFramebuffer=this.registerDisposer(new Gi(this.gl,{colorBuffers:[new xa(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new xa(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]}));this.offscreenCopyHelper=this.registerDisposer(Ca.get(this.gl));this.scaleBars=this.registerDisposer(new rf(this.gl));i.wireFrame.changed.add(()=>this.scheduleRedraw()),ue(t,"rotate-via-mouse-drag",a=>{let{mouseState:o}=this.viewer;if(o.updateUnconditionally()){let l=Float32Array.from(o.position);Kn(a.detail,(c,d,p)=>{let{pose:m}=this.navigationState,y=K.transformQuat(zl,Xr[0],m.orientation.orientation),v=K.transformQuat(X8,Xr[1],m.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(v,-d/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(y,-p/4*Math.PI/180,l)})}}),ue(t,"rotate-in-plane-via-touchrotate",a=>{let{detail:o}=a,{mouseState:l}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(r),this.visibleLayerTracker=Qg(this.viewer.layerManager,Pa,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.visibility.add(this.visibility)),this.registerDisposer(r.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(i.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(i.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){let{pose:r}=this.viewer.navigationState;r.updateDisplayPosition(i=>{K.set(i,-e,-t,0),K.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,r,i){let a=this.sliceView.projectionParameters.value;return K.transformMat4(e,t,a.viewMatrix),K.set(e,e[0]+r,e[1]+i,e[2]),K.transformMat4(e,e,a.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[r,i]of this.visibleLayerTracker.visibleLayers)if(!r.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let r=t.projectionParameters.value,{width:i,height:a,invViewProjectionMat:o}=r;ie.copy(e.invTransform,o);let{gl:l}=this;this.offscreenFramebuffer.bind(i,a),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let c=Q8,d=this.viewer.crossSectionBackgroundColor.value;c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,Th,this.colorFactor,c,0,0,1,1);let{visibleLayers:p}=this.visibleLayerTracker,{pickIDs:m}=this;m.clear();let y={wireFrame:this.viewer.wireFrame.value,projectionParameters:r,pickIDs:m,emitter:Y8,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(i,a),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(let[v,b]of p)v.draw(y,b);if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let v=Math.min(r.logicalWidth,r.logicalHeight)/4*1.5,{zoomFactor:{value:b}}=this.viewer.navigationState;this.axesLineHelper.draw(_1(Iy(r,v*b)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(r,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:r}=this;r.readPixelFloat32IntoBuffer(1,e-Tn,t-Tn,0,yt,yt)}completePickRequest(e,t,r,i){let{mouseState:a}=this.viewer;a.pickedRenderLayer=null,Ay(r,0,4,e,t,i.viewportWidth,i.viewportHeight);let{viewportWidth:o,viewportHeight:l}=i,c=bu.length,{value:d}=this.navigationState.position,p=d.length,m=this.navigationState.pose.displayDimensions.value,{displayRank:y,displayDimensionIndices:v}=m,b=(k,M,I)=>{let A=e+k,D=t+M;zl[0]=2*A/o-1,zl[1]=2*D/l-1,zl[2]=0,K.transformMat4(zl,zl,i.invTransform),I.set(d);for(let E=0;E<y;++E)I[v[E]]=zl[E]},{unsnappedPosition:x}=a;x.length!==p&&(x=a.unsnappedPosition=new Float32Array(p)),a.coordinateSpace=this.navigationState.coordinateSpace.value,a.displayDimensions=m,b(0,0,x);let C=(k,M,I)=>{let{position:A}=a;A.length!==p&&(A=a.position=new Float32Array(p)),b(k-Tn,M-Tn,A),this.pickIDs.setMouseState(a,I),a.setActive(!0)};for(let k=0;k<c;++k){let M=bu[k],I=r[4*k];if(I===0)continue;let A=M%yt,D=(M-A)/yt;C(A,D,I);return}C(Tn,Tn,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:r}=this,{width:i,height:a,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:l,displayRank:c}}=r.projectionParameters.value,{mouseX:d,mouseY:p}=this;d-=i/2,p-=a/2;let m=this.navigationState.position.value;for(let y=0;y<c;++y){let v=l[y],b=o[y]*d+o[4+y]*p;m[v]+=b*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}};var RO=rt(Ct());var Z8=["#f00","#0f0","#00f"],_O=Fe.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function eY(n){if(n<1||n>1024){let e=Math.log2(n)|0,t=n/2**e;return`${gy(t,1)}p${e}`}return n.toString()}var tY=[n=>n.name,n=>n.scaleFactor],nY=2e3,D0=class extends z{constructor(e,t,r,i="px"){super();this.displayDimensionRenderInfo=e;this.zoom=t;this.depthRange=r;this.displayUnit=i;this.element=document.createElement("div");this.dimensionGridContainer=document.createElement("div");this.depthGridContainer=document.createElement("div");this.defaultCheckbox=document.createElement("input");this.dimensionElements=Array.from(Array(3),(e,t)=>{let r=document.createElement("div");r.classList.add("neuroglancer-display-dimensions-widget-dimension"),r.style.display="contents",ue(r,"adjust-via-wheel",d=>{let p=d.detail,{deltaY:m}=p;m!==0&&this.zoomDimension(t,Math.sign(m))});let i=document.createElement("input");i.classList.add("neuroglancer-display-dimensions-widget-name"),i.title="Change display dimensions",i.spellcheck=!1,i.autocomplete="off",i.style.color=Z8[t],i.style.gridColumn="1",i.style.gridRow=`${t+1}`,i.addEventListener("focus",()=>{i.select()}),r.appendChild(i);let a=document.createElement("span");a.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let o=document.createElement("input");o.spellcheck=!1,o.title="Change relative scale at which dimension is displayed",o.autocomplete="off",a.style.gridColumn="2",a.style.gridRow=`${t+1}`,o.addEventListener("focus",()=>{o.select()}),a.appendChild(o),r.appendChild(a);let l=document.createElement("span");l.classList.add("neuroglancer-display-dimensions-widget-scale"),l.style.gridColumn="3",l.style.gridRow=`${t+1}`,r.appendChild(l),this.dimensionGridContainer.appendChild(r);let c={name:i,container:r,scaleFactor:o,scale:l,scaleFactorModified:!1};i.addEventListener("input",()=>{Vn(i),this.updateNameValidity()}),ue(i,"commit",()=>{this.updateNames()}),i.addEventListener("blur",d=>{let{relatedTarget:p}=d;this.dimensionElements.some(m=>m.name===p)||this.updateNames()||this.updateView()}),a.addEventListener("click",d=>{let{target:p}=d;p!==o&&(o.focus(),d.preventDefault())}),o.addEventListener("input",()=>{Vn(o),c.scaleFactorModified=!0}),ue(o,"commit",()=>{this.updateScaleFactors()}),o.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(let d of tY)ue(d(c),"move-up",()=>{t!==0&&d(this.dimensionElements[t-1]).focus()}),ue(d(c),"move-down",()=>{t!==2&&d(this.dimensionElements[t+1]).focus()});return c});this.scheduleUpdateView=Ye(()=>this.updateView());let{element:a,dimensionGridContainer:o,defaultCheckbox:l}=this,c=document.createElement("label"),d=this.registerCancellable((0,RO.default)(()=>{a.dataset.active="false"},nY)),p=()=>{a.dataset.active="true",d()};this.registerDisposer(t.changed.add(p)),this.registerDisposer(e.relativeDisplayScales.changed.add(p)),this.registerDisposer(r.changed.add(p)),a.classList.add("neuroglancer-display-dimensions-widget"),a.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),a.addEventListener("pointerleave",()=>{let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));let m=this.registerDisposer(new sn(a,_O));m.allShortcutsAreGlobal=!0,this.registerDisposer(new On(a,_O)),ue(o,"cancel",()=>{this.updateView();let x=document.activeElement;x instanceof HTMLElement&&a.contains(x)&&x.blur()});let{depthGridContainer:y}=this;y.classList.add("neuroglancer-depth-range-widget-grid"),a.appendChild(y);let v=document.createElement("label"),b=document.createElement("input");b.type="checkbox",v.classList.add("neuroglancer-depth-range-relative-checkbox-label"),b.classList.add("neuroglancer-depth-range-relative-checkbox"),v.appendChild(b),v.appendChild(document.createTextNode("Zoom-relative")),b.addEventListener("change",()=>{let x=b.checked,C=this.depthRange.value;x!==C<0&&(x?C=-C/this.zoom.value:C=-C*this.zoom.value,this.depthRange.value=C)}),v.title="Depth range is multiplied by scale",a.appendChild(v),ue(y,"adjust-via-wheel",x=>{let C=x.detail,{deltaY:k}=C;if(k===0)return;let M=this.depthRange.value;this.depthRange.value=M*2**Math.sign(k)}),this.registerDisposer(ar((x,C,{factors:k})=>{We(y);let{displayRank:M,globalDimensionNames:I,displayDimensionIndices:A,displayDimensionUnits:D,displayDimensionScales:E,canonicalVoxelFactors:V}=C,N=[],U=()=>{b.checked=this.depthRange.value<0;let R=this.depthRange.value;R<0&&(R*=-this.zoom.value);for(let X of N){let{input:j}=X;j.value=Bi(R*X.scale,X.unit,{precision:2,elide1:!1}),Vn(j)}},_=R=>{let X=Xo(R.input.value);if(X===void 0||X.unit!==R.unit)return!1;let j=X.scale/R.scale;return this.depthRange.value<0&&(j=-j/this.zoom.value),this.depthRange.value=j,!0};for(let R=0;R<M;++R){let X=A[R],j=I[X],oe=D[R],me=k[X],xe=N.find(se=>se.unit===oe&&se.factor===me);if(xe===void 0){let se=document.createElement("div");se.title="Visible depth range",se.style.display="contents",y.appendChild(se);let Se=document.createElement("span");Se.textContent="\xB1",se.appendChild(Se);let Ie=document.createElement("input");Ie.spellcheck=!1,Ie.autocomplete="off",Ie.addEventListener("focus",()=>{Ie.select()}),ue(Ie,"commit",()=>{_(xe)}),Ie.addEventListener("change",()=>{_(xe)||U()}),Ie.addEventListener("input",()=>{Vn(Ie)}),se.appendChild(Ie);let je=document.createElement("span");je.classList.add("neuroglancer-depth-range-widget-dimension-names"),se.appendChild(je),xe={unit:oe,factor:me,dimensionNames:[],input:Ie,label:je,scale:E[R]/V[R]},N.push(xe)}xe.dimensionNames.push(j)}for(let R of N)R.dimensionNames.length!==M&&(R.label.textContent=R.dimensionNames.join(" "));x.registerDisposer(ue(y,"cancel",()=>{U();let R=document.activeElement;R instanceof HTMLElement&&y.contains(R)&&R.blur()}));let B=x.registerCancellable(Ye(U));x.registerDisposer(this.depthRange.changed.add(B)),x.registerDisposer(this.zoom.changed.add(B)),U()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:r}=this,{relativeDisplayScales:i}=this,{displayDimensionIndices:a}=r.value,o=a[e];if(o===-1)return;let{factors:l}=i.value,c=new Float64Array(l);c[o]*=2**-t,i.setFactors(c)}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,r=e.map(c=>c.name.value),i=Ud(r),a=this.displayDimensions.coordinateSpace.value,{names:o}=a,l=r.length;for(let c=0;c<l;++c){let d=i[c],p=r[c],m=-1;p.length===0?d=!0:(m=o.indexOf(p),m===-1&&(d=!1));let y=e[c];y.name.dataset.isValid=d.toString(),y.container.dataset.isModified=(m!==t[c]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){let e=this.dimensionElements.map(l=>l.name.value).filter(l=>l.length>0);if(!Oc(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;let r=new Int32Array(3);r.fill(-1);let i=t.coordinateSpace.value,{names:a}=i,o=e.length;for(let l=0;l<o;++l){let c=a.indexOf(e[l]);if(c===-1)return!1;r[l]=c}return Ee(r,t.value.displayDimensionIndices)||t.setDimensionIndices(o,r),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:r,displayRank:i}=e.value,{factors:a}=t.value,{dimensionElements:o}=this,l=new Float64Array(a);for(let c=0;c<i;++c){let d=o[c];if(!d.scaleFactorModified)continue;let p=Number(d.scaleFactor.value),m=r[c];!Number.isFinite(p)||p<=0||(l[m]=p)}return Ee(l,a)||t.setFactors(l),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:r,canonicalVoxelFactors:i,displayDimensionUnits:a,displayDimensionScales:o,globalDimensionNames:l}=this.displayDimensionRenderInfo.value,{factors:c}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let d=this.zoom.value,p=r[0],m=!0;if(p!==-1){let y=a[0],v=c[p];for(let b=1;b<3;++b){let x=r[b];if(x!==-1&&(a[b]!==y||c[x]!==v)){m=!1;break}}}for(let y=0;y<3;++y){let v=r[y],b=e[y];if(delete b.name.dataset.isValid,b.container.dataset.isModified=(v===-1).toString(),v===-1)b.name.value="",b.scale.textContent="",b.scaleFactor.value="";else{b.name.value=l[v];let x=o[y]*d/i[y];if(y===0||!m){let C=Bi(x,a[y],{precision:2,elide1:!1});b.scale.textContent=`${C}/${this.displayUnit}`}else b.scale.textContent="";b.scaleFactor.value=eY(c[v])}Vn(b.name),Vn(b.scaleFactor)}}disposed(){ut(this.element),super.disposed()}};var OO=new Map([["xy",void 0],["xz",at.rotateX(at.create(),at.create(),Math.PI/2)],["yz",at.rotateY(at.create(),at.create(),Math.PI/2)]]),NO="\u25FB",P0=new Map([["4panel","\u25F1"],["3d",NO]]);function rY(n,e){let t;return e===void 0?t=n.navigationState.addRef():t=new _a(new Ra(n.navigationState.pose.position.addRef(),n.navigationState.pose.displayDimensionRenderInfo.addRef(),xo.makeRelative(n.navigationState.pose.orientation,e)),n.navigationState.zoomFactor.addRef(),n.navigationState.depthRange.addRef()),new $c(n.chunkManager,n.layerManager,t,n.wireFrame)}function of(n,e){return rY(n,OO.get(e))}function iY(n){return new Map([["xy",of(n,"xy")],["xz",of(n,"xz")],["yz",of(n,"yz")]])}function BO(n){return{crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor,selectionDetailsState:n.selectionDetailsState,mouseState:n.mouseState,layerManager:n.layerManager,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,visibleLayerRoles:n.visibleLayerRoles,selectedLayer:n.selectedLayer,visibility:n.visibility,scaleBarOptions:n.scaleBarOptions}}function I0(n){let{viewer:e}=n;return{...BO(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:n.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function My(n){return{...BO(n),navigationState:n.navigationState,inputEventMap:n.inputEventBindings.sliceView}}function wu(n,e){let{navigationState:t}=e;e.element.appendChild(n.registerDisposer(new D0(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof Cu?"px":"vh")).element)}function Tu(n,e,t){let r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",n.registerDisposer(()=>ut(r));for(let i=0;i<2;++i){let a=t[Math.min(t.length-1,i)];n.registerDisposer(ue(e.element,i===0?"toggle-layout":"toggle-layout-alternative",o=>{n.container.name=a,o.stopPropagation()}))}for(let i of t){let a=document.createElement("button"),o=document.createElement("div");a.appendChild(o),o.textContent=P0.get(i),a.title=`Switch to ${i} layout.`,a.addEventListener("click",()=>{n.container.name=i}),r.appendChild(a)}e.element.appendChild(r)}function aY(n,e){let t=new $c(n.chunkManager,n.layerManager,e.navigationState.addRef(),n.wireFrame),r=()=>{let{width:{value:i},height:{value:a}}=e;t.projectionParameters.setViewport({width:i,height:a,logicalWidth:i,logicalHeight:a,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(r)),t.registerDisposer(e.height.changed.add(r)),r(),t}function A0(n,e,t){let r=new Map;(()=>{let a=new Set;for(let o of t.values()){if(a.add(o),r.has(o))continue;let l=aY(n,o);e.sliceViews.set(l,!0),r.set(o,l)}for(let[o,l]of r)a.has(o)||e.sliceViews.delete(l)})()}var UO=class extends z{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=iY(r),{display:o}=r,l={...I0(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},c={...My(r),showScaleBar:r.showScaleBar},d={...My(r),showScaleBar:new Mt(!1,!1)},p=(y,v,b,x)=>{let C=this.registerDisposer(new Cu(o,v,a.get(y),b));return x&&wu(this,C),Tu(this,C,[y,`${y}-3d`]),C},m=[li(1,_s("column",[li(1,_s("row",[li(1,y=>{p("xy",y,c,!0)}),li(1,y=>{p("xz",y,d,!1)})])),li(1,_s("row",[li(1,y=>{let v=this.registerDisposer(new af(o,y,l));for(let b of a.values())v.sliceViews.set(b.addRef(),!1);wu(this,v),A0(r,v,i),Tu(this,v,["3d"])}),li(1,y=>{p("yz",y,d,!1)})]))]))];_s("row",m)(t)}disposed(){We(this.rootElement),super.disposed()}},FO=class extends z{constructor(e,t,r,i,a,o){super();this.container=e;this.rootElement=t;this.viewer=r;this.direction=i;let l=of(r,a),{display:c}=r,d={...I0(e),showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},p={...My(r),showScaleBar:r.showScaleBar};li(1,_s(i,[li(1,m=>{let y=this.registerDisposer(new Cu(c,m,l,p));wu(this,y),Tu(this,y,[a,"4panel"])}),li(1,m=>{let y=this.registerDisposer(new af(c,m,d));y.sliceViews.set(l.addRef(),!1),A0(r,y,o),wu(this,y),Tu(this,y,["3d","4panel"])})]))(t)}disposed(){We(this.rootElement),super.disposed()}},GO=class extends z{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a=of(r,i),o={...My(r),showScaleBar:r.showScaleBar};_s("row",[li(1,l=>{let c=this.registerDisposer(new Cu(r.display,l,a,o));wu(this,c),Tu(this,c,["4panel",`${i}-3d`])})])(t)}disposed(){We(this.rootElement),super.disposed()}},WO=class extends z{constructor(e,t,r,i){super();this.container=e;this.rootElement=t;this.viewer=r;let a={...I0(e),showSliceViews:new Mt(!1,!1)};_s("row",[li(1,o=>{let l=this.registerDisposer(new af(r.display,o,a));A0(r,l,i),wu(this,l),Tu(this,l,["4panel"])})])(t)}disposed(){We(this.rootElement),super.disposed()}},M0=new Map([["4panel",{factory:(n,e,t,r)=>new UO(n,e,t,r)}],["3d",{factory:(n,e,t,r)=>new WO(n,e,t,r)}]]);for(let n of OO.keys()){M0.set(n,{factory:(t,r,i)=>new GO(t,r,i,n)});let e=`${n}-3d`;P0.set(n,NO),P0.set(e,"\u25EB"),M0.set(e,{factory:(t,r,i,a)=>new FO(t,r,i,"row",n,a)})}function zO(n){let e=M0.get(n);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(n)}.`);return e}function oY(n){return zO(n),n}var HO=class extends z{constructor(e){super();this.width=new lt(1e3,Bt);this.height=new lt(1e3,Bt);this.changed=new re;this.position=new _p(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new lu(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new cu(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new _a(new Ra(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){Z(e),Cn(e,"width",this.width),Cn(e,"height",this.height),Cn(e,"position",Al(this.position)),Cn(e,"orientation",this.orientation),Cn(e,"scale",this.scale),Cn(e,"zoom",Al(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}},$O=class extends Bl{constructor(e){super((t,r)=>t.registerDisposer(t.registerDisposer(r).changed.add(this.changed.dispatch)));this.parentNavigationState=e;this.registerDisposer(e)}restoreState(e){Z(e);for(let t of Object.keys(e)){let r=new HO(this.parentNavigationState);try{this.set(t,r.addRef()),r.restoreState(e[t])}finally{r.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;let e={};for(let[t,r]of this)e[t]=r.toJSON();return e}},jO=class extends z{constructor(e,t){super();this.changed=new re;this.orthographicProjection=new Mt(!1);this.type=new lt(t,oY),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new $O(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(Z(e),$(e,"type",t=>this.type.restoreState(t)),$(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),$(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:r}=this,i=r.toJSON();return t.size===0&&i===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:i}}},R0=class extends z{constructor(e,t){super();this.viewer=e;this.element=document.createElement("div");this.specification=this.registerDisposer(new jO(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let r=this.registerCancellable((0,VO.default)(()=>this.updateLayout(),0));this.specification.type.changed.add(r),ue(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>r.flush())),r()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=zO(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}};var qO=typeof STATE_SERVERS!="undefined"&&Object.keys(STATE_SERVERS).length>0,_0=class extends z{constructor(e){super();this.element=document.createElement("div");this.button=it({text:"Share",title:"Share State"});if(typeof STATE_SERVERS=="undefined")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let r=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(i=>i.url).includes(r)&&(t.value=r)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(let[r,i]of Object.entries(STATE_SERVERS)){let a=document.createElement("option");a.textContent=r,a.value=i.url,a.selected=!!i.default,t.appendChild(a)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,r=new URL(t).protocol,{url:i,credentialsProvider:a}=mr(t,Py);Ke.forPromise(Xi(a,i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},$t).then(o=>{let l=new URL(o);l.protocol=r;let c=`${window.location.origin}/#!${l}`;navigator.clipboard.writeText(c).then(()=>{Ke.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ke.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}};function sY(n){return n.startsWith("key")?n.substring(3):n.startsWith("digit")||n.startsWith("arrow")?n.substring(5):n}function lY(n){return n.split("+").map(sY).join("+")}var cY={...wi,side:"left",row:1},V0=class{constructor(){this.location=new ur(cY)}get changed(){return this.location.changed}toJSON(){return Oi(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},O0=class extends zr{constructor(e,t,r,i,a){super(e,t.location);this.bindings=r;this.toolBinder=a;this.scroll=document.createElement("div");this.addTitleBar({title:"Help"});let o=document.createElement("div");o.classList.add("neuroglancer-help-body");let{scroll:l}=this;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);let c=this.registerCancellable(Ye(()=>this.updateView()));this.registerDisposer(a.changed.add(c)),this.registerDisposer(i.layersChanged.add(c)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:r}=this;We(e);let i=new Map;function a(p,m){for(let y of p.parents)y.label!==void 0?o(y.label,y):a(y,m);for(let[y,v]of p.bindings.entries()){let b=y.indexOf(":"),x=y.substring(b+1);m.set(x,v.action)}}function o(p,m){if(i.has(m))return;let y={label:p,entries:new Map};a(m,y.entries),i.set(m,y)}for(let[p,m]of t)o(p,m);let l=(p,m)=>{let y=document.createElement("h2");y.textContent=p,e.appendChild(y);for(let[v,b]of m){let x=document.createElement("div");x.className="dt",x.textContent=lY(v);let C=document.createElement("div");C.className="dd",C.textContent=b,e.appendChild(x),e.appendChild(C)}},c=new Map;for(let[p,m]of r.bindings){let y=c.get(m.layer);y===void 0&&(y=[],c.set(m.layer,y)),y.push([`shift+key${p.toLowerCase()}`,m.description])}let d=Array.from(c.entries());d.length>0&&(d[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),d.sort((p,m)=>p[0].managedLayer.nonArchivedLayerIndex-m[0].managedLayer.nonArchivedLayerIndex));for(let[p,m]of d)m.sort(),l(`Tool bindings for layer ${p.managedLayer.nonArchivedLayerIndex+1}: ${p.managedLayer.name}`,m);for(let p of i.values())l(p.label,p.entries)}};var H0=rt(Ct());var rN=rt(Ct());function uY(n,e){n.style.display="block";let{offsetWidth:t,offsetHeight:r}=n,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(i-t,e.clientX),l=document.documentElement.scrollTop+Math.min(a-r,e.clientY);n.style.left=o+"px",n.style.top=l+"px"}var N0=class extends z{constructor(e){super();this.element=document.createElement("div");this.parentDisposers=new Map;this.disabledValue=!1;this.opened=new re;this.closed=new re;let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){let{parentDisposers:t}=this;t.has(e)||t.set(e,Gn(e,"contextmenu",r=>{this.show(r),r.stopPropagation(),r.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,r=Gn(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),i=Gn(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),a=()=>{i(),r(),t.style.display="none"};this.opened.dispatch(),uY(t,e),this.menuDisposer=a}unregisterParent(e){let{parentDisposers:t}=this,r=t.get(e);r!==void 0&&(r(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),ut(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}};function dY(n){return O1(new TextEncoder().encode(n))}function pY(n){return new TextDecoder().decode(N1(n))}function fY(n,e){if(!!n.startsWith(e))try{let t=pY(n.substring(e.length));return JSON.parse(t)}catch{return}}function JO(n,e){return n+dY(JSON.stringify(e))}function YO(n,e){for(let t of n){let r=fY(t,e);if(r!==void 0)return{parameters:r,dragType:t}}}var KO;function sf(n,e){return n.dataTransfer.dropEffect=e,KO=e,e}function lf(){return KO}function XO(n){return n.draggable=!0,Gn(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}var QO="neuroglancer-layer\0",Pi;function B0(n,e){var i;n.dataTransfer.setData(JO(QO,e.layers.map(a=>({name:a.name,visible:a.visible}))),JSON.stringify({layers:e.layers.map(a=>a.toJSON()),layout:e.layoutSpec})),Pi!==void 0&&Pi.disposer();let t,r=()=>{e.manager.unregisterDisposer(r);for(let a of e.layers)a.dispose();e.manager.dispose(),Pi===t&&(Pi=void 0)};Pi=t={manager:e.manager.addRef(),layers:e.layers.map(a=>a.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(i=e.isLayerListPanel)!=null?i:!1,disposer:r}}function ku(n="none"){if(Pi!==void 0){if(n==="move"){let e=new Set(Pi.layers);Pi.manager.layerManager.filter(t=>!e.has(t))}Pi.disposer()}}function cf(n){return YO(n.dataTransfer.types,QO)}function ZO(n){if(Pi!==void 0&&Pi.manager.rootLayers===n.rootLayers)return Pi}var U0=class{initializeExternalLayers(e){let{dragType:t}=this;if(t!==void 0)try{let{layers:r,layout:i}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(r)||this.numSourceLayers!==r.length)throw new Error("Invalid layer drop data");this.layoutSpec=i;for(let[a,o]of this.layers)S_(a,r[o])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,r=e.dataTransfer.dropEffect;for(let i of this.layers.keys()){let a=t;t&&!i.archived&&r!=="copy"&&this.sourceIsLayerListPanel&&(a=!1),(i.archived!==a||a&&i.visible)&&(i.archived=a,a&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}};function F0(n,e,t){let r;n.shiftKey?r="copy":n.ctrlKey&&t?r="move":r=e;let i="",a=o=>{i!==""&&(i+=", "),i+=o};return e!=="none"&&r!==e&&(n.shiftKey?a(`release SHIFT to ${e}`):a(`release CONTROL to ${e}`)),r!=="copy"&&a("hold SHIFT to copy"),r!=="move"&&t&&e!=="move"&&a("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:i}}function eN(n,e,t,r){let i=ZO(e),a=!1,o;return i===void 0?o="copy":r?(i.isLayerListPanel||(a=!0),o="link"):i.manager===e&&i.isLayerListPanel===t?(o="move",a=!0):t?o="none":(i.isLayerListPanel||(a=!0),o="link"),F0(n,o,a)}function tN(n,e,t,r){let i=eN(n,e,t,r);return sf(n,i.dropEffect),i}function Ry(n,e,t){let{forceCopy:r,newTarget:i,isLayerListPanel:a=!1}=t,o=ZO(e);if(!r&&o!==void 0){let c=!i&&o.manager===e&&(o.isLayerListPanel===a||o.isLayerListPanel),d=new U0;return d.manager=e,d.numSourceLayers=o.layers.length,d.sourceManager=o.manager,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=o.isLayerListPanel,d.moveSupported=c,d.layers=new Map,d.forceCopy=!1,d.layoutSpec=o.layoutSpec,c?o.layers.forEach((p,m)=>{d.layers.set(p,m)}):o.layers.forEach((p,m)=>{(i||!e.layerManager.has(p))&&d.layers.set(p.addRef(),m)}),d}let l=cf(n);if(l!==void 0)try{let c=Te(l.parameters,(p,m)=>{let y=$(p,"name",ae),v=$(p,"visible",ya),b=new Wp(y,e);return a&&(v=!1),b.visible=v,b.archived=a,[b,m]}),d=new U0;return d.numSourceLayers=c.length,d.targetIsLayerListPanel=a,d.sourceIsLayerListPanel=!1,d.sourceManager=void 0,d.moveSupported=!1,d.forceCopy=o!==void 0,d.manager=e,d.dragType=l.dragType,d.layers=new Map(c),d}catch{}}function G0(n,e){return n.moveSupported?!1:(n.manager.layerManager.filter(t=>!n.layers.has(t)),e!==void 0&&n.layers.has(e))}function Lu(n,e,t,r=!1){function i(a,o){let l=n.dropLayers,{dropEffect:c,dropEffectMessage:d}=o?eN(a,n.manager,r,!1):{dropEffect:lf(),dropEffectMessage:""};if(c===void 0)return;sf(a,c);let p=!0;if(!(l!==void 0&&!l.compatibleWithMethod(c)&&(n.dropLayers=void 0,G0(l,t)))){if(l===void 0){if(l=n.dropLayers=Ry(a,n.manager,{forceCopy:c==="copy",newTarget:!1,isLayerListPanel:r}),l===void 0)return;p=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:c,dropEffectMessage:d};if(p){let{layerManager:m}=n.manager,y=new Set,v=Number.POSITIVE_INFINITY,b=m.managedLayers=m.managedLayers.filter((C,k)=>l.layers.has(C)?(v===Number.POSITIVE_INFINITY&&(v=k),y.add(C),!1):!0),x;t!==void 0?(x=b.indexOf(t),v<=x&&++x):x=b.length;for(let C of l.layers.keys())y.has(C)||l.layers.delete(C);b.splice(x,0,...l.layers.keys()),m.layersChanged.dispatch()}else{let m;t!==void 0&&(m=n.manager.layerManager.managedLayers.indexOf(t));for(let y of l.layers.keys())n.manager.add(y,m)}return{dropLayers:l,dropEffect:c,dropEffectMessage:d}}}e.addEventListener("dragenter",a=>{i(a,!0)!==void 0?a.preventDefault():hn(n.element,"drop")}),e.addEventListener("drop",a=>{var l;a.preventDefault(),n.dragEnterCount=0,hn(n.element,"drop");let o=(l=i(a,!1))==null?void 0:l.dropLayers;if(n.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(a)){G0(o);return}o.updateArchiveStates(a),ku(o.method==="move"?void 0:a.dataTransfer.dropEffect)}}),e.addEventListener("dragover",a=>{let o=i(a,!0);if(o===void 0){hn(n.element,"drop");return}let{dropLayers:l,dropEffect:c,dropEffectMessage:d}=o,p=l.layers.size,m="",y=l.numSourceLayers===1?"":"s",v=l.numSourceLayers;if(c==="none")m=`Cannot link dragged layer${y} here`;else{let b=v===p?`${v}`:`${p}/${v}`;m=`Drop to ${c} ${b} layer${y}`}d&&(m+=` (${d})`),Pr(n.element,"drop",m),a.preventDefault(),a.stopPropagation()})}function _y(n,e,t,r){e.draggable=!0,e.addEventListener("dragstart",i=>{Pr(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),B0(i,{manager:n.manager,layers:[t],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),i.stopPropagation()}),e.addEventListener("dragend",()=>{hn(e,"drag"),ku()})}function Vy(n){n.element.addEventListener("dragenter",()=>{++n.dragEnterCount}),n.element.addEventListener("dragleave",()=>{if(--n.dragEnterCount!=0)return;hn(n.element,"drop");let{dropLayers:e}=n;e!==void 0&&(G0(e),n.manager.layerManager.layersChanged.dispatch(),n.dropLayers=void 0)})}var nN=class extends z{constructor(e,t){super();this.layer=e;this.panel=t;this.element=document.createElement("div");this.layerNumberElement=document.createElement("div");this.labelElement=document.createElement("div");this.visibleProgress=document.createElement("div");this.prefetchProgress=document.createElement("div");this.labelElementText=document.createTextNode("");this.valueElement=document.createElement("div");this.maxLength=0;this.prevValueText="";let{element:r,labelElement:i,layerNumberElement:a,valueElement:o,visibleProgress:l,prefetchProgress:c,labelElementText:d}=this;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(l),r.appendChild(c),i.className="neuroglancer-layer-item-label",i.appendChild(d),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";let p=document.createElement("div");p.className="neuroglancer-layer-item-value-container";let m=document.createElement("div");m.className="neuroglancer-layer-item-button-container";let y=Qc();y.title="Remove layer from this layer group",y.addEventListener("click",x=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),x.stopPropagation()});let v=Di();v.title="Delete this layer",v.addEventListener("click",x=>{wo(this.layer),x.stopPropagation()}),r.appendChild(a),p.appendChild(o),p.appendChild(m),m.appendChild(y),m.appendChild(v),r.appendChild(i),r.appendChild(p);let b=this.registerDisposer(new Ps(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(b.element),b.element.addEventListener("click",x=>{x.stopPropagation()}),b.element.addEventListener("dblclick",x=>{x.stopPropagation()}),r.addEventListener("click",x=>{x.ctrlKey?t.selectedLayer.toggle(e):x.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),r.addEventListener("contextmenu",x=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,x.stopPropagation(),x.preventDefault()}),_y(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),Lu(this.panel,r,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let r=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(r+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),r+=", drag to move, shift+drag to copy",t.title=r}disposed(){this.element.remove(),super.disposed()}},W0=class extends z{constructor(e,t,r,i,a,o){super();this.display=e;this.manager=t;this.viewerNavigationState=r;this.selectedLayer=i;this.getLayoutSpecForDrag=a;this.showLayerHoverValues=o;this.layerWidgets=new Map;this.element=document.createElement("div");this.layerUpdateNeeded=!0;this.valueUpdateNeeded=!1;this.layerWidgetInsertionPoint=document.createElement("div");this.positionWidget=this.registerDisposer(new Ps(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner));this.dragEnterCount=0;this.scheduleUpdate=this.registerCancellable(Ye(()=>this.update()));this.registerDisposer(i);let{element:l}=this;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=it({svg:Ml,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let d=this.dropZone=document.createElement("div");d.className="neuroglancer-layer-panel-drop-zone";let p=y=>{if(y.ctrlKey||y.metaKey||y.type==="contextmenu"){let v=rw(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(v),this.selectedLayer.layer=v,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",p),this.registerEventListener(c,"contextmenu",p),l.appendChild(c),l.appendChild(d),this.registerDisposer(XO(c)),l.appendChild(this.positionWidget.element);let m=()=>{let y=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=y===on.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(m)),m(),this.update(),this.updateChunkStatistics(),Vy(this),Lu(this,d,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(Ye(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,ut(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let[t,r]of this.layerWidgets){let i=t.layer,a="";if(i!==null){let o=e.get(i);if(o!==void 0){let{value:l}=o;l!==void 0&&(a=""+l)}}if(a!==r.prevValueText){if(r.prevValueText=a,a.length>r.maxLength){let o=r.maxLength=a.length;r.valueElement.style.width=`${o}ch`}r.valueElement.textContent=a}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let r=0,i=0,a=0,o=0,l=e.layer;if(l!==null)for(let{layerChunkProgressInfo:c}of l.renderLayers)r+=c.numVisibleChunksNeeded,i+=c.numVisibleChunksAvailable,a+=c.numPrefetchChunksNeeded,o+=c.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${i/Math.max(1,r)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,a)*100}%`}}updateLayers(){var i;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(let a of this.manager.layerManager.managedLayers){if(a.archived&&!((i=this.dropLayers)==null?void 0:i.layers.has(a)))continue;t.add(a);let o=this.layerWidgets.get(a),l=a.nonArchivedLayerIndex;o===void 0&&(o=new nN(a,this),this.layerWidgets.set(a,o)),o.layerNumberElement.textContent=""+(1+l),o.update();let{element:c}=o;c!==r&&e.insertBefore(o.element,r),r=c.nextElementSibling}for(let[a,o]of this.layerWidgets)t.has(a)||(this.layerWidgets.delete(a),o.dispose())}addLayerMenu(){ny(this.manager,this.selectedLayer)}};function Oy(n,e){let t=Gn(n,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(Zp)!==-1){o.stopPropagation();let l=Z(JSON.parse(o.dataTransfer.getData(Zp))),c=$(l,"dimensions",Fd),d=$(l,"position",v=>Te(v,ct));if(d.length!==c.length)throw new Error("length mismatch between position and dimensions");let p=d.length,{coordinateSpace:{value:{names:m}},value:y}=e;for(let v=0;v<p;++v){let b=m.indexOf(c[v]);b!==-1&&(y[b]=d[v])}e.changed.dispatch()}}),r=o=>{o.dataTransfer.types.indexOf(Zp)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},i=Gn(n,"dragenter",r),a=Gn(n,"dragover",r);return()=>{i(),a(),t()}}var Ny="neuroglancer-layer-group-viewer";function z0(n){return n.dataTransfer.types.indexOf(Ny)!==-1}var Oa;function hY(n){if(Oa&&Oa.viewer.layerSpecification.rootLayers===n.rootLayers)return Oa.viewer}function iN(n,e){let t=hY(e),r,i=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?r="copy":(i=!0,r="move"),F0(n,r,i)}var aN=class extends z{constructor(e){super();this.relativeDisplayScales=new DC(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new PC(e.navigationState.pose.displayDimensions.addRef()),this.position=new _p(e.navigationState.position.addRef()),this.crossSectionOrientation=new lu(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new Vp(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new cu(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new Hg(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new Hg(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new _a(new Ra(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new lu(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new cu(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new _a(new Ra(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",Al(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}};function mY(n,e){let t=new N0(n),r=t.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");let i=document.createElement("button");i.textContent="Remove layer group",r.appendChild(i),t.registerEventListener(i,"click",()=>{e.layerSpecification.layerManager.clear()});let{viewerNavigationState:a}=e;for(let[o,l]of[["Render scale factors",a.relativeDisplayScales.link],["Render dimensions",a.displayDimensions.link],["Position",a.position.link],["Cross-section orientation",a.crossSectionOrientation.link],["Cross-section zoom",a.crossSectionScale.link],["Cross-section depth range",a.crossSectionDepthRange.link],["3-D projection orientation",a.projectionOrientation.link],["3-D projection zoom",a.projectionScale.link],["3-D projection depth range",a.projectionDepthRange.link]]){let c=t.registerDisposer(new Yp(l)),d=document.createElement("label");d.style.display="flex",d.style.flexDirection="row",d.style.whiteSpace="nowrap",d.textContent=o,d.appendChild(c.element),r.appendChild(d)}return t}var Eu=class extends z{constructor(e,t,r={}){super();this.element=e;this.viewerState=t;this.state=new oi;this.options={showLayerPanel:new Mt(!0),showViewerMenu:!1,showLayerHoverValues:new Mt(!0),...r},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new aN(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof zp?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(i=>i.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new To(e)),this.layout=this.registerDisposer(new R0(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(Oy(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,rN.default)(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(ue(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),Cn(e,"crossSectionZoom",Al(this.viewerNavigationState.crossSectionScale)),Cn(e,"perspectiveZoom",Al(this.viewerNavigationState.projectionScale)),Cn(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){let r=this.layerPanel=new W0(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(r.registerDisposer(mY(r.element,this)),r.element.title="Right click for options, drag to move/copy layer group."):r.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS!="undefined"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{let a=document.createElement("button");a.textContent="Clear segments",a.title='De-select all objects ("x")',a.addEventListener("click",o=>{hx(o,o,{action:"clear-segments"})}),r.element.appendChild(a)}for(let a of["3d","xy","xz","yz"]){let o=document.createElement("button");o.textContent=a,o.title=`Switch to ${a} layout`,o.addEventListener("click",()=>{let l;this.layout.name===a?a!=="3d"?l=`${a}-3d`:l="4panel":l=a,this.layout.name=l}),r.element.appendChild(o)}}r.element.draggable=!0;let i=r.element;i.addEventListener("dragstart",a=>{Pr(r.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),B0(a,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let o=()=>{Oa&&Oa.viewer===this&&(Oa=void 0),this.unregisterDisposer(o)};Oa={viewer:this,disposer:o},this.registerDisposer(o);let l=this.toJSON();delete l.layers,a.dataTransfer.setData(Ny,JSON.stringify(l)),r.element.style.backgroundColor="black",setTimeout(()=>{r.element.style.backgroundColor=""},0)}),r.element.addEventListener("dragend",()=>{hn(i,"drag"),ku(),Oa!==void 0&&Oa.viewer===this&&Oa.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){We(this.element);let{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}};var oN=Symbol("layoutComponentContainer"),uf=class extends z{constructor(e,t,r){super();this.viewer=e;this.parent=r;this.changed=new re;this.element=document.createElement("div");let{element:i}=this;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[oN]=this,this.setSpecification(t);let a=[],o=c=>{let d=document.createElement("div");d.className="neuroglancer-layout-split-drop-zone";let p;switch(d.style[c]="0",c){case"left":case"right":p="row",d.style.width="10px",d.style.height="100%";break;case"top":case"bottom":p="column",d.style.height="10px",d.style.width="100%";break}d.style.display="none",a.push({element:d,direction:p,orientation:c}),i.appendChild(d),lN(d,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,p==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;i.addEventListener("dragenter",c=>{if(!l&&cf(c)!==void 0){l=!0;for(let{element:d,direction:p,orientation:m}of a){if(r!==void 0&&p===r.direction&&((m==="left"||m==="top")&&r.get(0)!==this||(m==="bottom"||m==="right")&&r.get(r.length-1)!==this))continue;let{component:y}=this;y instanceof Uy&&y.direction===p||(d.style.display="block")}}},!0),i.addEventListener("drop",c=>{if(!!l){l=!1;for(let{element:d}of a)d.style.display="none"}},!0),i.addEventListener("dragleave",c=>{let{relatedTarget:d}=c;if(!!l&&!(d instanceof HTMLElement&&this.element.contains(d))){l=!1;for(let{element:p}of a)p.style.display="none"}},!0)}unsetComponent(){let e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Eu){let{layerManager:t}=e,r=e.registerCancellable((0,H0.default)(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&r()})),r()}else if(e instanceof Uy){let t=e.registerCancellable((0,H0.default)(()=>{let{length:r}=e;if(r===0&&this.parent!==void 0)this.dispose();else if(r===1){let i=e.get(0).component,a;if(this.parent===void 0&&i instanceof Eu){a=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let o=i.layerManager.managedLayers,l=new Set(o),{layerSpecification:c}=i;c.rootLayers.filter(m=>l.has(m)||m.archived);let d=[],{managedLayers:p}=c.rootLayers;for(let m=0,y=p.length;m<y;++m)l.has(p[m])&&d.push(m);for(let m=0,y=o.length;m<y;++m)p[d[m]]=o[m];c.rootLayers.layersChanged.dispatch()}else a=i.toJSON();this.setSpecification(a)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(gY(this,e))}static getFromElement(e){return e[oN]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t={type:"viewer"},{parent:r}=this;if(r!==void 0){if(e==="left"&&r.direction==="row"||e==="top"&&r.direction==="column")return{newContainer:r.insertChild(t,this),existingContainer:this};if(e==="right"&&r.direction==="row"||e==="bottom"&&r.direction==="column")return{newContainer:r.insertChild(t),existingContainer:this}}let i,a=this.component;a instanceof By?i=a.layerGroupViewer.toJSON():i=a.toJSON();let o,l,c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,i]},l=0;break;case"right":case"bottom":o={type:c,children:[i,t]},l=1;break}this.setSpecification(o);let d=this.component;return{newContainer:d.get(l),existingContainer:d.get(1-l)}}};function sN(n){return{mouseState:n.mouseState,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,showScaleBar:n.showScaleBar,scaleBarOptions:n.scaleBarOptions,showPerspectiveSliceViews:n.showPerspectiveSliceViews,inputEventBindings:n.inputEventBindings,visibility:n.visibility,selectedLayer:n.selectedLayer,visibleLayerRoles:n.visibleLayerRoles,navigationState:n.navigationState.addRef(),perspectiveNavigationState:n.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor}}var By=class extends z{constructor(e,t,r){super();this.element=e;this.layerGroupViewer=this.registerDisposer(new Eu(e,{display:r.display,layerSpecification:r.layerSpecification.addRef(),...sN(r)},{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}};function lN(n,e,t,r){n.addEventListener("dragenter",i=>{cf(i)!==void 0&&n.classList.add("neuroglancer-drag-over")}),n.addEventListener("dragleave",()=>{hn(n,"drop"),n.classList.remove("neuroglancer-drag-over")}),n.addEventListener("dragover",i=>{let a=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),Pr(n,"drop",l),i.stopPropagation(),i.preventDefault()};if(z0(i)){let o=iN(i,e);sf(i,o.dropEffect),a(o,`Drop to ${o.dropEffect} layer group as new ${r}`);return}if(cf(i)!==void 0){let o=tN(i,e,!1,!0);a(o,`Drop to ${o.dropEffect} layer as new ${r}`);return}}),n.addEventListener("drop",i=>{n.classList.remove("neuroglancer-drag-over"),hn(n,"drop");let a,o;if(z0(i)){i.stopPropagation();try{o=JSON.parse(i.dataTransfer.getData(Ny))}catch(d){return}if(a=Ry(i,e,{forceCopy:!1,newTarget:!0}),a===void 0)return}else{if(a=Ry(i,e,{forceCopy:lf()==="copy",newTarget:!0}),a===void 0)return;o=a.layoutSpec}if(!a.initializeExternalLayers(i)){if(!a.moveSupported)for(let d of a.layers.keys())d.dispose();return}i.preventDefault();let l=i.dataTransfer.dropEffect=lf();ku(l);let c=t();a.updateArchiveStates(i);for(let d of a.layers.keys())c.layerSpecification.add(d);try{c.restoreState(o)}catch{c.layout.reset()}})}var Uy=class extends z{constructor(e,t,r,i){super();this.element=e;this.direction=t;this.container=i;this.changed=new re;e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(let a of r)this.insertChild(a)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",lN(t,this.viewer.layerSpecification,()=>{let r=t.nextElementSibling,i;return r!==null&&(i=uf.getFromElement(r)),this.insertChild({type:"viewer",layers:[]},i).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{ut(t)}),t}get viewer(){return this.container.viewer}get(e){return uf.getFromElement(this.element.children[e*2+1])}insertChild(e,t){let r=new uf(this.viewer,e,this),i=this.makeDropPlaceholder(r);r.element.classList.add("neuroglancer-stack-layout-child"),r.registerDisposer(r.changed.add(this.changed.dispatch)),r.registerDisposer(()=>{this.element.removeChild(r.element),this.changed.dispatch()});let a=t!==void 0?t.element:null;return this.element.insertBefore(r.element,a),this.element.insertBefore(i,a),this.changed.dispatch(),r}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}};function gY(n,e){let t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(n.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new By(t,e,n.viewer)}Z(e);let r=$(e,"type",ae);switch(r){case"row":case"column":return new Uy(t,r,$(e,"children",i=>{let a=Te(i,o=>o);if(n.parent===void 0&&a.length===0)throw new Error("Stack layout requires at least one child.");return a}),n);case"viewer":{let i=n.viewer,a=new zp(i.layerSpecification.addRef()),o=new Eu(t,{display:i.display,layerSpecification:a,...sN(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new By(t,e,n.viewer)}}var $0=class extends z{constructor(e,t){super();this.viewer=e;this.defaultSpecification=t;this.container=this.registerDisposer(new uf(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}};var cN='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeCrossedIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle><path d="M3 21L20 4"></path></svg>';var uN='<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeIconTitle"><path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"></path><circle cx="12" cy="12" r="3"></circle></svg>';var dN='<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="cursorIconTitle"><polygon points="7 20 7 4 19 16 12 16 7 21"></polygon></svg>';var yY=Fe.fromObject({escape:{action:"cancel"}}),Fy=class extends z{constructor(e){super();this.layer=e;this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";let r=this.registerDisposer(new sn(t,yY));r.allShortcutsAreGlobal=!0,ue(t,"cancel",i=>{this.updateView(),t.blur(),i.stopPropagation(),i.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){qg(this.layer,this.element.value)}},pN=class extends z{constructor(e){super();this.layer=e;this.element=document.createElement("select");this.measureElement=document.createElement("div");let{element:t,measureElement:r}=this;t.classList.add("neuroglancer-layer-side-panel-type"),r.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(r);for(let[i,a]of Hp){if(a.type!==i)continue;let o=document.createElement("option");o.textContent=a.typeAbbreviation,o.value=i,t.appendChild(o)}t.addEventListener("change",()=>{let i=t.value,a=Hp.get(i);Bp(this.layer.managedLayer,a)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:r}=this;r.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${r.offsetWidth}px`}disposed(){this.measureElement.remove()}},df=class extends zr{constructor(e,t){super(e,t.location);this.panelState=t;let r=this.layer=t.layer,{element:i}=this,{titleBar:a}=this.addTitleBar({});a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new pN(r)).element),a.appendChild(this.registerDisposer(new Fy(r.managedLayer)).element);let o=this.registerDisposer(new dr({get value(){return r.managedLayer.pickEnabled},set value(c){r.managedLayer.pickEnabled=c},changed:r.managedLayer.layerChanged},{svg:dN,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new lr({get value(){return r.managedLayer.supportsPickOption},changed:r.managedLayer.layerChanged},o.element)),a.appendChild(o.element);let l={get value(){return t!==r.panels.panels[0]},set value(c){c?t.pin():t.unpin()},changed:r.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new dr(l,{text:"\u{1F4CC}\uFE0E",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Kr(c=>{i.dataset.neuroglancerLayerPanelPinned=c.toString()},l)),a.appendChild(Di({title:"Delete layer",onClick:()=>{wo(this.layer.managedLayer)}})),this.tabView=new UC({makeTab:c=>r.tabs.options.get(c).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new yh({get value(){return t.tabs.map(c=>({id:c,label:r.tabs.options.get(c).label}))},changed:t.tabsChanged})),handleTabElement:(c,d)=>{d.draggable=!0,d.addEventListener("dragstart",p=>{p.stopPropagation(),p.dataTransfer.setData("neuroglancer-side-panel","");let m="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(v=>v!==t&&v.location.visible)&&(m+=`, or move tab to other ${JSON.stringify(r.managedLayer.name)} panel`),Pr(d,"drag",m),this.sidePanelManager.startDrag({dropAsNewPanel:v=>{this.panelState.splitOffTab(c,{...WC,...v})},canDropAsTabs:v=>v instanceof df&&v.layer===this.layer&&v!==this?1:0,dropAsTab:v=>{this.panelState.moveTabTo(c,v.panelState)}},p)}),d.addEventListener("dragend",p=>{hn(d,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof df&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var a;let{dragSource:r}=this.sidePanelManager,i=(a=r==null?void 0:r.canDropAsTabs)==null?void 0:a.call(r,this);!i||(e.classList.add(xl),Pr(e,"drop",`Move ${i} ${i===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{hn(e,"drop"),e.classList.remove(xl)}),e.addEventListener("dragover",t=>{var i;let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||t.preventDefault()}),e.addEventListener("drop",t=>{var i;hn(e,"drop");let{dragSource:r}=this.sidePanelManager;!((i=r==null?void 0:r.canDropAsTabs)==null?void 0:i.call(r,this))||(e.classList.remove(xl),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}},j0=class extends z{constructor(e,t){super();this.sidePanelManager=e;this.selectedLayerState=t;this.layerSidePanels=new Map;this.generation=0;this.layersNeedUpdate=!0;let r=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(r)),this.registerDisposer(t.layerManager.layersChanged.add(r)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)==null?void 0:e.layer)!=null?t:void 0}update(){var a;if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:r}=this,i=o=>{let l=r.get(o);l===void 0?(l={generation:t,unregister:this.sidePanelManager.registerPanel({location:o.location,makePanel:()=>new df(this.sidePanelManager,o)})},r.set(o,l)):l.generation=t};{let o=this.getSelectedUserLayer(),{location:l}=this.selectedLayerState;if(o===void 0||!l.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:l,makePanel:()=>new zr(this.sidePanelManager,l)}));else{(a=this.placeholderSelectedLayerPanel)==null||a.call(this),this.placeholderSelectedLayerPanel=void 0;let c=o.panels.panels[0];c.location.value=l.value,i(c)}}for(let o of e.managedLayers){let l=o.layer;if(l===null)continue;let{panels:c}=l.panels;for(let d=1,p=c.length;d<p;++d)i(c[d])}for(let[o,l]of r)l.generation!==t&&(l.unregister(),r.delete(o))}disposed(){var e;(e=this.placeholderSelectedLayerPanel)==null||e.call(this);for(let{unregister:t}of this.layerSidePanels.values())t()}};var vY={...wi,side:"left",row:0},q0=class{constructor(){this.location=new ur(vY)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Oi(this.location.toJSON())}},fN=class extends z{constructor(e){super();this.layer=e;this.element=document.createElement("div");let{element:t}=this,r=it({svg:uN,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=it({svg:cN,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(r);let a=()=>{let o=this.layer.visible;r.style.display=o?"":"none",i.style.display=o?"none":""};a(),this.registerDisposer(e.layerChanged.add(a))}};function SY(n){let{selectedLayer:e}=n.manager.root,t=new dr({get value(){return e.layer===n&&e.visible},set value(r){r?(e.layer=n,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:Dy});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}var hN=class extends z{constructor(e,t){super();this.panel=e;this.layer=t;this.element=document.createElement("div");this.numberElement=document.createElement("div");this.generation=-1;let{element:r,numberElement:i}=this;r.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),r.appendChild(this.registerDisposer(new Lr({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),r.appendChild(i),r.appendChild(this.registerDisposer(new fN(t)).element),r.appendChild(this.registerDisposer(new Fy(t)).element),r.appendChild(this.registerDisposer(SY(t)).element);let a=Di({title:"Delete layer",onClick:()=>{wo(this.layer)}});a.classList.add("neuroglancer-layer-list-panel-item-delete"),r.appendChild(a),_y(e,r,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),Lu(e,r,t,!0),r.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),r.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}},J0=class extends zr{constructor(e,t,r){super(e,r.location);this.manager=t;this.state=r;this.items=new Map;this.itemContainer=document.createElement("div");this.layerDropZone=document.createElement("div");this.dragEnterCount=0;this.generation=-1;let{itemContainer:i,layerDropZone:a}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),a.style.flex="1";let l=this.registerCancellable(Ye(()=>this.render()));this.visibility.changed.add(l),this.registerDisposer(this.layerManager.layersChanged.add(l)),this.registerDisposer(this.selectedLayer.changed.add(l)),Vy(this),Lu(this,a,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){let e=this,t=this.selectedLayer.layer,r=++this.generation,i=0,a=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){let{items:d}=e,p=0;for(let y of e.layerManager.managedLayers)y.archived||++p;let m=`${(p+1).toString().length}ch`;for(let y of e.layerManager.managedLayers){y.visible?++i:y.archived?++o:++a;let v=d.get(y);v===void 0&&(v=e.registerDisposer(new hN(e,y)),d.set(y,v)),v.generation=r;let{nonArchivedLayerIndex:b}=y;v.numberElement.style.width=m,b===-1?v.numberElement.style.visibility="hidden":(v.numberElement.style.visibility="",v.numberElement.textContent=`${b+1}`),v.element.dataset.selected=(y===t).toString(),v.element.dataset.archived=y.archived.toString(),yield v.element}for(let[y,v]of d)r!==v.generation&&(d.delete(y),e.unregisterDisposer(v),v.dispose());yield e.layerDropZone}Yn(this.itemContainer,l());let c="Layers";if(i||a||o){c+=" (";let d="";i+a&&(c+=`${i}/${a+i} visible`,d=", "),o&&(c+=`${d}${o} archived`),c+=")"}this.titleElement.textContent=c}},Y0=class extends z{constructor(e){super();this.layerManager=e;this.element=document.createElement("div");let t=this.registerCancellable(Ye(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:r}=this;if(e!==0){let i=t.length;r.textContent=`${i-e}/${i}`}else r.textContent=""}};var gOe=rt(yN()),yOe=rt(K0()),vOe=rt(CN()),SOe=rt(kN());var X0=rt(Ds()),LN=rt(Ct());var bY=100,Q0=class extends ta{constructor(e){super();this.viewer=e;this.parsedValue=null;this.debouncedValueUpdater=(0,LN.default)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(t){this.parsedValue=null,this.applyButton.disabled=!0;let r=0,i=0,a="Unknown parse error";if(t instanceof Error){let o=t.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(o!==null){a=o[1];let l=parseInt(o[2],10),d=e.substring(0,l).split(`
`);r=d.length-1,i=d[d.length-1].length}else a=t.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:a,severity:"error",from:X0.default.Pos(r,i)}]})}},bY);this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0,this.textEditor=(0,X0.default)(r=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(Hr(this.viewer.state).value,null,"  ")}};var EN=rt(Ct());var xY={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1},Z0=class{constructor(){this.location=new ur(xY)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Oi(this.location.toJSON())}};function CY(n){let e=new Map;function t(r,i){if(typeof r!="object"){e.set(i,""+r);return}for(let a of Object.keys(r))t(r[a],i+"."+a)}return t(n,""),e}function wY(n){let e=new Set;e.add(".type");let t=new Set;function r(i,a){for(let o of e)if(n[i].get(o)!==n[a].get(o))return!0;return!1}for(let i=0,a=n.length;i<a;++i){for(let l of n[i].keys())t.add(l);let o=[];for(let l=0;l<i;++l)r(i,l)||o.push(l);for(;o.length>0;){let l=o,c;for(let d of t){if(e.has(d))continue;let p=[];for(let m of o)n[m].get(d)===n[i].get(d)&&p.push(m);if(p.length<l.length&&(l=p,c=d),p.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Array.from(e)}function TY(n,e){let t={};for(let r of e){let i=n.get(r);if(i!==void 0){if(r==="")return i;t[r]=i}}return JSON.stringify(t)}function Gy(n){return Object.assign({type:n.RPC_TYPE_ID},n.key||{})}function eT(n){let e=n.map(CY),t=wY(e);return e.map(r=>TY(r,t))}var kY=1e3,Du=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:n=>{let e=0;for(let t=0;t<fm;++t)e+=n[os(t,wa.VISIBLE)*ka+Ta.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:n=>n[os(dt.DOWNLOADING,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:n=>n[os(dt.SYSTEM_MEMORY,wa.VISIBLE)*ka+Ta.numChunks]+n[os(dt.SYSTEM_MEMORY_WORKER,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:n=>n[os(dt.GPU_MEMORY,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:n=>n[os(dt.FAILED,wa.VISIBLE)*ka+Ta.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:n=>n[os(dt.GPU_MEMORY,wa.VISIBLE)*ka+Ta.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:n=>n[Jb(Xd.totalTime)]/n[Jb(Xd.totalChunks)]}],tT=class extends zr{constructor(e,t,r){super(e,r.location);this.chunkQueueManager=t;this.displayState=r;this.data=void 0;this.requestDataTimerId=-1;this.dataRequested=!1;this.body=document.createElement("div");this.debouncedUpdateView=this.registerCancellable((0,EN.default)(()=>this.updateView(),0));let{body:i}=this;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},kY)})}updateView(){let{data:e}=this;if(e===void 0)return;let t=document.createElement("table"),r=[];for(let[l,c]of e){let d=[l];for(let{getter:p}of Du)d.push(p(c));r.push(d)}let i=eT(r.map(l=>Gy(l[0]))),a=new Map;i.forEach((l,c)=>{a.set(r[c][0],l)});{let l=document.createElement("thead"),c=document.createElement("tr");l.appendChild(c);let d=m=>{let y=document.createElement("td");y.textContent=m,c.appendChild(y)};d("Name");let p;for(let{label:m}of Du){let y=m.indexOf("/"),v=m;if(y!==-1){if(v=m.substring(0,y),v===p){++c.lastElementChild.colSpan;continue}p=v}d(v)}c=document.createElement("tr"),l.appendChild(c);{let m=document.createElement("td");c.appendChild(m)}for(let{label:m}of Du){let y=m.indexOf("/"),v="";y!==-1&&(v=m.substring(y+1));let b=document.createElement("td");b.textContent=v,c.appendChild(b)}t.appendChild(l)}let o=document.createElement("tbody");for(let[l,...c]of r){let d=document.createElement("tr"),p=m=>{let y=document.createElement("td");y.textContent=m,d.appendChild(y)};p(a.get(l));for(let m of c)p(""+m);o.appendChild(d)}t.appendChild(o),We(this.body),this.body.appendChild(t)}};var nT=class extends z{constructor(e,t={}){super();this.model=e;this.element=document.createElement("label");this.inputElement=document.createElement("input");let{validator:r,label:i}=t,{element:a,inputElement:o}=this;r===void 0&&(e instanceof lt?r=e.validator:r=l=>l),this.validator=r,i!==void 0&&(a.textContent=i),a.appendChild(o),a.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){ut(this.element),super.disposed()}};var LY={...wi,side:"left",row:2},rT=class{constructor(){this.location=new ur(LY)}get changed(){return this.location.changed}toJSON(){return Oi(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}},iT=class extends zr{constructor(e,t,r){super(e,t.location);this.addTitleBar({title:"Settings"});let i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let a=document.createElement("div");a.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(a),this.addBody(i);{let c=this.registerDisposer(new ef(r.title));c.element.placeholder="Title",c.element.classList.add("neuroglancer-settings-title"),a.appendChild(c.element)}let o=(c,d)=>{let p=this.registerDisposer(new nT(d,{label:c}));p.element.classList.add("neuroglancer-settings-limit-widget"),a.appendChild(p.element)};o("GPU memory limit",r.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",r.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",r.chunkQueueManager.capacities.download.itemLimit);let l=(c,d)=>{let p=document.createElement("label");p.textContent=c;let m=this.registerDisposer(new Lr(d));p.appendChild(m.element),a.appendChild(p)};l("Show axis lines",r.showAxisLines),l("Show scale bar",r.showScaleBar),l("Show cross sections in 3-d",r.showPerspectiveSliceViews),l("Show default annotations",r.showDefaultAnnotations),l("Show chunk statistics",r.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",r.wireFrame),l("Enable prefetching",r.chunkQueueManager.enablePrefetch)}};var aT=class extends z{constructor(e,t){super();this.selectedLayer=e;this.toolBinder=t;this.element=document.createElement("div");this.viewContext=void 0;this.updateView=this.registerCancellable(Ye(()=>{let{viewContext:e}=this;e!==void 0&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new z),We(this.element);let{selectedTool:t}=this;t!==void 0&&this.element.appendChild(this.makeWidget(e,t));let r=Array.from(this.toolBinder.bindings);r.sort(([i],[a])=>ho(i,a));for(let[,i]of r)this.element.appendChild(this.makeWidget(e,i))}));let{element:r}=this;r.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){let e=this.selectedLayer.layer;if(e===void 0)return;let t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;e!==void 0&&e();let t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let r=document.createElement("div");r.title="dblclick \u2192 unbind",t instanceof Co&&(r.title+=", click \u2192 bind key"),r.className="neuroglancer-annotation-tool-status-widget";let i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";let{managedLayer:a}=t.layer;a.manager.rootLayers.updateNonArchivedLayerIndices();let o=a.nonArchivedLayerIndex;i.textContent=(o+1).toString();let l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,r.addEventListener("dblclick",()=>{t instanceof Up?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Co){let c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,r.appendChild(c),JC(e,r,d=>t.layer.toolBinder.set(d,t.addRef()))}return r.appendChild(i),r.appendChild(l),r}};var PN=class extends z{constructor(e,t,r=""){super();this.gl=e;this.frameNumberCounter=t;let i=r+"chunk_worker.bundle.js";this.worker=new Worker(i),this.chunkQueueManager=this.registerDisposer(new Qd(new Cb(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new zc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new zc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new zc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new zc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Zd(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}};var IN=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],AN=[...IN,"showLayerPanel","showLayerHoverValues"],Wy=[...AN,"showUIControls","showPanelBorders"];function EY(){return Object.fromEntries(Wy.map(n=>[n,new Mt(!0)]))}function DY(n,e){for(let t of Wy){let r=e[t];r!==void 0&&(n[t].value=r)}}var PY=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS!="undefined"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0},MN=class extends oi{constructor(e){super();this.viewer=e;this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){let{viewer:t}=this;super.restoreState(e),pe(e,"navigation",r=>{Z(r),pe(r,"pose",i=>{Z(i),pe(i,"position",a=>{Z(a),Cn(a,"voxelCoordinates",t.position),pe(a,"voxelSize",o=>{let l=Je(new Float64Array(3),o,Lt);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=He({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),Cn(i,"orientation",t.crossSectionOrientation)}),Cn(r,"zoomFactor",t.crossSectionScale.legacyJsonView)}),Cn(e,"perspectiveOrientation",t.projectionOrientation),Cn(e,"perspectiveZoom",t.projectionScale.legacyJsonView),Cn(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}},pf=class extends z{constructor(e,t={}){super();this.display=e;this.title=new lt(void 0,ae);this.coordinateSpace=new rl;this.position=this.registerDisposer(new Qi(this.coordinateSpace));this.relativeDisplayScales=this.registerDisposer(new Wg(this.coordinateSpace));this.displayDimensions=this.registerDisposer(new zg(this.coordinateSpace));this.displayDimensionRenderInfo=this.registerDisposer(new Vp(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef()));this.crossSectionOrientation=this.registerDisposer(new xo);this.crossSectionScale=this.registerDisposer(new AC(this.displayDimensionRenderInfo.addRef()));this.projectionOrientation=this.registerDisposer(new xo);this.crossSectionDepthRange=this.registerDisposer(new Op(-10,this.displayDimensionRenderInfo));this.projectionDepthRange=this.registerDisposer(new Op(-50,this.displayDimensionRenderInfo));this.projectionScale=this.registerDisposer(new MC(this.displayDimensionRenderInfo.addRef()));this.navigationState=this.registerDisposer(new _a(new Ra(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef()));this.perspectiveNavigationState=this.registerDisposer(new _a(new Ra(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef()));this.mouseState=new XC;this.layerManager=this.registerDisposer(new Xg);this.selectedLayer=this.registerDisposer(new tw(this.layerManager.addRef()));this.showAxisLines=new Mt(!0,!0);this.wireFrame=new Mt(!1,!1);this.showScaleBar=new Mt(!0,!0);this.showPerspectiveSliceViews=new Mt(!0,!0);this.visibleLayerRoles=sI();this.showDefaultAnnotations=new Mt(!0,!0);this.crossSectionBackgroundColor=new Jo(K.fromValues(.5,.5,.5));this.perspectiveViewBackgroundColor=new Jo(K.fromValues(0,0,0));this.scaleBarOptions=new L0;this.partialViewport=new ZS;this.statisticsDisplayState=new Z0;this.helpPanelState=new V0;this.settingsPanelState=new rT;this.layerSelectedValues=this.registerDisposer(new QC(this.layerManager,this.mouseState));this.selectionDetailsState=this.registerDisposer(new ew(this.coordinateSpace,this.layerSelectedValues));this.selectedStateServer=new lt("",ae);this.layerListPanelState=new q0;this.toolBinder=this.registerDisposer(new jC);this.resetInitiated=new re;this.uiControlVisibility={};this.visible=!0;this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))};let{dataContext:r=new PN(e.gl,e,t.bundleRoot),visibility:i=new Vt(Vt.VISIBLE),inputEventBindings:a={global:new Fe,sliceView:new Fe,perspectiveView:new Fe},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:l=Zm({credentialsManager:Py}),uiConfiguration:c=EY()}=t;this.visibility=i,this.inputEventBindings=a,this.element=o,this.dataSourceProvider=l,this.uiConfiguration=c,this.registerDisposer(Kr(v=>{this.display.applyWindowedViewportToElement(o,v)},this.partialViewport)),this.registerDisposer(()=>ut(this.element)),this.dataContext=this.registerDisposer(r),DY(c,t);let d={...PY,...t},{resetStateWhenEmpty:p,showLayerDialog:m}=d;for(let v of AN)this.uiControlVisibility[v]=this.makeUiControlVisibilityState(v);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=m,this.resetStateWhenEmpty=p,this.layerSpecification=new aw(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(cr.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(cr.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let y=this.registerCancellable((0,DN.default)(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!ry&&this.showLayerDialog&&this.visibility.visible&&ny(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(y),y(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(Oy(o,this.navigationState.position)),this.state=new MN(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,r=this.uiConfiguration[e];return this.registerDisposer(mS((i,a)=>i&&a,t,r))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let r=this.registerDisposer(new Ps(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new lr(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element);let i=this.registerDisposer(new $w(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new lr(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK!="undefined"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(let{url:c,text:d}of l){let p=document.createElement("a");p.style.marginRight="5px",p.href=c,p.textContent=d,p.style.fontFamily="sans-serif",p.style.color="yellow",p.target="_blank",t.appendChild(p)}}let a=this.registerDisposer(new aT(this.selectedLayer,this.toolBinder));if(t.appendChild(a.element),this.registerDisposer(new lr(this.uiControlVisibility.showAnnotationToolStatus,a.element)),qO){let l=this.registerDisposer(new _0(this));t.appendChild(l.element)}{let{layerListPanelState:l}=this,c=this.registerDisposer(new dr(l.location.watchableVisible,{svg:SO,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new Y0(this.layerManager)).element),this.registerDisposer(new lr(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{let{selectionDetailsState:l}=this,c=this.registerDisposer(new dr(l.location.watchableVisible,{svg:bO,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new lr(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{let{selectedLayer:l}=this,c=this.registerDisposer(new dr({get value(){return l.visible},set value(d){l.visible=d},changed:l.location.locationChanged},{svg:Dy,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new lr(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{let l=it({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new lr(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{let{helpPanelState:l}=this,c=this.registerDisposer(new dr(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new lr(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{let{settingsPanelState:l}=this,c=this.registerDisposer(new dr(l.location.watchableVisible,{svg:xO,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new lr(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new lr(mS((...l)=>l.reduce((c,d)=>c||d,!1),...IN.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new $0(this,"4panel")),this.sidePanelManager=this.registerDisposer(new Cx(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new J0(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new j0(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new Tx(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new tT(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:l}=this;return new O0(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new iT(this.sidePanelManager,this.settingsPanelState,this)}));let o=()=>{let l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new sn(e,this.inputEventMap)),this.registerDisposer(new To(e))}bindAction(e,t){this.registerDisposer(ue(this.element,e,t))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});for(let e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(e===void 0){Ke.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(t===null||t.tool.value===void 0){Ke.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e,this.toolInputEventMapBinder)}editJsonState(){new Q0(this)}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}};var oT=class extends z{constructor(e,t,r,i){super();this.display=e;this.dataSourceProvider=t;this.dataContext=r;this.uiConfiguration=i;this.prefetchStates=new Map;this.changed=new re;this.specification=[];this.updatePrefetchStates=this.registerCancellable((0,RN.default)(()=>{let{specification:e,prefetchStates:t}=this,r=new Set;for(let{state:i,priority:a}of e){let o=JSON.stringify(i);r.add(o);let l=t.get(o);l===void 0?(l=this.makePrefetchState(i,a),t.set(o,l)):l.visibility.value=a}for(let[i,a]of t)r.has(i)||(t.delete(i),a.dispose())},0));this.registerDisposer(r)}makePrefetchState(e,t){let r=new pf(this.display,{showLayerDialog:!1,resetStateWhenEmpty:!1,dataSourceProvider:this.dataSourceProvider,dataContext:this.dataContext.addRef(),visibility:new Vt(t),uiConfiguration:this.uiConfiguration});try{r.state.restoreState(e)}catch(i){console.log(`Error setting prefetch state: ${i.message}`)}return r}reset(){this.specification=[],this.changed.dispatch(),this.updatePrefetchStates()}restoreState(e){this.specification=Te(e,t=>{Z(t);let r=$(t,"state",Z),i=$(t,"priority",a=>a===void 0?0:ft(a));return{state:r,priority:i}}),this.changed.dispatch(),this.updatePrefetchStates()}toJSON(){let{specification:e}=this;return e.length===0?void 0:this.specification}};var _N=rt(Ct());var sT=class extends z{constructor(e){super();this.viewer=e;this.actionSet=new lt(new Set,e=>new Set(vn(e)));this.actionDisposers=[];this.sendActionRequested=new qe;this.actionSet.changed.add((0,_N.default)(()=>this.updateActions(),0))}clearListeners(){for(let e of this.actionDisposers)e();this.actionDisposers.length=0}disposed(){this.clearListeners(),super.disposed()}updateActions(){this.clearListeners();for(let e of this.actionSet.value)this.actionDisposers.push(ue(this.viewer.element,e,()=>this.handleAction(e)))}handleAction(e){let{mouseState:t,layerSelectedValues:r}=this.viewer,i={};t.updateUnconditionally()&&(i.mousePosition=Array.prototype.slice.call(t.position)),i.selectedValues=r.toJSON(),i.viewerState=Hr(this.viewer.state).value,this.sendActionRequested.dispatch(e,JSON.parse(JSON.stringify(i)))}};var VN=rt(Ct());var lT=class extends z{constructor(){super();this.existingMessages=new Map;this.changed=new re;this.messages=new Map;this.changed.add(this.registerCancellable((0,VN.default)(()=>this.updateMessages(),0)))}reset(){this.messages.clear(),this.changed.dispatch()}restoreState(e){Z(e),this.messages.clear();for(let t of Object.keys(e)){let r=e[t],i=ae(r);this.messages.set(t,i)}this.changed.dispatch()}disposed(){for(let e of this.existingMessages.values())e.dispose();this.existingMessages.clear()}updateMessages(){let{existingMessages:e}=this,t=this.messages;for(let[r,i]of e){let a=t.get(r);a===void 0?(i.dispose(),e.delete(r)):i.setText(a)}for(let[r,i]of t){if(e.has(r))continue;let a=new Ke;a.setText(i),e.set(r,a)}}toJSON(){let e={};for(let[t,r]of this.messages)e[t]=r;return e}};var NN=rt(Ct()),BN=rt(Pl());function ON(n){return new Promise(e=>{let t=new Blob([n],{type:"application/octet-stream"}),r=new FileReader;r.onload=function(i){let a=i.target.result;e(a.substr(a.indexOf(",")+1))},r.readAsDataURL(t)})}var cT=class extends z{constructor(e){super();this.viewer=e;this.sendScreenshotRequested=new qe;this.sendStatisticsRequested=new qe;this.requestState=new lt(void 0,rn);this.wasAlreadyVisible=!1;this.previousRequest=void 0;this.debouncedMaybeSendScreenshot=this.registerCancellable((0,NN.default)(()=>this.maybeSendScreenshot(),0));this.statisticsRequested=!1;this.throttledSendStatistics=this.registerCancellable((0,BN.default)(async e=>{if(this.requestState.value!==e||this.previousRequest===e||(this.throttledSendStatistics(e),this.statisticsRequested))return;this.statisticsRequested=!0;let t=await this.viewer.chunkQueueManager.getStatistics();if(this.statisticsRequested=!1,this.wasDisposed||this.requestState.value!==e||this.previousRequest===e)return;let r=eT(Array.from(t,d=>Gy(d[0]))),i=0,a=[],o=new Float64Array(qb);for(let[d,p]of t){for(let y=0;y<qb;++y)o[y]+=p[y];let m={};m.id=Gy(d),m.distinctId=r[i];for(let y of Du)m[y.key]=y.getter(p);++i,a.push(m)}let l={};for(let d of Du)l[d.key]=d.getter(o);let c={viewerState:JSON.parse(JSON.stringify(Hr(this.viewer.state).value)),selectedValues:JSON.parse(JSON.stringify(this.viewer.layerSelectedValues)),screenshotStatistics:{id:e,chunkSources:a,total:l}};this.sendStatisticsRequested.dispatch(c)},1e3,{leading:!1,trailing:!0}));this.requestState.changed.add(this.debouncedMaybeSendScreenshot),this.registerDisposer(e.display.updateFinished.add(this.debouncedMaybeSendScreenshot))}isReady(){let{viewer:e}=this;if(e.chunkQueueManager.flushPendingChunkUpdates(),!e.display.isReady())return!1;for(let t of e.layerManager.managedLayers)if(!t.isReady())return!1;return!0}async maybeSendScreenshot(){let e=this.requestState.value,{previousRequest:t}=this,{layerSelectedValues:r}=this.viewer;if(e===void 0||e===t){this.wasAlreadyVisible=!1,this.throttledSendStatistics.cancel();return}let{viewer:i}=this;if(!this.isReady()){this.wasAlreadyVisible=!1,this.throttledSendStatistics(e);return}if(!this.wasAlreadyVisible){this.throttledSendStatistics(e),this.wasAlreadyVisible=!0,this.debouncedMaybeSendScreenshot();return}this.wasAlreadyVisible=!1,this.previousRequest=e,this.throttledSendStatistics.cancel(),i.display.draw();let a=i.display.canvas.toDataURL(),{width:o,height:l}=i.display.canvas,c="data:image/png;base64,",d,p,m;if(!a.startsWith(c))d="",p="";else if(d="image/png",p=a.substring(c.length),e.endsWith("_includeDepth")){let v=i.display.getDepthArray();U1(v,An.LITTLE),m=await ON(v)}let y={viewerState:JSON.parse(JSON.stringify(Hr(this.viewer.state).value)),selectedValues:JSON.parse(JSON.stringify(r)),screenshot:{id:e,image:p,imageType:d,depthData:m,width:o,height:l}};this.sendScreenshotRequested.dispatch(y)}};var UN=rt(Ct()),FN=rt(Pl());var uT=class extends z{constructor(e,t=100,r=!0){super();this.state=e;this.receiveUpdates=r;this.serverGeneration="";this.clientGeneration=-1;this.connected_=!1;this.receiveUpdateRequested=new qe;this.sendUpdateRequested=new qe;t!==null?(this.sendUpdates=!0,this.registerDisposer(e.changed.add(this.registerCancellable((0,FN.default)(this.registerCancellable((0,UN.default)(()=>this.handleStateChanged(),0)),t,{leading:!1}))))):this.sendUpdates=!1}set connected(e){e!==this.connected_&&(this.connected_=e,e===!0&&(this.receiveUpdates&&this.receiveUpdateRequested.dispatch(this.serverGeneration),this.handleStateChanged()))}get connected(){return this.connected_}setState(e,t){!this.receiveUpdates||t!==this.serverGeneration&&(this.lastServerState=JSON.stringify(e),this.state.reset(),this.state.restoreState(e),this.serverGeneration=t,this.clientGeneration=this.state.changed.count)}handleStateChanged(){if(!this.sendUpdates||!this.connected_||this.receiveUpdates&&this.serverGeneration===""||this.clientGeneration===this.state.changed.count)return;let e=Hr(this.state).value,t=JSON.stringify(e);if(t===this.lastServerState){this.clientGeneration=this.state.changed.count;return}let r=Vh(160);this.serverGeneration=r,this.lastServerState=t,this.sendUpdateRequested.dispatch(e,r)}};var LF=rt(kF());function GK(){let n=window.location.pathname.match(/^(.*)\/v\/([^\/]+)/);if(n===null)throw new Error("Failed to determine token from URL.");let e=`${window.location.origin}${n[1]}`,t=n[2];return{socketUrl:`${e}/socket/${t}`,actionUrl:`${e}/action/${t}`}}var EF=1e3,WK=100,ek=class extends z{constructor(e,t,r){super();this.sharedState=e;this.privateState=t;this.configState=r;this.reconnectionDelay=EF;this.waitingToReconnect=-1;this.isOpen=!1;this.updateClients=new Map;this.status=this.registerDisposer(new Ke(!0));Object.assign(this,GK());let i=[{key:"p",state:t,receiveUpdates:!1,sendUpdates:0},{key:"c",state:r,receiveUpdates:!0,sendUpdates:null}];e!==void 0&&i.push({key:"s",state:e,receiveUpdates:!0,sendUpdates:WK});for(let{key:a,state:o,receiveUpdates:l,sendUpdates:c}of i){let d=this.registerDisposer(new uT(o,c,l));this.updateClients.set(a,d),c!==null&&d.sendUpdateRequested.add((p,m)=>this.send("setState",{k:a,s:p,g:m})),l&&d.receiveUpdateRequested.add(p=>this.send("getState",{g:p,k:a}))}this.connect()}dispose(){this.socket!==void 0&&(this.socket.close(),this.socket=void 0),this.waitingToReconnect!==-1&&(clearInterval(this.waitingToReconnect),this.waitingToReconnect=-1)}send(e,t){t.t=e,this.socket.send(JSON.stringify(t))}connect(){this.status.setText("Connecting to Python server"),this.status.setVisible(!0);let e=this.socket=new LF.default(this.socketUrl,{transports:["websocket","xhr-streaming"]});e.onopen=()=>{this.isOpen=!0,this.reconnectionDelay=EF,this.status.setVisible(!1);for(let t of this.updateClients.values())t.connected=!0},e.onclose=()=>{this.isOpen=!1;let{reconnectionDelay:t}=this;for(let a of this.updateClients.values())a.connected=!1;let r=Date.now()+t;this.status.setVisible(!0);let i=a=>{this.status.setText(`Disconnected from Python server.  Retrying in ${Math.ceil(a/1e3)} seconds.`)};this.waitingToReconnect=window.setInterval(()=>{let a=r-Date.now();a<0?(window.clearInterval(this.waitingToReconnect),this.waitingToReconnect=-1,this.connect()):i(a)},1e3),i(t),this.reconnectionDelay=Math.min(30*1e3,t*2)},e.onmessage=t=>{let r=JSON.parse(t.data);if(typeof r!="object"||Array.isArray(r))throw new Error("Invalid message received over server connection.");switch(r.t){case"setState":{let i=this.updateClients.get(r.k);if(i===void 0)throw new Error(`Invalid state key: ${JSON.stringify(r.k)}`);i.setState(r.s,r.g);break}}}}sendActionNotification(e,t){fetch(this.actionUrl,{method:"POST",body:JSON.stringify({action:e,state:t})})}};function DF(n){n.registerEventListener(document,"copy",e=>{if(fp(e.target))return;let t=document.getSelection();if(t!==null&&t.type==="Range")return;let r=Hr(n.state).value,{clipboardData:i}=e;i!==null&&i.setData("text/plain",JSON.stringify(r,void 0,"  ")),e.preventDefault()})}function zK(n,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let a=0;a<e;++a)a!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;let r=n.match(t);if(r===null)return;let i=new Float32Array(e);for(let a=0;a<e;++a){let o=Number(r[a+1]);if(!Number.isFinite(o))return;i[a]=o}return i}function PF(n){n.registerEventListener(document,"paste",e=>{if(fp(e.target))return;let{clipboardData:t}=e;if(t!==null){let r=t.getData("text/plain"),i=zK(r,n.coordinateSpace.value.rank);i!==void 0&&(n.navigationState.position.value=i)}e.preventDefault()})}function IF(){return Gn(document,"contextmenu",n=>{n.preventDefault()})}function AF(){return Gn(document,"wheel",n=>{n.ctrlKey&&n.preventDefault()},{passive:!1})}var MF=Symbol("SingleTextureVolumeChunk.textureUnit"),dv=Symbol("SingleTextureVolumeChunk.textureLayout"),Af=class extends z{constructor(e,t){super();this.shaderKey=e;this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",MF)}beginDrawing(e,t){let r=t.textureUnit(MF);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),t[dv]=null}endDrawing(e,t){e.bindTexture(lm[this.shaderSamplerType],null),t[dv]=null}bindChunk(e,t,r,i,a,o,l){let c=r.textureLayout;(t[dv]!==c||l)&&(t[dv]=c,this.setupTextureLayout(e,t,c,i,a,o)),e.bindTexture(lm[this.shaderSamplerType],r.texture)}beginSource(e,t){}},Mf=class extends Ux{constructor(e,t){super(e,t);this.texture=null;this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture(),r=lm[this.chunkFormat.shaderSamplerType];e.bindTexture(r,t),this.setTextureData(e),e.bindTexture(r,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}};var pv=class extends z{constructor(e,t,r){super();this.chunkDataSize=t;this.textureDims=r;this.textureShape=new Uint32Array(this.textureDims);let i=t.length,a=0;for(let m of t)m!==1&&++a;let o=this.strides=new Uint32Array(i*r),l=r===3?e.max3dTextureSize:e.maxTextureSize,c=0,d=1,{textureShape:p}=this;p.fill(1);for(let m=0;m<i;++m){let y=t[m];if(y===1)continue;let v=y*d,b;v>l||d!==1&&c+a<r?(++c,d=y,b=1):(b=d,d=v),o[r*m+c]=b,p[c]=d}}static get(e,t,r){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${r}`,()=>new pv(e,t,r))}},tk=new Uint32Array(3*5),fv=class extends Af{constructor(e,t,r,i){super(r,t);this.textureDims=i;Ci(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new sx("chunkData",i)}static get(e,t,r){let i=`sliceview.UncompressedChunkFormat:${t}:${r}`;return e.memoize.get(i,()=>new fv(e,t,i,r))}defineShader(e,t){super.defineShader(e,t);let{textureDims:r}=this,i=`ivec${this.textureDims}`,{textureAccessHelper:a}=this,o=(4+t)*r;tk.length<o&&(tk=new Uint32Array(o)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(a.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let c=`
${Xt(this.dataType)} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ${i} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  offset += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let l=tk,c=o.length,{strides:d}=r,p=i.length,{textureDims:m}=this;for(let v=0;v<m;++v){let b=0;for(let x=0;x<p;++x)b+=i[x]*d[x*m+v];l[v]=b}for(let v=0;v<3;++v){let b=a[v];if(!(b>=p))for(let x=0;x<m;++x)l[(v+1)*m+x]=d[b*m+x]}for(let v=0;v<c;++v){let b=o[v];if(b===-1)l.fill(0,(4+v)*m,(4+v+1)*m);else for(let x=0;x<m;++x)l[(4+v)*m+x]=d[b*m+x]}let y=(4+c)*m;m===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,y):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,y)}getTextureLayout(e,t){return pv.get(e,t,this.textureDims)}setTextureData(e,t,r){let{textureShape:i}=t;(this.textureDims===3?RI:MI)(e,this,r,i[0],i[1],i[2])}},RF=class extends Mf{setTextureData(e){let{source:t}=this,{chunkFormatHandler:r}=t,{chunkFormat:i}=r,a;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=a=r.textureLayout.addRef():this.textureLayout=a=i.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,a,this.data)}getValueAt(e){let{chunkFormat:t}=this,{chunkDataSize:r}=this,i=0,a=1,o=e.length;for(let d=0;d<o;++d)i+=a*e[d],a*=r[d];let l=t.dataType,c=this.data;switch(l){case G.UINT8:case G.INT8:case G.FLOAT32:case G.UINT16:case G.INT16:case G.UINT32:case G.INT32:return c[i];case G.UINT64:{let d=i*2;return new Q(c[d],c[d+1])}}}},_F=class extends z{constructor(e,t){super();let r=0;for(let i of t.chunkDataSize)i>1&&++r;this.chunkFormat=this.registerDisposer(fv.get(e,t.dataType,r>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new RF(e,t)}};Xm((n,e)=>e.compressedSegmentationBlockSize==null?new _F(n,e):null);function hv(n,e,t,r,i,a){let o=0,l=0,c=1,d=1;for(let x=0;x<3;++x){let C=i[x],k=r[x],M=Math.floor(C/k),I=C%k;o+=M*c,c*=Math.ceil(t[x]/k),l+=I*d,d*=k}let p=e+o*2,m=n[p],y=n[p+1],v=m&16777215,b=m>>24&255;if(b>0){let C=(e+y&16777215)+Math.floor(l*b/32),k=n[C],M=l*b%32,I=k>>M&(1<<b)-1;v+=a*I}return v}function VF(n,e,t,r,i){let a=hv(n,e,t,r,i,1)+e;return n[a]}function OF(n,e,t,r,i,a){let o=hv(e,t,r,i,a,2)+t;return n.low=e[o],n.high=e[o+1],n}var mv=class extends z{constructor(e,t){super();this.chunkDataSize=e;this.subchunkSize=t;let r=this.subchunkGridSize=K.create();for(let i=0;i<3;++i)r[i]=Math.ceil(e[i]/t[i])}static get(e,t,r){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${qo(t)},${qo(r)}`,()=>new mv(t,r))}},HK=Ci(new qi,G.UINT32),nk=new Uint32Array(4*4),gv=class extends Af{constructor(e,t,r,i){super(i,e);this.subchunkSize=t;this.numChannels=r;this.textureAccessHelper=new go("chunkData")}static get(e,t,r,i){let a=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,o=`${a}:${qo(r)}`;return e.memoize.get(o,()=>new gv(t,r,i,a))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);let r=4*(4+t);nk.length<r&&(nk=new Uint32Array(r));let{textureAccessHelper:i}=this;i.defineShader(e);let a=d=>"compressedSegmentationChunkFormat_"+d;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(wP);let{dataType:o}=this,l=Xt(o);o===G.UINT64?e.addFragmentCode(tn):e.addFragmentCode(ol),e.addFragmentCode(i.getAccessor(a("readTextureValue"),"uVolumeChunkSampler",G.UINT32,1));let c=`
uint ${a("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${a("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)c+=`, highp int channelIndex${d}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)c+=`
  chunkPositionFull += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${a("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${a("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${a("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${a("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===G.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===G.UINT64?c+=`
  result.value[0] = ${a("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${a("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${a("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,a,o){let{subchunkGridSize:l}=r;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);let c=nk,d=o.length;c.fill(0);for(let p=0;p<3;++p){c[p]=i[p];let m=a[p];m!==-1&&(c[4*(p+1)+m]=1)}for(let p=0;p<d;++p){let m=o[p];m!==-1&&(c[4*(4+p)+m]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(d+4)*4)}setTextureData(e,t,r){ds(e,HK,r)}getTextureLayout(e,t){return mv.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:r}=this;e.uniform3i(t.uniform("uSubchunkSize"),r[0],r[1],r[2])}},NF=class extends Mf{setTextureData(e){let{data:t}=this,{chunkFormat:r}=this,i=this.textureLayout=r.getTextureLayout(e,this.chunkDataSize);r.setTextureData(e,i,t)}getValueAt(e){let{chunkDataSize:t,chunkFormat:r}=this,{data:i}=this,a=i[e[3]||0];if(r.dataType===G.UINT64){let o=new Q;return OF(o,i,a,t,r.subchunkSize,e),o}else return VF(i,a,t,r.subchunkSize,e)}},BF=class extends z{constructor(e,t){super();let{dataType:r}=t;if(r!==G.UINT64&&r!==G.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${G[r]}`);this.chunkFormat=this.registerDisposer(gv.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new NF(e,t)}};Xm((n,e)=>e.compressedSegmentationBlockSize!=null?new BF(n,e):null);function UF(n,e=document.getElementById("neuroglancer-container")){try{let t=new eb(e);return new pf(t,n)}catch(t){throw Ke.showMessage(`Error: ${t.message}`),t}}function FF(n){return IF(),AF(),UF(n)}function GF(n){let e=Ye(()=>{var i;let r=(i=n.value)==null?void 0:i.trim();r?document.title=`${r} - neuroglancer`:document.title="neuroglancer"}),t=n.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}var WF=rt(Ct());function $K(n){return encodeURI(n).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}var rk=class extends z{constructor(e,t,r={}){super();this.root=e;this.credentialsManager=t;this.parseError=new Ge(void 0);let{updateDelayMilliseconds:i=200,defaultFragment:a="{}"}=r;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let o=(0,WF.default)(()=>this.setUrlHash(),i);this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=a}setUrlHash(){let e=Hr(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let r=$K(JSON.stringify(e.value));r!==this.prevStateString&&(this.prevStateString=r,decodeURIComponent(r)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+r))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let t=e.substring(2),{url:r,credentialsProvider:i}=mr(t,this.credentialsManager);Ke.forPromise(Xi(i,r,{},$t).then(a=>{Z(a),this.root.reset(),this.root.restoreState(a)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);let t=Mh(e);Z(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();let t=Mh(e);Z(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}};function jK(n){let e=new oi,t=new Su;e.add("viewer",t),n.global.addParent(t.eventActionMap,1e3);let r=new Su;e.add("sliceView",r),n.sliceView.addParent(r.eventActionMap,1e3);let i=new Su;e.add("perspectiveView",i),n.perspectiveView.addParent(i.eventActionMap,1e3);let a=new Su;return e.add("dataView",a),n.perspectiveView.addParent(a.eventActionMap,999),n.sliceView.addParent(a.eventActionMap,999),e}function qK(n){let e=new lt({},t=>{for(let r of Object.keys(t)){let i=t[r];if(typeof i!="number")throw new Error(`Expected key ${JSON.stringify(r)} to have a numeric value, but received: ${JSON.stringify(i)}.`)}return t});return e.changed.add((0,ik.default)(()=>{let t=e.value;for(let r of Object.keys(t))n.setSourceGeneration(r,t[r]);for(let r of n.sourceGenerations.keys())t.hasOwnProperty(r)||n.deleteSourceGeneration(r)},0)),e}window.addEventListener("DOMContentLoaded",()=>{let n=new oi,e=new oi,t=new x0;n.add("credentials",t.inputState),e.add("credentials",t.outputState);let r=Zm({credentialsManager:new Ig(t)}),i=new kC;r.register("python",i),n.add("sourceGenerations",qK(i));let a=window.viewer=FF({showLayerDialog:!1,resetStateWhenEmpty:!1,dataSourceProvider:r});WI(a.inputEventBindings),n.add("inputEventBindings",jK(a.inputEventBindings));let o=new sT(a);window.remoteActionHandler=o,n.add("actions",o.actionSet),n.add("statusMessages",new lT);let l=new cT(a);n.add("screenshot",l.requestState);let c=a.state;window.location.hash&&(a.registerDisposer(new rk(a.state,t)).updateFromUrlHash(),c=void 0);let d=new oT(a.display,r,a.dataContext.addRef(),a.uiConfiguration);n.add("prefetch",d);for(let v of Wy)n.add(v,a.uiConfiguration[v]);n.add("scaleBarOptions",a.scaleBarOptions);let p=new lt(void 0,v=>v==null?void 0:Je([0,0],v,ft));n.add("viewerSize",p);let m=()=>{let v=a.display.container,b=p.value;if(b===void 0)v.style.position="relative",v.style.width="",v.style.height="",v.style.transform="",v.style.transformOrigin="";else{v.style.position="absolute",v.style.width=`${b[0]}px`,v.style.height=`${b[1]}px`;let x=document.documentElement.clientWidth,C=document.documentElement.clientHeight,k=x/b[0],M=C/b[1],I=Math.min(k,M);v.style.transform=`scale(${I})`,v.style.transformOrigin="top left"}};m(),window.addEventListener("resize",m),p.changed.add((0,ik.default)(()=>m(),0));let y=new ek(c,e,n);o.sendActionRequested.add((v,b)=>y.sendActionNotification(v,b)),l.sendScreenshotRequested.add(v=>y.sendActionNotification("screenshot",v)),l.sendStatisticsRequested.add(v=>y.sendActionNotification("screenshotStatistics",v)),DF(a),PF(a),a.registerDisposer(GF(a.title))});})();
/*! JSON v3.3.2 | https://bestiejs.github.io/json3 | Copyright 2012-2015, Kit Cambridge, Benjamin Tan | http://kit.mit-license.org */
/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017-2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
//# sourceMappingURL=main.bundle.js.map
